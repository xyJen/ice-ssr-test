"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var fse = require("fs-extra");
var parser_1 = require("@babel/parser");
var traverse_1 = require("@babel/traverse");
var t = require("@babel/types");
function parseCode(code) {
    return (0, parser_1.parse)(code, {
        sourceType: 'module',
        plugins: ['jsx', 'typescript', 'decorators-legacy', 'dynamicImport', 'classProperties'],
    });
}
function checkAuthConfig(sourcePath) {
    if (!fse.existsSync(sourcePath)) {
        var ext = ['.ts', '.js', '.tsx', '.jsx'].find(function (extension) { return fse.existsSync("".concat(sourcePath).concat(extension)); });
        if (!ext) {
            throw new Error("can not found file: ".concat(sourcePath));
        }
        sourcePath = "".concat(sourcePath).concat(ext);
    }
    var code = fse.readFileSync(sourcePath, 'utf-8');
    var ast = parseCode(code);
    var hasAuthConfig = false;
    var hasConfigInitialData = false;
    (0, traverse_1.default)(ast, {
        ObjectExpression: function (nodePath) {
            var node = nodePath.node;
            var isAppConfig = false;
            node.properties.forEach(function (property) {
                if (t.isObjectMethod(property) || t.isObjectProperty(property)) {
                    if (!hasConfigInitialData) {
                        hasConfigInitialData = t.isIdentifier(property.key) && property.key.name === 'getInitialData';
                        if (hasConfigInitialData) {
                            // 存在 getInitialData 的配置，判定当前 ObjectExpression 为 appConfig
                            isAppConfig = true;
                        }
                    }
                    // 判断非 appConfig 上的 auth 配置
                    if (!isAppConfig && !hasAuthConfig) {
                        hasAuthConfig = t.isIdentifier(property.key) && property.key.name === 'auth';
                    }
                }
            });
        },
    });
    return hasAuthConfig && hasConfigInitialData;
}
exports.default = checkAuthConfig;
//# sourceMappingURL=analyzeAuth.js.map