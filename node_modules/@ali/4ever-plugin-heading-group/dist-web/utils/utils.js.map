{"version":3,"sources":["../../../src/utils/utils.ts"],"names":["Block","Injection","generateHeadingGroupKey","generateGroupKey","generateHeadingGroupType","generateGroupType","groupHeading","group","not","fn","notFn","condition","predicates","some","node","predicate","HEADING_GROUP_REG","isGroupType","type","test","isHeadingGroup","isBlock","isGroupFrom","getHeadingLevel","injectToNodes","injections","nodes","injectionMap","Map","forEach","injection","injectionList","get","key","push","set","map","injectIntoNode","isHeadingGroupAvailable","controller","query","isHeading","getNextViewGroupNode","document","value","level","parent","getParent","nextNode","getNextBlock","userData","nextLevel","getPreviousViewGroupNode","previousNode","getPreviousBlock","previousViewNode","maxLevel","prevLevel","fold"],"mappings":"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","sourcesContent":["import { Controller, Block, Element, Injection } from '@ali/4ever-cangjie';\nimport type { FoldableHeadingData } from '@ali/4ever-plugin-heading';\nimport {\n  generateHeadingGroupKey as generateGroupKey,\n  generateHeadingGroupType as generateGroupType,\n  groupHeading as group,\n} from '@ali/4ever-utils';\n\nexport {\n  generateGroupKey,\n  generateGroupType,\n  group\n}\n\nexport type Condition = (node: any) => boolean;\n\nexport function not<T extends (...args: any[]) => boolean>(fn: T): T {\n  return function notFn(...args: any[]) {\n    return !fn(...args);\n  } as T;\n}\n\n/**\n * 生成条件组查询器\n * @param predicates\n * @returns\n */\nexport function condition<T extends Condition>(...predicates: T[]) {\n  function some(node: any) {\n    return predicates.some((predicate) => predicate(node));\n  }\n\n  return {\n    some,\n    not: not(some),\n  };\n}\n\nconst HEADING_GROUP_REG = /^heading-\\d-group$/;\n\n/**\n * 判断是否是折叠标题类型\n * @param type\n * @returns\n */\nexport function isGroupType(type: string): boolean {\n  return HEADING_GROUP_REG.test(type);\n}\n\n/**\n * 判断节点是否是标题组\n * @param node\n * @returns\n */\nexport function isHeadingGroup(node: any): node is Block<FoldableHeadingData> {\n  return Block.isBlock(node) && isGroupType(node.type);\n}\n\n/**\n * 检测节点是否是某个类型的 group\n * @param node\n * @param type\n * @returns\n */\n export function isGroupFrom(node: any, type: string): node is Block {\n  return Block.isBlock(node) && node.type === generateGroupType(type);\n}\n\n/**\n * 读取标题等级\n * @param node\n * @returns\n */\nexport function getHeadingLevel(node: Block): number {\n  switch (node.type) {\n    case 'heading-1': {\n      return 1;\n    }\n\n    case 'heading-2': {\n      return 2;\n    }\n\n    case 'heading-3': {\n      return 3;\n    }\n\n    case 'heading-4': {\n      return 4;\n    }\n\n    case 'heading-5': {\n      return 5;\n    }\n\n    case 'heading-6': {\n      return 6;\n    }\n\n    default: {\n      return -1;\n    }\n  }\n}\n\n/**\n * 注入一组 Injection 至一组节点组中\n * @param injections\n * @param nodes\n * @returns\n */\nexport function injectToNodes<T extends Element>(injections: Injection[], nodes: T[]): T[] {\n  const injectionMap = new Map<string, Injection[]>();\n  injections.forEach((injection) => {\n    const injectionList = injectionMap.get(injection.key);\n    if (injectionList) {\n      injectionList.push(injection);\n    } else {\n      injectionMap.set(injection.key, [injection]);\n    }\n  });\n  return nodes.map((node) => {\n    const injectionList = injectionMap.get(node.key);\n    if (injectionList) {\n      return Injection.injectIntoNode(injectionList, node) as T;\n    }\n    return node;\n  });\n}\n\nexport function isHeadingGroupAvailable(controller: Controller): boolean {\n  return controller?.query('isHeadingGroupAvailable');\n}\n\nfunction isHeading (node: Block | null): node is Block {\n  return Block.isBlock(node) && getHeadingLevel(node) > 0;\n}\n\n/**\n * @description 获取下一个可视节点\n */\nexport function getNextViewGroupNode(node: Block, controller: Controller) {\n  const { document } = controller.value;\n  const level = getHeadingLevel(node);\n  const parent = document.getParent(node.key);\n  if (!parent || level <= 0 || !isHeadingGroupAvailable(controller)) {\n    return null\n  }\n  let nextNode = parent.getNextBlock(node.key);\n\n  if (!controller.userData.get(node, 'fold')) {\n    return nextNode;\n  }\n\n  while(nextNode) {\n    const nextLevel = getHeadingLevel(nextNode);\n    if (nextLevel > 0 && nextLevel <= level) {\n      return nextNode;\n    }\n    nextNode = parent.getNextBlock(nextNode.key);\n  }\n  return nextNode;\n}\n\n/**\n * @description 获取上一个可视节点\n */\nexport function getPreviousViewGroupNode(node: Block, controller: Controller) {\n  const { document } = controller.value;\n  const level = getHeadingLevel(node);\n  const parent = document.getParent(node.key);\n  if (!parent || !isHeadingGroupAvailable(controller)) {\n    return null;\n  }\n  const group = {};\n\n  let previousNode = parent.getPreviousBlock(node.key);\n  let previousViewNode = previousNode;\n  let maxLevel = 10;\n\n  while (previousNode) {\n    const prevLevel = getHeadingLevel(previousNode);\n    const fold = controller.userData.get(previousNode, 'fold');\n    if (isHeading(previousNode) && fold && !group[prevLevel] && prevLevel <= maxLevel) {\n      if (!isHeading(previousViewNode)) {\n        previousViewNode = previousNode;\n      } else if (getHeadingLevel(previousViewNode) > prevLevel) {\n        previousViewNode = previousNode;\n      }\n    }\n\n    if (isHeading(previousNode) && !group[prevLevel]) {\n      group[prevLevel] = previousNode;\n      if (prevLevel < maxLevel) {\n        maxLevel = prevLevel;\n      }\n    }\n\n    if ((prevLevel > 1 && prevLevel <= level) || prevLevel === 1) {\n      return previousViewNode;\n    }\n\n    previousNode = parent.getPreviousBlock(previousNode.key);\n  }\n  return previousViewNode;\n}"],"file":"utils.js"}