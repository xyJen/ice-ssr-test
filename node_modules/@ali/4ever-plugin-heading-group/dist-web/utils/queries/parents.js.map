{"version":3,"sources":["../../../../src/utils/queries/parents.ts"],"names":["Block","condition","getHeadingLevel","headings","Array","fill","map","_","i","node","isBlock","type","getHeadingParent","controller","document","value","nodeLevel","$level","query","level","cond","slice","path","getPath","key","index","heading","prev","nodes","some","getHeadingAncestors","ancestors","current","parent","unshift"],"mappings":"AAAA,SAASA,KAAT,QAAkC,oBAAlC;AAEA,SAASC,SAAT,EAAoBC,eAApB;AAEA,IAAMC,QAAQ,GAAGC,KAAK,CAAC,CAAD,CAAL,CAASC,IAAT,CAAc,CAAd,EAAiBC,GAAjB,CAAqB,UAACC,CAAD,EAAIC,CAAJ;AAAA,SAAU,UAACC,IAAD;AAAA,WAAeT,KAAK,CAACU,OAAN,CAAcD,IAAd,KAAuBA,IAAI,CAACE,IAAL,mBAAyBH,CAAC,GAAG,CAA7B,CAAtC;AAAA,GAAV;AAAA,CAArB,CAAjB;AAEA;AACA;AACA;AACA;AACA;AACA;;AACA,OAAO,SAASI,gBAAT,CAA0BC,UAA1B,EAAkDJ,IAAlD,EAA+D;AAAA,MAC5DK,QAD4D,GAC/CD,UAAU,CAACE,KADoC,CAC5DD,QAD4D;AAEpE,MAAME,SAAS,GAAGd,eAAe,CAACO,IAAD,CAAjC;AACA,MAAMQ,MAAM,GAAGJ,UAAU,CAACK,KAAX,CAAiB,sBAAjB,CAAf;AACA,MAAMC,KAAK,GAAG,OAAOF,MAAP,KAAkB,QAAlB,GAA6BA,MAA7B,GAAsC,CAApD,CAJoE,CAMpE;;AACA,MAAID,SAAS,KAAK,CAAlB,EAAqB;AACnB,WAAO,IAAP;AACD;;AAED,MAAII,IAAJ;;AAEA,MAAIJ,SAAS,KAAK,CAAC,CAAf,IAAoBA,SAAS,GAAGG,KAApC,EAA2C;AACzCC,IAAAA,IAAI,GAAGnB,SAAS,MAAT,SAAaE,QAAQ,CAACkB,KAAT,CAAe,CAAf,EAAkBF,KAAlB,CAAb,CAAP;AACD,GAFD,MAEO;AACLC,IAAAA,IAAI,GAAGnB,SAAS,MAAT,SAAaE,QAAQ,CAACkB,KAAT,CAAe,CAAf,EAAkBL,SAAS,GAAG,CAA9B,CAAb,CAAP;AACD;;AAED,MAAMM,IAAI,GAAGR,QAAQ,CAACS,OAAT,CAAiBd,IAAI,CAACe,GAAtB,CAAb;;AACA,MAAI,CAACF,IAAL,EAAW;AACT,WAAO,IAAP;AACD;;AAtBmE,MAuB7DG,KAvB6D,GAuBpDH,IAvBoD,KAyBpE;;AACA,MAAII,OAA0C,GAAG,IAAjD;AACA,MAAIlB,CAAC,GAAGiB,KAAK,GAAG,CAAhB;;AACA,SAAOjB,CAAC,IAAI,CAAZ,EAAe;AACb,QAAMmB,IAAI,GAAGb,QAAQ,CAACc,KAAT,CAAepB,CAAf,CAAb;;AACA,QAAIY,IAAI,CAACS,IAAL,CAAUF,IAAV,CAAJ,EAAqB;AACnBD,MAAAA,OAAO,GAAGC,IAAV;AACA;AACD;;AACDnB,IAAAA,CAAC,IAAI,CAAL;AACD;;AAED,SAAOkB,OAAP;AACD;AAED;AACA;AACA;AACA;AACA;AACA;;AACA,OAAO,SAASI,mBAAT,CAA6BjB,UAA7B,EAAqDJ,IAArD,EAAkE;AACvE,MAAMsB,SAA4C,GAAG,EAArD;AAEA,MAAIC,OAA0C,GAAGvB,IAAjD;;AAEA,SAAOuB,OAAO,KAAK,IAAnB,EAAyB;AACvB,QAAMC,MAAM,GAAGrB,gBAAgB,CAACC,UAAD,EAAamB,OAAb,CAA/B;;AACA,QAAIC,MAAJ,EAAY;AACVF,MAAAA,SAAS,CAACG,OAAV,CAAkBD,MAAlB;AACD;;AACDD,IAAAA,OAAO,GAAGC,MAAV;AACD;;AAED,SAAOF,SAAP;AACD","sourcesContent":["import { Block, Controller } from '@ali/4ever-cangjie';\nimport type { FoldableHeadingData } from '@ali/4ever-plugin-heading';\nimport { condition, getHeadingLevel } from '../utils';\n\nconst headings = Array(6).fill(0).map((_, i) => (node: any) => Block.isBlock(node) && node.type === `heading-${i + 1}`);\n\n/**\n * 查询节点的父级标题\n * @param controller\n * @param node\n * @returns\n */\nexport function getHeadingParent(controller: Controller, node: Block) {\n  const { document } = controller.value;\n  const nodeLevel = getHeadingLevel(node);\n  const $level = controller.query('getHeadingGroupLevel');\n  const level = typeof $level === 'number' ? $level : 3;\n\n  // H1 没有父级组\n  if (nodeLevel === 1) {\n    return null;\n  }\n\n  let cond: ReturnType<typeof condition>;\n\n  if (nodeLevel === -1 || nodeLevel > level) {\n    cond = condition(...headings.slice(0, level));\n  } else {\n    cond = condition(...headings.slice(0, nodeLevel - 1));\n  }\n\n  const path = document.getPath(node.key);\n  if (!path) {\n    return null;\n  }\n  const [index] = path;\n\n  // 查询第一个高级标题节点返回\n  let heading: Block<FoldableHeadingData> | null = null;\n  let i = index - 1;\n  while (i >= 0) {\n    const prev = document.nodes[i];\n    if (cond.some(prev)) {\n      heading = prev;\n      break;\n    }\n    i -= 1;\n  }\n\n  return heading;\n}\n\n/**\n * 查询节点的祖先标题组\n * @param controller\n * @param node\n * @returns\n */\nexport function getHeadingAncestors(controller: Controller, node: Block) {\n  const ancestors: Array<Block<FoldableHeadingData>> = [];\n\n  let current: Block<FoldableHeadingData> | null = node;\n\n  while (current !== null) {\n    const parent = getHeadingParent(controller, current);\n    if (parent) {\n      ancestors.unshift(parent);\n    }\n    current = parent;\n  }\n\n  return ancestors;\n}\n"],"file":"parents.js"}