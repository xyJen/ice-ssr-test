{"version":3,"sources":["../../../../src/utils/handlers/createAutoUnfold.ts"],"names":["Block","getHeadingAncestors","injectToNodes","createAutoUnfold","options","onAutoUnfold","inject","autoUnfold","event","controller","detail","selection","trigger","document","value","focus","block","getFurthestAncestor","key","isBlock","groups","query","injections","parents","filter","group","userData","get","forEach","parent"],"mappings":"AAAA,SAASA,KAAT,QAAsD,oBAAtD;AAEA,SAASC,mBAAT;AACA,SAASC,aAAT;;AAcA,SAASC,gBAAT,CAA0BC,OAA1B,EAAsD;AAAA,MAC5CC,YAD4C,GACXD,OADW,CAC5CC,YAD4C;AAAA,wBACXD,OADW,CAC9BE,MAD8B;AAAA,MAC9BA,MAD8B,gCACrB,KADqB;AAGpD,SAAO,SAASC,UAAT,CAAoBC,KAApB,EAA+CC,UAA/C,EAAuE;AAAA,wBAC7CD,KAAK,CAACE,MADuC;AAAA,QACpEC,SADoE,iBACpEA,SADoE;AAAA,QACzDC,OADyD,iBACzDA,OADyD;AAAA,QAGpEC,QAHoE,GAGvDJ,UAAU,CAACK,KAH4C,CAGpED,QAHoE;AAAA,QAIpEE,KAJoE,GAI1DJ,SAJ0D,CAIpEI,KAJoE;AAK5E,QAAMC,KAAK,GAAGH,QAAQ,CAACI,mBAAT,CAA6BF,KAAK,CAACG,GAAnC,CAAd,CAL4E,CAO5E;AACA;;AACA,QAAIN,OAAO,KAAK,kBAAZ,IAAkCZ,KAAK,CAACmB,OAAN,CAAcH,KAAd,CAAtC,EAA4D;AAC1D,UAAII,MAAM,GAAGX,UAAU,CAACY,KAAX,CAAiBpB,mBAAjB,EAAsCe,KAAtC,CAAb,CAD0D,CAE1D;;AACA,UAAIV,MAAJ,EAAY;AACVc,QAAAA,MAAM,GAAGlB,aAAa,CAACO,UAAU,CAACK,KAAX,CAAiBQ,UAAlB,EAA8BF,MAA9B,CAAtB;AACD,OALyD,CAO1D;;;AACA,UAAMG,OAAO,GAAGH,MAAM,CAACI,MAAP,CAAc,UAACC,KAAD;AAAA,eAAWhB,UAAU,CAACiB,QAAX,CAAoBC,GAApB,CAAwBF,KAAxB,EAA+B,MAA/B,CAAX;AAAA,OAAd,CAAhB;AACAF,MAAAA,OAAO,CAACK,OAAR,CAAgB,UAACC,MAAD;AAAA,eAAYxB,YAAY,CAACI,UAAD,EAAaoB,MAAb,CAAxB;AAAA,OAAhB;AACD;AACF,GApBD;AAqBD;;AAED,eAAe1B,gBAAf","sourcesContent":["import { Block, CangjieSelectEvent, Controller } from '@ali/4ever-cangjie';\nimport type { FoldableHeadingData } from '@ali/4ever-plugin-heading';\nimport { getHeadingAncestors } from '../queries';\nimport { injectToNodes } from '../utils';\n\nexport interface AutoUnfoldOptions {\n  /**\n   * 触发自动展开\n   */\n  onAutoUnfold: (controller: Controller, node: Block<FoldableHeadingData>) => void;\n  /**\n   * 是否注入 Injection\n   * @default false\n   */\n  inject?: boolean;\n}\n\nfunction createAutoUnfold(options: AutoUnfoldOptions) {\n  const { onAutoUnfold, inject = false } = options;\n\n  return function autoUnfold(event: CangjieSelectEvent, controller: Controller) {\n    const { selection, trigger } = event.detail;\n\n    const { document } = controller.value;\n    const { focus } = selection;\n    const block = document.getFurthestAncestor(focus.key);\n\n    // TODO: 这里的 query 会在每次 select 时消耗一次 O(N) 的查询性能，后续考虑在 DOM 上做一次 O(h) 的查询来优化\n    // 如果是议题的选区扩展行为，则不执行自动展开\n    if (trigger !== 'subjectNormalize' && Block.isBlock(block)) {\n      let groups = controller.query(getHeadingAncestors, block);\n      // 若开启了注入，则自动注入 Injection 数据\n      if (inject) {\n        groups = injectToNodes(controller.value.injections, groups);\n      }\n\n      // 过滤折叠标题自动展开\n      const parents = groups.filter((group) => controller.userData.get(group, 'fold'));\n      parents.forEach((parent) => onAutoUnfold(controller, parent));\n    }\n  };\n}\n\nexport default createAutoUnfold;\n"],"file":"createAutoUnfold.js"}