{"version":3,"sources":["../../../../src/utils/handlers/createCommentShow.ts"],"names":["createCommentShow","options","onAutoUnfold","inject","onCommentShow","controller","payload","contentId","deco","value","decorations","find","mark","ViewMark","isViewMark","data","start","block","document","getFurthsestBlock","key","Block","isBlock","groups","query","getHeadingAncestors","injections","parents","filter","group","userData","get","forEach","parent"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;AAeA,SAASA,iBAAT,CAA2BC,OAA3B,EAAwD;AACtD,QAAM;AAAEC,IAAAA,YAAF;AAAgBC,IAAAA,MAAM,GAAG;AAAzB,MAAmCF,OAAzC;AAEA,SAAO,SAASG,aAAT,CAAuBC,UAAvB,EAA+CC,OAA/C,EAA4E;AACjF,UAAM;AAAEC,MAAAA;AAAF,QAAgBD,OAAtB;AACA,UAAME,IAAI,GAAGH,UAAU,CAACI,KAAX,CAAiBC,WAAjB,CAA6BC,IAA7B,CAAkC,CAAC;AAAEC,MAAAA;AAAF,KAAD,KAAcC,4BAASC,UAAT,CAAoBF,IAApB,KAA6BA,IAAI,CAACG,IAAL,CAAUR,SAAV,KAAwBA,SAArG,CAAb;;AAEA,QAAI,CAACC,IAAL,EAAW;AACT;AACD;;AAED,UAAM;AAAEQ,MAAAA;AAAF,QAAYR,IAAlB;AACA,UAAMS,KAAK,GAAGZ,UAAU,CAACI,KAAX,CAAiBS,QAAjB,CAA0BC,iBAA1B,CAA4CH,KAAK,CAACI,GAAlD,CAAd,CATiF,CAWjF;;AACA,QAAIC,mBAAMC,OAAN,CAAcL,KAAd,CAAJ,EAA0B;AACxB,UAAIM,MAAM,GAAGlB,UAAU,CAACmB,KAAX,CAAiBC,4BAAjB,EAAsCR,KAAtC,CAAb,CADwB,CAExB;;AACA,UAAId,MAAJ,EAAY;AACVoB,QAAAA,MAAM,GAAG,0BAAclB,UAAU,CAACI,KAAX,CAAiBiB,UAA/B,EAA2CH,MAA3C,CAAT;AACD,OALuB,CAOxB;;;AACA,YAAMI,OAAO,GAAGJ,MAAM,CAACK,MAAP,CAAeC,KAAD,IAAWxB,UAAU,CAACyB,QAAX,CAAoBC,GAApB,CAAwBF,KAAxB,EAA+B,MAA/B,CAAzB,CAAhB;AACAF,MAAAA,OAAO,CAACK,OAAR,CAAiBC,MAAD,IAAY/B,YAAY,CAACG,UAAD,EAAa4B,MAAb,CAAxC;AACD;AACF,GAvBD;AAwBD;;eAEcjC,iB","sourcesContent":["import { ViewMark } from '@ali/4ever-plugin-comment';\nimport { Controller, Block } from '@ali/4ever-cangjie';\nimport { getHeadingAncestors } from '../queries';\nimport { injectToNodes } from '../utils';\n\nexport interface CommentShowPayload {\n  contentId: string;\n}\n\nexport interface CommentShowOptions {\n  onAutoUnfold: (controller: Controller, node: Block) => void;\n  /**\n   * 是否注入 Injection\n   * @default false\n   */\n  inject?: boolean;\n}\n\nfunction createCommentShow(options: CommentShowOptions) {\n  const { onAutoUnfold, inject = false } = options;\n\n  return function onCommentShow(controller: Controller, payload: CommentShowPayload) {\n    const { contentId } = payload;\n    const deco = controller.value.decorations.find(({ mark }) => ViewMark.isViewMark(mark) && mark.data.contentId === contentId);\n\n    if (!deco) {\n      return;\n    }\n\n    const { start } = deco;\n    const block = controller.value.document.getFurthsestBlock(start.key);\n\n    // TODO: 这里的 query 会在每次 select 时消耗一次 O(N) 的查询性能，后续考虑在 DOM 上做一次 O(h) 的查询来优化\n    if (Block.isBlock(block)) {\n      let groups = controller.query(getHeadingAncestors, block);\n      // 若开启了注入，则自动注入 Injection 数据\n      if (inject) {\n        groups = injectToNodes(controller.value.injections, groups);\n      }\n\n      // 过滤折叠标题自动展开\n      const parents = groups.filter((group) => controller.userData.get(group, 'fold'));\n      parents.forEach((parent) => onAutoUnfold(controller, parent));\n    }\n  };\n}\n\nexport default createCommentShow;\n"],"file":"createCommentShow.js"}