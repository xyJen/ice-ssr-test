"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _everCangjie = require("@ali/4ever-cangjie");

var _queries = require("../queries");

var _utils = require("../utils");

function createAutoUnfold(options) {
  const {
    onAutoUnfold,
    inject = false
  } = options;
  return function autoUnfold(event, controller) {
    const {
      selection,
      trigger
    } = event.detail;
    const {
      document
    } = controller.value;
    const {
      focus
    } = selection;
    const block = document.getFurthestAncestor(focus.key); // TODO: 这里的 query 会在每次 select 时消耗一次 O(N) 的查询性能，后续考虑在 DOM 上做一次 O(h) 的查询来优化
    // 如果是议题的选区扩展行为，则不执行自动展开

    if (trigger !== 'subjectNormalize' && _everCangjie.Block.isBlock(block)) {
      let groups = controller.query(_queries.getHeadingAncestors, block); // 若开启了注入，则自动注入 Injection 数据

      if (inject) {
        groups = (0, _utils.injectToNodes)(controller.value.injections, groups);
      } // 过滤折叠标题自动展开


      const parents = groups.filter(group => controller.userData.get(group, 'fold'));
      parents.forEach(parent => onAutoUnfold(controller, parent));
    }
  };
}

var _default = createAutoUnfold;
exports.default = _default;
//# sourceMappingURL=createAutoUnfold.js.map