import _extends from "@babel/runtime/helpers/extends";
import { CangjieInputEvent, Commands } from '@ali/4ever-cangjie';
import { shouldAutoSpacing, shouldDeleteSpacing, getPreText, getNextText } from "../utils";
export default function onInsertText(event, controller, next) {
  var nextInputText = event.detail.data || '';
  if (!nextInputText.trim()) return next();
  var _controller$value = controller.value,
      document = _controller$value.document,
      selection = _controller$value.selection;
  var isExpanded = selection.isExpanded;
  var preText = getPreText(controller);
  var nextText = getNextText(controller);
  if (!preText.length && !nextText.length) return next();
  var preLastText = preText[preText.length - 1];
  var nextFirstText = nextText[0];
  var inputText = Array.from(nextInputText);
  var inputFirstText = inputText[0];
  var inputLastText = inputText[inputText.length - 1]; // check if need add space

  var needAddSpaceBefore = shouldAutoSpacing(inputFirstText, preLastText);
  var needAddSpaceAfter = shouldAutoSpacing(inputLastText, nextFirstText);

  if (needAddSpaceBefore) {
    nextInputText = " " + nextInputText;
  }

  if (needAddSpaceAfter) {
    nextInputText = nextInputText + " ";
  } // 1. 删除前面多余空格（插入后删除需要重新计算位置，因此先行删除）


  var shouldDeleteSpacingBefore = shouldDeleteSpacing(preText[preText.length - 2], preLastText, inputFirstText, nextFirstText, isExpanded);

  if (shouldDeleteSpacingBefore) {
    var range = selection.moveToStart(document).moveAnchorBackward();
    controller.command(Commands.deleteAtRange, range);
  } // 2. 添加空格


  if (needAddSpaceBefore || needAddSpaceAfter) {
    next(CangjieInputEvent(_extends({}, event.detail, {
      data: nextInputText
    })));
  } else {
    next();
  } // 3. 删除后面多余空格


  var shouldDeleteSpacingAfter = shouldDeleteSpacing(inputLastText, nextFirstText, nextText[1], preLastText, isExpanded);

  if (shouldDeleteSpacingAfter) {
    controller.command(Commands.deleteForward);
  } // 4. 光标矫正


  if (needAddSpaceAfter) {
    controller.command(Commands.moveBackward);
  }
}
//# sourceMappingURL=onInsertText.js.map