{"version":3,"sources":["../../../../../src/plugins/autoSpacing/handlers/onInsertText.ts"],"names":["CangjieInputEvent","Commands","shouldAutoSpacing","shouldDeleteSpacing","getPreText","getNextText","onInsertText","event","controller","next","nextInputText","detail","data","trim","value","document","selection","isExpanded","preText","nextText","length","preLastText","nextFirstText","inputText","Array","from","inputFirstText","inputLastText","needAddSpaceBefore","needAddSpaceAfter","shouldDeleteSpacingBefore","range","moveToStart","moveAnchorBackward","command","deleteAtRange","shouldDeleteSpacingAfter","deleteForward","moveBackward"],"mappings":";AAAA,SAEEA,iBAFF,EAGEC,QAHF,QAIO,oBAJP;AAKA,SACEC,iBADF,EAEEC,mBAFF,EAGEC,UAHF,EAIEC,WAJF;AAOA,eAAe,SAASC,YAAT,CACbC,KADa,EAEbC,UAFa,EAGbC,IAHa,EAIb;AACA,MAAIC,aAAa,GAAGH,KAAK,CAACI,MAAN,CAAaC,IAAb,IAAqB,EAAzC;AACA,MAAI,CAACF,aAAa,CAACG,IAAd,EAAL,EAA2B,OAAOJ,IAAI,EAAX;AAF3B,0BAIgCD,UAAU,CAACM,KAJ3C;AAAA,MAIQC,QAJR,qBAIQA,QAJR;AAAA,MAIkBC,SAJlB,qBAIkBA,SAJlB;AAKA,MAAMC,UAAU,GAAGD,SAAS,CAACC,UAA7B;AAEA,MAAMC,OAAO,GAAGd,UAAU,CAACI,UAAD,CAA1B;AACA,MAAMW,QAAQ,GAAGd,WAAW,CAACG,UAAD,CAA5B;AACA,MAAI,CAACU,OAAO,CAACE,MAAT,IAAmB,CAACD,QAAQ,CAACC,MAAjC,EAAyC,OAAOX,IAAI,EAAX;AAEzC,MAAMY,WAAW,GAAGH,OAAO,CAACA,OAAO,CAACE,MAAR,GAAiB,CAAlB,CAA3B;AACA,MAAME,aAAa,GAAGH,QAAQ,CAAC,CAAD,CAA9B;AAEA,MAAMI,SAAS,GAAGC,KAAK,CAACC,IAAN,CAAWf,aAAX,CAAlB;AACA,MAAMgB,cAAc,GAAGH,SAAS,CAAC,CAAD,CAAhC;AACA,MAAMI,aAAa,GAAGJ,SAAS,CAACA,SAAS,CAACH,MAAV,GAAmB,CAApB,CAA/B,CAhBA,CAkBA;;AACA,MAAMQ,kBAAkB,GAAG1B,iBAAiB,CAACwB,cAAD,EAAiBL,WAAjB,CAA5C;AACA,MAAMQ,iBAAiB,GAAG3B,iBAAiB,CAACyB,aAAD,EAAgBL,aAAhB,CAA3C;;AAEA,MAAGM,kBAAH,EAAuB;AACrBlB,IAAAA,aAAa,SAAOA,aAApB;AACD;;AAED,MAAGmB,iBAAH,EAAsB;AACpBnB,IAAAA,aAAa,GAAMA,aAAN,MAAb;AACD,GA5BD,CA8BA;;;AACA,MAAMoB,yBAAyB,GAAG3B,mBAAmB,CAACe,OAAO,CAACA,OAAO,CAACE,MAAR,GAAiB,CAAlB,CAAR,EAA8BC,WAA9B,EAA2CK,cAA3C,EAA2DJ,aAA3D,EAA0EL,UAA1E,CAArD;;AACA,MAAIa,yBAAJ,EAA+B;AAC7B,QAAMC,KAAK,GAAGf,SAAS,CAACgB,WAAV,CAAsBjB,QAAtB,EAAgCkB,kBAAhC,EAAd;AACAzB,IAAAA,UAAU,CAAC0B,OAAX,CAAmBjC,QAAQ,CAACkC,aAA5B,EAA2CJ,KAA3C;AACD,GAnCD,CAqCA;;;AACA,MAAIH,kBAAkB,IAAIC,iBAA1B,EAA6C;AAC3CpB,IAAAA,IAAI,CAACT,iBAAiB,cACjBO,KAAK,CAACI,MADW;AAEpBC,MAAAA,IAAI,EAAEF;AAFc,OAAlB,CAAJ;AAID,GALD,MAKO;AACLD,IAAAA,IAAI;AACL,GA7CD,CA+CA;;;AACA,MAAM2B,wBAAwB,GAAGjC,mBAAmB,CAACwB,aAAD,EAAgBL,aAAhB,EAA+BH,QAAQ,CAAC,CAAD,CAAvC,EAA4CE,WAA5C,EAAyDJ,UAAzD,CAApD;;AACA,MAAGmB,wBAAH,EAA6B;AAC3B5B,IAAAA,UAAU,CAAC0B,OAAX,CAAmBjC,QAAQ,CAACoC,aAA5B;AACD,GAnDD,CAqDA;;;AACA,MAAIR,iBAAJ,EAAuB;AACrBrB,IAAAA,UAAU,CAAC0B,OAAX,CAAmBjC,QAAQ,CAACqC,YAA5B;AACD;AACF","sourcesContent":["import { \n  Controller, \n  CangjieInputEvent, \n  Commands,\n} from '@ali/4ever-cangjie';\nimport { \n  shouldAutoSpacing,\n  shouldDeleteSpacing,\n  getPreText,\n  getNextText,\n} from '../utils';\n\nexport default function onInsertText(\n  event: CangjieInputEvent,\n  controller: Controller,\n  next: Function,\n) {\n  let nextInputText = event.detail.data || '';\n  if (!nextInputText.trim()) return next();\n\n  const { document, selection } = controller.value;\n  const isExpanded = selection.isExpanded;\n  \n  const preText = getPreText(controller);\n  const nextText = getNextText(controller);\n  if (!preText.length && !nextText.length) return next();\n\n  const preLastText = preText[preText.length - 1];\n  const nextFirstText = nextText[0];\n  \n  const inputText = Array.from(nextInputText);\n  const inputFirstText = inputText[0];\n  const inputLastText = inputText[inputText.length - 1];\n\n  // check if need add space\n  const needAddSpaceBefore = shouldAutoSpacing(inputFirstText, preLastText);\n  const needAddSpaceAfter = shouldAutoSpacing(inputLastText, nextFirstText);\n\n  if(needAddSpaceBefore) {\n    nextInputText = ` ${nextInputText}`;\n  }\n\n  if(needAddSpaceAfter) {\n    nextInputText = `${nextInputText} `;\n  }\n\n  // 1. 删除前面多余空格（插入后删除需要重新计算位置，因此先行删除）\n  const shouldDeleteSpacingBefore = shouldDeleteSpacing(preText[preText.length - 2], preLastText, inputFirstText, nextFirstText, isExpanded);\n  if (shouldDeleteSpacingBefore) {\n    const range = selection.moveToStart(document).moveAnchorBackward();\n    controller.command(Commands.deleteAtRange, range);\n  }\n\n  // 2. 添加空格\n  if (needAddSpaceBefore || needAddSpaceAfter) {\n    next(CangjieInputEvent({\n      ...event.detail,\n      data: nextInputText,\n    }));\n  } else {\n    next();\n  }\n\n  // 3. 删除后面多余空格\n  const shouldDeleteSpacingAfter = shouldDeleteSpacing(inputLastText, nextFirstText, nextText[1], preLastText, isExpanded);\n  if(shouldDeleteSpacingAfter) {\n    controller.command(Commands.deleteForward);\n  }\n\n  // 4. 光标矫正\n  if (needAddSpaceAfter) {\n    controller.command(Commands.moveBackward);\n  }\n}\n"],"file":"onInsertText.js"}