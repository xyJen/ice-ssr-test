{"version":3,"sources":["../../../../../src/plugins/callout/components/callout.tsx"],"names":["React","throttle","Block","useZoom","environment","useScrollableContent","StickerPlugin","CalloutPlugin","ColorBlocks","useHover","Popover","Tooltip","getRectOfNodeFirstText","STICKER_PANEL_COLUMMS","StickerPanel","setCalloutStickerCode","convertKeysToContainer","deleteCallout","CalloutInnerToolbar","isCallout","StickerItem","CalloutBoxWrapper","CalloutBox","ContentBox","StickerBox","StickerInnerBox","DEFAULTS","STICKER_SIZE","PADDING_TOP","Callout","props","controller","node","attributes","children","sticker","locale","contentBoxRef","useRef","stickerBoxRef","disableInlineToolbar","query","useMemo","calloutPr","data","bgcolor","backgroundColor","stickerCode","showSticker","metadata","Boolean","showstk","stcode","border","color","borderColor","whiteBorder","ref","useState","stickerTop","setStickerTop","zoom","showStickerPanel","setShowStickerTop","showInnerToolbar","setShowInnerToolbar","useEffect","keys","nodes","map","n","key","run","isColorBlocks","indexOf","length","every","isBlock","current","rect","stickerRect","getBoundingClientRect","height","newTop","top","Math","round","triggerSetSticker","useCallback","code","updateInnerToolbar","event","target","HTMLElement","forceHide","closest","panel","showIt","isShow","trailing","handleMouseMove","IS_MOBILE","persist","handleHideInnerToolbar","cancel","enableBorderHighlight","onMouseLeave","isHover","hoverHandlers","scrollContent","window","document","body","addEventListener","removeEventListener","showRightToolbar","toggleStickerPanelVisible","switchEmoji","v","zIndex","displayName"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { throttle } from 'lodash-es';\nimport { Block, Controller, useZoom, environment } from '@ali/4ever-cangjie';\nimport {\n  useScrollableContent,\n  StickerPlugin,\n  CalloutPlugin,\n} from '@ali/4ever-bamboo';\nimport { ParagraphData, ColorBlocks } from '@ali/4ever-mo';\nimport { useHover } from '@ali/4ever-component';\nimport { Popover } from '@ali/we-design-next';\nimport { Tooltip } from '@ali/we-design';\nimport { getRectOfNodeFirstText } from '@ali/4ever-utils';\nimport { STICKER_PANEL_COLUMMS, StickerPanel } from '@ali/4ever-plugin-sticker';\nimport {\n  setCalloutStickerCode,\n  convertKeysToContainer,\n  deleteCallout,\n} from '../actions';\nimport CalloutInnerToolbar from './InnerToolbar';\nimport { isCallout } from '../utils';\nimport { Locale } from '../types';\n\nconst { StickerItem } = StickerPlugin;\nconst {\n  CalloutBoxWrapper,\n  CalloutBox,\n  ContentBox,\n  StickerBox,\n  StickerInnerBox,\n  DEFAULTS,\n  STICKER_SIZE,\n  PADDING_TOP,\n} = CalloutPlugin;\n\nexport interface CalloutProps {\n  controller: Controller;\n  node: Block<ParagraphData> | ColorBlocks;\n  locale?: Locale;\n  attributes: Record<string, string>;\n  sticker: StickerPlugin.Sticker;\n}\n\n/**\n * 高亮区块\n * @param props\n * @returns\n */\nconst Callout: React.FC<CalloutProps> = (props) => {\n  const { controller, node, attributes, children, sticker, locale } = props;\n  const contentBoxRef = React.useRef<HTMLDivElement>();\n  const stickerBoxRef = React.useRef<HTMLDivElement>();\n  const disableInlineToolbar = controller.query('hasHoverToolbar', 'callout');\n\n  const {\n    bgcolor = DEFAULTS.bgcolor,\n    sticker: stickerCode = DEFAULTS.stcode,\n    border,\n    color,\n    showSticker,\n  } = React.useMemo(() => {\n    if (isCallout(node)) {\n      const { calloutPr } = node.data;\n      return {\n        bgcolor: calloutPr?.backgroundColor,\n        sticker: calloutPr?.stickerCode,\n        showSticker: true,\n      };\n    } else {\n      const { metadata } = (node as ColorBlocks).data;\n      return { ...metadata, showSticker: Boolean(metadata.showstk) };\n    }\n  }, [node]);\n\n  // 边框色默认为背景色, 使边框和文字对齐\n  let borderColor = border || bgcolor;\n  if (!border && bgcolor === '#FFFFFF') {\n    borderColor = DEFAULTS.whiteBorder;\n  }\n\n  const ref = React.useRef<HTMLDivElement>(null);\n  const [stickerTop, setStickerTop] = React.useState(0);\n  const zoom = useZoom();\n  const [showStickerPanel, setShowStickerTop] = React.useState(false);\n  const [showInnerToolbar, setShowInnerToolbar] = React.useState(false);\n\n  React.useEffect(() => {\n    if (isCallout(node)) {\n      const keys = node.nodes.map((n) => n.key);\n      controller.run('onAction', convertKeysToContainer({ keys }));\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  React.useEffect(() => {\n    if (!ColorBlocks.isColorBlocks(node)) {\n      return;\n    }\n    /**\n     * 背景：\n     * 排版下，突然出现 node.nodes 是空数组的临时状态，可能和 task 调度有关系\n     * 目前排查下来，非常难定位，暂时忽略这个 case\n     *\n     * hotfix：排版下，暂时不执行这里的逻辑\n     *\n     */\n    if (node.key.indexOf('-') >= 0) {\n      return;\n    }\n    const { nodes = [] } = node;\n    if (!nodes.length || nodes.every((n) => !Block.isBlock(n))) {\n      controller.run('onAction', deleteCallout({ node }));\n    }\n  }, [node, controller]);\n\n  React.useEffect(() => {\n    if (stickerBoxRef.current && node.nodes[0]) {\n      const rect = getRectOfNodeFirstText(node.nodes[0] as Block);\n      const stickerRect = stickerBoxRef.current?.getBoundingClientRect();\n      if (rect && rect.height && stickerRect) {\n        const newTop =\n          rect.top / zoom -\n          stickerRect.top / zoom -\n          PADDING_TOP +\n          (rect.height / zoom - STICKER_SIZE) / 2 -\n          1;\n        setStickerTop(Math.round(newTop));\n      }\n    }\n  }, [node, stickerBoxRef, zoom]);\n\n  const triggerSetSticker = React.useCallback(\n    ({ code }) => {\n      setShowStickerTop(false);\n      controller.run(\n        'onAction',\n        setCalloutStickerCode({\n          node,\n          stickerCode: code,\n        }),\n      );\n    },\n    [controller, node, setShowStickerTop],\n  );\n\n  const updateInnerToolbar = React.useCallback(\n    throttle((event: React.MouseEvent) => {\n      const { target } = event;\n      if (!(target instanceof HTMLElement)) {\n        return;\n      }\n      const forceHide = target.closest('[data-istasklist]');\n      const panel = target.closest('[data-color-select-panel]');\n      const showIt = !panel || panel === ref.current;\n      const isShow = !forceHide && showIt;\n      if (showInnerToolbar !== isShow) {\n        setShowInnerToolbar(isShow);\n      }\n    }, 100, { trailing: true }),\n    [showInnerToolbar],\n  );\n\n  const handleMouseMove = React.useCallback((event: React.MouseEvent) => {\n    if (environment.IS_MOBILE) {\n      return;\n    }\n    event.persist();\n    updateInnerToolbar(event);\n  }, [updateInnerToolbar]);\n\n  const handleHideInnerToolbar = React.useCallback(() => {\n    updateInnerToolbar.cancel();\n    setShowInnerToolbar(false);\n  }, [updateInnerToolbar]);\n\n  const enableBorderHighlight = React.useMemo(() => controller.query('enableBorderHighlight'), []);\n  const [isHover, hoverHandlers] = useHover(enableBorderHighlight, {\n    onMouseLeave: handleHideInnerToolbar,\n  });\n\n  const scrollContent = useScrollableContent() || window.document.body;\n\n  // 如果不这样做，还有一种做法参考现在的 setStickerPanelVisible,\n  // 通过 action 触发显示隐藏，在 controller.data 里面存状态\n  // 个人不认可这种做法\n\n  React.useEffect(() => {\n    window.document.addEventListener('keydown', handleHideInnerToolbar);\n    return () => {\n      window.document.removeEventListener('keydown', handleHideInnerToolbar);\n    };\n  }, [controller, handleHideInnerToolbar]);\n\n  const showRightToolbar = ColorBlocks.isColorBlocks(node);\n\n  const toggleStickerPanelVisible = React.useCallback(() => {\n    setShowStickerTop(!showStickerPanel)\n  }, [showStickerPanel]);\n\n  return (\n    <CalloutBoxWrapper {...attributes}>\n      <CalloutBox\n        ref={ref}\n        className=\"callout-box\"\n        data-callout-group\n        data-color-select-panel\n        backgroundColor={bgcolor}\n        borderColor={borderColor}\n        selected={false}\n        {...hoverHandlers}\n        onMouseMove={handleMouseMove}\n        onMouseDown={() => {}}\n        onClick={() => {}}\n        data-hover-box=\"borderBox\"\n        isHover={isHover}\n      >\n        {!disableInlineToolbar && showRightToolbar && (\n          <CalloutInnerToolbar\n            color={color}\n            bgcolor={bgcolor}\n            border={border}\n            locale={locale}\n            showSticker={showSticker}\n            controller={controller}\n            node={node as ColorBlocks}\n            showInnerToolbar={showInnerToolbar}\n          />\n        )}\n        {Boolean(showSticker) && (\n          // we-design-next tooltip 有 bug, 点击 popover 内的表情后不消失，这里先用 we-design 的\n          <Tooltip title={locale?.switchEmoji} placement=\"bottom\" zIndex={900}>\n            <StickerBox className=\"callout-sticker-box\" ref={stickerBoxRef}>\n              <Popover\n                visible={showStickerPanel}\n                trigger=\"click\"\n                getContainer={() => scrollContent}\n                // StickerPanel 本身有 memo\n                content={\n                  <StickerPanel\n                    sticker={sticker}\n                    columns={STICKER_PANEL_COLUMMS}\n                    onClick={triggerSetSticker}\n                  />\n                }\n                onVisibleChange={(v) => {\n                  setShowStickerTop(v);\n                }}\n                placement=\"bottom\"\n                style={{ zIndex: 1000 }}\n              >\n                <StickerInnerBox style={{ top: stickerTop }}>\n                  <StickerItem\n                    sz={STICKER_SIZE}\n                    code={stickerCode}\n                    sticker={sticker}\n                    onClick={toggleStickerPanelVisible}\n                  />\n                </StickerInnerBox>\n              </Popover>\n            </StickerBox>\n          </Tooltip>\n        )}\n        <ContentBox\n          data-container-block\n          showSticker={showSticker}\n          ref={contentBoxRef}\n        >\n          {children}\n        </ContentBox>\n      </CalloutBox>\n    </CalloutBoxWrapper>\n  );\n};\n\nCallout.displayName = 'Callout';\n\nexport default Callout;\n"],"file":"callout.js"}