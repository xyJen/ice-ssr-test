{"version":3,"sources":["../../../../../src/plugins/callout/commands/convertKeysToContainer.ts"],"names":["Commands","Block","ColorBlocks","keysToBlocks","controller","keys","document","value","blocks","map","k","getNode","filter","n","isBlock","removeCalloutPrFlag","withoutNormalizing","forEach","b","data","calloutPr","command","setNodeByKey","key","convertKeysToContainer","length","parent","getParent","isColorBlocks","prevAttrs","bgcolor","backgroundColor","sticker","stickerCode","colorBlock","createColorBlocks","showstk","targetPath","getPath","targetIndex","pop","insertNodeByPath","colorBlockPath","reverse","fromPath","moveNodeByPath"],"mappings":"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","sourcesContent":["import { Controller, Commands, Block } from '@ali/4ever-cangjie';\nimport { ColorBlocks } from '@ali/4ever-mo';\nimport { CalloutPr } from '../types';\n\nfunction keysToBlocks(controller: Controller, keys: string[]) {\n  const { document } = controller.value;\n  const blocks = keys\n    .map((k) => document.getNode(k))\n    .filter((n) => Block.isBlock(n)) as Block[];\n  return blocks;\n}\n\nfunction removeCalloutPrFlag(controller: Controller, keys: string[]) {\n  controller.withoutNormalizing(() => {\n    const blocks = keysToBlocks(controller, keys);\n    blocks.forEach((b) => {\n      if (b.data.calloutPr) {\n        const data = { ...b.data };\n        delete data.calloutPr;\n        controller.command(Commands.setNodeByKey, b.key, { data });\n      }\n    });\n  });\n  return controller;\n}\n\nexport function convertKeysToContainer(controller: Controller, keys: string[]) {\n  const { document } = controller.value;\n  const blocks = keysToBlocks(controller, keys);\n\n  if (!blocks.length) {\n    return controller;\n  }\n\n  /**\n   * 如果已经转移过了，直接去除标记\n   */\n  const parent = document.getParent(blocks[0].key);\n  if (ColorBlocks.isColorBlocks(parent)) {\n    return controller.command(removeCalloutPrFlag, keys);\n  }\n\n  const prevAttrs = blocks[0].data?.calloutPr as CalloutPr | undefined;\n  const { backgroundColor: bgcolor, stickerCode: sticker } = prevAttrs || {};\n  const colorBlock = ColorBlocks.createColorBlocks(\n    {\n      bgcolor,\n      sticker,\n      showstk: true,\n    },\n    [],\n  );\n  const targetPath = document.getPath(blocks[0].key)!;\n  const targetIndex = targetPath.pop()!;\n  controller.withoutNormalizing(() => {\n    controller.command(\n      Commands.insertNodeByPath,\n      targetPath,\n      targetIndex,\n      colorBlock,\n    );\n    const colorBlockPath = controller.value.document.getPath(colorBlock.key);\n    blocks.reverse().forEach((n) => {\n      const fromPath = controller.value.document.getPath(n.key);\n      if (fromPath && colorBlockPath) {\n        controller.command(\n          Commands.moveNodeByPath,\n          fromPath,\n          colorBlockPath,\n          0,\n        );\n      }\n    });\n  });\n  return controller.command(removeCalloutPrFlag, keys);\n}\n"],"file":"convertKeysToContainer.js"}