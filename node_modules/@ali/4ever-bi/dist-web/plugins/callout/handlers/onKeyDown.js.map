{"version":3,"sources":["../../../../../src/plugins/callout/handlers/onKeyDown.ts"],"names":["isKeyHotkey","Text","Commands","hotkeys","Path","ColorBlocks","Paragraph","Table","isEmptyParagraph","onEnter","onKeyDown","event","controller","next","value","document","selection","focusKey","focus","key","isCollapsed","isEnter","colorBlocks","getClosest","isColorBlocks","isBackspaceHotKey","isDeleteHotKey","nodes","length","preventDefault","path","getPath","index","pop","p","create","command","moveNodeByPath","link","removeNodeByPath","closestTable","isTable","skipSelectAll","getNode","isSelectAll","moveAnchorToStartOfNode","moveFocusToEndOfNode"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport isKeyHotkey from 'is-hotkey';\nimport { Controller, Block, Text, Commands, hotkeys, Path } from '@ali/4ever-cangjie';\nimport { ColorBlocks, Paragraph, Table } from '@ali/4ever-mo';\nimport { isEmptyParagraph } from '@ali/4ever-bamboo';\nimport onEnter from './onEnter';\n\nexport default function onKeyDown(\n  event: React.KeyboardEvent,\n  controller: Controller,\n  next: Function,\n) {\n  const { document, selection } = controller.value;\n  const { key: focusKey } = selection.focus;\n\n  if (selection.isCollapsed && hotkeys.isEnter(event)) {\n    return onEnter(event, controller, next);\n  }\n\n  const colorBlocks = document.getClosest(\n    focusKey,\n    ColorBlocks.isColorBlocks,\n  ) as ColorBlocks | undefined;\n\n  if (!colorBlocks) {\n    return next();\n  }\n\n  const isBackspaceHotKey = isKeyHotkey('backspace');\n  const isDeleteHotKey = isKeyHotkey('delete');\n\n  if (isBackspaceHotKey(event) || isDeleteHotKey(event)) {\n    if (\n      colorBlocks.nodes.length === 1 &&\n      isEmptyParagraph(colorBlocks.nodes[0] as Block)\n    ) {\n      event.preventDefault();\n      const path = document.getPath(colorBlocks.key)!;\n      const index = path.pop()!;\n      const p = Paragraph.create({ nodes: [Text.create()] });\n      // Before: 插入空段落 -> 删除高亮块\n      // Now: 将高亮块中的段落移除到高亮块所在位置 -> 删除空的高亮块\n      // 这样可以避免 Undo 时选区由于 remove_node 移动到高亮块前的节点末尾，无法被选区矫正纠正\n      return controller\n        .command(Commands.moveNodeByPath, Path.link(path, [index, 0]), path, index)\n        .command(Commands.removeNodeByPath, Path.link(path, [index + 1]));\n    }\n  }\n\n  // 如果在嵌套的子元素内全选，就先忽略掉\n  const closestTable = document.getClosest(focusKey, Table.isTable);\n  const skipSelectAll = closestTable && colorBlocks.getNode(closestTable.key);\n\n  if (hotkeys.isSelectAll(event) && !skipSelectAll) {\n    event.preventDefault();\n    return controller\n      .command(Commands.moveAnchorToStartOfNode, colorBlocks.nodes[0])\n      .command(\n        Commands.moveFocusToEndOfNode,\n        colorBlocks.nodes[colorBlocks.nodes.length - 1],\n      );\n  }\n\n  return next();\n}\n"],"file":"onKeyDown.js"}