{"version":3,"sources":["../../../../../src/plugins/hoverToolbar/components/HoverToolbar.tsx"],"names":["React","debounce","noop","throttle","ResizeObserver","ToolbarLayout","useZoomContainer","useZoom","domUtils","Block","Inline","useScrollableContainer","useScrollableContent","PluginRoles","HoverToolbarContexts","ActiveInteractionHooks","BasicPortal","Portal","usePlugins","useHoverCapture","HOVER_TOOLBAR_HEIGHT","SAFE_CONTAINER_MARGIN_TOP","SAFE_NODE_MARGIN_TOP","SAFE_CONTAINER_MARGIN_RIGHT_OR_LEFT","SCROLL_TIMEOUT","getHoverToolbarLayout","HoverToolbarWrapper","HOVER_TOOLBAR_NOT_READY","HOVER_TOOLBAR_SLIDE_IN","useActiveInteraction","HoverToolbar","props","controller","configs","plugins","zoomContainer","scrollableContainer","hoverCapture","zoom","currentNode","useRef","useState","singleToolbar","setSingleToolbar","wrapperRef","toolbarWidth","inOuterContainer","setInOuterContainer","inOuterContainerRef","innerContainer","window","document","body","outerContainer","Element","container","visiblePopoverSetRef","Set","needSlidInRef","isVisible","setVisible","content","activeType","setActiveType","activeRef","current","currentKey","setCurrentKey","showHoverToolbar","length","locale","useEffect","enableTrigger","style","opacity","reset","useCallback","clear","undefined","forceClose","updatePos","node","nodeDOM","findDOMNodeSafely","key","newStyle","position","nodeRect","getBoundingClientRect","contentRect","containerRect","Window","x","y","width","innerWidth","height","innerHeight","nodeX","nodeY","nodeW","nodeH","containerY","containerH","contentX","contentY","contentWidth","contentW","offsetWidth","top","classList","remove","left","toString","contains","add","handleResize","newWidth","observer","observe","disconnect","cancel","handleChange","mutationObserver","MutationObserver","childList","subtree","attributes","attributeFilter","getContainer","handleTrigger","msg","currentLayout","layoutConfigs","layouts","visiblePopoverSet","setActiveInteraction","on","off","handleScroll","addEventListener","removeEventListener","handleMouseEnter","getCurrentNode","isBlock","isInline","dispatch","type","reason","handleMouseLeave","handleAnimationEnd","event","target","hoverToolbar","padding"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { debounce, noop, throttle } from 'lodash-es';\nimport ResizeObserver from 'resize-observer-polyfill';\nimport { ToolbarLayout, IToolbarLayoutProps } from '@ali/we-design-next';\nimport { Controller, Node, useZoomContainer, useZoom, domUtils, Block, Inline } from '@ali/4ever-cangjie';\nimport { useScrollableContainer, useScrollableContent, PluginRoles } from '@ali/4ever-bamboo';\nimport { HoverToolbarContexts, ActiveInteractionHooks, BasicPortal as Portal } from '@ali/4ever-component';\nimport { usePlugins } from '../../../pluginsContext';\nimport { useHoverCapture } from '../context/hoverCaptureContext';\nimport { HoverCapture, ICallback } from '../utils/hoverCapture';\nimport { IHoverToolbarPluginConfigs } from '../types';\nimport { HOVER_TOOLBAR_HEIGHT, SAFE_CONTAINER_MARGIN_TOP, SAFE_NODE_MARGIN_TOP, SAFE_CONTAINER_MARGIN_RIGHT_OR_LEFT, SCROLL_TIMEOUT } from '../constants';\nimport { getHoverToolbarLayout } from './getHoverToolbarLayout';\nimport { HoverToolbarWrapper, HOVER_TOOLBAR_NOT_READY, HOVER_TOOLBAR_SLIDE_IN } from './styled';\n\ntype ISingLineItems = IToolbarLayoutProps['singleLineToolbar'];\nconst { useActiveInteraction } = ActiveInteractionHooks;\n\nexport interface IHoverToolbarProps {\n  controller: Controller;\n  configs: IHoverToolbarPluginConfigs;\n}\n\nexport const HoverToolbar: React.FC<IHoverToolbarProps> = ((props) => {\n  const { controller, configs } = props;\n  const plugins = usePlugins();\n  const zoomContainer = useZoomContainer();\n  const scrollableContainer = useScrollableContainer();\n  const hoverCapture = useHoverCapture();\n  const zoom = useZoom();\n  const currentNode = React.useRef<Node | null>(null);\n  const [singleToolbar, setSingleToolbar] = React.useState<ISingLineItems>();\n  const wrapperRef = React.useRef<HTMLDivElement>(null);\n  const toolbarWidth = React.useRef<number>(0);\n  const [inOuterContainer, setInOuterContainer] = React.useState(false);\n  const inOuterContainerRef = React.useRef(false);\n  const innerContainer = zoomContainer || window.document.body;\n  const outerContainer = scrollableContainer instanceof Element ? scrollableContainer : window.document.body;\n  const container = inOuterContainer ? outerContainer : innerContainer;\n  const visiblePopoverSetRef = React.useRef<Set<string>>(new Set());\n  const needSlidInRef = React.useRef<boolean>(false);\n  const [isVisible, setVisible] = React.useState(false);\n  const content = useScrollableContent();\n  const [activeType, setActiveType] = useActiveInteraction();\n  const activeRef = React.useRef('');\n  activeRef.current = activeType;\n  const [currentKey, setCurrentKey] = React.useState('');\n\n  const showHoverToolbar = singleToolbar && singleToolbar.length > 0;\n\n  inOuterContainerRef.current = inOuterContainer;\n  const locale = configs.locale || {};\n\n  React.useEffect(() => {\n    // inOuterContainer 更新时浮动工具栏会重新渲染\n    hoverCapture?.enableTrigger();\n    if (wrapperRef.current) {\n      wrapperRef.current.style.opacity = '1';\n    }\n  }, [inOuterContainer, hoverCapture]);\n\n  const reset = React.useCallback(() => {\n    visiblePopoverSetRef.current.clear();\n    hoverCapture?.enableTrigger();\n    setSingleToolbar(undefined);\n    toolbarWidth.current = 0;\n  }, [hoverCapture]);\n\n  React.useEffect(() => {\n    if (activeType && activeType !== 'hoverToolbarPopover') {\n      hoverCapture?.forceClose();\n      reset();\n    }\n  }, [activeType, hoverCapture]);\n\n  const updatePos = React.useCallback(() => {\n    const node = currentNode.current;\n    if (node && wrapperRef.current) {\n      if (toolbarWidth.current === 0) {\n        wrapperRef.current.style.opacity = '0';\n        return;\n      }\n      const nodeDOM = domUtils.findDOMNodeSafely(node.key, innerContainer);\n      if (nodeDOM) {\n        const newStyle: React.CSSProperties = {\n          position: 'absolute',\n        };\n        const nodeRect = nodeDOM.getBoundingClientRect();\n        const contentRect = innerContainer.getBoundingClientRect();\n        const containerRect = !scrollableContainer || scrollableContainer instanceof Window\n          ? { x: 0, y: 0, width: window.innerWidth, height: window.innerHeight }\n          : scrollableContainer.getBoundingClientRect();\n        const { x: nodeX, y: nodeY, width: nodeW, height: nodeH } = nodeRect;\n        const { y: containerY, height: containerH } = containerRect;\n        const { x: contentX, y: contentY, width: contentWidth } = contentRect;\n        const contentW = contentWidth || innerContainer.offsetWidth * zoom;\n        // 滚动的时候 contentWidth 可能为 0，会产生抖动\n        if (contentWidth === 0) {\n          return;\n        }\n        // 元素滚出下边缘\n        if (nodeY > containerY + containerH) {\n          newStyle.opacity = '0';\n          setVisible(false);\n          // 元素上边缘与滚动容器之间的距离足够固定安全距离 + 自适应安全距离 + 工具栏高度, 相对于纸张\n        } else if (nodeY >= containerY + (SAFE_CONTAINER_MARGIN_TOP + SAFE_NODE_MARGIN_TOP + HOVER_TOOLBAR_HEIGHT) * zoom) {\n          const top = (nodeY - contentY) / zoom - SAFE_NODE_MARGIN_TOP - HOVER_TOOLBAR_HEIGHT;\n          newStyle.top = top;\n          if (inOuterContainerRef.current) {\n            setInOuterContainer(false);\n            newStyle.opacity = '0';\n          } else {\n            newStyle.opacity = '1';\n            wrapperRef.current.classList.remove(HOVER_TOOLBAR_NOT_READY);\n          }\n          setVisible(true);\n          // 工具栏上边缘与容器上边缘距离固定, 相对于window\n        } else if ((nodeY + nodeH) >= containerY + (SAFE_CONTAINER_MARGIN_TOP + HOVER_TOOLBAR_HEIGHT) * zoom) {\n          const top = containerY + SAFE_CONTAINER_MARGIN_TOP * zoom + (zoom - 1) * HOVER_TOOLBAR_HEIGHT / 2;\n          newStyle.top = top;\n          newStyle.position = 'fixed';\n          if (!inOuterContainerRef.current) {\n            setInOuterContainer(true);\n            newStyle.opacity = '0';\n          } else {\n            newStyle.opacity = '1';\n            wrapperRef.current.classList.remove(HOVER_TOOLBAR_NOT_READY);\n          }\n          setVisible(true);\n          // 元素下边缘与滚动容器上边缘之间的距离不能容纳 工具栏高度 + 最小安全距离\n        } else {\n          setVisible(false);\n          newStyle.opacity = '0';\n        }\n        // 居中后左侧放不下\n        if (nodeX + nodeW / 2 - toolbarWidth.current * zoom / 2 - SAFE_CONTAINER_MARGIN_RIGHT_OR_LEFT * zoom < contentX) {\n          if (inOuterContainerRef.current) {\n            newStyle.left = SAFE_CONTAINER_MARGIN_RIGHT_OR_LEFT * zoom + contentX;\n          } else {\n            newStyle.left = SAFE_CONTAINER_MARGIN_RIGHT_OR_LEFT;\n          }\n        } else if (nodeX + nodeW / 2 - toolbarWidth.current * zoom / 2 - SAFE_CONTAINER_MARGIN_RIGHT_OR_LEFT * zoom >= contentX && nodeX + nodeW / 2 + toolbarWidth.current * zoom / 2 + SAFE_CONTAINER_MARGIN_RIGHT_OR_LEFT * zoom <= contentX + contentW) {\n          if (inOuterContainerRef.current) {\n            newStyle.left = nodeX + nodeW / 2 - toolbarWidth.current / 2;\n          } else {\n            newStyle.left = (nodeX + nodeW / 2 - toolbarWidth.current / 2 * zoom - contentX) / zoom;\n          }\n        } else if (inOuterContainerRef.current) {\n          newStyle.left = contentX + contentW - SAFE_CONTAINER_MARGIN_RIGHT_OR_LEFT * zoom;\n        } else {\n          newStyle.left = (contentX + contentW) / zoom - SAFE_CONTAINER_MARGIN_RIGHT_OR_LEFT;\n        }\n        if (!wrapperRef.current) {\n          hoverCapture?.forceClose();\n          return;\n        }\n        wrapperRef.current.style.top = `${newStyle.top || 0}px`;\n        wrapperRef.current.style.left = `${newStyle.left || 0}px`;\n        wrapperRef.current.style.opacity = (newStyle.opacity || 0).toString();\n        wrapperRef.current.style.position = newStyle.position || 'absolute';\n        if (needSlidInRef.current && !wrapperRef.current.classList.contains(HOVER_TOOLBAR_NOT_READY)) {\n          wrapperRef.current.classList.add(HOVER_TOOLBAR_SLIDE_IN);\n        }\n      } else {\n        hoverCapture?.forceClose();\n      }\n    }\n  }, [zoom, scrollableContainer, innerContainer, hoverCapture]);\n\n  React.useEffect(() => {\n    if (!singleToolbar) return noop;\n    const handleResize = debounce(() => {\n      const newWidth = wrapperRef.current?.offsetWidth || 0;\n      if (toolbarWidth.current !== newWidth) {\n        toolbarWidth.current = newWidth;\n        updatePos();\n      }\n    }, 200);\n    const observer = new ResizeObserver(handleResize);\n    wrapperRef.current && observer.observe(wrapperRef.current);\n    return () => {\n      observer.disconnect();\n      handleResize.cancel();\n      toolbarWidth.current = 0;\n    };\n  }, [singleToolbar, updatePos]);\n\n  React.useEffect(() => {\n    if (!singleToolbar) return noop;\n    const handleChange = throttle(() => {\n      updatePos();\n    }, 200);\n    const mutationObserver: MutationObserver = new MutationObserver(handleChange);\n    content && mutationObserver.observe(content, {\n      childList: true,\n      subtree: true,\n      attributes: true,\n      attributeFilter: ['style'],\n    });\n    return () => {\n      mutationObserver && mutationObserver.disconnect();\n      handleChange.cancel();\n    }\n  }, [singleToolbar, updatePos, content]);\n\n  const getContainer = React.useCallback(() => {\n    // Hack: 缩放的时候 popover 内部使用的 dom-align 不能正确定位到被 scale 的容器，所以需要挂载到 dom 上，缺点时不会跟随滚动\n    if (zoom !== 1) {\n      return window.document.body;\n    }\n    const innerContainer = zoomContainer || window.document.body;\n    const outerContainer = scrollableContainer instanceof Element ? scrollableContainer : window.document.body;\n    const container = inOuterContainerRef.current ? outerContainer : innerContainer;\n    return container;\n  }, [zoomContainer, scrollableContainer, zoom]);\n\n  React.useEffect(() => {\n    const handleTrigger: ICallback = (msg) => {\n      // 有其他激活中的菜单就不触发\n      if (activeRef.current && activeRef.current !== 'hoverToolbarPopover') {\n        return;\n      }\n      const { node = null } = msg;\n      if (currentNode.current !== node) {\n        if (!currentNode.current) {\n          needSlidInRef.current = true;\n        }\n        const currentLayout = node ? getHoverToolbarLayout({\n          layoutConfigs: configs.layouts || {},\n          plugins,\n          controller,\n          node,\n          hoverCapture: (hoverCapture as HoverCapture),\n          locale,\n          visiblePopoverSet: visiblePopoverSetRef.current,\n          activeRef,\n          setActiveInteraction: setActiveType,\n          reset,\n        }) : undefined;\n        setSingleToolbar(currentLayout);\n        setCurrentKey(node?.key || '');\n        currentNode.current = node;\n        toolbarWidth.current = 0;\n        if (!node) {\n          visiblePopoverSetRef.current.clear();\n          hoverCapture?.enableTrigger();\n        }\n      }\n    };\n    hoverCapture?.on(handleTrigger);\n    return () => {\n      hoverCapture?.off(handleTrigger);\n    };\n  }, [controller, configs, plugins, hoverCapture, updatePos, reset, setActiveType]);\n\n  React.useEffect(() => {\n    const handleScroll = throttle(() => {\n      updatePos();\n    }, SCROLL_TIMEOUT);\n    scrollableContainer?.addEventListener('scroll', handleScroll);\n    return () => {\n      scrollableContainer?.removeEventListener('scroll', handleScroll);\n    }\n  }, [scrollableContainer, updatePos]);\n\n  const handleMouseEnter = React.useCallback(() => {\n    const node = hoverCapture?.getCurrentNode();\n    if (!Block.isBlock(node) && !Inline.isInline(node)) return;\n    controller.dispatch('updateHighlight', {\n      node,\n      type: 'hover',\n      reason: 'hoverToolbar',\n    })\n  }, [hoverCapture]);\n\n  const handleMouseLeave = React.useCallback(() => {\n    const node = hoverCapture?.getCurrentNode();\n    if (!Block.isBlock(node) && !Inline.isInline(node)) return;\n    controller.dispatch('removeHighlight', {\n      node,\n      type: 'hover',\n      reason: 'hoverToolbar',\n    })\n  }, [hoverCapture]);\n\n  const handleAnimationEnd = React.useCallback((event: React.AnimationEvent) => {\n    const { target } = event;\n    const { classList } = (target as HTMLDivElement);\n    classList.remove(HOVER_TOOLBAR_SLIDE_IN);\n    needSlidInRef.current = false;\n  }, []);\n\n  return showHoverToolbar ? (\n    <Portal\n      container={container}\n    >\n      <HoverToolbarWrapper\n        ref={wrapperRef}\n        className={`hover-toolbar-wrapper ${HOVER_TOOLBAR_NOT_READY}`}\n        data-hover-toolbar\n        style={{\n          '--hover-toolbar-transform': inOuterContainer ? `scale(${zoom})` : 'scale(1)',\n        } as React.CSSProperties}\n        data-testid=\"hover-toolbar\"\n        onMouseEnter={handleMouseEnter}\n        onMouseLeave={handleMouseLeave}\n        onAnimationEnd={handleAnimationEnd}\n        data-role={PluginRoles.hoverToolbar}\n      >\n        <HoverToolbarContexts.GetContainerContext.Provider value={getContainer} >\n          <HoverToolbarContexts.HoverToolbarVisibleContext.Provider value={isVisible}>\n            <HoverToolbarContexts.VisiblePopoverSetContext.Provider value={visiblePopoverSetRef.current}>\n              <ToolbarLayout\n                mode=\"singleLine\"\n                singleLineToolbar={singleToolbar}\n                layout=\"fit-content\"\n                align=\"left\"\n                style={{\n                  padding: '2px 0',\n                }}\n                key={currentKey}\n              />\n            </HoverToolbarContexts.VisiblePopoverSetContext.Provider>\n          </HoverToolbarContexts.HoverToolbarVisibleContext.Provider>\n        </HoverToolbarContexts.GetContainerContext.Provider>\n      </HoverToolbarWrapper>\n    </Portal>\n  ) : null;\n});\n"],"file":"HoverToolbar.js"}