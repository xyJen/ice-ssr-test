{"version":3,"sources":["../../../../../src/plugins/indent/handlers/onTab.ts"],"names":["Commands","decreaseIndent","increaseIndent","getBlocksFromEditor","getClosestParagraph","IndentTrigger","onTab","event","editor","next","value","document","query","preventDefault","selection","currentParagraph","isAtStartofParagraph","getStart","isAtStartOfNode","selectedBlocks","selectedMultiBlocks","length","selectedAllBlock","isExpanded","shiftKey","isCollapsed","keyboard","toolbar","command","del","insertText","currentItems","data","list"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { Controller, Commands } from '@ali/4ever-cangjie';\n;\nimport decreaseIndent from '../commands/decreaseIndent';\nimport increaseIndent from '../commands/increaseIndent';\nimport { getBlocksFromEditor }  from '@ali/4ever-utils';\nimport { getClosestParagraph } from '@ali/4ever-utils';\nimport { IndentTrigger } from '../utils';\n\n\nexport default function onTab(event: React.KeyboardEvent, editor: Controller, next: Function) {\n  const { value } = editor;\n  const { document } = value;\n  if (editor.query('isSelectionInTableCell')) {\n    return next();\n  }\n  event.preventDefault();\n  const { selection } = value;\n  if (!selection) return next();\n\n  const currentParagraph = getClosestParagraph(value);\n  if (!currentParagraph) return next();\n  const isAtStartofParagraph = selection ? selection.getStart(document).isAtStartOfNode(currentParagraph) : null;\n  const selectedBlocks = getBlocksFromEditor(editor);\n  const selectedMultiBlocks = selectedBlocks.length > 1;\n  let selectedAllBlock = false;\n  if (selection.isExpanded && editor.query('isSelectWholeBlocks')) {\n    selectedAllBlock = true;\n  }\n\n  if (event.shiftKey && isAtStartofParagraph) {\n    /* 在段首且没有选区时，逻辑和“减少缩进”按钮相同 */\n    if (selection.isCollapsed) {\n      return decreaseIndent(editor, IndentTrigger.keyboard);\n    }\n\n    /* 在段首有选区时：\n     * 1. 选中多段或整段选中时视为仅减少缩进\n     * 2. 否则先删除选区内容再执行减少缩进逻辑\n    */\n    if (selectedMultiBlocks || selectedAllBlock) {\n      return decreaseIndent(editor, IndentTrigger.toolbar);\n    }\n    editor.command(Commands.del);\n    return decreaseIndent(editor, IndentTrigger.keyboard);\n  }\n\n  if (selection.isCollapsed) {\n    if (!isAtStartofParagraph) {\n      // 未选中且在段内时\n      return editor.command(Commands.insertText, '    ');\n    }\n\n    const currentItems = editor.query('getListCurrentItem');\n    if (currentItems?.length && currentItems[0]?.data?.list) {\n      // 不处理列表\n      return next();\n    }\n    return increaseIndent(editor, IndentTrigger.keyboard);\n  }\n\n  if (!isAtStartofParagraph) {\n    // 不在段首且选中时：先删除后插入tab\n    return editor.command(Commands.del).command(Commands.insertText, '    ');\n  }\n\n  const currentItems = editor.query('getListCurrentItem');\n  if (currentItems?.length && currentItems[0]?.data?.list) {\n    return next();\n  }\n\n  if (selectedMultiBlocks || selectedAllBlock) {\n    return increaseIndent(editor, IndentTrigger.toolbar);\n  }\n  editor.command('deleteAtRange', selection!);\n  return increaseIndent(editor, IndentTrigger.keyboard);\n}\n"],"file":"onTab.js"}