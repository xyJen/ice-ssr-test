import _extends from "@babel/runtime/helpers/extends";
import { Commands } from '@ali/4ever-cangjie';
import { getClosestParagraph } from '@ali/4ever-utils';
import { getBlocksFromEditor, isEqualWithDefault } from '@ali/4ever-utils';
import { decreaseListLevel } from "../utils/setListLevelByIntent";
import { INDENT_SIZE, MIN_INDENT_SIZE, INDENT_SIZE_CHARS, DEFAULT_INDENT, IndentTrigger } from "../utils";
export default (function (editor, trigger, givenValue) {
  var value = editor.value;
  var indentVal = givenValue !== undefined ? givenValue : INDENT_SIZE;
  var selectedBlocks = getBlocksFromEditor(editor);

  var _ref = editor.query('getListDepthItems') || {},
      depthItems = _ref.depthItems,
      hasFirstStart = _ref.hasFirstStart;

  if (hasFirstStart) {
    selectedBlocks = depthItems;
  }

  selectedBlocks.forEach(function (node) {
    var indentNode = getClosestParagraph(value, node);

    if (indentNode) {
      var indentNodeData = indentNode.data || {};
      var list = indentNodeData.list;

      if (list) {
        return decreaseListLevel(editor, indentNode, hasFirstStart);
      }

      var ind = indentNodeData.ind || {}; // data.ind can be null

      var nextInd = _extends({}, ind);

      var _ind$firstLine = ind.firstLine,
          firstLine = _ind$firstLine === void 0 ? 0 : _ind$firstLine,
          _ind$firstLineChars = ind.firstLineChars,
          firstLineChars = _ind$firstLineChars === void 0 ? 0 : _ind$firstLineChars,
          _ind$left = ind.left,
          left = _ind$left === void 0 ? 0 : _ind$left,
          _ind$leftChars = ind.leftChars,
          leftChars = _ind$leftChars === void 0 ? 0 : _ind$leftChars,
          _ind$hanging = ind.hanging,
          hanging = _ind$hanging === void 0 ? 0 : _ind$hanging,
          _ind$hangingChars = ind.hangingChars,
          hangingChars = _ind$hangingChars === void 0 ? 0 : _ind$hangingChars;
      var firstLineIndent = firstLineChars || firstLine;
      var hangingIndent = hangingChars || hanging || firstLine < 0;

      switch (trigger) {
        case IndentTrigger.keyboard:
          if (hangingIndent) {
            // 取消设置的悬挂缩进
            delete nextInd.hanging;
            delete nextInd.hangingChars;

            if (firstLine < 0) {
              delete nextInd.firstLine;
            }
          } else if (firstLineIndent) {
            // 取消设置的行首缩进
            delete nextInd.firstLine;
            delete nextInd.firstLineChars;
          } else if (leftChars) {
            // 未设置行首和悬挂缩进：减少 left 和 leftChars
            // 一次减少两字符
            nextInd.leftChars = Math.max(leftChars - INDENT_SIZE_CHARS, MIN_INDENT_SIZE); // 兜底

            nextInd.left = nextInd.leftChars / INDENT_SIZE_CHARS * INDENT_SIZE;
          } else {
            nextInd.left = Math.max(left - indentVal, MIN_INDENT_SIZE);
          }

          break;

        default:
          // 传进来的视为像素单位
          if (leftChars) {
            // toolbar 按钮一次少两个字符
            nextInd.leftChars = Math.max(leftChars - INDENT_SIZE_CHARS, MIN_INDENT_SIZE);
            nextInd.left = nextInd.leftChars / INDENT_SIZE_CHARS * INDENT_SIZE;
          } else {
            nextInd.left = Math.max(left - indentVal, MIN_INDENT_SIZE);
          }

      }

      if (isEqualWithDefault(nextInd, ind, DEFAULT_INDENT)) {
        return undefined;
      }

      editor.command(Commands.setNodeByKey, indentNode.key, {
        data: _extends({}, indentNodeData, {
          ind: nextInd
        })
      });
    }

    return undefined;
  });
  return editor;
});
//# sourceMappingURL=decreaseIndent.js.map