{"version":3,"sources":["../../../../../src/plugins/quickPreview/hooks/createRenderContent.tsx"],"names":["React","constants","environment","Actions","DB_CLICK_TIME","DB_CLICK_PX","DB_CLICK_SCROLL_PX","OFFSET_NONE","lastMouseDown","lastClick","time","x","y","isElementInContent","element","key","content","closest","Selector","querySelector","DbClick","controller","configs","useEffect","handleTouchStart","event","timer","clearTimeout","value","isFocused","document","target","touches","HTMLElement","length","isHitTitle","HTMLTextAreaElement","clientX","clientY","now","Date","timeCount","xCount","Math","abs","yCount","hitTest","run","type","EXIT","payload","noScroll","noFocus","focus","preventDefault","handleTouchEnd","changedTouches","handleClick","setTimeout","onPreviewClick","handleMousedown","IS_IPAD","currentTime","window","addEventListener","passive","removeEventListener","createRenderContent","renderContent","props","next","isQuickPreview","Boolean","query"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { Controller, constants, environment } from '@ali/4ever-cangjie';\n\nimport Actions from '../actions';\nimport { QuickPreviewConfigs } from '../types';\n\n/**\n * 这里使用默认的 db click 非常容易误触。\n * 参考了飞书的行为，把触发的参数控制的非常严格\n */\n\n/**\n * 连续两次 touch 之间的最大间隔时间 ms\n * 和飞书对比，300 明显偏大，200 明显偏小。250 感觉还是偏大，暂用\n */\nconst DB_CLICK_TIME = 250;\n// 连续两次 touch 之间的最大间隔距离 px\nconst DB_CLICK_PX = 15;\n// touch start 和 end 之间，移动超过 px 就判定无效\nconst DB_CLICK_SCROLL_PX = 1;\nconst OFFSET_NONE = -1000;\n\nlet lastMouseDown = 0;\nlet lastClick = { time: 0, x: OFFSET_NONE, y: OFFSET_NONE };\n\nfunction isElementInContent(element: HTMLElement, key: string) {\n  const content = element.closest(`[${constants.Selector.content}]`);\n  if (\n    !content ||\n    !content.querySelector(`[${constants.Selector.key}=\"${key}\"]`)\n  ) {\n    return false;\n  }\n  return true;\n}\n\nfunction DbClick({\n  controller,\n  configs,\n}: {\n  controller: Controller;\n  configs?: QuickPreviewConfigs;\n}) {\n  React.useEffect(() => {\n    const handleTouchStart = (event: TouchEvent) => {\n      timer && clearTimeout(timer);\n      const { isFocused, document } = controller.value;\n      if (isFocused) {\n        return;\n      }\n      const { target, touches } = event;\n      if (!(target instanceof HTMLElement) || !touches.length) {\n        return;\n      }\n      if (!isElementInContent(target, document.key)) {\n        return;\n      }\n\n      // hack, to be removed later\n      const isHitTitle =\n        target instanceof HTMLTextAreaElement &&\n        target.closest('#doc-title-area');\n      const { clientX, clientY } = touches[0];\n      const now = Date.now();\n      const timeCount = now - lastClick.time;\n      const xCount = Math.abs(clientX - lastClick.x);\n      const yCount = Math.abs(clientY - lastClick.y);\n      const hitTest =\n        timeCount < DB_CLICK_TIME &&\n        xCount < DB_CLICK_PX &&\n        yCount < DB_CLICK_PX;\n      if (hitTest) {\n        controller.run('onAction', {\n          type: Actions.EXIT,\n          payload: { noScroll: true, noFocus: isHitTitle },\n        });\n        if (isHitTitle) {\n          target.focus();\n        }\n      } else if (isHitTitle) {\n        event.preventDefault();\n      }\n      lastClick = { time: now, x: clientX, y: clientY };\n    };\n\n    const handleTouchEnd = (event: TouchEvent) => {\n      if (controller.value.isFocused) {\n        return;\n      }\n      const { target, changedTouches } = event;\n      if (!(target instanceof HTMLElement) || !changedTouches.length) {\n        return;\n      }\n      const { clientX, clientY } = changedTouches[0];\n      const xCount = Math.abs(clientX - lastClick.x);\n      const yCount = Math.abs(clientY - lastClick.y);\n      if (xCount > DB_CLICK_SCROLL_PX || yCount > DB_CLICK_SCROLL_PX) {\n        // 发生了滚动，重置掉\n        lastClick.time = 0;\n      }\n      lastClick.x = clientX;\n      lastClick.y = clientY;\n    };\n    let timer: any = null;\n    const handleClick = (event: MouseEvent) => {\n      if (!(event.target instanceof HTMLElement)) {\n        return;\n      }\n      const { document } = controller.value;\n      if (!isElementInContent(event.target, document.key)) {\n        return;\n      }\n      timer = setTimeout(() => {\n        if (configs?.onPreviewClick) {\n          configs.onPreviewClick();\n        }\n      }, DB_CLICK_TIME * 2);\n    };\n    const handleMousedown = (event: MouseEvent) => {\n      if (!environment.IS_IPAD) {\n        return;\n      }\n      const isHitTitle =\n        event.target instanceof HTMLTextAreaElement &&\n        event.target.closest('#doc-title-area');\n      const currentTime = Date.now();\n\n      const hitTest = currentTime - lastMouseDown < DB_CLICK_TIME;\n      if (hitTest) {\n        controller.run('onAction', {\n          type: Actions.EXIT,\n          payload: { noScroll: true, noFocus: isHitTitle },\n        });\n        if (isHitTitle) {\n          event.target.focus();\n        }\n        lastMouseDown = 0;\n      } else {\n        lastMouseDown = Date.now();\n        isHitTitle && event.preventDefault();\n      }\n    };\n    window.document.addEventListener('touchstart', handleTouchStart, {\n      passive: false,\n    });\n    window.document.addEventListener('touchend', handleTouchEnd);\n    window.document.addEventListener('touchcancel', handleTouchEnd);\n    window.document.addEventListener('mousedown', handleMousedown);\n    window.document.addEventListener('click', handleClick);\n    return () => {\n      timer && clearTimeout(timer);\n      window.document.removeEventListener('touchstart', handleTouchStart);\n      window.document.removeEventListener('touchend', handleTouchEnd);\n      window.document.removeEventListener('touchcancel', handleTouchEnd);\n      window.document.removeEventListener('mousedown', handleMousedown);\n      window.document.removeEventListener('click', handleClick);\n    };\n  }, [controller]);\n  return null;\n}\n\nexport default function createRenderContent(configs?: QuickPreviewConfigs) {\n  return function renderContent(props, controller: Controller, next) {\n    const isQuickPreview = Boolean(controller.query('isQuickPreview'));\n    return (\n      <React.Fragment>\n        {isQuickPreview && (\n          <DbClick controller={controller} configs={configs} />\n        )}\n        {next()}\n      </React.Fragment>\n    );\n  };\n}\n"],"file":"createRenderContent.js"}