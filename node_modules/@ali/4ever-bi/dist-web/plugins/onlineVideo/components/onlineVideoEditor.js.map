{"version":3,"sources":["../../../../../src/plugins/onlineVideo/components/onlineVideoEditor.tsx"],"names":["React","WebBetaNormal","useOnClickOutside","InsertWrapper","Input","Button","IconWrapper","removeOnlineVideo","focusOnlineVideoEditor","selectOnlineVideo","judgeVideoType","url","test","stopPropagation","e","OnlineVideoEditor","props","controller","onSave","isValidVideoURL","locale","node","pluginState","onFocus","onBlur","portalRef","useRef","onlineVideoRef","nodeRef","useState","setUrl","inputRef","createRef","data","useEffect","id","current","focus","select","onInputBlur","useCallback","onInputFocus","preventDefault","run","handleClickoutside","event","target","contains","onInsertOnlineVideo","type","src","handleInput","value","onIconClick","placeholder","ok","memo"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { Controller, Node, Block } from '@ali/4ever-cangjie';\nimport { WebBetaNormal } from '@ali/we-design';\nimport { useOnClickOutside } from '@ali/4ever-component';\nimport { InsertWrapper, Input, Button, IconWrapper } from './styled';\nimport {\n  removeOnlineVideo,\n  focusOnlineVideoEditor,\n  selectOnlineVideo,\n} from '../actions';\n\nconst judgeVideoType = (url) => {\n  if (/youku/.test(url)) {\n    return 'youku';\n  }\n  return 'mp4';\n};\n\nconst stopPropagation = (e) => {\n  e.stopPropagation();\n};\n\ninterface IProps {\n  controller: Controller;\n  onSave: (params: any) => void;\n  isValidVideoURL: (url: string) => boolean;\n  locale: Record<string, any>;\n  node: Node;\n  pluginState: Record<string, boolean>;\n  onFocus: () => void;\n  onBlur: () => void;\n}\n\nconst OnlineVideoEditor = (props: IProps) => {\n  const {\n    controller,\n    onSave,\n    isValidVideoURL,\n    locale = {},\n    node,\n    pluginState,\n    onFocus,\n    onBlur,\n  } = props;\n  const portalRef = React.useRef<HTMLDivElement>(null);\n  const onlineVideoRef = React.useRef<HTMLDivElement>(null);\n  const nodeRef = React.useRef(node);\n  const [url, setUrl] = React.useState('');\n  const inputRef = React.createRef<HTMLInputElement>();\n  const { data } = node as Block;\n\n  React.useEffect(() => {\n    if (pluginState[data.id]) {\n      // TODO 主动 focus 失效，原因待查\n      inputRef.current?.focus();\n      inputRef.current?.select();\n      onFocus();\n    }\n  }, [pluginState]);\n\n  const onInputBlur = React.useCallback(() => {\n    onBlur();\n  }, []);\n\n  const onInputFocus = React.useCallback((e) => {\n    e.preventDefault();\n    e.stopPropagation();\n    controller.run('onAction', focusOnlineVideoEditor(nodeRef.current));\n    onFocus();\n  }, []);\n\n  const handleClickoutside = React.useCallback((event) => {\n    const target = event.target as HTMLElement;\n    if (\n      target === onlineVideoRef.current ||\n      onlineVideoRef.current?.contains(target)\n    ) {\n      return;\n    }\n    controller.run('onAction', removeOnlineVideo(node));\n  }, []);\n\n  useOnClickOutside(portalRef, handleClickoutside);\n\n  const onInsertOnlineVideo = () => {\n    if (!isValidVideoURL || !isValidVideoURL(url)) {\n      return;\n    }\n    const type = judgeVideoType(url);\n    onSave({\n      src: url,\n      type,\n    });\n  };\n\n  const handleInput = (e) => {\n    setUrl(e.target.value);\n  };\n\n  const onIconClick = (e) => {\n    e.preventDefault();\n    e.stopPropagation();\n    controller.run('onAction', selectOnlineVideo(nodeRef.current));\n  };\n\n  return (\n    <InsertWrapper ref={onlineVideoRef}>\n      <IconWrapper onClick={onIconClick}>\n        <WebBetaNormal />\n      </IconWrapper>\n      <Input\n        ref={inputRef}\n        placeholder={locale.placeholder}\n        onBlur={onInputBlur}\n        onFocus={onInputFocus}\n        onChange={handleInput}\n        onKeyDown={stopPropagation}\n        onMouseDown={stopPropagation}\n        onClick={stopPropagation}\n      />\n      <Button onClick={onInsertOnlineVideo}>{locale.ok}</Button>\n    </InsertWrapper>\n  );\n};\n\nexport default React.memo(OnlineVideoEditor);\n"],"file":"onlineVideoEditor.js"}