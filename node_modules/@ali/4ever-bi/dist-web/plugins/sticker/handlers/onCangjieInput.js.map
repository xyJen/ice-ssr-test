{"version":3,"sources":["../../../../../src/plugins/sticker/handlers/onCangjieInput.ts"],"names":["getEmojiData","getMatchedEmojiQuery","insertMarkdownEmoji","emojiMap","getEmojiMap","onCangjieInput","event","controller","next","detail","data","onSpace","value","selection","document","startText","isExpanded","anchorInline","endPoint","convertToTextPoints","end","text","slice","offset","queryInfo","path","getPath","key","preventDefault","query","offsetWithDelimiter","start","emoji","run"],"mappings":";;AACA,SAASA,YAAT,QAA6B,2BAA7B;AACA,OAAOC,oBAAP;AACA,SAASC,mBAAT;AAEA,IAAIC,QAAoC,GAAG,IAA3C;;SACeC,W;;;;;0EAAf;AAAA;AAAA;AAAA;AAAA;AAAA,gBACOD,QADP;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAEiBH,YAAY,EAF7B;;AAAA;AAAA;;AAAA;AAAA,6CAISG,QAJT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;;;AAOA,IAAME,cAAwC,GAAG,SAA3CA,cAA2C,CAACC,KAAD,EAAQC,UAAR,EAAoBC,IAApB,EAA6B;AAC5E,MAAIF,KAAK,CAACG,MAAN,CAAaC,IAAb,KAAsB,GAA1B,EAA+B,OAAOF,IAAI,EAAX;AAC/B,SAAOG,OAAO,CAACL,KAAD,EAAQC,UAAR,EAAoBC,IAApB,CAAd;AACD,CAHD;;AAIA,eAAeH,cAAf;AAEA;AACA;AACA;AACA;AACA;AACA;;SACeM,O;;;;;sEAAf,kBAAuBL,KAAvB,EAA8BC,UAA9B,EAA0CC,IAA1C;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,gCAC6CD,UAAU,CAACK,KADxD,EACUC,SADV,qBACUA,SADV,EACqBC,QADrB,qBACqBA,QADrB,EAC+BC,SAD/B,qBAC+BA,SAD/B;;AAAA,kBAEMF,SAAS,CAACG,UAAV,IAAwB,CAACD,SAAzB,IAAsCR,UAAU,CAACK,KAAX,CAAiBK,YAF7D;AAAA;AAAA;AAAA;;AAAA,8CAGWT,IAAI,EAHf;;AAAA;AAIQU,YAAAA,QAJR,GAImBL,SAAS,CAACM,mBAAV,CAA8BL,QAA9B,EAAwCM,GAJ3D;AAKQC,YAAAA,IALR,GAKeN,SAAS,CAACM,IAAV,CAAeC,KAAf,CAAqB,CAArB,EAAwBJ,QAAQ,CAACK,MAAjC,CALf;;AAAA,gBAMOF,IANP;AAAA;AAAA;AAAA;;AAAA,8CAMoBb,IAAI,EANxB;;AAAA;AAOQgB,YAAAA,SAPR,GAOoBvB,oBAAoB,CAACoB,IAAD,EAAO,IAAP,CAPxC;AAQQI,YAAAA,IARR,GAQeX,QAAQ,CAACY,OAAT,CAAiBX,SAAS,CAACY,GAA3B,CARf;;AAAA,kBASM,CAACH,SAAD,IAAc,CAACC,IATrB;AAAA;AAAA;AAAA;;AAAA,8CASkCjB,IAAI,EATtC;;AAAA;AAUEF,YAAAA,KAAK,CAACsB,cAAN;AACQC,YAAAA,KAXV,GAWyCL,SAXzC,CAWUK,KAXV,EAWiBC,mBAXjB,GAWyCN,SAXzC,CAWiBM,mBAXjB;AAYUC,YAAAA,KAZV,GAYyBD,mBAZzB,CAYUC,KAZV,EAYiBX,GAZjB,GAYyBU,mBAZzB,CAYiBV,GAZjB;AAAA;AAAA,mBAayBhB,WAAW,EAbpC;;AAAA;AAaQD,YAAAA,QAbR;AAcQ6B,YAAAA,KAdR,GAcgB7B,QAAQ,CAAC0B,KAAD,CAdxB;;AAAA,gBAeOG,KAfP;AAAA;AAAA;AAAA;;AAAA,8CAeqBxB,IAAI,EAfzB;;AAAA;AAgBQmB,YAAAA,GAhBR,GAgBcZ,SAAS,CAACY,GAhBxB;AAiBEpB,YAAAA,UAAU,CAAC0B,GAAX,CAAe,UAAf,EAA2B/B,mBAAmB,CAAC;AAAEyB,cAAAA,GAAG,EAAHA,GAAF;AAAOI,cAAAA,KAAK,EAALA,KAAP;AAAcX,cAAAA,GAAG,EAAHA,GAAd;AAAmBY,cAAAA,KAAK,EAALA;AAAnB,aAAD,CAA9C;;AAjBF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G","sourcesContent":["import { Plugin } from '@ali/4ever-cangjie';\nimport { getEmojiData } from '@ali/4ever-plugin-sticker';\nimport getMatchedEmojiQuery from '../utils/getMatchedEmojiQuery';\nimport { insertMarkdownEmoji } from '../actions';\n\nlet emojiMap: Record<string, any> | null = null;\nasync function getEmojiMap() {\n  if (!emojiMap) {\n    return await getEmojiData();\n  }\n  return emojiMap;\n}\n\nconst onCangjieInput: Plugin['onCangjieInput'] = (event, controller, next) => {\n  if (event.detail.data !== ' ') return next();\n  return onSpace(event, controller, next);\n};\nexport default onCangjieInput;\n\n/**\n * 通过::+space触发emoji的逻辑\n * @param event\n * @param controller\n * @param next\n */\nasync function onSpace(event, controller, next) {\n  const { selection, document, startText } = controller.value;\n  if (selection.isExpanded || !startText || controller.value.anchorInline)\n    return next();\n  const endPoint = selection.convertToTextPoints(document).end;\n  const text = startText.text.slice(0, endPoint.offset);\n  if (!text) return next();\n  const queryInfo = getMatchedEmojiQuery(text, true);\n  const path = document.getPath(startText.key);\n  if (!queryInfo || !path) return next();\n  event.preventDefault();\n  const { query, offsetWithDelimiter } = queryInfo;\n  const { start, end } = offsetWithDelimiter;\n  const emojiMap = await getEmojiMap();\n  const emoji = emojiMap[query];\n  if (!emoji) return next();\n  const key = startText.key;\n  controller.run('onAction', insertMarkdownEmoji({ key, start, end, emoji }));\n}\n"],"file":"onCangjieInput.js"}