{"version":3,"sources":["../../../../../src/plugins/sticker/handlers/onCangjieSelect.ts"],"names":["Commands","Selection","Queries","Sticker","SELECTION_TRIGGER","moveCaret","setRange","MOVE_UPWARD","MOVE_DOWNWARD","MOVE_BACKWARD","MOVE_FORWARD","SELECT_START","MOVE_SET","queryRange","getTargetMethod","moveMethod","onCangjieSelect","event","controller","next","detail","trigger","selection","anchor","value","document","isCollapsed","isTextPoint","maybeInline","getClosestInline","key","isSticker","run","offset","range","query","maybeSticker","getParent","point","pointAtDistance","command","select","create","focus","data"],"mappings":"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","sourcesContent":["import { Controller, Commands, Selection, Queries } from '@ali/4ever-cangjie';\nimport { Sticker } from '@ali/4ever-mo';\nimport { SELECTION_TRIGGER } from '@ali/4ever-utils';\nimport { moveCaret, setRange } from '../actions';\n\nconst {\n  MOVE_UPWARD,\n  MOVE_DOWNWARD,\n  MOVE_BACKWARD,\n  MOVE_FORWARD,\n  SELECT_START,\n} = SELECTION_TRIGGER;\n\nconst MOVE_SET = {\n  [MOVE_UPWARD]: {\n    queryRange: 'getUpsideRange',\n    getTargetMethod: 'getPreviousNode',\n    moveMethod: 'moveToEndOfNode',\n  },\n  [MOVE_DOWNWARD]: {\n    queryRange: 'getDownsideRange',\n    getTargetMethod: 'getNextNode',\n    moveMethod: 'moveToStartOfNode',\n  },\n};\n\nexport default function onCangjieSelect(event, controller: Controller, next) {\n  const { trigger, selection } = event.detail;\n  const { anchor } = selection;\n  const { value } = controller;\n  const { document } = value;\n  if (!selection.isCollapsed || !anchor.isTextPoint()) {\n    return next();\n  }\n  const maybeInline = document.getClosestInline(anchor.key);\n  if (Sticker.isSticker(maybeInline)) {\n    if (trigger === MOVE_BACKWARD) {\n      return controller.run('onAction', moveCaret({ offset: -1 }));\n    }\n    if (trigger === MOVE_FORWARD) {\n      return controller.run('onAction', moveCaret({ offset: 1 }));\n    }\n    if (trigger === MOVE_UPWARD || trigger === MOVE_DOWNWARD) {\n      const { queryRange } = MOVE_SET[trigger];\n      const range = controller.query(Queries[queryRange]);\n      if (!range) return controller;\n      const maybeSticker = document.getParent(range.anchor.key);\n      if (Sticker.isSticker(maybeSticker)) {\n        return controller.run('onAction', setRange({ range, trigger }));\n      }\n    }\n    // 点击到表格上时，纠正选区到下一个 text 开头\n    if (trigger === SELECT_START) {\n      const point = controller.query(Queries.pointAtDistance, selection.anchor, 1);\n      return controller.command(Commands.select, Selection.create({ anchor: point, focus: point, data: selection.data }));\n    }\n  }\n  return next();\n}\n"],"file":"onCangjieSelect.js"}