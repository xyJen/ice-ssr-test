{"version":3,"sources":["../../../../../src/plugins/formula/components/content.tsx"],"names":["React","useCallback","useEffect","useRef","useState","useMemo","styled","environment","Tag","FormulaPlugin","Dropdown","isKeyHotkey","FormulaView","FormulaPlaceholder","biActions","basicActions","FormulaTextarea","setFormulaData","setFormulaInjection","calcuSize","isEnterHotKey","isEscHotKey","isMobile","IS_MOBILE","FormulaWrapper","div","memo","props","isEditing","setIsEditing","modelFormulaData","node","data","metadata","formula","setFormula","controller","config","isSelected","value","startInline","selection","readOnly","currentFormula","textareaRef","isPlaceholder","locale","onTextareaChange","text","onClickConfirm","nextFormula","trim","tagData","run","onKeyDown","e","createFocusToNodeAction","key","onClickButton","handleEnter","event","isTag","isCollapsed","preventDefault","stopPropagation","current","focus","document","addEventListener","removeEventListener","getContainer","bodyEle","body","querySelector","onVisibleChange","visible","placeholder","formulaView","formulaTextarea","renderContent","showPlaceholder","content"],"mappings":"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","sourcesContent":["import React, { useCallback, useEffect, useRef, useState, useMemo } from 'react';\nimport styled from 'styled-components';\nimport { environment, RenderNodeProps, Element } from '@ali/4ever-cangjie';\nimport { Tag } from '@ali/4ever-mo';\nimport { FormulaPlugin } from '@ali/4ever-bamboo';\nimport { Dropdown } from '@ali/we-design';\nimport isKeyHotkey from 'is-hotkey';\nimport { FormulaConfig } from '../types';\nimport FormulaView from './view';\nimport FormulaPlaceholder from './placeholder';\nimport { biActions as basicActions } from '@ali/4ever-plugin-basic';\nimport FormulaTextarea from './textarea';\nimport { setFormulaData, setFormulaInjection } from '../actions';\n\nconst { calcuSize } = FormulaPlugin;\n\nconst isEnterHotKey = isKeyHotkey('enter');\nconst isEscHotKey = isKeyHotkey('esc');\n\ninterface FormulaProps extends RenderNodeProps<Element> {\n  // 插件配置\n  config?: FormulaConfig;\n}\n\nconst isMobile = environment.IS_MOBILE;\n\nconst FormulaWrapper = styled.div`\n  position: relative;\n  display: inline-flex;\n  vertical-align: middle;\n  border-radius: 4px;\n\n  .bi-katex-dropdown {\n    border: none;\n    box-shadow: 0px 8px 24px 0px rgba(0,0,0,0.16), 0px 0px 1px 0px rgba(0,0,0,0.24);\n    animation: scale-up-top 0.25s cubic-bezier(0.455, 0.030, 0.515, 0.955) both;\n  }\n`;\n\nexport default React.memo((props: FormulaProps) => {\n  const [isEditing, setIsEditing] = useState(false);\n\n  const modelFormulaData = props.node.data.metadata.formula || '';\n\n  // 这里保存临时的输入内容，当关闭弹窗就要把它置为空\n  const [formula, setFormula] = useState<string | null>(modelFormulaData);\n\n  const { node, controller, config, isSelected } = props;\n\n  const { startInline, selection } = controller.value;\n\n  const { readOnly } = controller;\n\n  const currentFormula = formula === null ? modelFormulaData : formula;\n\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n\n  const isPlaceholder = !currentFormula;\n\n  // 国际化文案\n  const locale = config?.locale || {};\n\n  const onTextareaChange = useCallback((text: string) => {\n    setFormula(text);\n  }, []);\n\n  const onClickConfirm = useCallback(() => {\n    const nextFormula = currentFormula.trim();\n\n    if (modelFormulaData !== nextFormula) {\n      const tagData = {\n        ...calcuSize(nextFormula),\n        metadata: {\n          formula: nextFormula,\n        },\n      };\n      controller.run('onAction', setFormulaData(node, tagData));\n    }\n  }, [modelFormulaData, currentFormula, controller, node]);\n\n  const onKeyDown = useCallback((e: React.KeyboardEvent<HTMLElement>) => {\n    if (isEditing && isEscHotKey(e)) {\n      setIsEditing(false);\n      onClickConfirm();\n\n      controller.run('onAction', basicActions.createFocusToNodeAction({ node }));\n    }\n  }, [isEditing, controller, node.key, onClickConfirm]);\n\n  const onClickButton = useCallback(() => {\n    onClickConfirm();\n    setIsEditing(false);\n  }, [onClickConfirm]);\n\n  useEffect(() => {\n    const data = calcuSize(currentFormula);\n    controller.run('onAction', setFormulaInjection(node.key, data));\n  }, [currentFormula, controller, node.key]);\n\n  useEffect(() => {\n    const handleEnter = (event: KeyboardEvent) => {\n      if (\n        isEnterHotKey(event) &&\n        Tag.isTag(startInline) &&\n        selection.isCollapsed &&\n        startInline.key === node.key\n      ) {\n        event.preventDefault();\n        event.stopPropagation();\n\n        setIsEditing(true);\n        textareaRef.current && textareaRef.current.focus();\n      }\n    };\n\n    document.addEventListener('keydown', handleEnter);\n    return () => {\n      document.removeEventListener('keydown', handleEnter);\n    };\n  }, [textareaRef, startInline, selection, node.key]);\n\n  const getContainer = useCallback(() => {\n    const bodyEle = document.body;\n    return document.querySelector('div[data-cangjie-content]') || bodyEle;\n  }, []);\n\n  const onVisibleChange = useCallback((visible: boolean) => {\n    setIsEditing(visible);\n\n    if (!visible) {\n      onClickConfirm();\n    } else {\n      textareaRef.current && textareaRef.current.focus();\n    }\n  }, [textareaRef, onClickConfirm]);\n\n  const placeholder = useMemo(() => {\n    return (\n      <FormulaPlaceholder\n        locale={locale}\n        notAllowed={readOnly || isMobile}\n        isSelected={isSelected}\n        isEditing={isEditing}\n      />\n    );\n  }, [readOnly, locale, isSelected, isEditing]);\n\n  const formulaView = useMemo(() => {\n    return (\n      <FormulaView\n        formula={currentFormula}\n        isEditing={isEditing}\n        isSelected={isSelected}\n      />\n    );\n  }, [currentFormula, isEditing, isSelected]);\n\n  const formulaTextarea = useMemo(() => {\n    return (\n      <FormulaTextarea\n        locale={locale}\n        formula={currentFormula}\n        config={config}\n        textareaRef={textareaRef}\n        onChange={onTextareaChange}\n        onButtonClick={onClickButton}\n      />\n    );\n  }, [locale, currentFormula, textareaRef, config, onTextareaChange, onClickButton]);\n\n  const renderContent = useMemo(() => {\n    const showPlaceholder = isPlaceholder && !currentFormula;\n    const content = showPlaceholder ? placeholder : formulaView;\n\n    if (readOnly || isMobile) {\n      return content;\n    }\n\n    return (\n      <Dropdown\n        trigger=\"click\"\n        getContainer={getContainer}\n        overlay={formulaTextarea}\n        visible={isEditing}\n        onVisibleChange={onVisibleChange}\n        placement=\"bottomLeft\"\n        overlayClassName=\"bi-katex-dropdown\"\n        zIndex={1000}\n      >\n        <div>{content}</div>\n      </Dropdown>\n    );\n  }, [\n    isPlaceholder,\n    isEditing,\n    placeholder,\n    formulaView,\n    readOnly,\n    getContainer,\n    formulaTextarea,\n    onVisibleChange,\n    currentFormula,\n  ]);\n\n  return (\n    <FormulaWrapper\n      data-cangjie-not-editable\n      onKeyDown={onKeyDown}\n    >\n      {renderContent}\n    </FormulaWrapper>\n  );\n});\n"],"file":"content.js"}