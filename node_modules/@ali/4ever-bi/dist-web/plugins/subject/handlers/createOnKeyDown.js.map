{"version":3,"sources":["../../../../../src/plugins/subject/handlers/createOnKeyDown.ts"],"names":["hotkeys","Commands","clearSubjectStyle","deleteSubject","selectSubject","unselectSubject","SELECTED_SUBJECT_KEY","hasSubjectBeenSelected","hasSubjectGroupBlocks","isSelectionCoverSubjectFromStart","isSubjectSelected","isEmptyNode","isSubjectHeading","toggleFold","isDeleteBackward","event","isDeleteWordBackward","isDeleteLineBackward","isDeleteForward","isDeleteWordForward","isDeleteLineForward","isDelete","createOnKeyDown","onKeyDown","controller","next","value","document","startBlock","endBlock","selection","nativeEvent","end","getEnd","isAtStartOfNode","query","preventDefault","command","key","isCollapsed","focus","getNextBlock","isAtEndOfNode","isEnter","fold","userData","get","splitBlock","selectedKey","data","block","getNode","isTextPoint","offset"],"mappings":"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","sourcesContent":["import { Plugin, hotkeys, Commands } from '@ali/4ever-cangjie';\nimport { clearSubjectStyle, deleteSubject, selectSubject, unselectSubject } from '../commands';\nimport { SELECTED_SUBJECT_KEY } from '../constants';\nimport { hasSubjectBeenSelected } from '../helpers';\nimport { hasSubjectGroupBlocks, isSelectionCoverSubjectFromStart, isSubjectSelected } from '../queries';\nimport { isEmptyNode, isSubjectHeading } from '../utils';\nimport { toggleFold } from '@ali/4ever-factory';\nimport type { Subject } from '../utils';\n\nfunction isDeleteBackward(event: KeyboardEvent) {\n  return hotkeys.isDeleteBackward(event) || hotkeys.isDeleteWordBackward(event) || hotkeys.isDeleteLineBackward(event);\n}\n\nfunction isDeleteForward(event: KeyboardEvent) {\n  return hotkeys.isDeleteForward(event) || hotkeys.isDeleteWordForward(event) || hotkeys.isDeleteLineForward(event);\n}\n\nfunction isDelete(event: KeyboardEvent) {\n  return isDeleteBackward(event) || isDeleteForward(event);\n}\n\nfunction createOnKeyDown(): Plugin['onKeyDown'] {\n  return function onKeyDown(event, controller, next) {\n    const { document, startBlock, endBlock, selection } = controller.value;\n\n    /**\n     * 限制 1：反向删除\n     * @description 若光标在议题开始处，且议题不为空，则不允许直接删除，选中议题块\n     */\n    if (isDeleteBackward(event.nativeEvent) && isSubjectHeading(endBlock)) {\n      const end = selection.getEnd(document);\n      if (\n        // 光标结束在议题的开头\n        end.isAtStartOfNode(endBlock) &&\n        // 标题不为空，或有内容\n        (!isEmptyNode(endBlock) || controller.query(hasSubjectGroupBlocks, endBlock)) &&\n        // 未选中\n        !controller.query(isSubjectSelected, endBlock as Subject)\n      ) {\n        event.preventDefault();\n        return controller.command(selectSubject, endBlock.key);\n      }\n    }\n\n    /**\n     * 限制 2：正向删除\n     */\n    if (isDeleteForward(event.nativeEvent) && selection.isCollapsed) {\n      const { focus } = selection;\n\n      // 光标在议题标题处，标题为空，但议题不为空时，不允许删除\n      if (\n        isSubjectHeading(endBlock) &&\n        isEmptyNode(endBlock) &&\n        focus.isAtStartOfNode(endBlock) &&\n        controller.query(hasSubjectGroupBlocks, endBlock) &&\n        !controller.query(isSubjectSelected, endBlock as Subject)\n      ) {\n        event.preventDefault();\n        return controller.command(selectSubject, endBlock.key);\n      }\n\n      // 光标在议题上方的节点末尾，不允许删除\n      if (\n        endBlock &&\n        isSubjectHeading(document.getNextBlock(endBlock.key)) &&\n        focus.isAtEndOfNode(endBlock)\n      ) {\n        event.preventDefault();\n        return;\n      }\n    }\n\n    /**\n     * 限制 3：议题标题无法被换行操作分裂\n     * @description 换行时清除议题的属性\n     */\n    if (\n      hotkeys.isEnter(event) && isSubjectHeading(startBlock)\n      // 在行内输入 + 号唤起工具栏时，Enter 事件会被工具栏消费\n      && !controller.query('isNewLineGuideDisplay')\n      // 在 Mention 唤起时，Enter 时间会被选人行为消费\n      && !controller.query('isSelectionInMentionSuggestion')) {\n      event.preventDefault();\n      // 若折叠则先展开\n      const fold = controller.userData.get(startBlock, 'fold');\n      if (fold) {\n        controller.command(toggleFold, startBlock, false);\n      }\n      return controller.command(Commands.splitBlock).command('clearStyle').command(clearSubjectStyle);\n    }\n\n    /**\n     * Effects: 选中状态删除，删除整个议题\n     */\n    if (isDelete(event.nativeEvent) && hasSubjectBeenSelected(controller)) {\n      const { [SELECTED_SUBJECT_KEY]: selectedKey } = controller.value.data;\n      const block = document.getNode(selectedKey);\n      if (isSubjectHeading(block)) {\n        return controller.command(deleteSubject, block as Subject).command(unselectSubject);\n      }\n    }\n\n    /**\n     * Effects: 议题完全包含在选区内，删除操作需要删除议题格式\n     */\n    if (isDelete(event.nativeEvent) && isSubjectHeading(startBlock)) {\n      const end = selection.getEnd(document);\n      if (\n        // 若 end 选区不为 hanging\n        // References: cangjie/src/commands/delete/deleteAtRange (84 Line/252 Line)\n        end.isTextPoint() && end.offset > 0 &&\n        // 议题完全包含在选区内\n        controller.query(isSelectionCoverSubjectFromStart, startBlock as Subject)\n      ) {\n        next();\n        // 删除议题块之后，光标此时会停留在议题标题处，这里需要清除议题格式\n        return controller.command('clearStyle');\n      }\n    }\n\n    return next();\n  };\n}\n\nexport default createOnKeyDown;\n"],"file":"createOnKeyDown.js"}