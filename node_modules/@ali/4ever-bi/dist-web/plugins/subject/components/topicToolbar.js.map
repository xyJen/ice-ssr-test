{"version":3,"sources":["../../../../../src/plugins/subject/components/topicToolbar.tsx"],"names":["React","styled","FinishButton","Commands","environment","Tooltip","CloseNormal","SelectedNormalNormal","toggleFinished","Feedback","ToolbarBox","div","FinishedBox","FeedbackBox","FeedbackTooltipBox","AtContainer","span","tooltipStyle","display","alignItems","padding","height","background","border","borderRadius","fontSize","NotifySuccessIcon","color","marginRight","NotifyFailedIcon","TopicToolbar","props","node","controller","config","displayFinishButton","data","subjectPr","finished","locale","onNotifyFinishTopic","creator","user","finishButtonAction","finishButtonDone","cancelFinishTopicTip","notifyFinishTip","notifyFinishSuccess","notifyFinishFailed","mentionTip","isSameUser","uid","useState","fresh","success","notified","finishState","setFinishState","handleMentionClick","useCallback","startBlock","value","key","command","moveToEndOfNode","dispatch","handleNotifyClick","title","text","then","handleFinishClick","run","prevState","useEffect","undefined","timer","window","setTimeout","clearTimeout","feedbackTip","finishTip","nick","IS_MOBILE","displayName"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport styled from 'styled-components';\nimport FinishButton from './finishButton';\nimport { Heading1Data } from '@ali/4ever-mo';\nimport { Block, Commands, Controller, environment } from '@ali/4ever-cangjie';\nimport { Tooltip } from '@ali/we-design';\nimport { CloseNormal, SelectedNormalNormal } from '@ali/we-icon';\nimport { toggleFinished } from '../actions';\nimport { SubjectConfig } from '../types';\nimport Feedback from './feedback';\n\nconst ToolbarBox = styled.div`\n  display: flex;\n  align-items: center;\n  height: 100%;\n`;\n\nconst FinishedBox = styled.div`\n  font-size: 12px;\n  position: relative;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  height: 26px;\n  cursor: pointer;\n  transition: all 0.4s;\n  margin-left: 2px;\n\n  :hover {\n    background: rgba(126, 134, 142, 0.12);\n    border-radius: 4px;\n  }\n`;\n\nconst FeedbackBox = styled(Feedback)`\n  position: absolute;\n  height: 30px;\n  top: -30px;\n  right: -12px;\n  border: 0.5px solid rgba(17, 31, 44, 0.08);\n  padding: 6px 8px;\n`;\n\nconst FeedbackTooltipBox = styled.div`\n`;\n\nconst AtContainer = styled.span`\n  color: rgba(0, 137, 255, 1);\n  font-weight: bold;\n`;\n\nconst tooltipStyle: React.CSSProperties = {\n  display: 'flex',\n  alignItems: 'center',\n  padding: '4px 8px',\n  height: 28,\n  background: 'rgba(30, 30, 30, 0.94)',\n  border: '1px solid rgba(126, 134, 142, 0.16)',\n  borderRadius: 4,\n  fontSize: 12,\n};\n\nconst NotifySuccessIcon = <SelectedNormalNormal style={{ color: '#00B042', marginRight: 3 }} />;\n\nconst NotifyFailedIcon = <CloseNormal style={{ color: '#ff5219', marginRight: 3 }} />;\n\nexport interface TopicToolbarProps {\n  node: Block<Heading1Data>;\n  controller: Controller;\n  config: SubjectConfig;\n  displayFinishButton: boolean;\n}\n\nconst TopicToolbar: React.FC<TopicToolbarProps> = (props) => {\n  const { node, controller, config, displayFinishButton } = props;\n  const { subjectPr = {} } = node.data;\n  const { finished = false } = subjectPr;\n  const { locale = {}, onNotifyFinishTopic, creator, user } = config;\n  const { finishButtonAction, finishButtonDone } = locale;\n  const {\n    cancelFinishTopicTip,\n    notifyFinishTip,\n    notifyFinishSuccess,\n    notifyFinishFailed,\n    mentionTip,\n  } = locale;\n  const isSameUser = creator?.uid === user?.uid;\n\n  const [finishState, setFinishState] = React.useState({\n    // 当前完成是否新鲜\n    fresh: false,\n    // 通知是否成功\n    success: false,\n    // 是否已经通知\n    notified: false,\n  });\n\n  const { fresh, notified, success } = finishState;\n\n  const handleMentionClick = React.useCallback(() => {\n    const { startBlock } = controller.value;\n    if (startBlock?.key !== node.key) {\n      controller.command(Commands.moveToEndOfNode, node);\n    }\n    controller.dispatch('activeMention');\n  }, [controller, node]);\n\n  /**\n   * 点击通知议题反馈\n   */\n  const handleNotifyClick = React.useCallback(() => {\n    if (typeof onNotifyFinishTopic === 'function') {\n      onNotifyFinishTopic({\n        node,\n        title: node.text,\n      }).then(() => {\n        setFinishState({\n          fresh: true,\n          notified: true,\n          success: true,\n        });\n      }).catch(() => {\n        setFinishState({\n          fresh: true,\n          notified: true,\n          success: false,\n        });\n      });\n    } else {\n      setFinishState({\n        fresh: false,\n        notified: false,\n        success: false,\n      });\n    }\n  }, [node, onNotifyFinishTopic]);\n\n  /**\n   * 点击完成议题填报\n   */\n  const handleFinishClick = React.useCallback(() => {\n    controller.run('onAction', toggleFinished({\n      node,\n      finished: !finished,\n    }));\n    if (!finished) {\n      setFinishState({\n        fresh: !isSameUser,\n        notified: false,\n        success: false,\n      });\n      if (!isSameUser) {\n        handleNotifyClick();\n      }\n    } else {\n      setFinishState((prevState) => {\n        return {\n          ...prevState,\n          fresh: !finished,\n        };\n      });\n    }\n  }, [controller, finished, isSameUser, node, handleNotifyClick]);\n\n  /**\n   * 议题完成时，弹出发送 Tip，展示 7s\n   */\n  React.useEffect(() => {\n    if (!fresh) {\n      return undefined;\n    }\n    const timer = window.setTimeout(() => {\n      setFinishState((prevState) => {\n        return {\n          ...prevState,\n          fresh: false,\n        };\n      });\n    }, 7000);\n\n    return () => {\n      window.clearTimeout(timer);\n    };\n  }, [fresh]);\n\n  const feedbackTip = (\n    <>\n      {success ? NotifySuccessIcon : NotifyFailedIcon}\n      {success ? notifyFinishSuccess : notifyFinishFailed}\n    </>\n  );\n  // 通知完成之前，即使 finish 也显示为未完成的 tooltip，避免文案突然闪变\n  const finishTip = (finished && (notified || isSameUser)) ? (\n    <FeedbackTooltipBox>\n      {cancelFinishTopicTip}\n    </FeedbackTooltipBox>\n  ) : (\n    <FeedbackTooltipBox>\n      {notifyFinishTip}\n      {creator?.nick ? <AtContainer>{` @${creator.nick} `}</AtContainer> : ''}\n    </FeedbackTooltipBox>\n  );\n\n  return (\n    <ToolbarBox>\n      {(!environment.IS_MOBILE && displayFinishButton) && (\n        <Tooltip disabled={fresh} title={finishTip} placement=\"top\" overlayStyle={tooltipStyle}>\n          <FinishedBox onClick={handleFinishClick}>\n            <FinishButton finished={finished} text={finished ? finishButtonDone : finishButtonAction} />\n          </FinishedBox>\n        </Tooltip>\n      )}\n      <FeedbackBox visible={fresh && notified}>{feedbackTip}</FeedbackBox>\n    </ToolbarBox>\n  );\n};\n\nTopicToolbar.displayName = 'TopicToolbar';\n\nexport default TopicToolbar;\n"],"file":"topicToolbar.js"}