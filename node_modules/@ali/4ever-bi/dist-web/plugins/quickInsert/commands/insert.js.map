{"version":3,"sources":["../../../../../src/plugins/quickInsert/commands/insert.ts"],"names":["Commands","Point","Decoration","Mark","showQuickInsert","setQuickInsert","getFocusPoint","controller","selection","value","focus","create","key","offset","insert","data","query","command","moveToStartOfNextText","run","plugin","decorations","notQuickInsertDescorations","filter","item","mark","type","endPoint","startPoint","Math","max","insertText","setDecorations","start","end"],"mappings":"AAAA,SAEEA,QAFF,EAGEC,KAHF,EAIEC,UAJF,EAKEC,IALF,QAOO,oBAPP;AASA;AAEA,SAASC,eAAT,EAA0BC,cAA1B;;AAEA,SAASC,aAAT,CAAuBC,UAAvB,EAA+C;AAAA,MACrCC,SADqC,GACvBD,UAAU,CAACE,KADY,CACrCD,SADqC;;AAE7C,MAAI,CAACA,SAAL,EAAgB;AACd,WAAO,IAAP;AACD;;AACD,MAAME,KAAK,GAAGF,SAAS,CAACE,KAAxB;AAEA,SAAOT,KAAK,CAACU,MAAN,CAAa;AAClBC,IAAAA,GAAG,EAAEF,KAAK,CAACE,GADO;AAElB;AACAC,IAAAA,MAAM,EAAEH,KAAK,CAACG;AAHI,GAAb,CAAP;AAKD;;AAED,eAAe,SAASC,MAAT,CACbP,UADa,EAEbQ,IAFa,EAGb;AACA,MACER,UAAU,CAACS,KAAX,CAAiB,yBAAjB,KACAT,UAAU,CAACS,KAAX,CAAiB,sBAAjB,CAFF,EAGE;AACAT,IAAAA,UAAU,CAACU,OAAX,CAAmBjB,QAAQ,CAACkB,qBAA5B;AACD;;AAEDX,EAAAA,UAAU,CAACY,GAAX,CAAe,UAAf,EAA2Bf,eAAe,EAA1C;AACAG,EAAAA,UAAU,CAACY,GAAX,CAAe,UAAf,EAA2Bd,cAAc,CAACU,IAAI,CAACK,MAAN,CAAzC;AATA,MAWQC,WAXR,GAWwBd,UAAU,CAACE,KAXnC,CAWQY,WAXR;AAYA,MAAMC,0BAA0B,GAAGD,WAAW,CAACE,MAAZ,CACjC,UAAAC,IAAI;AAAA,WAAIA,IAAI,CAACC,IAAL,CAAUC,IAAV,KAAmB,cAAvB;AAAA,GAD6B,CAAnC;AAIA,MAAIC,QAAQ,GAAGrB,aAAa,CAACC,UAAD,CAA5B;;AACA,MAAI,CAACoB,QAAL,EAAe;AACb,WAAOpB,UAAP;AACD;;AAED,MAAMqB,UAAU,GAAG3B,KAAK,CAACU,MAAN,CAAa;AAC9BC,IAAAA,GAAG,EAAEe,QAAQ,CAACf,GADgB;AAE9B;AACAC,IAAAA,MAAM,EAAEgB,IAAI,CAACC,GAAL,CAAS,CAAT,EAAYH,QAAQ,CAACd,MAAT,GAAkB,CAA9B;AAHsB,GAAb,CAAnB;;AAMA,MAAIc,QAAQ,CAACd,MAAT,KAAoBe,UAAU,CAACf,MAAnC,EAA2C;AACzC;AACAN,IAAAA,UAAU,CAACU,OAAX,CAAmBjB,QAAQ,CAAC+B,UAA5B,EAAwC,GAAxC;AACAJ,IAAAA,QAAQ,GAAG1B,KAAK,CAACU,MAAN,CAAa;AACtBC,MAAAA,GAAG,EAAEe,QAAQ,CAACf,GADQ;AAEtB;AACAC,MAAAA,MAAM,EAAEc,QAAQ,CAACd,MAAT,GAAkB;AAHJ,KAAb,CAAX;AAKD;;AAED,SAAON,UAAU,CAACyB,cAAX,WACFV,0BADE,GAELpB,UAAU,CAACS,MAAX,CAAkB;AAChBsB,IAAAA,KAAK,EAAEL,UADS;AAEhBM,IAAAA,GAAG,EAAEP,QAFW;AAGhBF,IAAAA,IAAI,EAAEtB,IAAI,CAACQ,MAAL,CAAY;AAChBe,MAAAA,IAAI,EAAE,cADU;AAEhBX,MAAAA,IAAI,EAAJA;AAFgB,KAAZ;AAHU,GAAlB,CAFK,GAAP;AAWD","sourcesContent":["import {\n  Controller,\n  Commands,\n  Point,\n  Decoration,\n  Mark,\n  TextPoint,\n} from '@ali/4ever-cangjie';\n\n;\nimport { QuickInsertMarkData } from '../types';\nimport { showQuickInsert, setQuickInsert } from '../actions';\n\nfunction getFocusPoint(controller: Controller) {\n  const { selection } = controller.value;\n  if (!selection) {\n    return null;\n  }\n  const focus = selection.focus as TextPoint;\n\n  return Point.create({\n    key: focus.key,\n    // @ts-ignore\n    offset: focus.offset,\n  });\n}\n\nexport default function insert(\n  controller: Controller,\n  data: QuickInsertMarkData,\n) {\n  if (\n    controller.query('isCollapsedInInlineVoid') ||\n    controller.query('isSelectionInMention')\n  ) {\n    controller.command(Commands.moveToStartOfNextText);\n  }\n\n  controller.run('onAction', showQuickInsert());\n  controller.run('onAction', setQuickInsert(data.plugin));\n\n  const { decorations } = controller.value;\n  const notQuickInsertDescorations = decorations.filter(\n    item => item.mark.type !== 'quick-insert',\n  );\n\n  let endPoint = getFocusPoint(controller) as TextPoint;\n  if (!endPoint) {\n    return controller;\n  }\n\n  const startPoint = Point.create({\n    key: endPoint.key,\n    // @ts-ignore\n    offset: Math.max(0, endPoint.offset - 1),\n  }) as TextPoint;\n\n  if (endPoint.offset === startPoint.offset) {\n    // 插入空格，保证 decoration 区间不闭合，能够展示 quick-insert 面板\n    controller.command(Commands.insertText, ' ');\n    endPoint = Point.create({\n      key: endPoint.key,\n      // @ts-ignore\n      offset: endPoint.offset + 1,\n    }) as TextPoint;\n  }\n\n  return controller.setDecorations([\n    ...notQuickInsertDescorations,\n    Decoration.create({\n      start: startPoint!,\n      end: endPoint!,\n      mark: Mark.create({\n        type: 'quick-insert',\n        data,\n      }),\n    }),\n  ]);\n}\n"],"file":"insert.js"}