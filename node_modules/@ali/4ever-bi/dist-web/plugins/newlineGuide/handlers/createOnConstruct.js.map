{"version":3,"sources":["../../../../../src/plugins/newlineGuide/handlers/createOnConstruct.ts"],"names":["environment","PendingType","NewlineGuideData","setNewlineData","removeNewlineData","createOnConstruct","config","newlineGuideEnabled","newlineGuide","enabled","controller","next","IS_MOBILE","enableHots","isPendingEnable","onInput","get","triggered","point","query","value","selection","document","composing","anchor","key","offset","node","getNode","newQuery","text","substring","includes","run","inputData$","subscribe","hots$","pendingType","input"],"mappings":"AAAA,SAAqBA,WAArB,EAA6CC,WAA7C,QAAgE,oBAAhE;AAEA,SAASC,gBAAT;AACA,SAASC,cAAT,EAAyBC,iBAAzB;AAEA,eAAe,SAASC,iBAAT,CAA2BC,MAA3B,EAAmD;AAAA;;AAChE,MAAMC,mBAAmB,2BAAGD,MAAM,CAACE,YAAV,qBAAG,qBAAqBC,OAAjD;AACA,SAAO,UAACC,UAAD,EAAyBC,IAAzB,EAA4C;AACjD,QAAI,CAACJ,mBAAD,IAAwBP,WAAW,CAACY,SAAxC,EAAmD,OAAOD,IAAI,EAAX;;AAEnD,QAAID,UAAU,CAACG,UAAX,IAAyBH,UAAU,CAACI,eAAxC,EAAyD;AACvD,UAAMC,OAAO,GAAG,SAAVA,OAAU,GAAM;AAAA,mBACiBb,gBAAgB,CAACc,GAAjB,CAAqBN,UAArB,KACnC,EAFkB;AAAA,YACZO,SADY,QACZA,SADY;AAAA,YACDC,KADC,QACDA,KADC;AAAA,YACMC,KADN,QACMA,KADN;;AAAA,gCAGuBT,UAAU,CAACU,KAHlC;AAAA,YAGZC,SAHY,qBAGZA,SAHY;AAAA,YAGDC,QAHC,qBAGDA,QAHC;AAAA,YAGSC,SAHT,qBAGSA,SAHT;AAIpB,YAAMC,MAAM,GAAGH,SAAS,CAACG,MAAzB;;AACA,YAAI,CAACP,SAAD,IAAcM,SAAlB,EAA6B;AAC3B,iBAAOZ,IAAI,EAAX;AACD;;AACD,YAAI,CAAAO,KAAK,QAAL,YAAAA,KAAK,CAAEO,GAAP,OAAeD,MAAf,oBAAeA,MAAM,CAAEC,GAAvB,KAA8B,CAAAP,KAAK,QAAL,YAAAA,KAAK,CAAEQ,MAAP,MAAiBF,MAAjB,oBAAiBA,MAAM,CAAEE,MAAzB,CAAlC,EAAmE;AACjE;AACA,cAAMC,IAAI,GAAGL,QAAQ,CAACM,OAAT,CAAiBV,KAAK,CAACO,GAAvB,CAAb;AACA,cAAMI,QAAQ,GACZ,CAAAF,IAAI,QAAJ,YAAAA,IAAI,CAAEG,IAAN,CAAWC,SAAX,CAAqBb,KAAK,CAACQ,MAA3B,EAAmCF,MAAnC,oBAAmCA,MAAM,CAAEE,MAA3C,MAAsD,EADxD;AAEA,cAAIP,KAAK,KAAKU,QAAd,EAAwB,OAAOlB,IAAI,EAAX;;AACxB,cAAIkB,QAAQ,CAACG,QAAT,CAAkB,GAAlB,CAAJ,EAA4B;AAC1BtB,YAAAA,UAAU,CAACuB,GAAX,CAAe,UAAf,EAA2B7B,iBAAiB,EAA5C;AACA,mBAAOO,IAAI,EAAX;AACD;;AACDD,UAAAA,UAAU,CAACuB,GAAX,CACE,UADF,EAEE9B,cAAc,CAAC;AACbgB,YAAAA,KAAK,EAAEU;AADM,WAAD,CAFhB;AAMD;AACF,OAzBD;AA0BA;AACN;AACA;AACA;AACA;;;AACMnB,MAAAA,UAAU,CAACwB,UAAX,CAAsBC,SAAtB,CAAgCpB,OAAhC;AACAL,MAAAA,UAAU,CAAC0B,KAAX,CAAiBD,SAAjB,CAA2B,YAAM;AAC/B,YAAIzB,UAAU,CAAC2B,WAAX,KAA2BpC,WAAW,CAACqC,KAA3C,EAAkD;AAChDvB,UAAAA,OAAO;AACR;AACF,OAJD;AAKD;;AAED,WAAOJ,IAAI,EAAX;AACD,GA5CD;AA6CD","sourcesContent":["import { Controller, environment, TextPoint, PendingType } from '@ali/4ever-cangjie';\nimport { BiPluginConfig } from '../../../types';\nimport { NewlineGuideData } from '../model/newlineGuide';\nimport { setNewlineData, removeNewlineData } from '../actions';\n\nexport default function createOnConstruct(config: BiPluginConfig) {\n  const newlineGuideEnabled = config.newlineGuide?.enabled;\n  return (controller: Controller, next: Function) => {\n    if (!newlineGuideEnabled || environment.IS_MOBILE) return next();\n\n    if (controller.enableHots || controller.isPendingEnable) {\n      const onInput = () => {\n        const { triggered, point, query } = (NewlineGuideData.get(controller) ||\n          {}) as { triggered?: boolean; point?: TextPoint; query?: string };\n        const { selection, document, composing } = controller.value;\n        const anchor = selection.anchor as TextPoint;\n        if (!triggered || composing) {\n          return next();\n        }\n        if (point?.key === anchor?.key && point?.offset <= anchor?.offset) {\n          // 下拉弹窗弹出时计算query\n          const node = document.getNode(point.key);\n          const newQuery =\n            node?.text.substring(point.offset, anchor?.offset) || '';\n          if (query === newQuery) return next();\n          if (newQuery.includes(' ')) {\n            controller.run('onAction', removeNewlineData());\n            return next();\n          }\n          controller.run(\n            'onAction',\n            setNewlineData({\n              query: newQuery,\n            }),\n          );\n        }\n      };\n      /**\n       * 在Pending场景下，onchange获取到的query可能会出现迟滞的情况，所以这里需要inputData$来及时更新搜素内容\n       * 但是这里只针对进行英文输入的场景，中文输入法下，输入完成后会立即flush，所以inputData$不会触发\n       * 所以pending场景还是会走一遍onchange来确保中文输入法query正确\n       */\n      controller.inputData$.subscribe(onInput);\n      controller.hots$.subscribe(() => {\n        if (controller.pendingType === PendingType.input) {\n          onInput()\n        }\n      });\n    }\n\n    return next();\n  };\n}\n"],"file":"createOnConstruct.js"}