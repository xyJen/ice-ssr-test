{"version":3,"sources":["../../../../../src/plugins/newlineGuide/handlers/createOnChange.ts"],"names":["environment","NewlineGuideData","setNewlineData","removeNewlineData","createOnChange","config","newlineGuideEnabled","newlineGuide","enabled","controller","next","IS_MOBILE","get","triggered","point","query","value","selection","document","composing","anchor","key","offset","node","getNode","newQuery","text","substring","includes","run"],"mappings":"AAAA,SAAqBA,WAArB,QAAmD,oBAAnD;AAEA,SAASC,gBAAT;AACA,SAASC,cAAT,EAAyBC,iBAAzB;AAEA,eAAe,SAASC,cAAT,CAAwBC,MAAxB,EAAgD;AAAA;;AAC7D,MAAMC,mBAAmB,2BAAGD,MAAM,CAACE,YAAV,qBAAG,qBAAqBC,OAAjD;AACA,SAAO,UAACC,UAAD,EAAyBC,IAAzB,EAA4C;AACjD,QAAI,CAACJ,mBAAD,IAAwBN,WAAW,CAACW,SAAxC,EAAmD,OAAOD,IAAI,EAAX;;AADF,eAG9CT,gBAAgB,CAACW,GAAjB,CAAqBH,UAArB,KAAoC,EAHU;AAAA,QAEzCI,SAFyC,QAEzCA,SAFyC;AAAA,QAE9BC,KAF8B,QAE9BA,KAF8B;AAAA,QAEvBC,KAFuB,QAEvBA,KAFuB;;AAAA,4BAINN,UAAU,CAACO,KAJL;AAAA,QAIzCC,SAJyC,qBAIzCA,SAJyC;AAAA,QAI9BC,QAJ8B,qBAI9BA,QAJ8B;AAAA,QAIpBC,SAJoB,qBAIpBA,SAJoB;AAKjD,QAAMC,MAAM,GAAGH,SAAS,CAACG,MAAzB;;AACA,QAAI,CAACP,SAAD,IAAcM,SAAlB,EAA6B;AAC3B,aAAOT,IAAI,EAAX;AACD;;AACD,QAAI,CAAAI,KAAK,QAAL,YAAAA,KAAK,CAAEO,GAAP,OAAeD,MAAf,oBAAeA,MAAM,CAAEC,GAAvB,KAA8B,CAAAP,KAAK,QAAL,YAAAA,KAAK,CAAEQ,MAAP,MAAiBF,MAAjB,oBAAiBA,MAAM,CAAEE,MAAzB,CAAlC,EAAmE;AACjE;AACA,UAAMC,IAAI,GAAGL,QAAQ,CAACM,OAAT,CAAiBV,KAAK,CAACO,GAAvB,CAAb;AACA,UAAMI,QAAQ,GAAG,CAAAF,IAAI,QAAJ,YAAAA,IAAI,CAAEG,IAAN,CAAWC,SAAX,CAAqBb,KAAK,CAACQ,MAA3B,EAAmCF,MAAnC,oBAAmCA,MAAM,CAAEE,MAA3C,MAAsD,EAAvE;AACA,UAAIP,KAAK,KAAKU,QAAd,EAAwB,OAAOf,IAAI,EAAX;;AACxB,UAAIe,QAAQ,CAACG,QAAT,CAAkB,GAAlB,CAAJ,EAA4B;AAC1BnB,QAAAA,UAAU,CAACoB,GAAX,CAAe,UAAf,EAA2B1B,iBAAiB,EAA5C;AACA,eAAOO,IAAI,EAAX;AACD;;AACDD,MAAAA,UAAU,CAACoB,GAAX,CAAe,UAAf,EAA2B3B,cAAc,CAAC;AACxCa,QAAAA,KAAK,EAAEU;AADiC,OAAD,CAAzC;AAGD;;AAED,WAAOf,IAAI,EAAX;AACD,GAxBD;AAyBD","sourcesContent":["import { Controller, environment, TextPoint } from '@ali/4ever-cangjie';\nimport { BiPluginConfig } from '../../../types';\nimport { NewlineGuideData } from '../model/newlineGuide';\nimport { setNewlineData, removeNewlineData } from '../actions';\n\nexport default function createOnChange(config: BiPluginConfig) {\n  const newlineGuideEnabled = config.newlineGuide?.enabled;\n  return (controller: Controller, next: Function) => {\n    if (!newlineGuideEnabled || environment.IS_MOBILE) return next();\n    const { triggered, point, query } =\n      (NewlineGuideData.get(controller) || {}) as {triggered?: boolean; point?: TextPoint; query?: string};\n    const { selection, document, composing } = controller.value;\n    const anchor = selection.anchor as TextPoint;\n    if (!triggered || composing) {\n      return next();\n    }\n    if (point?.key === anchor?.key && point?.offset <= anchor?.offset) {\n      // 下拉弹窗弹出时计算query\n      const node = document.getNode(point.key);\n      const newQuery = node?.text.substring(point.offset, anchor?.offset) || '';\n      if (query === newQuery) return next();\n      if (newQuery.includes(' ')) {\n        controller.run('onAction', removeNewlineData());\n        return next();\n      }\n      controller.run('onAction', setNewlineData({\n        query: newQuery,\n      }));\n    }\n\n    return next();\n  };\n}\n"],"file":"createOnChange.js"}