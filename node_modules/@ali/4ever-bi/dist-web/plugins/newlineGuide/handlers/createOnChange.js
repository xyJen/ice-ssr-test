import { environment } from '@ali/4ever-cangjie';
import { NewlineGuideData } from "../model/newlineGuide";
import { setNewlineData, removeNewlineData } from "../actions";
export default function createOnChange(config) {
  var _config$newlineGuide;

  var newlineGuideEnabled = (_config$newlineGuide = config.newlineGuide) == null ? void 0 : _config$newlineGuide.enabled;
  return function (controller, next) {
    if (!newlineGuideEnabled || environment.IS_MOBILE) return next();

    var _ref = NewlineGuideData.get(controller) || {},
        triggered = _ref.triggered,
        point = _ref.point,
        query = _ref.query;

    var _controller$value = controller.value,
        selection = _controller$value.selection,
        document = _controller$value.document,
        composing = _controller$value.composing;
    var anchor = selection.anchor;

    if (!triggered || composing) {
      return next();
    }

    if ((point == null ? void 0 : point.key) === (anchor == null ? void 0 : anchor.key) && (point == null ? void 0 : point.offset) <= (anchor == null ? void 0 : anchor.offset)) {
      // 下拉弹窗弹出时计算query
      var node = document.getNode(point.key);
      var newQuery = (node == null ? void 0 : node.text.substring(point.offset, anchor == null ? void 0 : anchor.offset)) || '';
      if (query === newQuery) return next();

      if (newQuery.includes(' ')) {
        controller.run('onAction', removeNewlineData());
        return next();
      }

      controller.run('onAction', setNewlineData({
        query: newQuery
      }));
    }

    return next();
  };
}
//# sourceMappingURL=createOnChange.js.map