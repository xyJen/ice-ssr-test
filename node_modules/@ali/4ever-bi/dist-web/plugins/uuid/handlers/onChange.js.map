{"version":3,"sources":["../../../../../src/plugins/uuid/handlers/onChange.ts"],"names":["Block","Commands","uniqueId","createOnChange","config","onChange","controller","next","generateLeafBlockId","tmp","blocks","operations","map","o","type","undefined","path","filter","p","n","value","document","getNodeByPath","isBlock","getClosestBlock","key","reduce","prev","cur","push","node","data","uuid","uuidFn","generator","withoutNormalizing","withoutSaving","forEach","command","setNodeByKey","refblockUUID"],"mappings":";AAAA,SAASA,KAAT,EAAgBC,QAAhB,QAA4C,oBAA5C;AACA,SAASC,QAAT,QAA0B,kBAA1B;AAGA,eAAe,SAASC,cAAT,CAAwBC,MAAxB,EAAmD;AAAA,MAA3BA,MAA2B;AAA3BA,IAAAA,MAA2B,GAAJ,EAAI;AAAA;;AAChE,SAAO,SAASC,QAAT,CAAkBC,UAAlB,EAA0CC,IAA1C,EAA4D;AACjE,QAAI,CAACH,MAAM,CAACI,mBAAZ,EAAiC;AAC/B,aAAOD,IAAI,EAAX;AACD;;AAED,QAAME,GAAsB,GAAG,EAA/B;AACA,QAAMC,MAAM,GAAGJ,UAAU,CAACK,UAAX,CACZC,GADY,CACR,UAACC,CAAD,EAAO;AACV,aAAOA,CAAC,CAACC,IAAF,KAAW,eAAX,GAA6BC,SAA7B,GAAyCF,CAAC,CAACG,IAAlD;AACD,KAHY,EAIZC,MAJY,CAIL,UAACC,CAAD;AAAA,aAAO,CAAC,CAACA,CAAT;AAAA,KAJK,EAKZN,GALY,CAKR,UAACM,CAAD,EAAO;AACV,UAAMC,CAAC,GAAGb,UAAU,CAACc,KAAX,CAAiBC,QAAjB,CAA0BC,aAA1B,CAAwCJ,CAAxC,CAAV;;AACA,UAAIC,CAAJ,EAAO;AACL,eAAOnB,KAAK,CAACuB,OAAN,CAAcJ,CAAd,IAAmBA,CAAnB,GAAuBb,UAAU,CAACc,KAAX,CAAiBC,QAAjB,CAA0BG,eAA1B,CAA0CL,CAAC,CAACM,GAA5C,CAA9B;AACD;;AACD,aAAO,IAAP;AACD,KAXY,EAYZC,MAZY,CAYL,UAACC,IAAD,EAAgBC,GAAhB,EAAwB;AAC9B,UAAIA,GAAG,IAAI,CAACnB,GAAG,CAACmB,GAAG,CAACH,GAAL,CAAf,EAA0B;AACxBhB,QAAAA,GAAG,CAACmB,GAAG,CAACH,GAAL,CAAH,GAAe,CAAf;AACAE,QAAAA,IAAI,CAACE,IAAL,CAAUD,GAAV;AACD;;AACD,aAAOD,IAAP;AACD,KAlBY,EAkBV,EAlBU,EAmBZV,MAnBY,CAmBL,UAACa,IAAD;AAAA,aAAU,CAACA,IAAI,CAACC,IAAL,CAAUC,IAArB;AAAA,KAnBK,CAAf;AAqBA,QAAMC,MAAM,GAAG7B,MAAM,CAAC8B,SAAP,IAAoBhC,QAAnC;AAEAI,IAAAA,UAAU,CAAC6B,kBAAX,CAA8B,YAAM;AAClC;AACA7B,MAAAA,UAAU,CAAC8B,aAAX,CAAyB,YAAM;AAC7B1B,QAAAA,MAAM,CAAC2B,OAAP,CAAe,UAACP,IAAD,EAAU;AACvBxB,UAAAA,UAAU,CAACgC,OAAX,CAAmBrC,QAAQ,CAACsC,YAA5B,EAA0CT,IAAI,CAAEL,GAAhD,EAAqD;AACnDX,YAAAA,IAAI,EAAEgB,IAAI,CAAEhB,IADuC;AAEnDiB,YAAAA,IAAI,eACCD,IAAI,CAAEC,IADP;AAEFC,cAAAA,IAAI,EAAEF,IAAI,CAACC,IAAL,CAAUS,YAAV,GAAyBV,IAAI,CAACC,IAAL,CAAUS,YAAnC,GAAkDP,MAAM;AAF5D;AAF+C,WAArD;AAOD,SARD;AASD,OAVD;AAWD,KAbD;AAeA,WAAO1B,IAAI,EAAX;AACD,GA7CD;AA8CD","sourcesContent":["import { Block, Commands, Controller } from '@ali/4ever-cangjie';\nimport { uniqueId }  from '@ali/4ever-utils';\nimport { BiUUIDConfig } from '../util/type';\n\nexport default function createOnChange(config: BiUUIDConfig = {}) {\n  return function onChange(controller: Controller, next: () => void) {\n    if (!config.generateLeafBlockId) {\n      return next();\n    }\n\n    const tmp: Record<string, 1> = {};\n    const blocks = controller.operations\n      .map((o) => {\n        return o.type === 'set_selection' ? undefined : o.path;\n      })\n      .filter((p) => !!p)\n      .map((p) => {\n        const n = controller.value.document.getNodeByPath(p!);\n        if (n) {\n          return Block.isBlock(n) ? n : controller.value.document.getClosestBlock(n.key);\n        }\n        return null;\n      })\n      .reduce((prev: Block[], cur) => {\n        if (cur && !tmp[cur.key]) {\n          tmp[cur.key] = 1;\n          prev.push(cur);\n        }\n        return prev;\n      }, [])\n      .filter((node) => !node.data.uuid);\n\n    const uuidFn = config.generator || uniqueId;\n\n    controller.withoutNormalizing(() => {\n      // NOTE: 加上 withoutSaving 以避免 undo 时 `set_node` 把 redos stack 置空\n      controller.withoutSaving(() => {\n        blocks.forEach((node) => {\n          controller.command(Commands.setNodeByKey, node!.key, {\n            type: node!.type,\n            data: {\n              ...node!.data,\n              uuid: node.data.refblockUUID ? node.data.refblockUUID : uuidFn(),\n            },\n          });\n        });\n      });\n    });\n\n    return next();\n  };\n}\n"],"file":"onChange.js"}