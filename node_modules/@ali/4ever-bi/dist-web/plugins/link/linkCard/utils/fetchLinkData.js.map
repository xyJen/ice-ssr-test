{"version":3,"sources":["../../../../../../src/plugins/link/linkCard/utils/fetchLinkData.ts"],"names":["buildLinkCardData","fetchLinkData","node","controller","href","text","getLinkInfo","relatedId","command","isLoading","info","imgURL","title","desc","cardInfo","displayType","setOpRelatedId"],"mappings":";;AAEA,OAAOA,iBAAP;AAEA,gBAAsBC,aAAtB;AAAA;AAAA;;;4EAAO,iBACLC,IADK,EAELC,UAFK,EAGLC,IAHK,EAILC,IAJK,EAKLC,WALK,EAMLC,SANK;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,gBAMLA,SANK;AAMLA,cAAAA,SANK,GAMsB,IANtB;AAAA;;AAAA,kBAQDD,WAAW,IAAI,OAAOA,WAAP,KAAuB,UARrC;AAAA;AAAA;AAAA;;AASH;AACAH,YAAAA,UAAU,CAACK,OAAX,CAAmB,kBAAnB,EAAuCN,IAAvC,EAA6C;AAAEO,cAAAA,SAAS,EAAE;AAAb,aAA7C,EAVG,CAWH;;AAXG;AAAA;AAAA,mBAakBH,WAAW,CAACF,IAAD,CAb7B;;AAAA;AAaKM,YAAAA,IAbL;;AAAA,iBAcGA,IAdH;AAAA;AAAA;AAAA;;AAeC;AAfD,2BAgBgDA,IAhBhD,CAgBSC,MAhBT,EAgBSA,MAhBT,6BAgBkB,EAhBlB,+BAgBgDD,IAhBhD,CAgBsBE,KAhBtB,EAgBsBA,KAhBtB,4BAgB8B,EAhB9B,6BAgBgDF,IAhBhD,CAgBkCG,IAhBlC,EAgBkCA,IAhBlC,2BAgByC,EAhBzC;AAiBOC,YAAAA,QAjBP,GAiBiC;AAAEH,cAAAA,MAAM,EAANA,MAAF;AAAUC,cAAAA,KAAK,EAALA,KAAV;AAAiBC,cAAAA,IAAI,EAAJA,IAAjB;AAAuBE,cAAAA,WAAW,EAAE;AAApC,aAjBjC,EAkBC;;AACAZ,YAAAA,UAAU,CACPa,cADH,CACkBT,SADlB,EAEGC,OAFH,CAEW,kBAFX,EAE+BN,IAF/B,EAEqC,EAFrC,EAGGM,OAHH,CAGW,aAHX,EAG0BN,IAH1B,EAGgCF,iBAAiB,CAAC;AAAEK,cAAAA,IAAI,EAAJA,IAAF;AAAQD,cAAAA,IAAI,EAAJA,IAAR;AAAcU,cAAAA,QAAQ,EAARA;AAAd,aAAD,CAHjD;AAnBD;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AA6BD;AACAX,YAAAA,UAAU,CAACK,OAAX,CAAmB,kBAAnB,EAAuCN,IAAvC,EAA6C,EAA7C;AA9BC;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G","sourcesContent":["import { Controller, Block } from '@ali/4ever-cangjie';\nimport { ILinkCardInfo, LinkPluginConfig } from '../../types';\nimport buildLinkCardData from './buildLinkCardData';\n\nexport async function fetchLinkData(\n  node: Block,\n  controller: Controller,\n  href: string,\n  text: string,\n  getLinkInfo?: LinkPluginConfig['getLinkInfo'],\n  relatedId: string | null = null,\n) {\n  if (getLinkInfo && typeof getLinkInfo === 'function') {\n    // 先设置卡片状态为 loading，并且为节点注入信息，处理交互兼容\n    controller.command('setCardInjection', node, { isLoading: true });\n    // 展示卡片\n    try {\n      const info = await getLinkInfo(href);\n      if (info) {\n        // 请求成功\n        const { imgURL = '', title = '', desc = '' } = info;\n        const cardInfo: ILinkCardInfo = { imgURL, title, desc, displayType: 'card' };\n        // 清理注入信息\n        controller\n          .setOpRelatedId(relatedId)\n          .command('setCardInjection', node, {})\n          .command('setCardData', node, buildLinkCardData({ text, href, cardInfo }));\n        return;\n      }\n    } catch (e) {\n      // 获取信息失败，不添加任何数据\n      console.debug(e);\n    } finally {\n      // 清理注入信息\n      controller.command('setCardInjection', node, {});\n    }\n  }\n}\n"],"file":"fetchLinkData.js"}