import { transferUtils, constants } from '@ali/4ever-cangjie';
import { isLinkNode } from "../utils";
var MIME_TYPES = constants.MIME_TYPES;
export default function onCangjieCopyOrCut(event, controller, next) {
  if (!event.clipboardData) {
    return next();
  }

  var _controller$value = controller.value,
      document = _controller$value.document,
      selection = _controller$value.selection;
  var anchor = selection.anchor,
      focus = selection.focus;
  var inline = document.getClosestInline(anchor.key); // 如果最近的节点不是卡片节点，直接返回

  if (!inline || !isLinkNode(inline)) {
    return next();
  }

  if (anchor.isInNode(inline) && focus.isInNode(inline)) {
    var newSelection = selection.moveToRangeOfNode(inline, controller);
    /**
     * linkcard 是一个伪 void 节点。
     * 在 cangjie 的 onClick 事件中，针对 void 节点，会将光标移至节点末尾 packages/cangjie/src/plugins/core.tsx 200:1
     * 导致在 copy 过程中，selection 是 isCollapsed 的，复制的 fragment 获得的是没有 text 内容的片段。
     * 从而用户复制的 linkcard，会丢失标题。
     * 这里覆盖默认 copy 逻辑，将真实的 fragment 注入
     */

    var fragment = document.getFragmentAtRange(newSelection);

    if (typeof inline.data.href === 'string') {
      return next(event.setClipboardData(event.clipboardData.setData(MIME_TYPES.TEXT, inline.data.href).setData(MIME_TYPES.FRAGMENT, transferUtils.encodeFragment(fragment))));
    }
  }

  return next();
}
//# sourceMappingURL=onCangjieCopyorCut.js.map