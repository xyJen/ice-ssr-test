{"version":3,"sources":["../../../../../src/plugins/link/handlers/onAction.ts"],"names":["Commands","ContextMenu","copyToClipboard","hideCustomPastePanel","LINK_HIDE_EDITOR","LINK_REMOVE","LINK_UPDATE","LINK_WRAP","LINK_UNWRAP","LINK_UNWRAP_CARD","LINK_REMOVE_PURE","LINK_UPDATE_PURE","LINK_FOCUS_EDITOR","LINK_UNWRAP_PURE_LINK","LINK_REMOVE_INJECTED_CARDINFO","LINK_INJECT_CARDINFO","LINK_COPY_LINK","LINK_CUT_LINK","LINK_SWITCH_DISPLAYTYPE","LINK_SWITCH_LINK_TO_CARD","LINK_SAVE_LINK_CARD","LINK_HOVER_LINK_CARD","LINK_EDIT_LINK_CARD","LINK_CLICK_PLACEHOLDER","LINK_SHOW_LINK_PASRE_PANEL","LINK_CUT_PURE","LINK_HIDE_EDITOR_AND_MOVE_NEXT_TEXT","LINK_OPEN","updateLink","wrapLink","removeLink","removePureLink","updatePureLink","unwrapPureLink","updateLinkCardInfo","injectCardInfo","removeinjectedCardInfo","unwrapLinkCard","switchLinkDisplayType","ACTION_COPY","onAction","action","controller","next","type","payload","command","focus","value","selection","startInline","isCollapsed","anchor","isAtEndOfNode","moveToStartOfNextText","range","select","node","text","href","cardInfo","offset","srcHref","needFetchLinkInfo","blur","run","displayType","getLinkInfo"],"mappings":"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","sourcesContent":["import { Controller, Commands, ContextMenu, Action } from '@ali/4ever-cangjie';\nimport { copyToClipboard } from '@ali/4ever-bamboo';\nimport { hideCustomPastePanel } from '@ali/4ever-plugin-clipboard';\nimport {\n  LINK_HIDE_EDITOR,\n  LINK_REMOVE,\n  LINK_UPDATE,\n  LINK_WRAP,\n  LINK_UNWRAP,\n  LINK_UNWRAP_CARD,\n  LINK_REMOVE_PURE,\n  LINK_UPDATE_PURE,\n  LINK_FOCUS_EDITOR,\n  LINK_UNWRAP_PURE_LINK,\n  LINK_REMOVE_INJECTED_CARDINFO,\n  LINK_INJECT_CARDINFO,\n  LINK_COPY_LINK,\n  LINK_CUT_LINK,\n  LINK_SWITCH_DISPLAYTYPE,\n  LINK_SWITCH_LINK_TO_CARD,\n  LINK_SAVE_LINK_CARD,\n  LINK_HOVER_LINK_CARD,\n  LINK_EDIT_LINK_CARD,\n  LINK_CLICK_PLACEHOLDER,\n  LINK_SHOW_LINK_PASRE_PANEL,\n  LINK_CUT_PURE,\n  LINK_HIDE_EDITOR_AND_MOVE_NEXT_TEXT,\n  LINK_OPEN,\n} from '../actions';\nimport {\n  updateLink,\n  wrapLink,\n  removeLink,\n  removePureLink,\n  updatePureLink,\n  unwrapPureLink,\n  updateLinkCardInfo,\n  injectCardInfo,\n  removeinjectedCardInfo,\n  selectLink,\n  unwrapLinkCard,\n  switchLinkDisplayType,\n} from '../commands';\nimport {\n  CopyLinkPayload,\n  CutLinkPayload,\n  CutPureLinkPayload,\n  InjectCardInfoPayload,\n  OpenLinkPayload,\n  RemoveInjectedCardInfoPayload,\n  RemoveLinkPayload,\n  RemovePureLinkPayload,\n  SaveLinkCardPayload,\n  ShowLinkPastePanelPayload,\n  SwitchDisplayTypePayload,\n  UnwrapLinkCardPayload,\n  UnwrapPureLinkPayload,\n  UpdateLinkPayload,\n  UpdatePureLinkPayload,\n} from \"../types\";\n\nconst { ACTION_COPY } = ContextMenu;\n\nexport default function onAction(\n  action: Action,\n  controller: Controller,\n  next: () => Controller,\n): Controller {\n  const { type, payload } = action;\n  if (type === LINK_HIDE_EDITOR) {\n    controller.command(Commands.focus);\n    // 若是在末尾取消编辑，则跳出当前链接\n    const { selection, startInline } = controller.value;\n    if (\n      selection!.isCollapsed &&\n      startInline &&\n      selection!.anchor.isAtEndOfNode(startInline)\n    ) {\n      controller.command(Commands.moveToStartOfNextText);\n    }\n    return controller;\n  }\n  if (type === LINK_HIDE_EDITOR_AND_MOVE_NEXT_TEXT) {\n    controller.command(Commands.focus)\n      .command(Commands.moveToStartOfNextText);\n    return controller;\n  }\n  if (type === LINK_WRAP) {\n    const { range } = payload;\n    if (range) {\n      controller.command(Commands.select, range);\n    }\n    return controller.command(Commands.focus).command(wrapLink);\n  }\n  if (type === LINK_UNWRAP) {\n    return controller.command('unwrapLink');\n  }\n  if (type === LINK_UNWRAP_CARD) {\n    const { node } = payload as UnwrapLinkCardPayload;\n    return controller.command(unwrapLinkCard, node);\n  }\n  if (type === LINK_REMOVE) {\n    const { node } = payload as RemoveLinkPayload;\n    return removeLink(controller, node);\n  }\n  if (type === LINK_UPDATE) {\n    const { node, text, href, cardInfo } = payload as UpdateLinkPayload;\n    if (cardInfo) {\n      return updateLinkCardInfo(controller, node, text, href, cardInfo);\n    }\n\n    return updateLink(controller, node, text, href);\n  }\n  if (type === LINK_CUT_PURE) {\n    const { node, offset, href } = payload as CutPureLinkPayload;\n    copyToClipboard(href);\n    return removePureLink(controller, node, offset, href);\n  }\n  if (type === LINK_REMOVE_PURE) {\n    const { node, offset, href } = payload as RemovePureLinkPayload;\n    return removePureLink(controller, node, offset, href);\n  }\n  if (type === LINK_UPDATE_PURE) {\n    const {\n      node,\n      text,\n      href,\n      offset,\n      srcHref,\n      cardInfo,\n      needFetchLinkInfo,\n    } = payload as UpdatePureLinkPayload;\n    if (cardInfo) {\n      return controller.command('updatePureLinkWithCardInfo', node, offset, text, href, srcHref, cardInfo, needFetchLinkInfo);\n    }\n\n    return updatePureLink(controller, node, offset, text, href, srcHref);\n  }\n  if (type === LINK_FOCUS_EDITOR) {\n    return controller.command(Commands.blur);\n  }\n  if (type === LINK_UNWRAP_PURE_LINK) {\n    const { node, offset, href } = payload as UnwrapPureLinkPayload;\n    return controller.command(unwrapPureLink, node, offset, href);\n  }\n\n  if (type === LINK_INJECT_CARDINFO) {\n    const { node, cardInfo, range } = payload as InjectCardInfoPayload;\n    return controller.command(injectCardInfo, node, cardInfo, range);\n  }\n\n  if (type === LINK_REMOVE_INJECTED_CARDINFO) {\n    const { node } = payload as RemoveInjectedCardInfoPayload;\n    return controller.command(removeinjectedCardInfo, node);\n  }\n\n  if (type === LINK_COPY_LINK) {\n    const { node } = payload as CopyLinkPayload;\n    controller.command('copyLink', node);\n    return controller;\n  }\n\n  if (type === LINK_CUT_LINK) {\n    const { node } = payload as CutLinkPayload;\n    controller.command('copyLink', node);\n    removeLink(controller, node);\n    return controller;\n  }\n\n  if (type === LINK_SWITCH_DISPLAYTYPE) {\n    // 切换卡片显示类型后，隐藏custom面板 to fix: https://work.aone.alibaba-inc.com/issue/44255401\n    controller.run('onAction', hideCustomPastePanel());\n    const { node, displayType } = payload as SwitchDisplayTypePayload;\n    return controller.command(switchLinkDisplayType, node, displayType);\n  }\n\n  if (type === LINK_EDIT_LINK_CARD) {\n    return controller.command('editLink');\n  }\n\n  if (type === LINK_HOVER_LINK_CARD) {\n    return controller.command('hoverLink');\n  }\n\n  if (type === LINK_CLICK_PLACEHOLDER) {\n    return controller.command('linkPlaceholder');\n  }\n\n  if (type === LINK_SWITCH_LINK_TO_CARD) {\n    // 切换卡片显示类型后，隐藏custom面板 to fix: https://work.aone.alibaba-inc.com/issue/44255401\n    controller.run('onAction', hideCustomPastePanel());\n    const { node, text, href, cardInfo } = payload as UpdateLinkPayload;\n    if (cardInfo) {\n      return updateLinkCardInfo(controller, node, text, href, cardInfo);\n    }\n\n    return updateLink(controller, node, text, href);\n  }\n\n  if (type === LINK_SAVE_LINK_CARD) {\n    const { node, text, href } = payload as SaveLinkCardPayload;\n    return controller.command('saveLinkCard', node, text, href);\n  }\n\n  if (type === LINK_SHOW_LINK_PASRE_PANEL) {\n    const { text, getLinkInfo } = payload as ShowLinkPastePanelPayload;\n    return controller.command('showLinkPastePanel', text, getLinkInfo);\n  }\n\n  if (type === LINK_OPEN) {\n    const { href } = payload as OpenLinkPayload;\n    return controller.command('openLink', href);\n  }\n\n  return next();\n}\n"],"file":"onAction.js"}