{"version":3,"sources":["../../../../../src/plugins/link/commands/updateLinkCardInfo.ts"],"names":["Commands","Text","isLinkNode","isCardInfoNeedUpdate","originalCardInfo","newCardInfo","title","desc","imgURL","displayType","updateLinkCardInfo","controller","node","text","href","cardInfo","selection","value","nodeText","length","originalHref","data","isLink","isTextList","nodes","range","moveToRangeOfNode","command","select","insertText","focus","setNodeByKey","key","type","moveToEndOfNode","document","currentNode","getNode","linkTextNode","getNextText","marks","getMarksAtPosition","textNode","create","addMarks","newNode","merge","replaceNodeByKey","moveToStartOfNextText"],"mappings":"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","sourcesContent":["import { Controller, Inline, Commands, Text } from '@ali/4ever-cangjie';\nimport { ILinkCardInfo } from '../types';\nimport { isLinkNode } from '../utils';\n\nconst isCardInfoNeedUpdate = (originalCardInfo: ILinkCardInfo | undefined, newCardInfo: ILinkCardInfo) => {\n  if (!originalCardInfo) {\n    return true;\n  }\n  if (originalCardInfo.title !== newCardInfo.title\n    || originalCardInfo.desc !== newCardInfo.desc\n    || originalCardInfo.imgURL !== newCardInfo.imgURL\n    || originalCardInfo.displayType !== newCardInfo.displayType) {\n    return true;\n  }\n\n  return false;\n};\n\nexport default function updateLinkCardInfo(\n  controller: Controller,\n  node: Inline,\n  text: string,\n  href: string,\n  cardInfo?: ILinkCardInfo,\n) {\n  const { selection } = controller.value;\n  const nodeText = text.length ? text : href;\n  const originalHref = node.data.href;\n  const originalCardInfo = node.data.cardInfo;\n  const isLink = cardInfo && cardInfo.displayType === 'link'\n\n  // 若文本地址为空，则去除链接，链接里有可能嵌套inline图片\n  if (Text.isTextList(node.nodes) && !text.length && href.length && isLink) {\n    const range = selection.moveToRangeOfNode(node, controller);\n    return controller.command(Commands.select, range).command(Commands.insertText, href).command('unwrapLink').command(Commands.focus);\n  }\n\n  // 更新需要控制粒度，避免生成额外 op\n  if (cardInfo && (isCardInfoNeedUpdate(originalCardInfo, cardInfo) || href !== originalHref)) {\n    // 如果更新了卡片信息\n    controller.command(Commands.setNodeByKey, node.key, {\n      type: 'link',\n      data: { href, cardInfo: { ...cardInfo } },\n    }).command(Commands.moveToEndOfNode, node);\n  } else if (href !== originalHref) {\n    // 如果仅更新链接信息\n    controller.command(Commands.setNodeByKey, node.key, {\n      type: 'link',\n      data: { href },\n    }).command(Commands.moveToEndOfNode, node);\n  }\n  if (Text.isTextList(node.nodes) && nodeText !== node.text) {\n    // 卡片状态下的链接是 void 节点，如果采用 insertText 方式修改文本，会导致 void 节点被删除\n    // 因此采用 setNode 方式替换, 此时需要获取到最新的节点状态进行替换\n    const { document } = controller.value;\n    const currentNode = document.getNode(node.key);\n    if (!isLinkNode(currentNode)) {\n      return controller;\n    }\n    const linkTextNode = document.getNextText(currentNode.key);\n    if (linkTextNode) {\n      const marks = document.getMarksAtPosition(linkTextNode.key, 1);\n      const textNode = Text.create(nodeText).addMarks(0, nodeText.length, marks ?? []);\n      const newNode = currentNode.merge({ nodes: [textNode] });\n      controller.command(Commands.replaceNodeByKey, currentNode.key, newNode);\n    }\n  }\n  return controller.command(Commands.moveToStartOfNextText);\n}\n"],"file":"updateLinkCardInfo.js"}