{"version":3,"sources":["../../../../../../src/plugins/link/components/next/linkButton.tsx"],"names":["React","environment","Image","PluginRoles","AddLinkButton","DeleteLinkButton","wrapLink","unwrapPureLink","removeLink","isLink","isSelectionInLink","tryGetSelectedLinkPlaceholder","MOD","IS_MAC","SHORTCUT","isSelectionInDecoration","selection","decotation","focus","isTextPoint","key","start","end","offset","LinkButton","props","locale","controller","tooltipProp","tooltip","rest","value","startBlock","activeMarks","document","decrs","useMemo","run","isSelectionInPureLink","decrsInSelection","filter","decr","marks","map","mark","concat","some","type","placeholder","addLinkPlaceholder","handleClick","useCallback","linkDecoration","find","data","node","getNode","href","disabled","inlines","getLeafInlinesAtRange","isInvalidInlineInSelection","inline","isImage","query","isInLink","title","unlink","link","description","shortCut","linkDelete"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { Controller, Text, environment, Selection, Decoration, TextPoint } from '@ali/4ever-cangjie';\nimport { Image } from '@ali/4ever-mo';\nimport { PluginRoles } from '@ali/4ever-bamboo';\nimport { AddLinkButton, DeleteLinkButton } from '@ali/4ever-component';\nimport { wrapLink, unwrapPureLink, removeLink } from '../../actions';\nimport { isLink, isSelectionInLink } from '../../utils';\n;\nimport { IToolbarButtonConfig } from '@ali/4ever-component';\nimport { tryGetSelectedLinkPlaceholder } from '../../utils/isSelectionInLink';\nimport { LinkLocale } from '../../types';\n\nconst MOD = environment.IS_MAC ? '⌘' : 'Ctrl';\nconst SHORTCUT = `${MOD}+K`;\n\nexport interface LinkButtonProps extends IToolbarButtonConfig {\n  locale: LinkLocale;\n  controller: Controller;\n}\n\nfunction isSelectionInDecoration(selection: Selection, decotation: Decoration) {\n  const { focus } = selection;\n  return focus.isTextPoint()\n    && focus.key === decotation.start.key\n    && focus.key === decotation.end.key\n    && focus.offset >= decotation.start.offset\n    && focus.offset <= decotation.end.offset;\n}\n\nconst LinkButton: React.FC<LinkButtonProps> = (props) => {\n  const { locale, controller, tooltip: tooltipProp, ...rest } = props;\n\n  const { value } = controller;\n  const { startBlock, activeMarks, selection, document } = controller.value;\n\n  const decrs = React.useMemo(() => {\n    if (startBlock) {\n      return controller.run('decorateNode', startBlock);\n    }\n    return [];\n  }, [controller, startBlock]);\n\n  const isSelectionInPureLink = React.useMemo(() => {\n\n    const decrsInSelection = decrs.filter(decr => isSelectionInDecoration(selection, decr));\n\n    const marks = decrsInSelection.map((decr) => decr.mark).concat(activeMarks);\n    return (\n      marks.some(({ type }) => type === 'link') &&\n      !marks.some(({ type }) => type === 'unlink')\n    );\n  }, [decrs, activeMarks, selection]);\n\n  const placeholder = tryGetSelectedLinkPlaceholder(controller.value, locale.addLinkPlaceholder);\n\n  const handleClick = React.useCallback(() => {\n    if (isSelectionInPureLink) {\n      const { document, selection } = controller.value;\n      const focus = selection.focus as TextPoint;\n      const linkDecoration = decrs.find(\n        ({ mark, start, end }) => mark.type === 'link' &&\n          focus.key === start.key &&\n          focus.offset >= start.offset &&\n          focus.offset <= end.offset,\n      );\n      if (!linkDecoration) {\n        return;\n      }\n      const { mark, start } = linkDecoration;\n      const { data } = mark;\n      const node = document.getNode(start.key) as Text;\n      controller.run('onAction', unwrapPureLink(node, start.offset, data.href));\n    } else {\n      if (placeholder) {\n        // 在占位符进行取消链接时，直接执行删除，来自：https://work.aone.alibaba-inc.com/issue/34949369\n        controller.run('onAction', removeLink(placeholder));\n      } else {\n        controller.run('onAction', wrapLink());\n      }\n    }\n  }, [controller, decrs, isSelectionInPureLink, placeholder]);\n\n  const disabled = React.useMemo(() => {\n    const inlines = document.getLeafInlinesAtRange(selection);\n    const isInvalidInlineInSelection = inlines.some((inline) => {\n      return !isLink(inline) && !Image.isImage(inline);\n    })\n    return isInvalidInlineInSelection || controller.query('isSelectionInListSymbol') || false;\n  }, [selection, document, value]);\n\n  const isInLink = isSelectionInLink(controller.value) || isSelectionInPureLink;\n\n  const tooltip = React.useMemo(() => ({\n    title: isInLink ? locale?.unlink : locale.link,\n    description: 'Markdown: []() ' + (locale?.['space'] || 'Space'),\n    shortCut: SHORTCUT,\n    ...tooltipProp,\n  }), [isInLink, tooltipProp]);\n\n  return isInLink ? (\n    <DeleteLinkButton\n      testid=\"bi-toolbar-unlink\"\n      onClick={handleClick}\n      disabled={disabled}\n      title={locale?.link}\n      role={PluginRoles.link}\n      tooltip={tooltip}\n      {...rest}\n    />\n  ) : (\n    <AddLinkButton\n      testid=\"bi-toolbar-link\"\n      onClick={handleClick}\n      disabled={disabled}\n      title={locale?.link}\n      role={PluginRoles.linkDelete}\n      tooltip={tooltip}\n      {...rest}\n    />\n  );\n};\n\nexport default LinkButton;\n"],"file":"linkButton.js"}