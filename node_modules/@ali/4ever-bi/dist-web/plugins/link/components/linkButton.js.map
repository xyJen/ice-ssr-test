{"version":3,"sources":["../../../../../src/plugins/link/components/linkButton.tsx"],"names":["React","AddLinkButton","DeleteLinkButton","environment","Image","PluginRoles","ToolbarMode","IconButtonShortcut","wrapLink","unwrapPureLink","removeLink","isLink","isSelectionInLink","LINK_INSERT_HOT_KEY_TIP","tryGetSelectedLinkPlaceholder","MOD","IS_MAC","SHORTCUT","isSelectionInDecoration","selection","decotation","focus","isTextPoint","key","start","end","offset","LinkButton","props","locale","controller","toolbarMode","rest","value","startBlock","activeMarks","document","shortcut","decrs","useMemo","run","isSelectionInPureLink","decrsInSelection","filter","decr","marks","map","mark","concat","some","type","ploceholder","addLinkPlaceholder","handleClick","useCallback","linkDecoration","find","data","node","getNode","href","disabled","inlines","getLeafInlinesAtRange","isInvalidInlineInSelection","inline","isImage","query","isInLink","link","unlink","space","linkDelete"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { AddLinkButton, DeleteLinkButton } from '@ali/we-toolbar';\nimport { Controller, Text, environment, Selection, Decoration, TextPoint } from '@ali/4ever-cangjie';\nimport { Image } from '@ali/4ever-mo';\nimport { PluginRoles } from '@ali/4ever-bamboo';\nimport { ToolbarMode, IconButtonShortcut } from '@ali/4ever-component';\nimport { wrapLink, unwrapPureLink, removeLink } from '../actions';\nimport { isLink, isSelectionInLink } from '../utils';\n;\nimport { LINK_INSERT_HOT_KEY_TIP } from '../utils/hotKeyTips';\nimport { tryGetSelectedLinkPlaceholder } from '../utils/isSelectionInLink';\n\nconst MOD = environment.IS_MAC ? '⌘' : 'Ctrl';\nconst SHORTCUT = `${MOD}+K`;\n\nexport interface LinkButtonProps {\n  locale: Record<string, string>;\n  controller: Controller;\n  toolbarMode?: ToolbarMode;\n}\n\nfunction isSelectionInDecoration(selection: Selection, decotation: Decoration) {\n  const { focus } = selection;\n  return focus.isTextPoint()\n    && focus.key === decotation.start.key\n    && focus.key === decotation.end.key\n    && focus.offset >= decotation.start.offset\n    && focus.offset <= decotation.end.offset;\n}\n\nconst LinkButton: React.FC<LinkButtonProps> = (props) => {\n  const { locale, controller, toolbarMode, ...rest } = props;\n  const { value } = controller;\n  const { startBlock, activeMarks, selection, document } = controller.value;\n  const shortcut = toolbarMode === ToolbarMode.double ? ` ${SHORTCUT}` : '';\n\n  const decrs = React.useMemo(() => {\n    if (startBlock) {\n      return controller.run('decorateNode', startBlock);\n    }\n    return [];\n  }, [controller, startBlock]);\n\n  const isSelectionInPureLink = React.useMemo(() => {\n\n    const decrsInSelection = decrs.filter(decr => isSelectionInDecoration(selection, decr));\n\n    const marks = decrsInSelection.map((decr) => decr.mark).concat(activeMarks);\n    return (\n      marks.some(({ type }) => type === 'link') &&\n      !marks.some(({ type }) => type === 'unlink')\n    );\n  }, [decrs, activeMarks, selection]);\n\n  const ploceholder = tryGetSelectedLinkPlaceholder(controller.value, locale.addLinkPlaceholder);\n\n  const handleClick = React.useCallback(() => {\n    if (isSelectionInPureLink) {\n      const { document, selection } = controller.value;\n      const focus = selection.focus as TextPoint;\n      const linkDecoration = decrs.find(\n        ({ mark, start, end }) => mark.type === 'link' &&\n          focus.key === start.key &&\n          focus.offset >= start.offset &&\n          focus.offset <= end.offset,\n      );\n      if (!linkDecoration) {\n        return;\n      }\n      const { mark, start } = linkDecoration;\n      const { data } = mark;\n      const node = document.getNode(start.key) as Text;\n      controller.run('onAction', unwrapPureLink(node, start.offset, data.href));\n    } else {\n      if (ploceholder) {\n        // 在占位符进行取消链接时，直接执行删除，来自：https://work.aone.alibaba-inc.com/issue/34949369\n        controller.run('onAction', removeLink(ploceholder));\n      } else {\n        controller.run('onAction', wrapLink());\n      }\n    }\n  }, [controller, decrs, isSelectionInPureLink, ploceholder]);\n\n  const disabled = React.useMemo(() => {\n    const inlines = document.getLeafInlinesAtRange(selection);\n    const isInvalidInlineInSelection = inlines.some((inline) => {\n      return !isLink(inline) && !Image.isImage(inline);\n    })\n    return isInvalidInlineInSelection || controller.query('isSelectionInListSymbol');\n  }, [selection, document, value]);\n\n  const isInLink = isSelectionInLink(controller.value) || isSelectionInPureLink;\n\n  return isInLink ? (\n    <DeleteLinkButton\n      {...rest}\n      shortcutText={shortcut}\n      testid=\"bi-toolbar-unlink\"\n      onClick={handleClick}\n      disabled={disabled}\n      title={locale?.link}\n      role={PluginRoles.link}\n      tooltip={\n        <IconButtonShortcut\n          title={locale?.unlink}\n          shortcut={LINK_INSERT_HOT_KEY_TIP}\n          description={`Markdown: []() ${locale.space}`}\n        />\n      }\n    />\n  ) : (\n    <AddLinkButton\n      {...rest}\n      shortcutText={shortcut || LINK_INSERT_HOT_KEY_TIP}\n      tooltip={\n        <IconButtonShortcut\n          title={locale?.link}\n          shortcut={LINK_INSERT_HOT_KEY_TIP}\n          description={`Markdown: []() ${locale.space}`}\n        />\n      }\n      testid=\"bi-toolbar-link\"\n      onClick={handleClick}\n      disabled={disabled}\n      role={PluginRoles.linkDelete}\n    />\n  );\n};\n\nexport default LinkButton;\n"],"file":"linkButton.js"}