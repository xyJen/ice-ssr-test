{"version":3,"sources":["../../../../../../src/plugins/link/components/linkPortal/useEditorPortal.tsx"],"names":["React","LinkEditor","usePrevious","value","ref","useRef","useEffect","current","useEditorPortal","props","node","text","href","onSave","onRemove","onUnlink","controller","locale","isLinkFocused","enableCard","onEditorHide","portalRef","linkRef","isEditMode","isPlaceholder","nodeKey","key","isFocused","textInputRef","hrefInputRef","isEmptyHref","trim","length","preLinkFocused","focus","handleLinkMouseDown","useCallback","event","stopPropagation","preventDefault","handleLinkClick","handleClickoutside","target","contains","overlay","useMemo"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { LinkPortalProps } from '../../types';\nimport LinkEditor from '../linkEditor';\n\ninterface EditorPortalProps extends LinkPortalProps {\n  isEditMode: boolean;\n  onEditorHide: (delay?: number) => void;\n  portalRef: React.RefObject<HTMLDivElement>;\n  linkRef: React.RefObject<HTMLDivElement>;\n  isPlaceholder: boolean;\n}\n\ninterface IEditorPortal {\n  overlay: React.ReactElement;\n  handleLinkMouseDown: (event: React.MouseEvent) => void;\n  handleLinkClick: (event: React.MouseEvent) => void;\n}\n\n// 用于记录上一次的props, 类似react lifecycle当中的preProps\nfunction usePrevious<T>(value: T) {\n  const ref = React.useRef<T>();\n  React.useEffect(() => {\n    ref.current = value;\n  });\n  return ref.current;\n}\n\n\nconst useEditorPortal = (props: EditorPortalProps): IEditorPortal => {\n  const {\n    node,\n    text,\n    href = '',\n    onSave,\n    onRemove,\n    onUnlink,\n    controller,\n    locale,\n    isLinkFocused,\n    enableCard,\n    onEditorHide,\n    portalRef,\n    linkRef,\n    isEditMode,\n    isPlaceholder\n  } = props;\n\n  const nodeKey = node?.key;\n  const { isFocused } = controller.value;\n\n  const textInputRef = React.useRef<HTMLInputElement>();\n  const hrefInputRef = React.useRef<HTMLInputElement>();\n  const isEmptyHref = href.trim().length === 0;\n\n  const preLinkFocused = usePrevious(isLinkFocused);\n\n  React.useEffect(() => {\n    // 占位符默认 focus 标题\n    if (isEditMode && isPlaceholder) {\n      textInputRef.current?.focus();\n    }\n  }, [textInputRef, isPlaceholder, isEditMode]);\n\n  React.useEffect(() => {\n    // 外部点击触发编辑框显示时，应该 focus 到输入框\n    if (isFocused && !preLinkFocused && !isLinkFocused) {\n      if (isEmptyHref) {\n        // 空连接默认 focus href\n        hrefInputRef.current?.focus();\n      }\n    }\n  }, [hrefInputRef, isLinkFocused, isFocused, preLinkFocused]);\n\n  const handleLinkMouseDown = React.useCallback((event) => {\n    if (isPlaceholder && isEditMode) {\n      event.stopPropagation();\n      event.preventDefault();\n      textInputRef.current?.focus();\n    }\n    if (isEmptyHref && isEditMode) {\n      event.stopPropagation();\n      event.preventDefault();\n      hrefInputRef.current?.focus();\n    }\n    // controller.run('onAction', focusLinkEditor());\n  }, [textInputRef, hrefInputRef, isPlaceholder, isEditMode]);\n\n\n  // 编辑状态下 click 正常链接，隐藏编辑框\n  const handleLinkClick = React.useCallback((event) => {\n    if (!isPlaceholder && !isPlaceholder && isEditMode) {\n      onEditorHide();\n    }\n  }, [isEditMode, isPlaceholder, isEmptyHref]);\n\n  const handleClickoutside = React.useCallback((event) => {\n    const target = event.target as HTMLElement;\n    if (target === linkRef.current || linkRef.current?.contains(target)) {\n      return;\n    }\n    onEditorHide();\n  }, [onEditorHide]);\n\n  const overlay = React.useMemo(() => {\n    return (\n      <LinkEditor\n        ref={portalRef}\n        displayType={'link'}\n        nodeKey={nodeKey}\n        text={isPlaceholder ? '' : text}\n        href={href}\n        onSave={onSave}\n        onRemove={onRemove}\n        onUnlink={onUnlink}\n        locale={locale}\n        controller={controller}\n        onHide={onEditorHide}\n        onClickoutside={handleClickoutside}\n        enableCard={enableCard}\n        showPlaceholder={isPlaceholder}\n        textInputRef={textInputRef}\n        hrefInputRef={hrefInputRef}\n      />);\n  }, [portalRef, nodeKey, text, href, onSave, onRemove, onUnlink, locale, controller, enableCard, onEditorHide, handleClickoutside, isPlaceholder]);\n\n  return { overlay, handleLinkMouseDown, handleLinkClick };\n};\n\nexport default useEditorPortal;\n"],"file":"useEditorPortal.js"}