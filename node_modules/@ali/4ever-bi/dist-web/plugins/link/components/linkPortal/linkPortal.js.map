{"version":3,"sources":["../../../../../../src/plugins/link/components/linkPortal/linkPortal.tsx"],"names":["React","useZoom","useZoomContainer","Portal","useEditorPortal","useToolbarPortal","useDelayedState","hoverLinkCard","usePrevious","offsetX","offsetY","offset","HIDE_TOOLBAR_DELAY_TIME","getPosition","containerRect","triggerRect","portalRect","height","width","baseTop","bottom","top","baseLeft","left","bottomSpace","rightSpace","triggerTop","triggerRight","right","stopEvent","event","stopPropagation","LinkPortal","props","children","text","href","locale","controller","mountRoot","portalState","setPortalState","useState","overlayChanging","setOverlayChanging","hidingOverlay","setHidingOverlay","onOverlayHide","useCallback","showEditor","hideEditor","s","showToolbar","hideToolbar","defaultContent","document","body","scrollableContent","zoom","portalRef","useRef","linkRef","isPlaceholder","addLinkPlaceholder","isEmptyHref","trim","length","showStopEvent","isNormalLink","editorPortal","isEditMode","onEditorHide","toolbarPortal","onSwitchToEdit","editorOverlay","overlay","handleEditorLinkMouseDown","handleLinkMouseDown","handleEditorLinkClick","handleLinkClick","toolbarOverlay","handleMouseEnter","run","handleClick","prePortalState","useEffect","preVisible","currentVisible","cloneElement","onMouseDown","onMouseUp","undefined","onClick","onMouseEnter","onMouseLeave"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { useZoom, useZoomContainer } from '@ali/4ever-cangjie';\nimport Portal from '../AnimatePortal';\nimport type { GetPosition } from '@ali/4ever-component';\nimport { LinkPortalProps } from '../../types';\nimport useEditorPortal from './useEditorPortal';\nimport useToolbarPortal from './useToolbarPortal';\nimport { useDelayedState } from '@ali/4ever-component';\nimport { hoverLinkCard } from '../../actions';\nimport { usePrevious } from '@ali/we-design';\n\nconst offsetX = 0;\nconst offsetY = 6;\nconst offset = [offsetX, offsetY];\n\n// toolbar 隐藏延时\nconst HIDE_TOOLBAR_DELAY_TIME = 150;\n\nconst getPosition: GetPosition = (containerRect: DOMRect, triggerRect: DOMRect, portalRect: DOMRect) => {\n  const { height, width } = portalRect;\n\n  const baseTop = triggerRect.bottom - containerRect.top;\n  const baseLeft = triggerRect.left - containerRect.left;\n  // 计算底部剩余空间，若剩余空间能够容纳 portal，则向下展示 portal\n  // 如果下方剩余空间无法容纳 portal，还需要判断上方空间能否容纳\n  // 若上方也无法容纳(triggerTop < height)，则仍然放到下方\n  // 左右则优先放右侧，不够之后向左偏移\n  const bottomSpace = containerRect.height - baseTop;\n  const rightSpace = containerRect.width - baseLeft;\n\n  const triggerTop = triggerRect.top - containerRect.top;\n  const triggerRight = triggerRect.right - containerRect.left;\n\n  const top =\n    bottomSpace < height && triggerTop > height\n      ? triggerTop + offsetY - height - 4 // 放到上方\n      : baseTop + offsetY;\n  const left =\n    rightSpace < width && triggerRight > width\n      ? baseLeft + offsetX - width + rightSpace - 4\n      : baseLeft + offsetX;\n  return { left, top };\n};\n\nconst stopEvent = (event: React.MouseEvent) => event.stopPropagation();\n\ntype PortalState = 'Hidden' | 'EditorVisible' | 'ToolbarVisible';\n\nconst LinkPortal: React.FC<LinkPortalProps> = (props) => {\n  const {\n    children,\n    text,\n    href,\n    locale,\n    controller,\n    mountRoot = false,\n  } = props;\n\n  const [portalState, setPortalState] = useDelayedState<PortalState>('Hidden');\n  const [overlayChanging, setOverlayChanging] = React.useState<boolean>(false);\n  const [hidingOverlay, setHidingOverlay] = React.useState<React.ReactElement | null>(null);\n\n\n\n  const onOverlayHide = React.useCallback(() => {\n    setHidingOverlay(null);\n    setOverlayChanging(false);\n  }, []);\n\n  const showEditor = React.useCallback(() => {\n    setPortalState('EditorVisible');\n  }, []);\n\n  const hideEditor = React.useCallback(() => {\n    setPortalState((s) => {\n      return s === 'EditorVisible' ? 'Hidden' : s;\n    });\n  }, []);\n\n  const showToolbar = React.useCallback(() => {\n    setPortalState((s) => {\n      return s === 'Hidden' || s === 'ToolbarVisible' ? 'ToolbarVisible' : s;\n    });\n  }, []);\n\n  const hideToolbar = React.useCallback(() => {\n    // toolbar 隐藏时设置延时，处理链接到卡片的 hover 情况\n    setPortalState((s) => {\n      return s === 'ToolbarVisible' ? 'Hidden' : s;\n    }, HIDE_TOOLBAR_DELAY_TIME);\n  }, []);\n  const defaultContent =  useZoomContainer() || document.body;\n  const scrollableContent = mountRoot ? document.body : defaultContent;\n  const zoom = useZoom();\n  const portalRef = React.useRef<HTMLDivElement>(null);\n  const linkRef = React.useRef<HTMLDivElement>(null);\n\n  const isPlaceholder = text === locale.addLinkPlaceholder;\n  const isEmptyHref = href.trim().length === 0;\n  const showStopEvent = portalState === 'EditorVisible' && (isPlaceholder || isEmptyHref);\n  const isNormalLink = (!isPlaceholder && !isEmptyHref);\n\n  // 这里在编辑模式下，显示编辑框\n  const editorPortal = useEditorPortal({ ...props, isEditMode: portalState === 'EditorVisible', onEditorHide: hideEditor, linkRef, portalRef, isPlaceholder });\n  const toolbarPortal = useToolbarPortal({ ...props, onSwitchToEdit: showEditor, showToolbar, hideToolbar, linkRef, portalRef, isPlaceholder });\n  const {\n    overlay: editorOverlay,\n    handleLinkMouseDown: handleEditorLinkMouseDown,\n    handleLinkClick: handleEditorLinkClick } = editorPortal;\n\n  const { overlay: toolbarOverlay,\n    handleLinkMouseDown,\n    handleLinkClick,\n  } = toolbarPortal;\n\n  const handleMouseEnter = React.useCallback(() => {\n    showToolbar();\n    controller.run('onAction', hoverLinkCard());\n  }, [controller, showToolbar]);\n\n  const overlay = portalState !== 'EditorVisible' ? toolbarOverlay : editorOverlay;\n\n  const handleClick = portalState !== 'EditorVisible' ? handleLinkClick : handleEditorLinkClick;\n\n  const prePortalState = usePrevious(portalState);\n\n  React.useEffect(() => {\n    const preVisible = prePortalState === 'EditorVisible' || prePortalState === 'ToolbarVisible';\n    const currentVisible = portalState === 'EditorVisible' || portalState === 'ToolbarVisible';\n\n    if (preVisible && !currentVisible) {\n      // 进行隐藏时，使用旧的 overlay 进行隐藏，避免动画过程中组件切换\n      setHidingOverlay(prePortalState !== 'EditorVisible' ? toolbarOverlay : editorOverlay)\n    } else if (preVisible && currentVisible && prePortalState !== portalState) {\n      // 显示状态下切换 overlay，先使用旧的 overlay 进行隐藏，再显示新的 overlay\n      setOverlayChanging(true);\n      setHidingOverlay(prePortalState !== 'EditorVisible' ? toolbarOverlay : editorOverlay);\n    }\n  }, [prePortalState, portalState])\n\n  return (\n    <Portal\n      className=\"bi-link-portal\"\n      visible={portalState !== 'Hidden' && !overlayChanging}\n      triggerRef={linkRef}\n      overlay={hidingOverlay || overlay}\n      portalMatchTrigger={false}\n      getPosition={getPosition}\n      onOverlayHide={onOverlayHide}\n      container={scrollableContent}\n      offset={offset}\n      zoom={zoom}\n    >\n      {React.cloneElement(children as React.ReactElement, {\n        onMouseDown: portalState !== 'EditorVisible' ? handleLinkMouseDown : handleEditorLinkMouseDown,\n        // 当点击占位符时，需要阻止事件冒泡，避免被 cangjie 处理\n        onMouseUp: showStopEvent ? stopEvent : undefined,\n        onClick: showStopEvent ? stopEvent : handleClick,\n        onMouseEnter: portalState !== 'EditorVisible' && isNormalLink ? handleMouseEnter : undefined,\n        onMouseLeave: portalState !== 'EditorVisible' ? hideToolbar : undefined,\n      })}\n    </Portal>\n  );\n};\n\nexport default LinkPortal;\n"],"file":"linkPortal.js"}