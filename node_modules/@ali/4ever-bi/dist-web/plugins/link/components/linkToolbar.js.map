{"version":3,"sources":["../../../../../src/plugins/link/components/linkToolbar.tsx"],"names":["React","Tooltip","WebBetaNormal","ToolbarWrapper","LinkHref","LinkHrefWrapper","CardToolbarWrapper","useOnClickOutside","LinkCard","ToolbarIcon","LinkToolbar","forwardRef","props","ref","onEdit","onRemove","onCut","onUnlink","href","onHide","onClickoutside","onCopy","locale","getLinkInfo","onToolbarSwitchStyle","onOpenlink","title","imgURL","desc","enableCard","onMouseLeave","onMouseEnter","onCleanup","isMounted","useRef","useState","cardImgURL","setCardImgURL","cardTitle","setCardTitle","cardDesc","setCardDesc","cardState","setCardState","useEffect","current","handleKeyDown","event","key","toLowerCase","keyCode","preventDefault","document","addEventListener","removeEventListener","handleRefresh","useCallback","info","newImgURL","newTitle","newDesc","undefined","handleSwitchStyle","style","handleVisit","handleCopy","handleRemove","stopPropagation","handleUnlink","LinkCardToolbar","NormalToolbar","openLinkTip","edit","copy","unlink","memo"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { Tooltip, WebBetaNormal } from '@ali/we-design';\nimport { ToolbarWrapper, LinkHref, LinkHrefWrapper, CardToolbarWrapper } from './styled';\nimport { useOnClickOutside } from '@ali/4ever-component';\nimport { LinkDisplayType, LinkPluginConfig, CardState } from '../types';\nimport { LinkCard } from './card/LinkCard';\nimport ToolbarIcon from './ToolbarIcon';\n\ninterface LinkToolbarProps {\n  href: string;\n  title?: string;\n  desc?: string;\n  imgURL?: string;\n  onEdit: () => void;\n  onRemove: () => void;\n  onCut: () => void;\n  onHide: () => void;\n  onUnlink: () => void;\n  onOpenlink: () => void;\n  onCopy: (href: string) => void;\n  onClickoutside: (event: MouseEvent) => void;\n  onMouseLeave: (event?: React.MouseEvent) => void;\n  onMouseEnter: (event?: React.MouseEvent) => void;\n  onCleanup: () => void;\n  locale: LinkPluginConfig['locale'];\n  getLinkInfo?: LinkPluginConfig['getLinkInfo'];\n  onToolbarSwitchStyle: (href: string, displayType: LinkDisplayType, title?: string, desc?: string, imgURL?: string) => void;\n  // todo 全量后下线配置\n  enableCard: boolean;\n}\n\nconst LinkToolbar = React.forwardRef<HTMLDivElement, LinkToolbarProps>(\n  (props, ref) => {\n    const {\n      onEdit,\n      onRemove,\n      onCut,\n      onUnlink,\n      href,\n      onHide,\n      onClickoutside,\n      onCopy,\n      locale,\n      getLinkInfo,\n      onToolbarSwitchStyle,\n      onOpenlink,\n      title,\n      imgURL,\n      desc,\n      enableCard,\n      onMouseLeave,\n      onMouseEnter,\n      onCleanup,\n    } = props;\n\n    useOnClickOutside(ref as React.RefObject<HTMLDivElement>, onClickoutside);\n    const isMounted = React.useRef<boolean>(false);\n    const [cardImgURL, setCardImgURL] = React.useState<string | undefined>(imgURL);\n    const [cardTitle, setCardTitle] = React.useState<string | undefined>(title);\n    const [cardDesc, setCardDesc] = React.useState<string | undefined>(desc);\n    const [cardState, setCardState] = React.useState<CardState>('normal');\n\n    React.useEffect(() => {\n      isMounted.current = true;\n      return () => {\n        isMounted.current = false;\n      };\n    }, []);\n\n    React.useEffect(() => {\n      const handleKeyDown = (event: KeyboardEvent) => {\n        if (!event.key) {\n          return;\n        }\n        const key = event.key.toLowerCase();\n        if (key.toLowerCase() === 'escape' || event.keyCode === 27) {\n          event.preventDefault();\n          // ESC 退出\n          onHide();\n        }\n      };\n      document.addEventListener('keydown', handleKeyDown);\n      return () => {\n        document.removeEventListener('keydown', handleKeyDown);\n      };\n    }, [onHide]);\n\n    const handleRefresh = React.useCallback(\n      async () => {\n        if (getLinkInfo && typeof getLinkInfo === 'function') {\n          setCardState('loading');\n\n          try {\n            const info = await getLinkInfo(href);\n\n            // 组件已经卸载，直接返回\n            if (!isMounted.current) {\n              return;\n            }\n            if (info) {\n              // 请求成功\n              const { imgURL: newImgURL = '', title: newTitle = '', desc: newDesc = '' } = info;\n              setCardImgURL(newImgURL);\n              setCardTitle(newTitle);\n              setCardDesc(newDesc);\n              setCardState('normal');\n              return;\n            }\n          } catch (e) {\n            console.debug(e);\n          }\n        }\n        // 请求失败，不更新数据,将卡片信息设置为 undefined\n        setCardState('error');\n        setCardImgURL(undefined);\n        setCardTitle(undefined);\n        setCardDesc(undefined);\n      }, [getLinkInfo, href, isMounted, setCardState, setCardImgURL, setCardTitle, setCardDesc],\n    );\n\n    // mount 时拉取数据\n    React.useEffect(() => {\n      if (enableCard) {\n        if (imgURL === undefined && title === undefined && desc === undefined) {\n          handleRefresh();\n        } else {\n          setCardState('normal');\n        }\n      }\n      return () => {\n        onCleanup();\n      }\n    }, [handleRefresh, imgURL, title, desc, setCardState, enableCard, onHide, onCleanup]);\n\n    // unmount 时确保 onCleanup 执行\n    React.useEffect(() => {\n      return () => {\n        onCleanup();\n      }\n    }, [onCleanup]);\n\n    // 切换展示风格时，将请求到的数据发出\n    const handleSwitchStyle = React.useCallback((style: LinkDisplayType) => {\n      onToolbarSwitchStyle(href, style, cardTitle, cardDesc, cardImgURL);\n    }, [href, cardTitle, cardDesc, cardImgURL, onToolbarSwitchStyle]);\n\n    const handleVisit = React.useCallback(\n      (event: React.MouseEvent) => {\n        event.preventDefault();\n        onOpenlink();\n      },\n      [onOpenlink],\n    );\n    const handleCopy = React.useCallback(\n      (event?: React.MouseEvent) => {\n        event?.preventDefault();\n        onCopy(href);\n      }, [href, onCopy],\n    );\n    const handleRemove = React.useCallback(\n      (event?: React.MouseEvent) => {\n        event?.preventDefault();\n        event?.stopPropagation();\n        onRemove();\n      }, [onRemove],\n    );\n    const handleUnlink = React.useCallback(\n      (event?: React.MouseEvent) => {\n        event?.preventDefault();\n        event?.stopPropagation();\n        onUnlink();\n      }, [onUnlink],\n    );\n\n    const LinkCardToolbar = (\n      <CardToolbarWrapper data-testid=\"link-toolbar\" ref={ref} onMouseLeave={onMouseLeave} onMouseEnter={onMouseEnter}>\n        <LinkCard\n          displayType={'link'}\n          state={cardState}\n          href={href}\n          onCopy={onCopy}\n          onDelete={onRemove}\n          onCut={onCut}\n          onUnlink={onUnlink}\n          onEdit={onEdit}\n          title={cardTitle}\n          imgURL={cardImgURL}\n          desc={cardDesc}\n          locale={locale}\n          readonly={false}\n          isMobile={false}\n          onOpenLink={onOpenlink}\n          onSwitchStyle={handleSwitchStyle}\n          onRefresh={handleRefresh}\n        />\n      </CardToolbarWrapper>\n    );\n\n    const NormalToolbar = (\n      <ToolbarWrapper data-testid=\"link-toolbar\" ref={ref} onMouseLeave={onMouseLeave} onMouseEnter={onMouseEnter}>\n        <WebBetaNormal />\n        <LinkHrefWrapper>\n          <Tooltip placement=\"bottom\" title={locale.openLinkTip}>\n            <LinkHref onMouseDown={handleVisit} data-testid=\"link-toolbar-visit\">\n              {href}\n            </LinkHref>\n          </Tooltip>\n        </LinkHrefWrapper>\n        <ToolbarIcon\n          data-testid=\"link-toolbar-edit\"\n          type=\"editor-border-beta\"\n          tip={locale.edit}\n          onMouseDown={onEdit}\n        />\n        <ToolbarIcon\n          data-testid=\"link-toolbar-copy\"\n          type=\"copy-beta\"\n          tip={locale.copy}\n          onMouseDown={handleCopy}\n        />\n        <ToolbarIcon\n          data-testid=\"link-toolbar-unlink\"\n          type=\"delete-link-beta\"\n          tip={locale.unlink}\n          onMouseDown={handleUnlink}\n        />\n        <ToolbarIcon\n          data-testid=\"link-toolbar-remove\"\n          type=\"delete-beta\"\n          tip={locale.delete}\n          onMouseDown={handleRemove}\n        />\n      </ToolbarWrapper>\n    );\n\n    return enableCard ? LinkCardToolbar : NormalToolbar;\n  },\n);\n\nexport default React.memo(LinkToolbar);\n"],"file":"linkToolbar.js"}