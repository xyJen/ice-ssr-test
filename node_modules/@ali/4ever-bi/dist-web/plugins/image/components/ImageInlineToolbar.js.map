{"version":3,"sources":["../../../../../src/plugins/image/components/ImageInlineToolbar.tsx"],"names":["React","debounce","environment","domUtils","PluginRoles","IconButton","Button","MoreButton","RotatepictureNormal","CounterclockwiseNormal","Rotate90Normal","ClockwiseNormal","CutNormal","CutPicNormal","DownloadpicturenewNormal","SelectDownloadNormal","RotateLeftLineThinNormal","PreviewBetaNormal","Menu","removeImage","setImageInjection","InlineToolbar","getData","TextButton","EditorMenu","inlineToolbarOverlayStyle","backgroundColor","boxShadow","border","inlineToolbarStyle","padding","borderRadius","getToolButton","name","icon","handleClick","testid","role","controller","node","handleClickWithController","event","props","ImageInlineToolbar","mutationObserver","observerCallback","mutationsList","parentDOM","ignoreMuation","every","mutation","shouldIgnoreMutation","setState","key","Math","random","handlepreview","e","preventDefault","stopPropagation","previewImage","src","data","handledeleteImg","run","handleCorp","isImageCropping","handleDownload","downloadImage","handlePreview","getCustomToolbar","customToolbars","extraData","getMoreMenuButton","inlineToolbarMore","getScrollableContent","getCustomToolButtons","locale","handleInlineToolbarRotate","handleInlineToolbarRotateAntiClockwise","cropping","imageInlineToolbarCrop","downloadImg","imageInlineToolbarDownload","previewImg","imageInlineToolbarPreview","rotateAntiClockwise","rotate","imageInlineToolbarRotate","imageInlineToolbarSingleRotateReverse","getToolButtonFromConfig","config","buttons","state","componentDidMount","initMutationObserver","componentWillUnmount","disconnect","cancel","root","type","target","attributeName","res","current","document","body","targetKey","getAttribute","parentElement","parent","value","getParent","findDOMNodeSafely","MutationObserver","observe","childList","attributes","subtree","attributeFilter","render","visible","triggerNode","inlineToolbarLayout","customToolButtonConfig","customToolLayout","IS_TOUCH_DEVICE","Component"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { debounce } from 'lodash-es';\nimport { Controller, Inline, environment, domUtils } from '@ali/4ever-cangjie';\nimport { ImagePlugin, PluginRoles } from '@ali/4ever-bamboo';\nimport { IconButton as Button, MoreButton } from '@ali/we-toolbar';\nimport {\n  RotatepictureNormal as CounterclockwiseNormal,\n  Rotate90Normal as ClockwiseNormal,\n  CutNormal as CutPicNormal,\n  DownloadpicturenewNormal as SelectDownloadNormal,\n  RotateLeftLineThinNormal,\n} from '@ali/we-icon';\nimport {\n  PreviewBetaNormal,\n  Menu,\n} from '@ali/we-design';\n\nimport { removeImage, setImageInjection } from '../actions';\nimport { InlineToolbar } from '../../../index';\nimport { getData } from '@ali/4ever-utils';\nimport { CustomToolButtonConfig } from '../types';\nimport TextButton from './TextButton';\nimport { TYPE_MENU_DATA, Menu as EditorMenu } from '@ali/4ever-component';\n\nconst inlineToolbarOverlayStyle = {\n  backgroundColor: 'transparent',\n  boxShadow: 'none',\n  border: 'none',\n};\n\nconst inlineToolbarStyle = {\n  border: 'none',\n  boxShadow: '0px 0px 1px rgb(0 0 0 / 24%), 0px 8px 24px rgb(0 0 0 / 16%)',\n  padding: '0 5px',\n  borderRadius: '4px',\n};\n\nexport interface ImageToolbarProps {\n  controller: Controller;\n  node: Inline;\n  locale: ImagePlugin.ILocale | Record<string, any>;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  handleInlineToolbarRotate(e: any): void;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  handleInlineToolbarRotateAntiClockwise(e: any): void;\n  previewImage(url: string, node: Inline): void;\n  downloadImage(url: string): void;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  onEnterCroppingMode(e: any): void;\n  getZoomContainer(): HTMLElement | null;\n  getScrollableContent(): HTMLElement;\n  triggerNode: HTMLElement | null;\n  visible?: boolean;\n  inlineToolbarLayout?: any;\n  customToolbars?: {\n    customToolButtonConfig: CustomToolButtonConfig;\n    customToolLayout: any;\n  };\n  inlineToolbarMore?: TYPE_MENU_DATA;\n}\n\nexport interface ImageToolbarState {\n  key: string;\n}\n\nexport const getToolButton = (\n  name: string | undefined,\n  icon: React.ReactNode,\n  handleClick: (event: React.MouseEvent, controller?: Controller, node?: any) => any,\n  testid: string,\n  role: string,\n  controller?: Controller,\n  node?: any,\n) => {\n  const handleClickWithController = (event) => {\n    return handleClick(event, controller, node);\n  };\n  return (props) => {\n    if (!icon) {\n      return <TextButton name={name} testid={testid} role={role} handleClick={handleClickWithController} />;\n    }\n    return (\n      <Button\n        {...props}\n        testid={testid}\n        onClick={handleClickWithController}\n        title={name}\n        tooltip={name}\n        bordered={false}\n        icon={icon}\n        role={role}\n      />\n    );\n  };\n};\n\nclass ImageInlineToolbar extends React.Component<ImageToolbarProps, ImageToolbarState> {\n  private mutationObserver: MutationObserver | null = null;\n\n  constructor(props) {\n    super(props);\n    this.state = {\n      key: 'image-inline-toolbar-0',\n    };\n  }\n\n  componentDidMount() {\n    this.initMutationObserver();\n  }\n\n  componentWillUnmount() {\n    this.mutationObserver?.disconnect();\n    this.observerCallback.cancel();\n  }\n\n  shouldIgnoreMutation(mutation: MutationRecord, root: HTMLElement) {\n    const { type, target, attributeName } = mutation;\n    const { key } = this.props.node;\n    let res = false;\n    if (type === 'attributes' && attributeName === 'style') {\n      let current: HTMLElement | null = target as HTMLElement;\n      while (current && current !== root && current !== document.body) {\n        const targetKey = current.getAttribute('data-cangjie-key');\n        if (key === targetKey) {\n          res = true;\n          break;\n        }\n        current = current.parentElement;\n      }\n    }\n    return res;\n  }\n\n  observerCallback = debounce((mutationsList: MutationRecord[], parentDOM: HTMLElement) => {\n    const ignoreMuation = mutationsList.every((mutation: MutationRecord) => this.shouldIgnoreMutation(mutation, parentDOM));\n    if (!ignoreMuation) {\n      this.setState({\n        key: `image-inline-toolbar-${Math.random()}`,\n      });\n    }\n  }, 200);\n\n  initMutationObserver() {\n    const { node, getScrollableContent } = this.props;\n    const parent = this.props.controller.value.document.getParent(node.key);\n    const root = getScrollableContent();\n    const parentDOM = parent && domUtils.findDOMNodeSafely(parent.key, root);\n    if (!parentDOM) {\n      return;\n    }\n\n    this.mutationObserver = new MutationObserver((mutationsList) => {\n      this.observerCallback(mutationsList, parentDOM);\n    });\n    this.mutationObserver.observe(parentDOM, {\n      childList: true,\n      attributes: true,\n      subtree: true,\n      attributeFilter: ['style'],\n    });\n  }\n\n  handlepreview = e => {\n    e.preventDefault();\n    e.stopPropagation();\n    const { node, previewImage } = this.props;\n    if (previewImage) {\n      const { src } = node.data;\n      previewImage(src, node);\n    }\n  };\n\n  handledeleteImg = e => {\n    e.preventDefault();\n    e.stopPropagation();\n    const { controller, node } = this.props;\n    controller.run('onAction', removeImage(node));\n  };\n\n  private readonly handleCorp = (event: React.MouseEvent) => {\n    const { controller, node } = this.props;\n    event.preventDefault();\n    event.stopPropagation();\n    controller.run(\n      'onAction',\n      setImageInjection(node.key, {\n        isImageCropping: true,\n      }),\n    );\n  };\n\n  private readonly handleDownload = (event: React.MouseEvent) => {\n    const { downloadImage, node } = this.props;\n    event.preventDefault();\n    event.stopPropagation();\n    if (downloadImage) {\n      const { src } = node.data;\n      downloadImage(src);\n    }\n  };\n\n  private readonly handlePreview = (event: React.MouseEvent) => {\n    const { previewImage, node } = this.props;\n    event.preventDefault();\n    event.stopPropagation();\n    if (previewImage) {\n      const { src } = node.data;\n      previewImage(src, node);\n    }\n  };\n\n  getCustomToolbar = (node, customToolbars) => {\n    const extraData = getData(node.data, 'extraData', {} as any);\n    for (const key in customToolbars) {\n      if (extraData[key]) {\n        return customToolbars[key];\n      }\n    }\n    return null;\n  };\n\n  getMoreMenuButton = () => {\n    const { inlineToolbarMore, getScrollableContent } = this.props;\n    return () => {\n      if (!inlineToolbarMore) {\n        return null;\n      }\n      return (\n        <MoreButton\n          testid=\"image-inline-more-dropdown\"\n          getContainer={getScrollableContent}\n          placement=\"bottomLeft\"\n          offsetY={0}\n          overlay={\n            <Menu\n              getContainer={getScrollableContent}\n              testid=\"image-inline-more-menu\"\n            >\n              <EditorMenu\n                menus={inlineToolbarMore}\n              />\n            </Menu>\n          }\n        />\n      );\n    };\n  };\n\n  getCustomToolButtons = () => {\n    const {\n      locale,\n      handleInlineToolbarRotate,\n      handleInlineToolbarRotateAntiClockwise,\n      downloadImage,\n      previewImage,\n    } = this.props;\n\n    return {\n      'image.crop': getToolButton(locale.cropping, <CutPicNormal />, this.handleCorp, 'bi-toolbar-image-crop', PluginRoles.imageInlineToolbarCrop),\n      'image.download': !downloadImage\n        ? null\n        : getToolButton(locale.downloadImg, <SelectDownloadNormal />, this.handleDownload, 'bi-toolbar-image-download', PluginRoles.imageInlineToolbarDownload),\n      'image.preview': !previewImage\n        ? null\n        : getToolButton(locale.previewImg, <PreviewBetaNormal />, this.handlePreview, 'bi-toolbar-image-preview', PluginRoles.imageInlineToolbarPreview),\n      'image.rotateReverse': getToolButton(\n        locale.rotateAntiClockwise,\n        <CounterclockwiseNormal />,\n        handleInlineToolbarRotateAntiClockwise,\n        'bi-toolbar-image-rotateReverse',\n        'imageInlineToolbarRotateReverse',\n      ),\n      'image.rotate': getToolButton(locale.rotate, <ClockwiseNormal />, handleInlineToolbarRotate, 'bi-toolbar-image-rotate', PluginRoles.imageInlineToolbarRotate),\n      'image.singeRotateReverse': getToolButton(\n        locale.rotateAntiClockwise,\n        <RotateLeftLineThinNormal />,\n        handleInlineToolbarRotateAntiClockwise,\n        'bi-toolbar-image-rotateReverse',\n        PluginRoles.imageInlineToolbarSingleRotateReverse,\n      ),\n      'image.more': this.getMoreMenuButton(),\n    };\n  };\n\n  getToolButtonFromConfig = (config: CustomToolButtonConfig) => {\n    const { controller, node } = this.props;\n    const buttons = {};\n    // eslint-disable-next-line guard-for-in\n    for (const key in config) {\n      const { name, icon, handleClick, testid, role } = config[key];\n      buttons[key] = getToolButton(name, icon, handleClick, testid, role, controller, node);\n    }\n    return buttons;\n  };\n\n  render() {\n    const { visible, triggerNode, inlineToolbarLayout, node, customToolbars } = this.props;\n    const { customToolButtonConfig, customToolLayout } = this.getCustomToolbar(node, customToolbars) || {};\n    // 狗姐：所有 inlineToolbar 样式和极简模式 inlineToolbar 保持一致，先从图片开刀\n    // 图片比较紧急，所以基于原来的 inlineToolbar 修改样式，而暂未使用新 inlineToolbar\n    return (\n      <InlineToolbar\n        key={this.state.key}\n        style={inlineToolbarStyle}\n        overlayStyle={inlineToolbarOverlayStyle}\n        visible={visible}\n        triggerNode={triggerNode}\n        inlineLayout={customToolLayout || inlineToolbarLayout}\n        customToolButtons={\n          customToolButtonConfig ?\n            this.getToolButtonFromConfig(customToolButtonConfig) : this.getCustomToolButtons()\n        }\n        offsetY={environment.IS_TOUCH_DEVICE ? -22 : -12}\n        testid=\"image\"\n      />\n    );\n  }\n}\n\nexport default ImageInlineToolbar;\n"],"file":"ImageInlineToolbar.js"}