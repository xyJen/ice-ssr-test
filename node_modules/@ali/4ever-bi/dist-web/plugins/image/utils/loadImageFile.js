import { environment } from '@ali/4ever-cangjie';
import logger from '@ali/4ever-logger';
import { getOrientation, orientationToAngle, rotateImage } from "./convertImage";
import checkFileType from "./checkFileType";
export default (function (file) {
  return new Promise(function (resolve, reject) {
    var reader = new FileReader();
    reader.addEventListener('load', function (e) {
      var buffer = e.target.result;

      var _checkFileType = checkFileType(file, buffer),
          checkedFile = _checkFileType.file,
          type = _checkFileType.type;

      var img = new Image(); // 只有 safari 浏览器支持 tiff 格式

      if ((type === 'tiff' || type === 'tif') && !environment.IS_SAFARI) {
        resolve({
          img: img,
          handledFile: checkedFile
        });
        return;
      }

      var orientation = getOrientation(buffer);
      var angle = orientationToAngle(orientation);
      rotateImage(checkedFile, angle).then(function (rotatedFile) {
        img.onload = function () {
          resolve({
            img: img,
            handledFile: checkedFile
          });
        };

        img.src = URL.createObjectURL(rotatedFile);
      });
    });
    reader.addEventListener('error', function () {
      logger.info({
        type: 'loadImageFailed',
        info: (file == null ? void 0 : file.type) || ''
      });
      reject(file);
    });
    reader.readAsArrayBuffer(file);
  });
});
//# sourceMappingURL=loadImageFile.js.map