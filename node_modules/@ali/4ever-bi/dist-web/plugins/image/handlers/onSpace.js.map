{"version":3,"sources":["../../../../../src/plugins/image/handlers/onSpace.ts"],"names":["Commands","Text","Block","Inline","Document","insertImagePlaceholder","markdownRegExp","onSpace","event","controller","next","value","anchorText","selection","document","isExpanded","convertToTextPoints","anchor","text","slice","offset","matches","match","matchText","alt","_s","src","_t","title","preventDefault","command","moveAnchorBackward","length","del","dispatch","mdType","moveToStartOfNextText","paragraph","create","type","nodes","data","encodeURI","fragment","insertFragment"],"mappings":"AAAA,SAAqBA,QAArB,EAA+BC,IAA/B,EAAqCC,KAArC,EAA4CC,MAA5C,EAAuEC,QAAvE,QAAuF,oBAAvF;AACA,OAAOC,sBAAP,2C,CAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,IAAMC,cAAc,GAAG,+EAAvB;AAEA,eAAe,SAASC,OAAT,CACbC,KADa,EAEbC,UAFa,EAGbC,IAHa,EAIb;AAAA,MACQC,KADR,GACkBF,UADlB,CACQE,KADR;AAAA,MAEQC,UAFR,GAE4CD,KAF5C,CAEQC,UAFR;AAAA,MAEoBC,SAFpB,GAE4CF,KAF5C,CAEoBE,SAFpB;AAAA,MAE+BC,QAF/B,GAE4CH,KAF5C,CAE+BG,QAF/B;AAGA,MAAI,CAACD,SAAD,IAAc,CAACD,UAAf,IAA6BC,SAAS,CAACE,UAA3C,EAAuD,OAAOL,IAAI,EAAX;;AAHvD,8BAKmBG,SAAS,CAACG,mBAAV,CAA8BF,QAA9B,CALnB;AAAA,MAKQG,MALR,yBAKQA,MALR;;AAMA,MAAMC,IAAI,GAAGN,UAAU,CAACM,IAAX,CAAgBC,KAAhB,CAAsB,CAAtB,EAAyBF,MAAM,CAACG,MAAhC,CAAb;AAEA,MAAMC,OAAO,GAAGH,IAAI,CAACI,KAAL,CAAWhB,cAAX,CAAhB;AAEA,MAAI,CAACe,OAAL,EAAc,OAAOX,IAAI,EAAX;AAVd,MAYOa,SAZP,GAY6CF,OAZ7C;AAAA,MAYkBG,GAZlB,GAY6CH,OAZ7C;AAAA,MAYuBI,EAZvB,GAY6CJ,OAZ7C;AAAA,MAY2BK,GAZ3B,GAY6CL,OAZ7C;AAAA,MAYgCM,EAZhC,GAY6CN,OAZ7C;AAAA,MAYoCO,KAZpC,GAY6CP,OAZ7C;AAcA,MAAIG,GAAG,IAAI,CAACE,GAAZ,EAAiB,OAAOhB,IAAI,EAAX;AAEjBF,EAAAA,KAAK,CAACqB,cAAN,GAhBA,CAiBA;;AACApB,EAAAA,UAAU,CACPqB,OADH,CACW9B,QAAQ,CAAC+B,kBADpB,EACwCR,SAAS,CAACS,MADlD,EAEGF,OAFH,CAEW9B,QAAQ,CAACiC,GAFpB,EAGGC,QAHH,CAGY,6BAHZ,EAG2C;AAAEC,IAAAA,MAAM,EAAE;AAAV,GAH3C,EAlBA,CAwBA;;AACA,MAAI,CAACX,GAAD,IAAQ,CAACE,GAAb,EAAkB;AAChB,WAAOrB,sBAAsB,CAACI,UAAD,CAAtB,CAAmCqB,OAAnC,CAA2C9B,QAAQ,CAACoC,qBAApD,CAAP;AACD,GA3BD,CA6BA;;;AACA,MAAMC,SAAS,GAAGnC,KAAK,CAACoC,MAAN,CAAa;AAC7BC,IAAAA,IAAI,EAAE,WADuB;AACVC,IAAAA,KAAK,EAAE,CACxBvC,IAAI,CAACqC,MAAL,EADwB,EAExBnC,MAAM,CAACmC,MAAP,CAAc;AACZC,MAAAA,IAAI,EAAE,OADM;AAEZE,MAAAA,IAAI,EAAE;AAAEf,QAAAA,GAAG,EAAEgB,SAAS,CAAChB,GAAD;AAAhB,OAFM;AAGZc,MAAAA,KAAK,EAAE,CAACvC,IAAI,CAACqC,MAAL,EAAD;AAHK,KAAd,CAFwB,EAOxBrC,IAAI,CAACqC,MAAL,EAPwB;AADG,GAAb,CAAlB;AAWA,MAAMK,QAAQ,GAAGvC,QAAQ,CAACkC,MAAT,CAAgB;AAAEE,IAAAA,KAAK,EAAE,CAACH,SAAD;AAAT,GAAhB,CAAjB;AAEA,SAAO5B,UAAU,CACdqB,OADI,CACI9B,QAAQ,CAAC4C,cADb,EAC6BD,QAD7B,CAAP;AAED","sourcesContent":["import { Controller, Commands, Text, Block, Inline, CangjieInputEvent, Document } from '@ali/4ever-cangjie';\nimport insertImagePlaceholder from '../commands/insertImagePlaceholder';\n\n// Image Markdown 规则\n// ![<ALT>](<URL><TITLE?>)\n// ALT: 非 [] 的字符，可以为空\n// URL: 由 \\w/:?#+.&%- 组成，不支持中文，可以为空，仅支持 http/https 协议\n// TITLE: 由空格 + \"string\" 组成，引号内侧不能为空白符，URL 存在时可以为空\n// eg.\n// 合法：\n//   ![]()\n//   ![](http://bar)\n//   ![](https://www.example.com/foo-1?bar=x#search)\n//   ![](https://www.example.com/foo-1?bar=x,y,z&zoo=a_b_c#search \"title 1\")\n//   ![foo](http://bar)\n//   ![<f o o>](http://bar)\n// 不合法：\n//   ![ab]]()\n//   ![](())\n//   ![](/uri)\n//   ![](file:///uri)\n//   ![](http://uri\"\")\n//   ![](\"abc\")\n//   ![](http://uri \" abc \")\n//   ![](</uri>)\nconst markdownRegExp = /!\\[([^\\[\\]]*)\\]\\(((https?:\\/\\/[\\w/:?#+.~=&%_,-]+)( \"(\\S\\s)?\\S+(\\s\\S)?\")?)?\\)$/;\n\nexport default function onSpace(\n  event: CangjieInputEvent,\n  controller: Controller,\n  next: Function,\n) {\n  const { value } = controller;\n  const { anchorText, selection, document } = value;\n  if (!selection || !anchorText || selection.isExpanded) return next();\n\n  const { anchor } = selection.convertToTextPoints(document);\n  const text = anchorText.text.slice(0, anchor.offset);\n\n  const matches = text.match(markdownRegExp);\n\n  if (!matches) return next();\n\n  const [matchText, alt, _s, src, _t, title] = matches;\n\n  if (alt && !src) return next();\n\n  event.preventDefault();\n  // 删除 markdown 文本\n  controller\n    .command(Commands.moveAnchorBackward, matchText.length)\n    .command(Commands.del)\n    .dispatch('createTriggerMarkdownAction', { mdType: 'image' });\n\n\n  // ![]() 时插入 placeholder\n  if (!alt && !src) {\n    return insertImagePlaceholder(controller).command(Commands.moveToStartOfNextText);\n  }\n\n  // 创建包含图片的 fragment，通过 insertFragment 进行转存插入\n  const paragraph = Block.create({\n    type: 'paragraph', nodes: [\n      Text.create(),\n      Inline.create({\n        type: 'image',\n        data: { src: encodeURI(src) },\n        nodes: [Text.create()],\n      }),\n      Text.create(),\n    ]\n  });\n  const fragment = Document.create({ nodes: [paragraph]});\n\n  return controller\n    .command(Commands.insertFragment, fragment);\n}\n"],"file":"onSpace.js"}