{"version":3,"sources":["../../../../src/__tests__/table/selectionbar.test.tsx"],"names":["valign","fill","splitCell","mergeCell","widthFit","tableButtons","defaultValue","Value","create","document","Document","nodes","table","bigMergedTable","toolbarLayout","toolButtons","name","showTargets","usePaletteIcon","hideConditions","App","props","val","controllerRef","value","setValue","React","useState","plugins","locale","handleChange","useCallback","change","body","describe","it","jest","fn","queryByTestId","content","controller","mock","calls","expect","toBe","command","Commands","moveToRangeOfDocument","fireEvent","mouseUp","fillButton","valignButton","description","action","cell","findDescendant","TableCell","isTableCell","moveToRangeOfNode","result","n","data","rowSpan","colSpan","tbSelection","key","startRowIndex","startColIndex","endRowIndex","endColIndex","forEach","testid","button","includes","length","mergeCellButton","disabled","parentElement","hasAttribute"],"mappings":"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","sourcesContent":["/** @jsx jsx */\nimport * as React from 'react';\nimport { last } from 'lodash-es';\nimport { fireEvent, jsx, renderEditor } from '@ali/4ever-dev-test';\nimport '@testing-library/jest-dom/extend-expect';\nimport {\n  Value,\n  Change,\n  Controller,\n  Commands,\n  Document\n} from '@ali/4ever-cangjie';\nimport { TableCell } from '@ali/4ever-mo';\nimport Provider from '../../provider';\nimport Content from '../../content';\nimport createBiPlugins from '../../createBiPlugins';\nimport { Trigger as SelectionBar } from '@ali/4ever-component';\nimport { bigMergedTable, createTableInstance, getTableFromController } from './helpers';\nimport locale from '../../locales/zh_CN';\nimport { ITableSelection, createEmptyParagraph } from '@ali/4ever-plugin-table';\n\nconst valign = 'SelectWrap-bi-toolbar-valign';\nconst fill = 'splitbutton-left-bi-toolbar-table-fill';\nconst splitCell = 'bi-toolbar-tablesimplesplit_wrap';\nconst mergeCell = 'bi-toolbar-tablesimplemerge_wrap';\nconst widthFit = 'table-width-fit-button';\n\nconst tableButtons = [\n  valign,\n  fill,\n  splitCell,\n  mergeCell,\n  widthFit,\n];\n\nconst defaultValue = Value.create({\n  document: Document.create({\n    nodes: [\n      createEmptyParagraph('A'),\n      createTableInstance({\n        table: bigMergedTable,\n      }),\n      createEmptyParagraph('B'),\n    ],\n  }),\n});\n\nconst toolbarLayout = [\n  {\n    toolButtons: [\n      {\n        name: 'table.fitWidth',\n      },\n      {\n        name: 'table.mergeSimple',\n      },\n      {\n        name: 'table.splitSimple',\n      },\n      {\n        name: 'table.fillFocus',\n      },\n      {\n        name: 'table.vAlign',\n        showTargets: ['table', 'columns'],\n      },\n    ],\n    showTargets: ['table'],\n  },\n  {\n    toolButtons: [\n      {\n        name: 'table.fillFocus',\n        usePaletteIcon: true,\n      },\n    ],\n    showTargets: ['columns'],\n  },\n  {\n    toolButtons: [\n      {\n        name: 'draggable.transform',\n      },\n    ],\n  },\n  {\n    toolButtons: [\n      {\n        name: 'list.ulist',\n      },\n      {\n        name: 'list.olist',\n      },\n    ],\n  },\n  {\n    toolButtons: [\n      {\n        name: 'sz.simple',\n      },\n      {\n        name: 'bold',\n      },\n      {\n        name: 'italic',\n      },\n      {\n        name: 'strike',\n      },\n      {\n        name: 'underline',\n      },\n      {\n        name: 'color.colorAndHighlight',\n      },\n      {\n        name: 'alignment',\n        hideConditions: ['hasListSelection'],\n      },\n    ],\n  },\n  {\n    toolButtons: [\n      {\n        name: 'list.tlist',\n        hideConditions: ['hasListSelection'],\n      },\n      {\n        name: 'comment',\n      },\n      {\n        name: 'table.delete',\n        showTargets: ['table'],\n      },\n      {\n        name: 'more',\n      },\n    ],\n  },\n];\n\nconst App: React.FC<{ val?: Value; controllerRef?: (controller: Controller) => void }> = (props) => {\n  const { val = defaultValue, controllerRef } = props;\n  const [value, setValue] = React.useState(val);\n  const plugins = createBiPlugins(locale);\n\n  const handleChange = React.useCallback((change: Change) => {\n    setValue(change.value);\n  }, []);\n\n  return (\n    <Provider\n      value={value}\n      plugins={plugins}\n      onChange={handleChange}\n      autoFocus\n      controllerRef={controllerRef}\n    >\n      <Content />\n      <SelectionBar\n        getScrollableContainer={() => document.body}\n        getScrollableContent={() => document.body}\n        toolbarLayout={toolbarLayout}\n      />\n    </Provider>\n  );\n};\n\ndescribe('bi/components/selectionBar', () => {\n  it('浮动工具栏显示、隐藏逻辑正常', async () => {\n    const controllerRef = jest.fn();\n    const { queryByTestId, content } = await renderEditor(<App controllerRef={controllerRef} />);\n    const controller = last(controllerRef.mock.calls)[0] as Controller;\n    expect(!!queryByTestId('selection-bar')).toBe(false);\n\n    controller.command(Commands.moveToRangeOfDocument);\n    fireEvent.mouseUp(content);\n    expect(!!queryByTestId('selection-bar')).toBe(true);\n\n    const fillButton = queryByTestId(fill);\n    const valignButton = queryByTestId(valign);\n    expect(!!fillButton).toBe(false);\n    expect(!!valignButton).toBe(false);\n  });\n\n  [\n    {\n      description: '选区在表格单元格内时，渲染填充、垂直对齐按钮',\n      action: (controller: Controller) => {\n        const cell = controller.value.document.findDescendant(TableCell.isTableCell);\n        controller.command(Commands.moveToRangeOfNode, cell);\n      },\n      result: [fill, valign],\n    },\n    {\n      description: '选区在合并单元格内时，渲染拆分、填充、垂直对齐按钮',\n      action: (controller: Controller) => {\n        const cell = controller.value.document.findDescendant(n => {\n          return TableCell.isTableCell(n) && (n.data?.rowSpan > 1 || n.data?.colSpan > 1);\n        });\n        controller.command(Commands.moveToRangeOfNode, cell);\n      },\n      result: [splitCell, fill, valign],\n    },\n    {\n      description: '选中多个单元格时，渲染拆分、填充、垂直对齐按钮',\n      action: (controller: Controller) => {\n        const table = getTableFromController(controller);\n        const tbSelection: ITableSelection = {\n          key: table.key,\n          startRowIndex: 0,\n          startColIndex: 0,\n          endRowIndex: 1,\n          endColIndex: 0,\n        };\n        controller.command('selectTableSelection', table, tbSelection);\n      },\n      result: [mergeCell, fill, valign],\n    },\n    {\n      description: '选中表格时，渲染宽度自适应、填充、垂直对齐按钮',\n      action: (controller: Controller) => {\n        const table = getTableFromController(controller);\n        controller.command('selectWholeTable', table);\n      },\n      result: [widthFit, fill, valign],\n    },\n  ].forEach(({ description, action, result }) => {\n    it(description, async () => {\n      const controllerRef = jest.fn();\n      const { queryByTestId, content } = await renderEditor(<App controllerRef={controllerRef} />);\n      const controller = last(controllerRef.mock.calls)[0] as Controller;\n      action(controller);\n      fireEvent.mouseUp(content);\n      expect(!!queryByTestId('selection-bar')).toBe(true);\n      result.forEach((testid) => {\n        const button = queryByTestId(testid);\n        expect(!!button).toBe(true);\n      });\n      // 预期外的 button 不显示\n      tableButtons.forEach(testid => {\n        if (!result.includes(testid)) {\n          const button = queryByTestId(testid);\n          expect(!!button).toBe(false);\n        }\n      });\n    });\n  });\n\n  it('选中合并单元格一部分时，合并/拆分单元格 button disabled', async () => {\n    const controllerRef = jest.fn();\n    const { queryByTestId, content } = await renderEditor(<App controllerRef={controllerRef} />);\n    const controller = last(controllerRef.mock.calls)[0] as Controller;\n\n    const table = getTableFromController(controller);\n    const tbSelection: ITableSelection = {\n      key: table.key,\n      startRowIndex: 2,\n      startColIndex: 0,\n      endRowIndex: 2,\n      endColIndex: table.nodes[0].nodes.length - 1,\n    };\n    controller.command('selectTableSelection', table, tbSelection, false);\n\n    fireEvent.mouseUp(content);\n    expect(!!queryByTestId('selection-bar')).toBe(true);\n\n    const mergeCellButton = queryByTestId(mergeCell);\n    const disabled = mergeCellButton?.parentElement?.hasAttribute('disabled');\n    expect(disabled).toBe(true);\n  });\n});\n"],"file":"selectionbar.test.js"}