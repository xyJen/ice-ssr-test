{"version":3,"sources":["../../../../src/__tests__/image/behaviour.test.tsx"],"names":["imageConfig","uploadImage","file","id","notifyProgress","Promise","resolve","url","name","plugins","image","array","waitForUpload","setTimeout","describe","_Image","global","Image","_URL","URL","beforeEach","onload","_src","src","beforeAll","createObjectURL","afterAll","it","time","parseInt","value","Mo","textToValue","controller","Controller","create","files","File","newController","images","document","filterDescendants","ImageMoPlugin","isImage","expect","length","toBe","i","data","extraData","mediaId","width","height","JSON","stringify","fn","jest","uploadFailed","reject","toBeCalledTimes","table","tableSelection","startColIndex","startRowIndex","endColIndex","endRowIndex","tableRows","findDescendant","n","type","nodes"],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\n/* eslint-disable import/no-extraneous-dependencies */\n/** @jsx jsx */\nimport { Inline, Controller } from '@ali/4ever-cangjie';\nimport '@testing-library/jest-dom/extend-expect';\n\nimport { Image as ImageMoPlugin, TableRow } from '@ali/4ever-mo';\nimport { createBiPlugins } from '../..';\nimport Mo from '../serializer';\nimport onInsertImage from '../../plugins/image/handlers/onInsertImage';\nimport { createEditor } from '../table/helpers';\n\nconst imageConfig = {\n  uploadImage: (file: File, id: string, notifyProgress: (percent) => void) => {\n    notifyProgress(99);\n    return Promise.resolve({\n      url: file.name,\n    });\n  },\n};\n\nconst plugins = createBiPlugins({\n  image: imageConfig,\n}).array;\n\nasync function waitForUpload() {\n  await new Promise((resolve) => {\n    setTimeout(() => {\n      resolve();\n    }, 100);\n  });\n}\n\n\ndescribe('Bi/image/behaviour', () => {\n  const _Image = global.Image;\n  const _URL = global.URL;\n\n  beforeEach(() => {\n    global.Image = class {\n      onload;\n      private _src;\n      set src(url: string) {\n        this._src = url;\n        this?.onload();\n      }\n      get src() {\n        return this._src;\n      }\n    };\n  });\n\n  beforeAll(() => {\n    global.URL = class {\n      static createObjectURL(file: File) {\n        return file.name;\n      }\n    };\n  });\n\n  afterAll(() => {\n    global.URL = _URL;\n    global.Image = _Image;\n  });\n\n  it('顺序上传', async () => {\n    global.Image = class {\n      onload;\n      private _src;\n      set src(url: string) {\n        const time = (3 - parseInt(url)) * 10;\n        this._src = url;\n        setTimeout(() => {\n          this?.onload();\n        }, time);\n      }\n      get src() {\n        return this._src;\n      }\n    };\n    const value = Mo.textToValue('');\n    const controller = Controller.create({\n      value,\n      plugins,\n    });\n    const files = [\n      new File([], '0.png'),\n      new File([], '1.png'),\n      new File([], '2.png'),\n    ];\n    const newController = onInsertImage(controller, files, imageConfig, {});\n    // wait reader image\n    await new Promise((resolve) => {\n      setTimeout(() => {\n        resolve();\n      }, 0);\n    });\n    // wait load image\n    await new Promise((resolve) => {\n      setTimeout(() => {\n        resolve();\n      }, 100);\n    });\n    // wait upload\n    await new Promise((resolve) => {\n      setTimeout(() => {\n        resolve();\n      }, 0);\n    });\n    const images = newController.value.document.filterDescendants(ImageMoPlugin.isImage) as Inline[];\n    expect(images.length).toBe(3);\n    for (let i = 0; i < files.length; i++) {\n      expect(images[i].data.name).toBe(`${i}.png`);\n    }\n  });\n  it('customSize & extraData', async () => {\n    const extraData = {\n      mediaId: 1,\n    };\n    const imageConfig = {\n      uploadImage: (file: File, id: string, notifyProgress: (percent) => void) => {\n        notifyProgress(99);\n        return Promise.resolve({\n          url: file.name,\n          width: 100,\n          height: 100,\n          extraData,\n        });\n      },\n    };\n    const value = Mo.textToValue('');\n    const controller = Controller.create({\n      value,\n      plugins,\n    });\n    const newController = onInsertImage(controller, new File([], 'test.png'), imageConfig, {});\n    await waitForUpload();\n    const images = newController.value.document.filterDescendants(ImageMoPlugin.isImage) as Inline[];\n    expect(images.length).toBe(1);\n    expect(images[0].data.width).toBe(100);\n    expect(images[0].data.height).toBe(100);\n    expect(JSON.stringify(images[0].data.extraData)).toBe(JSON.stringify(extraData));\n  });\n  it('上传失败', async () => {\n    const file = new File([], '0.png');\n    const fn = jest.fn();\n    const uploadFailed = () => {\n      fn();\n      return Promise.reject();\n    };\n    const value = Mo.textToValue('');\n    const controller = Controller.create({\n      value,\n      plugins,\n    });\n    const newController = onInsertImage(controller, file, {\n      uploadImage: uploadFailed,\n    }, {});\n    await waitForUpload();\n    const images = newController.value.document.filterDescendants(ImageMoPlugin.isImage) as Inline[];\n    expect(images.length).toBe(0);\n    expect(fn).toBeCalledTimes(1);\n  });\n\n  it('在有表格选区时粘贴图片', async () => {\n    const imageConfig = {\n      uploadImage: (file: File, id: string, notifyProgress: (percent) => void) => {\n        notifyProgress(99);\n        return Promise.resolve({\n          url: file.name,\n          width: 100,\n          height: 100,\n        });\n      },\n    };\n    const { controller } = await createEditor({\n      table: [['A', 'B'], ['C', 'D']],\n      tableSelection: {\n        startColIndex: 0,\n        startRowIndex: 0,\n        endColIndex: 1,\n        endRowIndex: 0,\n      }\n    });\n\n    onInsertImage(controller, new File([], 'test.png'), imageConfig, {});\n    await waitForUpload();\n    await waitForUpload();\n    const { document } = controller.value;\n    const images = document.filterDescendants(ImageMoPlugin.isImage) as Inline[];\n    expect(images.length).toBe(1);\n    const tableRows = document.findDescendant(n => n.type === 'table-row');\n    expect(tableRows?.nodes.length).toBe(2);\n  });\n});\n"],"file":"behaviour.test.js"}