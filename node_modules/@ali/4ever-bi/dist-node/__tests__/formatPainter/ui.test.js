"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _react = require("@testing-library/react");

var _everDevTest = require("@ali/4ever-dev-test");

var _everCangjie = require("@ali/4ever-cangjie");

var _editor = _interopRequireDefault(require("../editor"));

/* eslint-disable import/no-extraneous-dependencies */

/** @jsx jsx */
const marks = [{
  type: 'color',
  data: {
    value: 'red'
  }
}];
const paragraphData = {
  jc: 'right'
};
const defaultValue = (0, _everDevTest.jsx)("value", null, (0, _everDevTest.jsx)("document", null, (0, _everDevTest.jsx)("block", {
  type: "paragraph",
  key: "paragraphA",
  data: paragraphData
}, (0, _everDevTest.jsx)("text", {
  key: "textA",
  marks: marks
}, "with ", (0, _everDevTest.jsx)("cursor", null), "marks")), (0, _everDevTest.jsx)("block", {
  type: "paragraph",
  key: "paragraphB"
}, (0, _everDevTest.jsx)("text", {
  key: "textB"
}, "without marks"))));

async function copyAndPasteFormat(controller, container, type, target, offset) {
  // 避免选中离屏渲染的 toolbar
  const offScreenToolbarItem = container.querySelector('[class*="OffScreen"] [data-testid="SelectWrap-bi-toolbar-heading"]');

  if (offScreenToolbarItem) {
    await (0, _react.waitForElementToBeRemoved)(offScreenToolbarItem);
  }

  const btn = container.querySelector('[data-testid="bi-toolbar-painter"]');

  _everDevTest.fireEvent[type](btn);

  await (0, _everDevTest.waitForTime)(100);
  const text = container.querySelector(`[data-cangjie-key="${target}"]`);

  _everDevTest.fireEvent.mouseDown(text);

  controller.command(_everCangjie.Commands.moveAnchorToKey, target, 0);
  controller.command(_everCangjie.Commands.moveFocusToKey, target, offset || 0);

  _everDevTest.fireEvent.mouseUp(text);

  await (0, _everDevTest.waitForTime)(100);
  return text;
}

var _ref = (0, _everDevTest.jsx)("value", null, (0, _everDevTest.jsx)("document", null, (0, _everDevTest.jsx)("block", {
  type: "paragraph",
  key: "paragraphA",
  data: paragraphData
}, (0, _everDevTest.jsx)("text", {
  key: "textA"
}, "ppp", (0, _everDevTest.jsx)("cursor", null), "ppp")), (0, _everDevTest.jsx)("block", {
  type: "heading-1",
  key: "paragraphB"
}, (0, _everDevTest.jsx)("text", {
  key: "textB"
}, "withoutmarks"))));

var _ref2 = (0, _everDevTest.jsx)("value", null, (0, _everDevTest.jsx)("document", null, (0, _everDevTest.jsx)("block", {
  type: "heading-1",
  key: "paragraphA",
  data: paragraphData
}, (0, _everDevTest.jsx)("text", {
  key: "textA"
}, "ppp", (0, _everDevTest.jsx)("cursor", null), "ppp")), (0, _everDevTest.jsx)("block", {
  type: "paragraph",
  key: "paragraphB"
}, (0, _everDevTest.jsx)("text", {
  key: "textB"
}, "withoutmarks"))));

describe.skip('Bi/formatPainter/ui', () => {
  afterEach(() => {
    (0, _react.cleanup)();
  });
  test('单击只能使用一次', async () => {
    let controller;
    const {
      container
    } = await (0, _everDevTest.renderEditor)((0, _everDevTest.jsx)(_editor.default, {
      defaultValue: defaultValue,
      controllerRef: c => {
        controller = c;
      }
    }));
    const text = await copyAndPasteFormat(controller, container, 'click', 'textB');
    expect(text.querySelector('[data-cangjie-mark]').style.color).toBe('red');
    expect(container.querySelector('[data-cangjie-key="paragraphB"]').style.textAlign).toBe('right');
    expect(!!controller.value.data.formatClipboard).toBe(false);
  });
  test('双击格式可多次使用，按 esc 可取消', async () => {
    let controller;
    const {
      editor,
      container
    } = await (0, _everDevTest.renderEditor)((0, _everDevTest.jsx)(_editor.default, {
      defaultValue: defaultValue,
      controllerRef: c => {
        controller = c;
      }
    }));
    const text = await copyAndPasteFormat(controller, container, 'doubleClick', 'textB');
    expect(text.querySelector('[data-cangjie-mark]').style.color).toBe('red');
    expect(container.querySelector('[data-cangjie-key="paragraphB"]').style.textAlign).toBe('right');
    expect(!!controller.value.data.formatClipboard).toBe(true);

    _everDevTest.fireEvent.keyDown(editor, (0, _everDevTest.getHotkeyEvent)('esc'));

    await (0, _everDevTest.waitForTime)(100);
    expect(!!controller.value.data.formatClipboard).toBe(false);
  });
  test('快捷键粘贴和复制', async () => {
    let controller;
    const {
      editor,
      container
    } = await (0, _everDevTest.renderEditor)((0, _everDevTest.jsx)(_editor.default, {
      defaultValue: defaultValue,
      controllerRef: c => {
        controller = c;
      }
    }));

    _everDevTest.fireEvent.keyDown(editor, (0, _everDevTest.getHotkeyEvent)('c+ctrl+shift'));

    await (0, _everDevTest.waitForTime)(100);
    controller.command(_everCangjie.Commands.moveAnchorToKey, 'textB', 0);
    controller.command(_everCangjie.Commands.moveFocusToKey, 'textB', 0);

    _everDevTest.fireEvent.keyDown(editor, (0, _everDevTest.getHotkeyEvent)('v+ctrl+shift'));

    await (0, _everDevTest.waitForTime)(100);
    expect(container.querySelector('[data-cangjie-key="textB"] [data-cangjie-mark]').style.color).toBe('red');
    expect(container.querySelector('[data-cangjie-key="paragraphB"]').style.textAlign).toBe('right');
    expect(!!controller.value.data.formatClipboard).toBe(false);
  });
  test('从默认文本复制到标题', async () => {
    const value = _ref;
    let controller;
    const {
      editor,
      findByText
    } = await (0, _everDevTest.renderEditor)((0, _everDevTest.jsx)(_editor.default, {
      defaultValue: value,
      controllerRef: c => {
        controller = c;
      }
    }));

    _everDevTest.fireEvent.keyDown(editor, (0, _everDevTest.getHotkeyEvent)('c+ctrl+shift'));

    await (0, _everDevTest.waitForTime)(100);
    controller.command(_everCangjie.Commands.moveAnchorToKey, 'textB', 0);
    controller.command(_everCangjie.Commands.moveFocusToKey, 'textB', 7);

    _everDevTest.fireEvent.keyDown(editor, (0, _everDevTest.getHotkeyEvent)('v+ctrl+shift'));

    const partA = await findByText('without');
    const partB = await findByText('marks');
    expect(partA.parentElement.style.fontSize).toBe('11pt');
    expect(partA.parentElement.style.fontWeight).toBe('normal');
    expect(partB.parentElement.style.fontSize).toBe('');
  });
  test('从默认标题复制到文本', async () => {
    const value = _ref2;
    let controller;
    const {
      editor,
      findByText
    } = await (0, _everDevTest.renderEditor)((0, _everDevTest.jsx)(_editor.default, {
      defaultValue: value,
      controllerRef: c => {
        controller = c;
      }
    }));

    _everDevTest.fireEvent.keyDown(editor, (0, _everDevTest.getHotkeyEvent)('c+ctrl+shift'));

    await (0, _everDevTest.waitForTime)(100);
    controller.command(_everCangjie.Commands.moveAnchorToKey, 'textB', 0);
    controller.command(_everCangjie.Commands.moveFocusToKey, 'textB', 7);

    _everDevTest.fireEvent.keyDown(editor, (0, _everDevTest.getHotkeyEvent)('v+ctrl+shift'));

    const partA = await findByText('without');
    const partB = await findByText('marks');
    expect(partA.parentElement.style.fontSize).toBe('20pt');
    expect(partA.parentElement.style.fontWeight).toBe('bold');
    expect(partB.parentElement.style.fontSize).toBe('');
  });
});
//# sourceMappingURL=ui.test.js.map