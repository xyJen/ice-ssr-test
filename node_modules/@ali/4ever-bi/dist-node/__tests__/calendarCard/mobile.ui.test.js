"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var React = _interopRequireWildcard(require("react"));

var _ = require("../..");

var _react2 = require("@testing-library/react");

require("@testing-library/jest-dom/extend-expect");

var _provider = _interopRequireDefault(require("../../provider"));

var _content = _interopRequireDefault(require("../../content"));

var _everDevTest = require("@ali/4ever-dev-test");

/* eslint-disable import/no-extraneous-dependencies */

/** @jsx jsx */
const createBiPlugins = (0, _.createCustomizedBiPlugins)({ ..._.plugins,
  MobileCalendarCardPlugin: _.MobileCalendarCardPlugin
});

var _ref = (0, _everDevTest.jsx)(_content.default, null);

const Editor = props => {
  const {
    defaultValue,
    calendarConfig
  } = props;
  const [value, setValue] = React.useState(defaultValue);
  const plugins = React.useMemo(() => {
    return createBiPlugins({
      calendarCard: calendarConfig
    });
  }, [calendarConfig]);
  const handleChange = React.useCallback(changed => {
    setValue(changed.value);
  }, []);
  return (0, _everDevTest.jsx)(_provider.default, {
    value: value,
    onChange: handleChange,
    plugins: plugins,
    autoFocus: true
  }, _ref);
};

const calendarData = {
  calendarId: '18700362',
  comment: '超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注超长备注',
  totalCount: 14,
  place: '10-3-3',
  startTime: 1598281200000,
  endTime: 1598284800000,
  timezone: 'Asia/Shanghai',
  time: '08月24日 23:00 - 08月25日 00:00',
  subject: '超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题超长标题',
  organizer: [{
    uid: 3452016
  }],
  topReceivers: [{
    name: '陌',
    type: 1,
    uid: 3146067
  }, {
    uid: 3452016,
    name: '童岭',
    avatarMediaId: 'https://static.dingtalk.com/media/lADPBbCc1h2tUUPNA8DNA74_958_960.jpg_60x60q90.jpg',
    type: 1
  }, {
    name: '董旭',
    type: 1,
    uid: 3166262
  }, {
    name: '张卫刚卫刚卫刚卫刚卫刚卫刚卫刚卫刚卫刚卫刚卫刚卫刚卫刚卫刚卫刚卫刚卫刚',
    type: 1,
    uid: 3452113
  }, {
    name: '1598',
    type: 1,
    uid: 3452114
  }, {
    name: '170****2451',
    type: 1,
    uid: 3451114
  }, {
    name: 'Benjy',
    type: 1,
    uid: 2855028
  }, {
    name: '张卫刚',
    type: 1,
    uid: 3452184
  }, {
    name: '150****2598',
    type: 1,
    uid: 3452115
  }, {
    name: '董旭',
    type: 1,
    uid: 3166266
  }, {
    name: '170****2451',
    type: 1,
    uid: 3451117
  }, {
    name: 'Benjy',
    type: 1,
    uid: 2855039
  }, {
    name: '150****2598',
    type: 1,
    uid: 3452414
  }, {
    name: 'Benjy',
    type: 1,
    uid: 2855028
  }, {
    name: '张卫刚',
    type: 1,
    uid: 3452184
  }, {
    name: '150****2598',
    type: 1,
    uid: 3452115
  }, {
    name: '董旭',
    type: 1,
    uid: 3166266
  }, {
    name: '170****2451',
    type: 1,
    uid: 3451117
  }, {
    name: 'Benjy',
    type: 1,
    uid: 2855039
  }, {
    name: '150****2598',
    type: 1,
    uid: 3452414
  }, {
    name: '董旭',
    type: 1,
    uid: 3166562
  }],
  redirectUrl: 'dingtalk://dingtalkclient/action/open_mini_app?miniAppId=2018112162280005&ddMode=push&mainTask=true&keepAlive=false&newCalendar=1&page=pages%2Fdetail%2Findex%3FuniqueId%3DM2JMK2NUUlYzODVTdEpmeXFLYThhZz09&fallback_url=dingtalk%3A%2F%2Fdingtalkclient%2Fpage%2Fcalendar_detail%3Fid%3D0%26uniqueId%3DM2JMK2NUUlYzODVTdEpmeXFLYThhZz09',
  attachments: [{
    type: 7,
    fileName: '市政府工作会议纪要.docx'
  }, {
    type: 1,
    fileName: '市政府工作会议纪要2.docx'
  }, {
    type: 2,
    fileName: '市政府工作会议纪要3.docx'
  }, {
    type: 3,
    fileName: '市政府工作会议纪要4.docx'
  }]
};

const createCalendarConfig = config => {
  return {
    locale: {
      refresh: '刷新',
      refreshTips: '日程卡片有更新',
      receiverCount: '等{count}人参会',
      viewCalendardetails: '查看日程详情',
      noresponse: '未响应',
      received: '已接收',
      refused: '已拒绝',
      pending: '待定',
      organizer: '组织人'
    },
    getContainerWidthInPC: () => {
      return 440;
    },
    jumpToCalendar: (link, eventType) => {},
    openProfile: uid => {},
    jumpToAttachment: (url, eventType) => {},
    onRefreshSuccess: () => {},
    refresh: (calendarId, eventType) => {
      return new Promise(resolve => {
        setTimeout(() => {
          resolve({
            status: 'success',
            data: calendarData
          });
        }, 10);
      });
    },
    ...config
  };
};

describe('bi/calendarCard/mobile/ui', () => {
  beforeAll(() => {
    // 防止被 componentDidCatch catch 的 error 被控制台输出
    jest.spyOn(console, 'error'); // @ts-ignore

    console.error.mockImplementation(() => {});
  });
  afterAll(() => {
    // @ts-ignore
    console.error.mockRestore();
  });
  afterEach(() => {
    (0, _react2.cleanup)();
  });
  describe('bi/calendarCard/mobile/ui', () => {
    test('正常渲染', async () => {
      const value = (0, _everDevTest.jsx)("value", null, (0, _everDevTest.jsx)("document", null, (0, _everDevTest.jsx)("block", {
        type: "card",
        data: {
          cardType: 'calendar',
          height: 350,
          metadata: calendarData
        }
      })));
      const {
        queryByTestId,
        queryAllByTestId
      } = await (0, _everDevTest.renderEditor)((0, _everDevTest.jsx)(Editor, {
        defaultValue: value,
        calendarConfig: createCalendarConfig({})
      }));
      const subject = queryByTestId('calendar-subject').textContent;
      expect(subject).toBe(calendarData.subject);
      const receiverName = queryAllByTestId('calendar-receiver')[0].textContent;
      expect(receiverName.includes(calendarData.topReceivers[0].name)).toBe(true);
    });
    test('点击交互', async () => {
      const value = (0, _everDevTest.jsx)("value", null, (0, _everDevTest.jsx)("document", null, (0, _everDevTest.jsx)("block", {
        type: "card",
        data: {
          cardType: 'calendar',
          height: 350,
          metadata: calendarData
        }
      })));
      const handleState = {};
      const {
        queryByTestId,
        queryAllByTestId,
        findByTestId
      } = await (0, _everDevTest.renderEditor)((0, _everDevTest.jsx)(Editor, {
        defaultValue: value,
        calendarConfig: createCalendarConfig({
          getContainerWidthInPC: () => {
            return 640;
          },
          jumpToCalendar: (link, eventType) => {
            handleState.jumpToCalendar = {
              link,
              eventType
            };
          },
          openProfile: uid => {
            handleState.openProfile = uid;
          },
          onRefreshSuccess: () => {
            handleState.onRefreshSuccess = true;
          },
          refresh: (calendarId, eventType) => {
            handleState.refresh = {
              calendarId,
              eventType
            };
            return new Promise(resolve => {
              setTimeout(() => {
                resolve({
                  status: 'success',
                  data: calendarData
                });
              }, 10);
            });
          }
        })
      })); // 首次打开自动刷新数据

      expect(handleState.refresh.calendarId).toBe(calendarData.calendarId);
      expect(!handleState.refresh.eventType).toBe(true); // 点击标题

      const subject = queryByTestId('calendar-subject');

      _everDevTest.fireEvent.mouseDown(subject);

      expect(handleState.jumpToCalendar.link).toBe(calendarData.redirectUrl);
      expect(handleState.jumpToCalendar.eventType).toBe('title'); // 点击刷新
      // const refreshIcon = await findByTestId('Icon_refresh');
      // fireEvent.mouseDown(refreshIcon);
      // expect(handleState.refresh.eventType).toBe('click');
      // 点击应邀人

      const receiver = queryAllByTestId('calendar-receiver')[0];

      _everDevTest.fireEvent.mouseDown(receiver);

      expect(handleState.openProfile).toBe(calendarData.topReceivers[0].uid);
    });
  });
});
//# sourceMappingURL=mobile.ui.test.js.map