{"version":3,"sources":["../../../../src/__tests__/draggable/dragBlocks.ui.test.tsx"],"names":["defaultValue","App","props","val","value","setValue","React","useState","createBiPlugins","draggable","ImTagPlugin","leftToolbar","handleChange","change","enabled","menu","key","renderApp","results","container","document","body","paragraphs","querySelectorAll","describe","afterEach","jest","clearAllMocks","test","findByTestId","fireEvent","mouseMove","dragHander","mouseEnter","expect","DRAG_HIGHLIGHT_CLASSNAME","length","toBe","mouseLeave","mockFn","setData","fn","event","dragStart","dataTransfer","toHaveBeenNthCalledWith","getData","drop","type","innerText"],"mappings":"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","sourcesContent":["/** @jsx jsx */\nimport * as React from 'react';\nimport { fireEvent, jsx, renderEditor } from '@ali/4ever-dev-test';\nimport { cleanup, waitFor, fireEvent as event, act } from '@testing-library/react';\nimport {\n  Value,\n  Change,\n} from '@ali/4ever-cangjie';\nimport '@testing-library/jest-dom/extend-expect';\n\nimport Provider from '../../provider';\nimport Content from '../../content';\nimport draggable from '../../plugins/draggable';\nimport leftToolbar from '../../plugins/leftToolbar';\nimport ImTagPlugin from '../../plugins/imTag';\nimport { DRAG_HIGHLIGHT_CLASSNAME } from '@ali/4ever-plugin-draggable';\nimport createCustomizedBiPlugins from '../../createCustomizedBiPlugins';\n\nconst defaultValue = ((\n  <value>\n    <document>\n      <block type=\"paragraph\">\n        <anchor />AAA\n      </block>\n      <block type=\"paragraph\">\n        BBB<focus />\n      </block>\n    </document>\n  </value>\n) as unknown) as Value;\n\n\ninterface AppProps {\n  val?: Value;\n}\n\nconst App: React.FC<AppProps> = (props) => {\n  const { val = defaultValue } = props;\n  const [value, setValue] = React.useState(val);\n  const createBiPlugins = createCustomizedBiPlugins({\n    draggable,\n    ImTagPlugin,\n    leftToolbar,\n  });\n\n  const handleChange = (change: Change) => {\n    act(() => {\n      setValue(change.value);\n    });\n  };\n\n  return (\n    <Provider\n      value={value}\n      plugins={createBiPlugins({\n        draggable: {\n          enabled: true,\n        },\n        leftToolbar: {\n          menu: [\n            {\n              key: 'draggable',\n            },\n          ],\n        },\n      })}\n      onChange={handleChange}\n      autoFocus\n    >\n      <Content />\n    </Provider>\n  );\n};\n\nasync function renderApp(val?: Value) {\n  const results = await renderEditor(<App val={val} />, {\n    container: document.body,\n  });\n  const { container } = results;\n  const paragraphs = container.querySelectorAll('[data-type=\"paragraph\"]');\n  return { ...results, paragraphs };\n}\n\ndescribe('Bi/draggable/ui', () => {\n  afterEach(() => {\n    cleanup();\n    jest.clearAllMocks();\n  });\n\n  test('show highlight', async () => {\n    const { findByTestId, paragraphs, container } = await renderApp();\n    fireEvent.mouseMove(paragraphs[0]);\n    const dragHander = await waitFor(() => findByTestId('drag-hander'));\n    fireEvent.mouseEnter(dragHander);\n\n    await waitFor(() => {\n      expect(container.querySelectorAll(`.${DRAG_HIGHLIGHT_CLASSNAME}`).length).toBe(2);\n    });\n\n    fireEvent.mouseLeave(dragHander);\n\n    await waitFor(() => {\n      expect(container.querySelectorAll(`.${DRAG_HIGHLIGHT_CLASSNAME}`).length).toBe(0);\n    });\n  });\n\n  test('dragStart dataTransfer.setData toBeCalled', async () => {\n    const { findByTestId, paragraphs } = await renderApp();\n    fireEvent.mouseMove(paragraphs[0]);\n    const dragHander = await findByTestId('drag-hander');\n\n    const mockFn = { setData: jest.fn() };\n    event.dragStart(dragHander, { dataTransfer: mockFn });\n    expect(mockFn.setData).toHaveBeenNthCalledWith(1, 'application/x-cangjie-drag-fragment', '{\"type\":0,\"fragment\":[{\"key\":\"2\",\"type\":\"paragraph\",\"nodeJson\":{\"klass\":\"block\",\"type\":\"paragraph\",\"data\":{},\"nodes\":[{\"klass\":\"text\",\"leaves\":[{\"klass\":\"leaf\",\"text\":\"AAA\",\"marks\":[]}]}]},\"parentKey\":\"5\"},{\"key\":\"4\",\"type\":\"paragraph\",\"nodeJson\":{\"klass\":\"block\",\"type\":\"paragraph\",\"data\":{},\"nodes\":[{\"klass\":\"text\",\"leaves\":[{\"klass\":\"leaf\",\"text\":\"BBB\",\"marks\":[]}]}]},\"parentKey\":\"5\"}]}');\n    expect(mockFn.setData).toHaveBeenNthCalledWith(2, 'text/plain', 'AAABBB');\n    expect(mockFn.setData).toHaveBeenNthCalledWith(3, 'text/html', '<p style=\\\"text-align:left;text-indent:0;margin-left:0;margin-top:0;margin-bottom:0\\\"><span data-type=\\\"text\\\">AAA</span></p><p style=\\\"text-align:left;text-indent:0;margin-left:0;margin-top:0;margin-bottom:0\\\"><span data-type=\\\"text\\\">BBB</span></p>');\n  });\n\n  test('drop dataTransfer.getData toBeCalled', async () => {\n    const value = ((\n      <value>\n        <document>\n          <block type=\"paragraph\">\n            AAA<cursor />\n          </block>\n        </document>\n      </value>\n    ) as unknown) as Value;\n\n    const { paragraphs } = await renderApp(value);\n    const mockFn = { getData: jest.fn() };\n    event.drop(paragraphs[0], { dataTransfer: mockFn });\n    expect(mockFn.getData).toHaveBeenNthCalledWith(1, 'application/x-cangjie-drag-fragment');\n    expect(mockFn.getData).toHaveBeenNthCalledWith(2, 'text/html');\n    expect(mockFn.getData).toHaveBeenNthCalledWith(3, 'text/plain');\n  });\n\n  test('drop text', async () => {\n    const value = ((\n      <value>\n        <document>\n          <block type=\"paragraph\">\n            AAA<cursor />\n          </block>\n        </document>\n      </value>\n    ) as unknown) as Value;\n\n    const { paragraphs, container } = await renderApp(value);\n    const mockFn = { getData: (type) => {\n      if (type === 'text/plain') {\n        return 'text';\n      }\n    } };\n    event.drop(paragraphs[0], { dataTransfer: mockFn });\n\n    expect(container.innerText === 'AAAtext');\n  });\n\n  test('drop blockJson', async () => {\n    const value = ((\n      <value>\n        <document>\n          <block type=\"paragraph\">\n            AAA<cursor />\n          </block>\n        </document>\n      </value>\n    ) as unknown) as Value;\n\n    const { paragraphs, container } = await renderApp(value);\n    const mockFn = { getData: (type) => {\n      if (type === 'application/x-cangjie-drag-fragment') {\n        return '{\"type\":0,\"fragment\":[{\"key\":\"3\",\"type\":\"paragraph\",\"nodeJson\":{\"klass\":\"block\",\"type\":\"paragraph\",\"data\":{},\"nodes\":[{\"klass\":\"text\",\"leaves\":[{\"klass\":\"leaf\",\"text\":\"BBB\",\"marks\":[]}]}]}}]}';\n      }\n    } };\n    event.drop(paragraphs[0], { dataTransfer: mockFn });\n\n    expect(container.innerText === 'AAABBB');\n  });\n\n  test('drop html', async () => {\n    const value = ((\n      <value>\n        <document>\n          <block type=\"paragraph\">\n            AAA<cursor />\n          </block>\n        </document>\n      </value>\n    ) as unknown) as Value;\n\n    const { paragraphs, container } = await renderApp(value);\n    const mockFn = { getData: (type) => {\n      if (type === 'text/html') {\n        return '<p style=\\\"text-align:left;text-indent:0;margin-left:0\\\"><span>BBB</span></p>';\n      }\n    } };\n    event.drop(paragraphs[0], { dataTransfer: mockFn });\n    expect(container.innerText === 'AAABBB');\n  });\n});\n"],"file":"dragBlocks.ui.test.js"}