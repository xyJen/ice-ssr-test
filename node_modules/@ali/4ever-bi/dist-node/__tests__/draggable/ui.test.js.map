{"version":3,"sources":["../../../../src/__tests__/draggable/ui.test.tsx"],"names":["defaultValue","App","props","val","value","setValue","React","useState","createBiPlugins","draggable","ImTagPlugin","HeadingPlugin","leftToolbar","handleChange","change","enabled","menu","key","renderApp","results","container","document","body","paragraph","querySelector","fireEvent","mouseMove","describe","afterEach","jest","clearAllMocks","test","findByTestId","queryByTestId","expect","not","toBeInTheDocument","editor","keyDown","querySelectorAll","DRAG_HIGHLIGHT_CLASSNAME","length","toBe","it","skip","src","LEGAL_EVENT","leftToolbarEnable","enable","colsWidth","p","dragHander"],"mappings":"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","sourcesContent":["/** @jsx jsx */\nimport * as React from 'react';\nimport {\n  fireEvent,\n  jsx,\n  renderEditor,\n  getHotkeyEvent,\n  waitForTime,\n} from '@ali/4ever-dev-test';\nimport { cleanup, waitFor, waitForElementToBeRemoved, act } from '@testing-library/react';\nimport {\n  Value,\n  Change,\n} from '@ali/4ever-cangjie';\nimport '@testing-library/jest-dom/extend-expect';\n\nimport Provider from '../../provider';\nimport Content from '../../content';\nimport draggable from '../../plugins/draggable';\nimport leftToolbar from '../../plugins/leftToolbar';\nimport ImTagPlugin from '../../plugins/imTag';\nimport HeadingPlugin from '../../plugins/heading';\nimport createCustomizedBiPlugins from '../../createCustomizedBiPlugins';\nimport { DRAG_HIGHLIGHT_CLASSNAME } from '@ali/4ever-plugin-draggable';\nimport { dispatchCustomEvent, LEGAL_EVENT } from '@ali/4ever-utils';\n\nconst defaultValue = ((\n  <value>\n    <document>\n      <block type=\"paragraph\">\n        Hello <cursor />\n        Cangjie\n      </block>\n    </document>\n  </value>\n) as unknown) as Value;\n\n\ninterface AppProps {\n  val?: Value;\n}\n\nconst App: React.FC<AppProps> = (props) => {\n  const { val = defaultValue } = props;\n  const [value, setValue] = React.useState(val);\n  const createBiPlugins = createCustomizedBiPlugins({\n    draggable,\n    ImTagPlugin,\n    HeadingPlugin,\n    leftToolbar,\n  });\n\n  const handleChange = (change: Change) => {\n    act(() => {\n      setValue(change.value);\n    });\n  };\n\n  return (\n    <Provider\n      value={value}\n      plugins={createBiPlugins({\n        draggable: {\n          enabled: true,\n        },\n        leftToolbar: {\n          menu: [\n            {\n              key: 'draggable',\n            },\n          ],\n        },\n      })}\n      onChange={handleChange}\n      autoFocus\n    >\n      <Content />\n    </Provider>\n  );\n};\n\nasync function renderApp(val?: Value) {\n  const results = await renderEditor(<div><App val={val} /><div id=\"hide\">hide drag</div></div>, {\n    container: document.body,\n  });\n  const { container } = results;\n  const paragraph = container.querySelector('[data-type=\"paragraph\"]');\n\n  fireEvent.mouseMove(paragraph);\n\n  return { ...results, paragraph };\n}\n\ndescribe('Bi/draggable/ui', () => {\n  afterEach(() => {\n    cleanup();\n    jest.clearAllMocks();\n  });\n\n  test('show and hide dragHander', async () => {\n    const { findByTestId, queryByTestId, container } = await renderApp();\n    await findByTestId('drag-hander');\n    fireEvent.mouseMove(container.querySelector('#hide'));\n    await waitForTime(50);\n    expect(queryByTestId('drag-hander')).not.toBeInTheDocument();\n  });\n\n  test('not hide dragHander after input', async () => {\n    const value = ((\n      <value>\n        <document>\n          <block type=\"paragraph\">\n            AAA<cursor />\n          </block>\n        </document>\n      </value>\n    ) as unknown) as Value;\n\n    const { editor, container, queryByTestId, findByTestId } = await renderApp(value);\n\n    await findByTestId('drag-hander');\n\n    fireEvent.keyDown(editor, getHotkeyEvent('space'));\n    // 输入内容后不隐藏抓手\n    await waitFor(() => {\n      expect(queryByTestId('drag-hander')).toBeInTheDocument();\n    });\n    // 同时删除高亮\n    await waitFor(() => {\n      expect(container.querySelectorAll(`.${DRAG_HIGHLIGHT_CLASSNAME}`).length).toBe(0);\n    });\n  });\n\n  it('not hide dragHander after type change', async () => {\n    const value = ((\n      <value>\n        <document>\n          <block type=\"paragraph\">\n            #<cursor />AAA\n          </block>\n        </document>\n      </value>\n    ) as unknown) as Value;\n\n    const { editor, queryByTestId, findByTestId } = await renderApp(value);\n\n    await findByTestId('drag-hander');\n\n    fireEvent.keyDown(editor, getHotkeyEvent('space'));\n    // 变成标题后不隐藏抓手\n    await waitFor(() => {\n      expect(queryByTestId('drag-hander')).toBeInTheDocument();\n    });\n  });\n\n  it.skip('hide dragHander with one inline img', async () => {\n    const value = ((\n      <value>\n        <document>\n          <block type=\"paragraph\">\n            <inline\n              type=\"image\"\n              data={{\n                src: 'https://cn.bing.com/az/hprichbg/rb/TeslaCoil_EN-CN1604235004_1920x1080.jpg',\n              }}\n            /><cursor />\n          </block>\n        </document>\n      </value>\n    ) as unknown) as Value;\n\n    const { queryByTestId } = await renderApp(value);\n    await waitForTime(100);\n    expect(queryByTestId('drag-hander')).not.toBeInTheDocument();\n  });\n\n  it.skip('hide dragHander with empty paragraph', async () => {\n    const value = ((\n      <value>\n        <document>\n          <block type=\"paragraph\">\n            <cursor />\n          </block>\n        </document>\n      </value>\n    ) as unknown) as Value;\n    dispatchCustomEvent(LEGAL_EVENT.leftToolbarEnable, { enable: false });\n    const { queryByTestId } = await renderApp(value);\n    await waitForTime(100);\n    expect(queryByTestId('drag-hander')).not.toBeInTheDocument();\n  });\n\n  test('show dragHander next to table when mouseMove paragraph-in-table', async () => {\n    const value = ((\n      <value>\n        <document>\n          <block type=\"table\" key=\"table-key-1\" data={{ colsWidth: [100, 100] }}>\n            <block type=\"table-row\">\n              <block type=\"table-cell\">\n                <block type=\"paragraph\" />\n              </block>\n              <block type=\"table-cell\">\n                <block type=\"paragraph\" key=\"a\">A</block>\n              </block>\n            </block>\n          </block>\n        </document>\n      </value>\n    ) as unknown) as Value;\n\n    const { queryByTestId, container } = await renderApp(value);\n    const p = container.querySelector('[data-cangjie-key=\"a\"]');\n    fireEvent.mouseMove(p);\n    await waitForTime(100);\n    const dragHander = queryByTestId('drag-hander');\n    expect(dragHander).toBeInTheDocument();\n  });\n});\n"],"file":"ui.test.js"}