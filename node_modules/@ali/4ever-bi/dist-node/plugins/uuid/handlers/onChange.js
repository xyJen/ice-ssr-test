"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = createOnChange;

var _everCangjie = require("@ali/4ever-cangjie");

var _everUtils = require("@ali/4ever-utils");

function createOnChange(config = {}) {
  return function onChange(controller, next) {
    if (!config.generateLeafBlockId) {
      return next();
    }

    const tmp = {};
    const blocks = controller.operations.map(o => {
      return o.type === 'set_selection' ? undefined : o.path;
    }).filter(p => !!p).map(p => {
      const n = controller.value.document.getNodeByPath(p);

      if (n) {
        return _everCangjie.Block.isBlock(n) ? n : controller.value.document.getClosestBlock(n.key);
      }

      return null;
    }).reduce((prev, cur) => {
      if (cur && !tmp[cur.key]) {
        tmp[cur.key] = 1;
        prev.push(cur);
      }

      return prev;
    }, []).filter(node => !node.data.uuid);
    const uuidFn = config.generator || _everUtils.uniqueId;
    controller.withoutNormalizing(() => {
      // NOTE: 加上 withoutSaving 以避免 undo 时 `set_node` 把 redos stack 置空
      controller.withoutSaving(() => {
        blocks.forEach(node => {
          controller.command(_everCangjie.Commands.setNodeByKey, node.key, {
            type: node.type,
            data: { ...node.data,
              uuid: node.data.refblockUUID ? node.data.refblockUUID : uuidFn()
            }
          });
        });
      });
    });
    return next();
  };
}
//# sourceMappingURL=onChange.js.map