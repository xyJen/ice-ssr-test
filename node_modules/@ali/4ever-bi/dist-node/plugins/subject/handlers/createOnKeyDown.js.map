{"version":3,"sources":["../../../../../src/plugins/subject/handlers/createOnKeyDown.ts"],"names":["isDeleteBackward","event","hotkeys","isDeleteWordBackward","isDeleteLineBackward","isDeleteForward","isDeleteWordForward","isDeleteLineForward","isDelete","createOnKeyDown","onKeyDown","controller","next","document","startBlock","endBlock","selection","value","nativeEvent","end","getEnd","isAtStartOfNode","query","hasSubjectGroupBlocks","isSubjectSelected","preventDefault","command","selectSubject","key","isCollapsed","focus","getNextBlock","isAtEndOfNode","isEnter","fold","userData","get","toggleFold","Commands","splitBlock","clearSubjectStyle","SELECTED_SUBJECT_KEY","selectedKey","data","block","getNode","deleteSubject","unselectSubject","isTextPoint","offset","isSelectionCoverSubjectFromStart"],"mappings":"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","sourcesContent":["import { Plugin, hotkeys, Commands } from '@ali/4ever-cangjie';\nimport { clearSubjectStyle, deleteSubject, selectSubject, unselectSubject } from '../commands';\nimport { SELECTED_SUBJECT_KEY } from '../constants';\nimport { hasSubjectBeenSelected } from '../helpers';\nimport { hasSubjectGroupBlocks, isSelectionCoverSubjectFromStart, isSubjectSelected } from '../queries';\nimport { isEmptyNode, isSubjectHeading } from '../utils';\nimport { toggleFold } from '@ali/4ever-factory';\nimport type { Subject } from '../utils';\n\nfunction isDeleteBackward(event: KeyboardEvent) {\n  return hotkeys.isDeleteBackward(event) || hotkeys.isDeleteWordBackward(event) || hotkeys.isDeleteLineBackward(event);\n}\n\nfunction isDeleteForward(event: KeyboardEvent) {\n  return hotkeys.isDeleteForward(event) || hotkeys.isDeleteWordForward(event) || hotkeys.isDeleteLineForward(event);\n}\n\nfunction isDelete(event: KeyboardEvent) {\n  return isDeleteBackward(event) || isDeleteForward(event);\n}\n\nfunction createOnKeyDown(): Plugin['onKeyDown'] {\n  return function onKeyDown(event, controller, next) {\n    const { document, startBlock, endBlock, selection } = controller.value;\n\n    /**\n     * 限制 1：反向删除\n     * @description 若光标在议题开始处，且议题不为空，则不允许直接删除，选中议题块\n     */\n    if (isDeleteBackward(event.nativeEvent) && isSubjectHeading(endBlock)) {\n      const end = selection.getEnd(document);\n      if (\n        // 光标结束在议题的开头\n        end.isAtStartOfNode(endBlock) &&\n        // 标题不为空，或有内容\n        (!isEmptyNode(endBlock) || controller.query(hasSubjectGroupBlocks, endBlock)) &&\n        // 未选中\n        !controller.query(isSubjectSelected, endBlock as Subject)\n      ) {\n        event.preventDefault();\n        return controller.command(selectSubject, endBlock.key);\n      }\n    }\n\n    /**\n     * 限制 2：正向删除\n     */\n    if (isDeleteForward(event.nativeEvent) && selection.isCollapsed) {\n      const { focus } = selection;\n\n      // 光标在议题标题处，标题为空，但议题不为空时，不允许删除\n      if (\n        isSubjectHeading(endBlock) &&\n        isEmptyNode(endBlock) &&\n        focus.isAtStartOfNode(endBlock) &&\n        controller.query(hasSubjectGroupBlocks, endBlock) &&\n        !controller.query(isSubjectSelected, endBlock as Subject)\n      ) {\n        event.preventDefault();\n        return controller.command(selectSubject, endBlock.key);\n      }\n\n      // 光标在议题上方的节点末尾，不允许删除\n      if (\n        endBlock &&\n        isSubjectHeading(document.getNextBlock(endBlock.key)) &&\n        focus.isAtEndOfNode(endBlock)\n      ) {\n        event.preventDefault();\n        return;\n      }\n    }\n\n    /**\n     * 限制 3：议题标题无法被换行操作分裂\n     * @description 换行时清除议题的属性\n     */\n    if (\n      hotkeys.isEnter(event) && isSubjectHeading(startBlock)\n      // 在行内输入 + 号唤起工具栏时，Enter 事件会被工具栏消费\n      && !controller.query('isNewLineGuideDisplay')\n      // 在 Mention 唤起时，Enter 时间会被选人行为消费\n      && !controller.query('isSelectionInMentionSuggestion')) {\n      event.preventDefault();\n      // 若折叠则先展开\n      const fold = controller.userData.get(startBlock, 'fold');\n      if (fold) {\n        controller.command(toggleFold, startBlock, false);\n      }\n      return controller.command(Commands.splitBlock).command('clearStyle').command(clearSubjectStyle);\n    }\n\n    /**\n     * Effects: 选中状态删除，删除整个议题\n     */\n    if (isDelete(event.nativeEvent) && hasSubjectBeenSelected(controller)) {\n      const { [SELECTED_SUBJECT_KEY]: selectedKey } = controller.value.data;\n      const block = document.getNode(selectedKey);\n      if (isSubjectHeading(block)) {\n        return controller.command(deleteSubject, block as Subject).command(unselectSubject);\n      }\n    }\n\n    /**\n     * Effects: 议题完全包含在选区内，删除操作需要删除议题格式\n     */\n    if (isDelete(event.nativeEvent) && isSubjectHeading(startBlock)) {\n      const end = selection.getEnd(document);\n      if (\n        // 若 end 选区不为 hanging\n        // References: cangjie/src/commands/delete/deleteAtRange (84 Line/252 Line)\n        end.isTextPoint() && end.offset > 0 &&\n        // 议题完全包含在选区内\n        controller.query(isSelectionCoverSubjectFromStart, startBlock as Subject)\n      ) {\n        next();\n        // 删除议题块之后，光标此时会停留在议题标题处，这里需要清除议题格式\n        return controller.command('clearStyle');\n      }\n    }\n\n    return next();\n  };\n}\n\nexport default createOnKeyDown;\n"],"file":"createOnKeyDown.js"}