{"version":3,"sources":["../../../../../src/plugins/subject/components/topicToolbar.tsx"],"names":["ToolbarBox","styled","div","FinishedBox","FeedbackBox","Feedback","FeedbackTooltipBox","AtContainer","span","tooltipStyle","display","alignItems","padding","height","background","border","borderRadius","fontSize","NotifySuccessIcon","color","marginRight","NotifyFailedIcon","TopicToolbar","props","node","controller","config","displayFinishButton","subjectPr","data","finished","locale","onNotifyFinishTopic","creator","user","finishButtonAction","finishButtonDone","cancelFinishTopicTip","notifyFinishTip","notifyFinishSuccess","notifyFinishFailed","mentionTip","isSameUser","uid","finishState","setFinishState","React","useState","fresh","success","notified","handleMentionClick","useCallback","startBlock","value","key","command","Commands","moveToEndOfNode","dispatch","handleNotifyClick","title","text","then","catch","handleFinishClick","run","prevState","useEffect","undefined","timer","window","setTimeout","clearTimeout","feedbackTip","finishTip","nick","environment","IS_MOBILE","displayName"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport styled from 'styled-components';\nimport FinishButton from './finishButton';\nimport { Heading1Data } from '@ali/4ever-mo';\nimport { Block, Commands, Controller, environment } from '@ali/4ever-cangjie';\nimport { Tooltip } from '@ali/we-design';\nimport { CloseNormal, SelectedNormalNormal } from '@ali/we-icon';\nimport { toggleFinished } from '../actions';\nimport { SubjectConfig } from '../types';\nimport Feedback from './feedback';\n\nconst ToolbarBox = styled.div`\n  display: flex;\n  align-items: center;\n  height: 100%;\n`;\n\nconst FinishedBox = styled.div`\n  font-size: 12px;\n  position: relative;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  height: 26px;\n  cursor: pointer;\n  transition: all 0.4s;\n  margin-left: 2px;\n\n  :hover {\n    background: rgba(126, 134, 142, 0.12);\n    border-radius: 4px;\n  }\n`;\n\nconst FeedbackBox = styled(Feedback)`\n  position: absolute;\n  height: 30px;\n  top: -30px;\n  right: -12px;\n  border: 0.5px solid rgba(17, 31, 44, 0.08);\n  padding: 6px 8px;\n`;\n\nconst FeedbackTooltipBox = styled.div`\n`;\n\nconst AtContainer = styled.span`\n  color: rgba(0, 137, 255, 1);\n  font-weight: bold;\n`;\n\nconst tooltipStyle: React.CSSProperties = {\n  display: 'flex',\n  alignItems: 'center',\n  padding: '4px 8px',\n  height: 28,\n  background: 'rgba(30, 30, 30, 0.94)',\n  border: '1px solid rgba(126, 134, 142, 0.16)',\n  borderRadius: 4,\n  fontSize: 12,\n};\n\nconst NotifySuccessIcon = <SelectedNormalNormal style={{ color: '#00B042', marginRight: 3 }} />;\n\nconst NotifyFailedIcon = <CloseNormal style={{ color: '#ff5219', marginRight: 3 }} />;\n\nexport interface TopicToolbarProps {\n  node: Block<Heading1Data>;\n  controller: Controller;\n  config: SubjectConfig;\n  displayFinishButton: boolean;\n}\n\nconst TopicToolbar: React.FC<TopicToolbarProps> = (props) => {\n  const { node, controller, config, displayFinishButton } = props;\n  const { subjectPr = {} } = node.data;\n  const { finished = false } = subjectPr;\n  const { locale = {}, onNotifyFinishTopic, creator, user } = config;\n  const { finishButtonAction, finishButtonDone } = locale;\n  const {\n    cancelFinishTopicTip,\n    notifyFinishTip,\n    notifyFinishSuccess,\n    notifyFinishFailed,\n    mentionTip,\n  } = locale;\n  const isSameUser = creator?.uid === user?.uid;\n\n  const [finishState, setFinishState] = React.useState({\n    // 当前完成是否新鲜\n    fresh: false,\n    // 通知是否成功\n    success: false,\n    // 是否已经通知\n    notified: false,\n  });\n\n  const { fresh, notified, success } = finishState;\n\n  const handleMentionClick = React.useCallback(() => {\n    const { startBlock } = controller.value;\n    if (startBlock?.key !== node.key) {\n      controller.command(Commands.moveToEndOfNode, node);\n    }\n    controller.dispatch('activeMention');\n  }, [controller, node]);\n\n  /**\n   * 点击通知议题反馈\n   */\n  const handleNotifyClick = React.useCallback(() => {\n    if (typeof onNotifyFinishTopic === 'function') {\n      onNotifyFinishTopic({\n        node,\n        title: node.text,\n      }).then(() => {\n        setFinishState({\n          fresh: true,\n          notified: true,\n          success: true,\n        });\n      }).catch(() => {\n        setFinishState({\n          fresh: true,\n          notified: true,\n          success: false,\n        });\n      });\n    } else {\n      setFinishState({\n        fresh: false,\n        notified: false,\n        success: false,\n      });\n    }\n  }, [node, onNotifyFinishTopic]);\n\n  /**\n   * 点击完成议题填报\n   */\n  const handleFinishClick = React.useCallback(() => {\n    controller.run('onAction', toggleFinished({\n      node,\n      finished: !finished,\n    }));\n    if (!finished) {\n      setFinishState({\n        fresh: !isSameUser,\n        notified: false,\n        success: false,\n      });\n      if (!isSameUser) {\n        handleNotifyClick();\n      }\n    } else {\n      setFinishState((prevState) => {\n        return {\n          ...prevState,\n          fresh: !finished,\n        };\n      });\n    }\n  }, [controller, finished, isSameUser, node, handleNotifyClick]);\n\n  /**\n   * 议题完成时，弹出发送 Tip，展示 7s\n   */\n  React.useEffect(() => {\n    if (!fresh) {\n      return undefined;\n    }\n    const timer = window.setTimeout(() => {\n      setFinishState((prevState) => {\n        return {\n          ...prevState,\n          fresh: false,\n        };\n      });\n    }, 7000);\n\n    return () => {\n      window.clearTimeout(timer);\n    };\n  }, [fresh]);\n\n  const feedbackTip = (\n    <>\n      {success ? NotifySuccessIcon : NotifyFailedIcon}\n      {success ? notifyFinishSuccess : notifyFinishFailed}\n    </>\n  );\n  // 通知完成之前，即使 finish 也显示为未完成的 tooltip，避免文案突然闪变\n  const finishTip = (finished && (notified || isSameUser)) ? (\n    <FeedbackTooltipBox>\n      {cancelFinishTopicTip}\n    </FeedbackTooltipBox>\n  ) : (\n    <FeedbackTooltipBox>\n      {notifyFinishTip}\n      {creator?.nick ? <AtContainer>{` @${creator.nick} `}</AtContainer> : ''}\n    </FeedbackTooltipBox>\n  );\n\n  return (\n    <ToolbarBox>\n      {(!environment.IS_MOBILE && displayFinishButton) && (\n        <Tooltip disabled={fresh} title={finishTip} placement=\"top\" overlayStyle={tooltipStyle}>\n          <FinishedBox onClick={handleFinishClick}>\n            <FinishButton finished={finished} text={finished ? finishButtonDone : finishButtonAction} />\n          </FinishedBox>\n        </Tooltip>\n      )}\n      <FeedbackBox visible={fresh && notified}>{feedbackTip}</FeedbackBox>\n    </ToolbarBox>\n  );\n};\n\nTopicToolbar.displayName = 'TopicToolbar';\n\nexport default TopicToolbar;\n"],"file":"topicToolbar.js"}