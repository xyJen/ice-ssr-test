{"version":3,"sources":["../../../../../src/plugins/image/components/imageEditor.tsx"],"names":["IMAGE_BG_COLOR","ACCURACY","shouldUseNaturalRatio","data","rectClip","left","right","top","bottom","ImageEditor","React","Component","constructor","props","imageEditor","rotateControl","initialRectData","resizeObserver","mutationObserver","prevImgWidth","mutationFrameId","resizeFrameId","rate","naturalRate","scrollableAncestorsDOM","handleParentScroll","rectData","getRealImgRectData","setState","onResizeStart","relativeEvent","angle","mouse","x","relativeX","y","relativeY","resizing","onEnterResizingMode","onResizeMove","X","Y","state","scale","updateImageSize","onResizeEnd","onChangeSize","l","r","t","b","clientWidth","clientHeight","current","ratio","width","handleMouseDown","e","preventDefault","stopPropagation","getZoomContainer","zoomContainer","document","addEventListener","handleMouseMove","handleMouseUp","removeEventListener","handleTouchStart","targetTouches","length","handleTouchMove","handleTouchEnd","touch","rotation","node","Math","cos","PI","sin","nw","cW","useNaturalRatio","cH","height","updateNaturalRate","target","naturalWidth","naturalHeight","renderResizeHolder","isBlurred","imageConfig","disableResize","cursor","PluginRoles","imageResizer","environment","IS_TOUCH_DEVICE","renderRotateHolder","isRotating","onEnterRotationMode","handleRotate","controller","isHide","renderEditBorder","position","renderResizeNumber","normalizedWidth","Number","toFixed","normalizedHeight","renderResizeBg","src","onContextMenu","filter","handleClick","onClick","isImageDraggable","query","enabled","createRef","outlineWidth","outline","initResizeObserver","getImgRef","img","observerCallback","entries","entry","contentRect","window","requestAnimationFrame","ResizeObserver","observe","initMutationObserver","parent","value","getParent","key","parentDOM","domUtils","findDOMNodeSafely","MutationObserver","childList","attributes","subtree","attributeFilter","initScrollHandler","parentElement","getAttribute","canScroll","DraggablePlugin","SCROLLABLE_ATTRIBUTE_KEY","push","forEach","ancestorDOM","removeScrollHandler","cancel","componentDidMount","componentWillUnmount","container","disconnect","cancelAnimationFrame","getImgRectData","render","rotateObj","translateX","translateY","oldWidth","oldHeight","oldRotateObj","oldRtX","oldRtY","newRtX","newRtY","backgroundColor","disableRotate","rotateStyle","rHeight","rWidth","style","transform","isEditing","isTouchDevice","enableSingleRotateBtn","IS_MAC","IS_WINDOWS","showMultipleRotateBtn","Position"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { throttle, debounce } from 'lodash-es';\nimport ResizeObserver from 'resize-observer-polyfill';\nimport {\n  calcRotationObj,\n  calcXAfterRotation,\n  calcYAfterRotation,\n  getRelativeMouseEvent,\n  getRelativeTouchEvent,\n  RelativeEventType,\n} from '@ali/4ever-utils';\nimport { Inline, Controller, environment, domUtils } from '@ali/4ever-cangjie';\nimport { PluginRoles, DraggablePlugin } from '@ali/4ever-bamboo';\nimport { ImageData } from '@ali/4ever-mo';\nimport ImageRotate from './imageRotate';\nimport ImageRotateHolder from './imageRotateHolder';\nimport {\n  EditorResizeHolder, EditorNum, SelectBorder, BgImg, ImageLoading,\n  RotateControl, ImageEditorFrame,\n} from './styled';\nimport { IImgRectData } from './types';\nimport { ImagePluginConfig } from '../types';\nimport { getFixedNumber, getResizeCursor } from '../utils';\nimport { Position } from './constants';\n\nconst IMAGE_BG_COLOR = 'rgba(0, 137, 255, .1)';\nconst ACCURACY = 5;\n\nexport interface ImageEditorProps {\n  getZoomContainer(): HTMLElement | null;\n  filter?: (url: string) => boolean;\n  src: string;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  rotation: any;\n  controller: Controller;\n  scale: number;\n  node: Inline;\n  onChangeSize(width: number, height: number, l: number, r: number, t: number, b: number): void;\n  onEnterRotationMode(): void;\n  onEnterResizingMode(): void;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  handleRotate(rotation: any): void;\n  isRotating: boolean;\n  onContextMenu(e: React.MouseEvent): void;\n  imageConfig: ImagePluginConfig;\n  isLoaded: boolean;\n  isBlurred: boolean;\n  getImgRectData: () => IImgRectData;\n  getImgRef: () => HTMLElement | null;\n  onClick?: () => void;\n}\n\nexport interface ImageEditorState {\n  mouse: {\n    x: number;\n    y: number;\n  };\n  width: number;\n  height: number;\n  resizing: boolean;\n  angle: number;\n  l: number;\n  r: number;\n  t: number;\n  b: number;\n  left: number;\n  top?: number;\n}\n\nfunction shouldUseNaturalRatio(data: ImageData) {\n  const { rectClip } = data;\n  return !rectClip || !(rectClip.left || rectClip.right || rectClip.top || rectClip.bottom);\n}\n\nclass ImageEditor extends React.Component<ImageEditorProps, ImageEditorState> {\n  private readonly imageEditor;\n  private readonly rotateControl;\n  private readonly initialRectData;\n  private resizeObserver: ResizeObserver | null = null;\n  private mutationObserver: MutationObserver | null = null;\n  private prevImgWidth: number;\n  private mutationFrameId = -1;\n  private resizeFrameId = -1;\n  private readonly rate: number;\n  private naturalRate?: number;\n  private readonly scrollableAncestorsDOM: Array<HTMLElement|undefined> = [];\n  private readonly handleParentScroll = throttle(() => {\n    const rectData = this.getRealImgRectData();\n    this.setState(rectData);\n  }, 200);\n\n  constructor(props) {\n    super(props);\n\n    const { node } = props;\n    const { width, height, l, r, t, b, left, top } = this.getRealImgRectData();\n\n    this.state = {\n      mouse: {\n        x: 0,\n        y: 0,\n      },\n      width,\n      height,\n      angle: 0,\n      resizing: false,\n      l,\n      r,\n      t,\n      b,\n      left,\n      top,\n    };\n\n    this.rotateControl = React.createRef();\n    this.imageEditor = React.createRef();\n    this.initialRectData = { width, height, l, r, t, b, left, top };\n    const outlineWidth: number = node.data?.outline?.width || 0;\n    this.prevImgWidth = width - 2 * (outlineWidth);\n    this.rate = height / width;\n  }\n\n  initResizeObserver() {\n    const { getImgRef } = this.props;\n    const img = getImgRef();\n    if (!img) {\n      return;\n    }\n\n    const observerCallback = throttle((entries) => {\n      for (const entry of entries) {\n        if (this.prevImgWidth !== entry.contentRect.width) {\n          this.resizeFrameId = window.requestAnimationFrame(() => {\n            const rectData = this.getRealImgRectData();\n            this.setState(rectData);\n          });\n          this.prevImgWidth = entry.contentRect.width;\n        }\n      }\n    }, 300);\n\n    this.resizeObserver = new ResizeObserver(observerCallback);\n    this.resizeObserver.observe(img);\n  }\n\n  initMutationObserver() {\n    const { node } = this.props;\n    const parent = this.props.controller.value.document.getParent(node.key);\n    const parentDOM = parent && domUtils.findDOMNodeSafely(parent.key);\n    if (!parentDOM) {\n      return;\n    }\n\n    const observerCallback = debounce(() => {\n      this.mutationFrameId = window.requestAnimationFrame(() => {\n        const rectData = this.getRealImgRectData();\n        this.setState(rectData);\n      });\n    }, 200);\n\n    this.mutationObserver = new MutationObserver(observerCallback);\n    this.mutationObserver.observe(parentDOM, {\n      childList: true,\n      attributes: true,\n      subtree: true,\n      attributeFilter: ['style'],\n    });\n  }\n\n  initScrollHandler() {\n    const { node } = this.props;\n    let current = domUtils.findDOMNodeSafely(node.key);\n    while (current?.parentElement && !current?.parentElement?.getAttribute('data-cangjie-content')) {\n      const canScroll = current?.parentElement.getAttribute(DraggablePlugin.SCROLLABLE_ATTRIBUTE_KEY);\n      canScroll && this.scrollableAncestorsDOM.push(current?.parentElement);\n      current = current?.parentElement;\n    }\n    this.scrollableAncestorsDOM.forEach((ancestorDOM) => {\n      ancestorDOM && ancestorDOM.addEventListener('scroll', this.handleParentScroll);\n    });\n  }\n\n  removeScrollHandler() {\n    this.scrollableAncestorsDOM.forEach((ancestorDOM) => {\n      ancestorDOM && ancestorDOM.removeEventListener('scroll', this.handleParentScroll);\n    });\n    this.handleParentScroll.cancel();\n  }\n\n  componentDidMount() {\n    this.initResizeObserver();\n    this.initMutationObserver();\n    this.initScrollHandler();\n  }\n\n  componentWillUnmount() {\n    document.removeEventListener('mousemove', this.handleMouseMove);\n    document.removeEventListener('mouseup', this.handleMouseUp);\n    const { getZoomContainer } = this.props;\n    const container = getZoomContainer();\n    container && container.removeEventListener('touchmove', this.handleTouchMove);\n    container && container.removeEventListener('touchend', this.handleTouchEnd);\n    this.resizeObserver?.disconnect();\n    this.mutationObserver?.disconnect();\n    this.removeScrollHandler();\n    window.cancelAnimationFrame(this.resizeFrameId);\n    window.cancelAnimationFrame(this.mutationFrameId);\n  }\n\n  getRealImgRectData() {\n    const { node } = this.props;\n    const outlineWidth: number = node.data?.outline?.width || 0;\n    const rectData = this.props.getImgRectData();\n    rectData.width += ((outlineWidth as number)) * 2;\n    rectData.height += ((outlineWidth as number)) * 2;\n    return rectData;\n  }\n\n  onResizeStart = (relativeEvent: RelativeEventType, angle: number) => {\n    this.setState({\n      mouse: {\n        x: relativeEvent.relativeX,\n        y: relativeEvent.relativeY,\n      },\n      angle,\n      resizing: false,\n    });\n    this.props.onEnterResizingMode();\n  };\n\n  onResizeMove = (relativeEvent: RelativeEventType) => {\n    const X = relativeEvent.relativeX;\n    const Y = relativeEvent.relativeY;\n    const { mouse } = this.state;\n    const { scale } = this.props;\n\n    if (X !== mouse.x || Y !== mouse.y) {\n      const x = (mouse.x - X) / scale;\n      const y = (mouse.y - Y) / scale;\n      this.updateImageSize(x, y);\n      this.setState({\n        mouse: {\n          x: X,\n          y: Y,\n        },\n        resizing: true,\n      });\n    }\n  };\n\n  onResizeEnd = () => {\n    const { onChangeSize } = this.props;\n    let { l, r, t, b } = this.initialRectData;\n    const { clientWidth, clientHeight } = this.imageEditor.current;\n    const ratio = clientWidth / this.initialRectData.width;\n    l = getFixedNumber(ratio * l, ACCURACY);\n    r = getFixedNumber(ratio * r, ACCURACY);\n    t = getFixedNumber(ratio * t, ACCURACY);\n    b = getFixedNumber(ratio * b, ACCURACY);\n\n    onChangeSize(clientWidth, clientHeight, l, r, t, b);\n    this.setState({\n      resizing: false,\n      angle: 0,\n    });\n  };\n\n  handleMouseDown = (e, angle) => {\n    e.preventDefault();\n    e.stopPropagation();\n\n    const { getZoomContainer } = this.props;\n    const zoomContainer = getZoomContainer();\n\n    if (!zoomContainer) return;\n\n    const relativeEvent = getRelativeMouseEvent(e, zoomContainer);\n    this.onResizeStart(relativeEvent, angle);\n\n    document.addEventListener('mousemove', this.handleMouseMove);\n    document.addEventListener('mouseup', this.handleMouseUp);\n  };\n\n  handleMouseMove = (e) => {\n    e.preventDefault();\n    e.stopPropagation();\n    const { getZoomContainer } = this.props;\n    const zoomContainer = getZoomContainer();\n    const relativeEvent = getRelativeMouseEvent(e, zoomContainer!);\n    this.onResizeMove(relativeEvent);\n  };\n\n  handleMouseUp = (e) => {\n    e.preventDefault();\n    e.stopPropagation();\n    this.onResizeEnd();\n\n    document.removeEventListener('mousemove', this.handleMouseMove);\n    document.removeEventListener('mouseup', this.handleMouseUp);\n  };\n\n  handleTouchStart = (e: React.TouchEvent, angle: number) => {\n    e.preventDefault();\n    e.stopPropagation();\n\n    const { getZoomContainer } = this.props;\n    const zoomContainer = getZoomContainer();\n    const { targetTouches } = e;\n\n    if (!zoomContainer || targetTouches.length > 1) return;\n\n    const relativeEvent = getRelativeTouchEvent(targetTouches[0], zoomContainer);\n    this.onResizeStart(relativeEvent, angle);\n\n    zoomContainer.addEventListener('touchmove', this.handleTouchMove);\n    zoomContainer.addEventListener('touchend', this.handleTouchEnd);\n  };\n\n  handleTouchMove = (e: TouchEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    const { getZoomContainer } = this.props;\n    const zoomContainer = getZoomContainer();\n    const touch = e.targetTouches[0];\n    const relativeEvent = getRelativeTouchEvent(touch, zoomContainer!);\n    this.onResizeMove(relativeEvent);\n  };\n\n  handleTouchEnd = (e: TouchEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    this.onResizeEnd();\n\n    const { getZoomContainer } = this.props;\n    const zoomContainer = getZoomContainer();\n    zoomContainer && zoomContainer.removeEventListener('touchmove', this.handleTouchMove);\n    zoomContainer && zoomContainer.removeEventListener('touchend', this.handleTouchEnd);\n  };\n\n  updateImageSize = (x, y) => {\n    const { rotation, node } = this.props;\n    x = x * Math.cos(-rotation / 180 * Math.PI) - y * Math.sin(-rotation / 180 * Math.PI);\n    let nw: number;\n    const { width, angle, l, r, t, b } = this.state;\n    if (angle < 180) {\n      nw = width - x;\n    } else {\n      nw = width + x;\n    }\n\n    // 最小校验\n    if (nw < 24) {\n      nw = 24;\n    }\n\n    const ratio = nw / width;\n\n    const cW = nw;\n    const useNaturalRatio = shouldUseNaturalRatio(node.data);\n    const rate = (useNaturalRatio && this.naturalRate) ? this.naturalRate : this.rate;\n    const cH = nw * rate;\n\n    this.setState({\n      width: cW,\n      height: cH,\n      l: l * ratio,\n      t: t * ratio,\n      r: r * ratio,\n      b: b * ratio,\n    });\n  };\n\n  updateNaturalRate: React.ReactEventHandler<HTMLImageElement> = (e) => {\n    const { target } = e;\n    const { naturalWidth, naturalHeight } = target as HTMLImageElement;\n    this.naturalRate = naturalHeight / naturalWidth;\n  };\n\n  renderResizeHolder = (angle) => {\n    const { isBlurred, imageConfig, rotation } = this.props;\n    const { disableResize } = imageConfig;\n    const cursor = getResizeCursor(angle, rotation);\n    return !disableResize ? (\n      <EditorResizeHolder\n        role=\"resizer\"\n        data-role={`${PluginRoles.imageResizer}${angle}`}\n        angle={angle}\n        cursor={cursor}\n        onMouseDown={(e) => this.handleMouseDown(e, angle)}\n        onMouseUp={this.handleMouseUp}\n        onTouchStart={(e) => this.handleTouchStart(e, angle)}\n        onTouchEnd={this.handleMouseUp}\n        isSupportTouch={environment.IS_TOUCH_DEVICE}\n        isHide={isBlurred}\n      />\n    ) : null;\n  };\n\n  renderRotateHolder = (angle) => {\n    const { isRotating, onEnterRotationMode, handleRotate, rotation, scale, getZoomContainer, controller, isBlurred } = this.props;\n    const { width, height, resizing } = this.state;\n    const isHide = resizing || isBlurred;\n    return (\n      <ImageRotateHolder\n        angle={angle}\n        isSupportTouch={environment.IS_TOUCH_DEVICE}\n        isRotating={isRotating}\n        onEnterRotationMode={onEnterRotationMode}\n        handleRotate={handleRotate}\n        rotation={rotation}\n        width={width}\n        height={height}\n        rotateControl={this.rotateControl.current}\n        rotateImageFrame={this.imageEditor.current}\n        getZoomContainer={getZoomContainer}\n        controller={controller}\n        scale={scale}\n        isHide={isHide}\n      />\n    );\n  };\n\n  renderEditBorder = (position: Position) => (\n    <SelectBorder\n      position={position}\n    />\n  );\n\n  renderResizeNumber = () => {\n    const { width, height, angle, resizing } = this.state;\n    const { isRotating } = this.props;\n    const normalizedWidth = Number(Number(width).toFixed());\n    const normalizedHeight = Number(Number(height).toFixed());\n\n    return isRotating ? null : (\n      <EditorNum\n        angle={angle}\n        resizing={resizing}\n      >\n        {normalizedWidth} × {normalizedHeight}\n      </EditorNum>\n    );\n  };\n\n  renderResizeBg = () => {\n    const { src, isRotating, onContextMenu, filter } = this.props;\n    const { width, height, l, t, r, b, resizing } = this.state;\n    if (src) {\n      return (\n        <BgImg\n          resizing={resizing}\n          rotating={isRotating}\n        >\n          <img\n            src={src}\n            // @ts-ignore 该属性无效\n            filter={filter}\n            onContextMenu={onContextMenu}\n            style={{\n              position: 'relative',\n              left: -l,\n              top: -t,\n              width: typeof width === 'number' ? (width + l + r) : width,\n              height: typeof height === 'number' ? (height + t + b) : height,\n            }}\n            onLoad={this.updateNaturalRate}\n          />\n        </BgImg>\n      );\n    }\n    return <ImageLoading />;\n  };\n\n  handleClick = (e: React.MouseEvent) => {\n    const { onClick, controller } = this.props;\n    const isImageDraggable = controller.query('getDraggableConfig')?.enabled;\n    if (!isImageDraggable) {\n      e.preventDefault();\n    }\n    e.stopPropagation();\n    onClick && onClick();\n  };\n\n  render() {\n    const {\n      onEnterRotationMode,\n      handleRotate,\n      rotation,\n      isRotating,\n      getZoomContainer,\n      scale,\n      controller,\n      imageConfig,\n    } = this.props;\n    const { angle, width, height, resizing } = this.state;\n\n    let rotateObj;\n    if (width > 0 && height > 0) {\n      rotateObj = calcRotationObj(width, height, rotation);\n    }\n\n    let translateX = rotateObj?.translateX || 0;\n    let translateY = rotateObj?.translateY || 0;\n\n    const oldWidth = this.initialRectData.width;\n    const oldHeight = this.initialRectData.height;\n\n    // 修正旋转后缩放的左上角顶点对齐\n    if (rotation !== 0 && oldWidth > 0 && oldHeight > 0) {\n      const oldRotateObj = calcRotationObj(oldWidth, oldHeight, rotation);\n      const oldRtX = calcXAfterRotation(-oldWidth / 2, -oldHeight / 2, rotation, oldRotateObj.translateX);\n      const oldRtY = calcYAfterRotation(-oldWidth / 2, -oldHeight / 2, rotation, oldRotateObj.translateY);\n      const newRtX = calcXAfterRotation(-width / 2, -height / 2, rotation, translateX);\n      const newRtY = calcYAfterRotation(-width / 2, -height / 2, rotation, translateY);\n      translateX = translateX - (newRtX - oldRtX) + (oldWidth - width) / 2;\n      translateY = translateY - (newRtY - oldRtY) + (oldHeight - height) / 2;\n    }\n\n    let backgroundColor = IMAGE_BG_COLOR;\n    if (isRotating || rotation % 90 === 0 || resizing) {\n      backgroundColor = 'transparent';\n    }\n\n    const { disableRotate } = imageConfig;\n\n    const rotateStyle = {\n      height: rotateObj ? rotateObj.rHeight : height,\n      width: rotateObj ? rotateObj.rWidth : width,\n      backgroundColor,\n      left: this.state.left,\n      top: this.state.top,\n    };\n\n    const style = {\n      width,\n      height,\n      top: (angle === 45 || angle === 315) ? 'auto' : 0,\n      left: (angle === 225 || angle === 315) ? 'auto' : 0,\n      bottom: (angle === 225 || angle === 135) ? 'auto' : 0,\n      right: (angle === 45 || angle === 135) ? 'auto' : 0,\n      transform: `translate(${translateX}px, ${translateY}px) rotate(${rotation}deg)`,\n    };\n\n    const isEditing = isRotating || resizing;\n    const isTouchDevice = environment.IS_TOUCH_DEVICE;\n    const enableSingleRotateBtn = isTouchDevice && !(environment.IS_MAC || environment.IS_WINDOWS);\n    const showMultipleRotateBtn = !disableRotate && !enableSingleRotateBtn;\n\n    return (\n      <RotateControl\n        style={rotateStyle}\n        ref={this.rotateControl}\n        data-testid=\"image-select\"\n      >\n        <ImageEditorFrame style={style} ref={this.imageEditor} data-testid=\"image-select-frame\" >\n          {\n            !disableRotate &&\n            enableSingleRotateBtn &&\n            (<ImageRotate\n              isRotating={isRotating}\n              onEnterRotationMode={onEnterRotationMode}\n              handleRotate={handleRotate}\n              rotation={rotation}\n              width={width}\n              height={height}\n              rotateControl={this.rotateControl.current}\n              rotateImageFrame={this.imageEditor.current}\n              getZoomContainer={getZoomContainer}\n              controller={controller}\n              scale={scale}\n            />)\n          }\n          {this.renderResizeBg()}\n          {isEditing && this.renderEditBorder(Position.top)}\n          {isEditing && this.renderEditBorder(Position.right)}\n          {isEditing && this.renderEditBorder(Position.bottom)}\n          {isEditing && this.renderEditBorder(Position.left)}\n          {showMultipleRotateBtn && this.renderRotateHolder(45)}\n          {showMultipleRotateBtn && this.renderRotateHolder(135)}\n          {showMultipleRotateBtn && this.renderRotateHolder(225)}\n          {showMultipleRotateBtn && this.renderRotateHolder(315)}\n          {this.renderResizeHolder(45)}\n          {this.renderResizeHolder(135)}\n          {this.renderResizeHolder(225)}\n          {this.renderResizeHolder(315)}\n          {this.renderResizeNumber()}\n        </ImageEditorFrame>\n      </RotateControl>\n    );\n  }\n}\n\nexport default ImageEditor;\n"],"file":"imageEditor.js"}