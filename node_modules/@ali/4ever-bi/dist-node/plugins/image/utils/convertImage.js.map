{"version":3,"sources":["../../../../../src/plugins/image/utils/convertImage.ts"],"names":["isMobileSafari","test","navigator","userAgent","isNativeSupport","document","createElement","style","Orientations","orientationToAngle","orientation","String","getStringFromCharCode","dataView","start","length","str","i","fromCharCode","getUint8","getOrientation","buffer","DataView","byteLength","exifIDCode","tiffOffset","firstIFDOffset","littleEndian","endianness","app1Start","ifdStart","offset","getUint16","getUint32","e","loadBuffer","url","res","fetch","credentials","mode","redirect","arrayBuffer","loadImage","Promise","resolve","reject","image","Image","addEventListener","err","imageOrientation","src","canvasToBlob","canvas","toBlob","blob","createObjectURL","ArrayBuffer","Blob","type","URL","rotateImage","imageFile","angle","localURL","isRightRngle","Math","abs","width","oldWidth","height","oldHeight","maxWidth","maxHeight","window","screen","ratioX","ratioY","ratio","min","ctx","getContext","translate","rotate","PI","drawImage","revokeObjectURL","File","name"],"mappings":"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","sourcesContent":["export function isMobileSafari() {\n  return /(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent);\n}\n\nexport function isNativeSupport() {\n  return (\n    isMobileSafari() ||\n    \"imageOrientation\" in document.createElement(\"image\").style\n  );\n}\n\nexport type OrientationType = 1 | 3 | 6 | 8;\n\nexport const Orientations: { [name: string]: number } = {\n  [\"1\"]: 0,\n  [\"3\"]: 180,\n  [\"6\"]: 90,\n  [\"8\"]: -90\n};\n\nexport function orientationToAngle(orientation: OrientationType) {\n  return Orientations[String(orientation)] || 0;\n}\n\nexport function getStringFromCharCode(\n  dataView: DataView,\n  start: number,\n  length: number\n) {\n  let str = \"\",\n    i;\n  for (i = start, length += start; i < length; i++) {\n    str += String.fromCharCode(dataView.getUint8(i));\n  }\n  return str;\n}\n\nexport function getOrientation(buffer: ArrayBuffer): OrientationType {\n  if (isNativeSupport()) {\n    return 1;\n  }\n  const dataView = new DataView(buffer);\n  let length = dataView.byteLength;\n  let orientation;\n  let exifIDCode;\n  let tiffOffset;\n  let firstIFDOffset;\n  let littleEndian;\n  let endianness;\n  let app1Start;\n  let ifdStart;\n  let offset;\n  let i;\n  try {\n    // Only handle JPEG image (start by 0xFFD8)\n    if (dataView.getUint8(0) === 0xff && dataView.getUint8(1) === 0xd8) {\n      offset = 2;\n      while (offset < length) {\n        if (\n          dataView.getUint8(offset) === 0xff &&\n          dataView.getUint8(offset + 1) === 0xe1\n        ) {\n          app1Start = offset;\n          break;\n        }\n        offset++;\n      }\n    }\n    if (app1Start) {\n      exifIDCode = app1Start + 4;\n      tiffOffset = app1Start + 10;\n      if (getStringFromCharCode(dataView, exifIDCode, 4) === \"Exif\") {\n        endianness = dataView.getUint16(tiffOffset);\n        littleEndian = endianness === 0x4949;\n        if (littleEndian || endianness === 0x4d4d /* bigEndian */) {\n          if (dataView.getUint16(tiffOffset + 2, littleEndian) === 0x002a) {\n            firstIFDOffset = dataView.getUint32(tiffOffset + 4, littleEndian);\n            if (firstIFDOffset >= 0x00000008) {\n              ifdStart = tiffOffset + firstIFDOffset;\n            }\n          }\n        }\n      }\n    }\n    if (ifdStart) {\n      length = dataView.getUint16(ifdStart, littleEndian);\n      for (i = 0; i < length; i++) {\n        offset = ifdStart + i * 12 + 2;\n        if (\n          dataView.getUint16(offset, littleEndian) === 0x0112 /* Orientation */\n        ) {\n          // 8 is the offset of the current tag's value\n          offset += 8;\n          // Get the original orientation value\n          orientation = dataView.getUint16(offset, littleEndian);\n          break;\n        }\n      }\n    }\n    return orientation as OrientationType;\n  } catch (e) {\n    return 1;\n  }\n}\n\nexport async function loadBuffer(url: string) {\n  const res = await fetch(url, {\n    credentials: \"same-origin\",\n    mode: \"cors\",\n    redirect: \"follow\"\n  });\n  return res.arrayBuffer();\n}\n\nexport function loadImage(url: string) {\n  return new Promise<HTMLImageElement>((resolve, reject) => {\n    const image = new Image();\n    image.addEventListener(\"load\", () => resolve(image));\n    image.addEventListener(\"error\", err => reject(err));\n    image.style.imageOrientation = \"from-image\";\n    image.src = url;\n  });\n}\n\nexport function canvasToBlob(canvas: HTMLCanvasElement) {\n  return new Promise<Blob>(resolve => {\n    canvas.toBlob(blob => resolve(blob));\n  });\n}\n\nexport function createObjectURL(blob: ArrayBuffer | Blob) {\n  if (blob instanceof ArrayBuffer) {\n    blob = new Blob([blob], { type: \"image/jpeg\" });\n  }\n  return URL.createObjectURL(blob);\n}\n\nexport async function rotateImage(\n  imageFile: File,\n  angle: number,\n) {\n  if (!angle || angle === 0) {\n    return imageFile;\n  }\n  const localURL = createObjectURL(imageFile);\n  const image = await loadImage(localURL);\n  const isRightRngle = Math.abs(angle) === 90;\n  const { width: oldWidth, height: oldHeight } = image;\n  const { width: maxWidth, height: maxHeight } = window.screen;\n  const ratioX = oldWidth > maxWidth ? maxWidth / oldWidth : 1;\n  const ratioY = oldHeight > maxHeight ? maxHeight / oldHeight : 1;\n  const ratio = Math.min(ratioX, ratioY);\n  const width = (isRightRngle ? oldHeight : oldWidth) * ratio;\n  const height = (isRightRngle ? oldWidth : oldHeight) * ratio;\n  const canvas = document.createElement('canvas');\n  const ctx = canvas.getContext('2d');\n  canvas.width = width;\n  canvas.height = height;\n  ctx.translate(width / 2, height / 2);\n  ctx.rotate((angle * Math.PI) / 180);\n  if (isRightRngle) {\n    ctx.drawImage(image, -height / 2, -width / 2, height, width);\n  } else {\n    ctx.drawImage(image, -width / 2, -height / 2, width, height);\n  }\n  const blob = await canvasToBlob(canvas);\n  URL.revokeObjectURL(localURL);\n  return new File([blob], imageFile.name, { type: 'image/jpeg' });\n}\n"],"file":"convertImage.js"}