"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = getNode;

var _everCangjie = require("@ali/4ever-cangjie");

var _findBlockKeyFromEvent = _interopRequireDefault(require("./utils/findBlockKeyFromEvent"));

var _findInlineKeyFromEvent = _interopRequireDefault(require("./utils/findInlineKeyFromEvent"));

var _getNodeType = _interopRequireDefault(require("../getNodeType"));

/* eslint-disable @typescript-eslint/ban-ts-comment */
function findDocumentNode(document) {
  const domNode = _everCangjie.domUtils.findDOMNodeSafely(document.key);

  return domNode || null;
}

function getNode(event, controller, layouts) {
  if (!layouts) return {};
  const layoutKeys = Object.keys(layouts);
  if (layoutKeys.length === 0) return {};
  const {
    document
  } = controller.value;
  const container = findDocumentNode(document);
  const inlineKey = (0, _findInlineKeyFromEvent.default)(event, document);
  const inline = document.getNode(inlineKey);

  if (inline) {
    const inlineType = (0, _getNodeType.default)(inline, controller);

    if (layoutKeys.indexOf(inlineType) > -1) {
      return {
        node: inline
      };
    }
  }

  const blockKey = (0, _findBlockKeyFromEvent.default)(event, container);
  let block = document.getNode(blockKey);
  if (!block || !layouts) return {};

  while (block && !_everCangjie.Document.isDocument(block)) {
    const type = (0, _getNodeType.default)(block, controller);

    if (layoutKeys.indexOf(type) > -1) {
      return {
        node: block
      };
    }

    block = document.getClosestBlock(block.key);
  }

  return {};
}
//# sourceMappingURL=getNode.js.map