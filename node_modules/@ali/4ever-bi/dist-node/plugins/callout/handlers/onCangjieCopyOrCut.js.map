{"version":3,"sources":["../../../../../src/plugins/callout/handlers/onCangjieCopyOrCut.ts"],"names":["MIME_TYPES","constants","getClosestColorBlock","controller","selection","document","value","anchor","focus","start","end","convertToTextPoints","startBlock","getClosest","key","ColorBlocks","isColorBlocks","endBlock","onCangjieCopyOrCut","event","next","clipboardData","tableSelection","query","colorBlock","pathLength","getPath","length","fragment","getFragmentAtRange","node","Document","isDocument","Block","isBlock","nodes","targetFragment","create","setData","FRAGMENT","transferUtils","encodeFragment"],"mappings":";;;;;;;AAAA;;AASA;;AAEA,MAAM;AAAEA,EAAAA;AAAF,IAAiBC,sBAAvB;;AAEA,MAAMC,oBAAoB,GAAIC,UAAD,IAA4B;AACvD,QAAM;AAAEC,IAAAA,SAAF;AAAaC,IAAAA;AAAb,MAA0BF,UAAU,CAACG,KAA3C;AACA,QAAM;AAAEC,IAAAA,MAAF;AAAUC,IAAAA;AAAV,MAAoBJ,SAA1B;AACA,QAAM;AAAEK,IAAAA,KAAF;AAASC,IAAAA;AAAT,MAAiBN,SAAS,CAACO,mBAAV,CAA8BN,QAA9B,CAAvB;AACA,QAAMO,UAAU,GAAGP,QAAQ,CAACQ,UAAT,CAAoBJ,KAAK,CAACK,GAA1B,EAA+BC,oBAAYC,aAA3C,CAAnB;AACA,QAAMC,QAAQ,GAAGZ,QAAQ,CAACQ,UAAT,CAAoBH,GAAG,CAACI,GAAxB,EAA6BC,oBAAYC,aAAzC,CAAjB;;AACA,MAAIT,MAAM,CAACO,GAAP,KAAeN,KAAK,CAACM,GAArB,IAA4BP,MAAM,CAACO,GAAP,KAAeF,UAAU,EAAEE,GAA3D,EAAgE;AAC9D,WAAO,IAAP;AACD;;AACD,SAAOF,UAAU,KAAKK,QAAf,GAA0BL,UAA1B,GAAuC,IAA9C;AACD,CAVD;;AAYe,SAASM,kBAAT,CACbC,KADa,EAEbhB,UAFa,EAGbiB,IAHa,EAIb;AACA,MAAI,CAACD,KAAK,CAACE,aAAX,EAA0B;AACxB,WAAOD,IAAI,EAAX;AACD;;AAED,QAAME,cAAc,GAAGnB,UAAU,CAACoB,KAAX,CAAiB,gBAAjB,CAAvB;;AACA,MAAID,cAAJ,EAAoB;AAClB,WAAOF,IAAI,EAAX;AACD;;AAED,QAAMI,UAAU,GAAGtB,oBAAoB,CAACC,UAAD,CAAvC;;AACA,MAAI,CAACqB,UAAL,EAAiB;AACf,WAAOJ,IAAI,EAAX;AACD;;AAED,QAAM;AAAEf,IAAAA,QAAF;AAAYD,IAAAA;AAAZ,MAA0BD,UAAU,CAACG,KAA3C;AACA,MAAImB,UAAU,GAAGpB,QAAQ,CAACqB,OAAT,CAAiBF,UAAU,CAACV,GAA5B,EAAkCa,MAAnD;AAEA,QAAMC,QAAQ,GAAGvB,QAAQ,CAACwB,kBAAT,CAA4BzB,SAA5B,CAAjB;AAEA,MAAI0B,IAAsB,GAAGF,QAA7B;;AACA,SAAOH,UAAU,KAAKM,sBAASC,UAAT,CAAoBF,IAApB,KAA6BG,mBAAMC,OAAN,CAAcJ,IAAd,CAAlC,CAAjB,EAAyE;AACvEA,IAAAA,IAAI,GAAGA,IAAI,CAACK,KAAL,CAAW,CAAX,CAAP;AACAV,IAAAA,UAAU;AACX;;AAED,MAAI,CAACV,oBAAYC,aAAZ,CAA0Bc,IAA1B,CAAL,EAAsC;AACpC,WAAOV,IAAI,EAAX;AACD;;AAED,QAAMgB,cAAc,GAAGL,sBAASM,MAAT,CAAgB;AAAEF,IAAAA,KAAK,EAAEL,IAAI,CAACK;AAAd,GAAhB,CAAvB;;AACAhB,EAAAA,KAAK,CAACE,aAAN,CAAoBiB,OAApB,CACEtC,UAAU,CAACuC,QADb,EAEEC,2BAAcC,cAAd,CAA6BL,cAA7B,CAFF;AAIA,SAAOhB,IAAI,EAAX;AACD","sourcesContent":["import {\n  CangjieClipboardEvent,\n  constants,\n  transferUtils,\n  Node,\n  Block,\n  Controller,\n  Document,\n} from '@ali/4ever-cangjie';\nimport { ColorBlocks } from '@ali/4ever-mo';\n\nconst { MIME_TYPES } = constants;\n\nconst getClosestColorBlock = (controller: Controller) => {\n  const { selection, document } = controller.value;\n  const { anchor, focus } = selection;\n  const { start, end } = selection.convertToTextPoints(document);\n  const startBlock = document.getClosest(start.key, ColorBlocks.isColorBlocks);\n  const endBlock = document.getClosest(end.key, ColorBlocks.isColorBlocks);\n  if (anchor.key === focus.key && anchor.key === startBlock?.key) {\n    return null;\n  }\n  return startBlock === endBlock ? startBlock : null;\n};\n\nexport default function onCangjieCopyOrCut(\n  event: CangjieClipboardEvent,\n  controller: Controller,\n  next,\n) {\n  if (!event.clipboardData) {\n    return next();\n  }\n\n  const tableSelection = controller.query('tableSelection');\n  if (tableSelection) {\n    return next();\n  }\n\n  const colorBlock = getClosestColorBlock(controller);\n  if (!colorBlock) {\n    return next();\n  }\n\n  const { document, selection } = controller.value;\n  let pathLength = document.getPath(colorBlock.key)!.length;\n\n  const fragment = document.getFragmentAtRange(selection);\n\n  let node: Node | undefined = fragment;\n  while (pathLength && (Document.isDocument(node) || Block.isBlock(node))) {\n    node = node.nodes[0];\n    pathLength--;\n  }\n\n  if (!ColorBlocks.isColorBlocks(node)) {\n    return next();\n  }\n\n  const targetFragment = Document.create({ nodes: node.nodes });\n  event.clipboardData.setData(\n    MIME_TYPES.FRAGMENT,\n    transferUtils.encodeFragment(targetFragment),\n  );\n  return next();\n}\n"],"file":"onCangjieCopyOrCut.js"}