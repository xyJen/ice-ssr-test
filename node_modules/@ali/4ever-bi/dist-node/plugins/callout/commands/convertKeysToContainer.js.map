{"version":3,"sources":["../../../../../src/plugins/callout/commands/convertKeysToContainer.ts"],"names":["keysToBlocks","controller","keys","document","value","blocks","map","k","getNode","filter","n","Block","isBlock","removeCalloutPrFlag","withoutNormalizing","forEach","b","data","calloutPr","command","Commands","setNodeByKey","key","convertKeysToContainer","length","parent","getParent","ColorBlocks","isColorBlocks","prevAttrs","backgroundColor","bgcolor","stickerCode","sticker","colorBlock","createColorBlocks","showstk","targetPath","getPath","targetIndex","pop","insertNodeByPath","colorBlockPath","reverse","fromPath","moveNodeByPath"],"mappings":"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","sourcesContent":["import { Controller, Commands, Block } from '@ali/4ever-cangjie';\nimport { ColorBlocks } from '@ali/4ever-mo';\nimport { CalloutPr } from '../types';\n\nfunction keysToBlocks(controller: Controller, keys: string[]) {\n  const { document } = controller.value;\n  const blocks = keys\n    .map((k) => document.getNode(k))\n    .filter((n) => Block.isBlock(n)) as Block[];\n  return blocks;\n}\n\nfunction removeCalloutPrFlag(controller: Controller, keys: string[]) {\n  controller.withoutNormalizing(() => {\n    const blocks = keysToBlocks(controller, keys);\n    blocks.forEach((b) => {\n      if (b.data.calloutPr) {\n        const data = { ...b.data };\n        delete data.calloutPr;\n        controller.command(Commands.setNodeByKey, b.key, { data });\n      }\n    });\n  });\n  return controller;\n}\n\nexport function convertKeysToContainer(controller: Controller, keys: string[]) {\n  const { document } = controller.value;\n  const blocks = keysToBlocks(controller, keys);\n\n  if (!blocks.length) {\n    return controller;\n  }\n\n  /**\n   * 如果已经转移过了，直接去除标记\n   */\n  const parent = document.getParent(blocks[0].key);\n  if (ColorBlocks.isColorBlocks(parent)) {\n    return controller.command(removeCalloutPrFlag, keys);\n  }\n\n  const prevAttrs = blocks[0].data?.calloutPr as CalloutPr | undefined;\n  const { backgroundColor: bgcolor, stickerCode: sticker } = prevAttrs || {};\n  const colorBlock = ColorBlocks.createColorBlocks(\n    {\n      bgcolor,\n      sticker,\n      showstk: true,\n    },\n    [],\n  );\n  const targetPath = document.getPath(blocks[0].key)!;\n  const targetIndex = targetPath.pop()!;\n  controller.withoutNormalizing(() => {\n    controller.command(\n      Commands.insertNodeByPath,\n      targetPath,\n      targetIndex,\n      colorBlock,\n    );\n    const colorBlockPath = controller.value.document.getPath(colorBlock.key);\n    blocks.reverse().forEach((n) => {\n      const fromPath = controller.value.document.getPath(n.key);\n      if (fromPath && colorBlockPath) {\n        controller.command(\n          Commands.moveNodeByPath,\n          fromPath,\n          colorBlockPath,\n          0,\n        );\n      }\n    });\n  });\n  return controller.command(removeCalloutPrFlag, keys);\n}\n"],"file":"convertKeysToContainer.js"}