"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = RegisterEvent;

var _react = _interopRequireDefault(require("react"));

var _lodash = require("lodash");

var actions = _interopRequireWildcard(require("../actions"));

var _utils = require("../utils");

var _types = require("../types");

/** 高亮延迟 */
const DELAY_TIME = 50;

function RegisterEvent({
  controller,
  getRole,
  getHighlightType
}) {
  _react.default.useEffect(() => {
    let prevLeaveNode = null;
    const mouseEnter = (0, _lodash.debounce)(event => {
      if (getRole() !== _types.LaserPointerRole.HOST) {
        return;
      }

      const node = (0, _utils.findClosesetBlock)(event.target, controller);
      const highlightType = node && getHighlightType(node, controller);

      if (highlightType) {
        const path = controller.value.document.getPath(node.key);
        controller.run('onAction', actions.highlight({
          path
        }));
      }
    }, DELAY_TIME);

    const mouseleave = event => {
      mouseEnter.cancel();

      if (getRole() !== _types.LaserPointerRole.HOST) {
        return;
      }

      const node = (0, _utils.findClosesetBlock)(event.target, controller);
      const highlightType = node && getHighlightType(node, controller);

      if (highlightType && prevLeaveNode !== node) {
        controller.run('onAction', actions.removeHighlight());
      }

      prevLeaveNode = node;
    };

    document.addEventListener('mouseenter', mouseEnter, {
      capture: true
    });
    document.addEventListener('mouseleave', mouseleave, {
      capture: true
    });
    return () => {
      document.removeEventListener('mouseenter', mouseEnter, {
        capture: true
      });
      document.removeEventListener('mouseleave', mouseleave, {
        capture: true
      }); // 防止内存泄漏

      mouseEnter.cancel();
    }; // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  return null;
}
//# sourceMappingURL=RegisterEvent.js.map