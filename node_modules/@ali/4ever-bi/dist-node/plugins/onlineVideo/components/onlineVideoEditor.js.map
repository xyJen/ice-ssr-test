{"version":3,"sources":["../../../../../src/plugins/onlineVideo/components/onlineVideoEditor.tsx"],"names":["judgeVideoType","url","test","stopPropagation","e","OnlineVideoEditor","props","controller","onSave","isValidVideoURL","locale","node","pluginState","onFocus","onBlur","portalRef","React","useRef","onlineVideoRef","nodeRef","setUrl","useState","inputRef","createRef","data","useEffect","id","current","focus","select","onInputBlur","useCallback","onInputFocus","preventDefault","run","handleClickoutside","event","target","contains","onInsertOnlineVideo","type","src","handleInput","value","onIconClick","placeholder","ok","memo"],"mappings":";;;;;;;;;AAAA;;AAEA;;AACA;;AACA;;AACA;;uBAJ4B,a;;AAU5B,MAAMA,cAAc,GAAIC,GAAD,IAAS;AAC9B,MAAI,QAAQC,IAAR,CAAaD,GAAb,CAAJ,EAAuB;AACrB,WAAO,OAAP;AACD;;AACD,SAAO,KAAP;AACD,CALD;;AAOA,MAAME,eAAe,GAAIC,CAAD,IAAO;AAC7BA,EAAAA,CAAC,CAACD,eAAF;AACD,CAFD;;wBA0FQ,eAAC,uBAAD,O;;AA3ER,MAAME,iBAAiB,GAAIC,KAAD,IAAmB;AAC3C,QAAM;AACJC,IAAAA,UADI;AAEJC,IAAAA,MAFI;AAGJC,IAAAA,eAHI;AAIJC,IAAAA,MAAM,GAAG,EAJL;AAKJC,IAAAA,IALI;AAMJC,IAAAA,WANI;AAOJC,IAAAA,OAPI;AAQJC,IAAAA;AARI,MASFR,KATJ;;AAUA,QAAMS,SAAS,GAAGC,eAAMC,MAAN,CAA6B,IAA7B,CAAlB;;AACA,QAAMC,cAAc,GAAGF,eAAMC,MAAN,CAA6B,IAA7B,CAAvB;;AACA,QAAME,OAAO,GAAGH,eAAMC,MAAN,CAAaN,IAAb,CAAhB;;AACA,QAAM,CAACV,GAAD,EAAMmB,MAAN,IAAgBJ,eAAMK,QAAN,CAAe,EAAf,CAAtB;;AACA,QAAMC,QAAQ,gBAAGN,eAAMO,SAAN,EAAjB;;AACA,QAAM;AAAEC,IAAAA;AAAF,MAAWb,IAAjB;;AAEAK,iBAAMS,SAAN,CAAgB,MAAM;AACpB,QAAIb,WAAW,CAACY,IAAI,CAACE,EAAN,CAAf,EAA0B;AACxB;AACAJ,MAAAA,QAAQ,CAACK,OAAT,EAAkBC,KAAlB;AACAN,MAAAA,QAAQ,CAACK,OAAT,EAAkBE,MAAlB;AACAhB,MAAAA,OAAO;AACR;AACF,GAPD,EAOG,CAACD,WAAD,CAPH;;AASA,QAAMkB,WAAW,GAAGd,eAAMe,WAAN,CAAkB,MAAM;AAC1CjB,IAAAA,MAAM;AACP,GAFmB,EAEjB,EAFiB,CAApB;;AAIA,QAAMkB,YAAY,GAAGhB,eAAMe,WAAN,CAAmB3B,CAAD,IAAO;AAC5CA,IAAAA,CAAC,CAAC6B,cAAF;AACA7B,IAAAA,CAAC,CAACD,eAAF;AACAI,IAAAA,UAAU,CAAC2B,GAAX,CAAe,UAAf,EAA2B,qCAAuBf,OAAO,CAACQ,OAA/B,CAA3B;AACAd,IAAAA,OAAO;AACR,GALoB,EAKlB,EALkB,CAArB;;AAOA,QAAMsB,kBAAkB,GAAGnB,eAAMe,WAAN,CAAmBK,KAAD,IAAW;AACtD,UAAMC,MAAM,GAAGD,KAAK,CAACC,MAArB;;AACA,QACEA,MAAM,KAAKnB,cAAc,CAACS,OAA1B,IACAT,cAAc,CAACS,OAAf,EAAwBW,QAAxB,CAAiCD,MAAjC,CAFF,EAGE;AACA;AACD;;AACD9B,IAAAA,UAAU,CAAC2B,GAAX,CAAe,UAAf,EAA2B,gCAAkBvB,IAAlB,CAA3B;AACD,GAT0B,EASxB,EATwB,CAA3B;;AAWA,wCAAkBI,SAAlB,EAA6BoB,kBAA7B;;AAEA,QAAMI,mBAAmB,GAAG,MAAM;AAChC,QAAI,CAAC9B,eAAD,IAAoB,CAACA,eAAe,CAACR,GAAD,CAAxC,EAA+C;AAC7C;AACD;;AACD,UAAMuC,IAAI,GAAGxC,cAAc,CAACC,GAAD,CAA3B;AACAO,IAAAA,MAAM,CAAC;AACLiC,MAAAA,GAAG,EAAExC,GADA;AAELuC,MAAAA;AAFK,KAAD,CAAN;AAID,GATD;;AAWA,QAAME,WAAW,GAAItC,CAAD,IAAO;AACzBgB,IAAAA,MAAM,CAAChB,CAAC,CAACiC,MAAF,CAASM,KAAV,CAAN;AACD,GAFD;;AAIA,QAAMC,WAAW,GAAIxC,CAAD,IAAO;AACzBA,IAAAA,CAAC,CAAC6B,cAAF;AACA7B,IAAAA,CAAC,CAACD,eAAF;AACAI,IAAAA,UAAU,CAAC2B,GAAX,CAAe,UAAf,EAA2B,gCAAkBf,OAAO,CAACQ,OAA1B,CAA3B;AACD,GAJD;;AAMA,sBACE,eAAC,qBAAD;AAAe,IAAA,GAAG,EAAET;AAApB,kBACE,eAAC,mBAAD;AAAa,IAAA,OAAO,EAAE0B;AAAtB,UADF,eAIE,eAAC,aAAD;AACE,IAAA,GAAG,EAAEtB,QADP;AAEE,IAAA,WAAW,EAAEZ,MAAM,CAACmC,WAFtB;AAGE,IAAA,MAAM,EAAEf,WAHV;AAIE,IAAA,OAAO,EAAEE,YAJX;AAKE,IAAA,QAAQ,EAAEU,WALZ;AAME,IAAA,SAAS,EAAEvC,eANb;AAOE,IAAA,WAAW,EAAEA,eAPf;AAQE,IAAA,OAAO,EAAEA;AARX,IAJF,eAcE,eAAC,cAAD;AAAQ,IAAA,OAAO,EAAEoC;AAAjB,KAAuC7B,MAAM,CAACoC,EAA9C,CAdF,CADF;AAkBD,CA1FD;;4BA4Fe9B,eAAM+B,IAAN,CAAW1C,iBAAX,C","sourcesContent":["import React from 'react';\nimport { Controller, Node, Block } from '@ali/4ever-cangjie';\nimport { WebBetaNormal } from '@ali/we-design';\nimport { useOnClickOutside } from '@ali/4ever-component';\nimport { InsertWrapper, Input, Button, IconWrapper } from './styled';\nimport {\n  removeOnlineVideo,\n  focusOnlineVideoEditor,\n  selectOnlineVideo,\n} from '../actions';\n\nconst judgeVideoType = (url) => {\n  if (/youku/.test(url)) {\n    return 'youku';\n  }\n  return 'mp4';\n};\n\nconst stopPropagation = (e) => {\n  e.stopPropagation();\n};\n\ninterface IProps {\n  controller: Controller;\n  onSave: (params: any) => void;\n  isValidVideoURL: (url: string) => boolean;\n  locale: Record<string, any>;\n  node: Node;\n  pluginState: Record<string, boolean>;\n  onFocus: () => void;\n  onBlur: () => void;\n}\n\nconst OnlineVideoEditor = (props: IProps) => {\n  const {\n    controller,\n    onSave,\n    isValidVideoURL,\n    locale = {},\n    node,\n    pluginState,\n    onFocus,\n    onBlur,\n  } = props;\n  const portalRef = React.useRef<HTMLDivElement>(null);\n  const onlineVideoRef = React.useRef<HTMLDivElement>(null);\n  const nodeRef = React.useRef(node);\n  const [url, setUrl] = React.useState('');\n  const inputRef = React.createRef<HTMLInputElement>();\n  const { data } = node as Block;\n\n  React.useEffect(() => {\n    if (pluginState[data.id]) {\n      // TODO 主动 focus 失效，原因待查\n      inputRef.current?.focus();\n      inputRef.current?.select();\n      onFocus();\n    }\n  }, [pluginState]);\n\n  const onInputBlur = React.useCallback(() => {\n    onBlur();\n  }, []);\n\n  const onInputFocus = React.useCallback((e) => {\n    e.preventDefault();\n    e.stopPropagation();\n    controller.run('onAction', focusOnlineVideoEditor(nodeRef.current));\n    onFocus();\n  }, []);\n\n  const handleClickoutside = React.useCallback((event) => {\n    const target = event.target as HTMLElement;\n    if (\n      target === onlineVideoRef.current ||\n      onlineVideoRef.current?.contains(target)\n    ) {\n      return;\n    }\n    controller.run('onAction', removeOnlineVideo(node));\n  }, []);\n\n  useOnClickOutside(portalRef, handleClickoutside);\n\n  const onInsertOnlineVideo = () => {\n    if (!isValidVideoURL || !isValidVideoURL(url)) {\n      return;\n    }\n    const type = judgeVideoType(url);\n    onSave({\n      src: url,\n      type,\n    });\n  };\n\n  const handleInput = (e) => {\n    setUrl(e.target.value);\n  };\n\n  const onIconClick = (e) => {\n    e.preventDefault();\n    e.stopPropagation();\n    controller.run('onAction', selectOnlineVideo(nodeRef.current));\n  };\n\n  return (\n    <InsertWrapper ref={onlineVideoRef}>\n      <IconWrapper onClick={onIconClick}>\n        <WebBetaNormal />\n      </IconWrapper>\n      <Input\n        ref={inputRef}\n        placeholder={locale.placeholder}\n        onBlur={onInputBlur}\n        onFocus={onInputFocus}\n        onChange={handleInput}\n        onKeyDown={stopPropagation}\n        onMouseDown={stopPropagation}\n        onClick={stopPropagation}\n      />\n      <Button onClick={onInsertOnlineVideo}>{locale.ok}</Button>\n    </InsertWrapper>\n  );\n};\n\nexport default React.memo(OnlineVideoEditor);\n"],"file":"onlineVideoEditor.js"}