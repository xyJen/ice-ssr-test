{"version":3,"sources":["../../../../src/plugins/autoSpacing/utils.ts"],"names":["SPACING","isBlankOrEmoji","char","length","test","isLatin","shouldDeleteSpacing","a","b","c","sibling","isExpanded","textUtils","isChineseChar","shouldAutoSpacing","isPunc","getNodeText","node","start","end","Array","from","text","slice","getPreText","controller","document","selection","value","convertToTextPoints","startTextNode","getNode","key","offset","getNextText","endTextNode","shouldKeepSpcing","shouldDeleteSiblingSpacing","d","deleted","shoudDeleteBefore","shoudDeleteAfter"],"mappings":"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","sourcesContent":["import { textUtils, Controller, Node } from '@ali/4ever-cangjie';\n\nconst SPACING = ' ';\n\n/**\n * 判断是否为空白符或emoji\n * 处于性能考虑不做 unicode split，所有长度大于 1 的 grapheme 都被视为 emoji\n */\nexport function isBlankOrEmoji(char?: string) {\n  // char.length > 1: 👨‍👩‍👧‍👦\n  if (!char || char.length > 1 || /\\s/.test(char)) return true;\n  return false;\n}\n\n/**\n * 检测是够为常见拉丁文\n * ascii: https://www.ascii-code.com/\n * https://newbedev.com/regex-with-extended-latin-alphabet-a-o-u-e-ss\n */\nexport function isLatin(char: string) {\n  // C0 到 FF 不一定包含所有变形，如: Ŭ\n  // /[A-z|0-9|\\u00C0-\\u00FF]/.test(undefined) = true\n  return char && /[A-z|0-9|\\u00C0-\\u00FF]/.test(char);\n}\n\n/**\n * 判断是否应该删除空格\n * 首先，应该满足在西文前后输入：\n * 中文 [输入:中文][光标]Char：删除前面空格\n * Char[光标][输入:中文] 中文：删除后面空格\n * 其次，必须满足以下 pattern：\n *     a          b          c\n * eastAsian   spacing   eastAsian\n * 另外用户如果是选中内容输入，我们不做空格清除，原因在于无法准确判断用户意图，例如：\n *     [-----选区-----] \n * 中文   Char 中文中文中文中文\n * 我们难以判断此时用户是想输入内容与后面内容联系还是与前面内容联系\n */\nexport function shouldDeleteSpacing(a: string, b: string, c: string, sibling: string, isExpanded: boolean) {\n  if (isExpanded || b !== SPACING || !isLatin(sibling)) return false;\n  return textUtils.isChineseChar(a) && textUtils.isChineseChar(c);\n}\n\n/**\n * 判断两个字符之间是否应该 autoSpacing\n */\nexport function shouldAutoSpacing(a: string, b: string) {\n  // 有任意一个为空白符 或 多码点 unicode 则不加 spacing\n  if(isBlankOrEmoji(a) || isBlankOrEmoji(b)) return false;\n\n  // 有任意一个为标点 则不加 spacing\n  if(textUtils.isPunc(a) || textUtils.isPunc(b)) return false;\n\n  return isLatin(a) !== isLatin(b);\n}\n\n/**\n * 获取节点文本\n */\nfunction getNodeText(node: Node | null, start: number, end?: number) {\n  if (!node) return [];\n  // perf: use Array.from 避免复杂的 unicode 拆分\n  return Array.from(node.text.slice(start, end));\n}\n\n/**\n * 获取当前选区前后的文字\n * @param controller \n */\nexport function getPreText(controller: Controller) {\n  const { document, selection } = controller.value;\n  const { start } = selection.convertToTextPoints(document);\n  const startTextNode = document.getNode(start.key);\n  \n  return getNodeText(startTextNode, 0, start.offset);\n}\n\nexport function getNextText(controller: Controller) {\n  const { document, selection } = controller.value;\n  const { end } = selection.convertToTextPoints(document);\n  const endTextNode = document.getNode(end.key);\n  \n  return getNodeText(endTextNode, end.offset);\n}\n\n/**\n * 西文中间允许有空格\n */\nfunction shouldKeepSpcing(a: string, b: string) {\n  return isLatin(a) && isLatin(b);\n}\n\n/**\n * 连续空格删除逻辑\n * 首先，必须是连续空格相邻\n *     a          b          c          d\n *             spacing    spacing\n * 其次，分别判断 deleted 和 a/b 的类型以决定是否删除对应空格\n * 最后，西文之间是需要空格的，但我们难以判断连续空格前后的语义，因此保留一个空格\n */\nexport function shouldDeleteSiblingSpacing(a: string, b: string, c: string, d: string, deleted?: string) {\n  // 非连续空格不处理\n  if (isBlankOrEmoji(deleted) || b !== SPACING || c !== SPACING) return [false, false];\n  \n  // 特别注意：照顾英文输入习惯，空格留在前面\n  const shoudDeleteBefore = shouldAutoSpacing(a, deleted || '') && !shouldKeepSpcing(a, d);\n  const shoudDeleteAfter = shouldAutoSpacing(deleted || '', d);\n\n  return [shoudDeleteBefore, shoudDeleteAfter];\n}"],"file":"utils.js"}