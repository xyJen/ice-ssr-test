"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = onInsertText;

var _everCangjie = require("@ali/4ever-cangjie");

var _utils = require("../utils");

function onInsertText(event, controller, next) {
  let nextInputText = event.detail.data || '';
  if (!nextInputText.trim()) return next();
  const {
    document,
    selection
  } = controller.value;
  const isExpanded = selection.isExpanded;
  const preText = (0, _utils.getPreText)(controller);
  const nextText = (0, _utils.getNextText)(controller);
  if (!preText.length && !nextText.length) return next();
  const preLastText = preText[preText.length - 1];
  const nextFirstText = nextText[0];
  const inputText = Array.from(nextInputText);
  const inputFirstText = inputText[0];
  const inputLastText = inputText[inputText.length - 1]; // check if need add space

  const needAddSpaceBefore = (0, _utils.shouldAutoSpacing)(inputFirstText, preLastText);
  const needAddSpaceAfter = (0, _utils.shouldAutoSpacing)(inputLastText, nextFirstText);

  if (needAddSpaceBefore) {
    nextInputText = ` ${nextInputText}`;
  }

  if (needAddSpaceAfter) {
    nextInputText = `${nextInputText} `;
  } // 1. 删除前面多余空格（插入后删除需要重新计算位置，因此先行删除）


  const shouldDeleteSpacingBefore = (0, _utils.shouldDeleteSpacing)(preText[preText.length - 2], preLastText, inputFirstText, nextFirstText, isExpanded);

  if (shouldDeleteSpacingBefore) {
    const range = selection.moveToStart(document).moveAnchorBackward();
    controller.command(_everCangjie.Commands.deleteAtRange, range);
  } // 2. 添加空格


  if (needAddSpaceBefore || needAddSpaceAfter) {
    next((0, _everCangjie.CangjieInputEvent)({ ...event.detail,
      data: nextInputText
    }));
  } else {
    next();
  } // 3. 删除后面多余空格


  const shouldDeleteSpacingAfter = (0, _utils.shouldDeleteSpacing)(inputLastText, nextFirstText, nextText[1], preLastText, isExpanded);

  if (shouldDeleteSpacingAfter) {
    controller.command(_everCangjie.Commands.deleteForward);
  } // 4. 光标矫正


  if (needAddSpaceAfter) {
    controller.command(_everCangjie.Commands.moveBackward);
  }
}
//# sourceMappingURL=onInsertText.js.map