{"version":3,"sources":["../../../../../src/plugins/link/commands/updateLinkCardInfo.ts"],"names":["isCardInfoNeedUpdate","originalCardInfo","newCardInfo","title","desc","imgURL","displayType","updateLinkCardInfo","controller","node","text","href","cardInfo","selection","value","nodeText","length","originalHref","data","isLink","Text","isTextList","nodes","range","moveToRangeOfNode","command","Commands","select","insertText","focus","setNodeByKey","key","type","moveToEndOfNode","document","currentNode","getNode","linkTextNode","getNextText","marks","getMarksAtPosition","textNode","create","addMarks","newNode","merge","replaceNodeByKey","moveToStartOfNextText"],"mappings":"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","sourcesContent":["import { Controller, Inline, Commands, Text } from '@ali/4ever-cangjie';\nimport { ILinkCardInfo } from '../types';\nimport { isLinkNode } from '../utils';\n\nconst isCardInfoNeedUpdate = (originalCardInfo: ILinkCardInfo | undefined, newCardInfo: ILinkCardInfo) => {\n  if (!originalCardInfo) {\n    return true;\n  }\n  if (originalCardInfo.title !== newCardInfo.title\n    || originalCardInfo.desc !== newCardInfo.desc\n    || originalCardInfo.imgURL !== newCardInfo.imgURL\n    || originalCardInfo.displayType !== newCardInfo.displayType) {\n    return true;\n  }\n\n  return false;\n};\n\nexport default function updateLinkCardInfo(\n  controller: Controller,\n  node: Inline,\n  text: string,\n  href: string,\n  cardInfo?: ILinkCardInfo,\n) {\n  const { selection } = controller.value;\n  const nodeText = text.length ? text : href;\n  const originalHref = node.data.href;\n  const originalCardInfo = node.data.cardInfo;\n  const isLink = cardInfo && cardInfo.displayType === 'link'\n\n  // 若文本地址为空，则去除链接，链接里有可能嵌套inline图片\n  if (Text.isTextList(node.nodes) && !text.length && href.length && isLink) {\n    const range = selection.moveToRangeOfNode(node, controller);\n    return controller.command(Commands.select, range).command(Commands.insertText, href).command('unwrapLink').command(Commands.focus);\n  }\n\n  // 更新需要控制粒度，避免生成额外 op\n  if (cardInfo && (isCardInfoNeedUpdate(originalCardInfo, cardInfo) || href !== originalHref)) {\n    // 如果更新了卡片信息\n    controller.command(Commands.setNodeByKey, node.key, {\n      type: 'link',\n      data: { href, cardInfo: { ...cardInfo } },\n    }).command(Commands.moveToEndOfNode, node);\n  } else if (href !== originalHref) {\n    // 如果仅更新链接信息\n    controller.command(Commands.setNodeByKey, node.key, {\n      type: 'link',\n      data: { href },\n    }).command(Commands.moveToEndOfNode, node);\n  }\n  if (Text.isTextList(node.nodes) && nodeText !== node.text) {\n    // 卡片状态下的链接是 void 节点，如果采用 insertText 方式修改文本，会导致 void 节点被删除\n    // 因此采用 setNode 方式替换, 此时需要获取到最新的节点状态进行替换\n    const { document } = controller.value;\n    const currentNode = document.getNode(node.key);\n    if (!isLinkNode(currentNode)) {\n      return controller;\n    }\n    const linkTextNode = document.getNextText(currentNode.key);\n    if (linkTextNode) {\n      const marks = document.getMarksAtPosition(linkTextNode.key, 1);\n      const textNode = Text.create(nodeText).addMarks(0, nodeText.length, marks ?? []);\n      const newNode = currentNode.merge({ nodes: [textNode] });\n      controller.command(Commands.replaceNodeByKey, currentNode.key, newNode);\n    }\n  }\n  return controller.command(Commands.moveToStartOfNextText);\n}\n"],"file":"updateLinkCardInfo.js"}