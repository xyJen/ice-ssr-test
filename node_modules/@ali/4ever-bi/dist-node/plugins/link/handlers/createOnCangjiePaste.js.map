{"version":3,"sources":["../../../../../src/plugins/link/handlers/createOnCangjiePaste.ts"],"names":["tryWrapLink","controller","text","linkify","next","value","selection","document","isCollapsed","fragment","getFragmentAtRange","RangeSelection","create","test","command","Commands","wrapInline","type","data","href","moveToEnd","createOnCangjiePaste","config","linkConfig","protocolAllowList","getLinkInfo","enableCard","onCangjiePaste","event","clipboardData","query","receiveType","getFirstReceiveType","html","getData","hasRefblock","hasData","constants","MIME_TYPES","REFBLOCK","isTextUrl","indexOf","focus","isTextPoint","offset","focusText","startText","insertedText","slice","insertText","Selection","anchor","TextPoint","key","length","customPanel","run"],"mappings":"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","sourcesContent":["import { createLinkify as Linkify, matchesLink } from '@ali/4ever-utils';\nimport isUrl from 'is-url';\nimport { Plugin, RangeSelection, Commands, Controller, Selection, TextPoint, constants } from '@ali/4ever-cangjie';\nimport { hasLink } from '../utils';\nimport { BiPluginConfig } from '../../../types';\nimport { LinkPluginConfig } from '../types';\nimport { showLinkPastePanel } from '../actions';\n\n/**\n * 粘贴面板会拦截回车事件，这里在需要在 wraplink 时，不走链接识别逻辑\n * @see https://aone.alibaba-inc.com/v2/project/897543/bug/41483477# 《在链接后按回车无反应》\n * @param controller\n * @param text\n * @param linkify\n * @param next\n * @returns\n */\nfunction tryWrapLink(controller: Controller, text: string, linkify: any, next: Function) {\n  const { value } = controller;\n  const { selection, document } = value;\n  if (selection && selection.isCollapsed) {\n    return next();\n  }\n\n  const fragment = document.getFragmentAtRange(\n    RangeSelection.create(selection!),\n  );\n  if (linkify.test(fragment.text)) {\n    return next();\n  }\n\n  if (hasLink(value)) {\n    controller.command('unwrapLink');\n  }\n\n  return controller.command(Commands.wrapInline, {\n    type: 'link',\n    data: {\n      href: text,\n    },\n  }).command(Commands.moveToEnd);\n}\n\n\nexport default function createOnCangjiePaste(config: BiPluginConfig, linkConfig: LinkPluginConfig): Plugin['onCangjiePaste'] {\n  const { protocolAllowList, getLinkInfo, enableCard } = linkConfig;\n\n  const linkify = Linkify(protocolAllowList);\n  return function onCangjiePaste(event, controller, next) {\n    const clipboardData = controller.query('getClipboardData', event);\n    if (!clipboardData) {\n      return next();\n    }\n    const receiveType = clipboardData.getFirstReceiveType();\n    const html = clipboardData.getData('text/html');\n    const text = clipboardData.getData('text/plain');\n\n    // BACKGROUND：引用块会将锚点地址 text/plain 中，方便发送到 IM 消息等时，其他用户能锚点定位回对应引用位置\n    // 因此，当检测到为引用块时，不做识别为 URL 的处理\n    const hasRefblock = clipboardData.hasData(constants.MIME_TYPES.REFBLOCK);\n    if (hasRefblock) {\n      return next();\n    }\n\n    // HACK: 处理 <a data-title=\"...\" href=\"...\">href</a>，以支持钉钉文档拷贝链接粘贴需求\n    // 需求背景：\n    //   1. 粘贴到钉钉文档内，显示文档标题\n    //   2. 粘贴到浏览器地址栏等，粘贴结果为链接\n    if (receiveType !== 'text' && receiveType !== 'html') {\n      return next();\n    }\n\n    const isTextUrl = isUrl(text);\n    if (\n      !isTextUrl ||\n      (html && html.indexOf('data-title') > -1)\n    ) {\n      return next();\n    }\n\n    // 粘贴纯文本 URL 时，若当前为 collased 选区，则判断是否在链接/图片 md 语法内\n    // 若是，则直接插入文本，不再转为 link\n    const { focus } = controller.value.selection;\n    if (\n      !html\n      && isTextUrl\n      && controller.value.selection.isCollapsed\n      && focus.isTextPoint()\n      && focus.offset > 0\n    ) {\n      const focusText = controller.value.startText?.text || '';\n      const insertedText = `${focusText.slice(0, focus.offset)}${text}${focusText.slice(focus.offset)}`;\n      if (!matchesLink(linkify, insertedText)) {\n        return controller\n          .command(Commands.insertText, text)\n          .command('showClipboard', Selection.create({\n            anchor: focus,\n            focus: TextPoint.create({ key: focus.key, offset: focus.offset + text.length }),\n          }));\n      }\n    }\n\n    return tryWrapLink(\n      controller,\n      text,\n      linkify, () => {\n        // 链接自动转卡片逻辑\n        const { customPanel } = controller.value.data;\n        // 文档链接不做转卡片处理，后续用 hetu 专门替代掉\n        if (!customPanel && enableCard) {\n          controller.run('onAction', showLinkPastePanel(text, getLinkInfo));\n        }\n        return next();\n      },\n    );\n  };\n}\n"],"file":"createOnCangjiePaste.js"}