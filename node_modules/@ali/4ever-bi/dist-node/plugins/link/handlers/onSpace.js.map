{"version":3,"sources":["../../../../../src/plugins/link/handlers/onSpace.ts"],"names":["onSpace","event","controller","next","value","anchorText","selection","document","isExpanded","anchor","convertToTextPoints","text","slice","offset","matches","match","END_WITH_MARKDOWN_LINK","matchText","title","href","length","preventDefault","command","Commands","moveAnchorBackward","del","dispatch","mdType","run","insertInline","type","nodes","Text","create","data","encodeURI","node","anchorInline","key","moveToStartOfNextText"],"mappings":";;;;;;;AACA;;AACA;;AACA;;AACA;;AAEe,SAASA,OAAT,CACbC,KADa,EAEbC,UAFa,EAGbC,IAHa,EAIb;AACA,QAAM;AAAEC,IAAAA;AAAF,MAAYF,UAAlB;AACA,QAAM;AAAEG,IAAAA,UAAF;AAAcC,IAAAA,SAAd;AAAyBC,IAAAA;AAAzB,MAAsCH,KAA5C;AACA,MAAI,CAACE,SAAD,IAAc,CAACD,UAAf,IAA6BC,SAAS,CAACE,UAA3C,EAAuD,OAAOL,IAAI,EAAX;AAEvD,QAAM;AAAEM,IAAAA;AAAF,MAAaH,SAAS,CAACI,mBAAV,CAA8BH,QAA9B,CAAnB;AACA,QAAMI,IAAI,GAAGN,UAAU,CAACM,IAAX,CAAgBC,KAAhB,CAAsB,CAAtB,EAAyBH,MAAM,CAACI,MAAhC,CAAb;AAEA,QAAMC,OAAO,GAAGH,IAAI,CAACI,KAAL,CAAWC,sCAAX,CAAhB;AAEA,MAAI,CAACF,OAAL,EAAc,OAAOX,IAAI,EAAX;AAEd,QAAM,CAACc,SAAD,EAAYC,KAAZ,EAAmBC,IAAnB,IAA2BL,OAAjC,CAZA,CAcA;;AACA,MAAIH,IAAI,CAACS,MAAL,GAAcH,SAAS,CAACG,MAAxB,IAAkCT,IAAI,CAACA,IAAI,CAACS,MAAL,GAAcH,SAAS,CAACG,MAAxB,GAAiC,CAAlC,CAAJ,KAA6C,GAAnF,EAAwF,OAAOjB,IAAI,EAAX,CAfxF,CAgBA;;AACA,MAAI,CAACe,KAAD,IAAUC,IAAd,EAAoB,OAAOhB,IAAI,EAAX;AAEpBF,EAAAA,KAAK,CAACoB,cAAN,GAnBA,CAoBA;;AACAnB,EAAAA,UAAU,CACPoB,OADH,CACWC,sBAASC,kBADpB,EACwCP,SAAS,CAACG,MADlD,EAEGE,OAFH,CAEWC,sBAASE,GAFpB,EAGGC,QAHH,CAGY,6BAHZ,EAG2C;AAAEC,IAAAA,MAAM,EAAE;AAAV,GAH3C,EArBA,CA0BA;;AACA,MAAI,CAACT,KAAD,IAAU,CAACC,IAAf,EAAqB;AACnB,WAAOjB,UAAU,CAAC0B,GAAX,CAAe,UAAf,EAA2B,wBAA3B,CAAP;AACD,GA7BD,CA+BA;;;AACA1B,EAAAA,UAAU,CACPoB,OADH,CACWC,sBAASM,YADpB,EACkC;AAC9BC,IAAAA,IAAI,EAAE,MADwB;AAE9BC,IAAAA,KAAK,EAAE,CAACC,kBAAKC,MAAL,CAAYf,KAAZ,CAAD,CAFuB;AAG9BgB,IAAAA,IAAI,EAAE;AACJf,MAAAA,IAAI,EAAEgB,SAAS,CAAChB,IAAD;AADX;AAHwB,GADlC,EAhCA,CAyCA;;AACA,QAAMiB,IAAI,GAAGlC,UAAU,CAACE,KAAX,CAAiBiC,YAA9B;;AACA,MAAID,IAAI,KAAK,CAAClB,KAAD,IAAU,CAACC,IAAhB,CAAR,EAA+B;AAC7B,mCAAeiB,IAAI,CAACE,GAApB,EAAyB,IAAzB;AACA,WAAOpC,UAAP;AACD,GA9CD,CAgDA;;;AACA,SAAOA,UAAU,CAACoB,OAAX,CAAmBC,sBAASgB,qBAA5B,CAAP;AACD","sourcesContent":["import * as React from 'react';\nimport { Controller, Commands, Text, CangjieInputEvent, Block } from '@ali/4ever-cangjie';\nimport { wrapLink } from '../actions';\nimport { setJustCreated } from '../utils/linkStore';\nimport { END_WITH_MARKDOWN_LINK } from '@ali/4ever-plugin-link';\n\nexport default function onSpace(\n  event: React.KeyboardEvent | CangjieInputEvent,\n  controller: Controller,\n  next: Function,\n) {\n  const { value } = controller;\n  const { anchorText, selection, document } = value;\n  if (!selection || !anchorText || selection.isExpanded) return next();\n\n  const { anchor } = selection.convertToTextPoints(document);\n  const text = anchorText.text.slice(0, anchor.offset);\n\n  const matches = text.match(END_WITH_MARKDOWN_LINK);\n\n  if (!matches) return next();\n\n  const [matchText, title, href] = matches;\n\n  // 排除同时命中 ![]() 图片格式的情况\n  if (text.length > matchText.length && text[text.length - matchText.length - 1] === '!') return next();\n  // [](abc) 类似这样的文本暂时不予处理，可能导致空 text 的 Link 元素\n  if (!title && href) return next();\n\n  event.preventDefault();\n  // 删除 markdown 文本\n  controller\n    .command(Commands.moveAnchorBackward, matchText.length)\n    .command(Commands.del)\n    .dispatch('createTriggerMarkdownAction', { mdType: 'link' });\n\n  // []() 时插入 placeholder\n  if (!title && !href) {\n    return controller.run('onAction', wrapLink());\n  }\n\n  // 插入链接 Inline\n  controller\n    .command(Commands.insertInline, {\n      type: 'link',\n      nodes: [Text.create(title)],\n      data: {\n        href: encodeURI(href),\n      },\n    });\n\n  // 打开链接编辑框\n  const node = controller.value.anchorInline;\n  if (node && (!title || !href)) {\n    setJustCreated(node.key, true);\n    return controller;\n  }\n\n  // 链接填写完整，光标移动到下一个 Text 开头\n  return controller.command(Commands.moveToStartOfNextText);\n}\n"],"file":"onSpace.js"}