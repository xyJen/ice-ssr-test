{"version":3,"sources":["../../../../../../src/plugins/link/components/next/linkButton.tsx"],"names":["MOD","environment","IS_MAC","SHORTCUT","isSelectionInDecoration","selection","decotation","focus","isTextPoint","key","start","end","offset","LinkButton","props","locale","controller","tooltip","tooltipProp","rest","value","startBlock","activeMarks","document","decrs","React","useMemo","run","isSelectionInPureLink","decrsInSelection","filter","decr","marks","map","mark","concat","some","type","placeholder","addLinkPlaceholder","handleClick","useCallback","linkDecoration","find","data","node","getNode","href","disabled","inlines","getLeafInlinesAtRange","isInvalidInlineInSelection","inline","Image","isImage","query","isInLink","title","unlink","link","description","shortCut","PluginRoles","linkDelete"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { Controller, Text, environment, Selection, Decoration, TextPoint } from '@ali/4ever-cangjie';\nimport { Image } from '@ali/4ever-mo';\nimport { PluginRoles } from '@ali/4ever-bamboo';\nimport { AddLinkButton, DeleteLinkButton } from '@ali/4ever-component';\nimport { wrapLink, unwrapPureLink, removeLink } from '../../actions';\nimport { isLink, isSelectionInLink } from '../../utils';\n;\nimport { IToolbarButtonConfig } from '@ali/4ever-component';\nimport { tryGetSelectedLinkPlaceholder } from '../../utils/isSelectionInLink';\nimport { LinkLocale } from '../../types';\n\nconst MOD = environment.IS_MAC ? '⌘' : 'Ctrl';\nconst SHORTCUT = `${MOD}+K`;\n\nexport interface LinkButtonProps extends IToolbarButtonConfig {\n  locale: LinkLocale;\n  controller: Controller;\n}\n\nfunction isSelectionInDecoration(selection: Selection, decotation: Decoration) {\n  const { focus } = selection;\n  return focus.isTextPoint()\n    && focus.key === decotation.start.key\n    && focus.key === decotation.end.key\n    && focus.offset >= decotation.start.offset\n    && focus.offset <= decotation.end.offset;\n}\n\nconst LinkButton: React.FC<LinkButtonProps> = (props) => {\n  const { locale, controller, tooltip: tooltipProp, ...rest } = props;\n\n  const { value } = controller;\n  const { startBlock, activeMarks, selection, document } = controller.value;\n\n  const decrs = React.useMemo(() => {\n    if (startBlock) {\n      return controller.run('decorateNode', startBlock);\n    }\n    return [];\n  }, [controller, startBlock]);\n\n  const isSelectionInPureLink = React.useMemo(() => {\n\n    const decrsInSelection = decrs.filter(decr => isSelectionInDecoration(selection, decr));\n\n    const marks = decrsInSelection.map((decr) => decr.mark).concat(activeMarks);\n    return (\n      marks.some(({ type }) => type === 'link') &&\n      !marks.some(({ type }) => type === 'unlink')\n    );\n  }, [decrs, activeMarks, selection]);\n\n  const placeholder = tryGetSelectedLinkPlaceholder(controller.value, locale.addLinkPlaceholder);\n\n  const handleClick = React.useCallback(() => {\n    if (isSelectionInPureLink) {\n      const { document, selection } = controller.value;\n      const focus = selection.focus as TextPoint;\n      const linkDecoration = decrs.find(\n        ({ mark, start, end }) => mark.type === 'link' &&\n          focus.key === start.key &&\n          focus.offset >= start.offset &&\n          focus.offset <= end.offset,\n      );\n      if (!linkDecoration) {\n        return;\n      }\n      const { mark, start } = linkDecoration;\n      const { data } = mark;\n      const node = document.getNode(start.key) as Text;\n      controller.run('onAction', unwrapPureLink(node, start.offset, data.href));\n    } else {\n      if (placeholder) {\n        // 在占位符进行取消链接时，直接执行删除，来自：https://work.aone.alibaba-inc.com/issue/34949369\n        controller.run('onAction', removeLink(placeholder));\n      } else {\n        controller.run('onAction', wrapLink());\n      }\n    }\n  }, [controller, decrs, isSelectionInPureLink, placeholder]);\n\n  const disabled = React.useMemo(() => {\n    const inlines = document.getLeafInlinesAtRange(selection);\n    const isInvalidInlineInSelection = inlines.some((inline) => {\n      return !isLink(inline) && !Image.isImage(inline);\n    })\n    return isInvalidInlineInSelection || controller.query('isSelectionInListSymbol') || false;\n  }, [selection, document, value]);\n\n  const isInLink = isSelectionInLink(controller.value) || isSelectionInPureLink;\n\n  const tooltip = React.useMemo(() => ({\n    title: isInLink ? locale?.unlink : locale.link,\n    description: 'Markdown: []() ' + (locale?.['space'] || 'Space'),\n    shortCut: SHORTCUT,\n    ...tooltipProp,\n  }), [isInLink, tooltipProp]);\n\n  return isInLink ? (\n    <DeleteLinkButton\n      testid=\"bi-toolbar-unlink\"\n      onClick={handleClick}\n      disabled={disabled}\n      title={locale?.link}\n      role={PluginRoles.link}\n      tooltip={tooltip}\n      {...rest}\n    />\n  ) : (\n    <AddLinkButton\n      testid=\"bi-toolbar-link\"\n      onClick={handleClick}\n      disabled={disabled}\n      title={locale?.link}\n      role={PluginRoles.linkDelete}\n      tooltip={tooltip}\n      {...rest}\n    />\n  );\n};\n\nexport default LinkButton;\n"],"file":"linkButton.js"}