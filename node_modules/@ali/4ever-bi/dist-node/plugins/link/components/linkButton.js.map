{"version":3,"sources":["../../../../../src/plugins/link/components/linkButton.tsx"],"names":["MOD","environment","IS_MAC","SHORTCUT","isSelectionInDecoration","selection","decotation","focus","isTextPoint","key","start","end","offset","LinkButton","props","locale","controller","toolbarMode","rest","value","startBlock","activeMarks","document","shortcut","ToolbarMode","double","decrs","React","useMemo","run","isSelectionInPureLink","decrsInSelection","filter","decr","marks","map","mark","concat","some","type","ploceholder","addLinkPlaceholder","handleClick","useCallback","linkDecoration","find","data","node","getNode","href","disabled","inlines","getLeafInlinesAtRange","isInvalidInlineInSelection","inline","Image","isImage","query","isInLink","link","PluginRoles","unlink","LINK_INSERT_HOT_KEY_TIP","space","linkDelete"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { AddLinkButton, DeleteLinkButton } from '@ali/we-toolbar';\nimport { Controller, Text, environment, Selection, Decoration, TextPoint } from '@ali/4ever-cangjie';\nimport { Image } from '@ali/4ever-mo';\nimport { PluginRoles } from '@ali/4ever-bamboo';\nimport { ToolbarMode, IconButtonShortcut } from '@ali/4ever-component';\nimport { wrapLink, unwrapPureLink, removeLink } from '../actions';\nimport { isLink, isSelectionInLink } from '../utils';\n;\nimport { LINK_INSERT_HOT_KEY_TIP } from '../utils/hotKeyTips';\nimport { tryGetSelectedLinkPlaceholder } from '../utils/isSelectionInLink';\n\nconst MOD = environment.IS_MAC ? '⌘' : 'Ctrl';\nconst SHORTCUT = `${MOD}+K`;\n\nexport interface LinkButtonProps {\n  locale: Record<string, string>;\n  controller: Controller;\n  toolbarMode?: ToolbarMode;\n}\n\nfunction isSelectionInDecoration(selection: Selection, decotation: Decoration) {\n  const { focus } = selection;\n  return focus.isTextPoint()\n    && focus.key === decotation.start.key\n    && focus.key === decotation.end.key\n    && focus.offset >= decotation.start.offset\n    && focus.offset <= decotation.end.offset;\n}\n\nconst LinkButton: React.FC<LinkButtonProps> = (props) => {\n  const { locale, controller, toolbarMode, ...rest } = props;\n  const { value } = controller;\n  const { startBlock, activeMarks, selection, document } = controller.value;\n  const shortcut = toolbarMode === ToolbarMode.double ? ` ${SHORTCUT}` : '';\n\n  const decrs = React.useMemo(() => {\n    if (startBlock) {\n      return controller.run('decorateNode', startBlock);\n    }\n    return [];\n  }, [controller, startBlock]);\n\n  const isSelectionInPureLink = React.useMemo(() => {\n\n    const decrsInSelection = decrs.filter(decr => isSelectionInDecoration(selection, decr));\n\n    const marks = decrsInSelection.map((decr) => decr.mark).concat(activeMarks);\n    return (\n      marks.some(({ type }) => type === 'link') &&\n      !marks.some(({ type }) => type === 'unlink')\n    );\n  }, [decrs, activeMarks, selection]);\n\n  const ploceholder = tryGetSelectedLinkPlaceholder(controller.value, locale.addLinkPlaceholder);\n\n  const handleClick = React.useCallback(() => {\n    if (isSelectionInPureLink) {\n      const { document, selection } = controller.value;\n      const focus = selection.focus as TextPoint;\n      const linkDecoration = decrs.find(\n        ({ mark, start, end }) => mark.type === 'link' &&\n          focus.key === start.key &&\n          focus.offset >= start.offset &&\n          focus.offset <= end.offset,\n      );\n      if (!linkDecoration) {\n        return;\n      }\n      const { mark, start } = linkDecoration;\n      const { data } = mark;\n      const node = document.getNode(start.key) as Text;\n      controller.run('onAction', unwrapPureLink(node, start.offset, data.href));\n    } else {\n      if (ploceholder) {\n        // 在占位符进行取消链接时，直接执行删除，来自：https://work.aone.alibaba-inc.com/issue/34949369\n        controller.run('onAction', removeLink(ploceholder));\n      } else {\n        controller.run('onAction', wrapLink());\n      }\n    }\n  }, [controller, decrs, isSelectionInPureLink, ploceholder]);\n\n  const disabled = React.useMemo(() => {\n    const inlines = document.getLeafInlinesAtRange(selection);\n    const isInvalidInlineInSelection = inlines.some((inline) => {\n      return !isLink(inline) && !Image.isImage(inline);\n    })\n    return isInvalidInlineInSelection || controller.query('isSelectionInListSymbol');\n  }, [selection, document, value]);\n\n  const isInLink = isSelectionInLink(controller.value) || isSelectionInPureLink;\n\n  return isInLink ? (\n    <DeleteLinkButton\n      {...rest}\n      shortcutText={shortcut}\n      testid=\"bi-toolbar-unlink\"\n      onClick={handleClick}\n      disabled={disabled}\n      title={locale?.link}\n      role={PluginRoles.link}\n      tooltip={\n        <IconButtonShortcut\n          title={locale?.unlink}\n          shortcut={LINK_INSERT_HOT_KEY_TIP}\n          description={`Markdown: []() ${locale.space}`}\n        />\n      }\n    />\n  ) : (\n    <AddLinkButton\n      {...rest}\n      shortcutText={shortcut || LINK_INSERT_HOT_KEY_TIP}\n      tooltip={\n        <IconButtonShortcut\n          title={locale?.link}\n          shortcut={LINK_INSERT_HOT_KEY_TIP}\n          description={`Markdown: []() ${locale.space}`}\n        />\n      }\n      testid=\"bi-toolbar-link\"\n      onClick={handleClick}\n      disabled={disabled}\n      role={PluginRoles.linkDelete}\n    />\n  );\n};\n\nexport default LinkButton;\n"],"file":"linkButton.js"}