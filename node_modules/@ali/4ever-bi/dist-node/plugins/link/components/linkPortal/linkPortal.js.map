{"version":3,"sources":["../../../../../../src/plugins/link/components/linkPortal/linkPortal.tsx"],"names":["offsetX","offsetY","offset","HIDE_TOOLBAR_DELAY_TIME","getPosition","containerRect","triggerRect","portalRect","height","width","baseTop","bottom","top","baseLeft","left","bottomSpace","rightSpace","triggerTop","triggerRight","right","stopEvent","event","stopPropagation","LinkPortal","props","children","text","href","locale","controller","mountRoot","portalState","setPortalState","overlayChanging","setOverlayChanging","React","useState","hidingOverlay","setHidingOverlay","onOverlayHide","useCallback","showEditor","hideEditor","s","showToolbar","hideToolbar","defaultContent","document","body","scrollableContent","zoom","portalRef","useRef","linkRef","isPlaceholder","addLinkPlaceholder","isEmptyHref","trim","length","showStopEvent","isNormalLink","editorPortal","isEditMode","onEditorHide","toolbarPortal","onSwitchToEdit","overlay","editorOverlay","handleLinkMouseDown","handleEditorLinkMouseDown","handleLinkClick","handleEditorLinkClick","toolbarOverlay","handleMouseEnter","run","handleClick","prePortalState","useEffect","preVisible","currentVisible","cloneElement","onMouseDown","onMouseUp","undefined","onClick","onMouseEnter","onMouseLeave"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { useZoom, useZoomContainer } from '@ali/4ever-cangjie';\nimport Portal from '../AnimatePortal';\nimport type { GetPosition } from '@ali/4ever-component';\nimport { LinkPortalProps } from '../../types';\nimport useEditorPortal from './useEditorPortal';\nimport useToolbarPortal from './useToolbarPortal';\nimport { useDelayedState } from '@ali/4ever-component';\nimport { hoverLinkCard } from '../../actions';\nimport { usePrevious } from '@ali/we-design';\n\nconst offsetX = 0;\nconst offsetY = 6;\nconst offset = [offsetX, offsetY];\n\n// toolbar 隐藏延时\nconst HIDE_TOOLBAR_DELAY_TIME = 150;\n\nconst getPosition: GetPosition = (containerRect: DOMRect, triggerRect: DOMRect, portalRect: DOMRect) => {\n  const { height, width } = portalRect;\n\n  const baseTop = triggerRect.bottom - containerRect.top;\n  const baseLeft = triggerRect.left - containerRect.left;\n  // 计算底部剩余空间，若剩余空间能够容纳 portal，则向下展示 portal\n  // 如果下方剩余空间无法容纳 portal，还需要判断上方空间能否容纳\n  // 若上方也无法容纳(triggerTop < height)，则仍然放到下方\n  // 左右则优先放右侧，不够之后向左偏移\n  const bottomSpace = containerRect.height - baseTop;\n  const rightSpace = containerRect.width - baseLeft;\n\n  const triggerTop = triggerRect.top - containerRect.top;\n  const triggerRight = triggerRect.right - containerRect.left;\n\n  const top =\n    bottomSpace < height && triggerTop > height\n      ? triggerTop + offsetY - height - 4 // 放到上方\n      : baseTop + offsetY;\n  const left =\n    rightSpace < width && triggerRight > width\n      ? baseLeft + offsetX - width + rightSpace - 4\n      : baseLeft + offsetX;\n  return { left, top };\n};\n\nconst stopEvent = (event: React.MouseEvent) => event.stopPropagation();\n\ntype PortalState = 'Hidden' | 'EditorVisible' | 'ToolbarVisible';\n\nconst LinkPortal: React.FC<LinkPortalProps> = (props) => {\n  const {\n    children,\n    text,\n    href,\n    locale,\n    controller,\n    mountRoot = false,\n  } = props;\n\n  const [portalState, setPortalState] = useDelayedState<PortalState>('Hidden');\n  const [overlayChanging, setOverlayChanging] = React.useState<boolean>(false);\n  const [hidingOverlay, setHidingOverlay] = React.useState<React.ReactElement | null>(null);\n\n\n\n  const onOverlayHide = React.useCallback(() => {\n    setHidingOverlay(null);\n    setOverlayChanging(false);\n  }, []);\n\n  const showEditor = React.useCallback(() => {\n    setPortalState('EditorVisible');\n  }, []);\n\n  const hideEditor = React.useCallback(() => {\n    setPortalState((s) => {\n      return s === 'EditorVisible' ? 'Hidden' : s;\n    });\n  }, []);\n\n  const showToolbar = React.useCallback(() => {\n    setPortalState((s) => {\n      return s === 'Hidden' || s === 'ToolbarVisible' ? 'ToolbarVisible' : s;\n    });\n  }, []);\n\n  const hideToolbar = React.useCallback(() => {\n    // toolbar 隐藏时设置延时，处理链接到卡片的 hover 情况\n    setPortalState((s) => {\n      return s === 'ToolbarVisible' ? 'Hidden' : s;\n    }, HIDE_TOOLBAR_DELAY_TIME);\n  }, []);\n  const defaultContent =  useZoomContainer() || document.body;\n  const scrollableContent = mountRoot ? document.body : defaultContent;\n  const zoom = useZoom();\n  const portalRef = React.useRef<HTMLDivElement>(null);\n  const linkRef = React.useRef<HTMLDivElement>(null);\n\n  const isPlaceholder = text === locale.addLinkPlaceholder;\n  const isEmptyHref = href.trim().length === 0;\n  const showStopEvent = portalState === 'EditorVisible' && (isPlaceholder || isEmptyHref);\n  const isNormalLink = (!isPlaceholder && !isEmptyHref);\n\n  // 这里在编辑模式下，显示编辑框\n  const editorPortal = useEditorPortal({ ...props, isEditMode: portalState === 'EditorVisible', onEditorHide: hideEditor, linkRef, portalRef, isPlaceholder });\n  const toolbarPortal = useToolbarPortal({ ...props, onSwitchToEdit: showEditor, showToolbar, hideToolbar, linkRef, portalRef, isPlaceholder });\n  const {\n    overlay: editorOverlay,\n    handleLinkMouseDown: handleEditorLinkMouseDown,\n    handleLinkClick: handleEditorLinkClick } = editorPortal;\n\n  const { overlay: toolbarOverlay,\n    handleLinkMouseDown,\n    handleLinkClick,\n  } = toolbarPortal;\n\n  const handleMouseEnter = React.useCallback(() => {\n    showToolbar();\n    controller.run('onAction', hoverLinkCard());\n  }, [controller, showToolbar]);\n\n  const overlay = portalState !== 'EditorVisible' ? toolbarOverlay : editorOverlay;\n\n  const handleClick = portalState !== 'EditorVisible' ? handleLinkClick : handleEditorLinkClick;\n\n  const prePortalState = usePrevious(portalState);\n\n  React.useEffect(() => {\n    const preVisible = prePortalState === 'EditorVisible' || prePortalState === 'ToolbarVisible';\n    const currentVisible = portalState === 'EditorVisible' || portalState === 'ToolbarVisible';\n\n    if (preVisible && !currentVisible) {\n      // 进行隐藏时，使用旧的 overlay 进行隐藏，避免动画过程中组件切换\n      setHidingOverlay(prePortalState !== 'EditorVisible' ? toolbarOverlay : editorOverlay)\n    } else if (preVisible && currentVisible && prePortalState !== portalState) {\n      // 显示状态下切换 overlay，先使用旧的 overlay 进行隐藏，再显示新的 overlay\n      setOverlayChanging(true);\n      setHidingOverlay(prePortalState !== 'EditorVisible' ? toolbarOverlay : editorOverlay);\n    }\n  }, [prePortalState, portalState])\n\n  return (\n    <Portal\n      className=\"bi-link-portal\"\n      visible={portalState !== 'Hidden' && !overlayChanging}\n      triggerRef={linkRef}\n      overlay={hidingOverlay || overlay}\n      portalMatchTrigger={false}\n      getPosition={getPosition}\n      onOverlayHide={onOverlayHide}\n      container={scrollableContent}\n      offset={offset}\n      zoom={zoom}\n    >\n      {React.cloneElement(children as React.ReactElement, {\n        onMouseDown: portalState !== 'EditorVisible' ? handleLinkMouseDown : handleEditorLinkMouseDown,\n        // 当点击占位符时，需要阻止事件冒泡，避免被 cangjie 处理\n        onMouseUp: showStopEvent ? stopEvent : undefined,\n        onClick: showStopEvent ? stopEvent : handleClick,\n        onMouseEnter: portalState !== 'EditorVisible' && isNormalLink ? handleMouseEnter : undefined,\n        onMouseLeave: portalState !== 'EditorVisible' ? hideToolbar : undefined,\n      })}\n    </Portal>\n  );\n};\n\nexport default LinkPortal;\n"],"file":"linkPortal.js"}