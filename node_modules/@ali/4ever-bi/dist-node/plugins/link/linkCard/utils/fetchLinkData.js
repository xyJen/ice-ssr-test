"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.fetchLinkData = fetchLinkData;

var _buildLinkCardData = _interopRequireDefault(require("./buildLinkCardData"));

async function fetchLinkData(node, controller, href, text, getLinkInfo, relatedId = null) {
  if (getLinkInfo && typeof getLinkInfo === 'function') {
    // 先设置卡片状态为 loading，并且为节点注入信息，处理交互兼容
    controller.command('setCardInjection', node, {
      isLoading: true
    }); // 展示卡片

    try {
      const info = await getLinkInfo(href);

      if (info) {
        // 请求成功
        const {
          imgURL = '',
          title = '',
          desc = ''
        } = info;
        const cardInfo = {
          imgURL,
          title,
          desc,
          displayType: 'card'
        }; // 清理注入信息

        controller.setOpRelatedId(relatedId).command('setCardInjection', node, {}).command('setCardData', node, (0, _buildLinkCardData.default)({
          text,
          href,
          cardInfo
        }));
        return;
      }
    } catch (e) {} finally {
      // 清理注入信息
      controller.command('setCardInjection', node, {});
    }
  }
}
//# sourceMappingURL=fetchLinkData.js.map