{"version":3,"sources":["../../../../../../src/plugins/link/linkCard/utils/fetchLinkData.ts"],"names":["fetchLinkData","node","controller","href","text","getLinkInfo","relatedId","command","isLoading","info","imgURL","title","desc","cardInfo","displayType","setOpRelatedId","e"],"mappings":";;;;;;;;;AAEA;;AAEO,eAAeA,aAAf,CACLC,IADK,EAELC,UAFK,EAGLC,IAHK,EAILC,IAJK,EAKLC,WALK,EAMLC,SAAwB,GAAG,IANtB,EAOL;AACA,MAAID,WAAW,IAAI,OAAOA,WAAP,KAAuB,UAA1C,EAAsD;AACpD;AACAH,IAAAA,UAAU,CAACK,OAAX,CAAmB,kBAAnB,EAAuCN,IAAvC,EAA6C;AAAEO,MAAAA,SAAS,EAAE;AAAb,KAA7C,EAFoD,CAGpD;;AACA,QAAI;AACF,YAAMC,IAAI,GAAG,MAAMJ,WAAW,CAACF,IAAD,CAA9B;;AACA,UAAIM,IAAJ,EAAU;AACR;AACA,cAAM;AAAEC,UAAAA,MAAM,GAAG,EAAX;AAAeC,UAAAA,KAAK,GAAG,EAAvB;AAA2BC,UAAAA,IAAI,GAAG;AAAlC,YAAyCH,IAA/C;AACA,cAAMI,QAAuB,GAAG;AAAEH,UAAAA,MAAF;AAAUC,UAAAA,KAAV;AAAiBC,UAAAA,IAAjB;AAAuBE,UAAAA,WAAW,EAAE;AAApC,SAAhC,CAHQ,CAIR;;AACAZ,QAAAA,UAAU,CACPa,cADH,CACkBT,SADlB,EAEGC,OAFH,CAEW,kBAFX,EAE+BN,IAF/B,EAEqC,EAFrC,EAGGM,OAHH,CAGW,aAHX,EAG0BN,IAH1B,EAGgC,gCAAkB;AAAEG,UAAAA,IAAF;AAAQD,UAAAA,IAAR;AAAcU,UAAAA;AAAd,SAAlB,CAHhC;AAIA;AACD;AACF,KAbD,CAaE,OAAOG,CAAP,EAAU,CAGX,CAhBD,SAgBU;AACR;AACAd,MAAAA,UAAU,CAACK,OAAX,CAAmB,kBAAnB,EAAuCN,IAAvC,EAA6C,EAA7C;AACD;AACF;AACF","sourcesContent":["import { Controller, Block } from '@ali/4ever-cangjie';\nimport { ILinkCardInfo, LinkPluginConfig } from '../../types';\nimport buildLinkCardData from './buildLinkCardData';\n\nexport async function fetchLinkData(\n  node: Block,\n  controller: Controller,\n  href: string,\n  text: string,\n  getLinkInfo?: LinkPluginConfig['getLinkInfo'],\n  relatedId: string | null = null,\n) {\n  if (getLinkInfo && typeof getLinkInfo === 'function') {\n    // 先设置卡片状态为 loading，并且为节点注入信息，处理交互兼容\n    controller.command('setCardInjection', node, { isLoading: true });\n    // 展示卡片\n    try {\n      const info = await getLinkInfo(href);\n      if (info) {\n        // 请求成功\n        const { imgURL = '', title = '', desc = '' } = info;\n        const cardInfo: ILinkCardInfo = { imgURL, title, desc, displayType: 'card' };\n        // 清理注入信息\n        controller\n          .setOpRelatedId(relatedId)\n          .command('setCardInjection', node, {})\n          .command('setCardData', node, buildLinkCardData({ text, href, cardInfo }));\n        return;\n      }\n    } catch (e) {\n      // 获取信息失败，不添加任何数据\n      console.debug(e);\n    } finally {\n      // 清理注入信息\n      controller.command('setCardInjection', node, {});\n    }\n  }\n}\n"],"file":"fetchLinkData.js"}