"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _everCangjie = require("@ali/4ever-cangjie");

var _everUtils = require("@ali/4ever-utils");

var _setListLevelByIntent = require("../utils/setListLevelByIntent");

var _utils = require("../utils");

var _default = (editor, trigger, givenValue) => {
  const {
    value
  } = editor;
  const indentVal = givenValue !== undefined ? givenValue : _utils.INDENT_SIZE;
  let selectedBlocks = (0, _everUtils.getBlocksFromEditor)(editor);
  const {
    depthItems,
    hasFirstStart
  } = editor.query('getListDepthItems') || {};

  if (hasFirstStart) {
    selectedBlocks = depthItems;
  }

  selectedBlocks.forEach(node => {
    const indentNode = (0, _everUtils.getClosestParagraph)(value, node);

    if (indentNode) {
      const indentNodeData = indentNode.data || {};
      const {
        list
      } = indentNodeData;

      if (list) {
        return (0, _setListLevelByIntent.increaseListLevel)(editor, indentNode, hasFirstStart);
      }

      const ind = indentNodeData.ind || {}; // data.ind can be null

      const nextInd = { ...ind
      };
      const {
        firstLine = 0,
        firstLineChars = 0,
        left = 0,
        leftChars = 0,
        hanging = 0,
        hangingChars = 0
      } = ind;
      const firstLineIndent = firstLineChars || firstLine;
      const hangingIndent = hangingChars || hanging || firstLine < 0;

      switch (trigger) {
        case _utils.IndentTrigger.keyboard:
          if (hangingIndent) {
            // 取消悬挂缩进
            // 如果已经存在 leftChars 则保留左缩进
            // 否则增加左侧缩进，@wps/word
            delete nextInd.hanging;
            delete nextInd.hangingChars;

            if (firstLine < 0) {
              delete nextInd.firstLine;
            } // hangingChars 存在时 left 会被忽略


            const realLeft = hangingChars ? leftChars : leftChars || left;

            if (!realLeft) {
              nextInd.left = _utils.INDENT_SIZE;
            }
          } else if (!firstLineIndent) {
            // 首先增加首行缩进
            nextInd.firstLine = _utils.INDENT_SIZE;
          } else if (leftChars) {
            // 增加两字符
            nextInd.leftChars = Math.min(leftChars + _utils.INDENT_SIZE_CHARS, _utils.MAX_INDENT_SIZE_CHARS);
            nextInd.left = nextInd.leftChars / _utils.INDENT_SIZE_CHARS * _utils.INDENT_SIZE;
          } else {
            nextInd.left = Math.min(left + _utils.INDENT_SIZE, _utils.MAX_INDENT_SIZE);
          }

          break;

        default:
          if (hangingIndent || leftChars) {
            // 悬挂缩进存在时需要增加 leftChars
            nextInd.leftChars = Math.min(leftChars + _utils.INDENT_SIZE_CHARS, _utils.MAX_INDENT_SIZE_CHARS);
            nextInd.left = nextInd.leftChars / _utils.INDENT_SIZE_CHARS * _utils.INDENT_SIZE;
          } else {
            nextInd.left = Math.min(left + indentVal, _utils.MAX_INDENT_SIZE);
          }

      }

      if ((0, _everUtils.isEqualWithDefault)(nextInd, ind, _utils.DEFAULT_INDENT)) {
        return undefined;
      }

      editor.command(_everCangjie.Commands.setNodeByKey, indentNode.key, {
        data: { ...indentNodeData,
          ind: nextInd
        }
      });
    }

    return undefined;
  });
  return editor;
};

exports.default = _default;
//# sourceMappingURL=increaseIndent.js.map