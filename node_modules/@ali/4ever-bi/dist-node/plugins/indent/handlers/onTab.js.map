{"version":3,"sources":["../../../../../src/plugins/indent/handlers/onTab.ts"],"names":["onTab","event","editor","next","value","document","query","preventDefault","selection","currentParagraph","isAtStartofParagraph","getStart","isAtStartOfNode","selectedBlocks","selectedMultiBlocks","length","selectedAllBlock","isExpanded","shiftKey","isCollapsed","IndentTrigger","keyboard","toolbar","command","Commands","del","insertText","currentItems","data","list"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { Controller, Commands } from '@ali/4ever-cangjie';\n;\nimport decreaseIndent from '../commands/decreaseIndent';\nimport increaseIndent from '../commands/increaseIndent';\nimport { getBlocksFromEditor }  from '@ali/4ever-utils';\nimport { getClosestParagraph } from '@ali/4ever-utils';\nimport { IndentTrigger } from '../utils';\n\n\nexport default function onTab(event: React.KeyboardEvent, editor: Controller, next: Function) {\n  const { value } = editor;\n  const { document } = value;\n  if (editor.query('isSelectionInTableCell')) {\n    return next();\n  }\n  event.preventDefault();\n  const { selection } = value;\n  if (!selection) return next();\n\n  const currentParagraph = getClosestParagraph(value);\n  if (!currentParagraph) return next();\n  const isAtStartofParagraph = selection ? selection.getStart(document).isAtStartOfNode(currentParagraph) : null;\n  const selectedBlocks = getBlocksFromEditor(editor);\n  const selectedMultiBlocks = selectedBlocks.length > 1;\n  let selectedAllBlock = false;\n  if (selection.isExpanded && editor.query('isSelectWholeBlocks')) {\n    selectedAllBlock = true;\n  }\n\n  if (event.shiftKey && isAtStartofParagraph) {\n    /* 在段首且没有选区时，逻辑和“减少缩进”按钮相同 */\n    if (selection.isCollapsed) {\n      return decreaseIndent(editor, IndentTrigger.keyboard);\n    }\n\n    /* 在段首有选区时：\n     * 1. 选中多段或整段选中时视为仅减少缩进\n     * 2. 否则先删除选区内容再执行减少缩进逻辑\n    */\n    if (selectedMultiBlocks || selectedAllBlock) {\n      return decreaseIndent(editor, IndentTrigger.toolbar);\n    }\n    editor.command(Commands.del);\n    return decreaseIndent(editor, IndentTrigger.keyboard);\n  }\n\n  if (selection.isCollapsed) {\n    if (!isAtStartofParagraph) {\n      // 未选中且在段内时\n      return editor.command(Commands.insertText, '    ');\n    }\n\n    const currentItems = editor.query('getListCurrentItem');\n    if (currentItems?.length && currentItems[0]?.data?.list) {\n      // 不处理列表\n      return next();\n    }\n    return increaseIndent(editor, IndentTrigger.keyboard);\n  }\n\n  if (!isAtStartofParagraph) {\n    // 不在段首且选中时：先删除后插入tab\n    return editor.command(Commands.del).command(Commands.insertText, '    ');\n  }\n\n  const currentItems = editor.query('getListCurrentItem');\n  if (currentItems?.length && currentItems[0]?.data?.list) {\n    return next();\n  }\n\n  if (selectedMultiBlocks || selectedAllBlock) {\n    return increaseIndent(editor, IndentTrigger.toolbar);\n  }\n  editor.command('deleteAtRange', selection!);\n  return increaseIndent(editor, IndentTrigger.keyboard);\n}\n"],"file":"onTab.js"}