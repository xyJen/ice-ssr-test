"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = createOnChange;

var _everCangjie = require("@ali/4ever-cangjie");

var _newlineGuide = require("../model/newlineGuide");

var _actions = require("../actions");

function createOnChange(config) {
  const newlineGuideEnabled = config.newlineGuide?.enabled;
  return (controller, next) => {
    if (!newlineGuideEnabled || _everCangjie.environment.IS_MOBILE) return next();
    const {
      triggered,
      point,
      query
    } = _newlineGuide.NewlineGuideData.get(controller) || {};
    const {
      selection,
      document,
      composing
    } = controller.value;
    const anchor = selection.anchor;

    if (!triggered || composing) {
      return next();
    }

    if (point?.key === anchor?.key && point?.offset <= anchor?.offset) {
      // 下拉弹窗弹出时计算query
      const node = document.getNode(point.key);
      const newQuery = node?.text.substring(point.offset, anchor?.offset) || '';
      if (query === newQuery) return next();

      if (newQuery.includes(' ')) {
        controller.run('onAction', (0, _actions.removeNewlineData)());
        return next();
      }

      controller.run('onAction', (0, _actions.setNewlineData)({
        query: newQuery
      }));
    }

    return next();
  };
}
//# sourceMappingURL=createOnChange.js.map