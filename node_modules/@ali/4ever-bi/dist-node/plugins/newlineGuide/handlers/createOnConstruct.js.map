{"version":3,"sources":["../../../../../src/plugins/newlineGuide/handlers/createOnConstruct.ts"],"names":["createOnConstruct","config","newlineGuideEnabled","newlineGuide","enabled","controller","next","environment","IS_MOBILE","enableHots","isPendingEnable","onInput","triggered","point","query","NewlineGuideData","get","selection","document","composing","value","anchor","key","offset","node","getNode","newQuery","text","substring","includes","run","inputData$","subscribe","hots$","pendingType","PendingType","input"],"mappings":";;;;;;;AAAA;;AAEA;;AACA;;AAEe,SAASA,iBAAT,CAA2BC,MAA3B,EAAmD;AAChE,QAAMC,mBAAmB,GAAGD,MAAM,CAACE,YAAP,EAAqBC,OAAjD;AACA,SAAO,CAACC,UAAD,EAAyBC,IAAzB,KAA4C;AACjD,QAAI,CAACJ,mBAAD,IAAwBK,yBAAYC,SAAxC,EAAmD,OAAOF,IAAI,EAAX;;AAEnD,QAAID,UAAU,CAACI,UAAX,IAAyBJ,UAAU,CAACK,eAAxC,EAAyD;AACvD,YAAMC,OAAO,GAAG,MAAM;AACpB,cAAM;AAAEC,UAAAA,SAAF;AAAaC,UAAAA,KAAb;AAAoBC,UAAAA;AAApB,YAA+BC,+BAAiBC,GAAjB,CAAqBX,UAArB,KACnC,EADF;AAEA,cAAM;AAAEY,UAAAA,SAAF;AAAaC,UAAAA,QAAb;AAAuBC,UAAAA;AAAvB,YAAqCd,UAAU,CAACe,KAAtD;AACA,cAAMC,MAAM,GAAGJ,SAAS,CAACI,MAAzB;;AACA,YAAI,CAACT,SAAD,IAAcO,SAAlB,EAA6B;AAC3B,iBAAOb,IAAI,EAAX;AACD;;AACD,YAAIO,KAAK,EAAES,GAAP,KAAeD,MAAM,EAAEC,GAAvB,IAA8BT,KAAK,EAAEU,MAAP,IAAiBF,MAAM,EAAEE,MAA3D,EAAmE;AACjE;AACA,gBAAMC,IAAI,GAAGN,QAAQ,CAACO,OAAT,CAAiBZ,KAAK,CAACS,GAAvB,CAAb;AACA,gBAAMI,QAAQ,GACZF,IAAI,EAAEG,IAAN,CAAWC,SAAX,CAAqBf,KAAK,CAACU,MAA3B,EAAmCF,MAAM,EAAEE,MAA3C,KAAsD,EADxD;AAEA,cAAIT,KAAK,KAAKY,QAAd,EAAwB,OAAOpB,IAAI,EAAX;;AACxB,cAAIoB,QAAQ,CAACG,QAAT,CAAkB,GAAlB,CAAJ,EAA4B;AAC1BxB,YAAAA,UAAU,CAACyB,GAAX,CAAe,UAAf,EAA2B,iCAA3B;AACA,mBAAOxB,IAAI,EAAX;AACD;;AACDD,UAAAA,UAAU,CAACyB,GAAX,CACE,UADF,EAEE,6BAAe;AACbhB,YAAAA,KAAK,EAAEY;AADM,WAAf,CAFF;AAMD;AACF,OAzBD;AA0BA;AACN;AACA;AACA;AACA;;;AACMrB,MAAAA,UAAU,CAAC0B,UAAX,CAAsBC,SAAtB,CAAgCrB,OAAhC;AACAN,MAAAA,UAAU,CAAC4B,KAAX,CAAiBD,SAAjB,CAA2B,MAAM;AAC/B,YAAI3B,UAAU,CAAC6B,WAAX,KAA2BC,yBAAYC,KAA3C,EAAkD;AAChDzB,UAAAA,OAAO;AACR;AACF,OAJD;AAKD;;AAED,WAAOL,IAAI,EAAX;AACD,GA5CD;AA6CD","sourcesContent":["import { Controller, environment, TextPoint, PendingType } from '@ali/4ever-cangjie';\nimport { BiPluginConfig } from '../../../types';\nimport { NewlineGuideData } from '../model/newlineGuide';\nimport { setNewlineData, removeNewlineData } from '../actions';\n\nexport default function createOnConstruct(config: BiPluginConfig) {\n  const newlineGuideEnabled = config.newlineGuide?.enabled;\n  return (controller: Controller, next: Function) => {\n    if (!newlineGuideEnabled || environment.IS_MOBILE) return next();\n\n    if (controller.enableHots || controller.isPendingEnable) {\n      const onInput = () => {\n        const { triggered, point, query } = (NewlineGuideData.get(controller) ||\n          {}) as { triggered?: boolean; point?: TextPoint; query?: string };\n        const { selection, document, composing } = controller.value;\n        const anchor = selection.anchor as TextPoint;\n        if (!triggered || composing) {\n          return next();\n        }\n        if (point?.key === anchor?.key && point?.offset <= anchor?.offset) {\n          // 下拉弹窗弹出时计算query\n          const node = document.getNode(point.key);\n          const newQuery =\n            node?.text.substring(point.offset, anchor?.offset) || '';\n          if (query === newQuery) return next();\n          if (newQuery.includes(' ')) {\n            controller.run('onAction', removeNewlineData());\n            return next();\n          }\n          controller.run(\n            'onAction',\n            setNewlineData({\n              query: newQuery,\n            }),\n          );\n        }\n      };\n      /**\n       * 在Pending场景下，onchange获取到的query可能会出现迟滞的情况，所以这里需要inputData$来及时更新搜素内容\n       * 但是这里只针对进行英文输入的场景，中文输入法下，输入完成后会立即flush，所以inputData$不会触发\n       * 所以pending场景还是会走一遍onchange来确保中文输入法query正确\n       */\n      controller.inputData$.subscribe(onInput);\n      controller.hots$.subscribe(() => {\n        if (controller.pendingType === PendingType.input) {\n          onInput()\n        }\n      });\n    }\n\n    return next();\n  };\n}\n"],"file":"createOnConstruct.js"}