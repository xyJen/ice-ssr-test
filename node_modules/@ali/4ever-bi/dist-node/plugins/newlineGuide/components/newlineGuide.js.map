{"version":3,"sources":["../../../../../src/plugins/newlineGuide/components/newlineGuide.tsx"],"names":["closeContextMenu","PcContextMenu","MAX_ERROR_NUM","useActiveInteraction","ActiveInteractionHooks","NewlineGuide","props","uiVisible","React","useRef","guideStyle","setGuideStyle","useState","top","left","triggerStyle","setTriggerStyle","width","height","controller","renderGuideMenu","locale","zoom","enableKeyboard","onClickGuideMenu","withoutEmptyParagraphWhitelist","document","injections","selection","isFocused","value","enabled","useMemo","isCollapsed","startBlock","triggered","key","query","NewlineGuideData","get","blockKey","split","isInTable","showMenu","container","window","body","menuContainer","errorNumRef","handleVisibleChange","current","run","getMenuContainer","useEffect","caret","domUtils","findDOMRange","caretRect","getClientRects","caretTop","caretHeight","caretLeft","containerTop","containerLeft","getBoundingClientRect","guideLeft","editorContainerParent","querySelector","constants","Selector","editable","parentElement","padding","Number","parseInt","getComputedStyle","paddingLeft","nodes","closeContext","useCallback","onQuery","results","length","guideMenu","logger","sum","activeType","setActiveType","activeRef","ReactDOM","createPortal"],"mappings":"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","sourcesContent":["import React from 'react';\nimport ReactDOM from 'react-dom';\nimport { Controller, useSelectionData, useZoomContainer, domUtils, constants } from '@ali/4ever-cangjie';\nimport {\n  useScrollableContent,\n  PcContextMenu,\n} from '@ali/4ever-bamboo';\nimport { ActiveInteractionHooks } from '@ali/4ever-component';\nimport { Dropdown } from '@ali/we-design';\nimport logger from '@ali/4ever-logger';\nimport { DropdownAnimation } from '@ali/we-util';\nimport { MatchItemResult } from '@ali/4ever-utils';\nimport { NewlineGuideData } from '../model/newlineGuide';\nimport {\n  GuideWrapper,\n} from './styled';\nimport GuideMenu from './guideMenu';\nimport { removeNewlineData, setNewlineData } from '../actions';\nimport { NewlineGuidePluginConfig } from '../types';\n;\nimport getStartBlock from '../utils/getStartBlock';\n\nexport interface NewlineGuideProps extends NewlineGuidePluginConfig {\n  controller: Controller;\n  placeholder: string | React.ReactElement<any, string | React.JSXElementConstructor<any>>;\n  locale?: Record<string, string>;\n  zoom?: number;\n  enableKeyboard?: boolean;\n}\n\nconst { closeContextMenu } = PcContextMenu;\n\nconst MAX_ERROR_NUM = 1;\n\nconst { useActiveInteraction } = ActiveInteractionHooks;\n\nconst NewlineGuide: React.FC<NewlineGuideProps> = (props) => {\n  const uiVisible = React.useRef<boolean>(false);\n  const [guideStyle, setGuideStyle] = React.useState({\n    top: -9999,\n    left: -9999,\n  });\n\n  const [triggerStyle, setTriggerStyle] = React.useState({\n    width: 2,\n    height: 0,\n  });\n\n  const { controller, renderGuideMenu, locale, zoom = 1, enableKeyboard, onClickGuideMenu, withoutEmptyParagraphWhitelist } = props;\n  const { document, injections, selection, isFocused } = controller.value;\n  // 失焦或选中内容不显示\n  const enabled = React.useMemo(\n    () => isFocused && selection.isCollapsed,\n    [isFocused, selection],\n  );\n  const startBlock = getStartBlock(controller);\n  const { triggered, key, query } = NewlineGuideData.get(controller) || {};\n  // 这里只能从 renderController 中拿到 viewKey\n  // 通过 onCangjieInput hook 拿到的是 dataKey，且无法通过 action 劫持转换\n  // 通过 点击 触发给到的 key 是这里转换后的后的 dataKey\n  // 因此我们确保：NewlineGuideData.key 一定是 dataKey，而 viewKey 转换 dataKey 方法是相对固定的\n  const [blockKey] = (startBlock?.key || '').split('-');\n  const isInTable = controller.query('isNodeInTable', startBlock);\n  // 当且仅当 focused 在 当前行时 展示面板\n  const showMenu = triggered && key === blockKey;\n\n  const container = useZoomContainer() || window.document.body;\n  const menuContainer = useScrollableContent() || window.document.body;\n\n  const errorNumRef = React.useRef<number>(0);\n\n  const handleVisibleChange = (value: boolean) => {\n    if (!value && showMenu) {\n      uiVisible.current = false;\n      controller.run('onAction', removeNewlineData());\n    }\n  };\n\n  const getMenuContainer = () => {\n    return menuContainer;\n  };\n\n  React.useEffect(() => {\n    if (!enabled && triggered) {\n      // 失焦、有选区存在时 removeNewlineData\n      controller.run('onAction', removeNewlineData());\n    }\n  }, [controller, enabled, triggered]);\n\n  React.useEffect(() => {\n    if (!enabled) {\n      return;\n    }\n    // 支持光标 pending 后，需要保证最新的光标渲染完以后再计算位置，否则可能位置不正确\n    if (blockKey && (isInTable || showMenu)) {\n      // 根据目标位置计算光标 Rect\n      // Tips: 不能依赖光标 dom 节点的位置，在 Safari 下的 useEffect、setTimeout 时序会不稳定，导致读取的位置有误\n      const caret = domUtils.findDOMRange(controller.value.selection, controller, container);\n      const caretRect = caret?.getClientRects()[0];\n      // 根据块级元素和光标的位置计算控件位置，以便在任何字号、行高下都对齐光标中间\n      if (caret && caretRect) {\n        const { top: caretTop, height: caretHeight, left: caretLeft } = caretRect;\n        const { top: containerTop, left: containerLeft } = container.getBoundingClientRect();\n        const guideLeft = (caretLeft - containerLeft) / zoom;\n        setGuideStyle({\n          // 光标中间 - 段落顶部 = 控件相对段落的 top\n          top: (caretTop + caretHeight / 2 - containerTop) / zoom,\n          left: guideLeft,\n        });\n        setTriggerStyle({\n          width: 2,\n          height: caretHeight,\n        });\n\n        // 这里需要获取container的padding值，然后计算出插入按钮应该在的位置\n        // PS 这里应该是获取 container 下 [data-cangjie-editable] 元素的 parent 的 padding\n        // 非排版模式下，这个 parent 就是 container，而在排版模式下，这个 container 与 [data-cangjie-editable] 之间有个夹层\n        const editorContainerParent = container?.querySelector(`[${constants.Selector.editable}]`)?.parentElement;\n        let padding = 0;\n        if (editorContainerParent) {\n          padding = Number.parseInt(window.getComputedStyle(editorContainerParent).paddingLeft, 10);\n        }\n      }\n    }\n    // document.nodes、injections 需要作为依赖以便兼容某些 node 导致高度变化的情况（例如插入本地文件上传完成后自动变为预览模式）\n  }, [enabled, isInTable, showMenu, blockKey, container, zoom, document.nodes, injections, query]);\n\n  const closeContext = React.useCallback(() => {\n    controller.run('onAction', closeContextMenu());\n  }, [controller]);\n\n  const onQuery = React.useCallback((results: Array<MatchItemResult<{}>>) => {\n    if (!query || !results || results.length > 0) {\n      controller.run('onAction', setNewlineData({\n        showMenu: true,\n      }));\n      errorNumRef.current = 0;\n      return;\n    }\n    controller.run('onAction', setNewlineData({\n      showMenu: false,\n    }));\n    if (errorNumRef.current > MAX_ERROR_NUM) {\n      controller.run('onAction', removeNewlineData());\n      errorNumRef.current = 0;\n    } else {\n      errorNumRef.current += 1;\n    }\n  }, [query, controller]);\n\n  const guideMenu = React.useMemo(() => {\n    if (!enabled || !showMenu || !renderGuideMenu) return null;\n    // 埋点：区分点击和+\n    logger.sum(`newline_insert_show_by_${uiVisible.current ? 'click' : '+'}`);\n    // 右键菜单栏和插入工具栏需要互斥展示\n    closeContext();\n    return (\n      <GuideMenu withoutEmptyParagraphWhitelist={withoutEmptyParagraphWhitelist} query={query} controller={controller} enableKeyboard={enableKeyboard} onClickGuideMenu={onClickGuideMenu}>\n        {renderGuideMenu(query, onQuery)}\n      </GuideMenu>\n    );\n  }, [enabled, showMenu, renderGuideMenu, controller, enableKeyboard, onClickGuideMenu, query, closeContext, onQuery, withoutEmptyParagraphWhitelist]);\n\n  const [activeType, setActiveType] = useActiveInteraction();\n  const activeRef  = React.useRef('');\n  activeRef.current = activeType;\n\n  React.useEffect(() => {\n    if (showMenu) {\n      setActiveType('insertMenu');\n    } else if (activeRef.current === 'insertMenu') {\n      setActiveType('');\n    }\n  }, [showMenu, setActiveType]);\n\n  if (!enabled) {\n    return null;\n  }\n\n  // dropdown 组件placement向上位置计算存在问题\n  return ReactDOM.createPortal((\n    <GuideWrapper\n      style={guideStyle}\n    >\n      {showMenu ?\n        <Dropdown\n          overlay={\n            <DropdownAnimation\n              visible={showMenu}\n            >\n              {guideMenu}\n            </DropdownAnimation>\n          }\n          visible={showMenu}\n          getContainer={getMenuContainer}\n          onVisibleChange={handleVisibleChange}\n          placement=\"bottomLeft\"\n          overlayAutoAlign\n        >\n          <i style={triggerStyle} />\n        </Dropdown> : null}\n    </GuideWrapper>\n  ), container);\n};\n\nexport default NewlineGuide;\n"],"file":"newlineGuide.js"}