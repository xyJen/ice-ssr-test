{"version":3,"sources":["../../../../../src/plugins/formula/components/content.tsx"],"names":["calcuSize","FormulaPlugin","isEnterHotKey","isEscHotKey","isMobile","environment","IS_MOBILE","FormulaWrapper","styled","div","React","memo","props","isEditing","setIsEditing","modelFormulaData","node","data","metadata","formula","setFormula","controller","config","isSelected","startInline","selection","value","readOnly","currentFormula","textareaRef","isPlaceholder","locale","onTextareaChange","text","onClickConfirm","nextFormula","trim","tagData","run","onKeyDown","e","basicActions","createFocusToNodeAction","key","onClickButton","handleEnter","event","Tag","isTag","isCollapsed","preventDefault","stopPropagation","current","focus","document","addEventListener","removeEventListener","getContainer","bodyEle","body","querySelector","onVisibleChange","visible","placeholder","formulaView","formulaTextarea","renderContent","showPlaceholder","content"],"mappings":";;;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAEA;;AACA;;AACA;;AACA;;AACA;;uBAX4B,a;AAa5B,MAAM;AAAEA,EAAAA;AAAF,IAAgBC,yBAAtB;AAEA,MAAMC,aAAa,GAAG,uBAAY,OAAZ,CAAtB;AACA,MAAMC,WAAW,GAAG,uBAAY,KAAZ,CAApB;AAOA,MAAMC,QAAQ,GAAGC,yBAAYC,SAA7B;;AAEA,MAAMC,cAAc,gBAAGC,0BAAOC,GAAV,0QAApB;;4BAaeC,eAAMC,IAAN,CAAYC,KAAD,IAAyB;AACjD,QAAM,CAACC,SAAD,EAAYC,YAAZ,IAA4B,qBAAS,KAAT,CAAlC;AAEA,QAAMC,gBAAgB,GAAGH,KAAK,CAACI,IAAN,CAAWC,IAAX,CAAgBC,QAAhB,CAAyBC,OAAzB,IAAoC,EAA7D,CAHiD,CAKjD;;AACA,QAAM,CAACA,OAAD,EAAUC,UAAV,IAAwB,qBAAwBL,gBAAxB,CAA9B;AAEA,QAAM;AAAEC,IAAAA,IAAF;AAAQK,IAAAA,UAAR;AAAoBC,IAAAA,MAApB;AAA4BC,IAAAA;AAA5B,MAA2CX,KAAjD;AAEA,QAAM;AAAEY,IAAAA,WAAF;AAAeC,IAAAA;AAAf,MAA6BJ,UAAU,CAACK,KAA9C;AAEA,QAAM;AAAEC,IAAAA;AAAF,MAAeN,UAArB;AAEA,QAAMO,cAAc,GAAGT,OAAO,KAAK,IAAZ,GAAmBJ,gBAAnB,GAAsCI,OAA7D;AAEA,QAAMU,WAAW,GAAG,mBAA4B,IAA5B,CAApB;AAEA,QAAMC,aAAa,GAAG,CAACF,cAAvB,CAlBiD,CAoBjD;;AACA,QAAMG,MAAM,GAAGT,MAAM,EAAES,MAAR,IAAkB,EAAjC;AAEA,QAAMC,gBAAgB,GAAG,wBAAaC,IAAD,IAAkB;AACrDb,IAAAA,UAAU,CAACa,IAAD,CAAV;AACD,GAFwB,EAEtB,EAFsB,CAAzB;AAIA,QAAMC,cAAc,GAAG,wBAAY,MAAM;AACvC,UAAMC,WAAW,GAAGP,cAAc,CAACQ,IAAf,EAApB;;AAEA,QAAIrB,gBAAgB,KAAKoB,WAAzB,EAAsC;AACpC,YAAME,OAAO,GAAG,EACd,GAAGrC,SAAS,CAACmC,WAAD,CADE;AAEdjB,QAAAA,QAAQ,EAAE;AACRC,UAAAA,OAAO,EAAEgB;AADD;AAFI,OAAhB;AAMAd,MAAAA,UAAU,CAACiB,GAAX,CAAe,UAAf,EAA2B,6BAAetB,IAAf,EAAqBqB,OAArB,CAA3B;AACD;AACF,GAZsB,EAYpB,CAACtB,gBAAD,EAAmBa,cAAnB,EAAmCP,UAAnC,EAA+CL,IAA/C,CAZoB,CAAvB;AAcA,QAAMuB,SAAS,GAAG,wBAAaC,CAAD,IAAyC;AACrE,QAAI3B,SAAS,IAAIV,WAAW,CAACqC,CAAD,CAA5B,EAAiC;AAC/B1B,MAAAA,YAAY,CAAC,KAAD,CAAZ;AACAoB,MAAAA,cAAc;AAEdb,MAAAA,UAAU,CAACiB,GAAX,CAAe,UAAf,EAA2BG,2BAAaC,uBAAb,CAAqC;AAAE1B,QAAAA;AAAF,OAArC,CAA3B;AACD;AACF,GAPiB,EAOf,CAACH,SAAD,EAAYQ,UAAZ,EAAwBL,IAAI,CAAC2B,GAA7B,EAAkCT,cAAlC,CAPe,CAAlB;AASA,QAAMU,aAAa,GAAG,wBAAY,MAAM;AACtCV,IAAAA,cAAc;AACdpB,IAAAA,YAAY,CAAC,KAAD,CAAZ;AACD,GAHqB,EAGnB,CAACoB,cAAD,CAHmB,CAAtB;AAKA,wBAAU,MAAM;AACd,UAAMjB,IAAI,GAAGjB,SAAS,CAAC4B,cAAD,CAAtB;AACAP,IAAAA,UAAU,CAACiB,GAAX,CAAe,UAAf,EAA2B,kCAAoBtB,IAAI,CAAC2B,GAAzB,EAA8B1B,IAA9B,CAA3B;AACD,GAHD,EAGG,CAACW,cAAD,EAAiBP,UAAjB,EAA6BL,IAAI,CAAC2B,GAAlC,CAHH;AAKA,wBAAU,MAAM;AACd,UAAME,WAAW,GAAIC,KAAD,IAA0B;AAC5C,UACE5C,aAAa,CAAC4C,KAAD,CAAb,IACAC,YAAIC,KAAJ,CAAUxB,WAAV,CADA,IAEAC,SAAS,CAACwB,WAFV,IAGAzB,WAAW,CAACmB,GAAZ,KAAoB3B,IAAI,CAAC2B,GAJ3B,EAKE;AACAG,QAAAA,KAAK,CAACI,cAAN;AACAJ,QAAAA,KAAK,CAACK,eAAN;AAEArC,QAAAA,YAAY,CAAC,IAAD,CAAZ;AACAe,QAAAA,WAAW,CAACuB,OAAZ,IAAuBvB,WAAW,CAACuB,OAAZ,CAAoBC,KAApB,EAAvB;AACD;AACF,KAbD;;AAeAC,IAAAA,QAAQ,CAACC,gBAAT,CAA0B,SAA1B,EAAqCV,WAArC;AACA,WAAO,MAAM;AACXS,MAAAA,QAAQ,CAACE,mBAAT,CAA6B,SAA7B,EAAwCX,WAAxC;AACD,KAFD;AAGD,GApBD,EAoBG,CAAChB,WAAD,EAAcL,WAAd,EAA2BC,SAA3B,EAAsCT,IAAI,CAAC2B,GAA3C,CApBH;AAsBA,QAAMc,YAAY,GAAG,wBAAY,MAAM;AACrC,UAAMC,OAAO,GAAGJ,QAAQ,CAACK,IAAzB;AACA,WAAOL,QAAQ,CAACM,aAAT,CAAuB,2BAAvB,KAAuDF,OAA9D;AACD,GAHoB,EAGlB,EAHkB,CAArB;AAKA,QAAMG,eAAe,GAAG,wBAAaC,OAAD,IAAsB;AACxDhD,IAAAA,YAAY,CAACgD,OAAD,CAAZ;;AAEA,QAAI,CAACA,OAAL,EAAc;AACZ5B,MAAAA,cAAc;AACf,KAFD,MAEO;AACLL,MAAAA,WAAW,CAACuB,OAAZ,IAAuBvB,WAAW,CAACuB,OAAZ,CAAoBC,KAApB,EAAvB;AACD;AACF,GARuB,EAQrB,CAACxB,WAAD,EAAcK,cAAd,CARqB,CAAxB;AAUA,QAAM6B,WAAW,GAAG,oBAAQ,MAAM;AAChC,wBACE,eAAC,oBAAD;AACE,MAAA,MAAM,EAAEhC,MADV;AAEE,MAAA,UAAU,EAAEJ,QAAQ,IAAIvB,QAF1B;AAGE,MAAA,UAAU,EAAEmB,UAHd;AAIE,MAAA,SAAS,EAAEV;AAJb,MADF;AAQD,GATmB,EASjB,CAACc,QAAD,EAAWI,MAAX,EAAmBR,UAAnB,EAA+BV,SAA/B,CATiB,CAApB;;AAjGiD,0BA8G7C,eAAC,aAAD;AACE,IAAA,OAAO,EAAEe,cADX;AAEE,IAAA,SAAS,EAAEf,SAFb;AAGE,IAAA,UAAU,EAAEU;AAHd,IA9G6C;;AA4GjD,QAAMyC,WAAW,GAAG,oBAAQ,MAAM;AAChC;AAOD,GARmB,EAQjB,CAACpC,cAAD,EAAiBf,SAAjB,EAA4BU,UAA5B,CARiB,CAApB;;AA5GiD,2BAwH7C,eAAC,iBAAD;AACE,IAAA,MAAM,EAAEQ,MADV;AAEE,IAAA,OAAO,EAAEH,cAFX;AAGE,IAAA,MAAM,EAAEN,MAHV;AAIE,IAAA,WAAW,EAAEO,WAJf;AAKE,IAAA,QAAQ,EAAEG,gBALZ;AAME,IAAA,aAAa,EAAEY;AANjB,IAxH6C;;AAsHjD,QAAMqB,eAAe,GAAG,oBAAQ,MAAM;AACpC;AAUD,GAXuB,EAWrB,CAAClC,MAAD,EAASH,cAAT,EAAyBC,WAAzB,EAAsCP,MAAtC,EAA8CU,gBAA9C,EAAgEY,aAAhE,CAXqB,CAAxB;AAaA,QAAMsB,aAAa,GAAG,oBAAQ,MAAM;AAClC,UAAMC,eAAe,GAAGrC,aAAa,IAAI,CAACF,cAA1C;AACA,UAAMwC,OAAO,GAAGD,eAAe,GAAGJ,WAAH,GAAiBC,WAAhD;;AAEA,QAAIrC,QAAQ,IAAIvB,QAAhB,EAA0B;AACxB,aAAOgE,OAAP;AACD;;AAED,wBACE,eAAC,kBAAD;AACE,MAAA,OAAO,EAAC,OADV;AAEE,MAAA,YAAY,EAAEX,YAFhB;AAGE,MAAA,OAAO,EAAEQ,eAHX;AAIE,MAAA,OAAO,EAAEpD,SAJX;AAKE,MAAA,eAAe,EAAEgD,eALnB;AAME,MAAA,SAAS,EAAC,YANZ;AAOE,MAAA,gBAAgB,EAAC,mBAPnB;AAQE,MAAA,MAAM,EAAE;AARV,oBAUE,4BAAMO,OAAN,CAVF,CADF;AAcD,GAtBqB,EAsBnB,CACDtC,aADC,EAEDjB,SAFC,EAGDkD,WAHC,EAIDC,WAJC,EAKDrC,QALC,EAMD8B,YANC,EAODQ,eAPC,EAQDJ,eARC,EASDjC,cATC,CAtBmB,CAAtB;AAkCA,sBACE,eAAC,cAAD;AACE,qCADF;AAEE,IAAA,SAAS,EAAEW;AAFb,KAIG2B,aAJH,CADF;AAQD,CA7Kc,C","sourcesContent":["import React, { useCallback, useEffect, useRef, useState, useMemo } from 'react';\nimport styled from 'styled-components';\nimport { environment, RenderNodeProps, Element } from '@ali/4ever-cangjie';\nimport { Tag } from '@ali/4ever-mo';\nimport { FormulaPlugin } from '@ali/4ever-bamboo';\nimport { Dropdown } from '@ali/we-design';\nimport isKeyHotkey from 'is-hotkey';\nimport { FormulaConfig } from '../types';\nimport FormulaView from './view';\nimport FormulaPlaceholder from './placeholder';\nimport { biActions as basicActions } from '@ali/4ever-plugin-basic';\nimport FormulaTextarea from './textarea';\nimport { setFormulaData, setFormulaInjection } from '../actions';\n\nconst { calcuSize } = FormulaPlugin;\n\nconst isEnterHotKey = isKeyHotkey('enter');\nconst isEscHotKey = isKeyHotkey('esc');\n\ninterface FormulaProps extends RenderNodeProps<Element> {\n  // 插件配置\n  config?: FormulaConfig;\n}\n\nconst isMobile = environment.IS_MOBILE;\n\nconst FormulaWrapper = styled.div`\n  position: relative;\n  display: inline-flex;\n  vertical-align: middle;\n  border-radius: 4px;\n\n  .bi-katex-dropdown {\n    border: none;\n    box-shadow: 0px 8px 24px 0px rgba(0,0,0,0.16), 0px 0px 1px 0px rgba(0,0,0,0.24);\n    animation: scale-up-top 0.25s cubic-bezier(0.455, 0.030, 0.515, 0.955) both;\n  }\n`;\n\nexport default React.memo((props: FormulaProps) => {\n  const [isEditing, setIsEditing] = useState(false);\n\n  const modelFormulaData = props.node.data.metadata.formula || '';\n\n  // 这里保存临时的输入内容，当关闭弹窗就要把它置为空\n  const [formula, setFormula] = useState<string | null>(modelFormulaData);\n\n  const { node, controller, config, isSelected } = props;\n\n  const { startInline, selection } = controller.value;\n\n  const { readOnly } = controller;\n\n  const currentFormula = formula === null ? modelFormulaData : formula;\n\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n\n  const isPlaceholder = !currentFormula;\n\n  // 国际化文案\n  const locale = config?.locale || {};\n\n  const onTextareaChange = useCallback((text: string) => {\n    setFormula(text);\n  }, []);\n\n  const onClickConfirm = useCallback(() => {\n    const nextFormula = currentFormula.trim();\n\n    if (modelFormulaData !== nextFormula) {\n      const tagData = {\n        ...calcuSize(nextFormula),\n        metadata: {\n          formula: nextFormula,\n        },\n      };\n      controller.run('onAction', setFormulaData(node, tagData));\n    }\n  }, [modelFormulaData, currentFormula, controller, node]);\n\n  const onKeyDown = useCallback((e: React.KeyboardEvent<HTMLElement>) => {\n    if (isEditing && isEscHotKey(e)) {\n      setIsEditing(false);\n      onClickConfirm();\n\n      controller.run('onAction', basicActions.createFocusToNodeAction({ node }));\n    }\n  }, [isEditing, controller, node.key, onClickConfirm]);\n\n  const onClickButton = useCallback(() => {\n    onClickConfirm();\n    setIsEditing(false);\n  }, [onClickConfirm]);\n\n  useEffect(() => {\n    const data = calcuSize(currentFormula);\n    controller.run('onAction', setFormulaInjection(node.key, data));\n  }, [currentFormula, controller, node.key]);\n\n  useEffect(() => {\n    const handleEnter = (event: KeyboardEvent) => {\n      if (\n        isEnterHotKey(event) &&\n        Tag.isTag(startInline) &&\n        selection.isCollapsed &&\n        startInline.key === node.key\n      ) {\n        event.preventDefault();\n        event.stopPropagation();\n\n        setIsEditing(true);\n        textareaRef.current && textareaRef.current.focus();\n      }\n    };\n\n    document.addEventListener('keydown', handleEnter);\n    return () => {\n      document.removeEventListener('keydown', handleEnter);\n    };\n  }, [textareaRef, startInline, selection, node.key]);\n\n  const getContainer = useCallback(() => {\n    const bodyEle = document.body;\n    return document.querySelector('div[data-cangjie-content]') || bodyEle;\n  }, []);\n\n  const onVisibleChange = useCallback((visible: boolean) => {\n    setIsEditing(visible);\n\n    if (!visible) {\n      onClickConfirm();\n    } else {\n      textareaRef.current && textareaRef.current.focus();\n    }\n  }, [textareaRef, onClickConfirm]);\n\n  const placeholder = useMemo(() => {\n    return (\n      <FormulaPlaceholder\n        locale={locale}\n        notAllowed={readOnly || isMobile}\n        isSelected={isSelected}\n        isEditing={isEditing}\n      />\n    );\n  }, [readOnly, locale, isSelected, isEditing]);\n\n  const formulaView = useMemo(() => {\n    return (\n      <FormulaView\n        formula={currentFormula}\n        isEditing={isEditing}\n        isSelected={isSelected}\n      />\n    );\n  }, [currentFormula, isEditing, isSelected]);\n\n  const formulaTextarea = useMemo(() => {\n    return (\n      <FormulaTextarea\n        locale={locale}\n        formula={currentFormula}\n        config={config}\n        textareaRef={textareaRef}\n        onChange={onTextareaChange}\n        onButtonClick={onClickButton}\n      />\n    );\n  }, [locale, currentFormula, textareaRef, config, onTextareaChange, onClickButton]);\n\n  const renderContent = useMemo(() => {\n    const showPlaceholder = isPlaceholder && !currentFormula;\n    const content = showPlaceholder ? placeholder : formulaView;\n\n    if (readOnly || isMobile) {\n      return content;\n    }\n\n    return (\n      <Dropdown\n        trigger=\"click\"\n        getContainer={getContainer}\n        overlay={formulaTextarea}\n        visible={isEditing}\n        onVisibleChange={onVisibleChange}\n        placement=\"bottomLeft\"\n        overlayClassName=\"bi-katex-dropdown\"\n        zIndex={1000}\n      >\n        <div>{content}</div>\n      </Dropdown>\n    );\n  }, [\n    isPlaceholder,\n    isEditing,\n    placeholder,\n    formulaView,\n    readOnly,\n    getContainer,\n    formulaTextarea,\n    onVisibleChange,\n    currentFormula,\n  ]);\n\n  return (\n    <FormulaWrapper\n      data-cangjie-not-editable\n      onKeyDown={onKeyDown}\n    >\n      {renderContent}\n    </FormulaWrapper>\n  );\n});\n"],"file":"content.js"}