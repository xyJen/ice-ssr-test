{"version":3,"sources":["../../../../../src/plugins/quickPreview/hooks/createRenderContent.tsx"],"names":["DB_CLICK_TIME","DB_CLICK_PX","DB_CLICK_SCROLL_PX","OFFSET_NONE","lastMouseDown","lastClick","time","x","y","isElementInContent","element","key","content","closest","constants","Selector","querySelector","DbClick","controller","configs","React","useEffect","handleTouchStart","event","timer","clearTimeout","isFocused","document","value","target","touches","HTMLElement","length","isHitTitle","HTMLTextAreaElement","clientX","clientY","now","Date","timeCount","xCount","Math","abs","yCount","hitTest","run","type","Actions","EXIT","payload","noScroll","noFocus","focus","preventDefault","handleTouchEnd","changedTouches","handleClick","setTimeout","onPreviewClick","handleMousedown","environment","IS_IPAD","currentTime","window","addEventListener","passive","removeEventListener","createRenderContent","renderContent","props","next","isQuickPreview","Boolean","query"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { Controller, constants, environment } from '@ali/4ever-cangjie';\n\nimport Actions from '../actions';\nimport { QuickPreviewConfigs } from '../types';\n\n/**\n * 这里使用默认的 db click 非常容易误触。\n * 参考了飞书的行为，把触发的参数控制的非常严格\n */\n\n/**\n * 连续两次 touch 之间的最大间隔时间 ms\n * 和飞书对比，300 明显偏大，200 明显偏小。250 感觉还是偏大，暂用\n */\nconst DB_CLICK_TIME = 250;\n// 连续两次 touch 之间的最大间隔距离 px\nconst DB_CLICK_PX = 15;\n// touch start 和 end 之间，移动超过 px 就判定无效\nconst DB_CLICK_SCROLL_PX = 1;\nconst OFFSET_NONE = -1000;\n\nlet lastMouseDown = 0;\nlet lastClick = { time: 0, x: OFFSET_NONE, y: OFFSET_NONE };\n\nfunction isElementInContent(element: HTMLElement, key: string) {\n  const content = element.closest(`[${constants.Selector.content}]`);\n  if (\n    !content ||\n    !content.querySelector(`[${constants.Selector.key}=\"${key}\"]`)\n  ) {\n    return false;\n  }\n  return true;\n}\n\nfunction DbClick({\n  controller,\n  configs,\n}: {\n  controller: Controller;\n  configs?: QuickPreviewConfigs;\n}) {\n  React.useEffect(() => {\n    const handleTouchStart = (event: TouchEvent) => {\n      timer && clearTimeout(timer);\n      const { isFocused, document } = controller.value;\n      if (isFocused) {\n        return;\n      }\n      const { target, touches } = event;\n      if (!(target instanceof HTMLElement) || !touches.length) {\n        return;\n      }\n      if (!isElementInContent(target, document.key)) {\n        return;\n      }\n\n      // hack, to be removed later\n      const isHitTitle =\n        target instanceof HTMLTextAreaElement &&\n        target.closest('#doc-title-area');\n      const { clientX, clientY } = touches[0];\n      const now = Date.now();\n      const timeCount = now - lastClick.time;\n      const xCount = Math.abs(clientX - lastClick.x);\n      const yCount = Math.abs(clientY - lastClick.y);\n      const hitTest =\n        timeCount < DB_CLICK_TIME &&\n        xCount < DB_CLICK_PX &&\n        yCount < DB_CLICK_PX;\n      if (hitTest) {\n        controller.run('onAction', {\n          type: Actions.EXIT,\n          payload: { noScroll: true, noFocus: isHitTitle },\n        });\n        if (isHitTitle) {\n          target.focus();\n        }\n      } else if (isHitTitle) {\n        event.preventDefault();\n      }\n      lastClick = { time: now, x: clientX, y: clientY };\n    };\n\n    const handleTouchEnd = (event: TouchEvent) => {\n      if (controller.value.isFocused) {\n        return;\n      }\n      const { target, changedTouches } = event;\n      if (!(target instanceof HTMLElement) || !changedTouches.length) {\n        return;\n      }\n      const { clientX, clientY } = changedTouches[0];\n      const xCount = Math.abs(clientX - lastClick.x);\n      const yCount = Math.abs(clientY - lastClick.y);\n      if (xCount > DB_CLICK_SCROLL_PX || yCount > DB_CLICK_SCROLL_PX) {\n        // 发生了滚动，重置掉\n        lastClick.time = 0;\n      }\n      lastClick.x = clientX;\n      lastClick.y = clientY;\n    };\n    let timer: any = null;\n    const handleClick = (event: MouseEvent) => {\n      if (!(event.target instanceof HTMLElement)) {\n        return;\n      }\n      const { document } = controller.value;\n      if (!isElementInContent(event.target, document.key)) {\n        return;\n      }\n      timer = setTimeout(() => {\n        if (configs?.onPreviewClick) {\n          configs.onPreviewClick();\n        }\n      }, DB_CLICK_TIME * 2);\n    };\n    const handleMousedown = (event: MouseEvent) => {\n      if (!environment.IS_IPAD) {\n        return;\n      }\n      const isHitTitle =\n        event.target instanceof HTMLTextAreaElement &&\n        event.target.closest('#doc-title-area');\n      const currentTime = Date.now();\n\n      const hitTest = currentTime - lastMouseDown < DB_CLICK_TIME;\n      if (hitTest) {\n        controller.run('onAction', {\n          type: Actions.EXIT,\n          payload: { noScroll: true, noFocus: isHitTitle },\n        });\n        if (isHitTitle) {\n          event.target.focus();\n        }\n        lastMouseDown = 0;\n      } else {\n        lastMouseDown = Date.now();\n        isHitTitle && event.preventDefault();\n      }\n    };\n    window.document.addEventListener('touchstart', handleTouchStart, {\n      passive: false,\n    });\n    window.document.addEventListener('touchend', handleTouchEnd);\n    window.document.addEventListener('touchcancel', handleTouchEnd);\n    window.document.addEventListener('mousedown', handleMousedown);\n    window.document.addEventListener('click', handleClick);\n    return () => {\n      timer && clearTimeout(timer);\n      window.document.removeEventListener('touchstart', handleTouchStart);\n      window.document.removeEventListener('touchend', handleTouchEnd);\n      window.document.removeEventListener('touchcancel', handleTouchEnd);\n      window.document.removeEventListener('mousedown', handleMousedown);\n      window.document.removeEventListener('click', handleClick);\n    };\n  }, [controller]);\n  return null;\n}\n\nexport default function createRenderContent(configs?: QuickPreviewConfigs) {\n  return function renderContent(props, controller: Controller, next) {\n    const isQuickPreview = Boolean(controller.query('isQuickPreview'));\n    return (\n      <React.Fragment>\n        {isQuickPreview && (\n          <DbClick controller={controller} configs={configs} />\n        )}\n        {next()}\n      </React.Fragment>\n    );\n  };\n}\n"],"file":"createRenderContent.js"}