{"version":3,"sources":["../../../../../src/plugins/quickInsert/utils/pos.ts"],"names":["getPos","controller","scrollableContainer","portalDom","align","selection","document","value","point","Point","create","key","focus","offset","contentDOM","domUtils","findDOMNodeSafely","closest","constants","Selector","content","pos","findCaretPosition","window","containerRect","body","getBoundingClientRect","clientLeft","clientTop","height","clientHeight","clientWidth","isBottomLittleSpace","isLeftLittleSpace","width","left","scrollX","top","scrollY"],"mappings":";;;;;;;AAAA;;AAEe,SAASA,MAAT,CAAgBC,UAAhB,EAAwCC,mBAAxC,EAA0EC,SAA1E,EAAkGC,KAAa,GAAG,QAAlH,EAA4H;AAEzI,QAAM;AAAEC,IAAAA,SAAF;AAAaC,IAAAA;AAAb,MAA0BL,UAAU,CAACM,KAA3C;;AAEA,QAAMC,KAAK,GAAGC,mBAAMC,MAAN,CAAa;AACzBC,IAAAA,GAAG,EAAEN,SAAS,CAACO,KAAV,CAAgBD,GADI;AAEzB;AACAE,IAAAA,MAAM,EAAER,SAAS,CAACO,KAAV,CAAgBC,MAAhB,GAAyB;AAHR,GAAb,CAAd;;AAMA,QAAMC,UAAU,GAAGC,sBAASC,iBAAT,CAA2BV,QAAQ,CAACK,GAApC,GAA0CM,OAA1C,CAAmD,IAAGC,uBAAUC,QAAV,CAAmBC,OAAQ,GAAjF,CAAnB;;AAEA,QAAMC,GAAG,GAAGN,sBAASO,iBAAT,CAA2Bd,KAA3B,EAAkC,OAAlC,EAA2CM,UAAU,IAAIS,MAAzD,CAAZ;;AACA,MAAIF,GAAG,IAAInB,mBAAP,IAA8BC,SAAlC,EAA6C;AAC3C;AACA,UAAMqB,aAAa,GAAG,CAACtB,mBAAmB,CAACqB,MAApB,KAA+BrB,mBAA/B,GAAqDqB,MAAM,CAACjB,QAAP,CAAgBmB,IAArE,GAA4EvB,mBAA7E,EAAkGwB,qBAAlG,EAAtB;AACA,UAAM;AAAEC,MAAAA,UAAF;AAAcC,MAAAA,SAAd;AAAyBC,MAAAA;AAAzB,QAAoCR,GAA1C;AACA,UAAM;AAAES,MAAAA,YAAF;AAAgBC,MAAAA;AAAhB,QAAgC5B,SAAtC;AAEA,UAAM6B,mBAAmB,GACvBJ,SAAS,GAAGE,YAAZ,IACGN,aAAa,CAACK,MAAd,IAAwBD,SAAS,GAAGC,MAApC,IAA8CC,YAFnD;AAGA,UAAMG,iBAAiB,GACrBN,UAAU,GAAGI,WAAb,IACGP,aAAa,CAACU,KAAd,GAAsBP,UAAtB,GAAmCI,WAFxC;AAIA,UAAMI,IAAI,GAAGF,iBAAiB,GAAGN,UAAU,GAAGJ,MAAM,CAACa,OAApB,GAA8BL,WAAjC,GAA+CJ,UAAU,GAAGJ,MAAM,CAACa,OAAjG;AACA,UAAMC,GAAG,GAAGL,mBAAmB,GAAGJ,SAAS,GAAGL,MAAM,CAACe,OAAnB,GAA6BR,YAA7B,GAA4C,CAA/C,GAAmDT,GAAG,CAACO,SAAJ,GAAgBC,MAAhB,GAAyB,CAAzB,GAA6BN,MAAM,CAACe,OAAtH;;AAEA,QAAIlC,KAAK,KAAK,QAAd,EAAwB;AACtB,aAAO;AAAE+B,QAAAA,IAAF;AAAQE,QAAAA,GAAG,EAAEhB,GAAG,CAACO,SAAJ,GAAgBC,MAAhB,GAAyB,CAAzB,GAA6BN,MAAM,CAACe;AAAjD,OAAP;AACD;;AACD,QAAIlC,KAAK,KAAK,KAAd,EAAqB;AACnB,aAAO;AAAE+B,QAAAA,IAAF;AAAQE,QAAAA,GAAG,EAAET,SAAS,GAAGL,MAAM,CAACe,OAAnB,GAA6BR;AAA1C,OAAP;AACD;;AACD,WAAQ;AAAEK,MAAAA,IAAF;AAAQE,MAAAA;AAAR,KAAR;AACD;;AAED,SAAO;AAAEF,IAAAA,IAAI,EAAE,IAAR;AAAcE,IAAAA,GAAG,EAAE;AAAnB,GAAP;AACD","sourcesContent":["import { Point, Controller, domUtils, constants } from '@ali/4ever-cangjie';\n\nexport default function getPos(controller: Controller, scrollableContainer: HTMLElement, portalDom: HTMLElement, align: string = 'follow') {\n\n  const { selection, document } = controller.value;\n\n  const point = Point.create({\n    key: selection.focus.key,\n    // @ts-ignore\n    offset: selection.focus.offset - 1,\n  });\n\n  const contentDOM = domUtils.findDOMNodeSafely(document.key)?.closest(`[${constants.Selector.content}]`);\n\n  const pos = domUtils.findCaretPosition(point, 'start', contentDOM || window);\n  if (pos && scrollableContainer && portalDom) {\n    // @ts-ignore\n    const containerRect = (scrollableContainer.window === scrollableContainer ? window.document.body : scrollableContainer).getBoundingClientRect();\n    const { clientLeft, clientTop, height } = pos;\n    const { clientHeight, clientWidth } = portalDom;\n\n    const isBottomLittleSpace =\n      clientTop > clientHeight\n      && containerRect.height - (clientTop + height) < clientHeight;\n    const isLeftLittleSpace =\n      clientLeft > clientWidth\n      && containerRect.width - clientLeft < clientWidth;\n\n    const left = isLeftLittleSpace ? clientLeft + window.scrollX - clientWidth : clientLeft + window.scrollX;\n    const top = isBottomLittleSpace ? clientTop + window.scrollY - clientHeight - 2 : pos.clientTop + height + 2 + window.scrollY;\n\n    if (align === 'bottom') {\n      return { left, top: pos.clientTop + height + 2 + window.scrollY };\n    }\n    if (align === 'top') {\n      return { left, top: clientTop + window.scrollY - clientHeight };\n    }\n    return ({ left, top });\n  }\n\n  return { left: 9999, top: 9999 };\n}\n"],"file":"pos.js"}