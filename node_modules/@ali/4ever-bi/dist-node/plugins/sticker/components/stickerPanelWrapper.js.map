{"version":3,"sources":["../../../../../src/plugins/sticker/components/stickerPanelWrapper.tsx"],"names":["EXTRA_OFFSET_LEFT","StickerPanelWrapper","props","controller","sticker","visible","locale","onVisibleChange","zoomContainer","zoom","panelRef","onClickSticker","handleClickOutside","e","closestSticker","target","closest","stickerCode","getAttribute","run","requestAnimationFrame","updatePosition","current","rect","getBoundingClientRect","caretPos","panelHeight","offsetHeight","panelWidth","offsetWidth","initTransformOrigin","isAtBottom","isAtRight","style","top","left","transformOrigin","join","classList","add","React","useEffect","STICKER_PANEL_COLUMMS","memo"],"mappings":"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","sourcesContent":["import React, { useRef, useCallback, useEffect } from 'react';\nimport { useZoomContainer, useZoom } from '@ali/4ever-cangjie';\nimport { useOnClickOutside } from '@ali/4ever-component';\nimport { createOnClickSticker } from '../utils';\nimport { PanelWrapper } from './styled';\nimport { STICKER_PANEL_COLUMMS } from '../constants';\nimport { StickerPanel } from '@ali/4ever-plugin-sticker';\nimport { getCaretPosition } from '../utils/getCaretPosition';\nimport { setStickerPanelVisible } from '../actions';\n\nconst EXTRA_OFFSET_LEFT = 2;\n\nfunction StickerPanelWrapper(props) {\n  const { controller, sticker, visible, locale, onVisibleChange } = props;\n  const zoomContainer = useZoomContainer();\n  const zoom = useZoom();\n  const panelRef = useRef<HTMLDivElement>();\n\n  const onClickSticker = useCallback(\n    createOnClickSticker({ controller, sticker }),\n    [controller, sticker],\n  );\n\n  const handleClickOutside = useCallback(\n    (e) => {\n      // 面板不出现时不予处理（避免首次 mousedown 引起 flush 的情况）\n      if (!visible) {\n        return;\n      }\n      const closestSticker = e.target.closest('[data-type=sticker]');\n      const stickerCode = closestSticker?.getAttribute('data-sticker');\n      controller.run(\n        'onAction',\n        setStickerPanelVisible({\n          visible: false,\n        }),\n      );\n      if (stickerCode === '') {\n        requestAnimationFrame(updatePosition);\n      }\n    },\n    [controller, visible],\n  );\n\n  const updatePosition = () => {\n    if (!zoomContainer || !panelRef.current) {\n      return;\n    }\n\n    const rect = zoomContainer.getBoundingClientRect();\n    const caretPos = getCaretPosition({\n      controller,\n      rect,\n      zoom,\n      panelHeight: panelRef.current.offsetHeight,\n      panelWidth: panelRef.current.offsetWidth,\n    });\n    if (!caretPos) {\n      return;\n    }\n\n    const initTransformOrigin = ['top', 'left'];\n    if (caretPos.isAtBottom) {\n      initTransformOrigin[0] = 'bottom';\n    }\n    if (caretPos.isAtRight) {\n      initTransformOrigin[1] = 'right';\n    }\n\n    panelRef.current.style.top = `${caretPos.top}px`;\n    panelRef.current.style.left = `${caretPos.left + EXTRA_OFFSET_LEFT}px`;\n    panelRef.current.style.transformOrigin = initTransformOrigin.join(' ');\n    panelRef.current.classList.add('sticker-panel-visible');\n  };\n\n  useOnClickOutside(panelRef, handleClickOutside, false);\n\n  React.useEffect(() => {\n    updatePosition();\n  });\n\n  useEffect(() => {\n    onVisibleChange && onVisibleChange(visible);\n  }, [visible]);\n\n  return visible ? (\n    <PanelWrapper ref={panelRef}>\n      <StickerPanel\n        sticker={sticker}\n        columns={STICKER_PANEL_COLUMMS}\n        onClick={onClickSticker}\n        locale={locale}\n      />\n    </PanelWrapper>\n  ) : null;\n}\n\nexport default React.memo(StickerPanelWrapper);\n"],"file":"stickerPanelWrapper.js"}