{"version":3,"sources":["../../../../../src/plugins/sticker/handlers/onCangjieSelect.ts"],"names":["MOVE_UPWARD","MOVE_DOWNWARD","MOVE_BACKWARD","MOVE_FORWARD","SELECT_START","SELECTION_TRIGGER","MOVE_SET","queryRange","getTargetMethod","moveMethod","onCangjieSelect","event","controller","next","trigger","selection","detail","anchor","value","document","isCollapsed","isTextPoint","maybeInline","getClosestInline","key","Sticker","isSticker","run","offset","range","query","Queries","maybeSticker","getParent","point","pointAtDistance","command","Commands","select","Selection","create","focus","data"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;AAEA,MAAM;AACJA,EAAAA,WADI;AAEJC,EAAAA,aAFI;AAGJC,EAAAA,aAHI;AAIJC,EAAAA,YAJI;AAKJC,EAAAA;AALI,IAMFC,4BANJ;AAQA,MAAMC,QAAQ,GAAG;AACf,GAACN,WAAD,GAAe;AACbO,IAAAA,UAAU,EAAE,gBADC;AAEbC,IAAAA,eAAe,EAAE,iBAFJ;AAGbC,IAAAA,UAAU,EAAE;AAHC,GADA;AAMf,GAACR,aAAD,GAAiB;AACfM,IAAAA,UAAU,EAAE,kBADG;AAEfC,IAAAA,eAAe,EAAE,aAFF;AAGfC,IAAAA,UAAU,EAAE;AAHG;AANF,CAAjB;;AAae,SAASC,eAAT,CAAyBC,KAAzB,EAAgCC,UAAhC,EAAwDC,IAAxD,EAA8D;AAC3E,QAAM;AAAEC,IAAAA,OAAF;AAAWC,IAAAA;AAAX,MAAyBJ,KAAK,CAACK,MAArC;AACA,QAAM;AAAEC,IAAAA;AAAF,MAAaF,SAAnB;AACA,QAAM;AAAEG,IAAAA;AAAF,MAAYN,UAAlB;AACA,QAAM;AAAEO,IAAAA;AAAF,MAAeD,KAArB;;AACA,MAAI,CAACH,SAAS,CAACK,WAAX,IAA0B,CAACH,MAAM,CAACI,WAAP,EAA/B,EAAqD;AACnD,WAAOR,IAAI,EAAX;AACD;;AACD,QAAMS,WAAW,GAAGH,QAAQ,CAACI,gBAAT,CAA0BN,MAAM,CAACO,GAAjC,CAApB;;AACA,MAAIC,gBAAQC,SAAR,CAAkBJ,WAAlB,CAAJ,EAAoC;AAClC,QAAIR,OAAO,KAAKZ,aAAhB,EAA+B;AAC7B,aAAOU,UAAU,CAACe,GAAX,CAAe,UAAf,EAA2B,wBAAU;AAAEC,QAAAA,MAAM,EAAE,CAAC;AAAX,OAAV,CAA3B,CAAP;AACD;;AACD,QAAId,OAAO,KAAKX,YAAhB,EAA8B;AAC5B,aAAOS,UAAU,CAACe,GAAX,CAAe,UAAf,EAA2B,wBAAU;AAAEC,QAAAA,MAAM,EAAE;AAAV,OAAV,CAA3B,CAAP;AACD;;AACD,QAAId,OAAO,KAAKd,WAAZ,IAA2Bc,OAAO,KAAKb,aAA3C,EAA0D;AACxD,YAAM;AAAEM,QAAAA;AAAF,UAAiBD,QAAQ,CAACQ,OAAD,CAA/B;AACA,YAAMe,KAAK,GAAGjB,UAAU,CAACkB,KAAX,CAAiBC,qBAAQxB,UAAR,CAAjB,CAAd;AACA,UAAI,CAACsB,KAAL,EAAY,OAAOjB,UAAP;AACZ,YAAMoB,YAAY,GAAGb,QAAQ,CAACc,SAAT,CAAmBJ,KAAK,CAACZ,MAAN,CAAaO,GAAhC,CAArB;;AACA,UAAIC,gBAAQC,SAAR,CAAkBM,YAAlB,CAAJ,EAAqC;AACnC,eAAOpB,UAAU,CAACe,GAAX,CAAe,UAAf,EAA2B,uBAAS;AAAEE,UAAAA,KAAF;AAASf,UAAAA;AAAT,SAAT,CAA3B,CAAP;AACD;AACF,KAfiC,CAgBlC;;;AACA,QAAIA,OAAO,KAAKV,YAAhB,EAA8B;AAC5B,YAAM8B,KAAK,GAAGtB,UAAU,CAACkB,KAAX,CAAiBC,qBAAQI,eAAzB,EAA0CpB,SAAS,CAACE,MAApD,EAA4D,CAA5D,CAAd;AACA,aAAOL,UAAU,CAACwB,OAAX,CAAmBC,sBAASC,MAA5B,EAAoCC,uBAAUC,MAAV,CAAiB;AAAEvB,QAAAA,MAAM,EAAEiB,KAAV;AAAiBO,QAAAA,KAAK,EAAEP,KAAxB;AAA+BQ,QAAAA,IAAI,EAAE3B,SAAS,CAAC2B;AAA/C,OAAjB,CAApC,CAAP;AACD;AACF;;AACD,SAAO7B,IAAI,EAAX;AACD","sourcesContent":["import { Controller, Commands, Selection, Queries } from '@ali/4ever-cangjie';\nimport { Sticker } from '@ali/4ever-mo';\nimport { SELECTION_TRIGGER } from '@ali/4ever-utils';\nimport { moveCaret, setRange } from '../actions';\n\nconst {\n  MOVE_UPWARD,\n  MOVE_DOWNWARD,\n  MOVE_BACKWARD,\n  MOVE_FORWARD,\n  SELECT_START,\n} = SELECTION_TRIGGER;\n\nconst MOVE_SET = {\n  [MOVE_UPWARD]: {\n    queryRange: 'getUpsideRange',\n    getTargetMethod: 'getPreviousNode',\n    moveMethod: 'moveToEndOfNode',\n  },\n  [MOVE_DOWNWARD]: {\n    queryRange: 'getDownsideRange',\n    getTargetMethod: 'getNextNode',\n    moveMethod: 'moveToStartOfNode',\n  },\n};\n\nexport default function onCangjieSelect(event, controller: Controller, next) {\n  const { trigger, selection } = event.detail;\n  const { anchor } = selection;\n  const { value } = controller;\n  const { document } = value;\n  if (!selection.isCollapsed || !anchor.isTextPoint()) {\n    return next();\n  }\n  const maybeInline = document.getClosestInline(anchor.key);\n  if (Sticker.isSticker(maybeInline)) {\n    if (trigger === MOVE_BACKWARD) {\n      return controller.run('onAction', moveCaret({ offset: -1 }));\n    }\n    if (trigger === MOVE_FORWARD) {\n      return controller.run('onAction', moveCaret({ offset: 1 }));\n    }\n    if (trigger === MOVE_UPWARD || trigger === MOVE_DOWNWARD) {\n      const { queryRange } = MOVE_SET[trigger];\n      const range = controller.query(Queries[queryRange]);\n      if (!range) return controller;\n      const maybeSticker = document.getParent(range.anchor.key);\n      if (Sticker.isSticker(maybeSticker)) {\n        return controller.run('onAction', setRange({ range, trigger }));\n      }\n    }\n    // 点击到表格上时，纠正选区到下一个 text 开头\n    if (trigger === SELECT_START) {\n      const point = controller.query(Queries.pointAtDistance, selection.anchor, 1);\n      return controller.command(Commands.select, Selection.create({ anchor: point, focus: point, data: selection.data }));\n    }\n  }\n  return next();\n}\n"],"file":"onCangjieSelect.js"}