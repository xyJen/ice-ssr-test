{"version":3,"sources":["../../../src/utils/renderNode.tsx"],"names":["React","equal","Block","Text","MarksOptionContext","BackgroundOverlay","isGradientColor","shouldRenderBySelf","text","prevSz","leaves","every","leaf","szMark","marks","find","type","sz","data","isSameSize","colorMark","color","value","shouldAntiAliasing","node","nodes","length","isTextList","cachedMarksMap","WeakMap","buildHightlightMarks","cachedMarks","get","getTexts","forEach","offset","inlineCodeMark","mark","push","key","set","marksOption","disableHighlight","COLORS_WHITE","invalidMark","m","String","replace","some","c","createRenderNode","configs","disableAntiAliasing","renderNode","props","controller","next","children","isLeafBlock","isAntiAliasingDisabled","newChildren","newProps"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport equal from 'fast-deep-equal';\nimport { Node, Block, Text, RenderNodeProps, Mark, Controller } from '@ali/4ever-cangjie';\nimport { MarksOptionContext } from '@ali/4ever-plugin-marks';\nimport BackgroundOverlay, { MarkItem } from './components/backgroundLayer';\nimport { isGradientColor } from '@ali/4ever-utils';\nimport { TextBackgroundPluginConfigs } from './types';\n\n// 当文字字体大小相同且不为渐变色时，通过自身 background 渲染背景色，否则使用 div 模拟背景色\nfunction shouldRenderBySelf(text: Text) {\n  let prevSz: Record<string, any> | null = null;\n  return text.leaves.every((leaf) => {\n    const szMark = leaf.marks.find(({ type }) => type === 'sz');\n    const sz = szMark?.data || null;\n    const isSameSize = !prevSz || equal(sz, prevSz);\n    prevSz = sz;\n\n    const colorMark = leaf.marks.find(({ type }) => type === 'color');\n    const color = colorMark?.data?.value;\n    return isSameSize && !isGradientColor(color);\n  });\n}\n\nfunction shouldAntiAliasing(node: Block) {\n  return (\n    node.nodes.length > 1 ||\n    !Text.isTextList(node.nodes) ||\n    !node.nodes.every(shouldRenderBySelf)\n  );\n}\n\nconst cachedMarksMap = new WeakMap<Node, MarkItem[]>();\nfunction buildHightlightMarks(node: Node) {\n  const cachedMarks = cachedMarksMap.get(node);\n  if (cachedMarks) {\n    return cachedMarks;\n  }\n  const marks: MarkItem[] = [];\n  node.getTexts().forEach((text) => {\n    let offset = 0;\n    text.leaves.forEach((leaf) => {\n      const inlineCodeMark = leaf.marks.find(\n        (mark) => mark.type === 'inlineCode',\n      );\n      // 存在 行内代码 样式，则忽略其他背景色效果\n      if (inlineCodeMark) {\n        marks.push({ mark: inlineCodeMark!, key: text.key, offset });\n        offset += leaf.text.length;\n        return;\n      }\n      let colorMark;\n      leaf.marks.forEach((mark) => {\n        if (mark.type === 'highlight') {\n          colorMark = mark;\n        } else if (mark.type === 'shd') {\n          colorMark = colorMark || mark;\n        }\n      });\n\n      if (colorMark) {\n        const { key } = text;\n        marks.push({ mark: colorMark as Mark, key, offset });\n      }\n      offset += leaf.text.length;\n    });\n  });\n  cachedMarksMap.set(node, marks);\n  return marks;\n}\n\nconst marksOption = { disableHighlight: true };\n\nconst COLORS_WHITE = ['rgba(0,0,0,0)', 'white'];\n\n/**\n * 如果是白色的 mark，直接无视掉。\n * 一些外部拷贝的内容可能会加很多白色背景，严重影响性能。\n */\nconst invalidMark = (m: MarkItem) => {\n  const color = String(m.mark.data.value).replace(/ /g, '');\n  return COLORS_WHITE.some((c) => c === color);\n};\n\nexport default function createRenderNode(\n  configs?: TextBackgroundPluginConfigs,\n) {\n  const { disableAntiAliasing } = configs || {};\n  return function renderNode(props: RenderNodeProps, controller: Controller, next) {\n    const { node, children } = props;\n\n    if (!Block.isLeafBlock(node)) {\n      return next();\n    }\n\n    const isAntiAliasingDisabled =\n      disableAntiAliasing && disableAntiAliasing() === true;\n    if (isAntiAliasingDisabled || !shouldAntiAliasing(node as Block)) {\n      return next();\n    }\n\n    const marks = buildHightlightMarks(node);\n    if (!marks.length || marks.every(invalidMark)) {\n      return next();\n    }\n\n    const newChildren = () => {\n      return (\n        <MarksOptionContext.Provider value={marksOption}>\n          <BackgroundOverlay marks={marks} node={node as Block} controller={controller} />\n          {children()}\n        </MarksOptionContext.Provider>\n      );\n    };\n    const newProps = {\n      ...props,\n      children: newChildren,\n    };\n\n    return next(newProps);\n  };\n}\n"],"file":"renderNode.js"}