"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.restartNumbering = restartNumbering;
exports.continueNumbering = continueNumbering;

var _everCangjie = require("@ali/4ever-cangjie");

var _utils = require("../utils");

const numbering = (controller, listId) => {
  if (!listId) return;
  const {
    value
  } = controller;
  const {
    document
  } = value;
  let nextBlock = (0, _utils.getCurrentItem)(controller)[0];
  const listConfig = nextBlock?.data?.list;

  while (nextBlock) {
    const nextListConfig = nextBlock?.data?.list;

    if (listConfig && nextListConfig) {
      if (nextListConfig.listId === listConfig.listId && nextListConfig.level >= listConfig.level && listId !== nextListConfig.listId // 过滤相同 listId 的情况
      ) {
          controller.command(_everCangjie.Commands.setNodeByKey, nextBlock.key, (0, _utils.mergeListData)(nextBlock.data, {
            listId
          }));
        } else if (nextListConfig.level < listConfig.level) {
        break;
      }
    }

    nextBlock = document.getNextBlock(nextBlock.key);
  }
};

function restartNumbering(controller) {
  const {
    value
  } = controller;
  const currentBlock = (0, _utils.getCurrentItem)(controller)[0];

  if (!currentBlock) {
    return controller;
  } // 是兄弟项中的第一个时，无须重新编号


  if ((0, _utils.isFirstInCurrentLevel)(value, currentBlock)) {
    return controller;
  }

  const newListId = (0, _utils.getListId)({
    restart: true
  });
  numbering(controller, newListId);
  return controller;
}

function continueNumbering(controller) {
  const {
    value
  } = controller;
  const curBlock = (0, _utils.getCurrentItem)(controller)[0];

  if (!_everCangjie.Block.isBlock(curBlock)) {
    return controller;
  }

  const prevClosestListItem = (0, _utils.getPrevClosestListItem)(value, curBlock, {
    unLimitLevel: true,
    isOrdered: curBlock?.data?.list?.isOrdered
  });
  const newListId = prevClosestListItem?.data?.list?.listId;
  numbering(controller, newListId);
  return controller;
}
//# sourceMappingURL=numbering.js.map