{"version":3,"sources":["../../../../src/bi/commands/numbering.ts"],"names":["numbering","controller","listId","value","document","nextBlock","listConfig","data","list","nextListConfig","level","command","Commands","setNodeByKey","key","getNextBlock","restartNumbering","currentBlock","newListId","restart","continueNumbering","curBlock","Block","isBlock","prevClosestListItem","unLimitLevel","isOrdered"],"mappings":";;;;;;;;AAAA;;AACA;;AAQA,MAAMA,SAAS,GAAG,CAACC,UAAD,EAAyBC,MAAzB,KAA4C;AAC5D,MAAI,CAACA,MAAL,EAAa;AACb,QAAM;AAAEC,IAAAA;AAAF,MAAYF,UAAlB;AACA,QAAM;AAAEG,IAAAA;AAAF,MAAeD,KAArB;AACA,MAAIE,SAAS,GAAG,2BAAeJ,UAAf,EAA2B,CAA3B,CAAhB;AACA,QAAMK,UAAU,GAAGD,SAAS,EAAEE,IAAX,EAAiBC,IAApC;;AACA,SAAOH,SAAP,EAAkB;AAChB,UAAMI,cAAc,GAAGJ,SAAS,EAAEE,IAAX,EAAiBC,IAAxC;;AACA,QAAIF,UAAU,IAAIG,cAAlB,EAAkC;AAChC,UACEA,cAAc,CAACP,MAAf,KAA0BI,UAAU,CAACJ,MAArC,IACAO,cAAc,CAACC,KAAf,IAAwBJ,UAAU,CAACI,KADnC,IAEAR,MAAM,KAAKO,cAAc,CAACP,MAH5B,CAGmC;AAHnC,QAIE;AACAD,UAAAA,UAAU,CAACU,OAAX,CACEC,sBAASC,YADX,EAEER,SAAS,CAACS,GAFZ,EAGE,0BAAcT,SAAS,CAACE,IAAxB,EAA8B;AAC5BL,YAAAA;AAD4B,WAA9B,CAHF;AAOD,SAZD,MAYO,IAAIO,cAAc,CAACC,KAAf,GAAuBJ,UAAU,CAACI,KAAtC,EAA6C;AAClD;AACD;AACF;;AACDL,IAAAA,SAAS,GAAGD,QAAQ,CAACW,YAAT,CAAsBV,SAAS,CAACS,GAAhC,CAAZ;AACD;AACF,CA3BD;;AA6BO,SAASE,gBAAT,CAA0Bf,UAA1B,EAAkD;AACvD,QAAM;AAAEE,IAAAA;AAAF,MAAYF,UAAlB;AACA,QAAMgB,YAAY,GAAG,2BAAehB,UAAf,EAA2B,CAA3B,CAArB;;AACA,MAAI,CAACgB,YAAL,EAAmB;AACjB,WAAOhB,UAAP;AACD,GALsD,CAMvD;;;AACA,MAAI,kCAAsBE,KAAtB,EAA6Bc,YAA7B,CAAJ,EAAgD;AAC9C,WAAOhB,UAAP;AACD;;AACD,QAAMiB,SAAS,GAAG,sBAAU;AAAEC,IAAAA,OAAO,EAAE;AAAX,GAAV,CAAlB;AACAnB,EAAAA,SAAS,CAACC,UAAD,EAAaiB,SAAb,CAAT;AACA,SAAOjB,UAAP;AACD;;AAEM,SAASmB,iBAAT,CAA2BnB,UAA3B,EAAmD;AACxD,QAAM;AAAEE,IAAAA;AAAF,MAAYF,UAAlB;AACA,QAAMoB,QAAQ,GAAG,2BAAepB,UAAf,EAA2B,CAA3B,CAAjB;;AACA,MAAI,CAACqB,mBAAMC,OAAN,CAAcF,QAAd,CAAL,EAA8B;AAC5B,WAAOpB,UAAP;AACD;;AACD,QAAMuB,mBAAmB,GAAG,mCAAuBrB,KAAvB,EAA8BkB,QAA9B,EAAwC;AAClEI,IAAAA,YAAY,EAAE,IADoD;AAElEC,IAAAA,SAAS,EAAEL,QAAQ,EAAEd,IAAV,EAAgBC,IAAhB,EAAsBkB;AAFiC,GAAxC,CAA5B;AAIA,QAAMR,SAAS,GAAGM,mBAAmB,EAAEjB,IAArB,EAA2BC,IAA3B,EAAiCN,MAAnD;AACAF,EAAAA,SAAS,CAACC,UAAD,EAAaiB,SAAb,CAAT;AACA,SAAOjB,UAAP;AACD","sourcesContent":["import { Controller, Commands, Block } from '@ali/4ever-cangjie';\nimport {\n  getCurrentItem,\n  getListId,\n  mergeListData,\n  getPrevClosestListItem,\n  isFirstInCurrentLevel,\n} from '../utils';\n\nconst numbering = (controller: Controller, listId: string) => {\n  if (!listId) return;\n  const { value } = controller;\n  const { document } = value;\n  let nextBlock = getCurrentItem(controller)[0];\n  const listConfig = nextBlock?.data?.list;\n  while (nextBlock) {\n    const nextListConfig = nextBlock?.data?.list;\n    if (listConfig && nextListConfig) {\n      if (\n        nextListConfig.listId === listConfig.listId &&\n        nextListConfig.level >= listConfig.level &&\n        listId !== nextListConfig.listId // 过滤相同 listId 的情况\n      ) {\n        controller.command(\n          Commands.setNodeByKey,\n          nextBlock.key,\n          mergeListData(nextBlock.data, {\n            listId,\n          }),\n        );\n      } else if (nextListConfig.level < listConfig.level) {\n        break;\n      }\n    }\n    nextBlock = document.getNextBlock(nextBlock.key);\n  }\n};\n\nexport function restartNumbering(controller: Controller) {\n  const { value } = controller;\n  const currentBlock = getCurrentItem(controller)[0];\n  if (!currentBlock) {\n    return controller;\n  }\n  // 是兄弟项中的第一个时，无须重新编号\n  if (isFirstInCurrentLevel(value, currentBlock)) {\n    return controller;\n  }\n  const newListId = getListId({ restart: true });\n  numbering(controller, newListId);\n  return controller;\n}\n\nexport function continueNumbering(controller: Controller) {\n  const { value } = controller;\n  const curBlock = getCurrentItem(controller)[0];\n  if (!Block.isBlock(curBlock)) {\n    return controller;\n  }\n  const prevClosestListItem = getPrevClosestListItem(value, curBlock, {\n    unLimitLevel: true,\n    isOrdered: curBlock?.data?.list?.isOrdered,\n  }) as Block;\n  const newListId = prevClosestListItem?.data?.list?.listId;\n  numbering(controller, newListId);\n  return controller;\n}\n"],"file":"numbering.js"}