{"version":3,"sources":["../../../../src/bi/commands/transform.ts"],"names":["Commands","Text","Paragraph","toggleList","getListId","getListData","getListStyle","paragraph2List","controller","block","list","listStyle","isTaskList","data","level","Boolean","isOrdered","String","listStyleType","command","setNodeByKey","key","type","heading2List","TYPE","list2List","code2List","lineArr","text","split","removeNodeByKey","withoutNormalizing","forEach","line","paragraph","create","nodes","insertBlock","transform","listType","blocks","query","Array","isArray","slice","listId","value","restart","calloutPr","blockquote"],"mappings":"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","sourcesContent":["import { Controller, Commands, Node, Text, Block } from '@ali/4ever-cangjie';\nimport { Paragraph } from '@ali/4ever-plugin-paragraph';\nimport toggleList from './toggleList';\nimport { getListId, getListData, getListStyle } from '../utils';\nimport type { ListProperties } from '../../utils/types';\n\nconst paragraph2List = (controller: Controller, block: Block, list: ListProperties) => {\n  let listStyle = list.listStyle;\n  if (!list.isTaskList && block?.data?.list?.level > 0) {\n    listStyle = getListStyle(\n      Boolean(list.isOrdered),\n      block.data.list.level,\n      String(list.listStyleType),\n    );\n  }\n  controller\n    .command(Commands.setNodeByKey, block.key, {\n      type: block.type,\n      data: {\n        list: {\n          ...list,\n          level: block?.data?.list?.level || 0,\n          listStyle,\n        },\n      },\n    });\n};\n\nconst heading2List = (controller: Controller, block: Node, list: ListProperties) => {\n  controller\n    .command(Commands.setNodeByKey, block.key, {\n      type: Paragraph.TYPE,\n      data: {\n        list,\n      },\n    });\n\n    controller.command('setHeading', Paragraph.TYPE);\n};\n\nconst list2List = (controller: Controller, block: Node) => {\n  controller\n    .command(Commands.setNodeByKey, block.key, {\n      type: Paragraph.TYPE,\n      data: {},\n    });\n};\n\nconst code2List = (controller: Controller, block: Node, list: ListProperties) => {\n  const lineArr = block.text.split('\\n');\n  controller\n    .command(Commands.removeNodeByKey, block.key);\n\n  controller.withoutNormalizing(() => {\n    lineArr.forEach((line) => {\n      const paragraph = Paragraph.create({\n        data: {\n          list,\n        },\n        nodes: [Text.create(line)],\n      });\n\n      controller.command(Commands.insertBlock, paragraph);\n    });\n  });\n};\n\nexport default function transform(controller: Controller, type: string, listType?: string) {\n  const blocks = controller.query('getTransformNodes');\n  if (Array.isArray(blocks)) {\n    const data = getListData({\n      type: type === 'tlist' ? type : type.slice(0,2) as 'ul' | 'ol' | 'tlist',\n      listId: getListId({ value: controller.value, listType, restart: true, type }),\n      level: 0,\n      listStyleType: listType,\n    });\n    controller.withoutNormalizing(() => {\n      blocks.forEach((block) => {\n        if (block.type === 'code') {\n          return code2List(controller, block, data.list);\n        } else if (block.data.calloutPr) {\n          return paragraph2List(controller, block, data.list);\n        } else if (block.data.list) {\n          if (\n            (block.data.list.isTaskList && type === 'tlist')\n            || (!block.data.list.isTaskList && block.data.list.isOrdered && type === 'olist')\n            || (!block.data.list.isTaskList && !block.data.list.isOrdered && type === 'ulist')\n          ) {\n            return list2List(controller, block);\n          }\n          return paragraph2List(controller, block, data.list);\n        } else if (block.data.blockquote) {\n          return paragraph2List(controller, block, data.list);\n        } else if (block.type !== 'paragraph') {\n          return heading2List(controller, block, data.list);\n        }\n        return toggleList(controller, data, type, [block]);\n      });\n    });\n  }\n  return controller;\n}\n"],"file":"transform.js"}