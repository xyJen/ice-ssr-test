{"version":3,"sources":["../../../../src/bi/handlers/createOnAction.ts"],"names":["createOnAction","config","onAction","action","controller","next","document","value","type","payload","CODE_CHANGE","node","patches","textNode","getFirstText","opts","map","patch","selection","RangeSelection","fromJSON","anchor","key","offset","focus","length","content","withoutPending","editor","forEach","opt","command","Commands","insertTextAtRange","CODE_CHANGE_DATA","data","updateCode","resetFocusedCode","CODE_FOCUS_TO_CODE_EDITOR","codeAnchor","TextPoint","create","getFirstNode","range","select","withoutNormalizing","run","basicActions","createMergeDataAction","FOCUSED_CODE","blur","CODE_FOCUS_TO_TEXT_EDITOR","direction","moveToStartOfNode","previousBlock","getPreviousBlock","moveToEndOfNode","flush","nextBlock","getNextBlock","CODE_REMOVE","removeCode","CODE_INSERT","code","theme","syntax","id","CODE_TRANSFORM","transform","CODE_BLUR"],"mappings":"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","sourcesContent":["import {\n  Text,\n  Controller,\n  Commands,\n  Action,\n  RangeSelection,\n  TextPoint,\n} from '@ali/4ever-cangjie';\nimport {\n  CODE_CHANGE,\n  ChangeCodePayload,\n  CODE_FOCUS_TO_CODE_EDITOR,\n  CODE_FOCUS_TO_TEXT_EDITOR,\n  CODE_REMOVE,\n  CODE_BLUR,\n  CODE_INSERT,\n  CODE_CHANGE_DATA,\n  CODE_TRANSFORM,\n  RemoveCodePayload,\n  FocusToTextEditorPayload,\n  FocusToCodeEditorPayload,\n  InsertCodePayload,\n  ChangeCodeDataPayload,\n} from '../actions';\nimport updateCode from '../commands/updateCode';\nimport removeCode from '../commands/removeCode';\nimport createInsertCode from '../commands/insertCode';\nimport { transform } from '../commands/transform';\nimport { biActions as basicActions } from '@ali/4ever-plugin-basic';\nimport resetFocusedCode from '../commands/resetFocusedCode';\nimport { FOCUSED_CODE } from '../constants/value';\nimport { generateKey} from '@ali/4ever-utils';\nimport { setFocusState } from '../store';\nimport { CodePluginConfig } from '../types';\n\nexport default function createOnAction(config: CodePluginConfig) {\n  return function onAction(\n    action: Action,\n    controller: Controller,\n    next: () => void,\n  ) {\n    const { document } = controller.value;\n    const { type, payload } = action;\n\n    if (type === CODE_CHANGE) {\n      const { node, patches } = payload as ChangeCodePayload;\n      const textNode: Text = node.getFirstText()!;\n\n      const opts = patches.map((patch) => {\n        return {\n          selection: RangeSelection.fromJSON({\n            anchor: {\n              key: textNode.key,\n              offset: patch.offset,\n            },\n            focus: {\n              key: textNode.key,\n              offset: patch.type === 'insert' ? patch.offset : patch.offset + patch.value.length,\n            },\n          }),\n          content: patch.type === 'delete' ? '' : patch.value,\n        };\n      });\n\n      controller.withoutPending((editor) => {\n        opts.forEach((opt) => {\n          editor.command(\n            Commands.insertTextAtRange,\n            opt.selection,\n            opt.content,\n          );\n        });\n      });\n    }\n\n    if (type === CODE_CHANGE_DATA) {\n      const { node, data } = payload as ChangeCodeDataPayload;\n      if (node) {\n        return controller.command(updateCode, node, data);\n      }\n      return controller.command(resetFocusedCode);\n    }\n\n    if (type === CODE_FOCUS_TO_CODE_EDITOR) {\n      const { node } = payload as FocusToCodeEditorPayload;\n      // 代码块focus === 仓颉失焦，这时候手动更改选区到代码块\n      const codeAnchor = TextPoint.create({\n        key: node.getFirstNode().key,\n        offset: 0,\n      });\n      const range = RangeSelection.create({\n        anchor: codeAnchor,\n        focus: codeAnchor,\n      });\n      controller.command(Commands.select, range);\n\n      return controller.withoutNormalizing(() => {\n        controller.run('onAction', basicActions.createMergeDataAction({ [FOCUSED_CODE]: node.key }));\n        controller.command(\n          Commands.blur,\n        )\n      })\n    }\n\n    if (type === CODE_FOCUS_TO_TEXT_EDITOR) {\n      const { direction = 'down', node } = payload as FocusToTextEditorPayload;\n      controller.withoutNormalizing(() => {\n        controller.command(Commands.focus);\n\n        if (direction === 'left') {\n          controller.command(Commands.moveToStartOfNode, node);\n        }\n\n        // 回到代码块的上个段落\n        if (direction === 'up') {\n          const previousBlock = document.getPreviousBlock(node.key);\n          if (previousBlock) {\n            controller.command(Commands.moveToEndOfNode, previousBlock).flush();\n          } else {\n            controller.command(Commands.moveToStartOfNode, node);\n          }\n        }\n\n        // 回到代码块的下个段落\n        if (direction === 'down') {\n          const nextBlock = document.getNextBlock(node.key);\n          if (nextBlock) {\n            controller.command(Commands.moveToStartOfNode, nextBlock);\n          } else {\n            controller.command(Commands.moveToEndOfNode, node);\n          }\n        }\n\n        controller.run('onAction', basicActions.createMergeDataAction({ [FOCUSED_CODE]: null }));\n      });\n\n      return controller;\n    }\n\n    if (type === CODE_REMOVE) {\n      const { node } = payload as RemoveCodePayload;\n      return controller.command(removeCode, node.key).command(Commands.focus);\n    }\n\n    if (type === CODE_INSERT) {\n      const { code, theme, syntax } = payload as InsertCodePayload;\n      const id = generateKey();\n      // eslint-disable-next-line no-param-reassign\n      setFocusState(id, true);\n      return controller.command(createInsertCode(config), id, code, syntax, theme);\n    }\n\n    if (type === CODE_TRANSFORM) {\n      const id = generateKey();\n      setFocusState(id, true);\n      return controller.command(transform, config, id);\n    }\n\n    if (type === CODE_BLUR) {\n      controller.run('onAction', basicActions.createMergeDataAction({ [FOCUSED_CODE]: null }));\n      return controller;\n    }\n\n    return next();\n  };\n}\n"],"file":"createOnAction.js"}