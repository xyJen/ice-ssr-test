{"version":3,"sources":["../../../../src/bi/components/CodeEditor.tsx"],"names":["isFindHotKey","IS_FIREFOX","environment","isAtStartOfCodeEditor","cm","cursor","getCursor","line","ch","Pass","CodeEditor","props","locale","controller","node","onSave","cursorPos","isSelected","data","zoomContainer","document","body","disableInlineToolbar","query","id","syntax","DEFAULT_LANGUAGE","theme","DEFAULT_THEME","height","wrap","collabSelections","cmRef","React","useRef","wrapperRef","controllerRef","nodeRef","isResizing","setIsResizing","useState","draggingHeight","setDraggingHeight","lineHeight","setLineHeight","scale","focus","useCallback","current","run","backToTextEditor","direction","undefined","removeCodeEditor","getValue","length","onHistory","type","dispatch","options","useMemo","cursorBlinkRate","extraKeys","Backspace","Left","Up","Esc","isNullOrUndefined","dragHeight","setSize","codeHeight","handleBlur","handleDidMount","position","setCursor","defaultTextHeight","refresh","handleChange","_editor","_changes","patches","handleGutterClick","gutter","event","preventDefault","stopPropagation","hasFocus","handleResize","_","size","handleResizeStart","handleResizeStop","handleKeyDown","handleContextMenu","codemirrorIgnore","state","delayingBlurEvent","handleResizeClick","useEffect","useLayoutEffect","execCommand","widthRange","Infinity","heightRange","HEIGHT_PADDING","MAX_HEIGHT","isCodeFocused","value","selection","isCollapsed","showResize","autoHeight","didMount","commonStyle","maxHeight","minHeight","resizableStyle","transform","transformOrigin","width","enableBorderHighlight","Math","min","color","backgroundColor","key","text","placeholder"],"mappings":"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","sourcesContent":["/* eslint-disable react/destructuring-assignment */\nimport * as React from 'react';\nimport { isKeyHotkey } from 'is-hotkey';\nimport { Controller, Block, environment, useZoomContainer } from '@ali/4ever-cangjie';\nimport type {\n  Editor as CodeMirrorEditor,\n  EditorConfiguration,\n} from 'codemirror';\nimport {\n  changeCode,\n  focusToCodeEditor,\n  focusToTextEditor,\n  FocusDirection,\n  removeCode,\n  changeCodeData,\n  blurCode,\n} from '../actions';\n\nimport CodeInlineToolbar from './CodeInlineToolbar';\nimport { CodePluginConfig } from '../types';\nimport { Resizable } from '@ali/4ever-component';\nimport { getFocusState, setFocusState, CodeMirrorPosition } from '../store';\nimport CodeGlobalStyle from './CodeGlobalStyle';\nimport { DEFAULT_LANGUAGE } from '../../utils/constants/languages';\nimport { DEFAULT_THEME } from '../../utils/constants/themes';\nimport getCodeHeight from '../../components/Codemirror/utils';\nimport { HEIGHT_PADDING, MAX_HEIGHT } from '../../utils/constants/dimension';\nimport { CodeMirrorLazy } from '../../components/LazyCodemirror';\n\nconst isFindHotKey = isKeyHotkey('mod+f');\nconst { IS_FIREFOX } = environment;\n\nexport interface CodeEditorProps {\n  isSelected: boolean;\n  controller: Controller;\n  node: Block;\n  locale: CodePluginConfig['locale'];\n  onSave?: () => void;\n  cursorPos: 'start' | 'end' | {\n    line: number;\n    ch: number;\n  };\n}\n\nfunction isAtStartOfCodeEditor(cm: CodeMirrorEditor) {\n  const cursor = cm.getCursor();\n  return cursor.line === 0 && cursor.ch === 0;\n}\n\nconst Pass = 'CodeMirror.Pass';\n\nconst CodeEditor: React.FC<CodeEditorProps> = (props) => {\n  const { locale, controller, node, onSave = () => {}, cursorPos = 'end', isSelected } = props;\n  const { data } = node;\n  const zoomContainer = useZoomContainer() || document.body;\n  const disableInlineToolbar = controller.query('hasHoverToolbar', 'code');\n\n  const { id, syntax = DEFAULT_LANGUAGE, theme = DEFAULT_THEME, height, wrap = false, collabSelections = {} } = data;\n\n  const cmRef = React.useRef<CodeMirrorEditor | null>(null);\n  const wrapperRef = React.useRef<HTMLDivElement | null>(null);\n  const controllerRef = React.useRef(controller);\n  const nodeRef = React.useRef(node);\n\n  const [isResizing, setIsResizing] = React.useState(false);\n  const [draggingHeight, setDraggingHeight] = React.useState<number>(() => getCodeHeight(node));\n  const [lineHeight, setLineHeight] = React.useState(0);\n  const scale = 1.0;\n\n  const focus = React.useCallback(() => {\n    setFocusState(id, true);\n    controllerRef.current.run('onAction', focusToCodeEditor(nodeRef.current));\n  }, []);\n\n  const backToTextEditor = React.useCallback((direction?: FocusDirection) => {\n    controllerRef.current.run(\n      'onAction',\n      focusToTextEditor(nodeRef.current, direction),\n    );\n    return undefined;\n  }, []);\n\n  const removeCodeEditor = React.useCallback((cm: CodeMirrorEditor) => {\n    if (isAtStartOfCodeEditor(cm) && !cm.getValue().length) {\n      controllerRef.current.run('onAction', removeCode(nodeRef.current));\n      return undefined;\n    }\n    return Pass;\n  }, []);\n\n  // undo、redo\n  const onHistory = React.useCallback(\n    (type: 'undo' | 'redo') => {\n      controller.dispatch(type === 'undo' ? 'undo' : 'redo');\n    },\n    [controller],\n  );\n\n  const options = React.useMemo(\n    () => ({\n      cursorBlinkRate: 530,\n      extraKeys: {\n        Backspace: removeCodeEditor,\n        Left: (cm) => {\n          if (isAtStartOfCodeEditor(cm)) {\n            return backToTextEditor('left');\n          }\n          return Pass;\n        },\n        Up: (cm) => {\n          if (cm.getCursor().line === 0) {\n            return backToTextEditor('up');\n          }\n          return Pass;\n        },\n        Esc: () => backToTextEditor(),\n        'Ctrl-S': () => {\n          onSave();\n        },\n        'Cmd-S': () => {\n          onSave();\n        },\n        'Ctrl-Z': () => {\n          onHistory('undo');\n        },\n        'Shift-Ctrl-Z': () => {\n          onHistory('redo');\n        },\n        'Cmd-Z': () => {\n          onHistory('undo');\n        },\n        'Shift-Cmd-Z': () => {\n          onHistory('redo');\n        },\n      },\n    }),\n    [backToTextEditor, removeCodeEditor, onSave, onHistory],\n  );\n\n  const isNullOrUndefined = (dragHeight) => {\n    return dragHeight === null || dragHeight === undefined;\n  };\n\n  const setSize = React.useCallback(\n    () => {\n      if (isNullOrUndefined(height)) {\n        const codeHeight = getCodeHeight(node);\n        setDraggingHeight(codeHeight);\n      }\n    },\n    [height, node],\n  );\n\n  const handleBlur = React.useCallback(() => {\n    setFocusState(id, false);\n    controllerRef.current.run('onAction', blurCode());\n  }, []);\n\n  const handleDidMount = React.useCallback(\n    (cm: CodeMirrorEditor) => {\n      cmRef.current = cm;\n      // 防止文档打开时，focus 到代码块\n      const position = getFocusState(id);\n      if (position) {\n        cm.focus();\n        if (position !== true) {\n          cm.setCursor(position);\n        }\n        focus();\n      }\n      setSize();\n      const dragHeight = isNullOrUndefined(height) ? getCodeHeight(node) : height;\n      setDraggingHeight(dragHeight);\n      setLineHeight(cm.defaultTextHeight());\n      cm.refresh();\n    },\n    [id, setSize, height, focus],\n  );\n\n  const handleChange = React.useCallback(\n    (_editor, _changes, patches) => {\n      controllerRef.current.run(\n        'onAction',\n        changeCode({ patches, node: nodeRef.current }),\n      );\n    },\n    [],\n  );\n\n  const handleGutterClick = React.useCallback(\n    (\n      cm: CodeMirrorEditor,\n      line: number,\n      gutter: string,\n      event: React.MouseEvent,\n    ) => {\n      event.preventDefault();\n      event.stopPropagation();\n      if (!cm.hasFocus()) {\n        cm.focus();\n      }\n      cm.setCursor({ line, ch: 0 });\n    },\n    [],\n  );\n\n  const handleResize = React.useCallback((_, size) => {\n    setDraggingHeight(size.height);\n  }, []);\n\n  const handleResizeStart = React.useCallback(() => {\n    setIsResizing(true);\n  }, []);\n\n  const handleResizeStop = React.useCallback((_, size) => {\n    setIsResizing(false);\n    cmRef.current!.focus();\n    controllerRef.current.run(\n      'onAction',\n      changeCodeData(nodeRef.current, { height: size.height }),\n    );\n  }, []);\n\n  const handleKeyDown = React.useCallback((_, event: KeyboardEvent) => {\n    /**\n     * 对于部分组合键输入，执行stopPropagation后只是阻止往上冒泡，但并不会阻止浏览器默认行为，除非执行preventDefault。\n     * 这里不做stopPropagation处理，交由外层查找替换插件来处理。\n     */\n    if (isFindHotKey(event)) {\n      return;\n    }\n    event.stopPropagation();\n  }, []);\n\n  // 禁用右键菜单，防止弹出 cangjie menu\n  const handleContextMenu = React.useCallback((cm, event: React.MouseEvent) => {\n    // @ts-ignore codemirror event\n    event.codemirrorIgnore = true;\n    // 默认代码块 contextmenu 拦截的话，会 blur，通过 delayingBlurEvent 标记阻拦这一行为。\n    cm.state.delayingBlurEvent = false;\n    event.preventDefault();\n    event.stopPropagation();\n  }, []);\n\n  const handleResizeClick = React.useCallback((event: React.MouseEvent) => {\n    event.stopPropagation();\n  }, []);\n\n  React.useEffect(() => {\n    if (cmRef.current) {\n      cmRef.current.refresh();\n    }\n  }, [scale]);\n\n  React.useLayoutEffect(() => {\n    if (!isNullOrUndefined(height)) {\n      setDraggingHeight(height);\n    }\n  }, [height]);\n\n  React.useEffect(() => {\n    nodeRef.current = node;\n    controllerRef.current = controller;\n  }, [node, controller]);\n\n  React.useEffect(() => {\n    return () => {\n      // 代码块无论何时被删除时，更新 focusCode ，解决新建代码块后光标在代码块里，再 undo focusCode 不更新的 bug\n      controllerRef.current.run('onAction', blurCode());\n\n      if (!cmRef.current || !cmRef.current.hasFocus()) return;\n      const position: CodeMirrorPosition = cmRef.current.getCursor();\n      setFocusState(id, position);\n    };\n  }, []);\n\n  // 光标位置\n  React.useEffect(() => {\n    if (!cmRef.current?.hasFocus()) {\n      return;\n    }\n    if (cursorPos === 'start') {\n      cmRef.current?.execCommand('goDocStart');\n    } else if (cursorPos === 'end') {\n      cmRef.current?.execCommand('goDocEnd');\n    } else {\n      cmRef.current?.setCursor(cursorPos);\n    }\n  }, [cursorPos]);\n\n  // node 变化时，重新计算高度\n  React.useEffect(() => {\n    if (cmRef.current) {\n      setSize();\n    }\n  }, [node, setSize]);\n\n  const widthRange = React.useMemo<[number, number]>(() => [0, Infinity], []);\n  const heightRange = React.useMemo<[number, number]>(\n    () => [lineHeight + HEIGHT_PADDING, MAX_HEIGHT],\n    [lineHeight],\n  );\n\n  const isCodeFocused = isSelected && controller.value.selection.isCollapsed;\n  const showResize = isResizing || isCodeFocused;\n\n  // 解决从弹性变为 fixed 时，不出现 scrollBar 的问题。只有从弹性变为 fixed 才触发\n  const autoHeight = isNullOrUndefined(height) && draggingHeight < MAX_HEIGHT && !isResizing;\n  const didMount = React.useRef(false);\n  React.useEffect(() => {\n    if (!didMount.current) {\n      didMount.current = true;\n      return;\n    }\n    if (!autoHeight) {\n      cmRef.current?.refresh();\n    }\n  }, [autoHeight]);\n\n  // FIREFOX 下，不进行放缩\n  const commonStyle: React.CSSProperties = {\n    maxHeight: `${MAX_HEIGHT}px`,\n    // cm 未渲染时设置最小高度防止懒加载过程中高度剧烈抖动\n    minHeight: cmRef.current ? undefined : draggingHeight,\n  };\n  const resizableStyle = IS_FIREFOX\n    ? {\n      transform: `scale(${1.0 / scale})`,\n      transformOrigin: 'top left',\n      width: `${100 * scale}%`,\n      ...commonStyle,\n    }\n    : {\n      ...commonStyle,\n    };\n\n  const enableBorderHighlight = controller.query('enableBorderHighlight');\n\n  return (\n    <Resizable\n      innerRef={wrapperRef}\n      axis=\"y\"\n      width={Infinity}\n      height={Math.min(draggingHeight || 0, MAX_HEIGHT)}\n      widthRange={widthRange}\n      heightRange={heightRange}\n      onResize={handleResize}\n      onResizeStart={handleResizeStart}\n      onResizeStop={handleResizeStop}\n      onClick={handleResizeClick}\n      visible={showResize}\n      style={resizableStyle}\n      speed={IS_FIREFOX ? 1.0 : 1.0 / scale}\n      zoomContainer={zoomContainer}\n      handleStyle={\n        theme === 'dracula'\n          ? { color: 'rgba(255, 255, 255, 0.4)', backgroundColor: '#111F2C' }\n          : {}\n      }\n      autoHeight={autoHeight}\n      isActive={isCodeFocused}\n      enableBorderHighlight={enableBorderHighlight}\n    >\n      <CodeGlobalStyle />\n      {!disableInlineToolbar && isCodeFocused ? <CodeInlineToolbar\n        controller={controller}\n        node={node}\n        locale={locale}\n        triggerNode={wrapperRef.current}\n        focusedCodeKey={node.key}\n      /> : null}\n      <CodeMirrorLazy\n        value={node.text}\n        options={(options as unknown) as EditorConfiguration}\n        syntax={syntax}\n        theme={theme}\n        wrap={wrap}\n        onEditorMount={handleDidMount}\n        onChanges={handleChange}\n        onFocus={focus}\n        onBlur={handleBlur}\n        onGutterClick={handleGutterClick}\n        onKeyDown={handleKeyDown}\n        onContextMenu={handleContextMenu}\n        scale={scale}\n        collabSelections={collabSelections}\n        placeholder={locale.placeholder}\n        controller={controller}\n        node={node}\n      />\n    </Resizable>\n  );\n};\n\nexport default CodeEditor;\n"],"file":"CodeEditor.js"}