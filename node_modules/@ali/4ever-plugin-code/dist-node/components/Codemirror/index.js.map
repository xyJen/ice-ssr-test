{"version":3,"sources":["../../../../src/components/Codemirror/index.tsx"],"names":["BASE_OPTIONS","lineNumbers","tabSize","scrollbarStyle","autoCloseBrackets","undoDepth","useEventEffect","editor","eventName","callback","callbackRef","React","useRef","useEffect","current","handleEvent","params","on","off","VALUE_UPDATE_BY_PROPS_CHANGE","prevSelectedIndex","prevFindText","FIND_NAME","FIND_SELECTED_NAME","COLLAB_SELECTION_NAME","CodeMirror","forwardRef","props","value","onEditorMount","noop","className","options","syntax","theme","wrap","scale","style","onChanges","onBlur","onFocus","onGutterClick","onMouseDown","onDBClick","onTouchStart","onKeyDown","onContextMenu","onCopy","onBeforeSelectionChange","collabSelections","placeholder","print","controller","node","ref","setEditor","useState","isLocalChange","instance","fixedGutter","inputStyle","readOnly","viewportMargin","Infinity","onEditorBlur","useCallback","cm","evt","ranges","origin","onEditorChanges","e","changes","isValueUpdatedByProps","every","change","patches","getValue","zoom","useLayoutEffect","oldValue","console","error","logger","sum","patch","isInsert","type","from","posFromIndex","offset","to","undefined","length","replacement","replaceRange","refresh","languages","useMemo","newSyntax","s","toLowerCase","match","find","lang","key","title","alias","map","a","includes","curSyntaxRef","then","l","setOption","catch","clearMarkHasClassNames","classNames","getAllMarks","forEach","marker","clear","uid","selection","range","markText","anchor","head","findText","findAndReplaceVisible","data","decorations","document","query","selfDecorations","filter","d","start","closestBlock","getClosestBlock","selectedIndex","findIndex","mark","selected","searchCursor","getSearchCursor","line","ch","index","targetPosition","findNext","setCursor","environment","IS_FIREFOX","memo"],"mappings":"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","sourcesContent":["/* eslint-disable no-unused-expressions */\nimport * as React from 'react';\nimport codemirror, { Editor, EditorConfiguration, EditorChange, Position } from 'codemirror';\n\n\n// cidemirror addon\nimport 'codemirror/addon/scroll/simplescrollbars.js';\nimport 'codemirror/addon/edit/closebrackets.js';\nimport 'codemirror/addon/display/placeholder.js';\nimport 'codemirror/addon/search/searchcursor.js';\nimport { noop } from 'lodash-es';\nimport { environment, useZoom, Controller, Block, Value } from '@ali/4ever-cangjie';\nimport logger from '@ali/4ever-logger';\nimport { Wrapper } from './styled';\nimport type { CodeSelectionChange } from './types';\nimport { diffsToPatchs, Patch } from './diffMatch';\nimport { createCodeLanguages } from '../../utils/constants/languages';\nimport { loadLanguageMode } from './languageLoader';\n\ninterface DomEvent<T = Event> {\n  (instance: Editor, event: T): void;\n}\n\ninterface CodeMirrorProps {\n  value: string;\n  onEditorMount?: (cm: Editor) => void;\n  options?: EditorConfiguration;\n  syntax: string;\n  theme: string;\n  wrap: boolean;\n  className?: string;\n  scale?: number;\n  onChanges?: (editor: Editor, data: EditorChange[], patches: Patch[]) => void;\n  onBlur?: DomEvent;\n  onFocus?: DomEvent;\n  onMouseDown?: DomEvent;\n  onDBClick?: DomEvent;\n  onTouchStart?: DomEvent;\n  onKeyDown?: DomEvent<KeyboardEvent>;\n  onContextMenu?: DomEvent;\n  onCopy?: DomEvent;\n  onGutterClick?: (\n    editor: Editor,\n    lineNumber: number,\n    gutter: string,\n    event: React.MouseEvent,\n  ) => void;\n  onBeforeSelectionChange?: (editor: Editor, data: CodeSelectionChange) => void;\n  isFocused?: boolean;\n  innerRef?: React.RefObject<HTMLDivElement>;\n  style?: React.CSSProperties;\n  collabSelections: Record<string, CodeSelectionChange>;\n  placeholder?: string;\n  print?: boolean;\n  controller?: Controller;\n  node?: Block;\n}\n\nconst BASE_OPTIONS: EditorConfiguration = {\n  lineNumbers: true,\n  tabSize: 2,\n  scrollbarStyle: 'overlay',\n  autoCloseBrackets: true,\n  undoDepth: 0,\n};\n\n\nconst useEventEffect = (editor: Editor | null, eventName: string, callback) => {\n  const callbackRef = React.useRef(callback);\n\n  React.useEffect(() => {\n    callbackRef.current = callback;\n  }, [callback]);\n\n  React.useEffect(() => {\n    if (editor) {\n      const handleEvent = (...params) => {\n        callbackRef.current(...params);\n      };\n      editor.on(eventName, handleEvent);\n      return () => editor.off(eventName, handleEvent);\n    }\n    return () => { };\n  }, [eventName, editor]);\n};\n\nconst VALUE_UPDATE_BY_PROPS_CHANGE = '__VALUE_UPDATE_BY_PROPS_CHANGE__';\n\nlet prevSelectedIndex = -1;\nlet prevFindText = '';\nconst FIND_NAME = 'find-and-replace';\nconst FIND_SELECTED_NAME = 'find-and-replace-selected';\nconst COLLAB_SELECTION_NAME = 'collab-selection';\n\nconst CodeMirror = React.forwardRef<HTMLElement, CodeMirrorProps>((props, forwardRef) => {\n  const {\n    value,\n    onEditorMount = noop,\n    className = '',\n    options,\n    syntax,\n    theme,\n    wrap = false,\n    scale = 1.0,\n    style,\n    onChanges = noop,\n    onBlur = noop,\n    onFocus = noop,\n    onGutterClick = noop,\n    onMouseDown = noop,\n    onDBClick = noop,\n    onTouchStart = noop,\n    onKeyDown = noop,\n    onContextMenu = noop,\n    onCopy = noop,\n    onBeforeSelectionChange = noop,\n    collabSelections,\n    placeholder,\n    print = false,\n    controller,\n    node,\n  } = props;\n  const ref = React.useRef<HTMLDivElement>(null);\n  const [editor, setEditor] = React.useState<Editor | null>(null);\n\n  // 用于标记当前是否由 onChange 触发导致 value 变化(非受控 => 受控)，此时 value 应该与 editor value 一致，防御性目的，防止无限循环\n  const isLocalChange = React.useRef(false);\n\n  React.useEffect(() => {\n    if (editor === null) {\n      const instance = codemirror(ref.current!, {\n        ...BASE_OPTIONS,\n        ...options,\n        fixedGutter: false,\n        value,\n        // force not use textarea due to zoom mode\n        inputStyle: options?.readOnly ? 'contenteditable' : 'textarea',\n        placeholder,\n        viewportMargin: print ? Infinity : 10,\n        readOnly: options?.readOnly ? 'nocursor' : false,\n      });\n      // 阻止移动端的事件冒泡到 slate-editor\n      onEditorMount(instance);\n      setEditor(instance);\n    }\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [onEditorMount, editor, value, print]);\n\n  React.useEffect(() => {\n    if (typeof forwardRef === 'function') {\n      forwardRef(ref.current);\n    } else if (forwardRef) {\n      forwardRef.current = ref.current;\n    }\n  }, [ref, forwardRef]);\n\n  const onEditorBlur = React.useCallback((cm, evt) => {\n    onBeforeSelectionChange(cm, {\n      ranges: [],\n      origin: 'blur',\n    });\n    onBlur(cm, evt);\n  }, [onBlur, onBeforeSelectionChange]);\n\n  const onEditorChanges = React.useCallback(\n    (e: Editor, changes: EditorChange[]) => {\n      const isValueUpdatedByProps = changes.every((change) => change.origin === VALUE_UPDATE_BY_PROPS_CHANGE);\n      if (isValueUpdatedByProps) {\n        return;\n      }\n      isLocalChange.current = true;\n      const patches = diffsToPatchs(value, e.getValue());\n      onChanges(e, changes, patches);\n    },\n    [value, onChanges],\n  );\n\n  const zoom = useZoom();\n\n  useEventEffect(editor, 'changes', onEditorChanges);\n  useEventEffect(editor, 'focus', onFocus);\n  useEventEffect(editor, 'blur', onEditorBlur);\n  useEventEffect(editor, 'gutterClick', onGutterClick);\n  useEventEffect(editor, 'mousedown', onMouseDown);\n  useEventEffect(editor, 'dblclick', onDBClick);\n  useEventEffect(editor, 'touchstart', onTouchStart);\n  useEventEffect(editor, 'keydown', onKeyDown);\n  useEventEffect(editor, 'contextmenu', onContextMenu);\n  useEventEffect(editor, 'copy', onCopy);\n  useEventEffect(editor, 'beforeSelectionChange', onBeforeSelectionChange);\n\n  // init\n  React.useLayoutEffect(() => {\n    if (editor) {\n      const oldValue = editor.getValue();\n\n      if (isLocalChange.current) {\n        isLocalChange.current = false;\n        // 防御措施，理论上不会走这段逻辑\n        if (value !== oldValue) {\n          console.error('EditorChange 转化为文字 Op 有逻辑缺陷，请检查');\n          logger.sum('CodeInvalidChangeToOp');\n          return;\n        }\n      }\n      if (value !== oldValue) {\n        const patches = diffsToPatchs(oldValue, value);\n        for (const patch of patches) {\n          const isInsert = patch.type === 'insert';\n          const from = editor.posFromIndex(patch.offset);\n          const to = isInsert ? undefined : editor.posFromIndex(patch.offset + patch.value.length);\n          const replacement = isInsert ? patch.value : '';\n\n          editor.replaceRange(replacement, from, to, VALUE_UPDATE_BY_PROPS_CHANGE);\n        }\n      }\n    }\n  }, [value, editor]);\n\n  // when zoom change, update fresh height\n  React.useEffect(() => {\n    editor?.refresh();\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [zoom]);\n\n  const languages = React.useMemo(() => createCodeLanguages(), []);\n\n  // model 里有的 syntax 是不标准的(比如语雀拷贝)，这里先做一层处理\n  const newSyntax = React.useMemo(() => {\n    const s = `${syntax}`.toLowerCase();\n    const match = languages.find(\n      (lang) => [\n        lang.key.toLowerCase(),\n        lang.title.toLowerCase(),\n        ...(lang.alias?.map(a => a.toLowerCase()) || []),\n      ].includes(s),\n    );\n    return match?.key || syntax;\n  }, [syntax, languages]);\n\n  // language mode 为异步加载，通过 ref 标记当前的 syntax\n  const curSyntaxRef = React.useRef(newSyntax);\n  curSyntaxRef.current = newSyntax;\n\n  React.useEffect(() => {\n    loadLanguageMode(newSyntax).then((l) => {\n      if (l === curSyntaxRef.current) {\n        editor?.setOption('mode', newSyntax);\n      }\n    }).catch(() => {});\n  }, [newSyntax, editor]);\n\n  // 避免闪烁\n  React.useLayoutEffect(() => {\n    editor && editor.setOption('theme', theme);\n  }, [theme, editor]);\n\n  const clearMarkHasClassNames = React.useCallback((classNames: string[]) => {\n    editor?.getAllMarks().forEach((marker) => {\n      // @ts-ignore codemirror type error\n      if (classNames.includes(marker.className)) {\n        marker.clear();\n      }\n    });\n  }, [editor]);\n\n  React.useEffect(() => {\n    editor && editor.setOption('lineWrapping', wrap || print);\n  }, [wrap, editor, print]);\n  // collabSelections 变化时，重新绘制协同 selection\n  React.useEffect(() => {\n    clearMarkHasClassNames([COLLAB_SELECTION_NAME]);\n    // eslint-disable-next-line guard-for-in\n    for (const uid in collabSelections) {\n      const selection = collabSelections[uid];\n      for (const range of selection.ranges) {\n        editor?.markText(range.anchor, range.head, {\n          className: 'collab-selection',\n        });\n      }\n    }\n  }, [collabSelections, editor]);\n\n  // 设置查找替换高亮\n  React.useEffect(() => {\n    if (!editor || !controller) {\n      return;\n    }\n    const { findText = '', findAndReplaceVisible } = controller.value.data;\n    if (!findAndReplaceVisible) {\n      clearMarkHasClassNames([FIND_NAME, FIND_SELECTED_NAME]);\n      return;\n    }\n\n    if (findText !== prevFindText) {\n      prevSelectedIndex = -1;\n    }\n\n    const { decorations, document }: Value = controller.query('getDataValue') || controller.value;\n    const selfDecorations = decorations.filter((d) => {\n      const { key } = d.start;\n      const closestBlock = document.getClosestBlock(key);\n      return closestBlock?.key === node?.key;\n    });\n\n    clearMarkHasClassNames([FIND_NAME, FIND_SELECTED_NAME]);\n\n    const selectedIndex = selfDecorations.findIndex(({ mark }) => mark.data.selected);\n    // @ts-ignore searchcursor.js 注入了该方法\n    const searchCursor = editor.getSearchCursor(findText, { line: 0, ch: 0 }, true);\n\n    let index = 0;\n    let targetPosition: Position | null = null;\n    while (searchCursor.findNext()) {\n      const selected = index === selectedIndex;\n\n      const from = searchCursor.from();\n      const to = searchCursor.to();\n      // eslint-disable-next-line @typescript-eslint/no-shadow\n      const className = selected ? FIND_SELECTED_NAME : FIND_NAME;\n      editor.markText(from, to, { className });\n      if (selected) {\n        targetPosition = { line: from.line, ch: to.ch };\n      }\n      index++;\n    }\n\n    if (targetPosition && prevSelectedIndex !== selectedIndex) {\n      editor.setCursor(targetPosition);\n    }\n\n    prevSelectedIndex = selectedIndex;\n    prevFindText = findText;\n  }, [clearMarkHasClassNames, controller, editor, node]);\n\n  return (\n    <Wrapper\n      style={style}\n      print={print}\n      theme={theme}\n      className={!environment.IS_FIREFOX ? `scaled ${className}` : className}\n      ref={ref}\n      scale={scale}\n      zoom={zoom}\n      readOnly={options?.readOnly}\n    />\n  );\n});\n\nexport default React.memo(CodeMirror);\n"],"file":"index.js"}