{"version":3,"sources":["../../../src/components/ZhiCode.tsx"],"names":["Code","props","syntax","theme","height","code","node","controller","lineWrapping","print","rest","wrapperRef","React","useRef","zoomHeight","setZoomHeight","useState","ref","placeholderHeightRef","spacing","before","bambooTheme","after","data","zoom","handleOutsideClick","useCallback","e","selection","window","getSelection","wrapper","current","contains","anchorNode","focusNode","target","textarea","document","activeElement","removeAllRanges","HTMLTextAreaElement","select","useEffect","addEventListener","removeEventListener","handleSelectionChange","nativeSelection","value","isCollapsed","isExpanded","command","Commands","moveToFocus","options","useMemo","readOnly","handleCopy","_","evt","canCopy","preventDefault","handleContextMenu","stopPropagation","handleMount","he","parseInt","getComputedStyle","style","s","marginBottom","marginTop","marginLeft","marginRight","maxHeight","MAX_HEIGHT","minHeight","undefined","overflowY","width","transform","transformOrigin","fontSize","hackZoom","userSelect","WebkitUserSelect","memo"],"mappings":";;;;;;;;;;;;;AAAA;;AACA;;AAIA;;AACA;;AACA;;AACA;;uBAP4B,a;;AAoB5B;AACA;AACA;AACA,MAAMA,IAAyB,GAAIC,KAAD,IAAW;AAC3C,QAAM;AAAEC,IAAAA,MAAF;AAAUC,IAAAA,KAAV;AAAiBC,IAAAA,MAAjB;AAAyBC,IAAAA,IAAzB;AAA+BC,IAAAA,IAA/B;AAAqCC,IAAAA,UAArC;AAAiDC,IAAAA,YAAjD;AAA+DC,IAAAA,KAAK,GAAG,KAAvE;AAA8E,OAAGC;AAAjF,MAA0FT,KAAhG;AACA,QAAMU,UAAU,GAAGC,KAAK,CAACC,MAAN,CAA0B,IAA1B,CAAnB;AACA,QAAM,CAACC,UAAD,EAAaC,aAAb,IAA8BH,KAAK,CAACI,QAAN,CAAe,CAAf,CAApC;AACA,QAAMC,GAAG,GAAGL,KAAK,CAACC,MAAN,CAA6B,IAA7B,CAAZ;AACA,QAAMK,oBAAoB,GAAGN,KAAK,CAACC,MAAN,CAAqB,oBAAcP,IAAd,CAArB,CAA7B;AACA,QAAM;AAAEa,IAAAA,OAAO,GAAG;AAAEC,MAAAA,MAAM,EAAEC,iBAAYhB,IAAZ,CAAiB,YAAjB,CAAV;AAA0CiB,MAAAA,KAAK,EAAED,iBAAYhB,IAAZ,CAAiB,eAAjB;AAAjD;AAAZ,MAAqGC,IAAI,CAACiB,IAAhH;AACA,QAAM;AAAEH,IAAAA,MAAF;AAAUE,IAAAA;AAAV,MAAoBH,OAA1B;AAEA,QAAMK,IAAI,GAAG,2BAAb;AAEA,QAAMC,kBAAkB,GAAGb,KAAK,CAACc,WAAN,CAAmBC,CAAD,IAAmB;AAC9D,UAAMC,SAAS,GAAGC,MAAM,CAACC,YAAP,EAAlB;AACA,UAAMC,OAAO,GAAGpB,UAAU,CAACqB,OAA3B;;AACA,QAAI,CAACJ,SAAD,IAAc,CAACG,OAAnB,EAA4B;AAC1B;AACD;;AACD,QACEA,OAAO,CAACE,QAAR,CAAiBL,SAAS,CAACM,UAA3B,KACAH,OAAO,CAACE,QAAR,CAAiBL,SAAS,CAACO,SAA3B,CADA,IAEA,CAACJ,OAAO,CAACE,QAAR,CAAiBN,CAAC,CAACS,MAAnB,CAHH,EAIE;AACA,YAAMC,QAAQ,GAAGC,QAAQ,CAACC,aAA1B;AACAX,MAAAA,SAAS,CAACY,eAAV,GAFA,CAGA;;AACA,UAAIH,QAAQ,YAAYI,mBAAxB,EAA6C;AAC3CJ,QAAAA,QAAQ,CAACK,MAAT;AACD;AACF;AACF,GAlB0B,EAkBxB,EAlBwB,CAA3B;AAoBA9B,EAAAA,KAAK,CAAC+B,SAAN,CAAgB,MAAM;AACpBd,IAAAA,MAAM,CAACe,gBAAP,CAAwB,WAAxB,EAAqCnB,kBAArC;AAEA,WAAO,MAAMI,MAAM,CAACgB,mBAAP,CAA2B,WAA3B,EAAwCpB,kBAAxC,CAAb;AACD,GAJD,EAIG,CAACA,kBAAD,CAJH;AAMA,QAAMqB,qBAAqB,GAAGlC,KAAK,CAACc,WAAN,CAAkB,MAAM;AACpD,UAAMqB,eAAe,GAAGlB,MAAM,CAACC,YAAP,EAAxB;AACA,UAAMC,OAAO,GAAGpB,UAAU,CAACqB,OAA3B;;AACA,QAAI,CAACe,eAAD,IAAoB,CAAChB,OAAzB,EAAkC;AAChC;AACD;;AACD,UAAM;AAAEH,MAAAA;AAAF,QAAgBrB,UAAU,CAACyC,KAAjC,CANoD,CAOpD;;AACA,QACEjB,OAAO,CAACE,QAAR,CAAiBc,eAAe,CAACb,UAAjC,KACAH,OAAO,CAACE,QAAR,CAAiBc,eAAe,CAACZ,SAAjC,CADA,IAEA,CAACP,SAAS,CAACqB,WAFX,IAGArB,SAHA,IAIAA,SAAS,CAACsB,UALZ,EAME;AACA3C,MAAAA,UAAU,CAAC4C,OAAX,CAAmBC,sBAASC,WAA5B;AACD;AACF,GAjB6B,EAiB3B,CAAC9C,UAAD,CAjB2B,CAA9B;AAmBAK,EAAAA,KAAK,CAAC+B,SAAN,CAAgB,MAAM;AACpBL,IAAAA,QAAQ,CAACM,gBAAT,CAA0B,iBAA1B,EAA6CE,qBAA7C;AAEA,WAAO,MAAMR,QAAQ,CAACO,mBAAT,CAA6B,iBAA7B,EAAgDC,qBAAhD,CAAb;AACD,GAJD,EAIG,CAACA,qBAAD,CAJH;AAMA,QAAMQ,OAA4B,GAAG1C,KAAK,CAAC2C,OAAN,CACnC,OAAO;AACLC,IAAAA,QAAQ,EAAE;AADL,GAAP,CADmC,EAInC,EAJmC,CAArC;AAOA,QAAMC,UAAU,GAAG7C,KAAK,CAACc,WAAN,CAAkB,CAACgC,CAAD,EAAIC,GAAJ,KAA4B;AAC/D,QAAI,CAACpD,UAAU,CAACqD,OAAhB,EAAyB;AACvBD,MAAAA,GAAG,CAACE,cAAJ;AACD;AACF,GAJkB,EAIhB,CAACtD,UAAD,CAJgB,CAAnB,CArE2C,CA2E3C;;AACA,QAAMuD,iBAAiB,GAAGlD,KAAK,CAACc,WAAN,CAAkB,CAACgC,CAAD,EAAI/B,CAAJ,KAAiB;AAC3DA,IAAAA,CAAC,CAACoC,eAAF;AACApC,IAAAA,CAAC,CAACkC,cAAF;AACD,GAHyB,EAGvB,EAHuB,CAA1B;AAKA,QAAMG,WAAW,GAAGpD,KAAK,CAACc,WAAN,CAAkB,MAAM;AAC1C;AACAR,IAAAA,oBAAoB,CAACc,OAArB,GAA+B,CAA/B;AACA,UAAMiC,EAAE,GAAG7D,MAAM,IAAI8D,QAAQ,CAACC,gBAAgB,CAAClD,GAAG,CAACe,OAAL,CAAhB,CAA+B5B,MAAhC,EAAwC,EAAxC,CAA7B;;AACA,QAAI6D,EAAJ,EAAQ;AACNlD,MAAAA,aAAa,CAACkD,EAAD,CAAb;AACD;AACF,GAPmB,EAOjB,CAAC7D,MAAD,CAPiB,CAApB;AASA,QAAMgE,KAAK,GAAGxD,KAAK,CAAC2C,OAAN,CAAc,MAAM;AAChC,UAAMc,CAAsB,GAAG;AAC7BC,MAAAA,YAAY,EAAG,GAAEhD,KAAM,IADM;AAE7BiD,MAAAA,SAAS,EAAG,GAAEnD,MAAO,IAFQ;AAG7BoD,MAAAA,UAAU,EAAG,GAAEnD,iBAAYhB,IAAZ,CAAiB,aAAjB,CAAgC,IAHlB;AAI7BoE,MAAAA,WAAW,EAAG,GAAEpD,iBAAYhB,IAAZ,CAAiB,cAAjB,CAAiC,IAJpB;AAK7B;AACAD,MAAAA,MAAM,EAAE,CAACK,KAAD,GAAUL,MAAM,GAAI,GAAEA,MAAO,IAAb,GAAmB,SAAnC,GAAgD,MAN3B;AAO7BsE,MAAAA,SAAS,EAAE,CAACjE,KAAD,GAAU,GAAEkE,qBAAW,IAAvB,GAA6B,MAPX;AAQ7B;AACAC,MAAAA,SAAS,EAAE1D,oBAAoB,CAACc,OAArB,GAA+Bd,oBAAoB,CAACc,OAApD,GAA8D6C,SAT5C;AAU7BC,MAAAA,SAAS,EAAE;AAVkB,KAA/B,CADgC,CAahC;;AACA,QAAItD,IAAI,GAAG,CAAX,EAAc;AACZ6C,MAAAA,CAAC,CAACU,KAAF,GAAW,GAAG,MAAMvD,IAAM,GAA1B;AACA6C,MAAAA,CAAC,CAACW,SAAF,GAAe,SAAS,IAAIxD,IAAM,GAAlC;AACA6C,MAAAA,CAAC,CAACY,eAAF,GAAoB,SAApB;AACAZ,MAAAA,CAAC,CAACa,QAAF,GAAc,GAAE,KAAK1D,IAAK,IAA1B;AACD;;AACD,WAAO6C,CAAP;AACD,GArBa,EAqBX,CAACjD,MAAD,EAASE,KAAT,EAAgBlB,MAAhB,EAAwBK,KAAxB,EAA+Be,IAA/B,CArBW,CAAd,CA1F2C,CAiH3C;;AACA,QAAM2D,QAAQ,GAAGvE,KAAK,CAAC2C,OAAN,CAAc,MAAMzC,UAAU,GAAG,CAAb,IAAkBU,IAAI,GAAG,CAA7C,EAAgD,CAACA,IAAD,EAAOV,UAAP,CAAhD,CAAjB;AAEA,sBACE;AACE,iBAAU;AADZ,KAEMJ,IAFN;AAGE,IAAA,KAAK,EAAE,EACL,GAAG0D,KADE;AAELhE,MAAAA,MAAM,EAAE+E,QAAQ,GAAI,GAAErE,UAAU,GAAGU,IAAK,IAAxB,GAA8B4C,KAAK,CAAChE;AAF/C,KAHT;AAOE,IAAA,GAAG,EAAEa;AAPP,mBASE,eAAC,8BAAD;AACE,IAAA,KAAK,EAAE;AACLmE,MAAAA,UAAU,EAAE,MADP;AAELC,MAAAA,gBAAgB,EAAE,MAFb;AAGLjF,MAAAA,MAAM,EAAE+E,QAAQ,GAAI,GAAErE,UAAW,IAAjB,GAAuB+D;AAHlC,KADT;AAME,IAAA,KAAK,EAAExE,IANT;AAOE,IAAA,OAAO,EAAEiD,OAPX;AAQE,IAAA,MAAM,EAAEpD,MARV;AASE,IAAA,KAAK,EAAEC,KATT;AAUE,IAAA,aAAa,EAAE2D,iBAVjB;AAWE,IAAA,aAAa,EAAEnD,UAXjB;AAYE,IAAA,MAAM,EAAE8C,UAZV;AAaE,IAAA,IAAI,EAAEjD,YAbR;AAcE,IAAA,KAAK,EAAEC,KAdT;AAeE,IAAA,aAAa,EAAEuD,WAfjB;AAgBE,IAAA,UAAU,EAAEzD,UAhBd;AAiBE,IAAA,IAAI,EAAED;AAjBR,IATF,CADF;AA+BD,CAnJD;;4BAqJeM,KAAK,CAAC0E,IAAN,CAAWtF,IAAX,C","sourcesContent":["import * as React from 'react';\nimport { Block, Controller, Commands, useZoom } from '@ali/4ever-cangjie';\nimport type {\n  EditorConfiguration,\n} from 'codemirror';\nimport getCodeHeight from './Codemirror/utils';\nimport { theme as bambooTheme } from '@ali/4ever-utils';\nimport { MAX_HEIGHT } from '../utils/constants/dimension';\nimport { CodeMirrorLazy } from './LazyCodemirror';\n\ninterface CodeProps {\n  height?: number;\n  syntax: string;\n  theme: string;\n  code: string;\n  controller: Controller;\n  node: Block;\n  lineWrapping: boolean; // 是否自动换行\n  print?: boolean;\n}\n\n/**\n * TODO: 处理 code 与 cangjie 编辑器选区和复制的交互行为\n */\nconst Code: React.FC<CodeProps> = (props) => {\n  const { syntax, theme, height, code, node, controller, lineWrapping, print = false, ...rest } = props;\n  const wrapperRef = React.useRef<HTMLElement>(null);\n  const [zoomHeight, setZoomHeight] = React.useState(0);\n  const ref = React.useRef<HTMLDivElement>(null);\n  const placeholderHeightRef = React.useRef<number>(getCodeHeight(node));\n  const { spacing = { before: bambooTheme.code['margin-top'], after: bambooTheme.code['margin-bottom'] } } = node.data;\n  const { before, after } = spacing;\n\n  const zoom = useZoom();\n\n  const handleOutsideClick = React.useCallback((e: MouseEvent) => {\n    const selection = window.getSelection();\n    const wrapper = wrapperRef.current;\n    if (!selection || !wrapper) {\n      return;\n    }\n    if (\n      wrapper.contains(selection.anchorNode) &&\n      wrapper.contains(selection.focusNode) &&\n      !wrapper.contains(e.target as Node)\n    ) {\n      const textarea = document.activeElement;\n      selection.removeAllRanges();\n      // 移除选区的同时会导致 textarea 失焦，此处反选一下，保障首次 code-mirror blur 的时候不会致使 cangjie 失焦\n      if (textarea instanceof HTMLTextAreaElement) {\n        textarea.select();\n      }\n    }\n  }, []);\n\n  React.useEffect(() => {\n    window.addEventListener('mousedown', handleOutsideClick);\n\n    return () => window.removeEventListener('mousedown', handleOutsideClick);\n  }, [handleOutsideClick]);\n\n  const handleSelectionChange = React.useCallback(() => {\n    const nativeSelection = window.getSelection();\n    const wrapper = wrapperRef.current;\n    if (!nativeSelection || !wrapper) {\n      return;\n    }\n    const { selection } = controller.value;\n    // 选择代码块的时候清空 cangjie 的选区\n    if (\n      wrapper.contains(nativeSelection.anchorNode) &&\n      wrapper.contains(nativeSelection.focusNode) &&\n      !selection.isCollapsed &&\n      selection &&\n      selection.isExpanded\n    ) {\n      controller.command(Commands.moveToFocus);\n    }\n  }, [controller]);\n\n  React.useEffect(() => {\n    document.addEventListener('selectionchange', handleSelectionChange);\n\n    return () => document.removeEventListener('selectionchange', handleSelectionChange);\n  }, [handleSelectionChange]);\n\n  const options: EditorConfiguration = React.useMemo(\n    () => ({\n      readOnly: true,\n    }),\n    [],\n  );\n\n  const handleCopy = React.useCallback((_, evt: ClipboardEvent) => {\n    if (!controller.canCopy) {\n      evt.preventDefault();\n    }\n  }, [controller]);\n\n  // 目前 code 的内容区域选区交互没有处理，暂时禁止掉 contextmenu 的触发\n  const handleContextMenu = React.useCallback((_, e: Event) => {\n    e.stopPropagation();\n    e.preventDefault();\n  }, []);\n\n  const handleMount = React.useCallback(() => {\n    // mount 之后不再需要占位高度\n    placeholderHeightRef.current = 0;\n    const he = height || parseInt(getComputedStyle(ref.current!).height, 10);\n    if (he) {\n      setZoomHeight(he);\n    }\n  }, [height]);\n\n  const style = React.useMemo(() => {\n    const s: React.CSSProperties = {\n      marginBottom: `${after}px`,\n      marginTop: `${before}px`,\n      marginLeft: `${bambooTheme.code['margin-left']}px`,\n      marginRight: `${bambooTheme.code['margin-right']}px`,\n      // eslint-disable-next-line no-nested-ternary\n      height: !print ? (height ? `${height}px` : 'inherit') : 'auto',\n      maxHeight: !print ? `${MAX_HEIGHT}px` : 'none',\n      // cm 未渲染时设置最小高度防止懒加载过程中高度剧烈抖动\n      minHeight: placeholderHeightRef.current ? placeholderHeightRef.current : undefined,\n      overflowY: 'visible',\n    };\n    // https://alidocs.dingtalk.com/i/nodes/e5vdDPq4wYa8a4aeLn9wJj7nbm10NkB9?cid=134024%3A372551849&dontjump=true&nav=spaces&navQuery=spaceId%3Dnb9XJv4jyWLaXyAp\n    if (zoom > 1) {\n      s.width = `${ 100 * zoom }%`;\n      s.transform = `scale(${ 1 / zoom })`;\n      s.transformOrigin = '0px 0px';\n      s.fontSize = `${11 * zoom}pt`;\n    }\n    return s;\n  }, [before, after, height, print, zoom]);\n\n  // hack 兼容 zoom 模式\n  const hackZoom = React.useMemo(() => zoomHeight > 0 && zoom > 1, [zoom, zoomHeight]);\n\n  return (\n    <div\n      data-type=\"code\"\n      {...rest}\n      style={{\n        ...style,\n        height: hackZoom ? `${zoomHeight / zoom}px` : style.height,\n      }}\n      ref={ref}\n    >\n      <CodeMirrorLazy\n        style={{\n          userSelect: 'text',\n          WebkitUserSelect: 'text',\n          height: hackZoom ? `${zoomHeight}px` : undefined,\n        }}\n        value={code}\n        options={options}\n        syntax={syntax}\n        theme={theme}\n        onContextMenu={handleContextMenu}\n        codeMirrorRef={wrapperRef}\n        onCopy={handleCopy}\n        wrap={lineWrapping}\n        print={print}\n        onEditorMount={handleMount}\n        controller={controller}\n        node={node}\n      />\n    </div>\n  );\n};\n\nexport default React.memo(Code);\n"],"file":"ZhiCode.js"}