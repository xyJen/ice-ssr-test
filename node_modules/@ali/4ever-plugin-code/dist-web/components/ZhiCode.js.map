{"version":3,"sources":["../../../src/components/ZhiCode.tsx"],"names":["React","Commands","useZoom","getCodeHeight","theme","bambooTheme","MAX_HEIGHT","CodeMirrorLazy","Code","props","syntax","height","code","node","controller","lineWrapping","print","rest","wrapperRef","useRef","useState","zoomHeight","setZoomHeight","ref","placeholderHeightRef","data","spacing","before","after","zoom","handleOutsideClick","useCallback","e","selection","window","getSelection","wrapper","current","contains","anchorNode","focusNode","target","textarea","document","activeElement","removeAllRanges","HTMLTextAreaElement","select","useEffect","addEventListener","removeEventListener","handleSelectionChange","nativeSelection","value","isCollapsed","isExpanded","command","moveToFocus","options","useMemo","readOnly","handleCopy","_","evt","canCopy","preventDefault","handleContextMenu","stopPropagation","handleMount","he","parseInt","getComputedStyle","style","s","marginBottom","marginTop","marginLeft","marginRight","maxHeight","minHeight","undefined","overflowY","width","transform","transformOrigin","fontSize","hackZoom","userSelect","WebkitUserSelect","memo"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { Block, Controller, Commands, useZoom } from '@ali/4ever-cangjie';\nimport type {\n  EditorConfiguration,\n} from 'codemirror';\nimport getCodeHeight from './Codemirror/utils';\nimport { theme as bambooTheme } from '@ali/4ever-utils';\nimport { MAX_HEIGHT } from '../utils/constants/dimension';\nimport { CodeMirrorLazy } from './LazyCodemirror';\n\ninterface CodeProps {\n  height?: number;\n  syntax: string;\n  theme: string;\n  code: string;\n  controller: Controller;\n  node: Block;\n  lineWrapping: boolean; // 是否自动换行\n  print?: boolean;\n}\n\n/**\n * TODO: 处理 code 与 cangjie 编辑器选区和复制的交互行为\n */\nconst Code: React.FC<CodeProps> = (props) => {\n  const { syntax, theme, height, code, node, controller, lineWrapping, print = false, ...rest } = props;\n  const wrapperRef = React.useRef<HTMLElement>(null);\n  const [zoomHeight, setZoomHeight] = React.useState(0);\n  const ref = React.useRef<HTMLDivElement>(null);\n  const placeholderHeightRef = React.useRef<number>(getCodeHeight(node));\n  const { spacing = { before: bambooTheme.code['margin-top'], after: bambooTheme.code['margin-bottom'] } } = node.data;\n  const { before, after } = spacing;\n\n  const zoom = useZoom();\n\n  const handleOutsideClick = React.useCallback((e: MouseEvent) => {\n    const selection = window.getSelection();\n    const wrapper = wrapperRef.current;\n    if (!selection || !wrapper) {\n      return;\n    }\n    if (\n      wrapper.contains(selection.anchorNode) &&\n      wrapper.contains(selection.focusNode) &&\n      !wrapper.contains(e.target as Node)\n    ) {\n      const textarea = document.activeElement;\n      selection.removeAllRanges();\n      // 移除选区的同时会导致 textarea 失焦，此处反选一下，保障首次 code-mirror blur 的时候不会致使 cangjie 失焦\n      if (textarea instanceof HTMLTextAreaElement) {\n        textarea.select();\n      }\n    }\n  }, []);\n\n  React.useEffect(() => {\n    window.addEventListener('mousedown', handleOutsideClick);\n\n    return () => window.removeEventListener('mousedown', handleOutsideClick);\n  }, [handleOutsideClick]);\n\n  const handleSelectionChange = React.useCallback(() => {\n    const nativeSelection = window.getSelection();\n    const wrapper = wrapperRef.current;\n    if (!nativeSelection || !wrapper) {\n      return;\n    }\n    const { selection } = controller.value;\n    // 选择代码块的时候清空 cangjie 的选区\n    if (\n      wrapper.contains(nativeSelection.anchorNode) &&\n      wrapper.contains(nativeSelection.focusNode) &&\n      !selection.isCollapsed &&\n      selection &&\n      selection.isExpanded\n    ) {\n      controller.command(Commands.moveToFocus);\n    }\n  }, [controller]);\n\n  React.useEffect(() => {\n    document.addEventListener('selectionchange', handleSelectionChange);\n\n    return () => document.removeEventListener('selectionchange', handleSelectionChange);\n  }, [handleSelectionChange]);\n\n  const options: EditorConfiguration = React.useMemo(\n    () => ({\n      readOnly: true,\n    }),\n    [],\n  );\n\n  const handleCopy = React.useCallback((_, evt: ClipboardEvent) => {\n    if (!controller.canCopy) {\n      evt.preventDefault();\n    }\n  }, [controller]);\n\n  // 目前 code 的内容区域选区交互没有处理，暂时禁止掉 contextmenu 的触发\n  const handleContextMenu = React.useCallback((_, e: Event) => {\n    e.stopPropagation();\n    e.preventDefault();\n  }, []);\n\n  const handleMount = React.useCallback(() => {\n    // mount 之后不再需要占位高度\n    placeholderHeightRef.current = 0;\n    const he = height || parseInt(getComputedStyle(ref.current!).height, 10);\n    if (he) {\n      setZoomHeight(he);\n    }\n  }, [height]);\n\n  const style = React.useMemo(() => {\n    const s: React.CSSProperties = {\n      marginBottom: `${after}px`,\n      marginTop: `${before}px`,\n      marginLeft: `${bambooTheme.code['margin-left']}px`,\n      marginRight: `${bambooTheme.code['margin-right']}px`,\n      // eslint-disable-next-line no-nested-ternary\n      height: !print ? (height ? `${height}px` : 'inherit') : 'auto',\n      maxHeight: !print ? `${MAX_HEIGHT}px` : 'none',\n      // cm 未渲染时设置最小高度防止懒加载过程中高度剧烈抖动\n      minHeight: placeholderHeightRef.current ? placeholderHeightRef.current : undefined,\n      overflowY: 'visible',\n    };\n    // https://alidocs.dingtalk.com/i/nodes/e5vdDPq4wYa8a4aeLn9wJj7nbm10NkB9?cid=134024%3A372551849&dontjump=true&nav=spaces&navQuery=spaceId%3Dnb9XJv4jyWLaXyAp\n    if (zoom > 1) {\n      s.width = `${ 100 * zoom }%`;\n      s.transform = `scale(${ 1 / zoom })`;\n      s.transformOrigin = '0px 0px';\n      s.fontSize = `${11 * zoom}pt`;\n    }\n    return s;\n  }, [before, after, height, print, zoom]);\n\n  // hack 兼容 zoom 模式\n  const hackZoom = React.useMemo(() => zoomHeight > 0 && zoom > 1, [zoom, zoomHeight]);\n\n  return (\n    <div\n      data-type=\"code\"\n      {...rest}\n      style={{\n        ...style,\n        height: hackZoom ? `${zoomHeight / zoom}px` : style.height,\n      }}\n      ref={ref}\n    >\n      <CodeMirrorLazy\n        style={{\n          userSelect: 'text',\n          WebkitUserSelect: 'text',\n          height: hackZoom ? `${zoomHeight}px` : undefined,\n        }}\n        value={code}\n        options={options}\n        syntax={syntax}\n        theme={theme}\n        onContextMenu={handleContextMenu}\n        codeMirrorRef={wrapperRef}\n        onCopy={handleCopy}\n        wrap={lineWrapping}\n        print={print}\n        onEditorMount={handleMount}\n        controller={controller}\n        node={node}\n      />\n    </div>\n  );\n};\n\nexport default React.memo(Code);\n"],"file":"ZhiCode.js"}