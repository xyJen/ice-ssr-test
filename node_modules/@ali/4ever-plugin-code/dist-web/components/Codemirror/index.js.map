{"version":3,"sources":["../../../../src/components/Codemirror/index.tsx"],"names":["React","codemirror","noop","environment","useZoom","logger","Wrapper","diffsToPatchs","createCodeLanguages","loadLanguageMode","BASE_OPTIONS","lineNumbers","tabSize","scrollbarStyle","autoCloseBrackets","undoDepth","useEventEffect","editor","eventName","callback","callbackRef","useRef","useEffect","current","handleEvent","on","off","VALUE_UPDATE_BY_PROPS_CHANGE","prevSelectedIndex","prevFindText","FIND_NAME","FIND_SELECTED_NAME","COLLAB_SELECTION_NAME","CodeMirror","forwardRef","props","value","onEditorMount","className","options","syntax","theme","wrap","scale","style","onChanges","onBlur","onFocus","onGutterClick","onMouseDown","onDBClick","onTouchStart","onKeyDown","onContextMenu","onCopy","onBeforeSelectionChange","collabSelections","placeholder","print","controller","node","ref","useState","setEditor","isLocalChange","instance","fixedGutter","inputStyle","readOnly","viewportMargin","Infinity","onEditorBlur","useCallback","cm","evt","ranges","origin","onEditorChanges","e","changes","isValueUpdatedByProps","every","change","patches","getValue","zoom","useLayoutEffect","oldValue","console","error","sum","patch","isInsert","type","from","posFromIndex","offset","to","undefined","length","replacement","replaceRange","refresh","languages","useMemo","newSyntax","s","toLowerCase","match","find","lang","key","title","alias","map","a","includes","curSyntaxRef","then","l","setOption","clearMarkHasClassNames","classNames","getAllMarks","forEach","marker","clear","uid","selection","range","markText","anchor","head","data","findText","findAndReplaceVisible","query","decorations","document","selfDecorations","filter","d","start","closestBlock","getClosestBlock","selectedIndex","findIndex","mark","selected","searchCursor","getSearchCursor","line","ch","index","targetPosition","findNext","setCursor","IS_FIREFOX","memo"],"mappings":"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","sourcesContent":["/* eslint-disable no-unused-expressions */\nimport * as React from 'react';\nimport codemirror, { Editor, EditorConfiguration, EditorChange, Position } from 'codemirror';\n\n\n// cidemirror addon\nimport 'codemirror/addon/scroll/simplescrollbars.js';\nimport 'codemirror/addon/edit/closebrackets.js';\nimport 'codemirror/addon/display/placeholder.js';\nimport 'codemirror/addon/search/searchcursor.js';\nimport { noop } from 'lodash-es';\nimport { environment, useZoom, Controller, Block, Value } from '@ali/4ever-cangjie';\nimport logger from '@ali/4ever-logger';\nimport { Wrapper } from './styled';\nimport type { CodeSelectionChange } from './types';\nimport { diffsToPatchs, Patch } from './diffMatch';\nimport { createCodeLanguages } from '../../utils/constants/languages';\nimport { loadLanguageMode } from './languageLoader';\n\ninterface DomEvent<T = Event> {\n  (instance: Editor, event: T): void;\n}\n\ninterface CodeMirrorProps {\n  value: string;\n  onEditorMount?: (cm: Editor) => void;\n  options?: EditorConfiguration;\n  syntax: string;\n  theme: string;\n  wrap: boolean;\n  className?: string;\n  scale?: number;\n  onChanges?: (editor: Editor, data: EditorChange[], patches: Patch[]) => void;\n  onBlur?: DomEvent;\n  onFocus?: DomEvent;\n  onMouseDown?: DomEvent;\n  onDBClick?: DomEvent;\n  onTouchStart?: DomEvent;\n  onKeyDown?: DomEvent<KeyboardEvent>;\n  onContextMenu?: DomEvent;\n  onCopy?: DomEvent;\n  onGutterClick?: (\n    editor: Editor,\n    lineNumber: number,\n    gutter: string,\n    event: React.MouseEvent,\n  ) => void;\n  onBeforeSelectionChange?: (editor: Editor, data: CodeSelectionChange) => void;\n  isFocused?: boolean;\n  innerRef?: React.RefObject<HTMLDivElement>;\n  style?: React.CSSProperties;\n  collabSelections: Record<string, CodeSelectionChange>;\n  placeholder?: string;\n  print?: boolean;\n  controller?: Controller;\n  node?: Block;\n}\n\nconst BASE_OPTIONS: EditorConfiguration = {\n  lineNumbers: true,\n  tabSize: 2,\n  scrollbarStyle: 'overlay',\n  autoCloseBrackets: true,\n  undoDepth: 0,\n};\n\n\nconst useEventEffect = (editor: Editor | null, eventName: string, callback) => {\n  const callbackRef = React.useRef(callback);\n\n  React.useEffect(() => {\n    callbackRef.current = callback;\n  }, [callback]);\n\n  React.useEffect(() => {\n    if (editor) {\n      const handleEvent = (...params) => {\n        callbackRef.current(...params);\n      };\n      editor.on(eventName, handleEvent);\n      return () => editor.off(eventName, handleEvent);\n    }\n    return () => { };\n  }, [eventName, editor]);\n};\n\nconst VALUE_UPDATE_BY_PROPS_CHANGE = '__VALUE_UPDATE_BY_PROPS_CHANGE__';\n\nlet prevSelectedIndex = -1;\nlet prevFindText = '';\nconst FIND_NAME = 'find-and-replace';\nconst FIND_SELECTED_NAME = 'find-and-replace-selected';\nconst COLLAB_SELECTION_NAME = 'collab-selection';\n\nconst CodeMirror = React.forwardRef<HTMLElement, CodeMirrorProps>((props, forwardRef) => {\n  const {\n    value,\n    onEditorMount = noop,\n    className = '',\n    options,\n    syntax,\n    theme,\n    wrap = false,\n    scale = 1.0,\n    style,\n    onChanges = noop,\n    onBlur = noop,\n    onFocus = noop,\n    onGutterClick = noop,\n    onMouseDown = noop,\n    onDBClick = noop,\n    onTouchStart = noop,\n    onKeyDown = noop,\n    onContextMenu = noop,\n    onCopy = noop,\n    onBeforeSelectionChange = noop,\n    collabSelections,\n    placeholder,\n    print = false,\n    controller,\n    node,\n  } = props;\n  const ref = React.useRef<HTMLDivElement>(null);\n  const [editor, setEditor] = React.useState<Editor | null>(null);\n\n  // 用于标记当前是否由 onChange 触发导致 value 变化(非受控 => 受控)，此时 value 应该与 editor value 一致，防御性目的，防止无限循环\n  const isLocalChange = React.useRef(false);\n\n  React.useEffect(() => {\n    if (editor === null) {\n      const instance = codemirror(ref.current!, {\n        ...BASE_OPTIONS,\n        ...options,\n        fixedGutter: false,\n        value,\n        // force not use textarea due to zoom mode\n        inputStyle: options?.readOnly ? 'contenteditable' : 'textarea',\n        placeholder,\n        viewportMargin: print ? Infinity : 10,\n        readOnly: options?.readOnly ? 'nocursor' : false,\n      });\n      // 阻止移动端的事件冒泡到 slate-editor\n      onEditorMount(instance);\n      setEditor(instance);\n    }\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [onEditorMount, editor, value, print]);\n\n  React.useEffect(() => {\n    if (typeof forwardRef === 'function') {\n      forwardRef(ref.current);\n    } else if (forwardRef) {\n      forwardRef.current = ref.current;\n    }\n  }, [ref, forwardRef]);\n\n  const onEditorBlur = React.useCallback((cm, evt) => {\n    onBeforeSelectionChange(cm, {\n      ranges: [],\n      origin: 'blur',\n    });\n    onBlur(cm, evt);\n  }, [onBlur, onBeforeSelectionChange]);\n\n  const onEditorChanges = React.useCallback(\n    (e: Editor, changes: EditorChange[]) => {\n      const isValueUpdatedByProps = changes.every((change) => change.origin === VALUE_UPDATE_BY_PROPS_CHANGE);\n      if (isValueUpdatedByProps) {\n        return;\n      }\n      isLocalChange.current = true;\n      const patches = diffsToPatchs(value, e.getValue());\n      onChanges(e, changes, patches);\n    },\n    [value, onChanges],\n  );\n\n  const zoom = useZoom();\n\n  useEventEffect(editor, 'changes', onEditorChanges);\n  useEventEffect(editor, 'focus', onFocus);\n  useEventEffect(editor, 'blur', onEditorBlur);\n  useEventEffect(editor, 'gutterClick', onGutterClick);\n  useEventEffect(editor, 'mousedown', onMouseDown);\n  useEventEffect(editor, 'dblclick', onDBClick);\n  useEventEffect(editor, 'touchstart', onTouchStart);\n  useEventEffect(editor, 'keydown', onKeyDown);\n  useEventEffect(editor, 'contextmenu', onContextMenu);\n  useEventEffect(editor, 'copy', onCopy);\n  useEventEffect(editor, 'beforeSelectionChange', onBeforeSelectionChange);\n\n  // init\n  React.useLayoutEffect(() => {\n    if (editor) {\n      const oldValue = editor.getValue();\n\n      if (isLocalChange.current) {\n        isLocalChange.current = false;\n        // 防御措施，理论上不会走这段逻辑\n        if (value !== oldValue) {\n          console.error('EditorChange 转化为文字 Op 有逻辑缺陷，请检查');\n          logger.sum('CodeInvalidChangeToOp');\n          return;\n        }\n      }\n      if (value !== oldValue) {\n        const patches = diffsToPatchs(oldValue, value);\n        for (const patch of patches) {\n          const isInsert = patch.type === 'insert';\n          const from = editor.posFromIndex(patch.offset);\n          const to = isInsert ? undefined : editor.posFromIndex(patch.offset + patch.value.length);\n          const replacement = isInsert ? patch.value : '';\n\n          editor.replaceRange(replacement, from, to, VALUE_UPDATE_BY_PROPS_CHANGE);\n        }\n      }\n    }\n  }, [value, editor]);\n\n  // when zoom change, update fresh height\n  React.useEffect(() => {\n    editor?.refresh();\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [zoom]);\n\n  const languages = React.useMemo(() => createCodeLanguages(), []);\n\n  // model 里有的 syntax 是不标准的(比如语雀拷贝)，这里先做一层处理\n  const newSyntax = React.useMemo(() => {\n    const s = `${syntax}`.toLowerCase();\n    const match = languages.find(\n      (lang) => [\n        lang.key.toLowerCase(),\n        lang.title.toLowerCase(),\n        ...(lang.alias?.map(a => a.toLowerCase()) || []),\n      ].includes(s),\n    );\n    return match?.key || syntax;\n  }, [syntax, languages]);\n\n  // language mode 为异步加载，通过 ref 标记当前的 syntax\n  const curSyntaxRef = React.useRef(newSyntax);\n  curSyntaxRef.current = newSyntax;\n\n  React.useEffect(() => {\n    loadLanguageMode(newSyntax).then((l) => {\n      if (l === curSyntaxRef.current) {\n        editor?.setOption('mode', newSyntax);\n      }\n    }).catch(() => {});\n  }, [newSyntax, editor]);\n\n  // 避免闪烁\n  React.useLayoutEffect(() => {\n    editor && editor.setOption('theme', theme);\n  }, [theme, editor]);\n\n  const clearMarkHasClassNames = React.useCallback((classNames: string[]) => {\n    editor?.getAllMarks().forEach((marker) => {\n      // @ts-ignore codemirror type error\n      if (classNames.includes(marker.className)) {\n        marker.clear();\n      }\n    });\n  }, [editor]);\n\n  React.useEffect(() => {\n    editor && editor.setOption('lineWrapping', wrap || print);\n  }, [wrap, editor, print]);\n  // collabSelections 变化时，重新绘制协同 selection\n  React.useEffect(() => {\n    clearMarkHasClassNames([COLLAB_SELECTION_NAME]);\n    // eslint-disable-next-line guard-for-in\n    for (const uid in collabSelections) {\n      const selection = collabSelections[uid];\n      for (const range of selection.ranges) {\n        editor?.markText(range.anchor, range.head, {\n          className: 'collab-selection',\n        });\n      }\n    }\n  }, [collabSelections, editor]);\n\n  // 设置查找替换高亮\n  React.useEffect(() => {\n    if (!editor || !controller) {\n      return;\n    }\n    const { findText = '', findAndReplaceVisible } = controller.value.data;\n    if (!findAndReplaceVisible) {\n      clearMarkHasClassNames([FIND_NAME, FIND_SELECTED_NAME]);\n      return;\n    }\n\n    if (findText !== prevFindText) {\n      prevSelectedIndex = -1;\n    }\n\n    const { decorations, document }: Value = controller.query('getDataValue') || controller.value;\n    const selfDecorations = decorations.filter((d) => {\n      const { key } = d.start;\n      const closestBlock = document.getClosestBlock(key);\n      return closestBlock?.key === node?.key;\n    });\n\n    clearMarkHasClassNames([FIND_NAME, FIND_SELECTED_NAME]);\n\n    const selectedIndex = selfDecorations.findIndex(({ mark }) => mark.data.selected);\n    // @ts-ignore searchcursor.js 注入了该方法\n    const searchCursor = editor.getSearchCursor(findText, { line: 0, ch: 0 }, true);\n\n    let index = 0;\n    let targetPosition: Position | null = null;\n    while (searchCursor.findNext()) {\n      const selected = index === selectedIndex;\n\n      const from = searchCursor.from();\n      const to = searchCursor.to();\n      // eslint-disable-next-line @typescript-eslint/no-shadow\n      const className = selected ? FIND_SELECTED_NAME : FIND_NAME;\n      editor.markText(from, to, { className });\n      if (selected) {\n        targetPosition = { line: from.line, ch: to.ch };\n      }\n      index++;\n    }\n\n    if (targetPosition && prevSelectedIndex !== selectedIndex) {\n      editor.setCursor(targetPosition);\n    }\n\n    prevSelectedIndex = selectedIndex;\n    prevFindText = findText;\n  }, [clearMarkHasClassNames, controller, editor, node]);\n\n  return (\n    <Wrapper\n      style={style}\n      print={print}\n      theme={theme}\n      className={!environment.IS_FIREFOX ? `scaled ${className}` : className}\n      ref={ref}\n      scale={scale}\n      zoom={zoom}\n      readOnly={options?.readOnly}\n    />\n  );\n});\n\nexport default React.memo(CodeMirror);\n"],"file":"index.js"}