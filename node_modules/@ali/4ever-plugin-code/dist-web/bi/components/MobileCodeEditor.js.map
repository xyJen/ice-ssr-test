{"version":3,"sources":["../../../../src/bi/components/MobileCodeEditor.tsx"],"names":["React","CangjieSelectEvent","Selection","EdgePoint","useOnClickOutside","DEFAULT_THEME","SimpleCode","CodeEditor","props","locale","node","controller","data","theme","height","wrap","codeRef","useRef","wrapperRef","useState","selected","setSelected","isPreviewing","query","handleClickOutside","useCallback","setTimeout","handleSelect","event","preventDefault","stopPropagation","handleCursor","leftPoint","create","key","edge","run","selection","anchor","focus","target","document","querySelector","contains","position","text","memo"],"mappings":"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","sourcesContent":["/* eslint-disable react/destructuring-assignment */\nimport * as React from 'react';\nimport { Controller, Block, CangjieSelectEvent, Selection, EdgePoint } from '@ali/4ever-cangjie';\n\nimport { CodePluginConfig } from '../types';\nimport { useOnClickOutside } from '@ali/4ever-component';\nimport { DEFAULT_THEME } from '../../utils/constants/themes';\nimport SimpleCode from '../../components/SimpleCode';\n\nexport interface CodeEditorProps {\n  controller: Controller;\n  node: Block;\n  locale: CodePluginConfig['locale'];\n}\n\nconst CodeEditor: React.FC<CodeEditorProps> = (props) => {\n  const { locale, node, controller } = props;\n  const { data } = node;\n  const { theme = DEFAULT_THEME, height, wrap = false } = data;\n\n  const codeRef = React.useRef<HTMLPreElement>(null);\n  const wrapperRef = React.useRef<HTMLDivElement>(null);\n  const [selected, setSelected] = React.useState(false);\n  const isPreviewing = controller.query('isQuickPreview');\n\n  const handleClickOutside = React.useCallback(() => {\n    // 延迟让toolbar消失，避免组件销毁导致无法删除，400是toolbar逻辑防抖时间\n    setTimeout(() => {\n      setSelected(false);\n    }, 400);\n  }, []);\n\n  const handleSelect = React.useCallback(\n    (event: React.MouseEvent | React.TouchEvent) => {\n      event.preventDefault();\n      event.stopPropagation();\n      setSelected(true);\n    },\n    [],\n  );\n\n  const handleCursor = React.useCallback(() => {\n    // 移动端不知道为什么无法 focus 在 code 元素上，若不处理，光标会回到上一个地方，导致页面跳动。先 hack, click 后光标移动到代码块左端\n    const leftPoint = EdgePoint.create({\n      key: node.key,\n      edge: 'before',\n    });\n    controller.run(\n      'onCangjieSelect',\n      CangjieSelectEvent({\n        selection: Selection.create({\n          anchor: leftPoint,\n          focus: leftPoint,\n        }),\n      }),\n    );\n  }, [controller, node]);\n\n  useOnClickOutside(codeRef, handleClickOutside, false, (target) => {\n    // 目前难以获取整个 toolbar 的 dom ref，先临时处理 delete button 解决无法删除的 bug；后续改造成基于 isSelected 判断是否展示 toolbar\n    return document.querySelector('div[data-testid=\"code-block-remove\"]')?.contains(target) || false;\n  });\n  return (\n    <div ref={wrapperRef} style={{ position: 'relative' }}>\n      <SimpleCode\n        ref={codeRef}\n        code={node.text}\n        theme={theme}\n        height={height}\n        node={node}\n        onTouchStart={handleSelect}\n        onMouseDown={handleSelect}\n        onClick={handleCursor}\n        lineWrapping={wrap}\n      />\n    </div>\n  );\n};\n\nexport default React.memo(CodeEditor);\n"],"file":"MobileCodeEditor.js"}