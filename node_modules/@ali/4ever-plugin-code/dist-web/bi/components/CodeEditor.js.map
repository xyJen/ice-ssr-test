{"version":3,"sources":["../../../../src/bi/components/CodeEditor.tsx"],"names":["React","isKeyHotkey","environment","useZoomContainer","changeCode","focusToCodeEditor","focusToTextEditor","removeCode","changeCodeData","blurCode","CodeInlineToolbar","Resizable","getFocusState","setFocusState","CodeGlobalStyle","DEFAULT_LANGUAGE","DEFAULT_THEME","getCodeHeight","HEIGHT_PADDING","MAX_HEIGHT","CodeMirrorLazy","isFindHotKey","IS_FIREFOX","isAtStartOfCodeEditor","cm","cursor","getCursor","line","ch","Pass","CodeEditor","props","locale","controller","node","onSave","cursorPos","isSelected","data","zoomContainer","document","body","disableInlineToolbar","query","id","syntax","theme","height","wrap","collabSelections","cmRef","useRef","wrapperRef","controllerRef","nodeRef","useState","isResizing","setIsResizing","draggingHeight","setDraggingHeight","lineHeight","setLineHeight","scale","focus","useCallback","current","run","backToTextEditor","direction","undefined","removeCodeEditor","getValue","length","onHistory","type","dispatch","options","useMemo","cursorBlinkRate","extraKeys","Backspace","Left","Up","Esc","isNullOrUndefined","dragHeight","setSize","codeHeight","handleBlur","handleDidMount","position","setCursor","defaultTextHeight","refresh","handleChange","_editor","_changes","patches","handleGutterClick","gutter","event","preventDefault","stopPropagation","hasFocus","handleResize","_","size","handleResizeStart","handleResizeStop","handleKeyDown","handleContextMenu","codemirrorIgnore","state","delayingBlurEvent","handleResizeClick","useEffect","useLayoutEffect","execCommand","widthRange","Infinity","heightRange","isCodeFocused","value","selection","isCollapsed","showResize","autoHeight","didMount","commonStyle","maxHeight","minHeight","resizableStyle","transform","transformOrigin","width","enableBorderHighlight","Math","min","color","backgroundColor","key","text","placeholder"],"mappings":"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","sourcesContent":["/* eslint-disable react/destructuring-assignment */\nimport * as React from 'react';\nimport { isKeyHotkey } from 'is-hotkey';\nimport { Controller, Block, environment, useZoomContainer } from '@ali/4ever-cangjie';\nimport type {\n  Editor as CodeMirrorEditor,\n  EditorConfiguration,\n} from 'codemirror';\nimport {\n  changeCode,\n  focusToCodeEditor,\n  focusToTextEditor,\n  FocusDirection,\n  removeCode,\n  changeCodeData,\n  blurCode,\n} from '../actions';\n\nimport CodeInlineToolbar from './CodeInlineToolbar';\nimport { CodePluginConfig } from '../types';\nimport { Resizable } from '@ali/4ever-component';\nimport { getFocusState, setFocusState, CodeMirrorPosition } from '../store';\nimport CodeGlobalStyle from './CodeGlobalStyle';\nimport { DEFAULT_LANGUAGE } from '../../utils/constants/languages';\nimport { DEFAULT_THEME } from '../../utils/constants/themes';\nimport getCodeHeight from '../../components/Codemirror/utils';\nimport { HEIGHT_PADDING, MAX_HEIGHT } from '../../utils/constants/dimension';\nimport { CodeMirrorLazy } from '../../components/LazyCodemirror';\n\nconst isFindHotKey = isKeyHotkey('mod+f');\nconst { IS_FIREFOX } = environment;\n\nexport interface CodeEditorProps {\n  isSelected: boolean;\n  controller: Controller;\n  node: Block;\n  locale: CodePluginConfig['locale'];\n  onSave?: () => void;\n  cursorPos: 'start' | 'end' | {\n    line: number;\n    ch: number;\n  };\n}\n\nfunction isAtStartOfCodeEditor(cm: CodeMirrorEditor) {\n  const cursor = cm.getCursor();\n  return cursor.line === 0 && cursor.ch === 0;\n}\n\nconst Pass = 'CodeMirror.Pass';\n\nconst CodeEditor: React.FC<CodeEditorProps> = (props) => {\n  const { locale, controller, node, onSave = () => {}, cursorPos = 'end', isSelected } = props;\n  const { data } = node;\n  const zoomContainer = useZoomContainer() || document.body;\n  const disableInlineToolbar = controller.query('hasHoverToolbar', 'code');\n\n  const { id, syntax = DEFAULT_LANGUAGE, theme = DEFAULT_THEME, height, wrap = false, collabSelections = {} } = data;\n\n  const cmRef = React.useRef<CodeMirrorEditor | null>(null);\n  const wrapperRef = React.useRef<HTMLDivElement | null>(null);\n  const controllerRef = React.useRef(controller);\n  const nodeRef = React.useRef(node);\n\n  const [isResizing, setIsResizing] = React.useState(false);\n  const [draggingHeight, setDraggingHeight] = React.useState<number>(() => getCodeHeight(node));\n  const [lineHeight, setLineHeight] = React.useState(0);\n  const scale = 1.0;\n\n  const focus = React.useCallback(() => {\n    setFocusState(id, true);\n    controllerRef.current.run('onAction', focusToCodeEditor(nodeRef.current));\n  }, []);\n\n  const backToTextEditor = React.useCallback((direction?: FocusDirection) => {\n    controllerRef.current.run(\n      'onAction',\n      focusToTextEditor(nodeRef.current, direction),\n    );\n    return undefined;\n  }, []);\n\n  const removeCodeEditor = React.useCallback((cm: CodeMirrorEditor) => {\n    if (isAtStartOfCodeEditor(cm) && !cm.getValue().length) {\n      controllerRef.current.run('onAction', removeCode(nodeRef.current));\n      return undefined;\n    }\n    return Pass;\n  }, []);\n\n  // undo、redo\n  const onHistory = React.useCallback(\n    (type: 'undo' | 'redo') => {\n      controller.dispatch(type === 'undo' ? 'undo' : 'redo');\n    },\n    [controller],\n  );\n\n  const options = React.useMemo(\n    () => ({\n      cursorBlinkRate: 530,\n      extraKeys: {\n        Backspace: removeCodeEditor,\n        Left: (cm) => {\n          if (isAtStartOfCodeEditor(cm)) {\n            return backToTextEditor('left');\n          }\n          return Pass;\n        },\n        Up: (cm) => {\n          if (cm.getCursor().line === 0) {\n            return backToTextEditor('up');\n          }\n          return Pass;\n        },\n        Esc: () => backToTextEditor(),\n        'Ctrl-S': () => {\n          onSave();\n        },\n        'Cmd-S': () => {\n          onSave();\n        },\n        'Ctrl-Z': () => {\n          onHistory('undo');\n        },\n        'Shift-Ctrl-Z': () => {\n          onHistory('redo');\n        },\n        'Cmd-Z': () => {\n          onHistory('undo');\n        },\n        'Shift-Cmd-Z': () => {\n          onHistory('redo');\n        },\n      },\n    }),\n    [backToTextEditor, removeCodeEditor, onSave, onHistory],\n  );\n\n  const isNullOrUndefined = (dragHeight) => {\n    return dragHeight === null || dragHeight === undefined;\n  };\n\n  const setSize = React.useCallback(\n    () => {\n      if (isNullOrUndefined(height)) {\n        const codeHeight = getCodeHeight(node);\n        setDraggingHeight(codeHeight);\n      }\n    },\n    [height, node],\n  );\n\n  const handleBlur = React.useCallback(() => {\n    setFocusState(id, false);\n    controllerRef.current.run('onAction', blurCode());\n  }, []);\n\n  const handleDidMount = React.useCallback(\n    (cm: CodeMirrorEditor) => {\n      cmRef.current = cm;\n      // 防止文档打开时，focus 到代码块\n      const position = getFocusState(id);\n      if (position) {\n        cm.focus();\n        if (position !== true) {\n          cm.setCursor(position);\n        }\n        focus();\n      }\n      setSize();\n      const dragHeight = isNullOrUndefined(height) ? getCodeHeight(node) : height;\n      setDraggingHeight(dragHeight);\n      setLineHeight(cm.defaultTextHeight());\n      cm.refresh();\n    },\n    [id, setSize, height, focus],\n  );\n\n  const handleChange = React.useCallback(\n    (_editor, _changes, patches) => {\n      controllerRef.current.run(\n        'onAction',\n        changeCode({ patches, node: nodeRef.current }),\n      );\n    },\n    [],\n  );\n\n  const handleGutterClick = React.useCallback(\n    (\n      cm: CodeMirrorEditor,\n      line: number,\n      gutter: string,\n      event: React.MouseEvent,\n    ) => {\n      event.preventDefault();\n      event.stopPropagation();\n      if (!cm.hasFocus()) {\n        cm.focus();\n      }\n      cm.setCursor({ line, ch: 0 });\n    },\n    [],\n  );\n\n  const handleResize = React.useCallback((_, size) => {\n    setDraggingHeight(size.height);\n  }, []);\n\n  const handleResizeStart = React.useCallback(() => {\n    setIsResizing(true);\n  }, []);\n\n  const handleResizeStop = React.useCallback((_, size) => {\n    setIsResizing(false);\n    cmRef.current!.focus();\n    controllerRef.current.run(\n      'onAction',\n      changeCodeData(nodeRef.current, { height: size.height }),\n    );\n  }, []);\n\n  const handleKeyDown = React.useCallback((_, event: KeyboardEvent) => {\n    /**\n     * 对于部分组合键输入，执行stopPropagation后只是阻止往上冒泡，但并不会阻止浏览器默认行为，除非执行preventDefault。\n     * 这里不做stopPropagation处理，交由外层查找替换插件来处理。\n     */\n    if (isFindHotKey(event)) {\n      return;\n    }\n    event.stopPropagation();\n  }, []);\n\n  // 禁用右键菜单，防止弹出 cangjie menu\n  const handleContextMenu = React.useCallback((cm, event: React.MouseEvent) => {\n    // @ts-ignore codemirror event\n    event.codemirrorIgnore = true;\n    // 默认代码块 contextmenu 拦截的话，会 blur，通过 delayingBlurEvent 标记阻拦这一行为。\n    cm.state.delayingBlurEvent = false;\n    event.preventDefault();\n    event.stopPropagation();\n  }, []);\n\n  const handleResizeClick = React.useCallback((event: React.MouseEvent) => {\n    event.stopPropagation();\n  }, []);\n\n  React.useEffect(() => {\n    if (cmRef.current) {\n      cmRef.current.refresh();\n    }\n  }, [scale]);\n\n  React.useLayoutEffect(() => {\n    if (!isNullOrUndefined(height)) {\n      setDraggingHeight(height);\n    }\n  }, [height]);\n\n  React.useEffect(() => {\n    nodeRef.current = node;\n    controllerRef.current = controller;\n  }, [node, controller]);\n\n  React.useEffect(() => {\n    return () => {\n      // 代码块无论何时被删除时，更新 focusCode ，解决新建代码块后光标在代码块里，再 undo focusCode 不更新的 bug\n      controllerRef.current.run('onAction', blurCode());\n\n      if (!cmRef.current || !cmRef.current.hasFocus()) return;\n      const position: CodeMirrorPosition = cmRef.current.getCursor();\n      setFocusState(id, position);\n    };\n  }, []);\n\n  // 光标位置\n  React.useEffect(() => {\n    if (!cmRef.current?.hasFocus()) {\n      return;\n    }\n    if (cursorPos === 'start') {\n      cmRef.current?.execCommand('goDocStart');\n    } else if (cursorPos === 'end') {\n      cmRef.current?.execCommand('goDocEnd');\n    } else {\n      cmRef.current?.setCursor(cursorPos);\n    }\n  }, [cursorPos]);\n\n  // node 变化时，重新计算高度\n  React.useEffect(() => {\n    if (cmRef.current) {\n      setSize();\n    }\n  }, [node, setSize]);\n\n  const widthRange = React.useMemo<[number, number]>(() => [0, Infinity], []);\n  const heightRange = React.useMemo<[number, number]>(\n    () => [lineHeight + HEIGHT_PADDING, MAX_HEIGHT],\n    [lineHeight],\n  );\n\n  const isCodeFocused = isSelected && controller.value.selection.isCollapsed;\n  const showResize = isResizing || isCodeFocused;\n\n  // 解决从弹性变为 fixed 时，不出现 scrollBar 的问题。只有从弹性变为 fixed 才触发\n  const autoHeight = isNullOrUndefined(height) && draggingHeight < MAX_HEIGHT && !isResizing;\n  const didMount = React.useRef(false);\n  React.useEffect(() => {\n    if (!didMount.current) {\n      didMount.current = true;\n      return;\n    }\n    if (!autoHeight) {\n      cmRef.current?.refresh();\n    }\n  }, [autoHeight]);\n\n  // FIREFOX 下，不进行放缩\n  const commonStyle: React.CSSProperties = {\n    maxHeight: `${MAX_HEIGHT}px`,\n    // cm 未渲染时设置最小高度防止懒加载过程中高度剧烈抖动\n    minHeight: cmRef.current ? undefined : draggingHeight,\n  };\n  const resizableStyle = IS_FIREFOX\n    ? {\n      transform: `scale(${1.0 / scale})`,\n      transformOrigin: 'top left',\n      width: `${100 * scale}%`,\n      ...commonStyle,\n    }\n    : {\n      ...commonStyle,\n    };\n\n  const enableBorderHighlight = controller.query('enableBorderHighlight');\n\n  return (\n    <Resizable\n      innerRef={wrapperRef}\n      axis=\"y\"\n      width={Infinity}\n      height={Math.min(draggingHeight || 0, MAX_HEIGHT)}\n      widthRange={widthRange}\n      heightRange={heightRange}\n      onResize={handleResize}\n      onResizeStart={handleResizeStart}\n      onResizeStop={handleResizeStop}\n      onClick={handleResizeClick}\n      visible={showResize}\n      style={resizableStyle}\n      speed={IS_FIREFOX ? 1.0 : 1.0 / scale}\n      zoomContainer={zoomContainer}\n      handleStyle={\n        theme === 'dracula'\n          ? { color: 'rgba(255, 255, 255, 0.4)', backgroundColor: '#111F2C' }\n          : {}\n      }\n      autoHeight={autoHeight}\n      isActive={isCodeFocused}\n      enableBorderHighlight={enableBorderHighlight}\n    >\n      <CodeGlobalStyle />\n      {!disableInlineToolbar && isCodeFocused ? <CodeInlineToolbar\n        controller={controller}\n        node={node}\n        locale={locale}\n        triggerNode={wrapperRef.current}\n        focusedCodeKey={node.key}\n      /> : null}\n      <CodeMirrorLazy\n        value={node.text}\n        options={(options as unknown) as EditorConfiguration}\n        syntax={syntax}\n        theme={theme}\n        wrap={wrap}\n        onEditorMount={handleDidMount}\n        onChanges={handleChange}\n        onFocus={focus}\n        onBlur={handleBlur}\n        onGutterClick={handleGutterClick}\n        onKeyDown={handleKeyDown}\n        onContextMenu={handleContextMenu}\n        scale={scale}\n        collabSelections={collabSelections}\n        placeholder={locale.placeholder}\n        controller={controller}\n        node={node}\n      />\n    </Resizable>\n  );\n};\n\nexport default CodeEditor;\n"],"file":"CodeEditor.js"}