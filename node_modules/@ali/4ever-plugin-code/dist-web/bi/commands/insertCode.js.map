{"version":3,"sources":["../../../../src/bi/commands/insertCode.ts"],"names":["Commands","Block","Text","isNil","biActions","basicActions","FOCUSED_CODE","findClosestCodeSetting","DEFAULT_LANGUAGE","DEFAULT_THEME","createInsertCode","config","insertCode","controller","id","code","syntax","theme","value","focusBlock","selection","blocks","document","type","command","insertBlock","isCollapsed","focus","isAtEndOfNode","moveToEndOfBlock","codeSetting","getDefaultSetting","closestSyntax","closestTheme","defaultTheme","defaultSyntax","data","height","text","isExpanded","map","block","join","codeNode","create","nodes","run","createInsertBlockWithoutExtraBlankAction","node","createMergeDataAction","key"],"mappings":"AAAA,SAAqBA,QAArB,EAA+BC,KAA/B,EAAsCC,IAAtC,QAAkD,oBAAlD;AACA,SAASC,KAAT,QAAsB,WAAtB;AACA,SAASC,SAAS,IAAIC,YAAtB,QAA0C,yBAA1C;AACA,SAASC,YAAT;AAEA,OAAOC,sBAAP;AACA,SAASC,gBAAT;AACA,SAASC,aAAT;AAEA,eAAe,SAASC,gBAAT,CAA2BC,MAA3B,EAAsD;AACnE,SAAO,SAASC,UAAT,CACLC,UADK,EAELC,EAFK,EAGLC,IAHK,EAILC,MAJK,EAKLC,KALK,EAML;AAAA;;AAAA,4BACoDJ,UAAU,CAACK,KAD/D;AAAA,QACQC,UADR,qBACQA,UADR;AAAA,QACoBC,SADpB,qBACoBA,SADpB;AAAA,QAC+BC,MAD/B,qBAC+BA,MAD/B;AAAA,QACuCC,QADvC,qBACuCA,QADvC;;AAEA,QAAI,CAACF,SAAD,IAAc,CAACD,UAAnB,EAA+B;AAC7B,aAAON,UAAP;AACD,KAJD,CAMA;;;AACA,QAAIM,UAAU,CAACI,IAAX,KAAoB,MAAxB,EAAgC;AAC9BV,MAAAA,UAAU,CAACW,OAAX,CAAmBxB,QAAQ,CAACyB,WAA5B,EAAyC;AAAEF,QAAAA,IAAI,EAAE;AAAR,OAAzC;AACD,KATD,CAWA;;;AACA,QACEH,SAAS,CAACM,WAAV,IACA,CAACN,SAAS,CAACO,KAAV,CAAgBC,aAAhB,CAA8BT,UAA9B,CAFH,EAGE;AACAN,MAAAA,UAAU,CAACW,OAAX,CAAmBxB,QAAQ,CAAC6B,gBAA5B;AACD;;AAED,QAAMC,WAAW,GAAG,CAAAnB,MAAM,QAAN,YAAAA,MAAM,CAAEoB,iBAAR,KAA6BpB,MAAM,CAACoB,iBAAP,EAAjD;;AAnBA,eAuBIxB,sBAAsB,CAACe,QAAD,EAAWH,UAAX,EAAuBH,MAAvB,CAAtB,IAAwD,EAvB5D;AAAA,2BAqBEA,MArBF;AAAA,QAqBUgB,aArBV,4BAqB0BxB,gBArB1B;AAAA,0BAsBES,KAtBF;AAAA,QAsBSgB,YAtBT,2BAsBwBxB,aAtBxB;;AAwBA,QAAMyB,YAAY,GAAGJ,WAAW,QAAX,IAAAA,WAAW,CAAEb,KAAb,GAAqBa,WAAW,CAACb,KAAjC,GAAyCgB,YAA9D;AACA,QAAME,aAAa,GAAGL,WAAW,QAAX,IAAAA,WAAW,CAAEd,MAAb,GAAsBc,WAAW,CAACd,MAAlC,GAA2CgB,aAAjE;AAEA,QAAMI,IAAuB,GAAG;AAC9BpB,MAAAA,MAAM,EAAEb,KAAK,CAACa,MAAD,CAAL,GAAgBmB,aAAhB,GAAgCnB,MADV;AAE9BC,MAAAA,KAAK,EAAEd,KAAK,CAACc,KAAD,CAAL,GAAeiB,YAAf,GAA8BjB,KAFP;AAG9BoB,MAAAA,MAAM,EAAE,IAHsB;AAI9BvB,MAAAA,EAAE,EAAFA;AAJ8B,KAAhC;AAOA,QAAIwB,IAAY,GAAGvB,IAAnB;;AACA,QAAIZ,KAAK,CAACY,IAAD,CAAT,EAAiB;AACfuB,MAAAA,IAAI,GAAGlB,SAAS,CAACmB,UAAV,GACHlB,MAAM,CAACmB,GAAP,CAAW,UAACC,KAAD;AAAA,eAAWA,KAAK,CAACH,IAAjB;AAAA,OAAX,EAAkCI,IAAlC,CAAuC,IAAvC,CADG,GAEH,EAFJ;AAGD;;AAED,QAAMC,QAAQ,GAAG1C,KAAK,CAAC2C,MAAN,CAAa;AAC5BrB,MAAAA,IAAI,EAAE,MADsB;AAE5Ba,MAAAA,IAAI,EAAJA,IAF4B;AAG5BS,MAAAA,KAAK,EAAE,CAAC3C,IAAI,CAAC0C,MAAL,CAAYN,IAAZ,CAAD;AAHqB,KAAb,CAAjB;AAMAzB,IAAAA,UAAU,CAACiC,GAAX,CAAe,UAAf,EAA2BzC,YAAY,CAAC0C,wCAAb,CAAsD;AAC/EC,MAAAA,IAAI,EAAEL;AADyE,KAAtD,CAA3B;AAGA9B,IAAAA,UAAU,CAACiC,GAAX,CAAe,UAAf,EAA2BzC,YAAY,CAAC4C,qBAAb,oDACxB3C,YADwB,IACTqC,QAAQ,CAACO,GADA,yBAA3B;AAIA,WAAOrC,UAAP;AACD,GA7DD;AA8DD","sourcesContent":["import { Controller, Commands, Block, Text } from '@ali/4ever-cangjie';\nimport { isNil } from 'lodash-es';\nimport { biActions as basicActions } from '@ali/4ever-plugin-basic';\nimport { FOCUSED_CODE } from '../constants/value';\nimport { CodeData, CodePluginConfig } from '../types';\nimport findClosestCodeSetting from '../utils/findClosestCodeSetting';\nimport { DEFAULT_LANGUAGE } from '../../utils/constants/languages';\nimport { DEFAULT_THEME } from '../../utils/constants/themes';\n\nexport default function createInsertCode (config?: CodePluginConfig) {\n  return function insertCode(\n    controller: Controller,\n    id: string,\n    code?: string,\n    syntax?: string,\n    theme?: string,\n  ) {\n    const { focusBlock, selection, blocks, document } = controller.value;\n    if (!selection || !focusBlock) {\n      return controller;\n    }\n\n    // 代码行之间保证有空行\n    if (focusBlock.type === 'code') {\n      controller.command(Commands.insertBlock, { type: 'paragraph' });\n    }\n\n    // 防止段落被 split\n    if (\n      selection.isCollapsed &&\n      !selection.focus.isAtEndOfNode(focusBlock)\n    ) {\n      controller.command(Commands.moveToEndOfBlock);\n    }\n\n    const codeSetting = config?.getDefaultSetting && config.getDefaultSetting();\n    const {\n      syntax: closestSyntax = DEFAULT_LANGUAGE,\n      theme: closestTheme = DEFAULT_THEME,\n    } = findClosestCodeSetting(document, focusBlock, syntax) || {};\n    const defaultTheme = codeSetting?.theme ? codeSetting.theme : closestTheme;\n    const defaultSyntax = codeSetting?.syntax ? codeSetting.syntax : closestSyntax;\n\n    const data: Partial<CodeData> = {\n      syntax: isNil(syntax) ? defaultSyntax : syntax,\n      theme: isNil(theme) ? defaultTheme : theme,\n      height: null,\n      id,\n    };\n\n    let text: string = code!;\n    if (isNil(code)) {\n      text = selection.isExpanded\n        ? blocks.map((block) => block.text).join('\\n')\n        : '';\n    }\n\n    const codeNode = Block.create({\n      type: 'code',\n      data,\n      nodes: [Text.create(text)],\n    });\n\n    controller.run('onAction', basicActions.createInsertBlockWithoutExtraBlankAction({\n      node: codeNode,\n    }));\n    controller.run('onAction', basicActions.createMergeDataAction({\n      [FOCUSED_CODE]: codeNode.key,\n    }));\n\n    return controller;\n  }\n}\n"],"file":"insertCode.js"}