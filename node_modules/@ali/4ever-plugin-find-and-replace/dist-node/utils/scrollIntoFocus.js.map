{"version":3,"sources":["../../../src/utils/scrollIntoFocus.ts"],"names":["calcPageOffsetTop","document","pageIndex","scale","gap","data","pagesInfo","pages","nodes","slice","pageOffsetTop","reduce","top","page","rect","pi","currentHeight","height","calcPageOffsetTopOfKey","key","getFurthestAncestor","path","getPath","scrollToTop","target","Window","scrollTo","scrollX","scrollTop","scrollIntoVirtualPage","controller","container","value","virtualMap","isVirtual","offsetTop","scrollIntoFocus","window","findText","onCustomScroll","transferredKey","enableVirtualize","domUtils","scrollToNodeByKey","closestBlock","getClosestBlock","selectedDom","findDOMNodeSafely","getParent","createPerfLazyRenderPlugin","showPrunedElements","scrollIntoView","block","inline","behavior"],"mappings":"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","sourcesContent":["import {\n  Controller,\n  domUtils,\n  createPerfLazyRenderPlugin,\n  Document,\n} from '@ali/4ever-cangjie';\n\nimport setAncestorsUnfold from './setAncestorsUnfold';\nimport isPi from './isPi';\nimport transferKey from './transferKey';\n\nconst calcPageOffsetTop = (\n  document: Document,\n  pageIndex: number,\n  scale = 1.0,\n): number => {\n  const gap = document.data?.pagesInfo?.gap || 0;\n  // 计算页面的整体 offset 高度\n  const pages = document.nodes.slice(0, pageIndex);\n  const pageOffsetTop = pages.reduce((top, page) => {\n    const { rect } = page.data.pi;\n    const currentHeight = (rect.height + gap) * scale;\n    return top + currentHeight;\n  }, 0);\n\n  return pageOffsetTop;\n};\n\nconst calcPageOffsetTopOfKey = (document: Document, key: string): number => {\n  // 找到锚点所在的 page\n  const page = document.getFurthestAncestor(key);\n  const path = document.getPath(page!.key);\n  // 当前 page 的页数\n  const pageIndex = path![0];\n  return calcPageOffsetTop(document, pageIndex);\n};\n\nconst scrollToTop = (target: HTMLElement | Window, top: number) => {\n  if (target instanceof Window) {\n    target.scrollTo(target.scrollX, top);\n  } else {\n    target.scrollTop = top;\n  }\n};\n\nconst scrollIntoVirtualPage = (\n  key: string,\n  controller: Controller,\n  container: HTMLElement | Window,\n) => {\n  const { document } = controller.value;\n  const virtualMap: Record<string, boolean> = document.data.virtualMap || {};\n\n  // 找到锚点所在的 page\n  const page = document.getFurthestAncestor(key);\n\n  // 是否虚拟化\n  const isVirtual = page ? !!virtualMap[page.key] : false;\n  if (isVirtual && container) {\n    const offsetTop = calcPageOffsetTopOfKey(document, key);\n    scrollToTop(container, offsetTop);\n  }\n};\n\nconst scrollIntoFocus = async (\n  key: string,\n  controller: Controller,\n  container: HTMLElement | Window = window,\n  findText?: string,\n  onCustomScroll?: (dom: HTMLElement) => void,\n) => {\n  const { document } = controller.value;\n  const transferredKey = transferKey(key, controller, findText);\n\n  if (isPi(controller)) {\n    // 如果页面有虚拟化, 先滚动到虚拟化页面\n    scrollIntoVirtualPage(transferredKey, controller, container);\n  } else {\n    // 如果内容在标题折叠内，自动展开标题折叠\n    try {\n      if (controller.enableVirtualize) {\n        await domUtils.scrollToNodeByKey(transferredKey, controller);\n      }\n      const closestBlock = document.getClosestBlock(transferredKey);\n      if (closestBlock) {\n        setAncestorsUnfold(controller, closestBlock);\n      }\n    } catch {\n      // 不存在标题折叠\n    }\n  }\n\n  const selectedDom =\n    domUtils.findDOMNodeSafely(transferredKey) ||\n    domUtils.findDOMNodeSafely(document.getParent(transferredKey)?.key || '');\n\n  if (selectedDom) {\n    createPerfLazyRenderPlugin.showPrunedElements(selectedDom);\n    if (onCustomScroll) {\n      onCustomScroll(selectedDom);\n    } else {\n      selectedDom.scrollIntoView({\n        block: 'center',\n        inline: 'center',\n        behavior: 'auto',\n      });\n    }\n  }\n  return controller;\n};\n\nexport default scrollIntoFocus;\n"],"file":"scrollIntoFocus.js"}