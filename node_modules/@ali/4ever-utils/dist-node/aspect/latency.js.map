{"version":3,"sources":["../../../src/aspect/latency.ts"],"names":["debug","onLatency","key","cost","success","status","connect","speed","reporter","latency","fn","options","callback","_latency","args","start","Date","now","rs","apply","Promise","then","catch","res","err","Latency","deco","target","propertyKey","descriptor","value","TypeError","String","onFrameCallback","type","frameMap","Map","latencyCurrentFrame","leading","has","set","frameEnd","get","delete","isNaN","Error","window","requestAnimationFrame","resolve","setTimeout","console","warn","latencyFrame","LatencyFrame","onTotalCallback","total","latencyTotal","counting","_latencyTotal","onceCost","LatencyTotal"],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport Debug from 'debug';\n\nconst debug = Debug('EDITOR:UTIL:ASPECT:LATENCY');\n\nexport type Callback = (key: string, cost: number, success?: boolean) => void;\n\nexport interface LatencyOptions {\n  callback?: Callback;\n}\n\nfunction onLatency(key: string, cost: number, success = true) {\n  const status = success ? 'success' : 'failed';\n  debug('Latency %s %c%s: %c%dms', status, 'color: dodgerblue', key, 'color: orange', cost);\n}\n\nexport function connect(speed: (key: string, value?: number) => void): Callback {\n  return function reporter(key, cost, success = true) {\n    onLatency(key, cost, success);\n    const status = success ? 'success' : 'failed';\n    speed(`latency_${key}_${status}`, cost);\n  };\n}\n\n/**\n * 函数计时打点，支持同步函数和异步函数计时\n * @param key 打点的 key\n * @param fn 装饰的函数\n * @param callback 自定义打点\n */\nexport function latency<T extends Function>(key: string, fn: T, options: LatencyOptions = {}): T {\n  const { callback = onLatency } = options;\n  return function _latency(this: any, ...args: any[]) {\n    const start = Date.now();\n    const rs = fn.apply(this, args);\n    // 如果函数是 async 函数\n    if (rs instanceof Promise && rs.then && (rs as any).catch) {\n      return rs.then((res) => {\n        callback(key, Date.now() - start, true);\n        return res;\n      }).catch((err) => {\n        callback(key, Date.now() - start, false);\n        throw err;\n      });\n    }\n    callback(key, Date.now() - start);\n    return rs;\n  } as unknown as T;\n}\n\n\n/**\n * 函数计时装饰器，支持同步函数和异步函数计时\n * @param key 打点计时 key\n */\nexport function Latency(key: string, options?: LatencyOptions): MethodDecorator {\n  return function deco<F>(\n    target: object,\n    propertyKey: string | symbol,\n    descriptor: TypedPropertyDescriptor<F>,\n  ): TypedPropertyDescriptor<F> {\n    if (!descriptor || (typeof descriptor.value !== 'function')) {\n      throw new TypeError(`Only methods can be decorated with @Latency. <${String(propertyKey)}> is not a method!`);\n    }\n    return {\n      ...descriptor,\n      value: latency(key, descriptor.value, options) as any,\n    };\n  };\n}\n\n\nexport type FrameCallback = (key: string, cost: number, type: LatencyFrameType) => void;\n\nexport type LatencyFrameType = 'frame' | 'microtask' | 'macrotask';\n\nfunction onFrameCallback(key: string, cost: number, type: LatencyFrameType) {\n  debug('Latency %s %c%s: %c%dms', type, 'color: dodgerblue', key, 'color: orange', cost);\n}\n\nexport interface LatencyFrameOptions {\n  /**\n   * Frame 类型\n   * frame - 探测一帧的延迟时间，延迟方法为 window.requestAnimationFrame()\n   * microtask - 探测一个 microtask 的延迟时间，延迟方法为 Promise.resolve().then()\n   * macrotask - 探测一个 macrotask 的延迟时间，延迟方法为 window.setTimeout()\n   * @default 'frame'\n   * @description 注意 macrotask 不一定能保证是仅有一个 Event Loop\n   */\n  type?: LatencyFrameType;\n  /**\n   * 若在当前 Exec Stack 中多次触发，起始点取值是否为第一次，false 则取最后一次\n   * @default true\n   */\n  leading?: boolean;\n  callback?: FrameCallback;\n}\n\ntype Timestamp = number;\n\n// 计时器缓存\nconst frameMap = new Map<string, Timestamp>();\n\n/**\n * 记录当前执行点至下一帧的耗时，帧类型支持三种 frame | microtask | macrotask\n * @param key 计时 key\n * @param options\n */\nexport function latencyCurrentFrame(key: string, options: LatencyFrameOptions = {}) {\n  const {\n    leading = true,\n    callback = onFrameCallback,\n    type = 'frame' as LatencyFrameType,\n  } = options;\n\n  // 如果缓存中有 key，则直接 return\n  if (frameMap.has(key)) {\n    // 非 leading 模式重置计时\n    if (!leading) {\n      frameMap.set(key, Date.now());\n    }\n    return;\n  }\n\n  // 计时结束\n  function frameEnd() {\n    const start = frameMap.get(key);\n    frameMap.delete(key);\n    if (typeof start !== 'number' || isNaN(start)) {\n      throw new Error(`Cannot find start timer for key: ${key}`);\n    }\n    const cost = Date.now() - start;\n    callback(key, cost, type);\n  }\n\n  // 设置计时起始点\n  frameMap.set(key, Date.now());\n  if (type === 'frame') {\n    window.requestAnimationFrame(frameEnd);\n  } else if (type === 'microtask') {\n    Promise.resolve().then(frameEnd);\n  } else if (type === 'macrotask') {\n    window.setTimeout(frameEnd);\n  } else {\n    console.warn('Unexpected frame type: ', type);\n    frameMap.delete(key);\n  }\n}\n\n/**\n * 装饰函数，记录从函数执行开始至下一帧的耗时\n * @param key 计时 key\n * @param fn 装饰的函数\n * @param options\n */\nexport function latencyFrame<T extends Function>(key: string, fn: T, options?: LatencyFrameOptions) {\n  return function _latency(this: any, ...args: any[]) {\n    latencyCurrentFrame(key, options);\n    return fn.apply(this, args);\n  } as unknown as T;\n}\n\n/**\n * 装饰方法，记录从函数执行开始至下一帧的耗时\n * @param key 计时 key\n * @param options\n */\nexport function LatencyFrame(key: string, options?: LatencyFrameOptions): MethodDecorator {\n  return function deco<F>(\n    target: object,\n    propertyKey: string | symbol,\n    descriptor: TypedPropertyDescriptor<F>,\n  ): TypedPropertyDescriptor<F> {\n    if (!descriptor || (typeof descriptor.value !== 'function')) {\n      throw new TypeError(`Only methods can be decorated with @LatencyFrame. <${String(propertyKey)}> is not a method!`);\n    }\n    return {\n      ...descriptor,\n      value: latencyFrame(key, descriptor.value, options) as any,\n    };\n  };\n}\n\nexport type TotalCallback = (key: string, cost: number, total: number) => void;\n\nconst onTotalCallback: TotalCallback = (key, cost, total) => {\n  debug('Latency total %c%s: %c%d/time %c%dms', 'color: dodgerblue', key, 'color: tomato', total, 'color: orange', cost);\n};\n\nexport interface LatencyTotalOptions {\n  callback?: TotalCallback;\n}\n\n/**\n * 记录一个函数在一个 task 内总共执行的次数以及耗时\n * @param key 计时 key\n * @param fn 计时函数\n * @param options\n */\nexport function latencyTotal<T extends Function>(key: string, fn: T, options: LatencyTotalOptions = {}): T {\n  const { callback = onTotalCallback } = options;\n  let counting = false;\n  let total = 0;\n  let cost = 0;\n  return function _latencyTotal(this: any, ...args: any[]) {\n    const start = Date.now();\n    const res = fn.apply(this, args);\n    const onceCost = Date.now() - start;\n    total += 1;\n    cost += onceCost;\n    if (!counting) {\n      counting = true;\n      Promise.resolve().then(() => {\n        try {\n          callback(key, cost, total);\n        } finally {\n          counting = false;\n          total = 0;\n          cost = 0;\n        }\n      });\n    }\n    return res;\n  } as unknown as T;\n}\n\n/**\n * 记录一个函数在一个 task 内总共执行的次数以及耗时\n * @param key 计时 key\n * @param options\n */\nexport function LatencyTotal(key: string, options?: LatencyTotalOptions): MethodDecorator {\n  return function deco<F>(\n    target: object,\n    propertyKey: string | symbol,\n    descriptor: TypedPropertyDescriptor<F>,\n  ): TypedPropertyDescriptor<F> {\n    if (!descriptor || (typeof descriptor.value !== 'function')) {\n      throw new TypeError(`Only methods can be decorated with @LatencyTotal. <${String(propertyKey)}> is not a method!`);\n    }\n    return {\n      ...descriptor,\n      value: latencyTotal(key, descriptor.value, options) as any,\n    };\n  };\n}\n"],"file":"latency.js"}