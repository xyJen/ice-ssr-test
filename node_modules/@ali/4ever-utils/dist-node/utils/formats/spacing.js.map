{"version":3,"sources":["../../../../src/utils/formats/spacing.ts"],"names":["linesToPx","lines","linePitch","pitch","theme","spacing","defaultLinePitch","pxToLines","px","timesToPx","times","pxToTimes","ASL_LINE_HEIGHT","Object","keys","lineCfg","ACTUAL_MAP","map","h","parseFloat","sort","a","b","ASL_LINE_HEIGHT_LEN","length","PER_REG","findClosestLineHeight","target","height","DEFAULT","min","Infinity","i","newMin","Math","abs","fromHeadingType","type","headStyle","headDefaultStyle","before","after","line","fromHtml","value","fontSize","sz","unitsConverter","toPT","fsCfg","NaN","test","fromBlock","paragraph","inheritedData","nodeSpacing","data","inheritedSpacing","defaultThemeSpacing","beforeAutospacing","defaultBeforeAutospacing","beforeLines","toPX","afterAutospacing","defaultAfterAutospacing","afterLines","lineRule","max","toStyle","block","style","marginTop","marginBottom","lineHeight","getLineHeightFromSpacing","defaultLineHeight","klass","SpacingUtil"],"mappings":"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","sourcesContent":["import { Block, BlockJSON } from '@ali/4ever-cangjie';\nimport { headDefaultStyle } from '../../heading/heading';\nimport type { SpacingProperties } from '../modelData';\nimport { theme, fontSize as fsCfg, lineHeight as lineCfg } from '../../theme';\nimport { unitsConverter, ptToPx } from '../toUnits';\n\n/**\n * 将行单位转换为 px 单位\n * @param lines\n * @param linePitch 网格系统相关参数\n * @returns\n */\nfunction linesToPx(lines: number, linePitch?: number) {\n  // 默认 linePitch 为 15.6 pt\n  const pitch = linePitch || theme.spacing.defaultLinePitch;\n  // px = lines * pitch\n  return lines * pitch;\n}\n\nfunction pxToLines(px: number, linePitch?: number) {\n  const pitch = linePitch || theme.spacing.defaultLinePitch;\n  // px = lines * pitch\n  return px / pitch;\n}\n\n/**\n * 将倍数的行距转换为 px\n * 倍数在导入时会被：\n * 原始数据：480，代表24pt\n * 480 / 240 = 2，变为倍数（实际上应该除以 20 转换为 pt，都是为了兼容老数据）\n * 所以：\n * px = times * 12 * 4 / 3\n */\nfunction timesToPx(times: number) {\n  return times * 16;\n}\n\n/**\n * 将 px 单位的行距转换为倍数\n * @param times\n * @returns\n */\nfunction pxToTimes(times: number) {\n  return times / 16;\n}\n\n// 提前排序便于快速查找\nconst ASL_LINE_HEIGHT = Object.keys(lineCfg.ACTUAL_MAP)\n  .map((h) => parseFloat(h))\n  .sort((a, b) => a - b);\nconst ASL_LINE_HEIGHT_LEN = ASL_LINE_HEIGHT.length;\nconst PER_REG = /^\\d*\\.?\\d*%$/;\n\n/**\n * 从默认的行高列表中找出最接近的行高\n */\nfunction findClosestLineHeight(target: number) {\n  let height = lineCfg.DEFAULT;\n  let min = Infinity;\n  // fast than some\n  for (let i = 0; i < ASL_LINE_HEIGHT_LEN; i++) {\n    const newMin = Math.abs(target - ASL_LINE_HEIGHT[i]);\n    if (newMin > min) {\n      break;\n    }\n    height = ASL_LINE_HEIGHT[i];\n    min = newMin;\n  }\n\n  return height;\n}\n\nfunction fromHeadingType(type: string): SpacingProperties {\n  const headStyle = headDefaultStyle[type];\n  if (!headStyle) return {};\n  return {\n    // 转换为绝对值单位 px\n    before: ptToPx(headStyle['margin-top']),\n    after: ptToPx(headStyle['margin-bottom']),\n    line: headStyle['line-height'] / lineCfg.DEFAULT,\n  };\n}\n\n/**\n * 从html解析行高并强制转换为接近的行高（倍数）\n * 支持 2、200%、20px等\n * 策略：尽量靠近原格式视觉\n * @param value\n * @param fontSize\n */\nfunction fromHtml(\n  value: string,\n  fontSize?: string | number,\n) {\n  if (!value) return ASL_LINE_HEIGHT[0];\n  const sz = unitsConverter.toPT(fontSize) || fsCfg.DEFAULT;\n  let height = NaN;\n\n  if (PER_REG.test(value)) {\n    // 特别处理 %，兼容：@word @shimo @tengxun\n    height = parseFloat(value) / 100;\n  } else {\n    // other: 转换为固定值 除以 字号 除以 1.7\n    height = unitsConverter.toPT(value) / sz / lineCfg.DEFAULT;\n  }\n\n  if (!height) return ASL_LINE_HEIGHT[0];\n\n  return findClosestLineHeight(height);\n}\n\n/**\n * 从节点数据解析 spacing\n * before 和 after 会被转换为 px 单位（与存量 asl 一致）\n * line 则转换为：\n * px 单位（lineRule !== auto）\n * 倍数 单位（lineRule === auto）\n * @param paragraph 块级元素\n * @param inheritedData 继承值\n * @param linePitch docGrid.linePitch pt 单位\n * @returns SpacingProperties\n */\nfunction fromBlock(paragraph: Block | BlockJSON, inheritedData?: Record<string, any>, linePitch?: number): SpacingProperties {\n  const { type } = paragraph;\n  const nodeSpacing = paragraph.data?.spacing;\n  const inheritedSpacing = inheritedData?.spacing;\n\n  let spacing: SpacingProperties = {};\n  if (inheritedSpacing) {\n    // 有继承数据的时候忽略编辑器默认的 spacing\n    spacing = {\n      ...inheritedSpacing,\n      ...nodeSpacing,\n    };\n  } else {\n    const defaultThemeSpacing = fromHeadingType(type);\n    spacing = {\n      ...defaultThemeSpacing,\n      ...nodeSpacing,\n    };\n  }\n\n  if (spacing.beforeAutospacing) {\n    spacing.before = theme.spacing.defaultBeforeAutospacing;\n    // 删除无效字段避免影响提取公共属性\n    delete spacing.beforeLines;\n  } else if (spacing.beforeLines) {\n    spacing.before = linesToPx(spacing.beforeLines, linePitch);\n  } else if (typeof spacing.before === 'string') {\n    // 默认单位转换为 px（word导出数据含xxpx、xxpt）\n    spacing.before = unitsConverter.toPX(spacing.before);\n  }\n\n  if (spacing.afterAutospacing) {\n    spacing.after = theme.spacing.defaultAfterAutospacing;\n    delete spacing.afterLines;\n  } else if (spacing.afterLines) {\n    spacing.after = linesToPx(spacing.afterLines, linePitch);\n  } else if (typeof spacing.after === 'string') {\n    spacing.after = unitsConverter.toPX(spacing.after);\n  }\n\n  if ('line' in spacing) {\n    const { line, lineRule = 'auto' } = spacing;\n    // 存量数据中存在字符串类型的 line: 1.46667px（脏）,18px（正确）\n    // 这里转换为倍数，同时防止 line 过小\n    // word px 到 行高 公式：line = px / 16\n    if (typeof line === 'string') {\n      spacing.line = pxToTimes(unitsConverter.toPX(spacing.line)) || 1;\n    }\n    if (spacing.line && lineRule !== 'auto') {\n      // 固定值也需要做最小限制（24 * 0.6 = 14）\n      spacing.line = Math.max(14, timesToPx(spacing.line));\n    }\n    if (lineRule === 'auto') {\n      // 对极小值多倍做限制，避免粘连（1/1.7 = 0.6）\n      spacing.line = Math.max(0.6, spacing.line || 0);\n    }\n  }\n\n  return spacing;\n}\n\n/**\n * 将节点的 spacing 数据转换为 css 样式\n * 优先走 userSet to actualSet 隐射表，否则按照 * 1.7 计算行高\n */\nfunction toStyle(block: Block | BlockJSON, inheritedData?: Record<string, any>, linePitch?: number): React.CSSProperties {\n  const style: React.CSSProperties = {};\n\n  // PERF: 提前 return 提升性能\n  if (!block.data?.spacing && !inheritedData?.spacing && !headDefaultStyle[block.type]) {\n    return style;\n  }\n\n  const spacing = fromBlock(block, inheritedData, linePitch);\n  if (spacing.before) {\n    style.marginTop = spacing.before;\n  }\n\n  if (spacing.after) {\n    style.marginBottom = spacing.after;\n  }\n\n  if (spacing.line) {\n    const { lineRule = 'auto' } = spacing;\n    if (lineRule === 'auto') {\n      // 倍数\n      style.lineHeight = `${lineCfg.ACTUAL_MAP[spacing.line] || spacing.line * lineCfg.DEFAULT}`;\n    } else if (lineRule === 'exact') {\n      style.lineHeight = `${spacing.line}px`;\n    } else if (lineRule === 'atLeast') {\n      // 最小值降级\n      style.lineHeight = 'normal';\n    }\n  }\n\n  return style;\n}\n\nfunction getLineHeightFromSpacing(spacing?: SpacingProperties) {\n  const defaultLineHeight = `${lineCfg.DEFAULT}`;\n  if (!spacing?.line) return defaultLineHeight;\n  return `${toStyle({\n    klass: 'block',\n    type: 'paragraph',\n    data: {\n      spacing,\n    },\n  }).lineHeight || defaultLineHeight}`;\n}\n\nexport const SpacingUtil = {\n  fromBlock,\n  fromHtml,\n  fromHeadingType,\n  toStyle,\n  getLineHeightFromSpacing,\n  linesToPx,\n  pxToLines,\n  timesToPx,\n  pxToTimes,\n};\n"],"file":"spacing.js"}