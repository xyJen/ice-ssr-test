{"version":3,"sources":["../../../../src/utils/editor/removeMarkAtCurrentRange.ts"],"names":["Commands","Text","getRangesFromEditor","removeMarkAtCurrentPosition","controller","type","value","document","selection","isCollapsed","convertToTextPoints","focus","focusNode","getNode","key","curPosMarks","marks","getMarksAtPosition","offset","filter","m","newSelection","set","command","removeMarkAtRange","needRemovedMarks","getMarksAtRange","forEach","isCollapsedAtEmptyParagraph","query","isCollapsedAtEmptyHeading","isText","removeMarkByKey","removeMarkAtCurrentRange","selections"],"mappings":"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","sourcesContent":["import {\n  Controller,\n  Commands,\n  Text,\n  Mark,\n  Selection,\n} from '@ali/4ever-cangjie';\nimport { getRangesFromEditor } from './getRangesFromEditor';\n\n/**\n * 移除当前位置的临时样式\n * @param controller \n * @param type \n * @returns \n */\nfunction removeMarkAtCurrentPosition(controller: Controller, type: string) {\n  const { document, selection } = controller.value;\n  const { isCollapsed } = selection;\n  const { focus } = selection.convertToTextPoints(document);\n  const focusNode = document.getNode(focus.key);\n  if (!focusNode) return controller;\n  /**\n   * 优先级: selection.marks > marksAtPosition\n   * selection.marks = [] 代表临时的、强制的清空样式的状态\n   */\n  let curPosMarks: Mark[] | null = selection.marks;\n  if (isCollapsed && !curPosMarks) {\n    // collapsed 状态需要 getMarksAtPosition，例如在一段加粗和红色文本中单独取消加粗，此时是设置临时的 selection.marks，不落库\n    curPosMarks = document.getMarksAtPosition(focusNode.key, focus.offset);\n  }\n  if (!curPosMarks) return controller;\n  // 同类型的文本样式仅允许存在一个，这里直接 filter\n  // 特殊业务（例如评论）允许多个存在可以使用 setUtils.remove\n  curPosMarks = curPosMarks.filter((m) => m.type !== type);\n  const newSelection = selection.set('marks', curPosMarks);\n  controller.command('select', newSelection);\n  return controller;\n}\n\n/**\n * 在给定选区内删除指定类型的 mark\n * 策略同 removeMarkAtCurrentRange\n * @param controller\n * @param selection\n * @param type\n */\nexport function removeMarkAtRange(controller: Controller, selection: Selection, type: string) {\n  const { document } = controller.value;\n  const { isCollapsed } = selection;\n\n  if (!isCollapsed) {\n    // 1\n    const needRemovedMarks = document.getMarksAtRange(selection).filter((m) => m.type === type);\n    needRemovedMarks.forEach((m) => {\n      controller.command(Commands.removeMarkAtRange, selection, m);\n    });\n    // 即使是 isExpanded 也需要 removeMarkAtCurrentPosition，例如标题变为普通段落\n    return removeMarkAtCurrentPosition(controller, type);\n  }\n\n  const { focus } = selection.convertToTextPoints(document);\n  const focusNode = document.getNode(focus.key);\n  if (!focusNode) return controller;\n\n  const isCollapsedAtEmptyParagraph = controller.query('isCollapsedAtEmptyParagraph', selection) as boolean;\n  const isCollapsedAtEmptyHeading = controller.query('isCollapsedAtEmptyHeading', selection) as boolean;\n\n  if (isCollapsedAtEmptyParagraph || isCollapsedAtEmptyHeading) {\n    // 2\n    if (focusNode && Text.isText(focusNode)) {\n      const needRemovedMarks = document.getMarksAtPosition(focusNode.key, 0).filter((m) => m.type === type);\n      needRemovedMarks.forEach((m) => {\n        controller.command(Commands.removeMarkByKey, focusNode.key, 0, 0, m);\n      });\n    }\n  }\n\n  return removeMarkAtCurrentPosition(controller, type);\n}\n\n/**\n * 在当前选区内删除指定类型的 mark\n * 1. 未闭合时策略：清除选区内样式\n * 2. 闭合时策略：\n *  2.1 如果是 isCollapsedAtEmptyParagraph/Heading 时需要清除选区临时样式，也需要清除 text 节点的mark（操作可持久化），对应的场景有二：\n *    a. 表格选区中的空 cell；\n *    b. focus 在空段落（paragraph 和 heading）\n *  2.2 边缘闭合选区：仅设置选区的临时样式，对应的场景：focus 在分割线、卡片、表格等左右\n *  2.3 focus 在段落中以及其它情形：仅设置选区的临时样式\n * @param controller\n * @param type 类型\n */\nexport function removeMarkAtCurrentRange(controller: Controller, type: string) {\n  const selections = getRangesFromEditor(controller);\n  selections.forEach((selection) => removeMarkAtRange(controller, selection, type));\n  return controller;\n}\n"],"file":"removeMarkAtCurrentRange.js"}