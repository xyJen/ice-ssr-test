{"version":3,"sources":["../../../../src/utils/editor/addMarkAtCurrentRange.ts"],"names":["Commands","Text","getRangesFromEditor","addMarkAtRange","controller","selection","mark","document","value","isCollapsed","sameTypeMarks","getMarksAtRange","filter","m","type","forEach","command","removeMarkAtRange","convertToTextPoints","focus","focusNode","getNode","key","isCollapsedAtEmptyParagraph","query","isCollapsedAtEmptyHeading","isText","getMarksAtPosition","removeMarkByKey","addMarkByKey","valueSelection","curPosMarks","marks","offset","push","newSelection","set","addMarkAtCurrentRange","selections"],"mappings":"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","sourcesContent":["import {\n  Controller,\n  Commands,\n  Mark,\n  Text,\n  Selection,\n} from '@ali/4ever-cangjie';\nimport { getRangesFromEditor } from './getRangesFromEditor';\n\n/**\n * 在给定选区内增加指定 mark\n * 策略同 addMarkAtCurrentRange\n * @param controller\n * @param selection\n * @param mark\n */\nexport function addMarkAtRange(controller: Controller, selection: Selection, mark: Mark) {\n  const { document } = controller.value;\n  const { isCollapsed } = selection;\n  if (!isCollapsed) {\n    /**\n       * 1\n       * 先移除选区中同类型的样式\n       * TODO: 原则上我们只允许 marks 中同类型的 mark 只有一个\n       * 因此可以走更直接的 filter + push 操作\n       * 这里的 removeMarkAtRange 和 addMarkAtRange 要遍历两次 且 会使用数据层的 equal 比较，性能更低\n       */\n    const sameTypeMarks = document.getMarksAtRange(selection).filter((m) => m.type === mark.type);\n    sameTypeMarks.forEach((m) => {\n      controller.command(Commands.removeMarkAtRange, selection, m);\n    });\n\n    // 增加指定 mark\n    controller.command(Commands.addMarkAtRange, selection, mark);\n    return controller;\n  }\n\n  const { focus } = selection.convertToTextPoints(document);\n  const focusNode = document.getNode(focus.key);\n  if (!focusNode) return controller;\n\n  const isCollapsedAtEmptyParagraph = controller.query('isCollapsedAtEmptyParagraph', selection) as boolean;\n  const isCollapsedAtEmptyHeading = controller.query('isCollapsedAtEmptyHeading', selection) as boolean;\n\n  if (isCollapsedAtEmptyParagraph || isCollapsedAtEmptyHeading) {\n    // 2.1\n    if (Text.isText(focusNode)) {\n      // 依然需要先移除同类型样式\n      const sameTypeMarks = document.getMarksAtPosition(focusNode.key, 0).filter((m) => m.type === mark.type);\n      sameTypeMarks.forEach((m) => {\n        controller.command(Commands.removeMarkByKey, focusNode.key, 0, 0, m);\n      });\n      controller.command(Commands.addMarkByKey, focusNode.key, 0, 0, mark);\n    }\n  }\n\n  // 2 都需要设置选区临时样式：需要将当前位置和要设置的 mark 做合并\n  // 需要取 value.selection 否则可能会改变原有选区范围\n  const valueSelection = controller.value.selection;\n  let curPosMarks: Mark[] = valueSelection.marks || document.getMarksAtPosition(focusNode.key, focus.offset);\n  // 同类型的文本样式仅允许存在一个，这里直接 filter\n  // 特殊业务（例如评论）允许多个存在可以使用 setUtils.add\n  curPosMarks = curPosMarks.filter((m) => m.type !== mark.type);\n  curPosMarks.push(mark);\n  const newSelection = valueSelection.set('marks', curPosMarks);\n  controller.command('select', newSelection);\n  return controller;\n}\n\n\n/**\n * 在当前选区内增加指定 mark\n * 1. 未闭合时策略：在选区内增加样式\n * 2. 闭合时策略：\n *  2.1 如果是 isCollapsedAtEmptyParagraph/Heading 时需要给 text 节点加mark（操作可持久化），对应的场景有二：\n *    a. 表格选区中的空 cell；\n *    b. focus 在空段落（paragraph 和 heading）\n *  2.2 边缘闭合选区：仅设置选区的临时样式，对应的场景：focus 在分割线、卡片、表格等左右\n *  2.3 focus 在段落中以及其它情形：仅设置选区的临时样式\n * @param controller\n * @param mark 要求必须是 Mark，尽量使用 mo 中的 create 函数创建以确保兼容性（直接使用 Mark.create 不安全）\n */\nexport default function addMarkAtCurrentRange(controller: Controller, mark: Mark) {\n  const selections = getRangesFromEditor(controller);\n  selections.forEach((selection) => addMarkAtRange(controller, selection, mark));\n  return controller;\n}\n"],"file":"addMarkAtCurrentRange.js"}