{"version":3,"sources":["../../../../src/utils/handlers/createOnCangjieSelect.ts"],"names":["SUBJECT_NORMALIZE","createOnCangjieSelect","options","inject","onCangjieSelect","event","controller","next","selection","trigger","detail","document","injections","value","focus","block","getFurthestAncestor","key","Block","isBlock","subject","query","getSubjectStartBlock","Injection","injectIntoNode","userData","get","run","node","fold","start","getStart","end","getEnd","startBlock","getFurthsestBlock","endBlock","sel","startSubjectBlock","endSubjectBlock","isAtStartOfNode","moveStartToStartOfNode","subjectEndBlock","getSubjectEndBlock","isAtEndOfNode","moveEndToEndOfNode"],"mappings":"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","sourcesContent":["import { Block, CangjieSelectEvent, Injection, Plugin } from '@ali/4ever-cangjie';\nimport { toggleFold } from '@ali/4ever-utils';\nimport { getSubjectEndBlock, getSubjectStartBlock } from '../queries';\nimport { isSubjectHeading, SubjectHeading } from '../utils';\n\nconst SUBJECT_NORMALIZE = 'subjectNormalize';\n\nexport interface OnCangjieSelectOptions {\n  /**\n   * 是否注入 Injection\n   * @default false\n   */\n  inject?: boolean;\n}\n\nfunction createOnCangjieSelect(options: OnCangjieSelectOptions = {}): Plugin['onCangjieSelect'] {\n  const { inject = false } = options;\n\n  return function onCangjieSelect(event, controller, next) {\n    const { selection, trigger } = event.detail;\n    const { document, injections } = controller.value;\n    const { focus } = selection;\n    const block = document.getFurthestAncestor(focus.key);\n\n    /**\n     * Effects 1: 若光标 focus 进入到折叠议题区域内，需要自动展开议题\n     * @description 此处需求是由于在内容折叠情况下，若用户光标选区进入，则无法看到鼠标聚焦区域，所以需要自动展开\n     */\n\n    // TODO: 这里的 query 会在每次 select 时消耗一次 O(N) 的查询性能，后续考虑在 DOM 上做一次 O(h) 的查询来优化\n    if (trigger !== SUBJECT_NORMALIZE && Block.isBlock(block) && !isSubjectHeading(block)) {\n      let subject = controller.query(getSubjectStartBlock, block);\n\n      // 注入 Injection 数据\n      if (inject && subject) {\n        subject = Injection.injectIntoNode(injections, subject) as SubjectHeading;\n      }\n\n      // 若议题节点折叠则展开\n      if (subject && controller.userData.get(subject, 'fold')) {\n        controller.run('onAction', toggleFold({\n          node: subject,\n          fold: false,\n        }));\n      }\n    }\n\n    /**\n     * Effects 2: 若选区跨越议题范围，则需要扩展选区范围至整个议题\n     * @description 此处需求源于产品设计，议题标题不能被随意删除，由于标题的特例处理比较困难，因此我们通过扩展选区的方法使得用户\n     * 会选择整个议题，这样使得用户在操作时能有明显的预期\n     */\n\n    const start = selection.getStart(document);\n    const end = selection.getEnd(document);\n    const startBlock = document.getFurthsestBlock(start.key);\n    const endBlock = document.getFurthsestBlock(end.key);\n\n    // 若光标的起始和结束不在同一个 Block 上\n    if (trigger !== SUBJECT_NORMALIZE && startBlock && endBlock && startBlock !== endBlock) {\n      let sel = selection;\n      const startSubjectBlock = controller.query(getSubjectStartBlock, startBlock);\n      const endSubjectBlock = controller.query(getSubjectStartBlock, endBlock);\n\n      // 若光标的起始和结束不在同一个议题组内，则需要扩展选区\n      if (startSubjectBlock !== endSubjectBlock) {\n        // start 移动至起始议题的开头\n        if (startSubjectBlock && !start.isAtStartOfNode(startSubjectBlock)) {\n          sel = sel.moveStartToStartOfNode(startSubjectBlock, controller);\n        }\n\n        // end 移动至结束议题的末尾\n        if (endSubjectBlock) {\n          const subjectEndBlock = controller.query(getSubjectEndBlock, endSubjectBlock);\n          if (subjectEndBlock && !end.isAtEndOfNode(subjectEndBlock)) {\n            sel = sel.moveEndToEndOfNode(subjectEndBlock, controller);\n          }\n        }\n      }\n\n      // 若光标发生了变化，则更新\n      if (sel !== selection) {\n        return controller.run('onCangjieSelect', CangjieSelectEvent({\n          selection: sel,\n          trigger: SUBJECT_NORMALIZE,\n        }));\n      }\n    }\n\n    return next();\n  };\n}\n\nexport default createOnCangjieSelect;\n"],"file":"createOnCangjieSelect.js"}