{"version":3,"sources":["../../../../src/mo/serializer/htmlToJsonML.ts"],"names":["getLastChild","isJsonMLText","createEmptyParagraph","isTextNode","node","length","name","onOpenTag","state","parent","peek","prevSibling","lastTextChild","phantom","isPhantom","push","onCloseTag","br","pop","append"],"mappings":"AAAA,SAASA,YAAT,EAAuBC,YAAvB,QAA4D,kBAA5D;AACA,SAA2BC,oBAA3B,QAAwD,oBAAxD;;AAEA,IAAMC,UAAU,GAAG,SAAbA,UAAa,CAACC,IAAD,EAAkC;AAAA;;AACnD,MAAIA,IAAI,IAAIH,YAAY,CAACG,IAAD,CAApB,aAA8BA,IAAI,CAACA,IAAI,CAACC,MAAL,GAAc,CAAf,CAAlC,aAA8B,MAAwB,CAAxB,CAAlC,EAA8D;AAC5D,WAAO,IAAP;AACD;;AACD,SAAO,KAAP;AACD,CALD;;AAOA,eAAe;AACbC,EAAAA,IAAI,EAAE,IADO;AAGbC,EAAAA,SAAS,EAAE,mBAACC,KAAD,EAAeF,IAAf,EAAyC;AAClD,QAAIA,IAAI,KAAK,IAAb,EAAmB,OAAO,KAAP,CAD+B,CAGlD;;AACA,QAAMG,MAAM,GAAGD,KAAK,CAACE,IAAN,EAAf;AACA,QAAMC,WAAW,GAAGX,YAAY,CAACS,MAAD,CAAhC;;AACA,QAAIN,UAAU,CAACQ,WAAD,CAAd,EAA6B;AAC3B;AACA,UAAMC,aAAa,GAAGD,WAAH,oBAAGA,WAAW,CAAGA,WAAW,CAACN,MAAZ,GAAqB,CAAxB,CAAjC,CAF2B,CAG3B;;AACAO,MAAAA,aAAa,CAAC,CAAD,CAAb,IAAoB,IAApB;AACA,aAAO,IAAP;AACD;;AACD,QAAMC,OAAe,GAAGX,oBAAoB,EAA5C;AACCW,IAAAA,OAAD,CAAqBC,SAArB,GAAiC,IAAjC;AACAN,IAAAA,KAAK,CAACO,IAAN,CAAWF,OAAX;AACA,WAAO,IAAP;AACD,GApBY;AAsBbG,EAAAA,UAAU,EAAE,oBAACR,KAAD,EAAeF,IAAf,EAAyC;AACnD,QAAIA,IAAI,KAAK,IAAb,EAAmB,OAAO,KAAP;AACnB,QAAMG,MAAM,GAAGD,KAAK,CAACE,IAAN,EAAf;AACA,QAAMC,WAAW,GAAGX,YAAY,CAACS,MAAD,CAAhC;;AACA,QAAIN,UAAU,CAACQ,WAAD,CAAd,EAA6B;AAC3B,aAAO,IAAP;AACD;;AACD,QAAMM,EAAE,GAAGT,KAAK,CAACU,GAAN,EAAX;AACAV,IAAAA,KAAK,CAACW,MAAN,CAAaF,EAAb;AACA,WAAO,IAAP;AACD;AAhCY,CAAf","sourcesContent":["import { getLastChild, isJsonMLText, JsonML, Phantom } from '@ali/4ever-utils';\nimport { MoState as State, createEmptyParagraph, } from '@ali/4ever-cangjie';\n\nconst isTextNode = (node: JsonML | null): boolean => {\n  if (node && isJsonMLText(node) && node[node.length - 1]?.[2]) {\n    return true;\n  }\n  return false;\n};\n\nexport default {\n  name: 'br',\n\n  onOpenTag: (state: State, name: string): boolean => {\n    if (name !== 'br') return false;\n\n    // ref: src/plugins/text/htmlToJsonML.js\n    const parent = state.peek();\n    const prevSibling = getLastChild(parent);\n    if (isTextNode(prevSibling)) {\n      // 前一个兄弟节点是文本类型，直接在前一个节点内容尾插入 \\n, 防止产生 unnormalized 数据结构\n      const lastTextChild = prevSibling?.[prevSibling.length - 1];\n      // @ts-ignore\n      lastTextChild[2] += '\\n';\n      return true;\n    }\n    const phantom: JsonML = createEmptyParagraph();\n    (phantom as Phantom).isPhantom = true;\n    state.push(phantom);\n    return true;\n  },\n\n  onCloseTag: (state: State, name: string): boolean => {\n    if (name !== 'br') return false;\n    const parent = state.peek();\n    const prevSibling = getLastChild(parent);\n    if (isTextNode(prevSibling)) {\n      return true;\n    }\n    const br = state.pop();\n    state.append(br);\n    return true;\n  },\n};\n"],"file":"htmlToJsonML.js"}