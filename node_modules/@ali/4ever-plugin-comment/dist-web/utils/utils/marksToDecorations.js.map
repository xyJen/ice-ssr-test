{"version":3,"sources":["../../../../src/utils/utils/marksToDecorations.ts"],"names":["TextPoint","Decoration","Path","DataMark","ViewMark","getActiveId","getComments","marksToDecorations","controller","comments","value","decorations","document","activeContentId","otherDecorations","filter","d","isViewMark","mark","texts","getTexts","newDecs","data","isNew","newcid","contentId","find","c","readOnlyDecs","isReadonly","concat","map","isActive","set","create","forEach","text","offset","leaves","leave","marks","m","isDataMark","item","oldDec","dec","prevBlock","getClosestBlock","end","key","prevSucceedingBlock","getNextBlock","closestBlock","start","length","count","summary","newDec","push","sort","a","b","pa","getPath","pb","isBefore","isAfter"],"mappings":"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","sourcesContent":["import { Controller, TextPoint, Decoration, Path } from '@ali/4ever-cangjie';\nimport { DataMark, ViewMark } from '../models/marks';\nimport { getActiveId } from '../queries';\nimport getComments from '../queries/getComments';\n\n/**\n * DataMark -> ViewMark\n */\nexport function marksToDecorations(controller: Controller) {\n  const comments = getComments(controller);\n  const { decorations, document } = controller.value;\n  const activeContentId = getActiveId(controller);\n\n  // 先过滤掉所有的 ViewMark\n  const otherDecorations = decorations.filter(\n    (d) => !ViewMark.isViewMark(d.mark),\n  );\n  const texts = document.getTexts();\n  let newDecs = decorations.filter((d) => {\n    if (ViewMark.isViewMark(d.mark) && d.mark.data.isNew) {\n      const newcid = d.mark.data.contentId;\n      return !comments.find((c) => c.contentId === newcid);\n    }\n    return false;\n  });\n  const readOnlyDecs = decorations.filter(\n    (d) => ViewMark.isViewMark(d.mark) && d.mark.data.isReadonly,\n  );\n  newDecs = newDecs.concat(readOnlyDecs);\n  newDecs = newDecs.map((d) => {\n    const mark = d.mark as ViewMark;\n    const isActive = activeContentId === mark.data.contentId;\n    return d.set(\n      'mark',\n      ViewMark.create({\n        ...mark.data,\n        isActive,\n      }),\n    );\n  });\n\n  // 遍历每一个 mark，然后构建新的 View Decoration\n  texts.forEach((text) => {\n    let offset = 0;\n    text.leaves.forEach((leave) => {\n      leave.marks.forEach((m) => {\n        if (DataMark.isDataMark(m)) {\n          const { contentId } = m.data;\n          const item = comments.find((c) => c.contentId === contentId);\n          if (!item) {\n            return;\n          }\n          const oldDec = newDecs.find(\n            (dec) => dec.mark.data.contentId === contentId,\n          );\n          // 如果这个 text 和 oldDec 的跨越太多（超过一个 block），就忽略掉\n          if (oldDec) {\n            const prevBlock = document.getClosestBlock(oldDec.end.key);\n            const prevSucceedingBlock = document.getNextBlock(oldDec.end.key);\n            const closestBlock = document.getClosestBlock(text.key);\n            if (closestBlock !== prevBlock && closestBlock !== prevSucceedingBlock) {\n              return;\n            }\n          }\n          const start =\n            oldDec?.start ||\n            TextPoint.create({\n              key: text.key,\n              offset,\n            });\n          const end = TextPoint.create({\n            key: text.key,\n            offset: offset + leave.text.length,\n          });\n          const { count, summary } = item;\n          const newDec = Decoration.create({\n            start,\n            end,\n            mark:\n              oldDec?.mark ||\n              ViewMark.create({\n                contentId,\n                count,\n                summary,\n                isActive: contentId === activeContentId,\n              }),\n          });\n          if (oldDec) {\n            newDecs = newDecs.map((d) => {\n              return d !== oldDec ? d : newDec;\n            });\n          } else {\n            newDecs.push(newDec);\n          }\n        }\n      });\n      offset += leave.text.length;\n    });\n  });\n  newDecs = newDecs.sort((a, b) => {\n    const pa = document.getPath(a.start.key);\n    const pb = document.getPath(b.start.key);\n    if (!pa || !pb) {\n      return 0;\n    }\n    if (Path.isBefore(pa, pb)) {\n      return -1;\n    }\n    if (Path.isAfter(pa, pb)) {\n      return 1;\n    }\n    return a.start.offset < b.start.offset ? -1 : 1;\n  });\n  return [...otherDecorations, ...newDecs];\n}\n"],"file":"marksToDecorations.js"}