{"version":3,"sources":["../../../../src/utils/utils/findCommentPostion.ts"],"names":["EdgePoint","Path","domUtils","getRowTopFromPoint","validateCaches","ViewMark","canComment","comparePoint","lp","rp","document","edgeToOffset","p","edge","BEFORE","Number","MAX_SAFE_INTEGER","key","lOffset","isEdgePoint","offset","rOffset","lPath","getPath","rPath","compare","findCommentPostion","controller","decorations","selection","container","window","isFromPopup","value","docKey","docNode","findDOMNodeSafely","getBoundingClientRect","docTop","top","docWidth","width","docHeight","height","allRows","result","skipSelection","isCollapsed","allDecs","convertToTextPoints","anchor","some","d","isViewMark","mark","start","end","commonParams","item","paramPoint","focus","rowKey","clientTop","newRowItem","push","forEach","decoration","existingRow","find","r"],"mappings":"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","sourcesContent":["/* eslint-disable no-console */\nimport {\n  EdgePoint,\n  TextPoint,\n  Controller,\n  Path,\n  Document,\n  Selection,\n  Decoration,\n  domUtils,\n} from '@ali/4ever-cangjie';\nimport { getRowTopFromPoint } from '../commentPosition/getRowTopFromPoint';\nimport { validateCaches } from '../commentPosition/positionCache';\nimport { ViewMark } from '../models/marks';\nimport { canComment } from '../queries';\nimport { PostionRowItem } from '../types';\n\n/**\n * 对比两个 Point 在 document 的出现位置\n */\nfunction comparePoint(\n  lp: TextPoint | EdgePoint,\n  rp: TextPoint | EdgePoint,\n  document: Document,\n) {\n  const edgeToOffset = (p: EdgePoint) =>\n    p.edge === EdgePoint.BEFORE ? -1 : Number.MAX_SAFE_INTEGER;\n  if (lp.key === rp.key) {\n    const lOffset = lp.isEdgePoint() ? edgeToOffset(lp) : lp.offset;\n    const rOffset = rp.isEdgePoint() ? edgeToOffset(rp) : rp.offset;\n    return lOffset - rOffset;\n  }\n  const lPath = document.getPath(lp.key);\n  const rPath = document.getPath(rp.key);\n  if (!lPath || !rPath) {\n    return 0;\n  }\n  return Path.compare(lPath, rPath) || 0;\n}\n\ntype FindPositionParams = {\n  controller: Controller;\n  decorations: Decoration[];\n  selection?: Selection;\n  container?: Window | HTMLElement;\n  isFromPopup?: boolean;\n};\n\n/**\n * 获取评论框的位置。返回相对于当前 block 的位置，和屏幕绝对位置\n */\nexport function findCommentPostion({\n  controller,\n  decorations,\n  selection,\n  container = window,\n  isFromPopup,\n}: FindPositionParams) {\n  const { document } = controller.value;\n  const { key: docKey } = document;\n  const docNode = domUtils.findDOMNodeSafely(docKey, container);\n  if (!docNode) {\n    return [];\n  }\n  const {\n    top: docTop,\n    width: docWidth,\n    height: docHeight,\n  } = docNode.getBoundingClientRect();\n  const allRows = validateCaches({\n    controller,\n    docWidth,\n    container,\n    docTop,\n    docHeight,\n  });\n\n  // 初始化分行对象\n  const result: PostionRowItem[] = [];\n\n  // 如果当前已经有评论了，就 skip 掉（处理 block void 的 collapse 场景）\n  let skipSelection = false;\n  if (selection?.isCollapsed) {\n    const { decorations: allDecs } = controller.value;\n    const { anchor } = selection.convertToTextPoints(document);\n    skipSelection = allDecs.some((d) => {\n      return (\n        ViewMark.isViewMark(d.mark) &&\n        comparePoint(anchor, d.start, document) >= 0 &&\n        comparePoint(anchor, d.end, document) <= 0\n      );\n    });\n  }\n  const commonParams = { allRows, controller, container, isFromPopup, docTop };\n  if (!skipSelection && selection && canComment(controller, selection)) {\n    const item = getRowTopFromPoint({\n      ...commonParams,\n      paramPoint: selection?.focus,\n    });\n    if (item) {\n      const [rowKey, top] = item;\n      const clientTop = top + docTop;\n      const newRowItem = { rowKey, top, clientTop, selection, decorations: [] };\n      result.push(newRowItem);\n    }\n  }\n\n  // 处理 decorations\n  decorations.forEach((decoration) => {\n    const item = getRowTopFromPoint({\n      ...commonParams,\n      paramPoint: decoration.start,\n    });\n    if (!item) {\n      return;\n    }\n    const [rowKey, top] = item;\n    const existingRow = result.find((r) => r.rowKey === rowKey);\n    if (!existingRow) {\n      const clientTop = top + docTop;\n      const newRowItem = { rowKey, top, clientTop, decorations: [decoration] };\n      result.push(newRowItem);\n    } else {\n      existingRow.top = top;\n      existingRow.decorations.push(decoration);\n    }\n  });\n  return result;\n}\n"],"file":"findCommentPostion.js"}