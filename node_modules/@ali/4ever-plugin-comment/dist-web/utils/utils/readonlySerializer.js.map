{"version":3,"sources":["../../../../src/utils/utils/readonlySerializer.ts"],"names":["Decoration","Selection","TextPoint","ViewMark","hashCode","serialize","start","end","document","startPath","getPath","key","endPath","undefined","selection","create","anchor","focus","getFragmentAtRange","summary","text","hashStr","startPathStr","join","endPathStr","position","offset","length","deserialize","comment","contentId","count","split","pathStartStr","offsetStartStr","pathEndStr","offsetEndStr","lengthStr","pathStart","map","p","parseInt","pathEnd","offsetStart","offsetEnd","startNode","getNodeByPath","endNode","newHash","mark","isReadonly","decoration"],"mappings":"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","sourcesContent":["import { Decoration, Selection, TextPoint, Document } from '@ali/4ever-cangjie';\nimport { ViewMark } from '../models/marks';\nimport { CommentItem } from '../types';\nimport hashCode from './hashCode';\n\nexport function serialize(\n  start: TextPoint,\n  end: TextPoint,\n  document: Document,\n) {\n  const startPath = document.getPath(start.key);\n  const endPath = document.getPath(end.key);\n  if (!startPath || !endPath) {\n    return undefined;\n  }\n  const selection = Selection.create({ anchor: start, focus: end });\n  const { text: summary } = document.getFragmentAtRange(selection);\n  const hashStr = hashCode(summary);\n  const startPathStr = startPath.join(',');\n  const endPathStr = endPath.join(',');\n  const position = `${startPathStr}-${start.offset}-${endPathStr}-${end.offset}-${summary.length}-${hashStr}`;\n  return {\n    position,\n    summary,\n  };\n}\n\nexport function deserialize(comment: CommentItem, document: Document) {\n  const { contentId, position, count } = comment;\n  const [\n    pathStartStr,\n    offsetStartStr,\n    pathEndStr,\n    offsetEndStr,\n    lengthStr,\n    hashStr,\n  ] = position.split('-');\n  if (\n    !pathStartStr ||\n    !offsetStartStr ||\n    !pathEndStr ||\n    !offsetEndStr ||\n    !lengthStr ||\n    !hashStr\n  ) {\n    return undefined;\n  }\n  const pathStart = pathStartStr.split(',').map((p) => parseInt(p, 10));\n  const pathEnd = pathEndStr.split(',').map((p) => parseInt(p, 10));\n  const offsetStart = parseInt(offsetStartStr, 10);\n  const offsetEnd = parseInt(offsetEndStr, 10);\n  const length = parseInt(lengthStr, 10);\n  const startNode = document.getNodeByPath(pathStart);\n  const endNode = document.getNodeByPath(pathEnd);\n  if (!startNode || !endNode) {\n    return undefined;\n  }\n  const anchor = TextPoint.create({\n    key: startNode.key,\n    offset: offsetStart,\n  });\n  const focus = TextPoint.create({\n    key: endNode.key,\n    offset: offsetEnd,\n  });\n  const selection = Selection.create({ anchor, focus });\n  const { text } = document.getFragmentAtRange(selection);\n  const newHash = hashCode(text);\n  if (newHash !== hashStr || length !== text.length) {\n    return undefined;\n  }\n  const mark = ViewMark.create({\n    contentId,\n    count,\n    summary: text,\n    isReadonly: true,\n  });\n  const decoration = Decoration.create({\n    start: anchor,\n    end: focus,\n    mark,\n  });\n  return decoration;\n}\n"],"file":"readonlySerializer.js"}