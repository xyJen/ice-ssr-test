{"version":3,"sources":["../../../../src/utils/actions/showComment.ts"],"names":["domUtils","environment","createPerfLazyRenderPlugin","getActiveId","setActiveId","SCROLL_HEIGHT_PERCENT","findDOMNodeByVoidKey","ViewMark","IS_MOBILE","IS_IPAD","TOP_SPACE","BOTTOM_SPACE","findDOMNode","getScrollableContainerInfo","findScrollableContainer","scrollToSelectionTop","options","contentId","key","content","controller","scroller","heightPercent","bottomAlign","topExtraOffset","scrollToNodeByKey","domNode","querySelector","showPrunedElements","targetRect","getBoundingClientRect","height","closest","isWindow","scrollerTop","yOffset","viewportHeight","Math","max","window","innerHeight","alignY","bottom","top","targetOffsetTop","y","inView","topSpace","scrollTo","scrollX","scrollTop","updateComment","configs","oldId","run","skipAutoFocus","skipScroll","alwaysScroll","value","document","decorations","scrollTopExtraOffset","decoration","find","d","isViewMark","mark","data","start","scrollableContainer","scrollByBottomAlign","cachedMap","config","doUpdate","clearTimeout","timer","setTimeout"],"mappings":"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","sourcesContent":["import {\n  Controller,\n  domUtils,\n  environment,\n  constants,\n  createPerfLazyRenderPlugin,\n} from '@ali/4ever-cangjie';\nimport { getActiveId } from '../queries';\nimport { CommentPluginConfigs, ShowCommentOptions } from '../types';\nimport { setActiveId } from '../actions';\nimport { SCROLL_HEIGHT_PERCENT } from '../constants';\nimport { findDOMNodeByVoidKey } from '../utils/findDOMNodeByVoidKey';\nimport { ViewMark } from '../models';\n\nconst { IS_MOBILE, IS_IPAD } = environment;\n\nconst TOP_SPACE = IS_MOBILE && !IS_IPAD ? 20 : 100;\nconst BOTTOM_SPACE = 100;\n\nconst {\n  findDOMNode,\n  getScrollableContainerInfo,\n  findScrollableContainer,\n} = domUtils;\n\ntype ScrollOptions = {\n  contentId: string;\n  controller: Controller;\n  key?: string;\n  content: HTMLElement;\n  scroller: HTMLElement;\n  heightPercent: number;\n  topExtraOffset: number;\n  bottomAlign?: boolean;\n};\n\nasync function scrollToSelectionTop(options: ScrollOptions) {\n  const { contentId, key, content, controller, scroller, heightPercent, bottomAlign, topExtraOffset } = options;\n  if (key) {\n    await domUtils.scrollToNodeByKey(key, controller, true);\n  }\n  const domNode =\n    findDOMNodeByVoidKey(contentId, content) ||\n    content.querySelector(`[data-comment=\"${contentId}\"]`);\n  if (!domNode) {\n    return;\n  }\n  createPerfLazyRenderPlugin.showPrunedElements(domNode);\n  let targetRect: DOMRect | undefined = domNode.getBoundingClientRect();\n  if (targetRect && targetRect.height < 1) {\n    targetRect = domNode.closest('[data-foldable]')?.getBoundingClientRect();\n  }\n  if (!targetRect) {\n    return;\n  }\n\n  const { isWindow, scrollerTop, yOffset } = getScrollableContainerInfo(\n    scroller,\n  );\n\n  const viewportHeight = IS_MOBILE && !IS_IPAD\n    ? BOTTOM_SPACE\n    : Math.max(window.innerHeight * heightPercent, BOTTOM_SPACE);\n\n  const alignY = bottomAlign ? targetRect.bottom : targetRect.top;\n  // isInview: yOffset < targetOffsetTop < yOffset + viewportHeight\n  // move: targetOffsetTop <= finalY <= targetOffsetTop + viewportHeight\n  const targetOffsetTop = alignY + yOffset - scrollerTop;\n\n  let y = yOffset;\n  let inView = true;\n  const topSpace = TOP_SPACE + topExtraOffset;\n\n  if (targetOffsetTop < yOffset + topSpace) {\n    // selection above viewport\n    y = targetOffsetTop - topSpace;\n    inView = false;\n  } else if (targetOffsetTop > yOffset + viewportHeight) {\n    // selection below viewport\n    y = targetOffsetTop - viewportHeight;\n    inView = false;\n  }\n  if (inView) {\n    return;\n  }\n\n  if (isWindow) {\n    window.scrollTo(window.scrollX, y);\n  } else {\n    // eslint-disable-next-line no-param-reassign\n    scroller.scrollTop = y;\n  }\n}\n\nasync function updateComment(\n  controller: Controller,\n  contentId?: string,\n  options?: ShowCommentOptions,\n  configs?: CommentPluginConfigs,\n) {\n  const oldId = getActiveId(controller);\n  if (oldId !== contentId) {\n    controller.run('onAction', setActiveId(contentId, !options?.skipAutoFocus));\n  }\n  const skipScroll = oldId === contentId && !options?.alwaysScroll;\n  if (options?.skipScroll || !contentId || skipScroll) {\n    return;\n  }\n  try {\n    const { document, decorations } = controller.value;\n    // eslint-disable-next-line react/no-find-dom-node\n    const content = findDOMNode(document.key);\n    if (!content) {\n      return;\n    }\n    const { heightPercent = SCROLL_HEIGHT_PERCENT } = options || {};\n    const topExtraOffset = configs?.scrollTopExtraOffset || 0;\n    const decoration = decorations.find(\n      (d) =>\n        ViewMark.isViewMark(d.mark) &&\n        d.mark.data.contentId === contentId,\n    );\n    const key = decoration?.start?.key;\n    scrollToSelectionTop({\n      contentId,\n      key,\n      controller,\n      content: content as HTMLElement,\n      scroller: controller.scrollableContainer as HTMLElement,\n      heightPercent,\n      topExtraOffset,\n      bottomAlign:\n        configs?.scrollByBottomAlign && configs.scrollByBottomAlign(),\n    });\n  } catch (error) {\n    // ignore\n  }\n}\n\nconst cachedMap: any = {};\n\n//  避免频繁设置，导致的闪烁问题\nexport default (\n  controller: Controller,\n  contentId?: string,\n  options?: ShowCommentOptions,\n  config?: CommentPluginConfigs,\n) => {\n  const doUpdate = () => updateComment(controller, contentId, options, config);\n  const oldId = getActiveId(controller);\n\n  if (oldId && cachedMap[oldId]) {\n    window.clearTimeout(cachedMap[oldId]);\n  }\n  if (contentId && cachedMap[contentId]) {\n    window.clearTimeout(cachedMap[contentId]);\n  }\n  // 如果有一个是 undefined\n  const key = contentId || oldId;\n  if (key && (!oldId || !contentId)) {\n    // timeout 出于性能考虑，模拟 debounce 效果；这里后续是数据改动，无需清除\n    const timer = window.setTimeout(doUpdate, 100);\n    cachedMap[key] = timer;\n  } else {\n    doUpdate();\n  }\n};\n"],"file":"showComment.js"}