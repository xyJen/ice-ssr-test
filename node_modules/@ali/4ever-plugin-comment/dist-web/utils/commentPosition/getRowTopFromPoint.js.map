{"version":3,"sources":["../../../../src/utils/commentPosition/getRowTopFromPoint.ts"],"names":["TextPoint","Queries","domUtils","BLOCK_TOP_OFFSET","BLOCK_TOP_OFFSET_POPUP","SAMPLE_BLOCK_HEIGHT","corretCaretPoint","controller","point","document","value","getClosestVoid","key","getParent","type","query","pointAtDistance","getRootBlock","pointKey","path","getPath","firstPath","slice","firstRoot","length","getNodeByPath","findRow","params","docTop","top","allRows","container","undefined","rootKey","cachedRows","domNode","findDOMNodeSafely","newRows","splitRows","getBoundingClientRect","clientTop","height","forEach","r","points","rows","blockTop","targetTop","index","row","getRowTopFromPoint","paramPoint","isFromPopup","blockTopOffset","targetPoint","getNode","block","getClosestBlock","foldBlocks","firstFoldBlock","find","b","userData","get","firstFoldText","getFirstText","create","offset","pointCacheKey","viewKey","cachedPoint","p","caretTop","rowTop","Math","round","caretPosition","findCaretPosition","caretClientTop","result","rowHeight","rowOffsetTop","push"],"mappings":"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","sourcesContent":["import {\n  EdgePoint,\n  TextPoint,\n  Controller,\n  Document,\n  Block,\n  Queries,\n  domUtils,\n} from '@ali/4ever-cangjie';\n\n// Block 元素顶部的偏移，主要处理 border-radius 情况。\nconst BLOCK_TOP_OFFSET = 6;\n// sidebar POPUP 时的偏移。\nconst BLOCK_TOP_OFFSET_POPUP = -1;\n// 大于此值，会视为 Block 元素，定位到右上角；否则视为 Inline 元素，定位到光标中间\nconst SAMPLE_BLOCK_HEIGHT = 41;\n\ninterface MemoPoint {\n  // point 的 view key\n  key: string;\n  // 缓存的 point 位置计算结果\n  caretTop: number;\n  // splitRows 里面的一个 row\n  row: ReturnType<typeof domUtils.splitRows>[number];\n}\n\ninterface CachedRowsItem {\n  // offsetTop to docTop\n  top: number;\n  /// node height\n  height: number;\n  // 缓存的 point 点\n  points: MemoPoint[];\n  // 缓存的 rows\n  rows: ReturnType<typeof domUtils.splitRows>;\n}\n\n/**\n * 光标位置处理。由于 void 节点内的光标无法定位，尝试获取前一个位置\n */\nfunction corretCaretPoint(\n  controller: Controller,\n  point: EdgePoint | TextPoint,\n) {\n  const { document } = controller.value;\n  if (\n    document.getClosestVoid(point.key, controller) ||\n    document.getParent(point.key)?.type === 'code'\n  ) {\n    return controller.query(Queries.pointAtDistance, point, -1);\n  }\n  return point;\n}\n\n/**\n * 根据 key 获取 document 下面的一级节点\n */\nfunction getRootBlock(document: Document, pointKey: string) {\n  const path = document.getPath(pointKey);\n  const firstPath = path && path.slice(0, 1);\n  const firstRoot = firstPath?.length\n    ? document.getNodeByPath(firstPath)\n    : null;\n  return firstRoot;\n}\n\n/**\n * 根据 top 坐标，获取对应的分行（row）\n */\nfunction findRow(params: {\n  docTop: number;\n  top: number;\n  allRows: Record<string, CachedRowsItem>;\n  pointKey: string;\n  document: Document;\n  container: HTMLElement | Window;\n}) {\n  const { docTop, top, pointKey, document, allRows, container } = params;\n  const firstRoot = getRootBlock(document, pointKey);\n  if (!firstRoot) {\n    return undefined;\n  }\n  const { key: rootKey } = firstRoot;\n  let cachedRows = allRows[rootKey];\n\n  if (!cachedRows) {\n    const domNode = domUtils.findDOMNodeSafely(firstRoot.key, container);\n    const newRows = domNode && domUtils.splitRows(domNode);\n    if (!newRows || !newRows.length) {\n      return undefined;\n    }\n    const { top: clientTop, height } = domNode.getBoundingClientRect();\n    newRows.forEach((r) => {\n      // eslint-disable-next-line no-param-reassign\n      r.top -= clientTop;\n    });\n    cachedRows = {\n      top: clientTop - docTop,\n      height,\n      points: [],\n      rows: newRows,\n    };\n    allRows[rootKey] = cachedRows;\n  }\n\n  const { rows, top: blockTop } = cachedRows;\n  const targetTop = top - blockTop;\n  for (let index = 0; index < rows.length; index++) {\n    const row = rows[index];\n    if (row.top + row.height > targetTop) {\n      return { row, cachedRows };\n    }\n  }\n  const row = rows[rows.length - 1];\n  return { row, cachedRows };\n}\n\ninterface IParams {\n  controller: Controller;\n  isFromPopup?: boolean;\n  docTop: number;\n  container: HTMLElement | Window;\n  allRows: Record<string, CachedRowsItem>;\n  paramPoint: EdgePoint | TextPoint | undefined;\n}\n\n/**\n * 根据一个 point，获取对应的分行（row）、相对于 document 的 offsetTop\n */\nexport function getRowTopFromPoint(params: IParams) {\n  const {\n    controller,\n    paramPoint,\n    isFromPopup,\n    docTop,\n    container,\n    allRows,\n  } = params;\n  const { document } = controller.value;\n  const blockTopOffset = isFromPopup\n    ? BLOCK_TOP_OFFSET_POPUP\n    : BLOCK_TOP_OFFSET;\n  let targetPoint = paramPoint;\n  if (!targetPoint || !document.getNode(targetPoint.key)) {\n    return undefined;\n  }\n\n  // 0. 处理折叠逻辑等特殊场景，修正 point\n  const block = document.getClosestBlock(targetPoint.key);\n  const foldBlocks =\n    block && (controller.query('getHeadingAncestors', block) as Block[]);\n  const firstFoldBlock = foldBlocks && foldBlocks.find((b) => controller.userData.get(b, 'fold'));\n  const firstFoldText = firstFoldBlock?.getFirstText();\n  // 气泡形式，如果被折叠，就直接藏起来\n  if (!isFromPopup && firstFoldText) {\n    return undefined;\n  }\n  // 非气泡形式，如果被折叠，就找到折叠的段落\n  if (firstFoldText) {\n    targetPoint = TextPoint.create({\n      key: firstFoldText.key,\n      offset: 0,\n    });\n  }\n\n  const point = corretCaretPoint(controller, targetPoint);\n\n  // 1. 这里开始正式分行计算，获取 point 的 key\n  const pointCacheKey = point.viewKey;\n\n  // 1.1 先查有没有缓存，有的话， 就不需要计算了\n  const firstRoot = getRootBlock(document, point.key);\n  if (firstRoot) {\n    const cachedRows = firstRoot && allRows[firstRoot.key];\n    const cachedPoint = cachedRows?.points.find((p) => p.key === pointCacheKey);\n    if (cachedRows && cachedPoint) {\n      const { caretTop, row } = cachedPoint;\n      const rowTop = cachedRows.top + row.top;\n      return [Math.round(rowTop), Math.round(caretTop)];\n    }\n  }\n\n  // 2. 没有缓存，开始获取高度\n  const caretPosition = domUtils.findCaretPosition(point);\n  const caretClientTop = caretPosition?.clientTop;\n\n  if (typeof caretClientTop !== 'number') {\n    return undefined;\n  }\n\n  // 3. 计算分行（row）\n  const result = findRow({\n    top: caretClientTop - docTop,\n    docTop,\n    pointKey: point.key,\n    document,\n    container,\n    allRows,\n  });\n  if (!result) {\n    return undefined;\n  }\n\n  const { row, cachedRows } = result;\n  const { height: rowHeight, top: rowOffsetTop } = row;\n  const rowTop = cachedRows.top + rowOffsetTop;\n\n  // case 1：分行\n  // case 2：整个 void block\n  const top =\n    rowHeight <= SAMPLE_BLOCK_HEIGHT\n      ? caretClientTop - docTop\n      : rowTop + blockTopOffset;\n\n  // 4. 存到缓存里\n  cachedRows.points.push({\n    key: pointCacheKey,\n    caretTop: Math.round(top),\n    row,\n  });\n  return [Math.round(rowTop), Math.round(top)];\n}\n"],"file":"getRowTopFromPoint.js"}