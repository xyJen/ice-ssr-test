{"version":3,"sources":["../../../../src/utils/components/CommentInlinePanel.tsx"],"names":["React","Controller","useZoomContainer","ViewMark","getComments","getSiblings","cancelComment","hideComment","showComment","findDOMNodeByVoidKey","CommentInlinePanel","props","configs","onAdd","onDelete","enableAutoBlur","contentId","controller","useController","container","window","document","body","useState","position","setPosition","comments","item","find","c","decorations","value","decoration","d","isViewMark","mark","data","isNew","summary","rp","useEffect","voidNode","dom","querySelector","voidRect","getBoundingClientRect","rects","Array","from","getClientRects","rect","length","parent","top","bottom","left","width","parentRect","query","prev","next","navigateToPrev","useCallback","run","navigateToNext","cancelPopup","readonlyPosition","readOnly","undefined","summaryText","locale","comment","renderProps","isActive","isAutoFocus","Boolean","children","renderCustomPopup"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { Controller, useZoomContainer } from '@ali/4ever-cangjie';\nimport {\n  CommentPluginConfigs,\n  RenderCustomPopupProps,\n} from '../types';\nimport { ViewMark } from '../models/marks';\nimport getComments from '../queries/getComments';\nimport getSiblings from '../queries/getSiblings';\nimport { cancelComment, hideComment, showComment } from '../actions';\nimport { findDOMNodeByVoidKey } from '../utils/findDOMNodeByVoidKey';\n\ntype CommentSideBarProps = {\n  configs?: CommentPluginConfigs;\n  enableAutoBlur?: boolean;\n  onAdd: () => void;\n  onDelete: () => void;\n  contentId: string;\n};\n\ntype PopupData = {\n  top: number;\n  left: number;\n  contentId: string;\n};\n\nexport default function CommentInlinePanel(props: CommentSideBarProps) {\n  const { configs, onAdd, onDelete, enableAutoBlur, contentId } = props;\n  const controller = Controller.useController();\n  const container = useZoomContainer() || window.document.body;\n  const [position, setPosition] = React.useState<\n    RenderCustomPopupProps['position']\n  >();\n  const comments = getComments(controller);\n  const item = comments.find((c) => c.contentId === contentId);\n  const { decorations } = controller.value;\n  const decoration = decorations.find(\n    (d) => ViewMark.isViewMark(d.mark) && d.mark.data.contentId === contentId,\n  );\n  const mark = decoration?.mark as ViewMark | undefined;\n  const { isNew, summary, position: rp } = mark?.data || {};\n  React.useEffect(() => {\n    const voidNode = findDOMNodeByVoidKey(contentId, container);\n    const dom = container.querySelector(`[data-comment='${contentId}']`);\n    const voidRect = voidNode?.getBoundingClientRect();\n    const rects = voidRect ? [voidRect] : Array.from(dom?.getClientRects() || []);\n    const rect = rects[rects.length - 1];\n    if (!rect) {\n      return;\n    }\n    const parent = container.getBoundingClientRect();\n    const top = rect.bottom - parent.top;\n    const left = rect.left + rect.width / 2 - parent.left;\n    setPosition({ top, left, width: parent.width, rects, parentRect: parent });\n  }, [contentId, container, controller.value.decorations]);\n\n  const { prev, next } = controller.query(getSiblings);\n\n  const navigateToPrev = React.useCallback(() => {\n    if (prev) {\n      controller.run('onAction', showComment(prev));\n    }\n  }, [controller, prev]);\n\n  const navigateToNext = React.useCallback(() => {\n    if (next) {\n      controller.run('onAction', showComment(next));\n    }\n  }, [controller, next]);\n\n  const cancelPopup = React.useCallback(() => {\n    controller.run('onAction', hideComment());\n    controller.run('onAction', cancelComment());\n  }, [controller]);\n\n  if (!item && !decoration) {\n    return null;\n  }\n\n  let readonlyPosition: string | undefined = '';\n  if (isNew) {\n    readonlyPosition = controller.readOnly ? rp : undefined;\n  }\n  const summaryText =\n    summary || item?.summary || configs?.locale?.comment || '';\n  const renderProps: RenderCustomPopupProps = {\n    contentId,\n    isActive: true,\n    isAutoFocus: false,\n    isNew: Boolean(isNew),\n    summary: summaryText,\n    readonlyPosition,\n    onAdd,\n    onDelete,\n    prev,\n    next,\n    navigateToPrev,\n    navigateToNext,\n    cancelPopup,\n    position,\n  };\n  const children =\n    configs?.renderCustomPopup && configs.renderCustomPopup(renderProps);\n\n  return <React.Fragment>{children}</React.Fragment>;\n}\n"],"file":"CommentInlinePanel.js"}