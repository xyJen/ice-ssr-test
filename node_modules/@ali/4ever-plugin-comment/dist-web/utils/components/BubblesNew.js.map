{"version":3,"sources":["../../../../src/utils/components/BubblesNew.tsx"],"names":["React","styled","debounce","useZoomContainer","useZoom","TextPoint","Selection","domUtils","constants","environment","ViewMark","findCommentPostion","CommentAddButton","CommentBubble","useDocSize","hoverCapture","blockHoverEvent","BUTTON_SIZE","BubblesWrapper","div","SPACE_TO_DOC","IS_MOBILE","EFFECT_DEBOUNCE_TIME","getSelectionFromBlock","block","controller","fakePoint","create","key","offset","emptySelection","anchor","focus","newRange","moveToRangeOfNode","flip","convertToTextPoints","value","document","set","isFromTable","type","useRightSpace","rightSpaceId","useState","space","setSapce","useEffect","docNode","findDOMNodeSafely","contentNode","closest","Selector","content","getBoundingClientRect","docRight","right","contentRight","rightSpace","Math","max","BubblesNew","configs","disableRangeAdd","onBubbleClick","container","bubbles","setBubbles","ref","useRef","undefined","hoverBlock","setHoverBlock","handleHover","useCallback","on","off","decorations","selection","updatePosition","commentDecorations","filter","d","isViewMark","mark","hasHardSelection","isExpanded","getClosestVoid","isFocused","range","isCollapsed","rowItems","isFromPopup","current","top","refTop","documentNode","docTop","forEach","item","length","newBubbles","reduce","array","isMultiple","decoration","isAdd","Boolean","isHard","count","contentId","data","push","useReducer","s","updateRightSpace","tryUpdateRightSpace","isWidthChanged","debouncedFunc","cancel","handleHovered","isHover","trigger","zoom","wrapperStyle","useMemo","map","bubble","locale","addComment","showInline","showComent","round"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport styled from 'styled-components';\nimport { debounce } from 'lodash-es';\nimport {\n  Controller,\n  useZoomContainer,\n  useZoom,\n  TextPoint,\n  Selection,\n  Block,\n  domUtils,\n  constants,\n  environment,\n} from '@ali/4ever-cangjie';\n\nimport { ViewMark } from '../models/marks';\nimport { findCommentPostion } from '../utils/findCommentPostion';\nimport { CommentPluginConfigs } from '../types';\nimport { CommentAddButton, CommentBubble } from './floatButton';\nimport { useDocSize } from '../hooks/useDocSize';\nimport hoverCapture, { CaptureMsg } from '../utils/hoverCapture';\nimport blockHoverEvent from '../utils/blockHoverEvent';\nimport { BUTTON_SIZE } from '../utils/constants';\n\nconst BubblesWrapper = styled.div`\n  position: absolute;\n  top: 0;\n`;\n\nconst SPACE_TO_DOC = environment.IS_MOBILE ? -2 : 2;\nconst EFFECT_DEBOUNCE_TIME = 300;\n\ninterface IProps {\n  configs?: CommentPluginConfigs;\n  controller: Controller;\n}\n\ninterface Bubble {\n  top: number;\n  count: number;\n  contentId: string;\n  isMultiple: boolean;\n  newRange?: {\n    // 是否是 hover 产生的\n    isHard: boolean;\n    range: Selection;\n  };\n}\n\nfunction getSelectionFromBlock(block: Block, controller: Controller) {\n  const fakePoint = TextPoint.create({ key: '0', offset: 0 });\n  const emptySelection = Selection.create({\n    anchor: fakePoint,\n    focus: fakePoint,\n  });\n  const newRange = emptySelection.moveToRangeOfNode(block, controller).flip();\n  return Selection.create(\n    newRange.convertToTextPoints(controller.value.document),\n  ).set('data', { isFromTable: block.type === 'table' });\n}\n\n/**\n * cangjie-content 和 document 的 rect 不同步。\n *\n * 由于计算是基于 document、渲染是在 content 里面，这里设置一下差值。\n */\nfunction useRightSpace(controller: Controller, rightSpaceId: number) {\n  const [space, setSapce] = React.useState(0);\n  React.useEffect(() => {\n    const { document } = controller.value;\n    // eslint-disable-next-line react/no-find-dom-node\n    const docNode = domUtils.findDOMNodeSafely(document.key);\n    const contentNode = docNode?.closest(`[${constants.Selector.content}]`);\n    if (!docNode || !contentNode) {\n      return;\n    }\n    const { right: docRight } = docNode.getBoundingClientRect();\n    const { right: contentRight } = contentNode.getBoundingClientRect();\n    const rightSpace = Math.max(0, contentRight - docRight);\n    setSapce(rightSpace);\n  }, [controller, rightSpaceId]);\n  return space;\n}\n\nfunction BubblesNew({ configs, controller }: IProps) {\n  const { disableRangeAdd, onBubbleClick } = configs || {};\n  const container = useZoomContainer();\n  const [bubbles, setBubbles] = React.useState<Bubble[]>([]);\n  const ref = React.useRef<HTMLDivElement>(null);\n  const [hoverBlock, setHoverBlock] =\n    React.useState<Block | undefined>(undefined);\n\n  const handleHover = React.useCallback(\n    ({ block }: CaptureMsg) => {\n      if (hoverBlock !== block) {\n        setHoverBlock(block);\n      }\n    },\n    [hoverBlock],\n  );\n\n  React.useEffect(() => {\n    hoverCapture.on(handleHover);\n    return () => hoverCapture.off(handleHover);\n  }, [handleHover]);\n\n  const { decorations, document, selection } = controller.value;\n  const updatePosition = React.useCallback(() => {\n    const commentDecorations = decorations.filter((d) => {\n      return ViewMark.isViewMark(d.mark);\n    });\n    const hasHardSelection =\n      selection?.isExpanded ||\n      (selection &&\n        document.getClosestVoid(selection.anchor.key, controller) &&\n        controller.value.isFocused);\n    let range: Selection | undefined;\n    if (hasHardSelection && !disableRangeAdd) {\n      range = selection;\n    } else if (hoverBlock && selection.isCollapsed) {\n      range = getSelectionFromBlock(hoverBlock, controller);\n    }\n    const rowItems = findCommentPostion({\n      controller,\n      decorations: commentDecorations,\n      selection: range,\n      container: container || undefined,\n      isFromPopup: false,\n    });\n    const { top: refTop = 0 } = ref.current?.getBoundingClientRect() || {};\n    // eslint-disable-next-line react/no-find-dom-node\n    const documentNode = domUtils.findDOMNodeSafely(document.key);\n    if (!documentNode) {\n      return;\n    }\n    const { top: docTop } = documentNode.getBoundingClientRect();\n\n    rowItems.forEach((item) => {\n      // 如果存在 hover 选区、并且还有其他的气泡，就把选区去除掉\n      if (\n        item &&\n        !hasHardSelection &&\n        item.selection &&\n        item.decorations.length > 0\n      ) {\n        item.selection = undefined;\n      }\n    });\n    const newBubbles = rowItems.reduce<Bubble[]>((array, item) => {\n      const isMultiple = item.decorations.length > 1;\n      const decoration = item.decorations[0];\n      const top = item.top + docTop - refTop + BUTTON_SIZE / 2;\n      const isAdd = Boolean(item.selection);\n      const newRange =\n        isAdd && range\n          ? { range, isHard: Boolean(hasHardSelection) }\n          : undefined;\n      let count = 1;\n      let contentId = '';\n      if (decoration) {\n        const mark = decoration.mark as ViewMark;\n        ({ contentId, count } = mark.data);\n      }\n      array.push({ top, isMultiple, count, newRange, contentId });\n      return array;\n    }, []);\n    setBubbles(newBubbles);\n  }, [\n    decorations,\n    selection,\n    document,\n    controller,\n    disableRangeAdd,\n    hoverBlock,\n    container,\n  ]);\n\n  const [rightSpaceId, updateRightSpace] = React.useReducer(\n    (s: number) => s + 1,\n    0,\n  );\n  const tryUpdateRightSpace = React.useCallback((isWidthChanged: boolean) => {\n    if (isWidthChanged) {\n      updateRightSpace();\n    }\n  }, []);\n\n  useDocSize(ref, updatePosition);\n  useDocSize(ref, tryUpdateRightSpace);\n  React.useEffect(() => {\n    const debouncedFunc = debounce(updatePosition, EFFECT_DEBOUNCE_TIME);\n    debouncedFunc();\n    return () => {\n      debouncedFunc.cancel();\n    };\n  }, [updatePosition]);\n\n  const handleHovered = React.useCallback(\n    (isHover) => {\n      if (hoverBlock) {\n        blockHoverEvent.trigger({\n          block: hoverBlock,\n          isHover,\n        });\n      }\n    },\n    [hoverBlock],\n  );\n\n  const rightSpace = useRightSpace(controller, rightSpaceId);\n  const zoom = useZoom();\n  const wrapperStyle: React.CSSProperties = React.useMemo(\n    () => ({\n      right: `${(rightSpace - BUTTON_SIZE - SPACE_TO_DOC) / zoom}px`,\n    }),\n    [rightSpace, zoom],\n  );\n\n  return (\n    <BubblesWrapper data-comment-bubblesnew ref={ref} style={wrapperStyle}>\n      {bubbles.map((bubble) => {\n        const { newRange, contentId, isMultiple, count, top } = bubble;\n        if (newRange && !environment.IS_MOBILE) {\n          return (\n            <CommentAddButton\n              key={contentId}\n              controller={controller}\n              range={newRange.range}\n              onHover={newRange.isHard ? undefined : handleHovered}\n              top={top / zoom}\n              tips={configs?.locale?.addComment}\n            />\n          );\n        }\n\n        if (!newRange) {\n          return (\n            <CommentBubble\n              key={contentId}\n              controller={controller}\n              isMultiple={isMultiple}\n              count={count}\n              contentId={contentId}\n              showInline={configs?.showInline}\n              tips={configs?.locale?.showComent}\n              top={Math.round(top / zoom)}\n              onBubbleClick={onBubbleClick}\n            />\n          );\n        }\n        return null;\n      })}\n    </BubblesWrapper>\n  );\n}\n\nexport default BubblesNew;\n"],"file":"BubblesNew.js"}