{"version":3,"sources":["../../../../src/utils/components/ExternalSidebar.tsx"],"names":["React","styled","useZoomContainer","getActiveId","ViewMark","findCommentPostion","isAutoFocus","addComment","cancelComment","useDocSize","EmptyDiv","div","ExternalSidebar","props","ref","useRef","controller","configs","isCommentLoaded","onAdd","useCallback","run","onCancel","container","value","document","decorations","activeContentId","updatePosition","onSidebarInfoUpdated","commentDecorations","filter","d","isViewMark","mark","rowItems","length","selection","undefined","isFromPopup","autoFocus","cards","reduce","array","item","forEach","decoration","top","clientTop","data","isNew","contentId","summary","position","count","isActive","card","Boolean","push","prevDocument","usePrevious","useEffect","timer","setTimeout","EFFECT_DEBOUNCE_TIME","clearTimeout","current"],"mappings":"AAAA,OAAO,KAAKA,KAAZ,MAAuB,OAAvB;qBAC4B,a;AAA5B,OAAOC,MAAP,MAAmB,mBAAnB;AACA,SAAqBC,gBAArB,QAA6C,oBAA7C;AAEA,SAASC,WAAT;AAEA,SAASC,QAAT;AACA,SAASC,kBAAT;AACA,OAAOC,WAAP;AACA,SAASC,UAAT,EAAqBC,aAArB;AACA,SAASC,UAAT;AAQA,IAAMC,QAAQ,gBAAGT,MAAM,CAACU,GAAV,oCAAd;AAMA,eAAe,SAASC,eAAT,CAAyBC,KAAzB,EAAwC;AACrD,MAAMC,GAAG,GAAGd,KAAK,CAACe,MAAN,CAA6B,IAA7B,CAAZ;AADqD,MAG7CC,UAH6C,GAGCH,KAHD,CAG7CG,UAH6C;AAAA,uBAGCH,KAHD,CAGjCI,OAHiC;AAAA,MAGjCA,OAHiC,+BAGvB,EAHuB;AAAA,MAGnBC,eAHmB,GAGCL,KAHD,CAGnBK,eAHmB;AAIrD,MAAMC,KAAK,GAAGnB,KAAK,CAACoB,WAAN,CAAkB,YAAM;AACpCJ,IAAAA,UAAU,CAACK,GAAX,CAAe,UAAf,EAA2Bd,UAAU,EAArC;AACD,GAFa,EAEX,CAACS,UAAD,CAFW,CAAd;AAGA,MAAMM,QAAQ,GAAGtB,KAAK,CAACoB,WAAN,CAAkB,YAAM;AACvCJ,IAAAA,UAAU,CAACK,GAAX,CAAe,UAAf,EAA2Bb,aAAa,EAAxC;AACD,GAFgB,EAEd,CAACQ,UAAD,CAFc,CAAjB;AAIA,MAAMO,SAAS,GAAGrB,gBAAgB,EAAlC;AAXqD,0BAYnBc,UAAU,CAACQ,KAZQ;AAAA,MAY7CC,QAZ6C,qBAY7CA,QAZ6C;AAAA,MAYnCC,WAZmC,qBAYnCA,WAZmC;AAarD,MAAMC,eAAe,GAAGxB,WAAW,CAACa,UAAD,CAAnC;AAEA,MAAMY,cAAc,GAAG5B,KAAK,CAACoB,WAAN,CAAkB,YAAM;AAAA,eACZH,OADY;AAAA,QACrCY,oBADqC,QACrCA,oBADqC;;AAE7C,QAAI,CAACA,oBAAL,EAA2B;AACzB;AACD;;AACD,QAAMC,kBAAkB,GAAGJ,WAAW,CAACK,MAAZ,CAAmB,UAACC,CAAD,EAAO;AACnD,aAAO5B,QAAQ,CAAC6B,UAAT,CAAoBD,CAAC,CAACE,IAAtB,CAAP;AACD,KAF0B,CAA3B;AAGA,QAAMC,QAAQ,GAAGL,kBAAkB,CAACM,MAAnB,GACb/B,kBAAkB,CAAC;AACjBW,MAAAA,UAAU,EAAVA,UADiB;AAEjBU,MAAAA,WAAW,EAAEI,kBAFI;AAGjBO,MAAAA,SAAS,EAAEC,SAHM;AAIjBf,MAAAA,SAAS,EAAEA,SAAS,IAAIe,SAJP;AAKjBC,MAAAA,WAAW,EAAE;AALI,KAAD,CADL,GAQb,EARJ;AASA,QAAMC,SAAS,GAAGlC,WAAW,CAACU,UAAD,CAA7B,CAjB6C,CAmB7C;;AACA,QAAMyB,KAAK,GAAGN,QAAQ,CAACO,MAAT,CAAmC,UAACC,KAAD,EAAQC,IAAR,EAAiB;AAChEA,MAAAA,IAAI,CAAClB,WAAL,CAAiBmB,OAAjB,CAAyB,UAACC,UAAD,EAAgB;AAAA,YAC/BC,GAD+B,GACZH,IADY,CAC/BG,GAD+B;AAAA,YAC1BC,SAD0B,GACZJ,IADY,CAC1BI,SAD0B;AAEvC,YAAMd,IAAI,GAAGY,UAAU,CAACZ,IAAxB;AAFuC,yBAGgBA,IAAI,CAACe,IAHrB;AAAA,YAG/BC,KAH+B,cAG/BA,KAH+B;AAAA,YAGxBC,SAHwB,cAGxBA,SAHwB;AAAA,YAGbC,OAHa,cAGbA,OAHa;AAAA,YAGJC,QAHI,cAGJA,QAHI;AAAA,YAGMC,KAHN,cAGMA,KAHN;AAIvC,YAAMC,QAAQ,GAAGJ,SAAS,KAAKxB,eAA/B;AAEA,YAAM6B,IAAI,GAAG;AACXT,UAAAA,GAAG,EAAHA,GADW;AAEXC,UAAAA,SAAS,EAATA,SAFW;AAGXE,UAAAA,KAAK,EAAEO,OAAO,CAACP,KAAD,CAHH;AAIX5C,UAAAA,WAAW,EAAEmD,OAAO,CAACjB,SAAS,IAAIe,QAAd,CAJT;AAKXA,UAAAA,QAAQ,EAARA,QALW;AAMXD,UAAAA,KAAK,EAALA,KANW;AAOXF,UAAAA,OAAO,EAAPA,OAPW;AAQXC,UAAAA,QAAQ,EAARA,QARW;AASXF,UAAAA,SAAS,EAATA;AATW,SAAb;AAWAR,QAAAA,KAAK,CAACe,IAAN,CAAWF,IAAX;AACD,OAlBD;AAmBA,aAAOb,KAAP;AACD,KArBa,EAqBX,EArBW,CAAd;AAsBAd,IAAAA,oBAAoB,CAAC;AACnBY,MAAAA,KAAK,EAALA,KADmB;AAEnBtB,MAAAA,KAAK,EAALA,KAFmB;AAGnBG,MAAAA,QAAQ,EAARA,QAHmB;AAInBJ,MAAAA,eAAe,EAAfA;AAJmB,KAAD,CAApB;AAMD,GAhDsB,EAgDpB,CAACQ,WAAD,EAAcV,UAAd,EAA0BS,QAA1B,EAAoCF,SAApC,EAA+CI,eAA/C,EAAgET,eAAhE,CAhDoB,CAAvB;AAkDA,MAAMyC,YAAY,GAAGC,WAAW,CAACnC,QAAD,CAAhC;AACAzB,EAAAA,KAAK,CAAC6D,SAAN,CAAgB,YAAM;AACpB;AACJ;AACA;AACI,QAAI,CAACF,YAAD,IAAiBA,YAAY,KAAKlC,QAAtC,EAAgD;AAC9CG,MAAAA,cAAc;AACd,aAAOU,SAAP;AACD;AACD;AACJ;AACA;AACA;AACA;;;AACI,QAAMwB,KAAK,GAAGC,UAAU,CAAC,YAAM;AAC7BnC,MAAAA,cAAc;AACf,KAFuB,EAErBoC,oBAFqB,CAAxB;AAGA,WAAO,YAAM;AACXC,MAAAA,YAAY,CAACH,KAAD,CAAZ;AACD,KAFD;AAGD,GAnBD,EAmBG,CAAClC,cAAD,CAnBH;AAoBAnB,EAAAA,UAAU,CAACK,GAAD,EAAMc,cAAN,CAAV;AACA,sBAAO,eAAC,QAAD;AAAU,IAAA,GAAG,EAAEd;AAAf,IAAP;AACD;AAED,IAAMkD,oBAAoB,GAAG,GAA7B;;AAEA,SAASJ,WAAT,CAAwBpC,KAAxB,EAAiD;AAC/C,MAAMV,GAAG,GAAGd,KAAK,CAACe,MAAN,EAAZ;AACAf,EAAAA,KAAK,CAAC6D,SAAN,CAAgB,YAAM;AACpB/C,IAAAA,GAAG,CAACoD,OAAJ,GAAc1C,KAAd;AACD,GAFD;AAGA,SAAOV,GAAG,CAACoD,OAAX;AACD","sourcesContent":["import * as React from 'react';\nimport styled from 'styled-components';\nimport { Controller, useZoomContainer } from '@ali/4ever-cangjie';\n\nimport { getActiveId } from '../queries';\nimport { CommentPluginConfigs, SidebarCardInfo } from '../types';\nimport { ViewMark } from '../models/marks';\nimport { findCommentPostion } from '../utils/findCommentPostion';\nimport isAutoFocus from '../queries/isAutoFocus';\nimport { addComment, cancelComment } from '../actions';\nimport { useDocSize } from '../hooks/useDocSize';\n\ntype IProps = {\n  controller: Controller;\n  isCommentLoaded: boolean;\n  configs: CommentPluginConfigs;\n};\n\nconst EmptyDiv = styled.div`\n  width: 0;\n  height: 0;\n  display: none;\n`;\n\nexport default function ExternalSidebar(props: IProps) {\n  const ref = React.useRef<HTMLDivElement>(null);\n\n  const { controller, configs = {}, isCommentLoaded } = props;\n  const onAdd = React.useCallback(() => {\n    controller.run('onAction', addComment());\n  }, [controller]);\n  const onCancel = React.useCallback(() => {\n    controller.run('onAction', cancelComment());\n  }, [controller]);\n\n  const container = useZoomContainer();\n  const { document, decorations } = controller.value;\n  const activeContentId = getActiveId(controller);\n\n  const updatePosition = React.useCallback(() => {\n    const { onSidebarInfoUpdated } = configs as Record<string, any>;\n    if (!onSidebarInfoUpdated) {\n      return;\n    }\n    const commentDecorations = decorations.filter((d) => {\n      return ViewMark.isViewMark(d.mark);\n    });\n    const rowItems = commentDecorations.length\n      ? findCommentPostion({\n          controller,\n          decorations: commentDecorations,\n          selection: undefined,\n          container: container || undefined,\n          isFromPopup: true,\n        })\n      : [];\n    const autoFocus = isAutoFocus(controller);\n\n    // 生成 card 基本信息（这里可能有覆盖的场景）\n    const cards = rowItems.reduce<SidebarCardInfo[]>((array, item) => {\n      item.decorations.forEach((decoration) => {\n        const { top, clientTop } = item;\n        const mark = decoration.mark as ViewMark;\n        const { isNew, contentId, summary, position, count } = mark.data;\n        const isActive = contentId === activeContentId;\n\n        const card = {\n          top,\n          clientTop,\n          isNew: Boolean(isNew),\n          isAutoFocus: Boolean(autoFocus && isActive),\n          isActive,\n          count,\n          summary,\n          position,\n          contentId,\n        };\n        array.push(card);\n      });\n      return array;\n    }, []);\n    onSidebarInfoUpdated({\n      cards,\n      onAdd,\n      onCancel,\n      isCommentLoaded,\n    });\n  }, [decorations, controller, document, container, activeContentId, isCommentLoaded]);\n\n  const prevDocument = usePrevious(document);\n  React.useEffect(() => {\n    /**\n     * 非 document 变化，比如 decorations 变了，立刻刷新\n     */\n    if (!prevDocument || prevDocument === document) {\n      updatePosition();\n      return undefined;\n    }\n    /**\n     * document 变化，延迟刷新\n     *\n     * 一些场景比如（折叠标题），有动画延迟，等一会儿再更新，不然会闪烁\n     */\n    const timer = setTimeout(() => {\n      updatePosition();\n    }, EFFECT_DEBOUNCE_TIME);\n    return () => {\n      clearTimeout(timer);\n    };\n  }, [updatePosition]);\n  useDocSize(ref, updatePosition);\n  return <EmptyDiv ref={ref} />;\n}\n\nconst EFFECT_DEBOUNCE_TIME = 300;\n\nfunction usePrevious<T>(value: T): T | undefined {\n  const ref = React.useRef<T>();\n  React.useEffect(() => {\n    ref.current = value;\n  });\n  return ref.current;\n}\n"],"file":"ExternalSidebar.js"}