{"version":3,"sources":["../../../../src/utils/components/commentSidebar.tsx"],"names":["React","styled","useZoomContainer","domUtils","useZoom","environment","CloseBigNormal","ViewMark","PopupView","findCommentPostion","getActiveId","hideComment","cancelComment","setSidebarVisible","showComment","SIDEBAR_WIDTH","WIDTH","CARD_SPACE","SPACE","isAutoFocus","getSiblings","useAutoBlur","useDocSize","SCROLL_HEIGHT_PERCENT_SIDEBAR","ATTR_SIDEBAR","EFFECT_DEBOUNCE_TIME","IS_IPAD","RootWrapper","div","TopBarWrapper","TopBarInner","TopBarLine","CloseIconWrapper","SKIP_BLUR_PROPS","SKIP_BLUR_SELECOTR","skipBlur","target","some","s","hasAttribute","closest","adjustHeight","rawCards","activeContentId","focusedIndex","findIndex","card","contentId","cards","slice","updateHeight","prev","next","top","height","i","undefined","length","usePrevious","value","ref","useRef","useEffect","current","CommentSideBar","props","configs","onAdd","onDelete","enableAutoBlur","controller","container","document","decorations","hideSidebarTab","sidebarRef","useState","setCards","popHeights","useMemo","zoom","updatePosition","useCallback","commentDecorations","filter","d","isViewMark","mark","rowItems","selection","isFromPopup","autoFocus","getBoundingClientRect","barTop","findDOMNode","key","docTop","verticalOffset","newCards","reduce","array","item","forEach","decoration","data","isNew","summary","position","count","isActive","defaultHeight","find","vc","Math","round","Boolean","prio","push","activeIndex","c","abs","prevDocument","timer","setTimeout","clearTimeout","useLayoutEffect","showTimer","run","alwaysScroll","window","body","setAttribute","removeAttribute","clicker","event","Element","addEventListener","capture","removeEventListener","hideActive","handleCloseClick","handleCancelClick","handleKeydown","nativeEvent","isComposing","preventDefault","query","heightPercent","backgroundColor","sidebarBackgroundColor","topBarStyle","background","t","titleStr","locale","inlineComment","fontSize","map"],"mappings":";AAAA,OAAOA,KAAP,MAAkB,OAAlB;qBAC4B,a;AAA5B,OAAOC,MAAP,MAAmB,mBAAnB;AACA,SAAqBC,gBAArB,EAAuCC,QAAvC,EAAiDC,OAAjD,EAA0DC,WAA1D,QAA6E,oBAA7E;AACA,SAASC,cAAT,QAA+B,cAA/B;AACA,SAASC,QAAT;AACA,OAAOC,SAAP;AACA,SAASC,kBAAT;AACA,OAAOC,WAAP;AACA,SACEC,WADF,EAEEC,aAFF,EAGEC,iBAHF,EAIEC,WAJF;AAMA,SACEC,aAAa,IAAIC,KADnB,EAEEC,UAAU,IAAIC,KAFhB;AAMA,OAAOC,WAAP;AACA,OAAOC,WAAP;AACA,OAAOC,WAAP;AACA,SAASC,UAAT;AACA,SAASC,6BAAT;AAEA,IAAMC,YAAY,GAAG,sBAArB;AACA,IAAMC,oBAAoB,GAAG,GAA7B;IACQC,O,GAAYrB,W,CAAZqB,O;AAER,IAAMC,WAAW,gBAAG1B,MAAM,CAAC2B,GAAV,4GAENF,OAAO,GAAG,CAAH,GAAO,CAACV,KAFT,EAMNA,KANM,EAUbU,OAAO,mQAQL,EAlBW,CAAjB,C,CAqBA;;AACA,IAAMG,aAAa,gBAAG5B,MAAM,CAAC2B,GAAV,2GAGVF,OAAO,GAAG,MAAH,GAAY,CAHT,EAKRV,KALQ,CAAnB;AAWA,IAAMc,WAAW,gBAAG7B,MAAM,CAAC2B,GAAV,qFAAjB;AAOA,IAAMG,UAAU,gBAAG9B,MAAM,CAAC2B,GAAV,mEAAhB;AAKA,IAAMI,gBAAgB,gBAAG/B,MAAM,CAAC2B,GAAV,2JAAtB;AAyBA,IAAMK,eAAe,GAAG,CACtB,oBADsB,EAEtB,kBAFsB,EAGtB,qBAHsB,EAItB,yBAJsB,CAAxB;AAMA,IAAMC,kBAAkB,GAAG,CACzB,0BADyB,EAEzB,iBAFyB,EAGzB,qBAHyB,CAA3B;;AAMA,SAASC,QAAT,CAAkBC,MAAlB,EAAmC;AACjC,SAAOH,eAAe,CAACI,IAAhB,CACL,UAACC,CAAD;AAAA,WAAOF,MAAM,CAACG,YAAP,CAAoBD,CAApB,KAA0BF,MAAM,CAACI,OAAP,OAAmBF,CAAnB,OAAjC;AAAA,GADK,CAAP;AAGD;;AAED,SAASG,YAAT,CAAsBC,QAAtB,EAA4CC,eAA5C,EAAsE;AACpE,MAAMC,YAAY,GAAGF,QAAQ,CAACG,SAAT,CACnB,UAACC,IAAD;AAAA,WAAUA,IAAI,CAACC,SAAL,KAAmBJ,eAA7B;AAAA,GADmB,CAArB;AAGA,MAAMK,KAAiB,GAAGN,QAAQ,CAACO,KAAT,CAAe,CAAf,CAA1B;;AACA,WAASC,YAAT,CAAsBJ,IAAtB,EAAsCK,IAAtC,EAAuDC,IAAvD,EAAwE;AACtE,QAAID,IAAI,IAAIA,IAAI,CAACE,GAAL,GAAWF,IAAI,CAACG,MAAhB,GAAyBpC,KAAzB,GAAiC4B,IAAI,CAACO,GAAlD,EAAuD;AACrD,0BACKP,IADL;AAEEO,QAAAA,GAAG,EAAEF,IAAI,CAACE,GAAL,GAAWF,IAAI,CAACG,MAAhB,GAAyBpC;AAFhC;AAID;;AACD,QAAIkC,IAAI,IAAIN,IAAI,CAACO,GAAL,GAAWP,IAAI,CAACQ,MAAhB,GAAyBpC,KAAzB,GAAiCkC,IAAI,CAACC,GAAlD,EAAuD;AACrD,0BACKP,IADL;AAEEO,QAAAA,GAAG,EAAED,IAAI,CAACC,GAAL,GAAWnC,KAAX,GAAmB4B,IAAI,CAACQ;AAF/B;AAID;;AACD,WAAOR,IAAP;AACD;;AACD,OAAK,IAAIS,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGX,YAApB,EAAkCW,CAAC,EAAnC,EAAuC;AACrC,QAAMT,IAAI,GAAGI,YAAY,CAACF,KAAK,CAACO,CAAD,CAAN,EAAWP,KAAK,CAACO,CAAC,GAAG,CAAL,CAAhB,EAAyBC,SAAzB,CAAzB;AACAR,IAAAA,KAAK,CAACO,CAAD,CAAL,GAAWT,IAAX;AACD,GAvBmE,CAwBpE;;;AACA,OAAK,IAAIS,EAAC,GAAGX,YAAY,GAAG,CAA5B,EAA+BW,EAAC,IAAI,CAApC,EAAuCA,EAAC,EAAxC,EAA4C;AAC1C,QAAMT,KAAI,GAAGI,YAAY,CAACF,KAAK,CAACO,EAAD,CAAN,EAAWC,SAAX,EAAsBR,KAAK,CAACO,EAAC,GAAG,CAAL,CAA3B,CAAzB;;AACAP,IAAAA,KAAK,CAACO,EAAD,CAAL,GAAWT,KAAX;AACD;;AACD,OAAK,IAAIS,GAAC,GAAGX,YAAY,GAAG,CAA5B,EAA+BW,GAAC,GAAGP,KAAK,CAACS,MAAzC,EAAiDF,GAAC,EAAlD,EAAsD;AACpD,QAAMT,MAAI,GAAGI,YAAY,CAACF,KAAK,CAACO,GAAD,CAAN,EAAWP,KAAK,CAACO,GAAC,GAAG,CAAL,CAAhB,EAAyBC,SAAzB,CAAzB;;AACAR,IAAAA,KAAK,CAACO,GAAD,CAAL,GAAWT,MAAX;AACD;;AACD,SAAOE,KAAP;AACD;;AAUD,SAASU,WAAT,CAAwBC,KAAxB,EAAiD;AAC/C,MAAMC,GAAG,GAAG5D,KAAK,CAAC6D,MAAN,EAAZ;AACA7D,EAAAA,KAAK,CAAC8D,SAAN,CAAgB,YAAM;AACpBF,IAAAA,GAAG,CAACG,OAAJ,GAAcJ,KAAd;AACD,GAFD;AAGA,SAAOC,GAAG,CAACG,OAAX;AACD;;yBA4MS,eAAC,UAAD,O;;AA1MV,eAAe,SAASC,cAAT,CAAwBC,KAAxB,EAAoD;AAAA;;AAAA,MACzDC,OADyD,GACAD,KADA,CACzDC,OADyD;AAAA,MAChDC,KADgD,GACAF,KADA,CAChDE,KADgD;AAAA,MACzCC,QADyC,GACAH,KADA,CACzCG,QADyC;AAAA,MAC/BC,cAD+B,GACAJ,KADA,CAC/BI,cAD+B;AAAA,MACfC,UADe,GACAL,KADA,CACfK,UADe;AAEjE,MAAMC,SAAS,GAAGrE,gBAAgB,EAAlC;AACA,MAAM0D,GAAG,GAAG5D,KAAK,CAAC6D,MAAN,CAA6B,IAA7B,CAAZ;AAHiE,0BAI/BS,UAAU,CAACX,KAJoB;AAAA,MAIzDa,QAJyD,qBAIzDA,QAJyD;AAAA,MAI/CC,WAJ+C,qBAI/CA,WAJ+C;;AAAA,aAK1BP,OAAO,IAAI,EALe;AAAA,MAKzDQ,cALyD,QAKzDA,cALyD;AAAA,MAKzCC,UALyC,QAKzCA,UALyC;;AAAA,wBAOvC3E,KAAK,CAAC4E,QAAN,CAA2B,EAA3B,CAPuC;AAAA,MAO1D5B,KAP0D;AAAA,MAOnD6B,QAPmD;;AAQjE,MAAMC,UAAkC,GAAG9E,KAAK,CAAC+E,OAAN,CAAc;AAAA,WAAO,EAAP;AAAA,GAAd,EAA0B,EAA1B,CAA3C;AACA,MAAMC,IAAI,GAAG5E,OAAO,EAApB;AAEA;AACF;AACA;;AACE,MAAM6E,cAAc,GAAGjF,KAAK,CAACkF,WAAN,CAAkB,YAAM;AAAA;;AAC7C,QAAMC,kBAAkB,GAAGV,WAAW,CAACW,MAAZ,CAAmB,UAACC,CAAD,EAAO;AACnD,aAAO9E,QAAQ,CAAC+E,UAAT,CAAoBD,CAAC,CAACE,IAAtB,CAAP;AACD,KAF0B,CAA3B;AAGA,QAAMC,QAAQ,GAAG/E,kBAAkB,CAAC;AAClC6D,MAAAA,UAAU,EAAVA,UADkC;AAElCG,MAAAA,WAAW,EAAEU,kBAFqB;AAGlCM,MAAAA,SAAS,EAAEjC,SAHuB;AAIlCe,MAAAA,SAAS,EAAEA,SAAS,IAAIf,SAJU;AAKlCkC,MAAAA,WAAW,EAAE;AALqB,KAAD,CAAnC;AAOA,QAAM/C,eAAe,GAAGjC,WAAW,CAAC4D,UAAD,CAAnC;AACA,QAAMqB,SAAS,GAAGxE,WAAW,CAACmD,UAAD,CAA7B;;AAZ6C,gBAarB,iBAAAV,GAAG,CAACG,OAAJ,kCAAa6B,qBAAb,OAAwC,EAbnB;AAAA,QAahCC,MAbgC,SAarCxC,GAbqC,EAc7C;;;AAd6C,gCAerBlD,QAAQ,CAC7B2F,WADqB,CACTtB,QAAQ,CAACuB,GADA,EAErBH,qBAFqB,EAfqB;AAAA,QAehCI,MAfgC,yBAerC3C,GAfqC;;AAkB7C,QAAM4C,cAAc,GAAGJ,MAAM,GAAGA,MAAM,GAAGG,MAAZ,GAAqB,CAAlD,CAlB6C,CAoB7C;;AACA,QAAIE,QAAQ,GAAGV,QAAQ,CAACW,MAAT,CAA4B,UAACC,KAAD,EAAQC,IAAR,EAAiB;AAC1DA,MAAAA,IAAI,CAAC5B,WAAL,CAAiB6B,OAAjB,CAAyB,UAACC,UAAD,EAAgB;AAAA;;AAAA,YAC/BlD,GAD+B,GACvBgD,IADuB,CAC/BhD,GAD+B;AAEvC,YAAMkC,IAAI,GAAGgB,UAAU,CAAChB,IAAxB;AAFuC,yBAGgBA,IAAI,CAACiB,IAHrB;AAAA,YAG/BC,KAH+B,cAG/BA,KAH+B;AAAA,YAGxB1D,SAHwB,cAGxBA,SAHwB;AAAA,YAGb2D,OAHa,cAGbA,OAHa;AAAA,YAGJC,QAHI,cAGJA,QAHI;AAAA,YAGMC,KAHN,cAGMA,KAHN;AAIvC,YAAMC,QAAQ,GAAG9D,SAAS,KAAKJ,eAA/B;AACA,YAAMmE,aAAa,GAAGL,KAAK,GAAG,GAAH,GAAS,GAApC;AAEA,YAAMnD,MAAM,GACVwB,UAAU,CAAC/B,SAAD,CAAV,KACAC,KADA,mCACAA,KAAK,CAAE+D,IAAP,CAAY,UAACC,EAAD;AAAA,iBAAQA,EAAE,CAACjE,SAAH,KAAiBA,SAAzB;AAAA,SAAZ,CADA,qBACA,YAAiDO,MADjD,KAEAwD,aAHF;AAIA,YAAMhE,IAAc,GAAG;AACrBO,UAAAA,GAAG,EAAE4D,IAAI,CAACC,KAAL,CAAW7D,GAAG,GAAG4C,cAAjB,CADgB;AAErBQ,UAAAA,KAAK,EAAEU,OAAO,CAACV,KAAD,CAFO;AAGrBW,UAAAA,IAAI,EAAE,CAHe;AAIrBjG,UAAAA,WAAW,EAAEgG,OAAO,CAACxB,SAAS,IAAIkB,QAAd,CAJC;AAKrBA,UAAAA,QAAQ,EAARA,QALqB;AAMrBvD,UAAAA,MAAM,EAAEA,MAAM,GAAG0B,IANI;AAOrB4B,UAAAA,KAAK,EAALA,KAPqB;AAQrBF,UAAAA,OAAO,EAAPA,OARqB;AASrBC,UAAAA,QAAQ,EAARA,QATqB;AAUrB5D,UAAAA,SAAS,EAATA;AAVqB,SAAvB;AAYAqD,QAAAA,KAAK,CAACiB,IAAN,CAAWvE,IAAX;AACD,OAxBD;AAyBA,aAAOsD,KAAP;AACD,KA3Bc,EA2BZ,EA3BY,CAAf;AA4BAF,IAAAA,QAAQ,GAAGzD,YAAY,CAACyD,QAAD,EAAWvD,eAAX,CAAvB;AACA,QAAM2E,WAAW,GAAGpB,QAAQ,CAACrD,SAAT,CAClB,UAAC0E,CAAD;AAAA,aAAOA,CAAC,CAACxE,SAAF,KAAgBJ,eAAvB;AAAA,KADkB,CAApB;AAGAuD,IAAAA,QAAQ,CAACI,OAAT,CAAiB,UAACiB,CAAD,EAAIhE,CAAJ,EAAU;AACzBgE,MAAAA,CAAC,CAACH,IAAF,GAASH,IAAI,CAACO,GAAL,CAASjE,CAAC,GAAG+D,WAAb,CAAT;AACD,KAFD;AAGAzC,IAAAA,QAAQ,CAACqB,QAAD,CAAR;AACD,GAzDsB,EAyDpB,CAACzB,WAAD,EAAcH,UAAd,EAA0BE,QAA1B,EAAoCD,SAApC,EAA+CS,IAA/C,CAzDoB,CAAvB;AA2DA,MAAMyC,YAAY,GAAG/D,WAAW,CAACc,QAAD,CAAhC;AACAxE,EAAAA,KAAK,CAAC8D,SAAN,CAAgB,YAAM;AACpB;AACJ;AACA;AACI,QAAI2D,YAAY,KAAKjD,QAArB,EAA+B;AAC7BS,MAAAA,cAAc;AACd,aAAOzB,SAAP;AACD;AACD;AACJ;AACA;AACA;AACA;AACA;;;AACI,QAAMkE,KAAK,GAAGC,UAAU,CAAC,YAAM;AAC7B1C,MAAAA,cAAc;AACf,KAFuB,EAErBxD,oBAFqB,CAAxB;AAGA,WAAO,YAAM;AACXmG,MAAAA,YAAY,CAACF,KAAD,CAAZ;AACD,KAFD;AAGD,GApBD,EAoBG,CAACzC,cAAD,CApBH;AAsBA5D,EAAAA,WAAW,CAACiD,UAAD,EAAaD,cAAb,CAAX;AACA/C,EAAAA,UAAU,CAACsC,GAAD,EAAMqB,cAAN,CAAV;AACAjF,EAAAA,KAAK,CAAC6H,eAAN,CAAsB,YAAM;AAC1BlD,IAAAA,UAAU,IAAIA,UAAU,CAACf,GAAD,CAAxB;AACA,WAAO,YAAM;AACXe,MAAAA,UAAU,IAAIA,UAAU,CAACnB,SAAD,CAAxB;AACD,KAFD;AAGD,GALD,EAKG,CAACmB,UAAD,EAAaf,GAAb,CALH;AAOA5D,EAAAA,KAAK,CAAC8D,SAAN,CAAgB,YAAM;AACpB,QAAMnB,eAAe,GAAGjC,WAAW,CAAC4D,UAAD,CAAnC;;AACA,QAAI,CAAC3B,eAAL,EAAsB;AACpB,aAAOa,SAAP;AACD,KAJmB,CAKpB;;;AACA,QAAMsE,SAAS,GAAGH,UAAU,CAAC,YAAM;AACjCrD,MAAAA,UAAU,CAACyD,GAAX,CACE,UADF,EAEEjH,WAAW,CAAC6B,eAAD,EAAkB;AAAEqF,QAAAA,YAAY,EAAE;AAAhB,OAAlB,CAFb;AAID,KAL2B,EAKzB,CALyB,CAA5B;AAMA,WAAO,YAAM;AACXJ,MAAAA,YAAY,CAACE,SAAD,CAAZ;AACD,KAFD;AAGD,GAfD,EAeG,CAACxD,UAAD,CAfH;AAiBAtE,EAAAA,KAAK,CAAC8D,SAAN,CAAgB,YAAM;AACpBmE,IAAAA,MAAM,CAACzD,QAAP,CAAgB0D,IAAhB,CAAqBC,YAArB,CAAkC3G,YAAlC,EAAgD,EAAhD;AACA,WAAO,YAAM;AACXyG,MAAAA,MAAM,CAACzD,QAAP,CAAgB0D,IAAhB,CAAqBE,eAArB,CAAqC5G,YAArC;AACD,KAFD;AAGD,GALD,EAKG,EALH;AAOAxB,EAAAA,KAAK,CAAC8D,SAAN,CAAgB,YAAM;AACpB,QAAMuE,OAAO,GAAG,SAAVA,OAAU,CAACC,KAAD,EAAuB;AAAA,UAC7BlG,MAD6B,GAClBkG,KADkB,CAC7BlG,MAD6B;;AAErC,UACEA,MAAM,YAAYmG,OAAlB,IACA,CAACpG,QAAQ,CAACC,MAAD,CADT,IAEA,CAACF,kBAAkB,CAACG,IAAnB,CAAwB,UAACC,CAAD;AAAA,eAAOF,MAAM,CAACI,OAAP,CAAeF,CAAf,CAAP;AAAA,OAAxB,CAHH,EAIE;AACAgC,QAAAA,UAAU,CAACyD,GAAX,CAAe,UAAf,EAA2BjH,WAAW,CAAC0C,SAAD,CAAtC;AACD;AACF,KATD;;AAUAyE,IAAAA,MAAM,CAACzD,QAAP,CAAgBgE,gBAAhB,CAAiC,WAAjC,EAA8CH,OAA9C,EAAuD;AAAEI,MAAAA,OAAO,EAAE;AAAX,KAAvD;AACA,WAAO,YAAM;AACXR,MAAAA,MAAM,CAACzD,QAAP,CAAgBkE,mBAAhB,CAAoC,WAApC,EAAiDL,OAAjD,EAA0D;AACxDI,QAAAA,OAAO,EAAE;AAD+C,OAA1D;AAGD,KAJD;AAKD,GAjBD,EAiBG,CAACnE,UAAD,CAjBH;AAmBA,MAAMqE,UAAU,GAAG3I,KAAK,CAACkF,WAAN,CAAkB,YAAM;AACzCZ,IAAAA,UAAU,CAACyD,GAAX,CAAe,UAAf,EAA2BpH,WAAW,EAAtC;AACA2D,IAAAA,UAAU,CAACyD,GAAX,CAAe,UAAf,EAA2BnH,aAAa,EAAxC;AACD,GAHkB,EAGhB,CAAC0D,UAAD,CAHgB,CAAnB;AAKA,MAAMsE,gBAAgB,GAAG5I,KAAK,CAACkF,WAAN,CAAkB,YAAM;AAC/CZ,IAAAA,UAAU,CAACyD,GAAX,CAAe,UAAf,EAA2BlH,iBAAiB,CAAC,KAAD,CAA5C;AACA8H,IAAAA,UAAU;AACX,GAHwB,EAGtB,CAACrE,UAAD,EAAaqE,UAAb,CAHsB,CAAzB;AAKA,MAAME,iBAAiB,GAAG7I,KAAK,CAACkF,WAAN,CAAkB,YAAM;AAChDZ,IAAAA,UAAU,CAACyD,GAAX,CAAe,UAAf,EAA2BnH,aAAa,EAAxC;AACD,GAFyB,EAEvB,CAAC0D,UAAD,CAFuB,CAA1B;AAIA,MAAMwE,aAAa,GAAG9I,KAAK,CAACkF,WAAN,CACpB,UAACoD,KAAD,EAAgB;AACd,QAAIA,KAAK,CAACS,WAAN,CAAkBC,WAAtB,EAAmC;;AACnC,QAAIV,KAAK,CAACvC,GAAN,KAAc,WAAd,IAA6BuC,KAAK,CAACvC,GAAN,KAAc,SAA/C,EAA0D;AACxDuC,MAAAA,KAAK,CAACW,cAAN;;AADwD,8BAEjC3E,UAAU,CAAC4E,KAAX,CAAiB9H,WAAjB,CAFiC;AAAA,UAEhDgC,IAFgD,qBAEhDA,IAFgD;AAAA,UAE1CD,IAF0C,qBAE1CA,IAF0C;;AAGxD,UAAMf,MAAM,GAAGkG,KAAK,CAACvC,GAAN,KAAc,WAAd,GAA4B3C,IAA5B,GAAmCD,IAAlD;;AACA,UAAIf,MAAJ,EAAY;AACV,YAAM+G,aAAa,GAAG5H,6BAAtB;AACA+C,QAAAA,UAAU,CAACyD,GAAX,CAAe,UAAf,EAA2BjH,WAAW,CAACsB,MAAD,EAAS;AAAE+G,UAAAA,aAAa,EAAbA;AAAF,SAAT,CAAtC;AACD;AACF;AACF,GAZmB,EAapB,CAAC7E,UAAD,CAboB,CAAtB;AAgBA,MAAM8E,eAAe,GACnB,CAAAlF,OAAO,QAAP,YAAAA,OAAO,CAAEmF,sBAAT,KAAmCnF,OAAO,CAACmF,sBAAR,EADrC;AAEA,MAAMC,WAAgC,GAAG,EAAzC;;AACA,MAAIF,eAAJ,EAAqB;AACnBE,IAAAA,WAAW,CAACC,UAAZ,GAAyBH,eAAzB;AACD;;AACD,MAAMxC,KAAK,GAAG5D,KAAK,CAACmD,MAAN,CAAa,UAACqD,CAAD,EAAIjC,CAAJ;AAAA,WAAUiC,CAAC,GAAGjC,CAAC,CAACX,KAAhB;AAAA,GAAb,EAAoC,CAApC,CAAd;AACA,MAAM6C,QAAQ,IAAM,CAAAvF,OAAO,QAAP,+BAAAA,OAAO,CAAEwF,MAAT,qCAAiBC,aAAjB,KAAkC,SAAxC,WAAsD/C,KAAtD,MAAd;AACA,sBACE,eAAC,WAAD;AACE,uCADF;AAEE,IAAA,QAAQ,EAAE,CAFZ;AAGE,IAAA,GAAG,EAAEhD,GAHP;AAIE,6BAJF;AAKE,IAAA,SAAS,EAAEkF;AALb,KAOG,CAACpE,cAAD,iBACC,eAAC,aAAD;AAAe,IAAA,KAAK,EAAE4E;AAAtB,kBACE,eAAC,WAAD,qBACE,4BAAMG,QAAN,CADF,eAEE,eAAC,gBAAD;AAAkB,IAAA,OAAO,EAAEb;AAA3B,kBACE,eAAC,cAAD;AAAgB,IAAA,KAAK,EAAE;AAAEgB,MAAAA,QAAQ,EAAE;AAAZ;AAAvB,IADF,CAFF,CADF,QARJ,EAkBG5G,KAAK,CAAC6G,GAAN,CAAU,UAAC/G,IAAD,EAAU;AACnB,wBACE,eAAC,SAAD,eACMA,IADN;AAEE,MAAA,UAAU,EAAEwB,UAFd;AAGE,MAAA,KAAK,EAAEH,KAHT;AAIE,MAAA,UAAU,EAAEW,UAJd;AAKE,MAAA,QAAQ,EAAE+D,iBALZ;AAME,MAAA,QAAQ,EAAEzE,QANZ;AAOE,MAAA,GAAG,EAAEtB,IAAI,CAACC,SAPZ;AAQE,MAAA,OAAO,EAAEmB,OARX;AASE,MAAA,cAAc,EAAEe;AATlB,OADF;AAaD,GAdA,CAlBH,CADF;AAoCD","sourcesContent":["import React from 'react';\nimport styled from 'styled-components';\nimport { Controller, useZoomContainer, domUtils, useZoom, environment } from '@ali/4ever-cangjie';\nimport { CloseBigNormal } from '@ali/we-icon';\nimport { ViewMark } from '../models/marks';\nimport PopupView from '../components/popupView';\nimport { findCommentPostion } from '../utils/findCommentPostion';\nimport getActiveId from '../queries/getActiveId';\nimport {\n  hideComment,\n  cancelComment,\n  setSidebarVisible,\n  showComment,\n} from '../actions';\nimport {\n  SIDEBAR_WIDTH as WIDTH,\n  CARD_SPACE as SPACE,\n} from '../utils/constants';\nimport { CommentPluginConfigs } from '../types';\nimport { tipStyle } from '../common';\nimport isAutoFocus from '../queries/isAutoFocus';\nimport getSiblings from '../queries/getSiblings';\nimport useAutoBlur from '../hooks/useAutoBlur';\nimport { useDocSize } from '../hooks/useDocSize';\nimport { SCROLL_HEIGHT_PERCENT_SIDEBAR } from '../constants';\n\nconst ATTR_SIDEBAR = 'data-comment-sidebar';\nconst EFFECT_DEBOUNCE_TIME = 300;\nconst { IS_IPAD } = environment;\n\nconst RootWrapper = styled.div`\n  position: absolute;\n  right: ${IS_IPAD ? 0 : -WIDTH}px;\n  top: -6px;\n  z-index: 1;\n  height: 100%;\n  width: ${WIDTH}px;\n  &:focus {\n    outline: none;\n  }\n  ${IS_IPAD ? `\n    background: white;\n    @media (max-width: 700px) {\n      box-shadow: 0px 0px 1px rgba(0, 0, 0, 0.24), 0px 8px 24px rgba(0, 0, 0, 0.16);\n    }\n    @media (min-width: 700px) {\n      border-left: 1px solid rgba(126, 134, 142, 0.16);\n    }\n  ` : ''}\n`;\n\n// iPad 下有 h5 top bar，这里加上 64px 的偏移\nconst TopBarWrapper = styled.div`\n  z-index: 1;\n  position: fixed;\n  top: ${IS_IPAD ? '64px' : 0 };\n  right: 0;\n  width: ${WIDTH}px;\n  font-size: 16px;\n  color: #111F2C;\n  font-weight: 500;\n`;\n\nconst TopBarInner = styled.div`\n  margin-left: 16px;\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n`;\n\nconst TopBarLine = styled.div`\n  margin: 0 16px;\n  border-bottom: 1px solid rgba(126, 134, 142, 0.16);\n`;\n\nconst CloseIconWrapper = styled.div`\n  font-size: 0;\n  font-weight: normal;\n  width: 52px;\n  height: 52px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  color: rgba(23, 26, 29, 0.6);\n  cursor: pointer;\n`;\n\ntype CardInfo = {\n  top: number;\n  prio: number;\n  isNew: boolean;\n  count: number;\n  isActive: boolean;\n  isAutoFocus: boolean;\n  contentId: string;\n  summary: string;\n  height: number;\n  position?: string;\n};\n\nconst SKIP_BLUR_PROPS = [\n  'data-comment-popup',\n  'data-panel-emoji',\n  'data-comment-noblur',\n  'data-comment-no-capture',\n];\nconst SKIP_BLUR_SELECOTR = [\n  '.mention-suggestion-list',\n  '.ant-popconfirm',\n  '.popup-overlay-wrap',\n];\n\nfunction skipBlur(target: Element) {\n  return SKIP_BLUR_PROPS.some(\n    (s) => target.hasAttribute(s) || target.closest(`[${s}]`),\n  );\n}\n\nfunction adjustHeight(rawCards: CardInfo[], activeContentId?: string) {\n  const focusedIndex = rawCards.findIndex(\n    (card) => card.contentId === activeContentId,\n  );\n  const cards: CardInfo[] = rawCards.slice(0);\n  function updateHeight(card: CardInfo, prev?: CardInfo, next?: CardInfo) {\n    if (prev && prev.top + prev.height + SPACE > card.top) {\n      return {\n        ...card,\n        top: prev.top + prev.height + SPACE,\n      };\n    }\n    if (next && card.top + card.height + SPACE > next.top) {\n      return {\n        ...card,\n        top: next.top - SPACE - card.height,\n      };\n    }\n    return card;\n  }\n  for (let i = 1; i < focusedIndex; i++) {\n    const card = updateHeight(cards[i], cards[i - 1], undefined);\n    cards[i] = card;\n  }\n  // eslint-disable-next-line for-direction\n  for (let i = focusedIndex - 1; i >= 0; i--) {\n    const card = updateHeight(cards[i], undefined, cards[i + 1]);\n    cards[i] = card;\n  }\n  for (let i = focusedIndex + 1; i < cards.length; i++) {\n    const card = updateHeight(cards[i], cards[i - 1], undefined);\n    cards[i] = card;\n  }\n  return cards;\n}\n\ntype CommentSideBarProps = {\n  configs?: CommentPluginConfigs;\n  controller: Controller;\n  enableAutoBlur?: boolean;\n  onAdd: () => void;\n  onDelete: () => void;\n};\n\nfunction usePrevious<T>(value: T): T | undefined {\n  const ref = React.useRef<T>();\n  React.useEffect(() => {\n    ref.current = value;\n  });\n  return ref.current;\n}\n\nexport default function CommentSideBar(props: CommentSideBarProps) {\n  const { configs, onAdd, onDelete, enableAutoBlur, controller } = props;\n  const container = useZoomContainer();\n  const ref = React.useRef<HTMLDivElement>(null);\n  const { document, decorations } = controller.value;\n  const { hideSidebarTab, sidebarRef } = configs || {};\n\n  const [cards, setCards] = React.useState<CardInfo[]>([]);\n  const popHeights: Record<string, number> = React.useMemo(() => ({}), []);\n  const zoom = useZoom();\n\n  /**\n   * 在渲染出 DOM 后，遍历 DOM 位置，获取对应的 offset\n   */\n  const updatePosition = React.useCallback(() => {\n    const commentDecorations = decorations.filter((d) => {\n      return ViewMark.isViewMark(d.mark);\n    });\n    const rowItems = findCommentPostion({\n      controller,\n      decorations: commentDecorations,\n      selection: undefined,\n      container: container || undefined,\n      isFromPopup: true,\n    });\n    const activeContentId = getActiveId(controller);\n    const autoFocus = isAutoFocus(controller);\n    const { top: barTop } = ref.current?.getBoundingClientRect() || {};\n    // eslint-disable-next-line react/no-find-dom-node\n    const { top: docTop } = domUtils\n      .findDOMNode(document.key)\n      .getBoundingClientRect();\n    const verticalOffset = barTop ? barTop - docTop : 0;\n\n    // 生成 card 基本信息（这里可能有覆盖的场景）\n    let newCards = rowItems.reduce<CardInfo[]>((array, item) => {\n      item.decorations.forEach((decoration) => {\n        const { top } = item;\n        const mark = decoration.mark as ViewMark;\n        const { isNew, contentId, summary, position, count } = mark.data;\n        const isActive = contentId === activeContentId;\n        const defaultHeight = isNew ? 121 : 180;\n\n        const height =\n          popHeights[contentId] ||\n          cards?.find((vc) => vc.contentId === contentId)?.height ||\n          defaultHeight;\n        const card: CardInfo = {\n          top: Math.round(top - verticalOffset),\n          isNew: Boolean(isNew),\n          prio: 0,\n          isAutoFocus: Boolean(autoFocus && isActive),\n          isActive,\n          height: height * zoom,\n          count,\n          summary,\n          position,\n          contentId,\n        };\n        array.push(card);\n      });\n      return array;\n    }, []);\n    newCards = adjustHeight(newCards, activeContentId);\n    const activeIndex = newCards.findIndex(\n      (c) => c.contentId === activeContentId,\n    );\n    newCards.forEach((c, i) => {\n      c.prio = Math.abs(i - activeIndex);\n    });\n    setCards(newCards);\n  }, [decorations, controller, document, container, zoom]);\n\n  const prevDocument = usePrevious(document);\n  React.useEffect(() => {\n    /**\n     * 非 document 变化，比如 decorations 变了，立刻刷新\n     */\n    if (prevDocument === document) {\n      updatePosition();\n      return undefined;\n    }\n    /**\n     * document 变化，延迟刷新\n     *\n     * 一些场景比如（折叠标题），有动画延迟，等一会儿再更新，不然会闪烁\n     * 首次打开也要延迟刷新，因为侧边栏展开可能导致图片等元素缩放, 高度发生变化\n     */\n    const timer = setTimeout(() => {\n      updatePosition();\n    }, EFFECT_DEBOUNCE_TIME);\n    return () => {\n      clearTimeout(timer);\n    };\n  }, [updatePosition]);\n\n  useAutoBlur(controller, enableAutoBlur);\n  useDocSize(ref, updatePosition);\n  React.useLayoutEffect(() => {\n    sidebarRef && sidebarRef(ref);\n    return () => {\n      sidebarRef && sidebarRef(undefined);\n    };\n  }, [sidebarRef, ref]);\n\n  React.useEffect(() => {\n    const activeContentId = getActiveId(controller);\n    if (!activeContentId) {\n      return undefined;\n    }\n    // timeout 出于体验考虑，下一个 tick 再更新，避免频繁闪烁\n    const showTimer = setTimeout(() => {\n      controller.run(\n        'onAction',\n        showComment(activeContentId, { alwaysScroll: true }),\n      );\n    }, 0);\n    return () => {\n      clearTimeout(showTimer);\n    };\n  }, [controller]);\n\n  React.useEffect(() => {\n    window.document.body.setAttribute(ATTR_SIDEBAR, '');\n    return () => {\n      window.document.body.removeAttribute(ATTR_SIDEBAR);\n    };\n  }, []);\n\n  React.useEffect(() => {\n    const clicker = (event: MouseEvent) => {\n      const { target } = event;\n      if (\n        target instanceof Element &&\n        !skipBlur(target) &&\n        !SKIP_BLUR_SELECOTR.some((s) => target.closest(s))\n      ) {\n        controller.run('onAction', showComment(undefined));\n      }\n    };\n    window.document.addEventListener('mousedown', clicker, { capture: true });\n    return () => {\n      window.document.removeEventListener('mousedown', clicker, {\n        capture: true,\n      });\n    };\n  }, [controller]);\n\n  const hideActive = React.useCallback(() => {\n    controller.run('onAction', hideComment());\n    controller.run('onAction', cancelComment());\n  }, [controller]);\n\n  const handleCloseClick = React.useCallback(() => {\n    controller.run('onAction', setSidebarVisible(false));\n    hideActive();\n  }, [controller, hideActive]);\n\n  const handleCancelClick = React.useCallback(() => {\n    controller.run('onAction', cancelComment());\n  }, [controller]);\n\n  const handleKeydown = React.useCallback(\n    (event: any) => {\n      if (event.nativeEvent.isComposing) return;\n      if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {\n        event.preventDefault();\n        const { next, prev } = controller.query(getSiblings);\n        const target = event.key === 'ArrowDown' ? next : prev;\n        if (target) {\n          const heightPercent = SCROLL_HEIGHT_PERCENT_SIDEBAR;\n          controller.run('onAction', showComment(target, { heightPercent }));\n        }\n      }\n    },\n    [controller],\n  );\n\n  const backgroundColor =\n    configs?.sidebarBackgroundColor && configs.sidebarBackgroundColor();\n  const topBarStyle: React.CSSProperties = {};\n  if (backgroundColor) {\n    topBarStyle.background = backgroundColor;\n  }\n  const count = cards.reduce((t, c) => t + c.count, 0);\n  const titleStr = `${configs?.locale?.inlineComment || 'Comment'} (${count})`;\n  return (\n    <RootWrapper\n      data-inline-comment-sidebar\n      tabIndex={0}\n      ref={ref}\n      data-cache-ignore\n      onKeyDown={handleKeydown}\n    >\n      {!hideSidebarTab && (\n        <TopBarWrapper style={topBarStyle}>\n          <TopBarInner>\n            <div>{titleStr}</div>\n            <CloseIconWrapper onClick={handleCloseClick}>\n              <CloseBigNormal style={{ fontSize: '20px' }} />\n            </CloseIconWrapper>\n          </TopBarInner>\n          <TopBarLine />\n        </TopBarWrapper>\n      )}\n      {cards.map((card) => {\n        return (\n          <PopupView\n            {...card}\n            controller={controller}\n            onAdd={onAdd}\n            popHeights={popHeights}\n            onCancel={handleCancelClick}\n            onDelete={onDelete}\n            key={card.contentId}\n            configs={configs}\n            updatePosition={updatePosition}\n          />\n        );\n      })}\n    </RootWrapper>\n  );\n}\n"],"file":"commentSidebar.js"}