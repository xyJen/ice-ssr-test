{"version":3,"sources":["../../../../src/utils/components/CommentBottomBar.tsx"],"names":["React","styled","Controller","CompleteNormal","ToolbarArrowDownNormal","MobileBottomCurtain","ViewMark","hideComment","cancelComment","showComment","blockEvent","getSiblings","getComments","CURTAIN_HEIGHT","curtainWrapperStyle","maxHeight","ToolbarArrowUpNormal","TitleWrapper","div","Title","Finish","IconWrapper","props","isDisabled","Content","CommentBottomBar","configs","contentId","onAdd","onDelete","controller","useController","comments","item","find","c","decorations","value","decoration","d","isViewMark","mark","data","useState","isForcedNotVisible","setForcedNotVisible","timerRef","useRef","hideActive","useCallback","run","hideNew","some","isNew","handleClose","current","clearTimeout","setTimeout","useEffect","handleCloseComment","closeComment","isCloseDisabled","hideCloseMenu","query","prev","next","navigateToPrev","event","navigateToNext","summary","position","readonlyPosition","readOnly","undefined","summaryText","locale","comment","renderProps","isActive","isAutoFocus","Boolean","children","renderPopup"],"mappings":"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","sourcesContent":["import React from 'react';\nimport styled from 'styled-components';\nimport { Controller } from '@ali/4ever-cangjie';\nimport { CompleteNormal, ToolbarArrowDownNormal } from '@ali/we-icon';\nimport { MobileBottomCurtain } from '@ali/we-design';\nimport { CommentPluginConfigs, RenderPopupProps } from '../types';\nimport { ViewMark } from '../models/marks';\nimport { hideComment, cancelComment, showComment } from '../actions';\nimport blockEvent from '../utils/blockEvent';\nimport getSiblings from '../queries/getSiblings';\nimport getComments from '../queries/getComments';\n\nconst CURTAIN_HEIGHT = 480;\nconst curtainWrapperStyle = {\n  maxHeight: '70vh',\n};\n\nconst ToolbarArrowUpNormal = styled(ToolbarArrowDownNormal)`\n  transform: rotate(180deg);\n`;\n\nconst TitleWrapper = styled.div`\n  padding: 0 16px 0 19px;\n  font-size: 16px;\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n`;\n\nconst Title = styled.div`\n  flex: 1;\n  font-size: 14px;\n  text-align: left;\n  color: #171a1d;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  overflow: hidden;\n  letter-spacing: 0.22px;\n  font-weight: normal;\n`;\nconst Finish = styled.div`\n  padding: 0 4px;\n  line-height: 42px;\n  white-space: nowrap;\n  color: #191F25;;\n  flex: 0 0 36px;\n  text-align: center;\n  & > span {\n    font-size: 20px;\n  }\n`;\n\nconst IconWrapper = styled.div<{ isDisabled?: boolean }>`\n  height: 42px;\n  width: 36px;\n  display: flex;\n  cursor: pointer;\n  flex-direction: row;\n  justify-content: center;\n  align-items: center;\n  color: ${(props) =>\n    props.isDisabled ? 'rgba(23, 26, 29, 0.24)' : '#171A1D'};\n  & span {\n    font-size: 20px;\n  }\n`;\n\nconst Content = styled.div`\n  display: flex;\n  flex: 1;\n  overflow-y: scroll;\n  flex-direction: row;\n  & > :first-child {\n    width: 100%;\n  }\n  & [data-cmt-editor-container] {\n    background: white;\n  }\n`;\n\ntype CommentBottomBarProps = {\n  configs?: CommentPluginConfigs;\n  onAdd: () => void;\n  onDelete: () => void;\n  contentId: string;\n};\n\nfunction CommentBottomBar(props: CommentBottomBarProps) {\n  const { configs, contentId, onAdd, onDelete } = props;\n  const controller = Controller.useController();\n  const comments = getComments(controller);\n  const item = comments.find((c) => c.contentId === contentId);\n  const { decorations } = controller.value;\n  const decoration = decorations.find(\n    (d) => ViewMark.isViewMark(d.mark) && d.mark.data.contentId === contentId,\n  );\n\n  const [isForcedNotVisible, setForcedNotVisible] = React.useState(false);\n  const timerRef = React.useRef<ReturnType<typeof setTimeout>>();\n\n  const hideActive = React.useCallback(() => {\n    controller.run('onAction', hideComment());\n  }, [controller]);\n  const hideNew = React.useCallback(() => {\n    if (\n      decorations.some((d) => ViewMark.isViewMark(d.mark) && d.mark.data.isNew)\n    ) {\n      controller.run('onAction', cancelComment());\n    }\n  }, [controller, decorations]);\n\n  const handleClose = React.useCallback(() => {\n    setForcedNotVisible(true);\n    timerRef.current && clearTimeout(timerRef.current);\n    // timeout 出于体验考虑，展示 100ms 动画效果；上面已经有清除逻辑\n    timerRef.current = setTimeout(() => {\n      setForcedNotVisible(false);\n    }, 100);\n    hideActive();\n    hideNew();\n  }, [hideActive, hideNew]);\n\n  React.useEffect(() => {\n    return () => {\n      timerRef.current && clearTimeout(timerRef.current);\n    }\n  }, []);\n\n  const handleCloseComment = React.useCallback(() => {\n    configs?.closeComment && configs?.closeComment(contentId, handleClose);\n  }, [handleClose, contentId]);\n\n  const isCloseDisabled = configs?.hideCloseMenu && configs.hideCloseMenu();\n\n  const { prev, next } = controller.query(getSiblings);\n  const navigateToPrev = React.useCallback(\n    (event: React.MouseEvent) => {\n      if (prev) {\n        controller.run('onAction', showComment(prev));\n      }\n      blockEvent(event);\n    },\n    [controller, prev],\n  );\n\n  const navigateToNext = React.useCallback(\n    (event: React.MouseEvent) => {\n      if (next) {\n        controller.run('onAction', showComment(next));\n      }\n      blockEvent(event);\n    },\n    [controller, next],\n  );\n\n  if (!item && !decoration) {\n    return null;\n  }\n\n  const mark = decoration?.mark as ViewMark | undefined;\n  const { isNew, summary, position } = mark?.data || {};\n  let readonlyPosition: string | undefined = '';\n  if (isNew) {\n    readonlyPosition = controller.readOnly ? position : undefined;\n  }\n  const summaryText = summary || item?.summary || configs?.locale?.comment || '';\n  const renderProps: RenderPopupProps = {\n    contentId,\n    isActive: true,\n    isAutoFocus: false,\n    isNew: Boolean(isNew),\n    summary: summaryText,\n    readonlyPosition,\n    onAdd,\n    onDelete,\n  };\n  const children = configs?.renderPopup && configs.renderPopup(renderProps);\n\n  return (\n    <MobileBottomCurtain\n      isVisible={!!contentId && !isForcedNotVisible}\n      onClose={handleClose}\n      height={CURTAIN_HEIGHT}\n      title={\n        <TitleWrapper>\n          <Title>{`| ${summaryText}`}</Title>\n          <IconWrapper isDisabled={!prev} onClick={navigateToPrev}>\n            <ToolbarArrowUpNormal />\n          </IconWrapper>\n          <IconWrapper isDisabled={!next} onClick={navigateToNext}>\n            <ToolbarArrowDownNormal />\n          </IconWrapper>\n          { (!isNew && !isCloseDisabled) && (<Finish onClick={handleCloseComment}><CompleteNormal /></Finish>)}\n        </TitleWrapper>\n      }\n      style={curtainWrapperStyle}\n    >\n      <Content key={contentId} onClick={blockEvent}>\n        {children}\n      </Content>\n    </MobileBottomCurtain>\n  );\n}\n\nexport default CommentBottomBar;\n"],"file":"CommentBottomBar.js"}