{"version":3,"sources":["../../../../src/utils/hooks/useDocSize.ts"],"names":["React","debounce","fastdom","constants","ResizeObserver","DEBOUNCE_TIME","docs","WeakMap","CONTENT","Selector","content","EDITABLE","editable","handleSizeChange","doc","doUpdate","isWidthChanged","isHeightChanged","callbacks","forEach","c","error","console","measure","docNode","prevHeight","prevWidth","getBoundingClientRect","width","height","Math","round","w","h","setTimeout","onElementRemoved","element","onDetachCallback","observer","MutationObserver","isDetached","el","closest","disconnect","observe","childList","subtree","addObserver","node","callback","contentNode","parentElement","querySelector","undefined","get","push","newObj","changeCallback","set","removeObserver","filter","useDocSize","nodeRef","useEffect","current"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { debounce } from 'lodash-es';\nimport fastdom from 'fastdom';\nimport { constants } from '@ali/4ever-cangjie';\nimport ResizeObserver from 'resize-observer-polyfill';\n\nconst DEBOUNCE_TIME = 300;\n\ntype Callback = (isWidthChanged: boolean, isHeightChanged: boolean) => void;\n\ntype DocObj = {\n  callbacks: Callback[];\n  docNode: HTMLElement;\n  prevWidth?: number;\n  prevHeight?: number;\n};\n\nconst docs = new WeakMap<HTMLElement, DocObj>();\nconst CONTENT = `[${constants.Selector.content}]`;\nconst EDITABLE = `[${constants.Selector.editable}]`;\n\n/**\n * size change, 触发 callback\n */\nconst handleSizeChange = (doc: DocObj) => () => {\n  const doUpdate = (isWidthChanged: boolean, isHeightChanged: boolean) => {\n    const { callbacks } = doc;\n    try {\n      // 移动端由于键盘弹起，可能会导致迅速的切换。\n      // 这里 callback 使用了 findDOMNode，报错的话需要 ignore 掉\n      callbacks.forEach((c) => c(isWidthChanged, isHeightChanged));\n    } catch (error) {\n      console.error(error);\n    }\n  };\n  fastdom.measure(() => {\n    const { docNode, prevHeight, prevWidth } = doc;\n    const { width, height } = docNode.getBoundingClientRect();\n    const [w, h] = [Math.round(width), Math.round(height)];\n    const isWidthChanged = prevWidth !== w;\n    const isHeightChanged = prevHeight !== h;\n    if (isWidthChanged || isHeightChanged) {\n      // timeout 出于性能考虑，避免再 measure 期间调用更新\n      setTimeout(() => {\n        doUpdate(isWidthChanged, isHeightChanged);\n      }, 0);\n    }\n    doc.prevWidth = w;\n    doc.prevHeight = h;\n  });\n};\n\n/**\n * DOM 元素被移除的回调\n */\nfunction onElementRemoved(element: HTMLElement, onDetachCallback: Function) {\n  const observer = new MutationObserver(\n    debounce(() => {\n      const isDetached = (el: HTMLElement) => !el.closest('html');\n      if (isDetached(element)) {\n        observer.disconnect();\n        onDetachCallback();\n      }\n    }, DEBOUNCE_TIME),\n  );\n  observer.observe(element, {\n    childList: true,\n    subtree: true,\n  });\n}\n\nfunction addObserver(node: HTMLElement | null, callback: Callback) {\n  const contentNode =\n    node?.closest(CONTENT) || node?.parentElement?.querySelector(CONTENT);\n  const docNode = contentNode?.querySelector(EDITABLE) as\n    | HTMLElement\n    | undefined;\n  if (!docNode) {\n    return undefined;\n  }\n  const doc = docs.get(docNode);\n  if (doc) {\n    doc.callbacks.push(callback);\n    return doc;\n  }\n  const callbacks = [callback];\n  const newObj: DocObj = {\n    callbacks,\n    docNode,\n  };\n  const changeCallback = handleSizeChange(newObj);\n  const observer = new ResizeObserver(debounce(changeCallback, DEBOUNCE_TIME));\n  observer.observe(docNode);\n  onElementRemoved(docNode, () => {\n    newObj.callbacks = [];\n    observer.disconnect();\n    docs.delete(docNode);\n  });\n  changeCallback();\n  docs.set(docNode, newObj);\n  return newObj;\n}\n\nfunction removeObserver(doc: DocObj | undefined, callback: Function) {\n  if (!doc) {\n    return;\n  }\n  doc.callbacks = doc.callbacks.filter((c) => c !== callback);\n}\n\nexport function useDocSize(\n  nodeRef: React.RefObject<HTMLElement>,\n  callback: Callback,\n) {\n  React.useEffect(() => {\n    const doc = addObserver(nodeRef.current, callback);\n    return () => {\n      removeObserver(doc, callback);\n    };\n  }, [callback, nodeRef]);\n}\n"],"file":"useDocSize.js"}