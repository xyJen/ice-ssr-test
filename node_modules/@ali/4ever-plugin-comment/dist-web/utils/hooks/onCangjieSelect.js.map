{"version":3,"sources":["../../../../src/utils/hooks/onCangjieSelect.ts"],"names":["Selection","ViewMark","isSidebarVisible","getActiveId","showComment","cancelComment","configs","onCangjieSelect","event","controller","next","isDisabled","isSidebarOpen","readOnly","selection","detail","point","anchor","blurPopupOnClick","showInline","isCollapsed","isTextPoint","value","decorations","document","dec","find","d","isViewMark","mark","start","end","key","offset","range","create","focus","isNodeInRange","data","contentId","skipAutoFocus","autoBlur","undefined","run"],"mappings":"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","sourcesContent":["import { CangjieSelectEvent, Controller, Selection } from '@ali/4ever-cangjie';\nimport { CommentPluginConfigs } from '../types';\nimport { ViewMark } from '../models/marks';\nimport isSidebarVisible from '../queries/isSidebarVisible';\nimport getActiveId from '../queries/getActiveId';\nimport showComment from '../actions/showComment';\nimport { cancelComment } from '../actions';\n\nexport default (configs: CommentPluginConfigs | undefined) => {\n  return function onCangjieSelect(\n    event: CangjieSelectEvent,\n    controller: Controller,\n    next,\n  ) {\n    if (configs?.isDisabled && configs.isDisabled()) {\n      return next();\n    }\n    const isSidebarOpen = isSidebarVisible(controller);\n    if (!isSidebarOpen || controller.readOnly) {\n      return next();\n    }\n    const { selection } = event.detail;\n    const { anchor: point } = selection;\n    const { blurPopupOnClick, showInline } = configs || {};\n    if (selection.isCollapsed && point.isTextPoint()) {\n      const { decorations, document } = controller.value;\n      const dec = decorations.find((d) => {\n        if (ViewMark.isViewMark(d.mark)) {\n          const { start, end } = d;\n          if (start.key === point.key && end.key === point.key) {\n            // same text\n            if (start.offset === end.offset) {\n              // void\n              return true;\n            }\n            return point.offset > start.offset && point.offset <= end.offset;\n          } else if (start.key === point.key) {\n            return point.offset > start.offset;\n          } else if (end.key === point.key) {\n            return point.offset <= end.offset;\n          }\n          const range = Selection.create({ anchor: start, focus: end });\n          return document.isNodeInRange(point.key, range);\n        }\n        return false;\n      });\n      if (dec && !showInline) {\n        const mark = dec.mark as ViewMark;\n        const { readOnly } = controller;\n        showComment(controller, mark.data.contentId, { skipAutoFocus: !readOnly });\n      } else if (getActiveId(controller)) {\n        const autoBlur = !blurPopupOnClick || blurPopupOnClick() === true;\n        if (autoBlur) {\n          showComment(controller, undefined);\n        }\n        if (autoBlur && showInline) {\n          controller.run('onAction', cancelComment());\n        }\n      }\n    }\n    return next();\n  };\n};\n"],"file":"onCangjieSelect.js"}