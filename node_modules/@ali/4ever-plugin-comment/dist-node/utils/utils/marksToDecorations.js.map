{"version":3,"sources":["../../../../src/utils/utils/marksToDecorations.ts"],"names":["marksToDecorations","controller","comments","decorations","document","value","activeContentId","otherDecorations","filter","d","ViewMark","isViewMark","mark","texts","getTexts","newDecs","data","isNew","newcid","contentId","find","c","readOnlyDecs","isReadonly","concat","map","isActive","set","create","forEach","text","offset","leaves","leave","marks","m","DataMark","isDataMark","item","oldDec","dec","prevBlock","getClosestBlock","end","key","prevSucceedingBlock","getNextBlock","closestBlock","start","TextPoint","length","count","summary","newDec","Decoration","push","sort","a","b","pa","getPath","pb","Path","isBefore","isAfter"],"mappings":"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","sourcesContent":["import { Controller, TextPoint, Decoration, Path } from '@ali/4ever-cangjie';\nimport { DataMark, ViewMark } from '../models/marks';\nimport { getActiveId } from '../queries';\nimport getComments from '../queries/getComments';\n\n/**\n * DataMark -> ViewMark\n */\nexport function marksToDecorations(controller: Controller) {\n  const comments = getComments(controller);\n  const { decorations, document } = controller.value;\n  const activeContentId = getActiveId(controller);\n\n  // 先过滤掉所有的 ViewMark\n  const otherDecorations = decorations.filter(\n    (d) => !ViewMark.isViewMark(d.mark),\n  );\n  const texts = document.getTexts();\n  let newDecs = decorations.filter((d) => {\n    if (ViewMark.isViewMark(d.mark) && d.mark.data.isNew) {\n      const newcid = d.mark.data.contentId;\n      return !comments.find((c) => c.contentId === newcid);\n    }\n    return false;\n  });\n  const readOnlyDecs = decorations.filter(\n    (d) => ViewMark.isViewMark(d.mark) && d.mark.data.isReadonly,\n  );\n  newDecs = newDecs.concat(readOnlyDecs);\n  newDecs = newDecs.map((d) => {\n    const mark = d.mark as ViewMark;\n    const isActive = activeContentId === mark.data.contentId;\n    return d.set(\n      'mark',\n      ViewMark.create({\n        ...mark.data,\n        isActive,\n      }),\n    );\n  });\n\n  // 遍历每一个 mark，然后构建新的 View Decoration\n  texts.forEach((text) => {\n    let offset = 0;\n    text.leaves.forEach((leave) => {\n      leave.marks.forEach((m) => {\n        if (DataMark.isDataMark(m)) {\n          const { contentId } = m.data;\n          const item = comments.find((c) => c.contentId === contentId);\n          if (!item) {\n            return;\n          }\n          const oldDec = newDecs.find(\n            (dec) => dec.mark.data.contentId === contentId,\n          );\n          // 如果这个 text 和 oldDec 的跨越太多（超过一个 block），就忽略掉\n          if (oldDec) {\n            const prevBlock = document.getClosestBlock(oldDec.end.key);\n            const prevSucceedingBlock = document.getNextBlock(oldDec.end.key);\n            const closestBlock = document.getClosestBlock(text.key);\n            if (closestBlock !== prevBlock && closestBlock !== prevSucceedingBlock) {\n              return;\n            }\n          }\n          const start =\n            oldDec?.start ||\n            TextPoint.create({\n              key: text.key,\n              offset,\n            });\n          const end = TextPoint.create({\n            key: text.key,\n            offset: offset + leave.text.length,\n          });\n          const { count, summary } = item;\n          const newDec = Decoration.create({\n            start,\n            end,\n            mark:\n              oldDec?.mark ||\n              ViewMark.create({\n                contentId,\n                count,\n                summary,\n                isActive: contentId === activeContentId,\n              }),\n          });\n          if (oldDec) {\n            newDecs = newDecs.map((d) => {\n              return d !== oldDec ? d : newDec;\n            });\n          } else {\n            newDecs.push(newDec);\n          }\n        }\n      });\n      offset += leave.text.length;\n    });\n  });\n  newDecs = newDecs.sort((a, b) => {\n    const pa = document.getPath(a.start.key);\n    const pb = document.getPath(b.start.key);\n    if (!pa || !pb) {\n      return 0;\n    }\n    if (Path.isBefore(pa, pb)) {\n      return -1;\n    }\n    if (Path.isAfter(pa, pb)) {\n      return 1;\n    }\n    return a.start.offset < b.start.offset ? -1 : 1;\n  });\n  return [...otherDecorations, ...newDecs];\n}\n"],"file":"marksToDecorations.js"}