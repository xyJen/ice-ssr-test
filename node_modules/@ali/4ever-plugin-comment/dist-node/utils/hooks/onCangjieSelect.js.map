{"version":3,"sources":["../../../../src/utils/hooks/onCangjieSelect.ts"],"names":["configs","onCangjieSelect","event","controller","next","isDisabled","isSidebarOpen","readOnly","selection","detail","anchor","point","blurPopupOnClick","showInline","isCollapsed","isTextPoint","decorations","document","value","dec","find","d","ViewMark","isViewMark","mark","start","end","key","offset","range","Selection","create","focus","isNodeInRange","data","contentId","skipAutoFocus","autoBlur","undefined","run"],"mappings":"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","sourcesContent":["import { CangjieSelectEvent, Controller, Selection } from '@ali/4ever-cangjie';\nimport { CommentPluginConfigs } from '../types';\nimport { ViewMark } from '../models/marks';\nimport isSidebarVisible from '../queries/isSidebarVisible';\nimport getActiveId from '../queries/getActiveId';\nimport showComment from '../actions/showComment';\nimport { cancelComment } from '../actions';\n\nexport default (configs: CommentPluginConfigs | undefined) => {\n  return function onCangjieSelect(\n    event: CangjieSelectEvent,\n    controller: Controller,\n    next,\n  ) {\n    if (configs?.isDisabled && configs.isDisabled()) {\n      return next();\n    }\n    const isSidebarOpen = isSidebarVisible(controller);\n    if (!isSidebarOpen || controller.readOnly) {\n      return next();\n    }\n    const { selection } = event.detail;\n    const { anchor: point } = selection;\n    const { blurPopupOnClick, showInline } = configs || {};\n    if (selection.isCollapsed && point.isTextPoint()) {\n      const { decorations, document } = controller.value;\n      const dec = decorations.find((d) => {\n        if (ViewMark.isViewMark(d.mark)) {\n          const { start, end } = d;\n          if (start.key === point.key && end.key === point.key) {\n            // same text\n            if (start.offset === end.offset) {\n              // void\n              return true;\n            }\n            return point.offset > start.offset && point.offset <= end.offset;\n          } else if (start.key === point.key) {\n            return point.offset > start.offset;\n          } else if (end.key === point.key) {\n            return point.offset <= end.offset;\n          }\n          const range = Selection.create({ anchor: start, focus: end });\n          return document.isNodeInRange(point.key, range);\n        }\n        return false;\n      });\n      if (dec && !showInline) {\n        const mark = dec.mark as ViewMark;\n        const { readOnly } = controller;\n        showComment(controller, mark.data.contentId, { skipAutoFocus: !readOnly });\n      } else if (getActiveId(controller)) {\n        const autoBlur = !blurPopupOnClick || blurPopupOnClick() === true;\n        if (autoBlur) {\n          showComment(controller, undefined);\n        }\n        if (autoBlur && showInline) {\n          controller.run('onAction', cancelComment());\n        }\n      }\n    }\n    return next();\n  };\n};\n"],"file":"onCangjieSelect.js"}