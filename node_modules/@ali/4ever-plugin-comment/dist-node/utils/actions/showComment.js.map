{"version":3,"sources":["../../../../src/utils/actions/showComment.ts"],"names":["IS_MOBILE","IS_IPAD","environment","TOP_SPACE","BOTTOM_SPACE","findDOMNode","getScrollableContainerInfo","findScrollableContainer","domUtils","scrollToSelectionTop","options","contentId","key","content","controller","scroller","heightPercent","bottomAlign","topExtraOffset","scrollToNodeByKey","domNode","querySelector","createPerfLazyRenderPlugin","showPrunedElements","targetRect","getBoundingClientRect","height","closest","isWindow","scrollerTop","yOffset","viewportHeight","Math","max","window","innerHeight","alignY","bottom","top","targetOffsetTop","y","inView","topSpace","scrollTo","scrollX","scrollTop","updateComment","configs","oldId","run","skipAutoFocus","skipScroll","alwaysScroll","document","decorations","value","SCROLL_HEIGHT_PERCENT","scrollTopExtraOffset","decoration","find","d","ViewMark","isViewMark","mark","data","start","scrollableContainer","scrollByBottomAlign","error","cachedMap","config","doUpdate","clearTimeout","timer","setTimeout"],"mappings":"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","sourcesContent":["import {\n  Controller,\n  domUtils,\n  environment,\n  constants,\n  createPerfLazyRenderPlugin,\n} from '@ali/4ever-cangjie';\nimport { getActiveId } from '../queries';\nimport { CommentPluginConfigs, ShowCommentOptions } from '../types';\nimport { setActiveId } from '../actions';\nimport { SCROLL_HEIGHT_PERCENT } from '../constants';\nimport { findDOMNodeByVoidKey } from '../utils/findDOMNodeByVoidKey';\nimport { ViewMark } from '../models';\n\nconst { IS_MOBILE, IS_IPAD } = environment;\n\nconst TOP_SPACE = IS_MOBILE && !IS_IPAD ? 20 : 100;\nconst BOTTOM_SPACE = 100;\n\nconst {\n  findDOMNode,\n  getScrollableContainerInfo,\n  findScrollableContainer,\n} = domUtils;\n\ntype ScrollOptions = {\n  contentId: string;\n  controller: Controller;\n  key?: string;\n  content: HTMLElement;\n  scroller: HTMLElement;\n  heightPercent: number;\n  topExtraOffset: number;\n  bottomAlign?: boolean;\n};\n\nasync function scrollToSelectionTop(options: ScrollOptions) {\n  const { contentId, key, content, controller, scroller, heightPercent, bottomAlign, topExtraOffset } = options;\n  if (key) {\n    await domUtils.scrollToNodeByKey(key, controller, true);\n  }\n  const domNode =\n    findDOMNodeByVoidKey(contentId, content) ||\n    content.querySelector(`[data-comment=\"${contentId}\"]`);\n  if (!domNode) {\n    return;\n  }\n  createPerfLazyRenderPlugin.showPrunedElements(domNode);\n  let targetRect: DOMRect | undefined = domNode.getBoundingClientRect();\n  if (targetRect && targetRect.height < 1) {\n    targetRect = domNode.closest('[data-foldable]')?.getBoundingClientRect();\n  }\n  if (!targetRect) {\n    return;\n  }\n\n  const { isWindow, scrollerTop, yOffset } = getScrollableContainerInfo(\n    scroller,\n  );\n\n  const viewportHeight = IS_MOBILE && !IS_IPAD\n    ? BOTTOM_SPACE\n    : Math.max(window.innerHeight * heightPercent, BOTTOM_SPACE);\n\n  const alignY = bottomAlign ? targetRect.bottom : targetRect.top;\n  // isInview: yOffset < targetOffsetTop < yOffset + viewportHeight\n  // move: targetOffsetTop <= finalY <= targetOffsetTop + viewportHeight\n  const targetOffsetTop = alignY + yOffset - scrollerTop;\n\n  let y = yOffset;\n  let inView = true;\n  const topSpace = TOP_SPACE + topExtraOffset;\n\n  if (targetOffsetTop < yOffset + topSpace) {\n    // selection above viewport\n    y = targetOffsetTop - topSpace;\n    inView = false;\n  } else if (targetOffsetTop > yOffset + viewportHeight) {\n    // selection below viewport\n    y = targetOffsetTop - viewportHeight;\n    inView = false;\n  }\n  if (inView) {\n    return;\n  }\n\n  if (isWindow) {\n    window.scrollTo(window.scrollX, y);\n  } else {\n    // eslint-disable-next-line no-param-reassign\n    scroller.scrollTop = y;\n  }\n}\n\nasync function updateComment(\n  controller: Controller,\n  contentId?: string,\n  options?: ShowCommentOptions,\n  configs?: CommentPluginConfigs,\n) {\n  const oldId = getActiveId(controller);\n  if (oldId !== contentId) {\n    controller.run('onAction', setActiveId(contentId, !options?.skipAutoFocus));\n  }\n  const skipScroll = oldId === contentId && !options?.alwaysScroll;\n  if (options?.skipScroll || !contentId || skipScroll) {\n    return;\n  }\n  try {\n    const { document, decorations } = controller.value;\n    // eslint-disable-next-line react/no-find-dom-node\n    const content = findDOMNode(document.key);\n    if (!content) {\n      return;\n    }\n    const { heightPercent = SCROLL_HEIGHT_PERCENT } = options || {};\n    const topExtraOffset = configs?.scrollTopExtraOffset || 0;\n    const decoration = decorations.find(\n      (d) =>\n        ViewMark.isViewMark(d.mark) &&\n        d.mark.data.contentId === contentId,\n    );\n    const key = decoration?.start?.key;\n    scrollToSelectionTop({\n      contentId,\n      key,\n      controller,\n      content: content as HTMLElement,\n      scroller: controller.scrollableContainer as HTMLElement,\n      heightPercent,\n      topExtraOffset,\n      bottomAlign:\n        configs?.scrollByBottomAlign && configs.scrollByBottomAlign(),\n    });\n  } catch (error) {\n    // ignore\n  }\n}\n\nconst cachedMap: any = {};\n\n//  避免频繁设置，导致的闪烁问题\nexport default (\n  controller: Controller,\n  contentId?: string,\n  options?: ShowCommentOptions,\n  config?: CommentPluginConfigs,\n) => {\n  const doUpdate = () => updateComment(controller, contentId, options, config);\n  const oldId = getActiveId(controller);\n\n  if (oldId && cachedMap[oldId]) {\n    window.clearTimeout(cachedMap[oldId]);\n  }\n  if (contentId && cachedMap[contentId]) {\n    window.clearTimeout(cachedMap[contentId]);\n  }\n  // 如果有一个是 undefined\n  const key = contentId || oldId;\n  if (key && (!oldId || !contentId)) {\n    // timeout 出于性能考虑，模拟 debounce 效果；这里后续是数据改动，无需清除\n    const timer = window.setTimeout(doUpdate, 100);\n    cachedMap[key] = timer;\n  } else {\n    doUpdate();\n  }\n};\n"],"file":"showComment.js"}