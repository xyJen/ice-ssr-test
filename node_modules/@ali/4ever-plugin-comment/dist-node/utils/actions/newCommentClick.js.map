{"version":3,"sources":["../../../../src/utils/actions/newCommentClick.ts"],"names":["newCommentClick","controller","defaultSummary","document","decorations","value","selection","hash","Math","random","hash2","Date","getTime","contentId","start","spoint","end","epoint","sort","startCell","endCell","map","key","getClosest","node","isElement","type","moveStartToStartOfNode","moveEndToEndOfNode","getNode","anchor","isCollapsed","moveToRangeOfNode","finalSelection","shouldExtendSelection","parent","getParent","isParentVoid","query","parentBlock","getClosestBlock","moveAnchorToStartOfNode","moveFocusToEndOfNode","convertToTextPoints","result","summary","position","mark","ViewMark","create","isNew","count","dec","Decoration","run","setDecorations","filter","d","isViewMark","data","command","Commands","moveToFocus"],"mappings":"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","sourcesContent":["import { Commands, Controller, Decoration } from '@ali/4ever-cangjie';\nimport { setActiveId } from '../actions';\nimport { ViewMark } from '../models/marks';\nimport hashCode from '../utils/hashCode';\nimport { serialize } from '../utils/readonlySerializer';\n\nexport default function newCommentClick(\n  controller: Controller,\n  defaultSummary?: string,\n) {\n  const { document, decorations } = controller.value;\n  let { selection } = controller.value;\n  const hash = hashCode(`${Math.random()}`);\n  const hash2 = hashCode(`${new Date().getTime()}`);\n  const contentId = `${hash}${hash2}`;\n\n  /**\n   * 场景优化 - 表格（单元格）\n   */\n  const { start: spoint, end: epoint } = selection.sort(document);\n  const [startCell, endCell] = [spoint, epoint].map(({ key }) =>\n    document.getClosest(\n      key,\n      (node) => node.isElement() && node.type === 'table-cell',\n    ),\n  );\n  if (startCell && endCell && startCell !== endCell) {\n    selection = selection\n      .moveStartToStartOfNode(startCell, controller)\n      .moveEndToEndOfNode(endCell, controller);\n  }\n\n  /**\n   * 场景优化 - 代码块\n   */\n\n  const node = document.getNode(selection.anchor.key);\n  if (selection.isCollapsed && node?.isElement() && node.type === 'code') {\n    selection = selection.moveToRangeOfNode(node, controller);\n  }\n\n  /**\n   * 用户体验优化：如果是光标状态，尝试选中最近的一个 block 进行评论\n   */\n  let finalSelection = selection;\n  let shouldExtendSelection = false;\n  // 只有 collapse 状态，并且不在 void 元素内，才会触发此优化\n  if (selection.isCollapsed) {\n    const parent = document.getParent(selection.anchor.key);\n    const isParentVoid = parent && controller.query('isVoid', parent);\n    shouldExtendSelection = !isParentVoid;\n  }\n  if (shouldExtendSelection) {\n    const parentBlock = document.getClosestBlock(selection.anchor.key);\n    finalSelection = parentBlock\n      ? selection\n          .moveAnchorToStartOfNode(parentBlock, controller)\n          .moveFocusToEndOfNode(parentBlock, controller)\n      : selection;\n  }\n  const { start, end } = finalSelection.convertToTextPoints(document);\n  const result = serialize(start, end, document);\n  const summary = result?.summary || defaultSummary || '';\n  const position = result?.position;\n  const mark = ViewMark.create({\n    contentId,\n    isNew: true,\n    count: 0,\n    summary,\n    position,\n  });\n  const dec = Decoration.create({ start, end, mark });\n  controller.run('onAction', setActiveId(contentId, true));\n  controller\n    .setDecorations([\n      ...decorations.filter(\n        (d) => !(ViewMark.isViewMark(d.mark) && d.mark.data.isNew),\n      ),\n      dec,\n    ])\n    .command(Commands.moveToFocus);\n}\n"],"file":"newCommentClick.js"}