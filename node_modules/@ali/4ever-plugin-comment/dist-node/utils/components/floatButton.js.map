{"version":3,"sources":["../../../../src/utils/components/floatButton.tsx"],"names":["IS_MOBILE","environment","FloatWrapper","styled","div","SIZE_MOBILE","PCFloatWrapper","Icon","img","SIZE","props","showShadow","AddCommentIcon","ToolbarAddCommentNormal","IconWrapper","AddIconWrapper","CommentIconWrapper","IconNumber","PCFloatButton","React","forwardRef","top","onClick","children","tips","isNew","testId","wrapperProps","ref","undefined","style","attrs","blockEvent","tipStyle","MobileFloatButton","CommentAddButton","memo","controller","range","onHover","handleClick","useCallback","event","run","selection","type","ACTION_COMMENT_CLICK","useRef","useEffect","node","current","timer","requestAnimationFrame","opacity","cancelAnimationFrame","handleMouseEnter","handleMouseLeave","useMemo","onMouseEnter","onMouseLeave","CommentBubble","isMultiple","count","contentId","showInline","onBubbleClick","countStr","setTimeout","transform","src","RealFloatButton"],"mappings":"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","sourcesContent":["/* eslint-disable react/no-unused-prop-types */\nimport React from 'react';\nimport styled from 'styled-components';\nimport { Tooltip } from '@ali/we-design';\nimport { ToolbarAddCommentNormal } from '@ali/we-icon';\nimport {\n  Controller,\n  environment,\n  Selection,\n  CangjieSelectEvent,\n} from '@ali/4ever-cangjie';\nimport {\n  ACTION_COMMENT_CLICK,\n  setActiveId,\n  setSidebarVisible,\n  showComment,\n} from '../actions';\nimport blockEvent from '../utils/blockEvent';\nimport {\n  BUTTON_SIZE as SIZE,\n  BUTTON_SIZE_MOBILE as SIZE_MOBILE,\n} from '../utils/constants';\nimport { tipStyle } from '../common';\n\nconst { IS_MOBILE } = environment;\n\ninterface FloatButtonProps {\n  top: number;\n  controller: Controller;\n  showInline?: boolean;\n  testId?: string;\n  onClick?: (event: React.MouseEvent | React.TouchEvent) => void;\n  tips?: string;\n  children?: any;\n  isNew?: boolean;\n  wrapperProps?: any;\n}\n\ntype AddBubbleProps = FloatButtonProps & {\n  range?: Selection;\n  onHover?: (hover: boolean) => void;\n};\n\ntype CommentBubbleProps = FloatButtonProps & {\n  count: number;\n  contentId: string;\n  isMultiple?: boolean;\n  onBubbleClick?: (contentId: string) => void;\n};\n\nconst FloatWrapper = styled.div`\n  position: absolute;\n  top: 0;\n  right: 0;\n  cursor: pointer;\n  float: right;\n  width: ${SIZE_MOBILE}px;\n  height: ${SIZE_MOBILE}px;\n  display: flex;\n  flex-direction: row;\n  justify-content: center;\n  align-items: center;\n  box-sizing: content-box;\n  [data-comment-sidebar] &[data-comment-bubble] {\n    display: none;\n  }\n  [data-node-selecting] &[data-comment-bubble] {\n    display: none;\n  }\n`;\n\nconst PCFloatWrapper = styled(FloatWrapper)`\n  &:hover {\n    background: rgba(126, 134, 142, 0.12);\n    border-radius: 4px;\n  }\n`;\n\nconst Icon = styled.img<{ showShadow?: boolean }>`\n  width: ${IS_MOBILE ? SIZE : 20}px;\n  ${(props) =>\n    (props.showShadow\n      ? 'filter: drop-shadow(0px 2px 3px rgba(0, 137, 255, 0.4));'\n      : '')}\n`;\n\nconst AddCommentIcon = styled(ToolbarAddCommentNormal)`\n  font-size: ${IS_MOBILE ? SIZE : 20}px;\n`;\n\nconst IconWrapper = styled.div`\n  position: relative;\n  display: flex;\n  flex-direction: row;\n  justify-content: center;\n  align-items: center;\n`;\n\nconst AddIconWrapper = styled(IconWrapper)`\n  opacity: 0;\n  transition: opacity 0.25s;\n`;\n\nconst CommentIconWrapper = styled(IconWrapper)`\n  transform: scale(0.75);\n  opacity: 0.5;\n  transition: opacity 0.25s, transform 0.25s;\n`;\n\nconst IconNumber = styled.div`\n  position: absolute;\n  width: ${SIZE}px;\n  height: ${SIZE}px;\n  line-height: ${SIZE}px;\n  padding-left: 0.5px;\n  transform: scale(0.9);\n  color: white;\n  text-align: center;\n  vertical-align: middle;\n  font-size: 8px;\n`;\n\n/**\n * 右侧悬浮 Icon\n */\nconst PCFloatButton = React.forwardRef(\n  (\n    {\n      top,\n      onClick,\n      children,\n      tips,\n      isNew,\n      testId,\n      wrapperProps,\n    }: FloatButtonProps,\n    ref: any,\n  ) => {\n    if (top === undefined) {\n      return null;\n    }\n    const style: React.CSSProperties = { top: `${top - SIZE / 2}px` };\n    const attrs = isNew ? {} : { 'data-comment-bubble': '' };\n    return (\n      <PCFloatWrapper\n        {...attrs}\n        {...wrapperProps}\n        data-comment-noblur\n        ref={ref}\n        style={style}\n        data-testid={testId}\n        onMouseDown={onClick}\n        onClick={blockEvent}\n      >\n        <Tooltip overlayStyle={tipStyle} title={tips} placement=\"bottom\">\n          {children}\n        </Tooltip>\n      </PCFloatWrapper>\n    );\n  },\n);\n\n/**\n * 右侧悬浮 Icon\n */\nfunction MobileFloatButton({ top, onClick, children }: FloatButtonProps) {\n  if (top === undefined) {\n    return null;\n  }\n  const style: React.CSSProperties = { top: `${top - SIZE / 2}px` };\n  return (\n    <FloatWrapper\n      style={style}\n      data-comment-bubble\n      onMouseDown={blockEvent}\n      onClick={blockEvent}\n      onTouchStart={onClick}\n    >\n      {children}\n    </FloatWrapper>\n  );\n}\n\n/**\n * 右侧悬浮 Icon - 添加评论\n */\nexport const CommentAddButton = React.memo((props: AddBubbleProps) => {\n  const { controller, range, onHover } = props;\n  const handleClick = React.useCallback(\n    (event: React.MouseEvent | React.TouchEvent) => {\n      blockEvent(event);\n      if (onHover && range) {\n        controller?.run(\n          'onCangjieSelect',\n          CangjieSelectEvent({\n            selection: range,\n          }),\n        );\n      }\n      controller?.run('onAction', {\n        type: ACTION_COMMENT_CLICK,\n      });\n    },\n    [controller, onHover, range],\n  );\n  const ref = React.useRef<HTMLDivElement>(null);\n  React.useEffect(() => {\n    const node = ref.current;\n    if (!node) {\n      return undefined;\n    }\n    const timer = requestAnimationFrame(() => {\n      node.style.opacity = onHover ? '0.4' : '1';\n    });\n    return () => {\n      cancelAnimationFrame(timer);\n    };\n  }, [onHover]);\n  React.useEffect(() => {\n    return () => {\n      onHover && onHover(false);\n    };\n  }, [onHover]);\n  const handleMouseEnter = React.useCallback(() => {\n    const node = ref.current;\n    if (!node || !onHover) {\n      return;\n    }\n    onHover(true);\n    node.style.opacity = '1';\n  }, [onHover]);\n  const handleMouseLeave = React.useCallback(() => {\n    const node = ref.current;\n    if (!node || !onHover) {\n      return;\n    }\n    onHover(false);\n    node.style.opacity = '0.4';\n  }, [onHover]);\n  const wrapperProps = React.useMemo(\n    () => ({\n      onMouseEnter: handleMouseEnter,\n      onMouseLeave: handleMouseLeave,\n    }),\n    [handleMouseEnter, handleMouseLeave],\n  );\n  return (\n    <PCFloatButton\n      {...props}\n      wrapperProps={wrapperProps}\n      isNew\n      testId=\"comment-add\"\n      onClick={handleClick}\n      tips={props.tips || 'add comment'}\n    >\n      <AddIconWrapper ref={ref}>\n        <AddCommentIcon />\n      </AddIconWrapper>\n    </PCFloatButton>\n  );\n});\n\n/**\n * 右侧悬浮 Icon - 已有评论\n */\nexport const CommentBubble = React.memo((props: CommentBubbleProps) => {\n  const { top, isMultiple, tips, count, contentId, controller, showInline, onBubbleClick } = props;\n  const countStr = `${count || ''}`;\n  const handleClick = (event: React.MouseEvent | React.TouchEvent) => {\n    blockEvent(event);\n    if (IS_MOBILE) {\n      /**\n       * 移动端容易触发 cangjie touch 事件 bug，导致无法 blur\n       * 这里先 hotfix 一下，后续等 cangjie touch 事件改造后，可以移除这里的 timeout\n       */\n      setTimeout(() => {\n        controller.run('onCangjieBlur');\n        controller.run('onAction', showComment(contentId));\n      }, 300);\n    } else if (showInline) {\n      controller.run('onCangjieBlur');\n      controller.run('onAction', showComment(contentId));\n    } else {\n      controller.run('onCangjieBlur');\n      controller.run('onAction', setActiveId(contentId));\n      controller.run('onAction', setSidebarVisible(true));\n    }\n    onBubbleClick && onBubbleClick(contentId);\n  };\n  const ref = React.useRef<HTMLDivElement>(null);\n  React.useEffect(() => {\n    const node = ref.current;\n    if (!node) {\n      return undefined;\n    }\n    const timer = requestAnimationFrame(() => {\n      node.style.opacity = '1';\n      node.style.transform = 'scale(1)';\n    });\n    return () => {\n      cancelAnimationFrame(timer);\n    };\n  }, [countStr]);\n  if (!countStr) {\n    return null;\n  }\n  const src = isMultiple\n    ? 'https://img.alicdn.com/imgextra/i3/O1CN01WGVJgh1DS3R5moD3Q_!!6000000000214-55-tps-20-20.svg'\n    : 'https://img.alicdn.com/imgextra/i3/O1CN01bFO13z1bcAy5NpEpj_!!6000000003485-55-tps-20-20.svg';\n  const RealFloatButton = IS_MOBILE ? MobileFloatButton : PCFloatButton;\n  return (\n    <RealFloatButton\n      controller={controller}\n      onClick={handleClick}\n      testId=\"comment-show\"\n      top={top}\n      tips={tips || 'Show Comment'}\n    >\n      <CommentIconWrapper ref={ref}>\n        <Icon showShadow src={src} />\n        {!isMultiple && <IconNumber>{countStr}</IconNumber>}\n      </CommentIconWrapper>\n    </RealFloatButton>\n  );\n});\n"],"file":"floatButton.js"}