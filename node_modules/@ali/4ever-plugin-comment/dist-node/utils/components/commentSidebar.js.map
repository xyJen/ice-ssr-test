{"version":3,"sources":["../../../../src/utils/components/commentSidebar.tsx"],"names":["ATTR_SIDEBAR","EFFECT_DEBOUNCE_TIME","IS_IPAD","environment","RootWrapper","styled","div","WIDTH","TopBarWrapper","TopBarInner","TopBarLine","CloseIconWrapper","SKIP_BLUR_PROPS","SKIP_BLUR_SELECOTR","skipBlur","target","some","s","hasAttribute","closest","adjustHeight","rawCards","activeContentId","focusedIndex","findIndex","card","contentId","cards","slice","updateHeight","prev","next","top","height","SPACE","i","undefined","length","usePrevious","value","ref","React","useRef","useEffect","current","CommentSideBar","props","configs","onAdd","onDelete","enableAutoBlur","controller","container","document","decorations","hideSidebarTab","sidebarRef","setCards","useState","popHeights","useMemo","zoom","updatePosition","useCallback","commentDecorations","filter","d","ViewMark","isViewMark","mark","rowItems","selection","isFromPopup","autoFocus","barTop","getBoundingClientRect","docTop","domUtils","findDOMNode","key","verticalOffset","newCards","reduce","array","item","forEach","decoration","isNew","summary","position","count","data","isActive","defaultHeight","find","vc","Math","round","Boolean","prio","isAutoFocus","push","activeIndex","c","abs","prevDocument","timer","setTimeout","clearTimeout","useLayoutEffect","showTimer","run","alwaysScroll","window","body","setAttribute","removeAttribute","clicker","event","Element","addEventListener","capture","removeEventListener","hideActive","handleCloseClick","handleCancelClick","handleKeydown","nativeEvent","isComposing","preventDefault","query","getSiblings","heightPercent","SCROLL_HEIGHT_PERCENT_SIDEBAR","backgroundColor","sidebarBackgroundColor","topBarStyle","background","t","titleStr","locale","inlineComment","fontSize","map"],"mappings":"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","sourcesContent":["import React from 'react';\nimport styled from 'styled-components';\nimport { Controller, useZoomContainer, domUtils, useZoom, environment } from '@ali/4ever-cangjie';\nimport { CloseBigNormal } from '@ali/we-icon';\nimport { ViewMark } from '../models/marks';\nimport PopupView from '../components/popupView';\nimport { findCommentPostion } from '../utils/findCommentPostion';\nimport getActiveId from '../queries/getActiveId';\nimport {\n  hideComment,\n  cancelComment,\n  setSidebarVisible,\n  showComment,\n} from '../actions';\nimport {\n  SIDEBAR_WIDTH as WIDTH,\n  CARD_SPACE as SPACE,\n} from '../utils/constants';\nimport { CommentPluginConfigs } from '../types';\nimport { tipStyle } from '../common';\nimport isAutoFocus from '../queries/isAutoFocus';\nimport getSiblings from '../queries/getSiblings';\nimport useAutoBlur from '../hooks/useAutoBlur';\nimport { useDocSize } from '../hooks/useDocSize';\nimport { SCROLL_HEIGHT_PERCENT_SIDEBAR } from '../constants';\n\nconst ATTR_SIDEBAR = 'data-comment-sidebar';\nconst EFFECT_DEBOUNCE_TIME = 300;\nconst { IS_IPAD } = environment;\n\nconst RootWrapper = styled.div`\n  position: absolute;\n  right: ${IS_IPAD ? 0 : -WIDTH}px;\n  top: -6px;\n  z-index: 1;\n  height: 100%;\n  width: ${WIDTH}px;\n  &:focus {\n    outline: none;\n  }\n  ${IS_IPAD ? `\n    background: white;\n    @media (max-width: 700px) {\n      box-shadow: 0px 0px 1px rgba(0, 0, 0, 0.24), 0px 8px 24px rgba(0, 0, 0, 0.16);\n    }\n    @media (min-width: 700px) {\n      border-left: 1px solid rgba(126, 134, 142, 0.16);\n    }\n  ` : ''}\n`;\n\n// iPad 下有 h5 top bar，这里加上 64px 的偏移\nconst TopBarWrapper = styled.div`\n  z-index: 1;\n  position: fixed;\n  top: ${IS_IPAD ? '64px' : 0 };\n  right: 0;\n  width: ${WIDTH}px;\n  font-size: 16px;\n  color: #111F2C;\n  font-weight: 500;\n`;\n\nconst TopBarInner = styled.div`\n  margin-left: 16px;\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n`;\n\nconst TopBarLine = styled.div`\n  margin: 0 16px;\n  border-bottom: 1px solid rgba(126, 134, 142, 0.16);\n`;\n\nconst CloseIconWrapper = styled.div`\n  font-size: 0;\n  font-weight: normal;\n  width: 52px;\n  height: 52px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  color: rgba(23, 26, 29, 0.6);\n  cursor: pointer;\n`;\n\ntype CardInfo = {\n  top: number;\n  prio: number;\n  isNew: boolean;\n  count: number;\n  isActive: boolean;\n  isAutoFocus: boolean;\n  contentId: string;\n  summary: string;\n  height: number;\n  position?: string;\n};\n\nconst SKIP_BLUR_PROPS = [\n  'data-comment-popup',\n  'data-panel-emoji',\n  'data-comment-noblur',\n  'data-comment-no-capture',\n];\nconst SKIP_BLUR_SELECOTR = [\n  '.mention-suggestion-list',\n  '.ant-popconfirm',\n  '.popup-overlay-wrap',\n];\n\nfunction skipBlur(target: Element) {\n  return SKIP_BLUR_PROPS.some(\n    (s) => target.hasAttribute(s) || target.closest(`[${s}]`),\n  );\n}\n\nfunction adjustHeight(rawCards: CardInfo[], activeContentId?: string) {\n  const focusedIndex = rawCards.findIndex(\n    (card) => card.contentId === activeContentId,\n  );\n  const cards: CardInfo[] = rawCards.slice(0);\n  function updateHeight(card: CardInfo, prev?: CardInfo, next?: CardInfo) {\n    if (prev && prev.top + prev.height + SPACE > card.top) {\n      return {\n        ...card,\n        top: prev.top + prev.height + SPACE,\n      };\n    }\n    if (next && card.top + card.height + SPACE > next.top) {\n      return {\n        ...card,\n        top: next.top - SPACE - card.height,\n      };\n    }\n    return card;\n  }\n  for (let i = 1; i < focusedIndex; i++) {\n    const card = updateHeight(cards[i], cards[i - 1], undefined);\n    cards[i] = card;\n  }\n  // eslint-disable-next-line for-direction\n  for (let i = focusedIndex - 1; i >= 0; i--) {\n    const card = updateHeight(cards[i], undefined, cards[i + 1]);\n    cards[i] = card;\n  }\n  for (let i = focusedIndex + 1; i < cards.length; i++) {\n    const card = updateHeight(cards[i], cards[i - 1], undefined);\n    cards[i] = card;\n  }\n  return cards;\n}\n\ntype CommentSideBarProps = {\n  configs?: CommentPluginConfigs;\n  controller: Controller;\n  enableAutoBlur?: boolean;\n  onAdd: () => void;\n  onDelete: () => void;\n};\n\nfunction usePrevious<T>(value: T): T | undefined {\n  const ref = React.useRef<T>();\n  React.useEffect(() => {\n    ref.current = value;\n  });\n  return ref.current;\n}\n\nexport default function CommentSideBar(props: CommentSideBarProps) {\n  const { configs, onAdd, onDelete, enableAutoBlur, controller } = props;\n  const container = useZoomContainer();\n  const ref = React.useRef<HTMLDivElement>(null);\n  const { document, decorations } = controller.value;\n  const { hideSidebarTab, sidebarRef } = configs || {};\n\n  const [cards, setCards] = React.useState<CardInfo[]>([]);\n  const popHeights: Record<string, number> = React.useMemo(() => ({}), []);\n  const zoom = useZoom();\n\n  /**\n   * 在渲染出 DOM 后，遍历 DOM 位置，获取对应的 offset\n   */\n  const updatePosition = React.useCallback(() => {\n    const commentDecorations = decorations.filter((d) => {\n      return ViewMark.isViewMark(d.mark);\n    });\n    const rowItems = findCommentPostion({\n      controller,\n      decorations: commentDecorations,\n      selection: undefined,\n      container: container || undefined,\n      isFromPopup: true,\n    });\n    const activeContentId = getActiveId(controller);\n    const autoFocus = isAutoFocus(controller);\n    const { top: barTop } = ref.current?.getBoundingClientRect() || {};\n    // eslint-disable-next-line react/no-find-dom-node\n    const { top: docTop } = domUtils\n      .findDOMNode(document.key)\n      .getBoundingClientRect();\n    const verticalOffset = barTop ? barTop - docTop : 0;\n\n    // 生成 card 基本信息（这里可能有覆盖的场景）\n    let newCards = rowItems.reduce<CardInfo[]>((array, item) => {\n      item.decorations.forEach((decoration) => {\n        const { top } = item;\n        const mark = decoration.mark as ViewMark;\n        const { isNew, contentId, summary, position, count } = mark.data;\n        const isActive = contentId === activeContentId;\n        const defaultHeight = isNew ? 121 : 180;\n\n        const height =\n          popHeights[contentId] ||\n          cards?.find((vc) => vc.contentId === contentId)?.height ||\n          defaultHeight;\n        const card: CardInfo = {\n          top: Math.round(top - verticalOffset),\n          isNew: Boolean(isNew),\n          prio: 0,\n          isAutoFocus: Boolean(autoFocus && isActive),\n          isActive,\n          height: height * zoom,\n          count,\n          summary,\n          position,\n          contentId,\n        };\n        array.push(card);\n      });\n      return array;\n    }, []);\n    newCards = adjustHeight(newCards, activeContentId);\n    const activeIndex = newCards.findIndex(\n      (c) => c.contentId === activeContentId,\n    );\n    newCards.forEach((c, i) => {\n      c.prio = Math.abs(i - activeIndex);\n    });\n    setCards(newCards);\n  }, [decorations, controller, document, container, zoom]);\n\n  const prevDocument = usePrevious(document);\n  React.useEffect(() => {\n    /**\n     * 非 document 变化，比如 decorations 变了，立刻刷新\n     */\n    if (prevDocument === document) {\n      updatePosition();\n      return undefined;\n    }\n    /**\n     * document 变化，延迟刷新\n     *\n     * 一些场景比如（折叠标题），有动画延迟，等一会儿再更新，不然会闪烁\n     * 首次打开也要延迟刷新，因为侧边栏展开可能导致图片等元素缩放, 高度发生变化\n     */\n    const timer = setTimeout(() => {\n      updatePosition();\n    }, EFFECT_DEBOUNCE_TIME);\n    return () => {\n      clearTimeout(timer);\n    };\n  }, [updatePosition]);\n\n  useAutoBlur(controller, enableAutoBlur);\n  useDocSize(ref, updatePosition);\n  React.useLayoutEffect(() => {\n    sidebarRef && sidebarRef(ref);\n    return () => {\n      sidebarRef && sidebarRef(undefined);\n    };\n  }, [sidebarRef, ref]);\n\n  React.useEffect(() => {\n    const activeContentId = getActiveId(controller);\n    if (!activeContentId) {\n      return undefined;\n    }\n    // timeout 出于体验考虑，下一个 tick 再更新，避免频繁闪烁\n    const showTimer = setTimeout(() => {\n      controller.run(\n        'onAction',\n        showComment(activeContentId, { alwaysScroll: true }),\n      );\n    }, 0);\n    return () => {\n      clearTimeout(showTimer);\n    };\n  }, [controller]);\n\n  React.useEffect(() => {\n    window.document.body.setAttribute(ATTR_SIDEBAR, '');\n    return () => {\n      window.document.body.removeAttribute(ATTR_SIDEBAR);\n    };\n  }, []);\n\n  React.useEffect(() => {\n    const clicker = (event: MouseEvent) => {\n      const { target } = event;\n      if (\n        target instanceof Element &&\n        !skipBlur(target) &&\n        !SKIP_BLUR_SELECOTR.some((s) => target.closest(s))\n      ) {\n        controller.run('onAction', showComment(undefined));\n      }\n    };\n    window.document.addEventListener('mousedown', clicker, { capture: true });\n    return () => {\n      window.document.removeEventListener('mousedown', clicker, {\n        capture: true,\n      });\n    };\n  }, [controller]);\n\n  const hideActive = React.useCallback(() => {\n    controller.run('onAction', hideComment());\n    controller.run('onAction', cancelComment());\n  }, [controller]);\n\n  const handleCloseClick = React.useCallback(() => {\n    controller.run('onAction', setSidebarVisible(false));\n    hideActive();\n  }, [controller, hideActive]);\n\n  const handleCancelClick = React.useCallback(() => {\n    controller.run('onAction', cancelComment());\n  }, [controller]);\n\n  const handleKeydown = React.useCallback(\n    (event: any) => {\n      if (event.nativeEvent.isComposing) return;\n      if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {\n        event.preventDefault();\n        const { next, prev } = controller.query(getSiblings);\n        const target = event.key === 'ArrowDown' ? next : prev;\n        if (target) {\n          const heightPercent = SCROLL_HEIGHT_PERCENT_SIDEBAR;\n          controller.run('onAction', showComment(target, { heightPercent }));\n        }\n      }\n    },\n    [controller],\n  );\n\n  const backgroundColor =\n    configs?.sidebarBackgroundColor && configs.sidebarBackgroundColor();\n  const topBarStyle: React.CSSProperties = {};\n  if (backgroundColor) {\n    topBarStyle.background = backgroundColor;\n  }\n  const count = cards.reduce((t, c) => t + c.count, 0);\n  const titleStr = `${configs?.locale?.inlineComment || 'Comment'} (${count})`;\n  return (\n    <RootWrapper\n      data-inline-comment-sidebar\n      tabIndex={0}\n      ref={ref}\n      data-cache-ignore\n      onKeyDown={handleKeydown}\n    >\n      {!hideSidebarTab && (\n        <TopBarWrapper style={topBarStyle}>\n          <TopBarInner>\n            <div>{titleStr}</div>\n            <CloseIconWrapper onClick={handleCloseClick}>\n              <CloseBigNormal style={{ fontSize: '20px' }} />\n            </CloseIconWrapper>\n          </TopBarInner>\n          <TopBarLine />\n        </TopBarWrapper>\n      )}\n      {cards.map((card) => {\n        return (\n          <PopupView\n            {...card}\n            controller={controller}\n            onAdd={onAdd}\n            popHeights={popHeights}\n            onCancel={handleCancelClick}\n            onDelete={onDelete}\n            key={card.contentId}\n            configs={configs}\n            updatePosition={updatePosition}\n          />\n        );\n      })}\n    </RootWrapper>\n  );\n}\n"],"file":"commentSidebar.js"}