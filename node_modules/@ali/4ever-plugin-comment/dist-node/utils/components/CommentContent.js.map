{"version":3,"sources":["../../../../src/utils/components/CommentContent.tsx"],"names":["IS_MOBILE","IS_IPAD","environment","IS_PHONE","DEBOUNCE_LOAD_TIME","INIT_SCROLL_DELAY","initNavigate","navigateToComment","controller","onCommentInvalid","subId","options","subObjectId","validInPage","value","decorations","some","d","ViewMark","isViewMark","mark","data","contentId","_","ignoreCheck","run","CommentContent","props","configs","showInline","Boolean","document","isInited","React","useRef","isCommentLoaded","showBottomBar","isDisabled","fetchCachedComment","reloadComments","isDocLoaded","enableAutoBlur","contentIds","onContentMounted","onContentUnMounted","onSidebarInfoUpdated","disableBottomBar","withCustomApiAdaptor","isLoaded","showSideBar","loadKey","readOnly","current","useEffect","setTimeout","setDecorations","filter","sideBarStatus","onDisabled","setData","loadCachedComment","useCallback","result","Array","isArray","error","console","leading","trailing","undefined","showCommentOnLoaded","navigateRef","navigate","timer","window","flush","clearTimeout","curentCount","useMemo","texts","getTexts","allContentIds","forEach","text","leaves","leave","marks","m","DataMark","isDataMark","id","push","length","onCommentsChangeRef","handleAdd","handleDelete","commonsProps","onAdd","onDelete"],"mappings":"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","sourcesContent":["/* eslint-disable react-hooks/exhaustive-deps */\nimport React from 'react';\nimport { Controller, environment, useZoom } from '@ali/4ever-cangjie';\nimport { debounce } from 'lodash-es';\nimport CommentSideBar from './commentSidebar';\nimport isSidebarVisible from '../queries/isSidebarVisible';\nimport CommentBottomBar from './CommentBottomBar';\nimport { CommentPluginConfigs, ShowCommentOptions } from '../types';\nimport getActiveId from '../queries/getActiveId';\nimport { addComment, showComment, setComments } from '../actions';\nimport { DataMark, ViewMark } from '../models/marks';\nimport CommentInlinePanel from './CommentInlinePanel';\nimport useContentIds from '../utils/useContentIds';\nimport ExternalSidebar from './ExternalSidebar';\n\nconst { IS_MOBILE, IS_IPAD } = environment;\nconst IS_PHONE = IS_MOBILE && !IS_IPAD;\nconst DEBOUNCE_LOAD_TIME = 500;\nconst INIT_SCROLL_DELAY = 700;\nlet initNavigate = false;\n\ninterface CommentContentProps {\n  configs: CommentPluginConfigs | undefined;\n  controller: Controller;\n  isDisabled: boolean;\n}\n\nconst navigateToComment =\n  (controller: Controller, onCommentInvalid: Function) =>\n  async (\n    subId?: string | (() => Promise<string>),\n    options?: ShowCommentOptions,\n  ) => {\n    const subObjectId = typeof subId === 'function' ? await subId() : subId;\n    if (typeof subId === 'function' && !subObjectId) {\n      return;\n    }\n    const validInPage = controller.value.decorations.some(\n      (d) =>\n        ViewMark.isViewMark(d.mark) && d.mark.data.contentId === subObjectId,\n    );\n    const _ =\n      validInPage || options?.ignoreCheck\n        ? controller.run('onAction', showComment(subObjectId, options))\n        : onCommentInvalid(subObjectId);\n  };\n\nfunction CommentContent(props: CommentContentProps) {\n  const { controller, configs } = props;\n  const showInline = Boolean(configs?.showInline);\n  const { document } = controller.value;\n  const contentId = getActiveId(controller);\n  const isInited = React.useRef(false);\n  const isCommentLoaded = React.useRef(false);\n  useZoom();\n  const showBottomBar = IS_PHONE && contentId && !showInline;\n  const isDisabled = Boolean(configs?.isDisabled && configs.isDisabled());\n\n  const {\n    fetchCachedComment,\n    reloadComments,\n    isDocLoaded,\n    enableAutoBlur,\n    contentIds,\n    onContentMounted,\n    onContentUnMounted,\n    onSidebarInfoUpdated,\n    disableBottomBar,\n    withCustomApiAdaptor,\n  } = configs || {};\n  const isLoaded = isDocLoaded ? isDocLoaded() : true;\n  const showSideBar =\n    !showInline &&\n    !onSidebarInfoUpdated &&\n    !IS_PHONE &&\n    isSidebarVisible(controller);\n  const loadKey = controller.readOnly ? document : isLoaded;\n\n  useContentIds(controller, isCommentLoaded.current, contentIds);\n  React.useEffect(() => {\n    if (isDisabled) {\n      // timeout 出于体验考虑，下一个 tick 再更新，避免频繁闪烁\n      setTimeout(() => {\n        const { decorations } = controller.value;\n        controller.setDecorations(\n          decorations.filter((d) => !ViewMark.isViewMark(d.mark)),\n        );\n\n        const sideBarStatus = !IS_PHONE && isSidebarVisible(controller);\n        if (sideBarStatus && configs?.onDisabled) {\n          configs.onDisabled();\n        }\n      });\n    } else if (isInited.current) {\n      controller.setData({\n        ...controller.value.data,\n      });\n    }\n    isInited.current = true;\n  }, [controller, isDisabled]);\n\n  const loadCachedComment = React.useCallback(\n    debounce(\n      async () => {\n        try {\n          if (!fetchCachedComment || !loadKey) {\n            return;\n          }\n          const result = await fetchCachedComment();\n          if (!result || !Array.isArray(result)) {\n            return;\n          }\n          isCommentLoaded.current = true;\n          controller.run('onAction', setComments([...result]));\n        } catch (error) {\n          // eslint-disable-next-line no-console\n          console.error(error);\n        }\n      },\n      DEBOUNCE_LOAD_TIME,\n      {\n        leading: true,\n        trailing: true,\n      },\n    ),\n    [controller, fetchCachedComment, loadKey, isDisabled],\n  );\n\n  React.useEffect(() => {\n    if (!isCommentLoaded.current) {\n      return undefined;\n    }\n    const { showCommentOnLoaded, onDisabled } = configs || {};\n    const {\n      subObjectId,\n      onCommentInvalid = () => {},\n      navigateRef,\n    } = showCommentOnLoaded || {};\n    const navigate = navigateToComment(controller, onCommentInvalid);\n    if (isDisabled) {\n      onDisabled && navigateRef && navigateRef(onDisabled);\n    } else {\n      navigateRef && navigateRef(navigate);\n    }\n    if (!subObjectId || initNavigate) {\n      return undefined;\n    }\n    initNavigate = true;\n    // timeout 出于体验考虑，下一个 tick 再更新，避免频繁闪烁\n    const timer = window.setTimeout(() => {\n      navigate(subObjectId);\n      controller.flush();\n    }, INIT_SCROLL_DELAY);\n    return () => {\n      window.clearTimeout(timer);\n    };\n  }, [controller, isCommentLoaded.current]);\n\n  const curentCount = React.useMemo(() => {\n    const texts = document.getTexts();\n    const allContentIds: string[] = [];\n    texts.forEach((text) => {\n      text.leaves.forEach((leave) => {\n        leave.marks.forEach((m) => {\n          if (DataMark.isDataMark(m)) {\n            if (!allContentIds.some((id) => id === m.data.contentId)) {\n              allContentIds.push(m.data.contentId);\n            }\n          }\n        });\n      });\n    });\n    return allContentIds.length;\n  }, [document]);\n\n  // 使用 customApi, 必须放到 reloadComments 之前\n  React.useEffect(() => {\n    withCustomApiAdaptor && withCustomApiAdaptor();\n  }, [withCustomApiAdaptor]);\n\n  React.useEffect(() => {\n    reloadComments && reloadComments();\n  }, [reloadComments, curentCount]);\n\n  React.useEffect(() => {\n    onContentMounted && onContentMounted();\n    return () => {\n      onContentUnMounted && onContentUnMounted();\n    };\n  }, []);\n\n  React.useEffect(() => {\n    loadCachedComment();\n  }, [loadCachedComment]);\n\n  React.useEffect(() => {\n    if (configs?.onCommentsChangeRef) {\n      configs.onCommentsChangeRef(loadCachedComment);\n    }\n    return () => {\n      if (configs?.onCommentsChangeRef) {\n        configs.onCommentsChangeRef(null);\n      }\n    };\n  }, [loadCachedComment, configs]);\n\n  const handleAdd = React.useCallback(() => {\n    controller.run('onAction', addComment());\n  }, [controller]);\n\n  const handleDelete = React.useCallback(() => {\n    // controller.run('onAction', addComment());\n  }, [controller]);\n  const commonsProps = {\n    onAdd: handleAdd,\n    onDelete: handleDelete,\n    configs,\n  };\n\n  return (\n    <React.Fragment>\n      {showSideBar && !isDisabled && (\n        <CommentSideBar\n          enableAutoBlur={enableAutoBlur}\n          {...commonsProps}\n          controller={controller}\n        />\n      )}\n      {!!onSidebarInfoUpdated && !!configs && (\n        <ExternalSidebar\n          configs={configs}\n          isCommentLoaded={isCommentLoaded.current}\n          controller={controller}\n        />\n      )}\n      {showInline && contentId && (\n        <CommentInlinePanel {...commonsProps} contentId={contentId} />\n      )}\n      {showBottomBar && !isDisabled && !disableBottomBar && (\n        <CommentBottomBar {...commonsProps} contentId={contentId!} />\n      )}\n    </React.Fragment>\n  );\n}\n\nexport default CommentContent;\n"],"file":"CommentContent.js"}