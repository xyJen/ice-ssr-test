{"version":3,"sources":["../../../../src/utils/components/CommentInlinePanel.tsx"],"names":["CommentInlinePanel","props","configs","onAdd","onDelete","enableAutoBlur","contentId","controller","Controller","useController","container","window","document","body","position","setPosition","React","useState","comments","item","find","c","decorations","value","decoration","d","ViewMark","isViewMark","mark","data","isNew","summary","rp","useEffect","voidNode","dom","querySelector","voidRect","getBoundingClientRect","rects","Array","from","getClientRects","rect","length","parent","top","bottom","left","width","parentRect","prev","next","query","getSiblings","navigateToPrev","useCallback","run","navigateToNext","cancelPopup","readonlyPosition","readOnly","undefined","summaryText","locale","comment","renderProps","isActive","isAutoFocus","Boolean","children","renderCustomPopup"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { Controller, useZoomContainer } from '@ali/4ever-cangjie';\nimport {\n  CommentPluginConfigs,\n  RenderCustomPopupProps,\n} from '../types';\nimport { ViewMark } from '../models/marks';\nimport getComments from '../queries/getComments';\nimport getSiblings from '../queries/getSiblings';\nimport { cancelComment, hideComment, showComment } from '../actions';\nimport { findDOMNodeByVoidKey } from '../utils/findDOMNodeByVoidKey';\n\ntype CommentSideBarProps = {\n  configs?: CommentPluginConfigs;\n  enableAutoBlur?: boolean;\n  onAdd: () => void;\n  onDelete: () => void;\n  contentId: string;\n};\n\ntype PopupData = {\n  top: number;\n  left: number;\n  contentId: string;\n};\n\nexport default function CommentInlinePanel(props: CommentSideBarProps) {\n  const { configs, onAdd, onDelete, enableAutoBlur, contentId } = props;\n  const controller = Controller.useController();\n  const container = useZoomContainer() || window.document.body;\n  const [position, setPosition] = React.useState<\n    RenderCustomPopupProps['position']\n  >();\n  const comments = getComments(controller);\n  const item = comments.find((c) => c.contentId === contentId);\n  const { decorations } = controller.value;\n  const decoration = decorations.find(\n    (d) => ViewMark.isViewMark(d.mark) && d.mark.data.contentId === contentId,\n  );\n  const mark = decoration?.mark as ViewMark | undefined;\n  const { isNew, summary, position: rp } = mark?.data || {};\n  React.useEffect(() => {\n    const voidNode = findDOMNodeByVoidKey(contentId, container);\n    const dom = container.querySelector(`[data-comment='${contentId}']`);\n    const voidRect = voidNode?.getBoundingClientRect();\n    const rects = voidRect ? [voidRect] : Array.from(dom?.getClientRects() || []);\n    const rect = rects[rects.length - 1];\n    if (!rect) {\n      return;\n    }\n    const parent = container.getBoundingClientRect();\n    const top = rect.bottom - parent.top;\n    const left = rect.left + rect.width / 2 - parent.left;\n    setPosition({ top, left, width: parent.width, rects, parentRect: parent });\n  }, [contentId, container, controller.value.decorations]);\n\n  const { prev, next } = controller.query(getSiblings);\n\n  const navigateToPrev = React.useCallback(() => {\n    if (prev) {\n      controller.run('onAction', showComment(prev));\n    }\n  }, [controller, prev]);\n\n  const navigateToNext = React.useCallback(() => {\n    if (next) {\n      controller.run('onAction', showComment(next));\n    }\n  }, [controller, next]);\n\n  const cancelPopup = React.useCallback(() => {\n    controller.run('onAction', hideComment());\n    controller.run('onAction', cancelComment());\n  }, [controller]);\n\n  if (!item && !decoration) {\n    return null;\n  }\n\n  let readonlyPosition: string | undefined = '';\n  if (isNew) {\n    readonlyPosition = controller.readOnly ? rp : undefined;\n  }\n  const summaryText =\n    summary || item?.summary || configs?.locale?.comment || '';\n  const renderProps: RenderCustomPopupProps = {\n    contentId,\n    isActive: true,\n    isAutoFocus: false,\n    isNew: Boolean(isNew),\n    summary: summaryText,\n    readonlyPosition,\n    onAdd,\n    onDelete,\n    prev,\n    next,\n    navigateToPrev,\n    navigateToNext,\n    cancelPopup,\n    position,\n  };\n  const children =\n    configs?.renderCustomPopup && configs.renderCustomPopup(renderProps);\n\n  return <React.Fragment>{children}</React.Fragment>;\n}\n"],"file":"CommentInlinePanel.js"}