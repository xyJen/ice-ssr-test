{"version":3,"sources":["../../../../src/utils/components/CommentBottomBar.tsx"],"names":["CURTAIN_HEIGHT","curtainWrapperStyle","maxHeight","ToolbarArrowUpNormal","ToolbarArrowDownNormal","TitleWrapper","styled","div","Title","Finish","IconWrapper","props","isDisabled","Content","CommentBottomBar","configs","contentId","onAdd","onDelete","controller","Controller","useController","comments","item","find","c","decorations","value","decoration","d","ViewMark","isViewMark","mark","data","isForcedNotVisible","setForcedNotVisible","React","useState","timerRef","useRef","hideActive","useCallback","run","hideNew","some","isNew","handleClose","current","clearTimeout","setTimeout","useEffect","handleCloseComment","closeComment","isCloseDisabled","hideCloseMenu","prev","next","query","getSiblings","navigateToPrev","event","navigateToNext","summary","position","readonlyPosition","readOnly","undefined","summaryText","locale","comment","renderProps","isActive","isAutoFocus","Boolean","children","renderPopup","blockEvent"],"mappings":";;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AAEA;;AACA;;AACA;;AACA;;AACA;;uBAT4B,a;AAW5B,MAAMA,cAAc,GAAG,GAAvB;AACA,MAAMC,mBAAmB,GAAG;AAC1BC,EAAAA,SAAS,EAAE;AADe,CAA5B;AAIA,MAAMC,oBAAoB,gBAAG,+BAAOC,8BAAP,CAAH,+BAA1B;;AAIA,MAAMC,YAAY,gBAAGC,0BAAOC,GAAV,8FAAlB;;AAQA,MAAMC,KAAK,gBAAGF,0BAAOC,GAAV,6JAAX;;AAWA,MAAME,MAAM,gBAAGH,0BAAOC,GAAV,gIAAZ;;AAYA,MAAMG,WAAW,gBAAGJ,0BAAOC,GAAV,yJAQLI,KAAD,IACPA,KAAK,CAACC,UAAN,GAAmB,wBAAnB,GAA8C,SATjC,CAAjB;;AAeA,MAAMC,OAAO,gBAAGP,0BAAOC,GAAV,2IAAb;;wBAwHY,eAAC,oBAAD,O;;yBAGA,eAAC,8BAAD,O;;yBAEsE,eAAC,sBAAD,O;;AAzGlF,SAASO,gBAAT,CAA0BH,KAA1B,EAAwD;AACtD,QAAM;AAAEI,IAAAA,OAAF;AAAWC,IAAAA,SAAX;AAAsBC,IAAAA,KAAtB;AAA6BC,IAAAA;AAA7B,MAA0CP,KAAhD;;AACA,QAAMQ,UAAU,GAAGC,wBAAWC,aAAX,EAAnB;;AACA,QAAMC,QAAQ,GAAG,0BAAYH,UAAZ,CAAjB;AACA,QAAMI,IAAI,GAAGD,QAAQ,CAACE,IAAT,CAAeC,CAAD,IAAOA,CAAC,CAACT,SAAF,KAAgBA,SAArC,CAAb;AACA,QAAM;AAAEU,IAAAA;AAAF,MAAkBP,UAAU,CAACQ,KAAnC;AACA,QAAMC,UAAU,GAAGF,WAAW,CAACF,IAAZ,CAChBK,CAAD,IAAOC,gBAASC,UAAT,CAAoBF,CAAC,CAACG,IAAtB,KAA+BH,CAAC,CAACG,IAAF,CAAOC,IAAP,CAAYjB,SAAZ,KAA0BA,SAD/C,CAAnB;;AAIA,QAAM,CAACkB,kBAAD,EAAqBC,mBAArB,IAA4CC,eAAMC,QAAN,CAAe,KAAf,CAAlD;;AACA,QAAMC,QAAQ,GAAGF,eAAMG,MAAN,EAAjB;;AAEA,QAAMC,UAAU,GAAGJ,eAAMK,WAAN,CAAkB,MAAM;AACzCtB,IAAAA,UAAU,CAACuB,GAAX,CAAe,UAAf,EAA2B,2BAA3B;AACD,GAFkB,EAEhB,CAACvB,UAAD,CAFgB,CAAnB;;AAGA,QAAMwB,OAAO,GAAGP,eAAMK,WAAN,CAAkB,MAAM;AACtC,QACEf,WAAW,CAACkB,IAAZ,CAAkBf,CAAD,IAAOC,gBAASC,UAAT,CAAoBF,CAAC,CAACG,IAAtB,KAA+BH,CAAC,CAACG,IAAF,CAAOC,IAAP,CAAYY,KAAnE,CADF,EAEE;AACA1B,MAAAA,UAAU,CAACuB,GAAX,CAAe,UAAf,EAA2B,6BAA3B;AACD;AACF,GANe,EAMb,CAACvB,UAAD,EAAaO,WAAb,CANa,CAAhB;;AAQA,QAAMoB,WAAW,GAAGV,eAAMK,WAAN,CAAkB,MAAM;AAC1CN,IAAAA,mBAAmB,CAAC,IAAD,CAAnB;AACAG,IAAAA,QAAQ,CAACS,OAAT,IAAoBC,YAAY,CAACV,QAAQ,CAACS,OAAV,CAAhC,CAF0C,CAG1C;;AACAT,IAAAA,QAAQ,CAACS,OAAT,GAAmBE,UAAU,CAAC,MAAM;AAClCd,MAAAA,mBAAmB,CAAC,KAAD,CAAnB;AACD,KAF4B,EAE1B,GAF0B,CAA7B;AAGAK,IAAAA,UAAU;AACVG,IAAAA,OAAO;AACR,GATmB,EASjB,CAACH,UAAD,EAAaG,OAAb,CATiB,CAApB;;AAWAP,iBAAMc,SAAN,CAAgB,MAAM;AACpB,WAAO,MAAM;AACXZ,MAAAA,QAAQ,CAACS,OAAT,IAAoBC,YAAY,CAACV,QAAQ,CAACS,OAAV,CAAhC;AACD,KAFD;AAGD,GAJD,EAIG,EAJH;;AAMA,QAAMI,kBAAkB,GAAGf,eAAMK,WAAN,CAAkB,MAAM;AACjD1B,IAAAA,OAAO,EAAEqC,YAAT,IAAyBrC,OAAO,EAAEqC,YAAT,CAAsBpC,SAAtB,EAAiC8B,WAAjC,CAAzB;AACD,GAF0B,EAExB,CAACA,WAAD,EAAc9B,SAAd,CAFwB,CAA3B;;AAIA,QAAMqC,eAAe,GAAGtC,OAAO,EAAEuC,aAAT,IAA0BvC,OAAO,CAACuC,aAAR,EAAlD;AAEA,QAAM;AAAEC,IAAAA,IAAF;AAAQC,IAAAA;AAAR,MAAiBrC,UAAU,CAACsC,KAAX,CAAiBC,oBAAjB,CAAvB;;AACA,QAAMC,cAAc,GAAGvB,eAAMK,WAAN,CACpBmB,KAAD,IAA6B;AAC3B,QAAIL,IAAJ,EAAU;AACRpC,MAAAA,UAAU,CAACuB,GAAX,CAAe,UAAf,EAA2B,0BAAYa,IAAZ,CAA3B;AACD;;AACD,6BAAWK,KAAX;AACD,GANoB,EAOrB,CAACzC,UAAD,EAAaoC,IAAb,CAPqB,CAAvB;;AAUA,QAAMM,cAAc,GAAGzB,eAAMK,WAAN,CACpBmB,KAAD,IAA6B;AAC3B,QAAIJ,IAAJ,EAAU;AACRrC,MAAAA,UAAU,CAACuB,GAAX,CAAe,UAAf,EAA2B,0BAAYc,IAAZ,CAA3B;AACD;;AACD,6BAAWI,KAAX;AACD,GANoB,EAOrB,CAACzC,UAAD,EAAaqC,IAAb,CAPqB,CAAvB;;AAUA,MAAI,CAACjC,IAAD,IAAS,CAACK,UAAd,EAA0B;AACxB,WAAO,IAAP;AACD;;AAED,QAAMI,IAAI,GAAGJ,UAAU,EAAEI,IAAzB;AACA,QAAM;AAAEa,IAAAA,KAAF;AAASiB,IAAAA,OAAT;AAAkBC,IAAAA;AAAlB,MAA+B/B,IAAI,EAAEC,IAAN,IAAc,EAAnD;AACA,MAAI+B,gBAAoC,GAAG,EAA3C;;AACA,MAAInB,KAAJ,EAAW;AACTmB,IAAAA,gBAAgB,GAAG7C,UAAU,CAAC8C,QAAX,GAAsBF,QAAtB,GAAiCG,SAApD;AACD;;AACD,QAAMC,WAAW,GAAGL,OAAO,IAAIvC,IAAI,EAAEuC,OAAjB,IAA4B/C,OAAO,EAAEqD,MAAT,EAAiBC,OAA7C,IAAwD,EAA5E;AACA,QAAMC,WAA6B,GAAG;AACpCtD,IAAAA,SADoC;AAEpCuD,IAAAA,QAAQ,EAAE,IAF0B;AAGpCC,IAAAA,WAAW,EAAE,KAHuB;AAIpC3B,IAAAA,KAAK,EAAE4B,OAAO,CAAC5B,KAAD,CAJsB;AAKpCiB,IAAAA,OAAO,EAAEK,WAL2B;AAMpCH,IAAAA,gBANoC;AAOpC/C,IAAAA,KAPoC;AAQpCC,IAAAA;AARoC,GAAtC;AAUA,QAAMwD,QAAQ,GAAG3D,OAAO,EAAE4D,WAAT,IAAwB5D,OAAO,CAAC4D,WAAR,CAAoBL,WAApB,CAAzC;AAEA,sBACE,eAAC,6BAAD;AACE,IAAA,SAAS,EAAE,CAAC,CAACtD,SAAF,IAAe,CAACkB,kBAD7B;AAEE,IAAA,OAAO,EAAEY,WAFX;AAGE,IAAA,MAAM,EAAE9C,cAHV;AAIE,IAAA,KAAK,eACH,eAAC,YAAD,qBACE,eAAC,KAAD,QAAS,KAAImE,WAAY,EAAzB,CADF,eAEE,eAAC,WAAD;AAAa,MAAA,UAAU,EAAE,CAACZ,IAA1B;AAAgC,MAAA,OAAO,EAAEI;AAAzC,YAFF,eAKE,eAAC,WAAD;AAAa,MAAA,UAAU,EAAE,CAACH,IAA1B;AAAgC,MAAA,OAAO,EAAEK;AAAzC,aALF,EAQK,CAAChB,KAAD,IAAU,CAACQ,eAAZ,iBAAiC,eAAC,MAAD;AAAQ,MAAA,OAAO,EAAEF;AAAjB,aARrC,CALJ;AAgBE,IAAA,KAAK,EAAElD;AAhBT,kBAkBE,eAAC,OAAD;AAAS,IAAA,GAAG,EAAEe,SAAd;AAAyB,IAAA,OAAO,EAAE4D;AAAlC,KACGF,QADH,CAlBF,CADF;AAwBD;;eAEc5D,gB","sourcesContent":["import React from 'react';\nimport styled from 'styled-components';\nimport { Controller } from '@ali/4ever-cangjie';\nimport { CompleteNormal, ToolbarArrowDownNormal } from '@ali/we-icon';\nimport { MobileBottomCurtain } from '@ali/we-design';\nimport { CommentPluginConfigs, RenderPopupProps } from '../types';\nimport { ViewMark } from '../models/marks';\nimport { hideComment, cancelComment, showComment } from '../actions';\nimport blockEvent from '../utils/blockEvent';\nimport getSiblings from '../queries/getSiblings';\nimport getComments from '../queries/getComments';\n\nconst CURTAIN_HEIGHT = 480;\nconst curtainWrapperStyle = {\n  maxHeight: '70vh',\n};\n\nconst ToolbarArrowUpNormal = styled(ToolbarArrowDownNormal)`\n  transform: rotate(180deg);\n`;\n\nconst TitleWrapper = styled.div`\n  padding: 0 16px 0 19px;\n  font-size: 16px;\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n`;\n\nconst Title = styled.div`\n  flex: 1;\n  font-size: 14px;\n  text-align: left;\n  color: #171a1d;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  overflow: hidden;\n  letter-spacing: 0.22px;\n  font-weight: normal;\n`;\nconst Finish = styled.div`\n  padding: 0 4px;\n  line-height: 42px;\n  white-space: nowrap;\n  color: #191F25;;\n  flex: 0 0 36px;\n  text-align: center;\n  & > span {\n    font-size: 20px;\n  }\n`;\n\nconst IconWrapper = styled.div<{ isDisabled?: boolean }>`\n  height: 42px;\n  width: 36px;\n  display: flex;\n  cursor: pointer;\n  flex-direction: row;\n  justify-content: center;\n  align-items: center;\n  color: ${(props) =>\n    props.isDisabled ? 'rgba(23, 26, 29, 0.24)' : '#171A1D'};\n  & span {\n    font-size: 20px;\n  }\n`;\n\nconst Content = styled.div`\n  display: flex;\n  flex: 1;\n  overflow-y: scroll;\n  flex-direction: row;\n  & > :first-child {\n    width: 100%;\n  }\n  & [data-cmt-editor-container] {\n    background: white;\n  }\n`;\n\ntype CommentBottomBarProps = {\n  configs?: CommentPluginConfigs;\n  onAdd: () => void;\n  onDelete: () => void;\n  contentId: string;\n};\n\nfunction CommentBottomBar(props: CommentBottomBarProps) {\n  const { configs, contentId, onAdd, onDelete } = props;\n  const controller = Controller.useController();\n  const comments = getComments(controller);\n  const item = comments.find((c) => c.contentId === contentId);\n  const { decorations } = controller.value;\n  const decoration = decorations.find(\n    (d) => ViewMark.isViewMark(d.mark) && d.mark.data.contentId === contentId,\n  );\n\n  const [isForcedNotVisible, setForcedNotVisible] = React.useState(false);\n  const timerRef = React.useRef<ReturnType<typeof setTimeout>>();\n\n  const hideActive = React.useCallback(() => {\n    controller.run('onAction', hideComment());\n  }, [controller]);\n  const hideNew = React.useCallback(() => {\n    if (\n      decorations.some((d) => ViewMark.isViewMark(d.mark) && d.mark.data.isNew)\n    ) {\n      controller.run('onAction', cancelComment());\n    }\n  }, [controller, decorations]);\n\n  const handleClose = React.useCallback(() => {\n    setForcedNotVisible(true);\n    timerRef.current && clearTimeout(timerRef.current);\n    // timeout 出于体验考虑，展示 100ms 动画效果；上面已经有清除逻辑\n    timerRef.current = setTimeout(() => {\n      setForcedNotVisible(false);\n    }, 100);\n    hideActive();\n    hideNew();\n  }, [hideActive, hideNew]);\n\n  React.useEffect(() => {\n    return () => {\n      timerRef.current && clearTimeout(timerRef.current);\n    }\n  }, []);\n\n  const handleCloseComment = React.useCallback(() => {\n    configs?.closeComment && configs?.closeComment(contentId, handleClose);\n  }, [handleClose, contentId]);\n\n  const isCloseDisabled = configs?.hideCloseMenu && configs.hideCloseMenu();\n\n  const { prev, next } = controller.query(getSiblings);\n  const navigateToPrev = React.useCallback(\n    (event: React.MouseEvent) => {\n      if (prev) {\n        controller.run('onAction', showComment(prev));\n      }\n      blockEvent(event);\n    },\n    [controller, prev],\n  );\n\n  const navigateToNext = React.useCallback(\n    (event: React.MouseEvent) => {\n      if (next) {\n        controller.run('onAction', showComment(next));\n      }\n      blockEvent(event);\n    },\n    [controller, next],\n  );\n\n  if (!item && !decoration) {\n    return null;\n  }\n\n  const mark = decoration?.mark as ViewMark | undefined;\n  const { isNew, summary, position } = mark?.data || {};\n  let readonlyPosition: string | undefined = '';\n  if (isNew) {\n    readonlyPosition = controller.readOnly ? position : undefined;\n  }\n  const summaryText = summary || item?.summary || configs?.locale?.comment || '';\n  const renderProps: RenderPopupProps = {\n    contentId,\n    isActive: true,\n    isAutoFocus: false,\n    isNew: Boolean(isNew),\n    summary: summaryText,\n    readonlyPosition,\n    onAdd,\n    onDelete,\n  };\n  const children = configs?.renderPopup && configs.renderPopup(renderProps);\n\n  return (\n    <MobileBottomCurtain\n      isVisible={!!contentId && !isForcedNotVisible}\n      onClose={handleClose}\n      height={CURTAIN_HEIGHT}\n      title={\n        <TitleWrapper>\n          <Title>{`| ${summaryText}`}</Title>\n          <IconWrapper isDisabled={!prev} onClick={navigateToPrev}>\n            <ToolbarArrowUpNormal />\n          </IconWrapper>\n          <IconWrapper isDisabled={!next} onClick={navigateToNext}>\n            <ToolbarArrowDownNormal />\n          </IconWrapper>\n          { (!isNew && !isCloseDisabled) && (<Finish onClick={handleCloseComment}><CompleteNormal /></Finish>)}\n        </TitleWrapper>\n      }\n      style={curtainWrapperStyle}\n    >\n      <Content key={contentId} onClick={blockEvent}>\n        {children}\n      </Content>\n    </MobileBottomCurtain>\n  );\n}\n\nexport default CommentBottomBar;\n"],"file":"CommentBottomBar.js"}