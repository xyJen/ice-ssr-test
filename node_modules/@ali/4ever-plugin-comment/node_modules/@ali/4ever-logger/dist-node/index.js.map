{"version":3,"file":"index.js","sources":["../../src/index.ts"],"sourcesContent":["import WeLogger from '@ali/we-logger-main';\nimport type ArmsAppender from '@ali/we-logger-appender-arms';\nimport DebugAppender from '@ali/we-logger-appender-debug';\nimport packageJSON from '@ali/4ever-logger/package.json';\n\nconst { version } = packageJSON;\n\n/**\n * @see https://arms.console.aliyun.com/retcode?pid=en91t6prdd%4081db28b43ff68d6#/index\n */\nconst PID = 'en91t6prdd@81db28b43ff68d6';\n\n/**\n * 判断是否是本地环境\n */\nconst IS_LOCAL = process.env.NODE_ENV === 'development';\n\nconst IS_TEST = process.env.NODE_ENV === 'test';\n\nexport enum EnvEnum {\n  // 日常\n  DAILY = 'daily',\n  // 预发\n  PRE = 'pre',\n  // 线上\n  PROD = 'prod',\n  // 本地\n  LOCAL = 'local',\n  // 未知\n  UNKNOWN = 'unknown',\n}\n\nconst substr2EnvMap = new Map([\n  ['pre-', EnvEnum.PRE],\n  ['daily-', EnvEnum.DAILY],\n]);\n\nexport const getEnvironment = () => {\n  const { location: { hostname } } = window;\n  for (const [substr, env] of substr2EnvMap) {\n    if (hostname.startsWith(substr)) {\n      return env;\n    }\n  }\n  return EnvEnum.PROD;\n};\n\n/**\n * 默认需要一个 debug appender, 外层业务也可以主动移除\n */\nexport const debugAppender = new DebugAppender('EDITOR:LOGGER');\n\n/**\n * 默认配置好一个 arms appender, 需要外层业务手动注入才能够生效\n * @see https://arms.console.aliyun.com/retcode?pid=en91t6prdd%4081db28b43ff68d6#/index\n */\nexport const getArmsAppender = function () {\n  if (IS_TEST) {\n    return null;\n  }\n  // 单测环境下 Arms 会在 Console 抛错，这里做一个优化处理\n  // eslint-disable-next-line no-underscore-dangle\n  const _ArmsAppender = require('@ali/we-logger-appender-arms').default as typeof ArmsAppender;\n  return new _ArmsAppender({\n    release: version,\n    pid: PID,\n    appType: 'web',\n    // SDK 层不监听 hashchange\n    enableSPA: false,\n    // SDK 层不监听 HTTP\n    disableHook: true,\n    // 本地开发环境不上报\n    disabled: IS_LOCAL,\n    environment: getEnvironment(),\n  });\n};\n\nexport interface ILogger {\n  // 供使用者开关上报日志，默认关闭\n  setEnabled: (boolean) => void;\n  // 供使用者为业务命名\n  setBizName: (name: string) => Logger;\n}\n\nclass Logger extends WeLogger implements ILogger {\n  private armsAppender: ArmsAppender | null = null;\n\n  private sentPV = false;\n\n  private bizName = location.host;\n\n  setEnabled(flag = true) {\n    if (flag) {\n      if (!this.armsAppender) {\n        this.armsAppender = getArmsAppender();\n        this.armsAppender && this.append(this.armsAppender);\n      }\n      if (!this.sentPV && this.armsAppender) {\n        // Note: page's value\n        this.armsAppender.getArms().setPage(location.href);\n        this.armsAppender.sum(`BIZ: ${this.bizName}`);\n        this.sentPV = true;\n      }\n    } else if (this.armsAppender) {\n      this.remove(this.armsAppender);\n      this.armsAppender = null;\n    }\n  }\n\n  setBizName(name) {\n    this.bizName = name;\n    return this;\n  }\n}\n\nconst logger = new Logger().append(debugAppender);\n\nexport default logger;\n"],"names":["version","packageJSON","PID","IS_LOCAL","process","env","NODE_ENV","IS_TEST","EnvEnum","substr2EnvMap","Map","PRE","DAILY","getEnvironment","location","hostname","window","substr","startsWith","PROD","debugAppender","DebugAppender","getArmsAppender","_ArmsAppender","require","default","release","pid","appType","enableSPA","disableHook","disabled","environment","Logger","WeLogger","armsAppender","sentPV","bizName","host","setEnabled","flag","append","getArms","setPage","href","sum","remove","setBizName","name","logger"],"mappings":"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"}