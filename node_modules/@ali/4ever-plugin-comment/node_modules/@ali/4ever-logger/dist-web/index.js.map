{"version":3,"file":"index.js","sources":["../../src/index.ts"],"sourcesContent":["import WeLogger from '@ali/we-logger-main';\nimport type ArmsAppender from '@ali/we-logger-appender-arms';\nimport DebugAppender from '@ali/we-logger-appender-debug';\nimport packageJSON from '@ali/4ever-logger/package.json';\n\nconst { version } = packageJSON;\n\n/**\n * @see https://arms.console.aliyun.com/retcode?pid=en91t6prdd%4081db28b43ff68d6#/index\n */\nconst PID = 'en91t6prdd@81db28b43ff68d6';\n\n/**\n * 判断是否是本地环境\n */\nconst IS_LOCAL = process.env.NODE_ENV === 'development';\n\nconst IS_TEST = process.env.NODE_ENV === 'test';\n\nexport enum EnvEnum {\n  // 日常\n  DAILY = 'daily',\n  // 预发\n  PRE = 'pre',\n  // 线上\n  PROD = 'prod',\n  // 本地\n  LOCAL = 'local',\n  // 未知\n  UNKNOWN = 'unknown',\n}\n\nconst substr2EnvMap = new Map([\n  ['pre-', EnvEnum.PRE],\n  ['daily-', EnvEnum.DAILY],\n]);\n\nexport const getEnvironment = () => {\n  const { location: { hostname } } = window;\n  for (const [substr, env] of substr2EnvMap) {\n    if (hostname.startsWith(substr)) {\n      return env;\n    }\n  }\n  return EnvEnum.PROD;\n};\n\n/**\n * 默认需要一个 debug appender, 外层业务也可以主动移除\n */\nexport const debugAppender = new DebugAppender('EDITOR:LOGGER');\n\n/**\n * 默认配置好一个 arms appender, 需要外层业务手动注入才能够生效\n * @see https://arms.console.aliyun.com/retcode?pid=en91t6prdd%4081db28b43ff68d6#/index\n */\nexport const getArmsAppender = function () {\n  if (IS_TEST) {\n    return null;\n  }\n  // 单测环境下 Arms 会在 Console 抛错，这里做一个优化处理\n  // eslint-disable-next-line no-underscore-dangle\n  const _ArmsAppender = require('@ali/we-logger-appender-arms').default as typeof ArmsAppender;\n  return new _ArmsAppender({\n    release: version,\n    pid: PID,\n    appType: 'web',\n    // SDK 层不监听 hashchange\n    enableSPA: false,\n    // SDK 层不监听 HTTP\n    disableHook: true,\n    // 本地开发环境不上报\n    disabled: IS_LOCAL,\n    environment: getEnvironment(),\n  });\n};\n\nexport interface ILogger {\n  // 供使用者开关上报日志，默认关闭\n  setEnabled: (boolean) => void;\n  // 供使用者为业务命名\n  setBizName: (name: string) => Logger;\n}\n\nclass Logger extends WeLogger implements ILogger {\n  private armsAppender: ArmsAppender | null = null;\n\n  private sentPV = false;\n\n  private bizName = location.host;\n\n  setEnabled(flag = true) {\n    if (flag) {\n      if (!this.armsAppender) {\n        this.armsAppender = getArmsAppender();\n        this.armsAppender && this.append(this.armsAppender);\n      }\n      if (!this.sentPV && this.armsAppender) {\n        // Note: page's value\n        this.armsAppender.getArms().setPage(location.href);\n        this.armsAppender.sum(`BIZ: ${this.bizName}`);\n        this.sentPV = true;\n      }\n    } else if (this.armsAppender) {\n      this.remove(this.armsAppender);\n      this.armsAppender = null;\n    }\n  }\n\n  setBizName(name) {\n    this.bizName = name;\n    return this;\n  }\n}\n\nconst logger = new Logger().append(debugAppender);\n\nexport default logger;\n"],"names":["version","packageJSON","PID","IS_LOCAL","process","env","NODE_ENV","IS_TEST","EnvEnum","substr2EnvMap","Map","PRE","DAILY","getEnvironment","window","hostname","location","substr","startsWith","PROD","debugAppender","DebugAppender","getArmsAppender","_ArmsAppender","require","release","pid","appType","enableSPA","disableHook","disabled","environment","Logger","armsAppender","sentPV","bizName","host","setEnabled","flag","append","getArms","setPage","href","sum","remove","setBizName","name","WeLogger","logger"],"mappings":";;;;;;;;;;IAKQA,UAAYC,YAAZD;AAER;AACA;AACA;;AACA,IAAME,GAAG,GAAG,4BAAZ;AAEA;AACA;AACA;;AACA,IAAMC,QAAQ,GAAGC,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAAyB,aAA1C;AAEA,IAAMC,OAAO,GAAGH,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAAyB,MAAzC;IAEYE;;WAAAA;AAAAA,EAAAA;AAAAA,EAAAA;AAAAA,EAAAA;AAAAA,EAAAA;AAAAA,EAAAA;GAAAA,YAAAA;;AAaZ,IAAMC,aAAa,GAAG,IAAIC,GAAJ,CAAQ,CAC5B,CAAC,MAAD,EAASF,OAAO,CAACG,GAAjB,CAD4B,EAE5B,CAAC,QAAD,EAAWH,OAAO,CAACI,KAAnB,CAF4B,CAAR,CAAtB;IAKaC,cAAc,GAAG,SAAjBA,cAAiB,GAAM;AAAA,gBACCC,MADD;AAAA,MACdC,QADc,WAC1BC,QAD0B,CACdD,QADc;;AAElC,uDAA4BN,aAA5B,wCAA2C;AAAA;AAAA,QAA/BQ,MAA+B;AAAA,QAAvBZ,GAAuB;;AACzC,QAAIU,QAAQ,CAACG,UAAT,CAAoBD,MAApB,CAAJ,EAAiC;AAC/B,aAAOZ,GAAP;AACD;AACF;;AACD,SAAOG,OAAO,CAACW,IAAf;AACD;AAED;AACA;AACA;;IACaC,aAAa,GAAG,IAAIC,aAAJ,CAAkB,eAAlB;AAE7B;AACA;AACA;AACA;;IACaC,eAAe,GAAG,SAAlBA,eAAkB,GAAY;AACzC,MAAIf,OAAJ,EAAa;AACX,WAAO,IAAP;AACD,GAHwC;AAKzC;;;AACA,MAAMgB,aAAa,GAAGC,OAAO,CAAC,8BAAD,CAAP,WAAtB;;AACA,SAAO,IAAID,aAAJ,CAAkB;AACvBE,IAAAA,OAAO,EAAEzB,OADc;AAEvB0B,IAAAA,GAAG,EAAExB,GAFkB;AAGvByB,IAAAA,OAAO,EAAE,KAHc;AAIvB;AACAC,IAAAA,SAAS,EAAE,KALY;AAMvB;AACAC,IAAAA,WAAW,EAAE,IAPU;AAQvB;AACAC,IAAAA,QAAQ,EAAE3B,QATa;AAUvB4B,IAAAA,WAAW,EAAElB,cAAc;AAVJ,GAAlB,CAAP;AAYD;;IASKmB;;;;;;;;;;;UACIC,eAAoC;UAEpCC,SAAS;UAETC,UAAUnB,QAAQ,CAACoB;;;;;;SAE3BC,aAAA,oBAAWC,IAAX,EAAwB;AAAA,QAAbA,IAAa;AAAbA,MAAAA,IAAa,GAAN,IAAM;AAAA;;AACtB,QAAIA,IAAJ,EAAU;AACR,UAAI,CAAC,KAAKL,YAAV,EAAwB;AACtB,aAAKA,YAAL,GAAoBX,eAAe,EAAnC;AACA,aAAKW,YAAL,IAAqB,KAAKM,MAAL,CAAY,KAAKN,YAAjB,CAArB;AACD;;AACD,UAAI,CAAC,KAAKC,MAAN,IAAgB,KAAKD,YAAzB,EAAuC;AACrC;AACA,aAAKA,YAAL,CAAkBO,OAAlB,GAA4BC,OAA5B,CAAoCzB,QAAQ,CAAC0B,IAA7C;AACA,aAAKT,YAAL,CAAkBU,GAAlB,WAA8B,KAAKR,OAAnC;AACA,aAAKD,MAAL,GAAc,IAAd;AACD;AACF,KAXD,MAWO,IAAI,KAAKD,YAAT,EAAuB;AAC5B,WAAKW,MAAL,CAAY,KAAKX,YAAjB;AACA,WAAKA,YAAL,GAAoB,IAApB;AACD;AACF;;SAEDY,aAAA,oBAAWC,IAAX,EAAiB;AACf,SAAKX,OAAL,GAAeW,IAAf;AACA,WAAO,IAAP;AACD;;;EA5BkBC;;IA+BfC,MAAM,GAAG,IAAIhB,MAAJ,GAAaO,MAAb,CAAoBnB,aAApB;;;;;"}