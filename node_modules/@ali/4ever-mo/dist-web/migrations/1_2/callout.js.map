{"version":3,"sources":["../../../../src/migrations/1_2/callout.ts"],"names":["Path","equal","ColorBlocks","Heading","callout","upgrade","document","newDocument","callouts","len","nodes","length","i","first","isCallout","blocks","push","j","next","data","calloutPr","forEach","start","prevAttrs","bgcolor","backgroundColor","sticker","stickerCode","colorBlock","createColorBlocks","showstk","startPath","getPath","key","insertNode","colorBlockPath","reverse","block","from","to","link","moveNode","path","setNode","downgrade"],"mappings":"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","sourcesContent":["import { Block, Document, Path } from '@ali/4ever-cangjie';\nimport equal from 'fast-deep-equal';\nimport type { MoInterfaces } from '@ali/4ever-cangjie';\nimport { ColorBlocks } from '@ali/4ever-plugin-color-blocks';\nimport { Heading } from '@ali/4ever-plugin-heading';\nimport { MigrateAlg } from '../../type';\n\n/*         New Callout                             Old Callout        \n * ┌─────────────────────┐                    ┌─────────────────────┐\n * │    Introduction     │                    │    Introduction     │\n * └─────────────────────┘                    └─────────────────────┘\n * ┌─────────────────────┐                                           \n * │Callout              │                                           \n * │  ┌──────────────┐   │                    ┌─────────────────────┐\n * │  │   Commands   │   │                    │      Commands       │\n * │  └──────────────┘   │   ────flatten───▶  └─────────────────────┘\n * │  ┌──────────────┐   │                    ┌─────────────────────┐\n * │  │  Operations  │   │                    │     Operations      │\n * │  └──────────────┘   │   ◀────wrap─────── └─────────────────────┘\n * │  ┌──────────────┐   │                    ┌─────────────────────┐\n * │  │   Plugins    │   │                    │       Plugins       │\n * │  └──────────────┘   │                    └─────────────────────┘\n * └─────────────────────┘                                           \n * ┌─────────────────────┐                    ┌─────────────────────┐\n * │ Powered By Cangjie  │                    │ Powered By Cangjie  │\n * └─────────────────────┘                    └─────────────────────┘\n */                                                                  \nconst callout: MigrateAlg = {\n  upgrade: (document: Document) => {\n    let newDocument = document;\n\n    // 1. 获得所有老高亮块\n    const callouts: Block[][] = [];\n    const len = document.nodes.length;\n    let i = 0;\n    while (i < len) {\n      const first = document.nodes[i];\n      if (Heading.isCallout(first)) {\n        const blocks = [first];\n        callouts.push(blocks);\n        let j = i + 1;\n        while (j < len) {\n          const next = document.nodes[j];\n          if (\n            Heading.isCallout(next) &&\n            equal(next.data.calloutPr, first.data.calloutPr)\n          ) {\n            blocks.push(next);\n            j++;\n          } else {\n            break;\n          }\n        }\n        i = j;\n      } else {\n        i++;\n      }\n    }\n\n    // 2. 转换高亮块为新的高两块\n    callouts.forEach((blocks) => {\n      const start = blocks[0];\n      const prevAttrs = start.data?.calloutPr as MoInterfaces.CalloutPr.CalloutPr | undefined;\n      const { backgroundColor: bgcolor, stickerCode: sticker } =\n        prevAttrs || {};\n      // 创建高亮块容器\n      const colorBlock = ColorBlocks.createColorBlocks(\n        {\n          bgcolor,\n          sticker,\n          showstk: true,\n        },\n        [],\n      );\n      // 在原高亮块位置插入新高亮块\n      const startPath = newDocument.getPath(start.key)!;\n      newDocument = newDocument.insertNode(startPath, colorBlock);\n\n      // 将旧高亮块内容移动到新高亮块\n      const colorBlockPath = newDocument.getPath(colorBlock.key)!;\n      blocks.reverse().forEach((block) => {\n        const from = newDocument.getPath(block.key)!;\n        const to = Path.link(colorBlockPath, [0]);\n        newDocument = newDocument.moveNode(from, to);\n      });\n\n      // 删除 callout 标记，避免再被识别为高亮块\n      blocks.forEach((block) => {\n        const path = newDocument.getPath(block.key)!;\n        if (block.data?.calloutPr) {\n          const data = { ...block.data };\n          delete data.calloutPr;\n          newDocument = newDocument.setNode(path, {\n            data,\n          });\n        }\n      });\n    });\n\n    return newDocument;\n  },\n  downgrade: (document: Document) => document,\n};\n\nexport default callout;\n"],"file":"callout.js"}