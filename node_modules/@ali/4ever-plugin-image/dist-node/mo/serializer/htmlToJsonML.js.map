{"version":3,"sources":["../../../../src/mo/serializer/htmlToJsonML.ts"],"names":["name","onOpenTag","state","attrs","class","style","attrStyle","styleObj","width","attrWidth","height","attrHeight","dataWidth","dataHeight","bambooSrc","restAttrs","styleWidth","styleHeight","isBamboo","rawAttrs","parseInt","src","opacity","img","push","onCloseTag","pop","parent","peek","parentTagName","paragraphTags","append"],"mappings":";;;;;;;AAAA;;AAMA;;AACA;;eAEe;AACbA,EAAAA,IAAI,EAAE,KADO;;AAGbC,EAAAA,SAAS,CAACC,KAAD,EAAeF,IAAf,EAA6BG,KAA7B,EAAyD;AAChE;AACA,QAAIH,IAAI,KAAK,KAAT,IAAkB,+BAAeG,KAAK,EAAEC,KAAtB,CAAtB,EAAoD,OAAO,KAAP;AAEpD,UAAM;AACJC,MAAAA,KAAK,EAAEC,SADH;AAEJC,MAAAA,QAAQ,EAAEF,KAFN;AAGJG,MAAAA,KAAK,EAAEC,SAHH;AAIJC,MAAAA,MAAM,EAAEC,UAJJ;AAKJ,oBAAcC,SALV;AAMJ,qBAAeC,UANX;AAOJ,+BAAyBC,SAPrB;AAQJ,SAAGC;AARC,QASFZ,KATJ;AAWA,UAAM;AAAEK,MAAAA,KAAK,EAAEQ,UAAT;AAAqBN,MAAAA,MAAM,EAAEO;AAA7B,QAA6CZ,KAAnD,CAfgE,CAiBhE;AACA;;AACA,UAAMa,QAAQ,GAAG,CAAC,CAACJ,SAAnB;AACA,UAAMN,KAAK,GAAIU,QAAQ,IAAIN,SAAb,IAA2BI,UAA3B,IAAyCP,SAAvD;AACA,UAAMC,MAAM,GAAIQ,QAAQ,IAAIL,UAAb,IAA4BI,WAA5B,IAA2CN,UAA1D;AAEA,UAAMQ,QAAyC,GAAG,EAChD,GAAG,kBAAKJ,SAAL,EAAgB,CAAC,OAAD,EAAU,QAAV,EAAoB,KAApB,EAA2B,OAA3B,EAAoC,OAApC,EAA6C,KAA7C,CAAhB,CAD6C;AAEhDP,MAAAA,KAAK,EAAEY,QAAQ,CAACZ,KAAD,EAAQ,EAAR,CAFiC;AAGhDE,MAAAA,MAAM,EAAEU,QAAQ,CAACV,MAAD,EAAS,EAAT,CAHgC;AAIhDW,MAAAA,GAAG,EAAEP,SAAS,IAAIX,KAAK,CAACkB,GAAnB,IAA0B;AAJiB,KAAlD;;AAOA,QAAIhB,KAAK,CAACiB,OAAV,EAAmB;AACjBH,MAAAA,QAAQ,CAACG,OAAT,GAAmB,CAACjB,KAAK,CAACiB,OAA1B;AACD;;AAED,UAAMC,GAAW,GAAG,CAAC,KAAD,EAAQJ,QAAR,EAAkB,mCAAlB,CAApB;AACAjB,IAAAA,KAAK,CAACsB,IAAN,CAAWD,GAAX;AACA,WAAO,IAAP;AACD,GAxCY;;AA0CbE,EAAAA,UAAU,CAACvB,KAAD,EAAeF,IAAf,EAA6BG,KAA7B,EAAyD;AACjE,QAAIH,IAAI,KAAK,KAAT,IAAkB,+BAAeG,KAAK,EAAEC,KAAtB,CAAtB,EAAoD,OAAO,KAAP;AAEpD,UAAMmB,GAAG,GAAGrB,KAAK,CAACwB,GAAN,EAAZ;AACA,UAAMC,MAAM,GAAGzB,KAAK,CAAC0B,IAAN,EAAf;AACA,UAAMC,aAAa,GAAG,2BAAWF,MAAX,CAAtB;;AACA,QAAI,CAACG,yBAAcD,aAAd,CAAD,IAAiCA,aAAa,KAAK,GAAvD,EAA4D;AAC1D3B,MAAAA,KAAK,CAAC6B,MAAN,CAAa,CAAC,GAAD,EAAM,mCAAN,EAAyBR,GAAzB,EAA8B,mCAA9B,CAAb;AACD,KAFD,MAEO;AACLrB,MAAAA,KAAK,CAAC6B,MAAN,CAAaR,GAAb;AACD;;AACD,WAAO,IAAP;AACD;;AAtDY,C","sourcesContent":["import {\n  JsonML,\n  getTagName,\n  isEmojiClsName,\n  paragraphTags,\n} from '@ali/4ever-utils';\nimport { pick } from 'lodash-es';\nimport { MoState as State, MoAttributes as Attributes, createEmptyText } from '@ali/4ever-cangjie';\n\nexport default {\n  name: 'img',\n\n  onOpenTag(state: State, name: string, attrs: Attributes): boolean {\n    // 防止误解析来自 IM 的表情\n    if (name !== 'img' || isEmojiClsName(attrs?.class)) return false;\n\n    const {\n      style: attrStyle,\n      styleObj: style,\n      width: attrWidth,\n      height: attrHeight,\n      'data-width': dataWidth,\n      'data-height': dataHeight,\n      'data-4ever-bamboo-src': bambooSrc,\n      ...restAttrs\n    } = attrs;\n\n    const { width: styleWidth, height: styleHeight } = style;\n\n    // 宽度取值优先级：dataWidth(存在 boambooSrc 时) > styleWidth > attrWidth\n    // 高度同理\n    const isBamboo = !!bambooSrc;\n    const width = (isBamboo && dataWidth) || styleWidth || attrWidth;\n    const height = (isBamboo && dataHeight) || styleHeight || attrHeight;\n\n    const rawAttrs: Record<string, string | number> = {\n      ...pick(restAttrs, ['width', 'height', 'src', 'style', 'title', 'alt']),\n      width: parseInt(width, 10),\n      height: parseInt(height, 10),\n      src: bambooSrc || attrs.src || '',\n    };\n\n    if (style.opacity) {\n      rawAttrs.opacity = +style.opacity;\n    }\n\n    const img: JsonML = ['img', rawAttrs, createEmptyText()] as JsonML;\n    state.push(img);\n    return true;\n  },\n\n  onCloseTag(state: State, name: string, attrs: Attributes): boolean {\n    if (name !== 'img' || isEmojiClsName(attrs?.class)) return false;\n\n    const img = state.pop();\n    const parent = state.peek();\n    const parentTagName = getTagName(parent);\n    if (!paragraphTags[parentTagName] && parentTagName !== 'a') {\n      state.append(['p', createEmptyText(), img, createEmptyText()]);\n    } else {\n      state.append(img);\n    }\n    return true;\n  },\n};\n"],"file":"htmlToJsonML.js"}