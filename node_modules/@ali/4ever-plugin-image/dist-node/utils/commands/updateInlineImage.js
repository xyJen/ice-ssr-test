"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = updateInlineImage;

var _everCangjie = require("@ali/4ever-cangjie");

var _aslService = require("../utils/aslService");

const injectionKeys = ['isImageCropping', 'uploadPercent', 'isError', 'isSettingBorder'];

function updateInlineImage(controller, image, data, container) {
  if (!image) {
    return controller;
  }

  const {
    document
  } = controller.value;
  const path = document.getPath(image.key);
  const node = document.getNodeByPath(path);
  if (!node) return controller;
  const newData = { ...node?.data,
    ...data
  };
  injectionKeys.forEach(key => {
    delete newData[key];
  }); // 更新 rotation 的时候，若宽或高未落库，会影响后续计算

  if (!(0, _aslService.isValidSize)(newData.width, newData.height) && data.rotation > 0) {
    const root = container ?? _everCangjie.domUtils.findDOMNodeSafely(controller.value.document.key);

    const img = _everCangjie.domUtils.findDOMNodeSafely(image.key, root);

    newData.width = img?.clientWidth;
    newData.height = img?.clientHeight;
  }

  return controller.command(_everCangjie.Commands.setNodeByKey, image.key, {
    data: newData
  });
}
//# sourceMappingURL=updateInlineImage.js.map