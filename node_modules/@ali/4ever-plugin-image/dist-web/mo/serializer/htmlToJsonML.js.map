{"version":3,"sources":["../../../../src/mo/serializer/htmlToJsonML.ts"],"names":["getTagName","isEmojiClsName","paragraphTags","pick","createEmptyText","name","onOpenTag","state","attrs","attrStyle","style","styleObj","attrWidth","width","attrHeight","height","dataWidth","dataHeight","bambooSrc","restAttrs","styleWidth","styleHeight","isBamboo","rawAttrs","parseInt","src","opacity","img","push","onCloseTag","pop","parent","peek","parentTagName","append"],"mappings":"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","sourcesContent":["import {\n  JsonML,\n  getTagName,\n  isEmojiClsName,\n  paragraphTags,\n} from '@ali/4ever-utils';\nimport { pick } from 'lodash-es';\nimport { MoState as State, MoAttributes as Attributes, createEmptyText } from '@ali/4ever-cangjie';\n\nexport default {\n  name: 'img',\n\n  onOpenTag(state: State, name: string, attrs: Attributes): boolean {\n    // 防止误解析来自 IM 的表情\n    if (name !== 'img' || isEmojiClsName(attrs?.class)) return false;\n\n    const {\n      style: attrStyle,\n      styleObj: style,\n      width: attrWidth,\n      height: attrHeight,\n      'data-width': dataWidth,\n      'data-height': dataHeight,\n      'data-4ever-bamboo-src': bambooSrc,\n      ...restAttrs\n    } = attrs;\n\n    const { width: styleWidth, height: styleHeight } = style;\n\n    // 宽度取值优先级：dataWidth(存在 boambooSrc 时) > styleWidth > attrWidth\n    // 高度同理\n    const isBamboo = !!bambooSrc;\n    const width = (isBamboo && dataWidth) || styleWidth || attrWidth;\n    const height = (isBamboo && dataHeight) || styleHeight || attrHeight;\n\n    const rawAttrs: Record<string, string | number> = {\n      ...pick(restAttrs, ['width', 'height', 'src', 'style', 'title', 'alt']),\n      width: parseInt(width, 10),\n      height: parseInt(height, 10),\n      src: bambooSrc || attrs.src || '',\n    };\n\n    if (style.opacity) {\n      rawAttrs.opacity = +style.opacity;\n    }\n\n    const img: JsonML = ['img', rawAttrs, createEmptyText()] as JsonML;\n    state.push(img);\n    return true;\n  },\n\n  onCloseTag(state: State, name: string, attrs: Attributes): boolean {\n    if (name !== 'img' || isEmojiClsName(attrs?.class)) return false;\n\n    const img = state.pop();\n    const parent = state.peek();\n    const parentTagName = getTagName(parent);\n    if (!paragraphTags[parentTagName] && parentTagName !== 'a') {\n      state.append(['p', createEmptyText(), img, createEmptyText()]);\n    } else {\n      state.append(img);\n    }\n    return true;\n  },\n};\n"],"file":"htmlToJsonML.js"}