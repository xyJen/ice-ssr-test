var cnPattern = new RegExp("[\u4E00-\u9FA5]+");

function getMaxString(str, maxTextLength) {
  if (maxTextLength === void 0) {
    maxTextLength = 32;
  }

  if (!str) return '';
  var count = 0;
  var tmp = ''; // eslint-disable-next-line no-plusplus

  for (var i = 0; i < str.length; i++) {
    if (cnPattern.test(str[i])) {
      count += 2;
    } else {
      count += 1;
    }

    if (count > maxTextLength) {
      return tmp.slice(0, maxTextLength) + "...";
    }

    tmp += str[i];
  }

  return tmp;
}

export var generateWatermark = function generateWatermark(params, format) {
  var _params$markStyle = params.markStyle,
      markStyle = _params$markStyle === void 0 ? {} : _params$markStyle,
      _params$nickName = params.nickName,
      nickName = _params$nickName === void 0 ? '' : _params$nickName,
      _params$orgName = params.orgName,
      orgName = _params$orgName === void 0 ? '' : _params$orgName,
      maxTextLength = params.maxTextLength;
  var _markStyle$width = markStyle.width,
      width = _markStyle$width === void 0 ? 256 : _markStyle$width,
      _markStyle$height = markStyle.height,
      height = _markStyle$height === void 0 ? 300 : _markStyle$height,
      color = markStyle.color,
      _markStyle$fontSize = markStyle.fontSize,
      fontSize = _markStyle$fontSize === void 0 ? 10 : _markStyle$fontSize;
  var ratio = Math.min(3, window.devicePixelRatio || 1);
  var canvas = document.createElement('canvas');
  canvas.width = width * ratio;
  canvas.height = height * ratio;
  var ctx = canvas.getContext('2d');

  if (ctx) {
    ctx.font = fontSize * ratio + "pt 'PingFang SC','Hiragino Sans GB','Microsoft YaHei','Helvetica Neue',Helvetica,Arial,sans-serif";
    var watermarkNickName = getMaxString(nickName, maxTextLength);
    var watermarkOrgName = getMaxString(orgName, maxTextLength);
    ctx.fillStyle = color || 'rgb(25,31,37)';
    var nameMeasure = ctx.measureText(watermarkNickName);
    ctx.translate(8 * ratio, canvas.height * 0.5);
    ctx.rotate(-Math.PI / 6);
    ctx.fillText(watermarkOrgName, 0, 0);
    ctx.rotate(Math.PI / 6);
    ctx.translate((canvas.width / 2 - nameMeasure.width / 2 - 8 * ratio) * 1.08, (canvas.height * 0.24 + nameMeasure.width / 4) * 1.08);
    ctx.rotate(-Math.PI / 6);
    ctx.fillText(watermarkNickName || '', 0, 0);
  }

  if (format === 'canvas') {
    return canvas;
  }

  return canvas.toDataURL();
};