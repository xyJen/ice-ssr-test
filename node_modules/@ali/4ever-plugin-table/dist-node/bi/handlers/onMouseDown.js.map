{"version":3,"sources":["../../../../src/bi/handlers/onMouseDown.ts"],"names":["onKeyDown","event","controller","next","button","document","selection","value","isCollapsed","target","td","closest","cellKey","getAttribute","targetCell","getNode","start","end","sort","startCell","getClosest","key","TableCell","isTableCell","endCell","targetCellPath","getPath","startCellPath","endCellPath","Path","compare","preventDefault"],"mappings":";;;;;;;;;AAAA;;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACe,SAASA,SAAT,CACbC,KADa,EAEbC,UAFa,EAGbC,IAHa,EAIb;AACA,MAAIF,KAAK,CAACG,MAAN,KAAiB,CAArB,EAAwB;AACtB,WAAOD,IAAI,EAAX;AACD;;AACD,QAAM;AAAEE,IAAAA,QAAF;AAAYC,IAAAA;AAAZ,MAA0BJ,UAAU,CAACK,KAA3C;;AACA,MAAID,SAAS,CAACE,WAAd,EAA2B;AACzB,WAAOL,IAAI,EAAX;AACD;;AACD,QAAM;AAAEM,IAAAA;AAAF,MAAaR,KAAnB;AACA,QAAMS,EAAE,GAAID,MAAD,EAAyBE,OAAzB,CAAiC,IAAjC,CAAX;;AACA,MAAI,CAACD,EAAL,EAAS;AACP,WAAOP,IAAI,EAAX;AACD;;AACD,QAAMS,OAAO,GAAGF,EAAE,CAACG,YAAH,CAAgB,kBAAhB,CAAhB;;AACA,MAAI,CAACD,OAAL,EAAc;AACZ,WAAOT,IAAI,EAAX;AACD;;AACD,QAAMW,UAAU,GAAGT,QAAQ,CAACU,OAAT,CAAiBH,OAAjB,CAAnB;AAEA,QAAM;AAAEI,IAAAA,KAAF;AAASC,IAAAA;AAAT,MAAiBX,SAAS,CAACY,IAAV,CAAeb,QAAf,CAAvB;AACA,QAAMc,SAAS,GAAGd,QAAQ,CAACe,UAAT,CAAoBJ,KAAK,CAACK,GAA1B,EAA+BC,mBAAUC,WAAzC,CAAlB;AACA,QAAMC,OAAO,GAAGnB,QAAQ,CAACe,UAAT,CAAoBH,GAAG,CAACI,GAAxB,EAA6BC,mBAAUC,WAAvC,CAAhB;;AAEA,MAAI,CAACT,UAAD,IAAe,CAACK,SAAhB,IAA6B,CAACK,OAAlC,EAA2C;AACzC,WAAOrB,IAAI,EAAX;AACD;;AAED,QAAMsB,cAAc,GAAGpB,QAAQ,CAACqB,OAAT,CAAiBZ,UAAU,CAACO,GAA5B,CAAvB;AACA,QAAMM,aAAa,GAAGtB,QAAQ,CAACqB,OAAT,CAAiBP,SAAS,CAACE,GAA3B,CAAtB;AACA,QAAMO,WAAW,GAAGvB,QAAQ,CAACqB,OAAT,CAAiBF,OAAO,CAACH,GAAzB,CAApB;;AACA,MACEQ,kBAAKC,OAAL,CAAaL,cAAb,EAA6BE,aAA7B,KAAgD,CAAhD,IACAE,kBAAKC,OAAL,CAAaL,cAAb,EAA6BG,WAA7B,KAA8C,CAFhD,EAGE;AACA3B,IAAAA,KAAK,CAAC8B,cAAN;AACA;AACD;;AAED,SAAO5B,IAAI,EAAX;AACD","sourcesContent":["import { Controller, Path } from '@ali/4ever-cangjie';\nimport TableCell from '../../mo/models/tableCell';\n\n// 问题描述：\n// 1. 存在表格选区时\n// 2. 如果鼠标右键点击位置不在 selection.anchor、selection.focus 之间\n//    但是点击在 anchor 或 focus 所在的单元格时\n// 3. Cangjie 会\b focus 在点击位置，导致表格选区消失\n// 解法：\n// 拦截 Cangjie onMouseDown 默认事件\nexport default function onKeyDown(\n  event: React.MouseEvent,\n  controller: Controller,\n  next,\n) {\n  if (event.button !== 2) {\n    return next();\n  }\n  const { document, selection } = controller.value;\n  if (selection.isCollapsed) {\n    return next();\n  }\n  const { target } = event;\n  const td = (target as HTMLElement)?.closest('td');\n  if (!td) {\n    return next();\n  }\n  const cellKey = td.getAttribute('data-cangjie-key');\n  if (!cellKey) {\n    return next();\n  }\n  const targetCell = document.getNode(cellKey);\n\n  const { start, end } = selection.sort(document);\n  const startCell = document.getClosest(start.key, TableCell.isTableCell);\n  const endCell = document.getClosest(end.key, TableCell.isTableCell);\n\n  if (!targetCell || !startCell || !endCell) {\n    return next();\n  }\n\n  const targetCellPath = document.getPath(targetCell.key)!;\n  const startCellPath = document.getPath(startCell.key)!;\n  const endCellPath = document.getPath(endCell.key)!;\n  if (\n    Path.compare(targetCellPath, startCellPath)! >= 0 &&\n    Path.compare(targetCellPath, endCellPath)! <= 0\n  ) {\n    event.preventDefault();\n    return;\n  }\n\n  return next();\n}\n"],"file":"onMouseDown.js"}