"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = onArrowDown;

var _everCangjie = require("@ali/4ever-cangjie");

var _models = _interopRequireDefault(require("../../mo/models"));

var _tableCell = _interopRequireDefault(require("../../mo/models/tableCell"));

var _isSelectionInTableCell = _interopRequireDefault(require("../utils/isSelectionInTableCell"));

var _getPositionOfCell = _interopRequireDefault(require("../utils/getPositionOfCell"));

var _types = require("../types");

var _selectionCommands = require("../utils/selectionCommands");

var _getNextVisibleCell = _interopRequireDefault(require("../utils/getNextVisibleCell"));

var _setSelectionByTable = _interopRequireDefault(require("../../utils/utils/setSelectionByTable"));

function onArrowDown(event, controller, next) {
  const {
    value
  } = controller;
  const {
    document,
    selection,
    startBlock
  } = value;
  const tableSelection = controller.query('tableSelection');

  if (tableSelection) {
    event.preventDefault();
    const table = document.getNode(tableSelection.key);

    if (!table) {
      return;
    }

    if (controller.query('isSelectWholeTable', {
      node: table
    })) {
      return (0, _selectionCommands.moveToStartOfNextSibling)(controller, table);
    }

    const {
      startColIndex,
      endRowIndex
    } = tableSelection;
    return (0, _selectionCommands.moveToStartOfCell)(controller, table, endRowIndex + 1, startColIndex);
  }

  if (!(0, _isSelectionInTableCell.default)(value)) {
    return next();
  }

  const cell = document.getClosest(startBlock.key, _types.isTableCell);

  if (!cell) {
    return next();
  }

  const focusTable = document.getClosest(cell.key, _models.default.isTable);
  const position = (0, _getPositionOfCell.default)(cell.key, focusTable);

  if (position.rowIndex === focusTable.nodes.length - 1) {
    return next();
  }

  const newSelection = controller.query(_everCangjie.Queries.getDownsideRange);

  if (!newSelection) {
    return next();
  }

  const {
    anchor
  } = newSelection;
  const newFocusCell = document.getClosest(anchor.key, _tableCell.default.isTableCell); // 向下移动后，仍是同一个 cell 则不处理

  if (newFocusCell?.key === cell.key) {
    return next();
  }

  const nextCell = (0, _getNextVisibleCell.default)(document, cell, 'down');

  if (!nextCell) {
    return next();
  }

  event.preventDefault();
  const s = selection.moveToStartOfNode(nextCell, controller);
  return controller.command(_everCangjie.Commands.select, (0, _setSelectionByTable.default)(s, false));
}
//# sourceMappingURL=onArrowDown.js.map