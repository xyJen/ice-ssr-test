{"version":3,"sources":["../../../../src/bi/handlers/onDelete.ts"],"names":["isBackspaceHotKey","isDeleteHotKey","onDelete","event","controller","next","value","selection","document","startBlock","endBlock","tableSelection","query","preventDefault","table","getNode","key","isSelectWholeTable","node","run","edgeSelection","data","edge","isExpanded","startCell","getClosest","TableCell","isTableCell","isDeleteKey","isBackspaceKey","anchor","isElement","nodes","length","parent","getParent","insertPoint","EdgePoint","create","BEFORE","command","Commands","insertEmptyBlock","removeNodeByKey","endCell","block","getClosestBlock","isCollapsed","moveToStartOfNextBlock","backwardPoint","Queries","pointAtDistance","getStart","backwardCell","n","forwardPoint","getEnd","forwardCell","nextBlock","getNextSibling","type","isAtEndOfNode"],"mappings":"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","sourcesContent":["import { Block, Commands, Controller, EdgePoint, Queries } from '@ali/4ever-cangjie';\nimport { isEmptyParagraph } from '@ali/4ever-utils';\nimport Table from '../../mo/models';\nimport TableCell from '../../mo/models/tableCell';\nimport emptyTableSelection from '../commands/emptyTableSelection';\nimport deleteTable from '../commands/deleteTable';\nimport selectWholeTable from '../commands/selectWholeTable';\nimport { isKeyHotkey } from 'is-hotkey';\n\nconst isBackspaceHotKey = isKeyHotkey('backspace');\nconst isDeleteHotKey = isKeyHotkey('delete');\n\nexport default function onDelete(event, controller: Controller, next) {\n  const { value } = controller;\n  const { selection, document, startBlock, endBlock } = value;\n\n  const tableSelection = controller.query('tableSelection');\n  if (tableSelection) {\n    event.preventDefault();\n    const table = document.getNode(tableSelection.key) as Table;\n\n    if (table) {\n      const isSelectWholeTable = controller.query('isSelectWholeTable', {\n        node: table,\n      });\n      if (isSelectWholeTable) {\n        // @ts-ignore\n        return controller.run('onAction', deleteTable(controller, table));\n      }\n      // 删除选区内容而非其他东西\n      return emptyTableSelection(controller, table);\n    }\n    return controller;\n  }\n\n  const edgeSelection = value.data.edgeSelection;\n  if (edgeSelection) {\n    const table = document.getNode(edgeSelection.key);\n    if (edgeSelection.edge === 'before' && isDeleteHotKey(event)) {\n      // @ts-ignore\n      return controller.run('onAction', selectWholeTable(controller, table));\n    } else if (edgeSelection.edge === 'after' && isBackspaceHotKey(event)) {\n      // @ts-ignore\n      return controller.run('onAction', selectWholeTable(controller, table));\n    }\n    return controller;\n  }\n\n  if (!selection || selection.isExpanded) return next();\n\n  const startCell = startBlock ?\n    document.getClosest(startBlock.key, TableCell.isTableCell) as TableCell :\n    null;\n  const isDeleteKey = isDeleteHotKey(event);\n  const isBackspaceKey = isBackspaceHotKey(event);\n  const { anchor } = selection;\n\n  // 删除时，如果单元格内只有一个 void 元素，进行特殊处理\n  if (\n    startCell?.isElement() &&\n    startCell.nodes.length === 1\n  ) {\n    const parent = document.getParent(anchor.key);\n    if (parent === startCell.nodes[0] && controller.query('isVoid', parent)) {\n      const insertPoint = EdgePoint.create({\n        key: parent.key,\n        edge: EdgePoint.BEFORE,\n      });\n      return controller\n        .command(Commands.insertEmptyBlock, insertPoint)\n        .command(Commands.removeNodeByKey, parent.key);\n    }\n  }\n\n  const endCell = endBlock ?\n    document.getClosest(endBlock.key, TableCell.isTableCell) as TableCell :\n    null;\n\n  // 左移试探，发现移到其他单元格，则会删出问题，阻止\n  if (startCell && isBackspaceKey) {\n    const block = document.getClosestBlock(anchor.key);\n    if (\n      selection.isCollapsed &&\n      startCell.nodes.length !== 1 &&\n      startCell.nodes[0] === block &&\n      isEmptyParagraph(block)\n    ) {\n      return controller\n        .command(Commands.removeNodeByKey, block.key)\n        .command(Commands.moveToStartOfNextBlock);\n    }\n    const backwardPoint = controller.query(\n      Queries.pointAtDistance,\n      selection.getStart(document),\n      -1,\n    );\n    const backwardCell = backwardPoint?.key &&\n      document.getClosest(backwardPoint.key, n => n.key === startCell.key);\n\n    if (!backwardCell) {\n      event.preventDefault();\n      return controller;\n    }\n  }\n\n  if (endCell && isDeleteKey) {\n    const block = document.getClosestBlock(anchor.key);\n    if (\n      selection.isCollapsed &&\n      endCell.nodes.length !== 1 &&\n      endCell.nodes[0] === block &&\n      isEmptyParagraph(block)\n    ) {\n      return controller\n        .command(Commands.removeNodeByKey, block.key)\n        .command(Commands.moveToStartOfNextBlock);\n    }\n    const forwardPoint = controller.query(\n      Queries.pointAtDistance,\n      selection.getEnd(document),\n      1,\n    );\n    const forwardCell = forwardPoint?.key &&\n      document.getClosest(forwardPoint.key, n => n.key === endCell.key);\n\n    if (!forwardCell) {\n      event.preventDefault();\n      return controller;\n    }\n  }\n\n  const nextBlock = document.getNextSibling(endBlock?.key!) as Block;\n  if (\n    nextBlock\n    && nextBlock.type === 'table'\n    && selection.getEnd(document).isAtEndOfNode(endBlock!)\n    && isDeleteHotKey(event)\n  ) {\n    event.preventDefault();\n\n    // @ts-ignore\n    return controller.run('onAction', selectWholeTable(controller, nextBlock));\n  }\n\n  return next();\n}\n"],"file":"onDelete.js"}