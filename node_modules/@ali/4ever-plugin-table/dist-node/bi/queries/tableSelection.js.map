{"version":3,"sources":["../../../../src/bi/queries/tableSelection.ts"],"names":["TABLE_SELECTION_CACHE","WeakMap","setCache","key","value","set","tableSelection","controller","has","get","document","selection","anchor","focus","data","isByTable","anchorCell","getClosest","TableCell","isTableCell","anchorTable","Table","isTable","focusCell","focusTable","node","tableKey","startPosition","endPosition","minRowIndex","Math","min","rowIndex","maxRowIndex","max","minColIndex","colIndex","maxColIndex","result","startRowIndex","endRowIndex","startColIndex","endColIndex","tbSelection"],"mappings":"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","sourcesContent":["import { Controller, Value } from '@ali/4ever-cangjie';\nimport Table from '../../mo/models';\nimport TableCell from '../../mo/models/tableCell';\nimport { ITableSelection } from '../types';\nimport { adjustSelection, getPositionOfCell } from '../utils';\nimport isTableFromSameOrigin from './isTableFromSameOrigin';\n\ntype TABLE_SELECTION_TYPE = ITableSelection | null;\n\nconst TABLE_SELECTION_CACHE = new WeakMap<Value, TABLE_SELECTION_TYPE>();\n\nfunction setCache(key: Value, value: TABLE_SELECTION_TYPE) {\n  TABLE_SELECTION_CACHE.set(key, value);\n}\n\nexport default function tableSelection(controller: Controller) {\n  const { value } = controller;\n  if (TABLE_SELECTION_CACHE.has(value)) {\n    return TABLE_SELECTION_CACHE.get(value);\n  }\n\n  const { document, selection } = value;\n  const { anchor, focus, data } = selection;\n  const { isByTable } = data;\n  const anchorCell = document.getClosest(anchor.key, TableCell.isTableCell);\n  if (!anchorCell) {\n    setCache(value, null);\n    return null;\n  }\n  const anchorTable = document.getClosest(\n    anchorCell.key,\n    Table.isTable,\n  )! as Table;\n\n  const focusCell = document.getClosest(focus.key, TableCell.isTableCell);\n  if (\n    !focusCell ||\n    (\n      !isByTable &&\n      anchorCell.key === focusCell.key\n    )\n  ) {\n    setCache(value, null);\n    return null;\n  }\n  const focusTable = document.getClosest(\n    focusCell.key,\n    Table.isTable,\n  )! as Table;\n  // 处理从嵌套表格拖动到外层表格的情况\n  if (!isTableFromSameOrigin(\n    controller,\n    {\n      node: anchorTable,\n      tableKey: focusTable.key,\n    },\n  )) {\n    setCache(value, null);\n    return null;\n  }\n  const startPosition = getPositionOfCell(anchorCell.key, anchorTable)!;\n  const endPosition = getPositionOfCell(focusCell.key, anchorTable)!;\n  if (!startPosition || !endPosition) {\n    return null;\n  }\n  const minRowIndex = Math.min(startPosition.rowIndex, endPosition.rowIndex);\n  const maxRowIndex = Math.max(startPosition.rowIndex, endPosition.rowIndex);\n  const minColIndex = Math.min(startPosition.colIndex, endPosition.colIndex);\n  const maxColIndex = Math.max(startPosition.colIndex, endPosition.colIndex);\n  const result = {\n    startRowIndex: minRowIndex,\n    endRowIndex: maxRowIndex,\n    startColIndex: minColIndex,\n    endColIndex: maxColIndex,\n    key: anchorTable.key,\n  };\n\n  const tbSelection = isByTable !== true ? adjustSelection(focusTable, result) : result;\n\n  TABLE_SELECTION_CACHE.set(value, tbSelection);\n\n  return tbSelection;\n}\n"],"file":"tableSelection.js"}