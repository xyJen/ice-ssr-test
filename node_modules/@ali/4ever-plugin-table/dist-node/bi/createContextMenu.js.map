{"version":3,"sources":["../../../src/bi/createContextMenu.ts"],"names":["isCutAllowed","controller","document","selection","value","isExpanded","anchor","focus","hasTableSelection","query","isAnchorInCell","key","isFocusInCell","anchorCell","getClosest","isTableCell","focusCell","isCopyAllowed","createContextMenu","contextMenuPlugin","pluginConfig","locale","contextMenu","next","menus","focusBlock","table","type","isTable","data","sr","queryTbSelection","isSelectionSupportMerge","visible","node","isSelectionSupportSplit","colsWidth","endColIndex","nodes","length","targetColIndex","rightColWidth","leftColWidth","startColIndex","disableInsertRowAbove","startRowIndex","Table","isRowHeader","disableInsertColLeft","isColumnHeader","push","name","contextMenuMerge","action","options","disable","group","mobile","contextMenuSplit","contextMenuInsertAbove","contextMenuInsertBelow","contextMenuInsertLeft","contextMenuInsertRight","contextMenuDeleteRow","contextMenuDeleteCol","contextMenuDeleteTable","others","map","contextMenuItem","concat"],"mappings":"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","sourcesContent":["import {\n  Controller,\n  ContextMenuItem,\n} from '@ali/4ever-cangjie';\n\nimport { isTable, isTableCell } from './types';\nimport {\n  mergeTableCells,\n  splitTableCell,\n  insertTableRowBySelections,\n  insertTableCol,\n  deleteTableCols,\n  deleteTableRows,\n  deleteTable,\n} from './actions';\nimport createTableSelectionForFocusedCell from './utils/createTableSelectionForFocusedCell';\nimport { isKeyInCell } from './queries/canInsertTable';\nimport getDataTableSelectionByTable from './utils/getDataTableSelectionByTable';\nimport Table from '../mo/models';\n\nfunction isCutAllowed(controller: Controller) {\n  const { document, selection } = controller.value;\n  const { isExpanded, anchor, focus } = selection;\n  // 选区中全部是单元格, 允许剪切\n  const hasTableSelection = controller.query('hasTableSelection');\n  if (hasTableSelection) return true;\n  const isAnchorInCell = isKeyInCell(document, anchor.key);\n  const isFocusInCell = isKeyInCell(document, focus.key);\n  if (isAnchorInCell || isFocusInCell) {\n    const anchorCell = document.getClosest(anchor.key, isTableCell);\n    const focusCell = document.getClosest(focus.key, isTableCell);\n    // 选中同一个单元格内的内容时， 允许剪切\n    return isExpanded && anchorCell?.key === focusCell?.key;\n  }\n  return true;\n}\n\nfunction isCopyAllowed(controller: Controller) {\n  return controller.query('hasTableSelection');\n}\n\nexport default function createContextMenu() {\n  return function contextMenuPlugin(pluginConfig) {\n    const { locale = {} } = pluginConfig;\n    return function contextMenu(\n      controller: Controller,\n      next: () => ContextMenuItem[] | null,\n    ) {\n      const menus: ContextMenuItem[] = [];\n      const { value } = controller;\n      const { document, focusBlock } = value;\n      const table = focusBlock?.key && (focusBlock?.type === 'table' ? focusBlock : document.getClosest(focusBlock.key, isTable)) as Table;\n      if (table && !table.data.sr) {\n        const queryTbSelection = getDataTableSelectionByTable(controller, table);\n        const isSelectionSupportMerge = controller.query('isSelectionSupportMerge', { visible: true, node: table });\n        const isSelectionSupportSplit = controller.query('isSelectionSupportSplit', { visible: true, node: table });\n\n        const selection = queryTbSelection || createTableSelectionForFocusedCell(value, table);\n        if (selection && table.data?.colsWidth) {\n          const endColIndex: number = selection\n            ? selection.endColIndex\n            : table!.nodes[0].nodes.length - 1;\n          const targetColIndex = endColIndex + 1;\n          const rightColWidth = table.data.colsWidth[endColIndex];\n          const leftColWidth = table.data.colsWidth[selection.startColIndex];\n\n          const disableInsertRowAbove = selection.startRowIndex === 0 && Table.isRowHeader(table);\n          const disableInsertColLeft = selection.startColIndex === 0 && Table.isColumnHeader(table);\n\n          menus.push({\n            name: locale.contextMenuMerge,\n            action: mergeTableCells(table),\n            key: 'merge-cells',\n            options: {\n              disable: !isSelectionSupportMerge,\n              group: 3,\n              mobile: false,\n            },\n          }, {\n            name: locale.contextMenuSplit,\n            action: splitTableCell(table),\n            key: 'split-cell',\n            options: {\n              disable: !isSelectionSupportSplit,\n              group: 3,\n              mobile: false,\n            },\n          }, {\n            name: locale.contextMenuInsertAbove,\n            action: insertTableRowBySelections(table, 'insert-row-above'),\n            key: 'insert-row-above',\n            options: {\n              disable: disableInsertRowAbove,\n              group: 4,\n              mobile: false,\n            },\n          }, {\n            name: locale.contextMenuInsertBelow,\n            action: insertTableRowBySelections(table, 'insert-row-below'),\n            key: 'insert-row-below',\n            options: {\n              group: 4,\n              mobile: false,\n            },\n          }, {\n            name: locale.contextMenuInsertLeft,\n            action: insertTableCol(\n              table,\n              selection.startColIndex,\n              selection.startColIndex,\n              leftColWidth,\n            ),\n            key: 'insert-col-left',\n            options: {\n              disable: disableInsertColLeft,\n              group: 4,\n              mobile: false,\n            },\n          }, {\n            name: locale.contextMenuInsertRight,\n            action: insertTableCol(table, targetColIndex, endColIndex, rightColWidth),\n            key: 'insert-col-right',\n            options: {\n              group: 4,\n              mobile: false,\n            },\n          }, {\n            name: locale.contextMenuDeleteRow,\n            action: deleteTableRows(table),\n            key: 'delete-rows',\n            options: {\n              group: 5,\n              mobile: false,\n            },\n          }, {\n            name: locale.contextMenuDeleteCol,\n            action: deleteTableCols(table),\n            key: 'delete-cols',\n            options: {\n              group: 5,\n              mobile: false,\n            },\n          }, {\n            name: locale.contextMenuDeleteTable,\n            action: deleteTable(table),\n            key: 'delete-table',\n            options: {\n              group: 5,\n              mobile: false,\n            },\n          });\n        }\n      }\n      let others = next() || [];\n      others = others.map((contextMenuItem) => {\n        // 选区中包含表格的部分单元格时, 不允许剪切\n        if (contextMenuItem.key === 'cut' && !isCutAllowed(controller) && contextMenuItem.options) {\n          contextMenuItem.options.disable = true;\n        }\n        // 有表格选区时允许复制\n        if (contextMenuItem.key === 'copy' && isCopyAllowed(controller) && contextMenuItem.options) {\n          contextMenuItem.options.disable = false;\n        }\n        return contextMenuItem;\n      });\n      return menus.concat(others);\n    };\n  };\n}\n"],"file":"createContextMenu.js"}