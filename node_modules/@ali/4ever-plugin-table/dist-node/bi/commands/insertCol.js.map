{"version":3,"sources":["../../../../src/bi/commands/insertCol.ts"],"names":["insertCol","controller","table","targetColIndex","triggerColIndex","colWidth","containerWidth","value","document","tablePath","getPath","key","withoutNormalizing","rowIndex","finalIndex","triggerCell","originalCell","data","triggerCellData","bdr","fill","hidden","realNode","position","colIndex","command","Commands","setNodeByPath","colSpan","insertNodeByPath","colsWidth","originalTotalColsWidth","reduce","acc","curr","refColIndex","length","refColWidth","splice","totalColsWidth","Table","isAutofitWidth","newTable","getNodeByPath","containerW","updatedDoc","updatedTbl","latestTable","focusCell","s","selection","select","moveToStartOfNode"],"mappings":"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","sourcesContent":["import { Controller, Commands } from '@ali/4ever-cangjie';\nimport Table from '../../mo/models';\nimport createEmptyTableCell from '../utils/createEmptyTableCell';\nimport getRealNodeInTable from '../utils/getRealNodeInTable';\nimport getPositionOfCell from '../utils/getPositionOfCell';\nimport traverseSingleColCells from '../utils/traverseSingleColCells';\nimport resizeTableWidthFitContainer from './resizeTableWidthFitContainer';\nimport getVisibleCellOfCol from '../utils/getVisibleCellOfCol';\nimport setTableColsWidth from '../utils/setTableColsWidth';\nimport setSelectionByTable from '../../utils/utils/setSelectionByTable';\nimport resizeTableToAutofitWidth from './resizeTableToAutofitWidth';\nimport getTableMaxWidthByContainer from '../../utils/utils/getTableMaxWidthByContainer';\n\nexport default function insertCol(\n  controller: Controller,\n  table: Table,\n  targetColIndex: number,\n  triggerColIndex: number,\n  colWidth?: number,\n  containerWidth?: number,\n) {\n  const { value } = controller;\n  const { document } = value;\n  const tablePath = document.getPath(table.key);\n\n  controller.withoutNormalizing(() => {\n    traverseSingleColCells(table, targetColIndex, triggerColIndex, (rowIndex, finalIndex, triggerCell, originalCell) => {\n      const data = {} as any;\n      // triggerCell: 右键在哪个上面哪个就是triggerCell\n      // originalCell: 插入后新行的index，放在之前表格取的值，就是originalCell(可能不存在)\n      if (triggerCell) {\n        const triggerCellData = triggerCell.data;\n        if (triggerCellData && triggerCellData.bdr) {\n          data.bdr = triggerCellData.bdr;\n        }\n        if (triggerCellData && triggerCellData.fill) {\n          data.fill = triggerCellData.fill;\n        }\n      }\n      // 一种策略，originalCell是插入新列位置对应的原来的节点\n      // 这个节点如果处在realNode所在列后面的列(非同列)，那在这个位置上的新节点就会设置为hidden\n      // 同时比较rowIndex以保证realNode的colSpan只被拓充一次\n      if (originalCell && originalCell.data.hidden) {\n        const realNode = getRealNodeInTable(table, rowIndex, finalIndex);\n        if (realNode) {\n          const position = getPositionOfCell(realNode.key, table)!;\n          if (position.colIndex !== finalIndex) {\n            data.hidden = true;\n          }\n          if (position.rowIndex === rowIndex) {\n            controller.command(Commands.setNodeByPath, [...tablePath!, position.rowIndex, position.colIndex], {\n              data: {\n                ...realNode.data,\n                colSpan: (realNode.data.colSpan || 1) + 1,\n              },\n            });\n          }\n        }\n      }\n      controller.command(Commands.insertNodeByPath, [...tablePath!, rowIndex], finalIndex, createEmptyTableCell(data));\n    });\n  });\n\n  const colsWidth = [...table.data.colsWidth!];\n  const originalTotalColsWidth = colsWidth.reduce((acc, curr) => (acc + curr), 0);\n  // 未传入有效宽度则手动计算\n  if (!colWidth) {\n    const refColIndex = targetColIndex === colsWidth.length ? targetColIndex - 1 : targetColIndex;\n    const refColWidth = colsWidth[refColIndex];\n    colWidth = refColWidth;\n  }\n\n  colsWidth.splice(targetColIndex, 0, colWidth);\n\n  const totalColsWidth = colsWidth.reduce((acc, curr) => (acc + curr), 0);\n\n  setTableColsWidth(controller, table, colsWidth);\n\n  if (Table.isAutofitWidth(table)) {\n    const newTable = controller.value.document.getNodeByPath(tablePath) as Table;\n    resizeTableToAutofitWidth(controller, newTable, table, containerWidth);\n  } else {\n    const containerW = containerWidth || getTableMaxWidthByContainer(controller, table);\n    if (\n      totalColsWidth >= containerW\n      && originalTotalColsWidth <= containerW\n    ) {\n      const updatedDoc = controller.value.document;\n      const updatedTbl = updatedDoc.getNodeByPath(tablePath) as Table;\n\n      resizeTableWidthFitContainer(controller, updatedTbl, containerW);\n    }\n  }\n\n  const latestTable = controller.value.document.getNodeByPath(tablePath) as Table;\n  let focusCell = getVisibleCellOfCol(latestTable, targetColIndex);\n  if (!focusCell) {\n    focusCell = getRealNodeInTable(latestTable, 0, targetColIndex);\n  }\n  if (focusCell) {\n    const s = controller.value.selection;\n    return controller\n      .command(Commands.select, setSelectionByTable(s, false))\n      .command(Commands.moveToStartOfNode, focusCell!);\n  }\n  return controller;\n}\n"],"file":"insertCol.js"}