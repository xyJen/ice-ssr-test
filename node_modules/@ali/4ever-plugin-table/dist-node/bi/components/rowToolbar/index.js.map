{"version":3,"sources":["../../../../../src/bi/components/rowToolbar/index.tsx"],"names":["usePixelColsWidth","useRowsClientHeight","useRowIsSticky","useScrollableContainerRect","hooks","REALTABLE_PADDING","TOOLBAR_ITEM_SIZE","MIN_ROW_HEIGHT","STICKY_ROW_TOP_HEIGHT","STICKY_TOOLBAR_INDEX_MAP","constants","RowToolbarWrapper","styled","div","visible","props","HOVER_SHOW_INSERT_DELTA","scale","rowToolbar","p","top","RowInlineToolbar","isShow","RowToolbarResizer","TableRowToolbar","table","isSelected","controller","zoomContainer","tableRef","offsetParentRef","realTableWrapperRef","rowIndicatorRef","selection","hoverSelection","scrollableContainer","onContextMenu","onSelect","onRowResize","setIsHighlightSelection","setHoverSelection","getLastActiveTableKey","locale","isHideDeleteButton","isHoverCornerToolbar","colsWidth","isRowHeader","Table","isSticky","scrollRect","rowsClientHeight","rowsHeight","React","useMemo","nodes","map","row","key","contextMenuVisible","setContextMenuVisible","useState","positionOfInsertButton","setInsetBtnPos","isHoverDelete","setIsHoverDelete","hoverToolbarItemIndex","setHoverToolbarItemIndex","isDragging","setIsDragging","draggingRowHeight","setDraggingRowHeight","deleteButtonRef","useRef","rowToolbarRef","insertButtonRef","draggingRowResizer","startPositionTop","startClientY","originBodyCursor","rowResizerRef","deleteButtonTop","rowsRect","isResizingRowFlag","dragElementRef","dataInsertIndex","startSelectIndex","selectedIndexRange","intersectionObRef","observerTargets","isInitObserver","initObserver","useCallback","current","IntersectionObserver","changes","change","intersectionRatio","target","style","visibility","threshold","document","querySelectorAll","forEach","observe","detachObserver","unobserve","disconnect","hasIntersectionObserver","getRowIndexByClientY","clientY","index","query","node","calcRowsHeight","startIndex","endIndex","end","undefined","slice","reduce","totalHeight","h","updateInsertButtonStyle","insertButtonNode","bottom","menuRect","right","DISTANCE_BETWEEN_INSERT_BUTTON_AND_TOOLBAR","insertButtonTop","height","position","transform","left","rowHeight","Number","isFinite","Math","round","Object","entries","k","v","updateIndicatorStyle","targetRow","min","length","rowDOM","domUtils","findDOMNode","tableDOM","trueTableDOM","rowRect","tableRect","trueTableRect","width","relativeTop","e","logger","info","type","JSON","stringify","getDataSelectedIndexRange","tableSelection","getSelectedIndexRange","getSortedSelectedRange","r","range","start","max","updateToolbarStyle","updateDeleteButtonStyle","display","thisNode","ReactDOM","targetStartNode","children","startRowIndex","targetEndNode","endRowIndex","message","menuNode","targetStartRect","targetEndRect","mid","DISTANCE_BETWEEN_DELETE_BUTTON_AND_TOOLBAR","handlePreventDefault","event","preventDefault","stopPropagation","showIndicatorVisible","isVisible","opacity","handleMouseMove","clientX","getBoundingClientRect","toolbarRect","INDICATOR_WRAPPER_WIDTH","setPositionOfInsertButton","leading","i","handleMouseOverRowToolbarItem","isToolbarItem","getAttribute","parseInt","isNaN","tableCols","data","startColIndex","endColIndex","handleMouseOutRowToolbarItem","hideContextMenu","removeEventListener","selectRows","shouldHideContextMenu","shouldEnableEndDrag","insertIndex","rowsLength","maxColIndex","aboveRowSelection","handleMultiSelectRow","buttons","removeMultiSelectListener","endSelectedIndex","transition","moveRowToIndex","originIndexRange","targetIndex","run","updateDragElementPosition","x","y","calcInsertIndexByRowsRects","rects","rowsRects","updateDraggingStyle","relativeEvent","relativeX","relativeY","sortedRange","dataRowNodes","shouldDragEnd","dataInsertIndexTemp","handleDragging","handleDragEnd","handleDragStart","addEventListener","removeDragEventListener","addMultiSelectListener","enableDragIcon","tbs","Boolean","handleSelectRow","sortRange","shiftKey","timer","isRightClick","clearTimer","clearTimeout","removeCancelDragEventListener","window","setTimeout","DRAG_TRIGGER_TIME","handleRowResizing","rowToolbarItem","parentElement","rowToolbarItemRect","validClientY","delta","colResizer","handleRowResizeEnd","resizingRowIndex","resizingRowKey","backgroundColor","body","cursor","rowResizer","handleRowResizeStart","resizerRect","setProperty","realTableWrapperRect","tableWidth","deleteRow","insertRow","highlightSelection","cancelHighlightSelection","handleMouseOver","targetDom","srcElement","isInsideRowToolbar","contains","setCanInsertBtnShow","toolbarTop","findIndex","canInsertBtnShow","useEffect","handleMouseOut","handleMouseEnterIndicator","handleContextMenu","renderRowToolbarItems","rowsCount","isSelectWholeTable","indexRange","deleteRange","selectRanges","push","activeRange","getInsertButtonIndicator","isFirst","indicatorStyle","isShowButton","isShowDelete","preTableRef","useLayoutEffect","fastdom","measure","colsWidthRef","scaleRef","onHotsNextFrame","hots","some","hot","hasNode","sum","isShowInsertButton","isRowInlineToolbarShow","paddingTop","createPortal"],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/no-shadow */\n/* eslint-disable max-lines */\n/* eslint-disable react/no-find-dom-node */\nimport React, { useEffect, useLayoutEffect } from 'react';\nimport equal from 'fast-deep-equal';\nimport * as ReactDOM from 'react-dom';\nimport styled from 'styled-components';\nimport { throttle } from 'lodash-es';\nimport fastdom from 'fastdom';\nimport logger from '@ali/4ever-logger';\nimport Table from '../../../mo/models';\nimport TableRow from '../../../mo/models/tableRow';\nimport { domUtils, Hot, useHotsAtTheStartOfNextFrame } from '@ali/4ever-cangjie';\nimport {\n  getBoundingRelativeRect,\n  getRelativeMouseEvent,\n} from '@ali/4ever-utils';\nimport {\n  HOVER_SHOW_INSERT_DELTA,\n  DISTANCE_BETWEEN_INSERT_BUTTON_AND_TOOLBAR,\n  DRAG_TRIGGER_TIME,\n  DISTANCE_BETWEEN_DELETE_BUTTON_AND_TOOLBAR,\n} from '../../constants';\nimport { RowResizer } from '../styled';\nimport { logNPEInfo } from '../../utils/logger';\nimport { ISelectedIndexRange, ITableSelection } from '../../types';\nimport getAllRowsDomRect from '../../queries/getAllRowsDomRect';\nimport {\n  clickTableToolbar,\n  deleteTableRows,\n  insertTableRow,\n  moveTableRows,\n} from '../../actions';\nimport InlineToolbarInsertButton from '../inlineToolbarButtons/inlineToolbarInsertButton';\nimport InlineToolbarDeleteButton from '../inlineToolbarButtons/inlineToolbarDeleteButton';\nimport InsertButtonIndicator, {\n  INDICATOR_WRAPPER_WIDTH,\n} from '../inlineToolbarButtons/insertButtonIndicator';\nimport DragElement from './dragElement';\nimport RowToolbarItem from './rowToolbarItem';\nimport { scrollVerticalContainer } from '../../utils/scrollContainer';\nimport createToolbarWithTableSeletion from '../createToolbarWithTableSelection';\nimport type { TableRowToolbarProps } from '../createToolbarWithTableSelection';\nimport getDataTableSelectionByTable from '../../utils/getDataTableSelectionByTable';\nimport { getSelectedRowRangeFromTableSelection } from '../../utils/getSelectedRangeFromTableSelection';\nimport hasIntersectionObserver from '../../utils/hasIntersectionObserver';\nimport constants from '../../../utils/constants';\nimport * as hooks from '../../../utils/hooks';\n\nconst {\n  usePixelColsWidth,\n  useRowsClientHeight,\n  useRowIsSticky,\n  useScrollableContainerRect,\n} = hooks;\n\nconst {\n  REALTABLE_PADDING,\n  TOOLBAR_ITEM_SIZE,\n  MIN_ROW_HEIGHT,\n  STICKY_ROW_TOP_HEIGHT,\n  STICKY_TOOLBAR_INDEX_MAP,\n} = constants;\n\ninterface IScaleProps {\n  scale: number;\n  visible?: boolean;\n}\n\nconst RowToolbarWrapper = styled.div<IScaleProps>`\n  display: ${({ visible }) => (visible ? 'block' : 'none')};\n  position: absolute;\n  left: ${(props) => -(TOOLBAR_ITEM_SIZE + HOVER_SHOW_INSERT_DELTA) / props.scale}px;\n  box-sizing: border-box;\n  width: ${(props) => (TOOLBAR_ITEM_SIZE + 1 + HOVER_SHOW_INSERT_DELTA) / props.scale}px;\n  padding-left: ${(props) => HOVER_SHOW_INSERT_DELTA / props.scale}px;\n  z-index: ${STICKY_TOOLBAR_INDEX_MAP.rowToolbar};\n  top: ${(p) => (REALTABLE_PADDING.top + TOOLBAR_ITEM_SIZE) / p.scale}px;\n`;\n\nconst RowInlineToolbar = styled.div<{ isShow: boolean }>`\n  position: absolute;\n  z-index: 100;\n  opacity: ${(p) => (p.isShow ? 1 : 0)};\n  transition: opacity ease-in 0.25s;\n  pointer-events: ${(p) => (p.isShow ? 'auto' : 'none')};\n`;\n\nconst RowToolbarResizer = styled.div<IScaleProps>`\n  position: absolute;\n  bottom: -4px;\n  right: -1px;\n  height: 7px;\n  width: ${(props) => ((TOOLBAR_ITEM_SIZE + 1) / props.scale)}px;\n  background-color: transparent;\n  z-index: 1;\n  cursor: row-resize;\n\n  &:hover {\n    background-color: #3296FA;\n  }\n`;\n\nconst TableRowToolbar = (props: TableRowToolbarProps) => {\n  const {\n    table,\n    isSelected,\n    controller,\n    zoomContainer,\n    scale,\n    tableRef,\n    offsetParentRef,\n    realTableWrapperRef,\n    rowIndicatorRef,\n    selection,\n    hoverSelection,\n    scrollableContainer,\n    onContextMenu,\n    onSelect,\n    onRowResize,\n    setIsHighlightSelection,\n    setHoverSelection,\n    getLastActiveTableKey,\n    locale,\n    isHideDeleteButton,\n    isHoverCornerToolbar,\n  } = props;\n\n  const [colsWidth] = usePixelColsWidth();\n  const isRowHeader = Table.isRowHeader(table);\n  const [isSticky] = useRowIsSticky();\n  const [scrollRect] = useScrollableContainerRect();\n  const [rowsClientHeight] = useRowsClientHeight();\n\n  const rowsHeight = React.useMemo(() => {\n    return table.nodes.map((row) => (rowsClientHeight[row.key] || 0));\n  }, [rowsClientHeight, table.nodes]);\n\n  const [contextMenuVisible, setContextMenuVisible] = React.useState<boolean>(false);\n\n  const [positionOfInsertButton, setInsetBtnPos] = React.useState<number>(-1);\n\n  const [isHoverDelete, setIsHoverDelete] = React.useState<boolean>(false);\n\n  const [hoverToolbarItemIndex, setHoverToolbarItemIndex] = React.useState<number>(-1);\n\n  const [isDragging, setIsDragging] = React.useState<boolean>(false);\n\n  const [draggingRowHeight, setDraggingRowHeight] = React.useState<number>(0);\n\n  const deleteButtonRef = React.useRef<HTMLDivElement>(null);\n\n  const rowToolbarRef = React.useRef<HTMLDivElement>(null);\n\n  const insertButtonRef = React.useRef<HTMLDivElement>(null);\n\n  const draggingRowResizer = React.useRef<HTMLDivElement | null>(null);\n\n  const startPositionTop = React.useRef<number | null>(null);\n\n  const startClientY = React.useRef<number | null>(null);\n\n  const originBodyCursor = React.useRef<string>('');\n\n  const rowResizerRef = React.useRef<HTMLDivElement>(null);\n\n  const deleteButtonTop = React.useRef<number>(-1);\n\n  // 当前 viewTable 下的所有行的 DOMRect\n  // \b\b不是 dataTable\n  const rowsRect = React.useRef<DOMRect[]>([]);\n\n  const isResizingRowFlag = React.useRef<boolean>(false);\n\n  const dragElementRef = React.useRef<HTMLDivElement>(null);\n\n  const dataInsertIndex = React.useRef<number>(-1);\n\n  const startSelectIndex = React.useRef<number>(-1);\n\n  const selectedIndexRange = React.useRef<ISelectedIndexRange | null>(null);\n\n\n  const intersectionObRef = React.useRef<IntersectionObserver | null>(null);\n\n  const observerTargets = React.useRef<any>(null);\n\n  const isInitObserver = React.useRef<boolean>(false); // intersectionOb是否已经监听，避免多次重复监听\n\n  const initObserver = React.useCallback(() => {\n    intersectionObRef.current = new IntersectionObserver((changes) => {\n      for (const change of changes) {\n        if (change.intersectionRatio <= 0) {\n          (change.target as HTMLDivElement).style.visibility = 'hidden';\n        } else {\n          (change.target as HTMLDivElement).style.visibility = 'inherit';\n        }\n      }\n    }, {\n      threshold: [0, 1],\n    });\n    observerTargets.current = document.querySelectorAll('[data-ob=\"true\"]');\n    observerTargets.current.forEach((target) => {\n      intersectionObRef.current!.observe(target);\n    });\n  }, []);\n\n  const detachObserver = React.useCallback(() => {\n    if (observerTargets.current && intersectionObRef.current) {\n      observerTargets.current.forEach((target) => {\n        intersectionObRef.current!.unobserve(target);\n      });\n      intersectionObRef.current!.disconnect();\n    }\n  }, []);\n\n\n  useEffect(() => {\n    if (hasIntersectionObserver && isSelected && !isInitObserver.current) {\n      // 监听后标记为true，避免重复执行\n      isInitObserver.current = true;\n      initObserver();\n    }\n  }, [initObserver, isSelected]);\n\n  const getRowIndexByClientY = React.useCallback((clientY: number) => {\n    const index = controller.query('getRowIndexByClientY', { node: table, clientY });\n    return index === null ? -1 : index;\n  }, [controller, table]);\n\n  const calcRowsHeight = React.useCallback((startIndex: number, endIndex?: number) => {\n    const end = endIndex === undefined ? endIndex : endIndex + 1;\n    return rowsHeight\n      .slice(startIndex, end)\n      .reduce((totalHeight, h) => {\n        return totalHeight + h;\n      }, 0);\n  }, [rowsHeight]);\n\n  const updateInsertButtonStyle = React.useCallback(() => {\n    if (\n      positionOfInsertButton === -1 ||\n      !insertButtonRef.current ||\n      !selection\n    ) {\n      return;\n    }\n\n    const insertButtonNode = insertButtonRef.current;\n    const bottom = calcRowsHeight(positionOfInsertButton);\n    const menuRect = getBoundingRelativeRect(insertButtonNode, zoomContainer);\n\n    const right =\n      DISTANCE_BETWEEN_INSERT_BUTTON_AND_TOOLBAR + TOOLBAR_ITEM_SIZE;\n    const insertButtonTop = (bottom - menuRect.height / 2) / scale;\n\n    const style = {\n      position: 'absolute',\n      right: 'unset',\n      top: 'unset',\n      transform: 'unset',\n      bottom: 'unset',\n      left: 'unset',\n    };\n\n    if (\n      isSticky &&\n      (positionOfInsertButton === 0 || positionOfInsertButton === 1)\n    ) {\n      style.position = 'fixed';\n      style.right = 'unset';\n\n      const top =\n        scrollRect.top + STICKY_ROW_TOP_HEIGHT - menuRect.height / 2;\n      const rowHeight = positionOfInsertButton === 0 ? 0 : rowsHeight[0];\n      style.top = `${top + rowHeight}px`;\n      if (Number.isFinite(scrollRect.left)) {\n        style.left = `${scrollRect.left}px`;\n      }\n      style.transform = 'translateX(calc(-100% - 2px))';\n    } else {\n      style.bottom = `${Math.round(insertButtonTop)}px`;\n      style.right = `${Math.round(right / scale)}px`;\n    }\n\n    Object.entries(style).forEach(([k, v]) => {\n      insertButtonNode.style[k] = v;\n    });\n  }, [\n    positionOfInsertButton,\n    selection,\n    calcRowsHeight,\n    zoomContainer,\n    scale,\n    isSticky,\n    scrollRect,\n    rowsHeight,\n  ]);\n\n  const updateIndicatorStyle = React.useCallback(() => {\n    if (\n      !selection ||\n      !rowIndicatorRef.current ||\n      positionOfInsertButton === -1\n    ) {\n      return;\n    }\n    try {\n      const targetRow =\n        table.nodes[Math.min(positionOfInsertButton, table.nodes.length - 1)];\n      // Fix to https://work.aone.alibaba-inc.com/issue/38856463. targetRow会存在拿不到的情况，未能复现早值班问题，暂时不好定位具体原因\n      // 先做兜底处理,可能跟协同场景下的一些特殊操作有关?\n      if (!targetRow?.key) {\n        return;\n      }\n      const rowDOM = domUtils.findDOMNode(targetRow.key)!;\n      const tableDOM = domUtils.findDOMNode(table.key)!;\n      const trueTableDOM = tableRef.current!;\n      const rowRect = getBoundingRelativeRect(rowDOM, offsetParentRef.current);\n      const tableRect = getBoundingRelativeRect(tableDOM, zoomContainer);\n      const trueTableRect = getBoundingRelativeRect(\n        trueTableDOM,\n        zoomContainer,\n      );\n      const width =\n        Math.min(tableRect.width, trueTableRect.width) + TOOLBAR_ITEM_SIZE;\n      rowIndicatorRef.current.style.width = `${Math.round(width / scale)}px`;\n      rowIndicatorRef.current.style.transform = `translateX(${\n        -TOOLBAR_ITEM_SIZE / scale\n      }px)`;\n\n      let relativeTop = rowRect.top;\n      if (positionOfInsertButton === table.nodes.length) {\n        relativeTop = rowRect.bottom;\n      }\n      if (\n        isSticky &&\n        (positionOfInsertButton === 0 || positionOfInsertButton === 1)\n      ) {\n        const top = scrollRect.top + STICKY_ROW_TOP_HEIGHT;\n        const rowHeight = positionOfInsertButton === 0 ? 0 : rowsHeight[0];\n        rowIndicatorRef.current.style.top = `${top + rowHeight}px`;\n        rowIndicatorRef.current.style.position = 'fixed';\n      } else {\n        rowIndicatorRef.current.style.top = `${Math.round(\n          relativeTop / scale,\n        )}px`;\n        rowIndicatorRef.current.style.position = 'absolute';\n      }\n    } catch (e) {\n      logger.info({\n        type: 'updateIndicatorStyle',\n        info: JSON.stringify(e),\n      });\n    }\n  }, [\n    selection,\n    rowIndicatorRef,\n    positionOfInsertButton,\n    table.nodes,\n    table.key,\n    tableRef,\n    offsetParentRef,\n    zoomContainer,\n    scale,\n    isSticky,\n    scrollRect.top,\n    rowsHeight,\n  ]);\n\n  const getDataSelectedIndexRange = React.useCallback(() => {\n    const tableSelection = getDataTableSelectionByTable(controller, table);\n    return getSelectedRowRangeFromTableSelection({\n      controller,\n      table,\n      tableSelection,\n    });\n  }, [controller, table]);\n\n  const getSelectedIndexRange = React.useCallback(() => {\n    const tableSelection = getDataTableSelectionByTable(controller, table);\n    return getSelectedRowRangeFromTableSelection({\n      controller,\n      table,\n      tableSelection,\n    });\n  }, [controller, table]);\n\n  const getSortedSelectedRange = React.useCallback((r?: ISelectedIndexRange | null) => {\n    const range = r || getSelectedIndexRange();\n    if (!range) {\n      return null;\n    }\n    const { start, end } = range;\n    const min = Math.min(start, end);\n    const max = Math.max(start, end);\n    return {\n      min,\n      max,\n    };\n  }, [getSelectedIndexRange]);\n\n  const updateToolbarStyle = React.useCallback(() => {\n    updateInsertButtonStyle();\n    updateIndicatorStyle();\n  }, [updateInsertButtonStyle, updateIndicatorStyle]);\n\n  const updateDeleteButtonStyle = React.useCallback(() => {\n    if (!deleteButtonRef.current || !selection) {\n      return;\n    }\n    deleteButtonRef.current.style.display = 'block';\n\n    const thisNode = ReactDOM.findDOMNode(rowToolbarRef.current) as HTMLElement;\n    const targetStartNode = thisNode.children[selection.startRowIndex]?.children[0] as HTMLElement;\n    const targetEndNode = thisNode.children[selection.endRowIndex]?.children[0] as HTMLElement;\n    // TODO: targetEndNode/targetStartNode 为空根因待排查\n    // 添加日志定位\n    if (!targetEndNode || !targetStartNode) {\n      logNPEInfo(\n        table,\n        {\n          selection,\n          message: `${targetEndNode ? 'targetStartNode' : 'targetEndNode'} is undefined \\n`,\n        },\n      );\n      return;\n    }\n\n    const menuNode = ReactDOM.findDOMNode(deleteButtonRef.current) as HTMLElement;\n    const targetStartRect = getBoundingRelativeRect(targetStartNode, zoomContainer);\n    const targetEndRect = getBoundingRelativeRect(targetEndNode, zoomContainer);\n    const menuRect = getBoundingRelativeRect(menuNode, zoomContainer);\n    const mid = (targetEndRect.bottom - targetStartRect.top) / 2;\n    const relativeTop = targetStartRect.top + mid - menuRect.height / 2;\n    const left = targetStartRect.left - menuRect.width - DISTANCE_BETWEEN_DELETE_BUTTON_AND_TOOLBAR;\n    deleteButtonTop.current = relativeTop / scale;\n    menuNode.style.top = `${deleteButtonTop.current}px`;\n    menuNode.style.left = `${left / scale}px`;\n  }, [selection, zoomContainer, table, scale]);\n\n  const handlePreventDefault = React.useCallback((event) => {\n    event.preventDefault();\n    event.stopPropagation();\n  }, []);\n\n  const showIndicatorVisible = React.useCallback((isVisible: boolean) => {\n    if (!rowIndicatorRef.current) {\n      return;\n    }\n    const opacity = isVisible ? '1' : '0';\n    rowIndicatorRef.current.style.opacity = opacity;\n  }, [rowIndicatorRef]);\n\n\n  // 根据鼠标位置判断是否出现插入按钮\n  const handleMouseMove = React.useCallback(throttle((event) => {\n    // event 应该是非空的，但是有监控有报错显示为空\n    // https://aone.alibaba-inc.com/v2/project/995011/bug/43391898\n    if (\n      !rowToolbarRef.current ||\n      isResizingRowFlag.current ||\n      isDragging ||\n      !event\n    ) {\n      return;\n    }\n    const { clientX, clientY } = event;\n    // 鼠标位置在插入按钮区域时，不隐藏插入按钮\n    if (positionOfInsertButton !== -1 && insertButtonRef.current) {\n      const insertButtonNode = ReactDOM.findDOMNode(\n        insertButtonRef.current,\n      ) as HTMLDivElement;\n      const { left, top, right, bottom } = insertButtonNode.getBoundingClientRect();\n      if (clientX >= left && clientX <= right && clientY >= top && clientY <= bottom) {\n        return;\n      }\n    }\n    const toolbarRect = rowToolbarRef.current.getBoundingClientRect();\n    const { left, top, right, bottom } = toolbarRect;\n    // 鼠标位置不在 toolbar 区域内时，不显示插入按钮\n    if (\n      clientX < left ||\n      clientX > right ||\n      clientY < (top - INDICATOR_WRAPPER_WIDTH / 2) ||\n      clientY > (bottom + INDICATOR_WRAPPER_WIDTH / 2)\n    ) {\n      showIndicatorVisible(false);\n      setPositionOfInsertButton(-1);\n    }\n  }, 200, { leading: true }),\n  [isDragging, positionOfInsertButton, showIndicatorVisible, getDataSelectedIndexRange]);\n\n  const setPositionOfInsertButton = React.useCallback((index: number) => {\n    let i = index;\n    if (isRowHeader && i === 0) {\n      i = -1;\n    }\n    setInsetBtnPos(i);\n    dataInsertIndex.current = i;\n  }, [isRowHeader]);\n\n  const handleMouseOverRowToolbarItem = React.useCallback(\n    (event) => {\n      if (isResizingRowFlag.current) return;\n      // 如果不是ToolbarItem触发的则不处理\n      const isToolbarItem = event.target.getAttribute('data-ob');\n      if (!isToolbarItem) return;\n      const index = parseInt(event.target.getAttribute('data-index'), 10);\n      if (isNaN(index)) return;\n      const tableCols = table.data?.colsWidth?.length;\n      if (tableCols) {\n        // 构造hover选区\n        const hoverSelection = {\n          key: table.key,\n          startColIndex: 0,\n          endColIndex: tableCols - 1,\n          startRowIndex: index,\n          endRowIndex: index,\n        };\n        setHoverSelection(hoverSelection);\n        // hover的时候不显示插入按钮\n        showIndicatorVisible(false);\n        setPositionOfInsertButton(-1);\n      }\n    },\n    [\n      setHoverSelection,\n      setPositionOfInsertButton,\n      showIndicatorVisible,\n      table.data?.colsWidth?.length,\n      table.key,\n    ],\n  );\n\n  const handleMouseOutRowToolbarItem = React.useCallback((e) => {\n    // 如果不是ToolbarItem触发的则不处理\n    const isToolbarItem = e.target.getAttribute('data-ob');\n    if (!isToolbarItem) return;\n    setHoverSelection(null);\n  }, [setHoverSelection]);\n\n  const hideContextMenu = React.useCallback(() => {\n    setContextMenuVisible(false);\n    document.removeEventListener('mousedown', hideContextMenu);\n  }, []);\n\n  const selectRows = React.useCallback((\n    start: number,\n    end: number,\n    shouldHideContextMenu = true,\n  ) => {\n    if (start === end) {\n      startSelectIndex.current = start;\n    }\n    selectedIndexRange.current = {\n      start,\n      end,\n    };\n    onSelect(\n      {\n        start,\n        end,\n      },\n      shouldHideContextMenu,\n    );\n  }, [onSelect]);\n\n  const shouldEnableEndDrag = React.useCallback((insertIndex: number, rowsLength: number) => {\n    if (insertIndex === 0 && isRowHeader) return false;\n\n    if (insertIndex > 0 && insertIndex < rowsLength) {\n      const maxColIndex = table.data.colsWidth!.length - 1;\n      const aboveRowSelection: ITableSelection = {\n        startRowIndex: 0,\n        endRowIndex: insertIndex - 1,\n        startColIndex: 0,\n        endColIndex: maxColIndex,\n        key: table.key,\n      };\n      return controller.query(\n        'isAllSelectedCellsComplete',\n        { node: table, tableSelection: aboveRowSelection },\n      );\n    }\n    return true;\n  }, [table, controller, isRowHeader]);\n\n  const handleMultiSelectRow = React.useCallback(throttle((event: MouseEvent) => {\n    if (isDragging) {\n      return;\n    }\n    const selectedIndexRange = getDataSelectedIndexRange();\n    const { buttons } = event;\n    // 协同下，rowToolbar 可能不存在\n    if (buttons !== 1 || !rowToolbarRef.current || !selectedIndexRange) {\n      removeMultiSelectListener();\n      return;\n    }\n\n    const endSelectedIndex = getRowIndexByClientY(event.clientY);\n    if (deleteButtonRef.current) {\n      deleteButtonRef.current.style.transition = 'top ease-out 0.1s';\n    }\n    scrollVerticalContainer(event.clientY, scrollableContainer);\n    selectRows(startSelectIndex.current, endSelectedIndex!);\n  }, 100)\n  , [isDragging, getDataSelectedIndexRange, getRowIndexByClientY, selectRows]);\n\n  const moveRowToIndex = React.useCallback((\n    originIndexRange: ISelectedIndexRange,\n    targetIndex: number,\n  ) => {\n    const { min, max } = getSortedSelectedRange(originIndexRange)!;\n    controller.run(\n      'onAction',\n      moveTableRows(\n        table,\n        {\n          start: min,\n          end: max,\n        },\n        targetIndex,\n      ),\n    );\n    const startIndex = min < targetIndex ?\n      targetIndex - (max - min + 1) :\n      targetIndex;\n    selectRows(startIndex, startIndex + max - min);\n  }, [controller, table, getSortedSelectedRange, selectRows]);\n\n  const updateDragElementPosition = React.useCallback((x: number, y: number) => {\n    if (!dragElementRef.current) {\n      return;\n    }\n    dragElementRef.current.style.left = `${x / scale}px`;\n    dragElementRef.current.style.top = `${y / scale}px`;\n  }, [scale]);\n\n  const calcInsertIndexByRowsRects = React.useCallback((clientY: number, rects?: DOMRect[]) => {\n    let rowsRects = rects;\n    if (!rowsRects) {\n      rowsRects = controller.query(\n        'getAllRowsDomRect',\n        { node: table },\n      ) as DOMRect[];\n    }\n    let insertIndex = -1;\n    for (let i = 0; i < rowsRects.length; i++) {\n      const rowRect = rowsRects[i];\n      if (!rowRect) {\n        continue;\n      }\n      if (\n        clientY >= rowRect.top &&\n        clientY <= rowRect.top + rowRect.height / 2\n      ) {\n        insertIndex = i;\n        break;\n      }\n      if (\n        clientY > rowRect.top + rowRect.height / 2 &&\n        clientY < rowRect.bottom\n      ) {\n        insertIndex = i + 1;\n        break;\n      }\n    }\n    return insertIndex;\n  }, [controller, table]);\n\n  const updateDraggingStyle = React.useCallback(\n    (relativeEvent) => {\n      const { clientX, clientY, relativeX, relativeY } = relativeEvent;\n      const tableDOM = domUtils.findDOMNode(table.key) as HTMLElement;\n      if (!tableDOM) {\n        return;\n      }\n      updateDragElementPosition(relativeX, relativeY);\n      const tableRect = tableDOM.getBoundingClientRect();\n      if (\n        clientX < tableRect.left - TOOLBAR_ITEM_SIZE ||\n        clientX > tableRect.right ||\n        clientY < tableRect.top - TOOLBAR_ITEM_SIZE ||\n        clientY > tableRect.bottom\n      ) {\n        showIndicatorVisible(false);\n        setPositionOfInsertButton(-1);\n        return;\n      }\n      scrollVerticalContainer(clientY, scrollableContainer);\n\n      // 先根据 dataModel 计算应该插入行的 index 判断是否可以插入\n      // 再根据 viewModel 计算行插入指示器渲染的位置\n      let insertIndex = calcInsertIndexByRowsRects(clientY);\n      const sortedRange = getSortedSelectedRange();\n      if (!sortedRange) {\n        return;\n      }\n      const { min, max } = sortedRange;\n      if (insertIndex >= min && insertIndex <= max + 1) {\n        insertIndex = -1;\n      }\n      const dataRowNodes = controller.query('getAllRowsNodes', { node: table });\n      if (!dataRowNodes) return;\n\n      const shouldDragEnd = shouldEnableEndDrag(insertIndex, dataRowNodes.length);\n      if (!shouldDragEnd) {\n        insertIndex = -1;\n      }\n      const dataInsertIndexTemp = insertIndex;\n      if (insertIndex !== -1) {\n        insertIndex = calcInsertIndexByRowsRects(clientY, rowsRect.current);\n      }\n      showIndicatorVisible(insertIndex !== -1);\n      setPositionOfInsertButton(insertIndex);\n      dataInsertIndex.current = dataInsertIndexTemp;\n    },\n    [\n      table,\n      controller,\n      scrollableContainer,\n      updateDragElementPosition,\n      showIndicatorVisible,\n      shouldEnableEndDrag,\n      calcInsertIndexByRowsRects,\n      getSortedSelectedRange,\n      setPositionOfInsertButton,\n    ],\n  );\n\n  const handleDragging = React.useCallback((event: React.MouseEvent | MouseEvent) => {\n    const tableDOM = domUtils.findDOMNode(table.key) as HTMLElement;\n    if (!tableDOM || event.buttons !== 1) {\n      handleDragEnd();\n      return;\n    }\n    event.stopPropagation();\n    const relativeEvent = getRelativeMouseEvent(event, zoomContainer);\n    updateDraggingStyle(relativeEvent);\n  }, [table, zoomContainer, updateDraggingStyle]);\n\n  const handleDragEnd = React.useCallback(() => {\n    setIsDragging(false);\n    showIndicatorVisible(false);\n    // Tip: 为避免循环依赖问题，所以这里没有调用removeDragEventListener函数\n    document.removeEventListener('mousemove', handleDragging);\n    document.removeEventListener('mouseup', handleDragEnd);\n    if (dataInsertIndex.current === -1) {\n      return;\n    }\n    const selectedIndexRange = getDataSelectedIndexRange();\n    moveRowToIndex(selectedIndexRange!, dataInsertIndex.current);\n    setPositionOfInsertButton(-1);\n  }, [showIndicatorVisible, handleDragging, getDataSelectedIndexRange, moveRowToIndex, setPositionOfInsertButton]);\n\n  const handleDragStart = React.useCallback((relativeEvent, rowHeight) => {\n    setIsDragging(true);\n    setDraggingRowHeight(rowHeight);\n    updateDraggingStyle(relativeEvent);\n    document.addEventListener('mousemove', handleDragging);\n    document.addEventListener('mouseup', handleDragEnd);\n  }, [updateDraggingStyle, handleDragging, handleDragEnd]);\n\n  const removeDragEventListener = React.useCallback(() => {\n    document.removeEventListener('mousemove', handleDragging);\n    document.removeEventListener('mouseup', handleDragEnd);\n  }, [handleDragging, handleDragEnd]);\n\n  const removeMultiSelectListener = React.useCallback(() => {\n    if (deleteButtonRef.current) {\n      deleteButtonRef.current.style.transition = 'none';\n    }\n    document.removeEventListener('mousemove', handleMultiSelectRow);\n    document.removeEventListener('mouseup', removeMultiSelectListener);\n  }, [handleMultiSelectRow]);\n\n  const addMultiSelectListener = React.useCallback(() => {\n    document.addEventListener('mousemove', handleMultiSelectRow);\n    document.addEventListener('mouseup', removeMultiSelectListener);\n  }, [handleMultiSelectRow, removeMultiSelectListener]);\n\n  const enableDragIcon = React.useCallback(() => {\n    const tbs = getSelectedRowRangeFromTableSelection({\n      controller,\n      table,\n      tableSelection: selection,\n    });\n    const range = getSortedSelectedRange(tbs);\n    // 禁止拖拽表头行\n    if (isRowHeader && range?.min === 0) return false;\n\n    return Boolean(\n      range &&\n        hoverToolbarItemIndex >= range.min &&\n        hoverToolbarItemIndex <= range.max,\n    );\n  }, [\n    controller,\n    table,\n    selection,\n    getSortedSelectedRange,\n    isRowHeader,\n    hoverToolbarItemIndex,\n  ]);\n\n  const handleSelectRow = React.useCallback(\n    (event) => {\n      handlePreventDefault(event);\n      const index = getRowIndexByClientY(event.clientY);\n      const sortRange = getDataSelectedIndexRange();\n      controller.run('onAction', clickTableToolbar(table, 'row', event.target));\n      // shift 键多选行\n      const selectedIndexRange = getDataSelectedIndexRange();\n      if (\n        event.shiftKey &&\n        selectedIndexRange &&\n        startSelectIndex.current !== index\n      ) {\n        let start = startSelectIndex.current;\n        // 这里为单测兼容 startSelectIndex.current 为 -1 的情况\n        // 正常用户操作不会有此类问题\n        if (start === -1) {\n          start = selectedIndexRange.start;\n        }\n        selectRows(start, index);\n        return;\n      }\n      // 直接选中行\n      if (!sortRange || index > sortRange.end || index < sortRange.start) {\n        selectRows(index, index);\n        addMultiSelectListener();\n        return;\n      }\n\n\n      const relativeEvent = getRelativeMouseEvent(event, zoomContainer);\n\n      let timer: number;\n      const isRightClick = event.buttons === 2;\n      const clearTimer = () => {\n        clearTimeout(timer);\n        selectRows(index, index, !isRightClick);\n        removeCancelDragEventListener();\n      };\n      const removeCancelDragEventListener = () => {\n        document.removeEventListener('mousemove', clearTimer);\n        document.removeEventListener('mouseup', clearTimer);\n      };\n      const rowHeight = event.target.getBoundingClientRect().height;\n      timer = window.setTimeout(() => {\n        removeMultiSelectListener();\n        handleDragStart(relativeEvent, rowHeight);\n        removeCancelDragEventListener();\n      }, DRAG_TRIGGER_TIME);\n      if (!enableDragIcon()) {\n        clearTimer();\n      }\n      addMultiSelectListener();\n      document.addEventListener('mousemove', clearTimer);\n      document.addEventListener('mouseup', clearTimer);\n    },\n    [\n      controller,\n      table,\n      zoomContainer,\n      handlePreventDefault,\n      getRowIndexByClientY,\n      getDataSelectedIndexRange,\n      selectRows,\n      addMultiSelectListener,\n      handleDragStart,\n      removeMultiSelectListener,\n      enableDragIcon,\n    ],\n  );\n\n  const handleRowResizing = React.useCallback((event) => {\n    if (!draggingRowResizer.current || !zoomContainer) {\n      return;\n    }\n    event.preventDefault();\n    const relativeEvent = getRelativeMouseEvent(event, zoomContainer);\n\n    const rowToolbarItem = draggingRowResizer.current.parentElement as HTMLElement;\n    if (!rowToolbarItem) {\n      return;\n    }\n    const rowToolbarItemRect = getBoundingRelativeRect(rowToolbarItem, zoomContainer);\n    const validClientY = Math.max(rowToolbarItemRect.top + MIN_ROW_HEIGHT * scale, relativeEvent.relativeY);\n\n    const delta = validClientY - startClientY.current!;\n    const top = `${Math.round(startPositionTop.current! + delta / scale)}px`;\n\n    const colResizer = ReactDOM.findDOMNode(rowResizerRef.current) as HTMLElement;\n    if (!colResizer) {\n      return;\n    }\n    colResizer.style.top = top;\n    draggingRowResizer.current.style.top = top;\n  }, [zoomContainer, scale]);\n\n  // @ts-ignore\n  const handleRowResizeEnd = React.useCallback(() => {\n    isResizingRowFlag.current = false;\n    if (!draggingRowResizer.current || !startPositionTop.current) {\n      return;\n    }\n\n    const delta = parseInt(draggingRowResizer.current.style.top, 10) - Math.round(startPositionTop.current);\n    const resizingRowIndex = parseInt(draggingRowResizer.current.getAttribute('data-index')!, 10);\n    const resizingRowKey = table.nodes[resizingRowIndex].key;\n\n    // @ts-ignore\n    onRowResize(resizingRowKey, delta);\n\n    draggingRowResizer.current.style.backgroundColor = '';\n    draggingRowResizer.current.style.top = '';\n    draggingRowResizer.current = null;\n    startPositionTop.current = null;\n    startClientY.current = null;\n\n    document.body.style.cursor = originBodyCursor.current;\n    originBodyCursor.current = '';\n\n    const rowResizer = ReactDOM.findDOMNode(rowResizerRef.current) as HTMLElement;\n    if (!rowResizer) {\n      return null;\n    }\n    rowResizer.style.display = 'none';\n\n    document.removeEventListener('mousemove', handleRowResizing);\n    document.removeEventListener('mouseup', handleRowResizeEnd);\n  }, [onRowResize, table, handleRowResizing]);\n\n  const handleRowResizeStart = React.useCallback((event: React.MouseEvent<HTMLDivElement, MouseEvent>) => {\n    if (!rowToolbarRef.current) return;\n\n    isResizingRowFlag.current = true;\n    event.preventDefault();\n    event.stopPropagation();\n\n    const relativeEvent = getRelativeMouseEvent(event, zoomContainer);\n\n    startClientY.current = relativeEvent.relativeY;\n    draggingRowResizer.current = event.target as HTMLDivElement;\n    const resizerRect = getBoundingRelativeRect(\n      draggingRowResizer.current,\n      rowToolbarRef.current,\n    );\n    startPositionTop.current = (resizerRect.top + resizerRect.height / 2) / scale;\n    draggingRowResizer.current.style.backgroundColor = 'transparent';\n\n    originBodyCursor.current = document.body.style.cursor;\n    document.body.style.setProperty('cursor', 'row-resize', 'important');\n\n    const table = ReactDOM.findDOMNode(tableRef.current) as HTMLElement;\n    const tableRect = getBoundingRelativeRect(table, zoomContainer);\n    if (!realTableWrapperRef.current) {\n      return;\n    }\n    const realTableWrapperRect = realTableWrapperRef.current.getBoundingClientRect();\n    // eslint-disable-next-line react/no-find-dom-node\n    const rowResizer = ReactDOM.findDOMNode(rowResizerRef.current) as HTMLElement;\n    rowResizer.style.display = 'block';\n    rowResizer.style.top = `${startPositionTop.current}px`;\n    const tableWidth = Math.min(tableRect.width, realTableWrapperRect.width);\n    rowResizer.style.width = `${Math.round(tableWidth / scale)}px`;\n    rowResizer.style.left = `${(TOOLBAR_ITEM_SIZE + HOVER_SHOW_INSERT_DELTA) / scale}px`;\n\n    document.addEventListener('mousemove', handleRowResizing);\n    document.addEventListener('mouseup', handleRowResizeEnd);\n  }, [zoomContainer, scale, realTableWrapperRef, tableRef, handleRowResizing, handleRowResizeEnd]);\n\n  const deleteRow = React.useCallback(() => {\n    controller.run('onAction', deleteTableRows(table));\n  }, [table, controller]);\n\n  const insertRow = React.useCallback(() => {\n    const rowsLength = table.nodes.length;\n    const targetRow = table.nodes[Math.min(positionOfInsertButton, rowsLength - 1)];\n    const type = positionOfInsertButton === rowsLength ?\n      'insert-row-below' :\n      'insert-row-above';\n    // 理论上 targetRow 一定存在，添加 log 定位问题\n    if (!targetRow) {\n      logNPEInfo(table, {\n        type: `insertRow targetRow is undefined ${targetRow}`,\n        positionOfInsertButton,\n        rowsLength,\n      });\n      return;\n    }\n    controller.run('onAction', insertTableRow(targetRow, type));\n  }, [positionOfInsertButton, controller, table]);\n\n  const highlightSelection = React.useCallback(() => {\n    setIsHighlightSelection(true);\n    setIsHoverDelete(true);\n  }, [setIsHighlightSelection]);\n\n  const cancelHighlightSelection = React.useCallback(() => {\n    setIsHighlightSelection(false);\n    setIsHoverDelete(false);\n  }, [setIsHighlightSelection]);\n\n  const handleMouseOver = React.useCallback((e: MouseEvent) => {\n    const targetDom = e.target || e.srcElement;\n    const isInsideRowToolbar = targetDom ? rowToolbarRef.current?.contains(targetDom as Node) || false : false;\n    setCanInsertBtnShow(isInsideRowToolbar);\n    // 通过mouseMove去模拟mouseOver，通过判断e.targte是否为目标dom的子元素或者自身即可\n    if (\n      isResizingRowFlag.current ||\n      isDragging ||\n      !rowToolbarRef.current ||\n      !isInsideRowToolbar\n    ) {\n      return;\n    }\n    const { clientY } = e;\n    const toolbarTop = rowToolbarRef.current.getBoundingClientRect().top;\n    const relativeY = clientY - toolbarTop;\n    let totalHeight = 0;\n    const index = rowsHeight.findIndex((height) => {\n      if (relativeY >= totalHeight && relativeY <= totalHeight + height) {\n        return true;\n      }\n      totalHeight += height;\n      return false;\n    });\n    if (index === 0 && isRowHeader) {\n      setHoverToolbarItemIndex(-1);\n    } else {\n      setHoverToolbarItemIndex(index);\n    }\n  }, [isDragging, rowsHeight, isRowHeader]);\n\n  const [canInsertBtnShow, setCanInsertBtnShow] = React.useState<boolean>(true);\n\n  // 这里通过mouseMove去动态感知全选按钮是否hover到，以此来确定是否需要展示插入行按钮\n  React.useEffect(() => {\n    if (isSelected) {\n      document.addEventListener('mousemove', handleMouseOver, true);\n      return () => {\n        document.removeEventListener('mousemove', handleMouseOver, true);\n      };\n    }\n    return undefined;\n  }, [handleMouseOver, isSelected]);\n\n  const handleMouseOut = React.useCallback(() => {\n    if (isResizingRowFlag.current || isDragging) {\n      return;\n    }\n    setHoverToolbarItemIndex(-1);\n  }, [isDragging]);\n\n  const handleMouseEnterIndicator = React.useCallback((insertIndex: number) => {\n    setPositionOfInsertButton(insertIndex);\n    showIndicatorVisible(insertIndex !== -1);\n  }, [setPositionOfInsertButton, showIndicatorVisible]);\n\n  const handleContextMenu = React.useCallback((event) => {\n    handlePreventDefault(event);\n\n    onContextMenu(event);\n\n    setContextMenuVisible(true);\n  }, [handlePreventDefault, onContextMenu, setContextMenuVisible]);\n\n  const renderRowToolbarItems = React.useMemo(() => {\n    const rowsCount = table.nodes.length;\n    const children: React.ReactNode[] = [];\n    const isSelectWholeTable = controller.query('isSelectWholeTable', {\n      node: table,\n    });\n    const indexRange = getSelectedIndexRange();\n    const deleteRange = isHoverDelete ? indexRange! : null;\n    const selectRanges = indexRange ? [indexRange] : [];\n    if (isHoverCornerToolbar || isSelectWholeTable) {\n      selectRanges.push({ start: 0, end: rowsCount - 1 });\n    } else if (\n      hoverSelection &&\n      hoverSelection.startRowIndex === hoverSelection.endRowIndex\n    ) {\n      selectRanges.push({\n        start: hoverSelection.startRowIndex,\n        end: hoverSelection.endRowIndex,\n      });\n    }\n    const activeRange = selection\n      ? {\n        start: selection.startRowIndex,\n        end: selection.endRowIndex,\n      }\n      : null;\n    const getInsertButtonIndicator = (i: number, isFirst?: boolean) => {\n      const indicatorStyle: React.CSSProperties = {\n        position: 'absolute',\n        right: 8 / scale,\n      };\n      if (isFirst) {\n        indicatorStyle.top = 0;\n        indicatorStyle.transform = 'translateY(-50%)';\n      } else {\n        indicatorStyle.bottom = 0;\n        indicatorStyle.transform = 'translateY(50%)';\n      }\n      return (\n        <InsertButtonIndicator\n          key={i}\n          data-index={i}\n          scale={scale}\n          onClick={insertRow}\n          onMouseEnter={handleMouseEnterIndicator}\n          style={indicatorStyle}\n        />\n      );\n    };\n    for (let i = 0; i < rowsCount; i += 1) {\n      children.push(\n        <RowToolbarItem\n          key={table.nodes[i].key}\n          index={i}\n          width={TOOLBAR_ITEM_SIZE}\n          table={table}\n          deleteRange={deleteRange}\n          selectRanges={selectRanges}\n          activeRange={activeRange}\n          isSticky={isSticky}\n          scale={scale}\n          rowHeight={rowsHeight[i]}\n          onMouseOut={handleMouseOutRowToolbarItem}\n          onMouseOver={handleMouseOverRowToolbarItem}\n          onMouseDown={handleSelectRow}\n          onContextMenu={handleContextMenu}\n          onClick={handlePreventDefault}\n        >\n          {i === 0 && !isRowHeader ? getInsertButtonIndicator(i, true) : null}\n          {getInsertButtonIndicator(i + 1)}\n          <RowToolbarResizer\n            data-index={i}\n            onMouseDown={handleRowResizeStart}\n            scale={scale}\n            data-testid=\"table-row-toolbar-resizer\"\n          />\n        </RowToolbarItem>,\n      );\n    }\n    return children;\n  }, [\n    table,\n    controller,\n    getSelectedIndexRange,\n    isHoverDelete,\n    isHoverCornerToolbar,\n    hoverSelection,\n    selection,\n    scale,\n    insertRow,\n    handleMouseEnterIndicator,\n    isSticky,\n    rowsHeight,\n    handleMouseOutRowToolbarItem,\n    handleMouseOverRowToolbarItem,\n    handleSelectRow,\n    handleContextMenu,\n    handlePreventDefault,\n    isRowHeader,\n    handleRowResizeStart,\n  ]);\n\n  const isShowButton = React.useCallback(() => {\n    return !contextMenuVisible &&\n      zoomContainer &&\n      getLastActiveTableKey() === table.key &&\n      selection;\n  }, [contextMenuVisible, zoomContainer, getLastActiveTableKey, table.key, selection]);\n\n  // 展示插入按钮时隐藏删除按钮\n  const isShowDelete = React.useCallback(() => {\n    const selectedIndexRange = getSelectedIndexRange();\n    return Boolean(isShowButton() &&\n      selectedIndexRange &&\n      positionOfInsertButton === -1 &&\n      !isDragging &&\n      !isHideDeleteButton);\n  }, [getSelectedIndexRange, isShowButton, positionOfInsertButton, isDragging, isHideDeleteButton]);\n\n  const preTableRef = React.useRef<TableRow[]>();\n\n  // 缓存行高变化，由于表格的行高是基于table和controller进行计算，因此只需要在table和controller更新时判断是否需要更新缓存即可\n  // 由于行高信息取决于table-row节点的data属性和table-cell节点的data属性，因此只需要判断当前table.nodes跟上次的table.nodes是否相同即可\n  React.useLayoutEffect(() => {\n    if (!isSelected && !isHoverCornerToolbar) return;\n    fastdom.measure(() => {\n      if (!equal(preTableRef.current, table.nodes)) {\n        preTableRef.current = table.nodes;\n        rowsRect.current = getAllRowsDomRect(controller, { node: table });\n      }\n    });\n  }, [controller, table, table.nodes, isSelected, isHoverCornerToolbar]);\n\n  const colsWidthRef = React.useRef<number[] | undefined>(table.data.colsWidth);\n  const scaleRef = React.useRef<number>(scale);\n  // scale 变化的时候也需要重新计算行高信息\n  React.useLayoutEffect(() => {\n    if (!isSelected) return;\n\n    fastdom.measure(() => {\n      if (\n        scaleRef.current !== scale\n        || (!equal(colsWidth, colsWidthRef.current))\n      ) {\n        rowsRect.current = getAllRowsDomRect(controller, { node: table });\n        scaleRef.current = scale;\n        colsWidthRef.current = colsWidth;\n      }\n    });\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [scale, colsWidth, isSelected]);\n\n  useLayoutEffect(() => {\n    if (!isSelected) return;\n\n    fastdom.measure(() => {\n      updateToolbarStyle();\n      updateDeleteButtonStyle();\n    });\n  }, [updateDeleteButtonStyle, updateToolbarStyle, isSelected]);\n\n  useEffect(() => {\n    document.addEventListener('mousemove', handleMouseMove);\n\n    return () => {\n      document.removeEventListener('mousemove', handleMouseMove);\n    };\n  }, [handleMouseMove]);\n\n  // componentWillUnmount\n  useEffect(() => {\n    return () => {\n      document.removeEventListener('mousemove', handleRowResizing);\n      document.removeEventListener('mouseup', handleRowResizeEnd);\n      removeMultiSelectListener();\n      removeDragEventListener();\n      detachObserver(); // 移除监听\n    };\n  }, []);\n\n  useEffect(() => {\n    if (contextMenuVisible) {\n      document.addEventListener('mousedown', hideContextMenu);\n      return () => {\n        document.removeEventListener('mousedown', hideContextMenu);\n      };\n    }\n    return undefined;\n  }, [contextMenuVisible, hideContextMenu]);\n\n  const onHotsNextFrame = React.useCallback(\n    (hots: Hot[]) => {\n      // PERF: 非当前表格热区不处理\n      if (\n        hots.some(\n          (hot) => table.key === hot.node.key || table.hasNode(hot.node.key),\n        )\n      ) {\n        rowsRect.current = getAllRowsDomRect(controller, { node: table });\n      }\n    },\n    [controller, table],\n  );\n\n  useHotsAtTheStartOfNextFrame(controller, onHotsNextFrame);\n\n  const tableWidth = colsWidth.reduce((sum, width) => sum + width, 0);\n  // 表格全选按钮和insertBtn不能并存\n  const isShowInsertButton = !isDragging && positionOfInsertButton !== -1 && canInsertBtnShow;\n  const isRowInlineToolbarShow = Boolean(isShowButton() && isShowInsertButton);\n  if (!isRowInlineToolbarShow) {\n    showIndicatorVisible(false);\n  }\n\n  const style = {\n    display: isSelected ? 'block' : 'none',\n    paddingTop: isSticky ? rowsHeight[0] + 1 : 0,\n  };\n\n  return (\n    <RowToolbarWrapper\n      style={style}\n      role=\"toolbar\"\n      data-testid=\"table-row-toolbar\"\n      scale={scale}\n      ref={rowToolbarRef}\n      onMouseOut={handleMouseOut}\n    >\n      {renderRowToolbarItems}\n      <RowResizer ref={rowResizerRef} />\n      {ReactDOM.createPortal(\n        <RowInlineToolbar\n          isShow={isShowDelete()}\n          ref={deleteButtonRef}\n          data-testid=\"table-row-inline-toolbar\"\n        >\n          <InlineToolbarDeleteButton\n            scale={scale}\n            mode=\"row\"\n            locale={locale}\n            onDelete={deleteRow}\n            onHighlightSelection={highlightSelection}\n            onCancelHighlightSelection={cancelHighlightSelection}\n          />\n        </RowInlineToolbar>,\n        zoomContainer,\n      )}\n      <RowInlineToolbar\n        ref={insertButtonRef}\n        data-testid=\"table-row-inline-toolbar-insert\"\n        isShow={isRowInlineToolbarShow}\n        onMouseMove={handlePreventDefault}\n      >\n        <InlineToolbarInsertButton\n          locale={locale}\n          table={table}\n          rowIndicatorRef={rowIndicatorRef}\n          selection={selection}\n          mode=\"row\"\n          tableRef={tableRef}\n          scale={scale}\n          onInsert={insertRow}\n          zoomContainer={zoomContainer}\n          insertIndex={positionOfInsertButton}\n          onShowIndicatorVisible={showIndicatorVisible}\n        />\n      </RowInlineToolbar>\n      {zoomContainer && ReactDOM.createPortal(\n        <DragElement\n          ref={dragElementRef}\n          visible={isDragging}\n          height={draggingRowHeight}\n          width={tableWidth + TOOLBAR_ITEM_SIZE}\n        />,\n        zoomContainer,\n      )}\n    </RowToolbarWrapper>\n  );\n};\n\nexport default createToolbarWithTableSeletion(TableRowToolbar);\n"],"file":"index.js"}