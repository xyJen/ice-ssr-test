{"version":3,"sources":["../../../../src/bi/components/table.tsx"],"names":["getTableIsSelected","visibleUtil","utils","getColIndex","cell","border","table","cellKey","getAttribute","position","colIndex","parseInt","getRowKey","row","parentElement","rowElements","Array","from","children","rowIndex","indexOf","adjustedRowIndex","adjustedRow","getPrevVisibleCell","prevVisibleCell","previousElementSibling","style","display","getNextVisibleCell","nextVisibleCell","nextElementSibling","lastActiveTableKey","closeContextMenu","actions","getLastActiveTableKey","Table","React","Component","constructor","props","colResizeable","rowResizeable","resizingColIndex","resizingRowKey","resizingColCell","resizingColNextCell","resizingRow","startTableX","startTableY","wrapperRef","createRef","realTableWrapperRef","tableRef","colResizerRef","rowResizerRef","colIndicatorRef","rowIndicatorRef","tableResizeControllerRef","tableResizeControlLinesRef","tableLeftShadowRef","tableRightShadowRef","lastEndCellKey","tableSelection","colsNodes","updateShadowRafId","tableCursorStyle","isResizingTable","controller","run","getContainerWidth","node","value","containerBlock","containerWidth","handleMouseEnter","current","cursor","handleMouseMove","event","zoomContainer","relativeEvent","isInNestedTable","targetCell","target","closest","prevCursor","targetCellRect","deltaToLeft","relativeX","left","deltaToRight","right","deltaToTop","relativeY","top","deltaToBottom","bottom","DETECT_DELTA","handleMouseDown","key","buttons","handleColResizeStart","handleRowResizeStart","handleTableResizeStart","scale","preventDefault","stopPropagation","realTableWrapper","ReactDOM","findDOMNode","realTableWrapperRect","Math","round","document","addEventListener","handleTableResizing","handleTableResizeEnd","tableRect","tableResizeController","currentTableX","max","MIN_COL_WIDTH","currentTableY","MIN_ROW_HEIGHT","rowsHeight","query","deltaX","deltaY","removeEventListener","maxTableWidth","updateShadowState","firstRowDOM","querySelector","firstRowRect","colResizer","height","isSelected","TOOLBAR_ITEM_SIZE","handleColResizing","handleColResizeEnd","colsWidth","resizingColCellRect","resizingColCellRectLeft","resizingColCellIndex","data","type","nodeData","fixedColWidth","slice","reduce","sum","colWidth","validLeftLimit","totalWidth","validRightLimit","Infinity","resizingColNextCellRect","resizingColNextCellRectLeft","resizingColNextCellIndex","validClientX","min","delta","isNaN","handleColResize","resizeColIndex","rowResizer","marginTop","tableWidth","width","handleRowResizing","handleRowResizeEnd","resizingColRectTop","validTopLimit","validClientY","handleRowResize","tableRow","getNode","originalHeight","handleSelectRow","selectedRowRange","shouldHideContextMenu","start","end","handleSelectCol","selectedColRange","handleSelectCorner","updateShadowStyleCallback","visible","dataTable","unregisterVisibleChange","tableLeftShadow","tableRightShadow","updateShadowStyle","getVisible","registerVisibleChange","updateScrollLeft","percentOfScrollLeft","scrollContainer","offsetWidth","totalScroll","scrollTo","behavior","updateTableResizeController","tableDOM","updateOnRender","handleTableToolbarContextMenu","handleMenuEvent","selection","getTableSelection","window","cancelAnimationFrame","requestAnimationFrame","fastdom","measure","shouldShowTableLeftShadow","scrollLeft","scrollableContentWidth","shouldShowTableRightShadow","prevLeft","prevRight","state","setState","handleTableScroll","tableConfig","onScroll","tblSelections","curTableSelection","find","ts","getTableLeftMaxBorder","nodes","acc","firstCell","hidden","bdr","sz","getAllColsNodes","handleSetIsHighlightSelection","isHighlight","isSelectionHighlight","handleSetHoverSelection","sel","hoverSelection","isShowCornerToolbar","hideCornerButton","handleMouseEnterTable","isHoverTable","handleMouseLeaveTable","setWholeTableHoverSelection","cols","length","rows","endColIndex","endRowIndex","startColIndex","startRowIndex","removeWholeTableHoverSelection","handleMouseEnterCornerToolbar","isHoverCornerToolbar","handleMouseLeaveCornerToolbar","componentDidMount","componentDidUpdate","prevProps","prevNode","prevIsSelected","componentWillUnmount","cancel","Boolean","render","locale","scrollableContainer","draggableConfig","hideDeleteButton","hideWidthFitButton","enableAutofitWidth","enableHeader","setTableHeaderStyle","leftOffset","floor","isSelectWholeTable","isHideDeleteButton","disableHorizontalScrollbar","marginLeft","paddingLeft","paddingTop","REALTABLE_PADDING","paddingBottom","Container","body","pendingSelectedWhole","setPendingSelectedWhole","useState","realSelected","setRealSelected","forceUpdate","useReducer","c","useEffect","newTable","shouldUpdateTable","useCallback","isPendingSelected","hasHots","memoProps","useMemo","pixelColsWidth","enableHeaderSticky"],"mappings":"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","sourcesContent":["/* eslint-disable max-lines */\n/* eslint-disable react/no-find-dom-node */\nimport * as React from 'react';\nimport * as ReactDOM from 'react-dom';\nimport { throttle } from 'lodash-es';\nimport fastdom from 'fastdom';\nimport {\n  Controller,\n  Block,\n  useZoom,\n  useZoomContainer,\n  BiPluginConfig,\n  useScrollableContainer,\n} from '@ali/4ever-cangjie';\nimport { actions } from '@ali/4ever-plugin-pc-contex-menu';\nimport MoTable from '../../mo/models';\nimport {\n  getClosestContainerBlock,\n  getInnerWidth,\n  getBoundingRelativeRect,\n  getRelativeMouseEvent,\n} from '@ali/4ever-utils';\nimport {\n  resizeTableWidth,\n  resizeTableWidthFitContainer,\n  resizeTableHeight,\n  resizeTableColWidth,\n  setTableRowHeight,\n  deleteTable,\n  selectTableCols,\n  selectTableRows,\n  selectTable,\n  scrollTable,\n  adjustColsWidth,\n} from '../actions';\nimport getPositionOfCell from '../utils/getPositionOfCell';\nimport {\n  MIN_COL_WIDTH,\n  MIN_ROW_HEIGHT,\n  DETECT_DELTA,\n  TOOLBAR_ITEM_SIZE,\n} from '../constants';\nimport createTableSelectionForFocusedCell from '../utils/createTableSelectionForFocusedCell';\nimport TableCornerToolbar from './cornerToolbar';\nimport TableColToolbar from './colToolbar';\nimport TableRowToolbar from './rowToolbar';\nimport TableResizeController from './tableResizeController';\nimport {\n  ColResizer,\n  RowResizer,\n  ColIndicator,\n  RowIndicator,\n  Wrapper,\n  TableLeftSideShadow,\n  TableRightSideShadow,\n} from './styled';\nimport { logNPEInfo } from '../utils/logger';\nimport { ISelectedIndexRange, ITableSelection, TableConfig } from '../types';\nimport TableWithSelection from './tableWithSelection';\nimport CornerButton from './cornerButton';\nimport { useSelectionStatus } from '../../utils/hooks/useSelectionStatus';\nimport { REALTABLE_PADDING } from '../../utils/constants';\nimport TableScrollContainer from '../../components/tableScrollContainer';\nimport { TableIsSelectedContext } from '../../utils/hooks/useTableIsSelected';\nimport utils from '../../utils/utils';\nimport { PixelColsWidthContext } from '../../utils/hooks/usePixelColsWidth';\nimport TableContextContainer from '../../components/tableContextContainer';\nimport { ContextContainer } from './contextContainer';\n\nconst { getTableIsSelected, visibleUtil } = utils;\n\nfunction getColIndex(cell: HTMLTableCellElement, border: 'left' | 'right', table: MoTable) {\n  const cellKey = cell.getAttribute('data-cangjie-key')!;\n  const position = getPositionOfCell(\n    cellKey,\n    table,\n  );\n\n  const colIndex = position && position.colIndex;\n  if (!(typeof colIndex === 'number' && colIndex >= 0)) {\n    return null;\n  }\n\n  return border === 'left'\n    ? colIndex - 1\n    : colIndex + (parseInt(cell.getAttribute('colspan')!, 10) || 1) - 1;\n}\n\nfunction getRowKey(cell: HTMLTableCellElement, border: 'top' | 'bottom' | false) {\n  const row = cell.parentElement;\n  if (!row) {\n    return null;\n  }\n  const rowElements = Array.from(row.parentElement!.children);\n  const rowIndex = rowElements.indexOf(row!);\n  const adjustedRowIndex = border === 'top' ? rowIndex - 1 : rowIndex;\n  const adjustedRow = rowElements[adjustedRowIndex];\n  if (adjustedRow) {\n    return adjustedRow.getAttribute('data-cangjie-key');\n  }\n  return null;\n}\n\nfunction getPrevVisibleCell(cell: HTMLTableCellElement) {\n  let prevVisibleCell = cell.previousElementSibling as HTMLTableCellElement;\n  while (prevVisibleCell && prevVisibleCell.style.display === 'none') {\n    prevVisibleCell = prevVisibleCell.previousElementSibling as HTMLTableCellElement;\n  }\n  return prevVisibleCell;\n}\n\nfunction getNextVisibleCell(cell: HTMLTableCellElement) {\n  let nextVisibleCell = cell.nextElementSibling as HTMLTableCellElement;\n  while (nextVisibleCell && nextVisibleCell.style.display === 'none') {\n    nextVisibleCell = nextVisibleCell.nextElementSibling as HTMLTableCellElement;\n  }\n  return nextVisibleCell;\n}\n\nexport interface Selection {\n  startRowIndex: number;\n  startColIndex: number;\n  endRowIndex: number;\n  endColIndex: number;\n}\n\nlet lastActiveTableKey: string | null = null;\nconst { closeContextMenu } = actions;\n\nfunction getLastActiveTableKey() {\n  return lastActiveTableKey;\n}\n\nexport interface TableProps {\n  controller: Controller;\n  isSelected: boolean;\n  node: MoTable;\n  colsWidth: number[];\n  scale: number;\n  zoomContainer: HTMLElement;\n  scrollableContainer?: Window | HTMLElement | null;\n  tableSelection?: Omit<ITableSelection, 'key'> | null;\n  children: () => React.ReactNode;\n  tableConfig?: TableConfig;\n  draggableConfig?: BiPluginConfig['draggable'];\n  locale: any;\n  visible?: boolean;\n}\n\ninterface TableState {\n  shouldShowTableLeftShadow: boolean;\n  shouldShowTableRightShadow: boolean;\n  isSelectionHighlight: boolean;\n  hoverSelection: ITableSelection | null;\n  isHoverTable: boolean;\n  isHoverCornerToolbar: boolean;\n}\n\nclass Table extends React.Component<TableProps, TableState> {\n  colResizeable: false | 'left' | 'right' = false;\n\n  rowResizeable: false | 'top' | 'bottom' = false;\n\n  resizingColIndex: number | null = null;\n\n  resizingRowKey: string | null = null;\n\n  resizingColCell: HTMLTableCellElement | null = null;\n\n  resizingColNextCell: HTMLTableCellElement | null = null;\n\n  resizingRow: HTMLTableCellElement | null = null;\n\n  startTableX: number | null = null;\n\n  startTableY: number | null = null;\n\n  wrapperRef: React.RefObject<HTMLDivElement> = React.createRef();\n\n  realTableWrapperRef: React.RefObject<HTMLDivElement> = React.createRef();\n\n  tableRef: React.RefObject<HTMLTableElement> = React.createRef();\n\n  colResizerRef: React.RefObject<HTMLDivElement> = React.createRef();\n\n  rowResizerRef: React.RefObject<HTMLDivElement> = React.createRef();\n\n  colIndicatorRef: React.RefObject<HTMLTableElement> = React.createRef();\n\n  rowIndicatorRef: React.RefObject<HTMLTableElement> = React.createRef();\n\n  tableResizeControllerRef: React.RefObject<HTMLDivElement> = React.createRef();\n\n  tableResizeControlLinesRef: React.RefObject<\n  HTMLDivElement\n  > = React.createRef();\n\n  tableLeftShadowRef: React.RefObject<HTMLDivElement> = React.createRef();\n\n  tableRightShadowRef: React.RefObject<HTMLDivElement> = React.createRef();\n\n  lastEndCellKey: string | null = null;\n\n  tableSelection: ITableSelection | null = null;\n\n  colsNodes: HTMLDivElement[] = [];\n\n  updateShadowRafId: number | null = null;\n\n  tableCursorStyle: string | null = null;\n\n  isResizingTable = false;\n\n  constructor(props: TableProps) {\n    super(props);\n    this.state = {\n      shouldShowTableLeftShadow: false,\n      shouldShowTableRightShadow: false,\n      isSelectionHighlight: false,\n      hoverSelection: null,\n      isHoverTable: false,\n      isHoverCornerToolbar: false,\n    };\n  }\n\n  componentDidMount() {\n    this.updateOnRender();\n    this.updateShadowState();\n    this.updateScrollLeft();\n  }\n\n  componentDidUpdate(prevProps: TableProps) {\n    fastdom.measure(() => {\n      const { node, isSelected } = this.props;\n      this.updateOnRender();\n\n      const { node: prevNode, isSelected: prevIsSelected } = prevProps;\n      if (\n        isSelected !== prevIsSelected ||\n        (node.data.colsWidth || []).length !==\n        (prevNode.data.colsWidth || []).length\n      ) {\n        this.handleTableScroll();\n      }\n      if (node.data?.percentOfScrollLeft !== prevNode.data?.percentOfScrollLeft) {\n        this.updateScrollLeft();\n      }\n    });\n  }\n\n  componentWillUnmount() {\n    this.handleTableScroll.cancel();\n    this.updateOnRender.cancel();\n    if (this.updateShadowRafId !== null) {\n      window.cancelAnimationFrame(this.updateShadowRafId);\n    }\n\n    document.removeEventListener('mousemove', this.handleColResizing);\n    document.removeEventListener('mouseup', this.handleColResizeEnd);\n\n    document.removeEventListener('mousemove', this.handleRowResizing);\n    document.removeEventListener('mouseup', this.handleRowResizeEnd);\n\n    document.removeEventListener('mousemove', this.handleTableResizing);\n    document.removeEventListener('mouseup', this.handleTableResizeEnd);\n  }\n\n  isInNestedTable(event) {\n    const table = event.target.closest('table');\n    return table !== ReactDOM.findDOMNode(this.tableRef.current);\n  }\n\n  isSelected() {\n    const { isSelected } = this.props;\n    return isSelected || Boolean(this.getTableSelection());\n  }\n\n  closeContextMenu = () => {\n    const { controller } = this.props;\n    controller.run('onAction', closeContextMenu());\n  };\n\n  getContainerWidth = () => {\n    const { controller, node } = this.props;\n    const { value } = controller;\n    const containerBlock = getClosestContainerBlock(value, node);\n    const containerWidth = getInnerWidth(containerBlock);\n    return containerWidth;\n  };\n\n  handleMouseEnter = () => {\n    if (!this.realTableWrapperRef.current) return;\n\n    this.tableCursorStyle = this.realTableWrapperRef.current.style.cursor;\n  };\n\n  handleMouseMove = (event) => {\n    const { zoomContainer } = this.props;\n    const relativeEvent = getRelativeMouseEvent(event, zoomContainer);\n    if (\n      this.startTableX || // 正在调整列宽\n      this.startTableY ||\n      this.isInNestedTable(event)\n    ) {\n      return;\n    }\n\n    const targetCell = event.target.closest('td');\n    const prevCursor = this.tableCursorStyle;\n\n    if (!targetCell) {\n      return;\n    }\n\n    const targetCellRect = getBoundingRelativeRect(targetCell, zoomContainer);\n    const deltaToLeft = relativeEvent.relativeX - targetCellRect.left;\n    const deltaToRight = targetCellRect.right - relativeEvent.relativeX;\n    const deltaToTop = relativeEvent.relativeY - targetCellRect.top;\n    const deltaToBottom = targetCellRect.bottom - relativeEvent.relativeY;\n\n    // DETECT_DELTA不加成scale比较合理\n\n    if (deltaToLeft <= DETECT_DELTA) {\n      if (!targetCell.previousElementSibling) {\n        this.colResizeable = false;\n        targetCell.style.cursor = prevCursor;\n      } else {\n        this.colResizeable = 'left';\n        this.rowResizeable = false;\n        targetCell.style.cursor = 'col-resize';\n      }\n    } else if (deltaToRight <= DETECT_DELTA) {\n      this.colResizeable = 'right';\n      this.rowResizeable = false;\n      targetCell.style.cursor = 'col-resize';\n    } else if (deltaToTop <= 4) {\n      if (!targetCell.parentElement.previousElementSibling) {\n        this.rowResizeable = false;\n        targetCell.style.cursor = prevCursor;\n      } else {\n        this.rowResizeable = 'top';\n        this.colResizeable = false;\n        targetCell.style.cursor = 'row-resize';\n      }\n    } else if (deltaToBottom <= DETECT_DELTA) {\n      this.rowResizeable = 'bottom';\n      this.colResizeable = false;\n      targetCell.style.cursor = 'row-resize';\n    } else {\n      this.rowResizeable = false;\n      this.colResizeable = false;\n      // 单元格的鼠标默认样式\n      targetCell.style.cursor = prevCursor;\n    }\n  };\n\n  handleMouseDown = (event: React.MouseEvent<HTMLTableElement>) => {\n    const { node } = this.props;\n    lastActiveTableKey = node.key;\n    // 右键 mouseDown 不处理\n    if (\n      this.isInNestedTable(event) ||\n      event.buttons === 2\n    ) {\n      return;\n    }\n\n    if (this.colResizeable) {\n      this.handleColResizeStart(event);\n    } else if (this.rowResizeable) {\n      this.handleRowResizeStart(event);\n    }\n  };\n\n  handleTableResizeStart = (event) => {\n    const { scale, zoomContainer } = this.props;\n    event.preventDefault();\n    event.stopPropagation();\n    const relativeEvent = getRelativeMouseEvent(event, zoomContainer);\n    const realTableWrapper = ReactDOM.findDOMNode(this.realTableWrapperRef.current) as HTMLElement;\n    const realTableWrapperRect = getBoundingRelativeRect(\n      realTableWrapper,\n      zoomContainer,\n    );\n\n    this.startTableX = Math.round(\n      (relativeEvent.relativeX - realTableWrapperRect.left) / scale,\n    );\n    this.startTableY = Math.round(\n      (relativeEvent.relativeY - realTableWrapperRect.top) / scale,\n    );\n    if (this.tableResizeControlLinesRef.current) {\n      this.tableResizeControlLinesRef.current.style.display = 'block';\n    }\n\n    this.isResizingTable = true;\n\n    document.addEventListener('mousemove', this.handleTableResizing);\n    document.addEventListener('mouseup', this.handleTableResizeEnd);\n  };\n\n  handleTableResizing = (event) => {\n    const { scale, zoomContainer } = this.props;\n    if (!zoomContainer) return;\n\n    event.preventDefault();\n    event.stopPropagation();\n    const relativeEvent = getRelativeMouseEvent(event, zoomContainer);\n    const realTableWrapper = this.realTableWrapperRef.current;\n    if (!realTableWrapper || !this.tableRef.current || !this.tableResizeControllerRef.current) return;\n    const realTableWrapperRect = getBoundingRelativeRect(\n      realTableWrapper,\n      zoomContainer,\n    );\n    const table = this.tableRef.current;\n    const tableRect = getBoundingRelativeRect(table, zoomContainer);\n    const tableResizeController = this.tableResizeControllerRef.current;\n\n    const currentTableX = Math.max(\n      MIN_COL_WIDTH,\n      Math.round((relativeEvent.relativeX - realTableWrapperRect.left) / scale),\n    );\n    const currentTableY = Math.max(\n      MIN_ROW_HEIGHT,\n      Math.round((relativeEvent.relativeY - tableRect.top) / scale),\n    );\n\n    tableResizeController.style.left = `${currentTableX}px`;\n    tableResizeController.style.top =\n      `${currentTableY +\n      Math.round((tableRect.top - realTableWrapperRect.top) / scale)\n      }px`;\n  };\n\n  handleTableResizeEnd = (event) => {\n    this.isResizingTable = false;\n    event.preventDefault();\n    event.stopPropagation();\n    const { controller, node, zoomContainer, scale } = this.props;\n    const rowsHeight = controller.query('getAllRowsHeight', {\n      node,\n    });\n\n    const relativeEvent = getRelativeMouseEvent(event, zoomContainer);\n    const realTableWrapper = this.realTableWrapperRef.current;\n    if (!realTableWrapper) {\n      return;\n    }\n    const realTableWrapperRect = getBoundingRelativeRect(\n      realTableWrapper,\n      zoomContainer,\n    );\n\n    const deltaX =\n      Math.round((relativeEvent.relativeX - realTableWrapperRect.left) / scale) -\n      this.startTableX!;\n    const deltaY =\n      Math.round((relativeEvent.relativeY - realTableWrapperRect.top) / scale) -\n      this.startTableY!;\n\n    this.startTableX = null;\n    this.startTableY = null;\n    if (this.tableResizeControlLinesRef.current) {\n      this.tableResizeControlLinesRef.current.style.display = 'none';\n    }\n    document.removeEventListener('mousemove', this.handleTableResizing);\n    document.removeEventListener('mouseup', this.handleTableResizeEnd);\n    const maxTableWidth = controller.query('maxTableWidth', { node });\n    controller.run('onAction', resizeTableWidth(node, deltaX, maxTableWidth));\n    controller.run('onAction', resizeTableHeight(node, rowsHeight, deltaY));\n    this.updateShadowState();\n  };\n\n  handleColResizeStart = (event) => {\n    const { scale, zoomContainer, node } = this.props;\n    const relativeEvent = getRelativeMouseEvent(event, zoomContainer);\n\n    event.preventDefault();\n\n    const targetCell = event.target.closest('td');\n    if (!targetCell) {\n      return;\n    }\n    // @ts-ignore\n    this.resizingColIndex = getColIndex(targetCell, this.colResizeable, node);\n    if (typeof this.resizingColIndex !== 'number') {\n      return;\n    }\n    this.resizingColCell =\n      this.colResizeable === 'left'\n        ? getPrevVisibleCell(targetCell)\n        : targetCell;\n    this.resizingColNextCell =\n      this.colResizeable === 'left'\n        ? targetCell\n        : getNextVisibleCell(targetCell);\n\n    const realTableWrapper = ReactDOM.findDOMNode(this.realTableWrapperRef.current) as HTMLElement;\n    const realTableWrapperRect = getBoundingRelativeRect(\n      realTableWrapper,\n      zoomContainer,\n    );\n    const table = ReactDOM.findDOMNode(this.tableRef.current) as HTMLElement;\n    const tableRect = getBoundingRelativeRect(table, zoomContainer);\n    const firstRowDOM = table.querySelector('tr');\n    if (!firstRowDOM) return;\n\n    const firstRowRect = getBoundingRelativeRect(firstRowDOM, zoomContainer);\n\n    this.startTableX = relativeEvent.relativeX - realTableWrapperRect.left;\n\n    const colResizer = ReactDOM.findDOMNode(\n      this.colResizerRef.current,\n    ) as HTMLElement;\n    colResizer.style.display = 'block';\n    colResizer.style.height = `${\n      Math.round(tableRect.bottom - firstRowRect.top) / scale +\n      (this.isSelected() ? TOOLBAR_ITEM_SIZE / scale : 0)\n    }px`;\n\n    colResizer.style.left = `${Math.round(this.startTableX / scale)}px`;\n\n    document.addEventListener('mousemove', this.handleColResizing);\n    document.addEventListener('mouseup', this.handleColResizeEnd);\n  };\n\n  handleColResizing = (event) => {\n    const { node, colsWidth } = this.props;\n    const { scale, zoomContainer } = this.props;\n    if (!zoomContainer) return;\n\n    const relativeEvent = getRelativeMouseEvent(event, zoomContainer);\n\n    event.preventDefault();\n\n    const realTableWrapper = this.realTableWrapperRef.current;\n    const colResizer = this.colResizerRef.current;\n\n    // Fix: 找不到节点\n    if (!realTableWrapper || !colResizer || !this.resizingColCell) return;\n\n    const realTableWrapperRect = getBoundingRelativeRect(\n      realTableWrapper,\n      zoomContainer,\n    );\n    const resizingColCellRect = getBoundingRelativeRect(\n      this.resizingColCell,\n      zoomContainer,\n    );\n    const resizingColCellRectLeft = resizingColCellRect.left;\n    const resizingColCellIndex =\n      this.resizingColIndex! -\n      parseInt(this.resizingColCell.getAttribute('colspan')!, 10) +\n      1;\n    if (!node.data.colsWidth) {\n      logNPEInfo(node, {\n        type: `node.data.colsWidth is ${node.data.colsWidth}`,\n        nodeData: node.data,\n      });\n      return;\n    }\n    const fixedColWidth = (colsWidth || [])\n      .slice(resizingColCellIndex, this.resizingColIndex!)\n      .reduce((sum, colWidth) => sum + colWidth, 0);\n    const validLeftLimit =\n      resizingColCellRectLeft + fixedColWidth * scale + MIN_COL_WIDTH * scale;\n    const totalWidth = (colsWidth || []).reduce(\n      (sum, colWidth) => sum + colWidth,\n      0,\n    );\n    let validRightLimit = Infinity;\n    if (\n      this.resizingColNextCell &&\n      totalWidth <= this.getContainerWidth()! - 2\n    ) {\n      const resizingColNextCellRect = getBoundingRelativeRect(\n        this.resizingColNextCell,\n        zoomContainer,\n      );\n      const resizingColNextCellRectLeft = resizingColNextCellRect.left;\n      const resizingColNextCellIndex =\n        resizingColCellIndex +\n        parseInt(this.resizingColCell.getAttribute('colspan')!, 10);\n      validRightLimit =\n        resizingColNextCellRectLeft +\n        (colsWidth[resizingColNextCellIndex] - MIN_COL_WIDTH) * scale;\n    }\n    let validClientX = Math.max(validLeftLimit, relativeEvent.relativeX);\n    validClientX = Math.min(validRightLimit, validClientX);\n    colResizer.style.left = `${Math.round(\n      (validClientX - realTableWrapperRect.left) / scale,\n    )}px`;\n  };\n\n  handleColResizeEnd = () => {\n    const { scale } = this.props;\n    const colResizer = ReactDOM.findDOMNode(\n      this.colResizerRef.current,\n    ) as HTMLElement;\n    if (!colResizer) {\n      return;\n    }\n\n    const delta =\n      parseInt(colResizer.style.left, 10) -\n      Math.round(this.startTableX! / scale);\n    if (!isNaN(delta)) {\n      this.handleColResize(this.resizingColIndex, delta);\n    }\n\n    document.removeEventListener('mousemove', this.handleColResizing);\n    document.removeEventListener('mouseup', this.handleColResizeEnd);\n\n    colResizer.style.display = 'none';\n    colResizer.style.left = '';\n\n    this.resizingColIndex = null;\n    this.resizingColCell = null;\n    this.resizingColNextCell = null;\n    this.startTableX = null;\n  };\n\n  handleColResize = (resizeColIndex, delta) => {\n    const { controller, node } = this.props;\n    controller.run(\n      'onAction',\n      resizeTableColWidth({\n        node,\n        colIndex: resizeColIndex,\n        delta,\n      }),\n    );\n\n    this.updateShadowState();\n  };\n\n  handleRowResizeStart = (event) => {\n    const { scale, zoomContainer, isSelected } = this.props;\n    const relativeEvent = getRelativeMouseEvent(event, zoomContainer);\n    event.preventDefault();\n\n    const targetCell = event.target.closest('td');\n    if (!targetCell) {\n      return;\n    }\n    const resizingRowKey = getRowKey(targetCell, this.rowResizeable);\n    if (!resizingRowKey) {\n      return;\n    }\n    this.resizingRowKey = resizingRowKey;\n    this.resizingRow =\n      this.rowResizeable === 'top'\n        ? targetCell.parentElement.previousElementSibling\n        : targetCell.parentElement;\n\n    const realTableWrapper = ReactDOM.findDOMNode(this.realTableWrapperRef.current) as HTMLElement;\n    const realTableWrapperRect = getBoundingRelativeRect(\n      realTableWrapper,\n      zoomContainer,\n    );\n    const table = ReactDOM.findDOMNode(this.tableRef.current) as HTMLElement;\n    const tableRect = getBoundingRelativeRect(table, zoomContainer);\n\n    this.startTableY = relativeEvent.relativeY - realTableWrapperRect.top;\n\n    const rowResizer = ReactDOM.findDOMNode(\n      this.rowResizerRef.current,\n    ) as HTMLElement;\n    rowResizer.style.display = 'block';\n    rowResizer.style.marginTop = '-1px';\n    const tableWidth = Math.min(tableRect.width, realTableWrapperRect.width);\n    rowResizer.style.width = `${Math.round(\n      (tableWidth + (isSelected ? TOOLBAR_ITEM_SIZE : 0)) / scale,\n    )}px`;\n\n    rowResizer.style.top = `${Math.round(this.startTableY / scale)}px`;\n\n    document.addEventListener('mousemove', this.handleRowResizing);\n    document.addEventListener('mouseup', this.handleRowResizeEnd);\n  };\n\n  handleRowResizing = (event) => {\n    const { scale, zoomContainer } = this.props;\n    const relativeEvent = getRelativeMouseEvent(event, zoomContainer);\n    event.preventDefault();\n\n    const realTableWrapper = ReactDOM.findDOMNode(this.realTableWrapperRef.current) as HTMLElement;\n    const rowResizer = ReactDOM.findDOMNode(\n      this.rowResizerRef.current,\n    ) as HTMLElement;\n\n    // Fix: 找不到节点\n    if (!realTableWrapper || !rowResizer || !this.resizingRow) return;\n\n    const realTableWrapperRect = getBoundingRelativeRect(\n      realTableWrapper,\n      zoomContainer,\n    );\n    const resizingColRectTop = getBoundingRelativeRect(\n      this.resizingRow,\n      zoomContainer,\n    ).top;\n    const validTopLimit = resizingColRectTop + MIN_ROW_HEIGHT * scale;\n    const validClientY = Math.max(validTopLimit, relativeEvent.relativeY);\n    rowResizer.style.top = `${Math.round(\n      (validClientY - realTableWrapperRect.top) / scale,\n    )}px`;\n  };\n\n  handleRowResizeEnd = () => {\n    const { scale } = this.props;\n    const rowResizer = ReactDOM.findDOMNode(\n      this.rowResizerRef.current,\n    ) as HTMLElement;\n    if (!rowResizer) {\n      return;\n    }\n\n    const delta =\n      parseInt(rowResizer.style.top, 10) - Math.round(this.startTableY! / scale);\n    if (!isNaN(delta)) {\n      this.handleRowResize(this.resizingRowKey, delta);\n    }\n\n    document.removeEventListener('mousemove', this.handleRowResizing);\n    document.removeEventListener('mouseup', this.handleRowResizeEnd);\n\n    rowResizer.style.display = 'none';\n    rowResizer.style.top = '';\n\n    this.resizingRowKey = null;\n    this.resizingRow = null;\n    this.startTableY = null;\n  };\n\n  handleRowResize = (resizingRowKey, delta) => {\n    const { controller } = this.props;\n    const tableRow = controller.value.document.getNode(resizingRowKey);\n    // 协同者可能删除 row\n    if (!tableRow) return;\n    const originalHeight = controller.query('getRowsHeight', {\n      node: tableRow,\n    });\n    controller.run(\n      'onAction',\n      setTableRowHeight(tableRow, originalHeight + delta),\n    );\n  };\n\n  handleSelectRow = (\n    selectedRowRange: ISelectedIndexRange,\n    shouldHideContextMenu = true,\n  ) => {\n    const { controller, node } = this.props;\n    // selections不止一个的情况，交给pi处理\n    lastActiveTableKey = node.key;\n    const { start, end } = selectedRowRange;\n    controller.run(\n      'onAction',\n      selectTableRows(node, start, end),\n    );\n    if (shouldHideContextMenu) {\n      this.closeContextMenu();\n    }\n  };\n\n  handleSelectCol = (\n    selectedColRange: ISelectedIndexRange,\n    shouldHideContextMenu = true,\n  ) => {\n    const { controller, node } = this.props;\n    // selections不止一个的情况，交给pi处理\n    lastActiveTableKey = node.key;\n    const { start, end } = selectedColRange;\n    controller.run(\n      'onAction',\n      selectTableCols(node, start, end),\n    );\n    if (shouldHideContextMenu) {\n      this.closeContextMenu();\n    }\n  };\n\n  handleSelectCorner = () => {\n    const { controller, node } = this.props;\n    // selections不止一个的情况，交给pi处理\n    lastActiveTableKey = node.key;\n    controller.run('onAction', selectTable(node));\n    this.closeContextMenu();\n  };\n\n  updateShadowStyleCallback = (visible: boolean) => {\n    if (!visible) return;\n\n    const { scale, zoomContainer, node: dataTable } = this.props;\n    visibleUtil.unregisterVisibleChange(dataTable.key, this.updateShadowStyleCallback);\n    const table = ReactDOM.findDOMNode(this.tableRef.current) as HTMLElement;\n    if (!table) {\n      return;\n    }\n    const tableRect = getBoundingRelativeRect(table, zoomContainer);\n\n    const tableLeftShadow = ReactDOM.findDOMNode(\n      this.tableLeftShadowRef.current,\n    ) as HTMLElement;\n    const tableRightShadow = ReactDOM.findDOMNode(\n      this.tableRightShadowRef.current,\n    ) as HTMLElement;\n\n    const height = `${Math.round(tableRect.height / scale)}px`;\n\n    if (tableLeftShadow) {\n      tableLeftShadow.style.height = height;\n    }\n    if (tableRightShadow) {\n      tableRightShadow.style.height = height;\n    }\n  };\n\n  updateShadowStyle = () => {\n    const { node } = this.props;\n    if (visibleUtil.getVisible(node.key)) {\n      this.updateShadowStyleCallback(true);\n    } else {\n      visibleUtil.unregisterVisibleChange(node.key, this.updateShadowStyleCallback);\n      visibleUtil.registerVisibleChange(node.key, this.updateShadowStyleCallback);\n    }\n  };\n\n  updateScrollLeft = () => {\n    const { node } = this.props;\n    const { percentOfScrollLeft } = node.data || {};\n    const scrollContainer = this.realTableWrapperRef.current;\n    if (!scrollContainer || !this.tableRef.current) {\n      return;\n    }\n    if (typeof percentOfScrollLeft === 'number') {\n      const containerWidth = scrollContainer.offsetWidth;\n      const tableWidth = this.tableRef.current.offsetWidth;\n      const totalScroll = tableWidth - containerWidth;\n      scrollContainer.scrollTo({\n        left: percentOfScrollLeft * totalScroll,\n        behavior: 'smooth',\n      });\n    }\n  };\n\n  updateTableResizeController = () => {\n    const { controller, scale, zoomContainer } = this.props;\n    if (!this.isSelected() || !zoomContainer) {\n      return;\n    }\n    const tableDOM = ReactDOM.findDOMNode(this.tableRef.current) as HTMLElement;\n    const realTableWrapper = ReactDOM.findDOMNode(this.realTableWrapperRef.current) as HTMLElement;\n    const tableResizeController = ReactDOM.findDOMNode(\n      this.tableResizeControllerRef.current,\n    ) as HTMLElement;\n    if (!tableResizeController || !tableDOM || !realTableWrapper) {\n      return;\n    }\n    const tableRect = getBoundingRelativeRect(tableDOM, zoomContainer);\n    const realTableWrapperRect = getBoundingRelativeRect(\n      realTableWrapper,\n      zoomContainer,\n    );\n    if (!controller.query('isTableSupportResize')) {\n      tableResizeController.style.display = 'none';\n      return;\n    }\n    // 可能出现小数的偏差，容错\n    if (tableRect.right <= realTableWrapperRect.right + 1) {\n      tableResizeController.style.display = '';\n      tableResizeController.style.left =\n        `${Math.round((tableRect.right - realTableWrapperRect.left) / scale)}px`;\n      tableResizeController.style.top =\n        `${Math.round((tableRect.bottom - realTableWrapperRect.top) / scale)}px`;\n    } else {\n      tableResizeController.style.display = 'none';\n    }\n  };\n\n  updateOnRender = throttle(() => {\n    this.updateTableResizeController();\n    this.updateShadowStyle();\n  });\n\n  handleTableToolbarContextMenu = (event: React.MouseEvent<HTMLElement>) => {\n    event.preventDefault();\n    const { controller } = this.props;\n    controller.run('onContextMenu', event);\n  };\n\n  handleMenuEvent = (type) => {\n    const { controller, node } = this.props;\n    let selection = this.getTableSelection();\n    if (!selection) {\n      selection = createTableSelectionForFocusedCell(controller.value, node);\n    }\n    if (type === 'delete-table') {\n      controller.run('onAction', deleteTable(node));\n    } else if (type === 'table-width-fit-container') {\n      controller.run('onAction', resizeTableWidthFitContainer(node));\n    }\n  };\n\n  updateShadowState = () => {\n    // 文档模型更新后，DOM 不会立刻更新，所以需要等待 DOM 更新后再计算阴影的状态\n    if (this.updateShadowRafId !== null) {\n      window.cancelAnimationFrame(this.updateShadowRafId);\n    }\n    this.updateShadowRafId = window.requestAnimationFrame(() => {\n      fastdom.measure(() => {\n        const table = ReactDOM.findDOMNode(this.tableRef.current) as HTMLElement;\n        const realTableWrapper = ReactDOM.findDOMNode(\n          this.realTableWrapperRef.current,\n        ) as HTMLElement;\n        if (!table || !realTableWrapper) {\n          return;\n        }\n        const { zoomContainer } = this.props;\n\n        const tableRect = getBoundingRelativeRect(table, zoomContainer);\n\n        const realTableWrapperRect = getBoundingRelativeRect(\n          realTableWrapper,\n          zoomContainer,\n        );\n        const shouldShowTableLeftShadow = realTableWrapper.scrollLeft > 0;\n        const scrollableContentWidth = tableRect.width;\n        const shouldShowTableRightShadow =\n          scrollableContentWidth - realTableWrapper.scrollLeft >\n          realTableWrapperRect.width;\n        const {\n          shouldShowTableLeftShadow: prevLeft,\n          shouldShowTableRightShadow: prevRight,\n        } = this.state;\n        if (\n          prevLeft !== shouldShowTableLeftShadow ||\n          prevRight !== shouldShowTableRightShadow\n        ) {\n          this.setState({ shouldShowTableLeftShadow, shouldShowTableRightShadow });\n        }\n      });\n    });\n  };\n\n  handleTableScroll = throttle(() => {\n    const { controller, node, tableConfig } = this.props;\n    const table = ReactDOM.findDOMNode(this.tableRef.current);\n    if (!table || !this.realTableWrapperRef.current) {\n      return;\n    }\n    controller.run('onAction', scrollTable(this.realTableWrapperRef.current));\n    if (tableConfig?.onScroll) {\n      tableConfig.onScroll(this.realTableWrapperRef.current, node);\n    }\n    this.updateShadowState();\n  });\n\n  getTableSelection = () => {\n    const { controller, node } = this.props;\n    const tblSelections = controller.query(\n      'viewTableSelections',\n    );\n    if (!tblSelections) {\n      return null;\n    }\n    const curTableSelection = tblSelections.find(\n      (ts) => ts.key === node.key,\n    );\n    if (!curTableSelection) {\n      return null;\n    }\n    return curTableSelection;\n  };\n\n  getTableLeftMaxBorder = (table: MoTable) => {\n    return table.nodes.reduce((acc, row: Block) => {\n      if (!row.nodes) {\n        return acc;\n      }\n      const firstCell = row.nodes[0] as Block;\n      if (\n        firstCell &&\n        firstCell.data &&\n        !firstCell.data.hidden &&\n        firstCell.data.bdr &&\n        firstCell.data.bdr.left &&\n        firstCell.data.bdr.left.sz > acc\n      ) {\n        return firstCell.data.bdr.left.sz;\n      }\n      return acc;\n    }, 1);\n  };\n\n  getAllColsNodes = (colsNodes: HTMLDivElement[]) => {\n    this.colsNodes = colsNodes;\n  };\n\n  handleSetIsHighlightSelection = (isHighlight: boolean) => {\n    this.setState({\n      isSelectionHighlight: isHighlight,\n    });\n  };\n\n  handleSetHoverSelection = (sel: ITableSelection | null) => {\n    this.setState({\n      hoverSelection: sel,\n    });\n  };\n\n  isShowCornerToolbar = () => {\n    const { tableConfig } = this.props;\n    return !tableConfig?.hideCornerButton?.();\n  };\n\n  handleMouseEnterTable = () => {\n    // 调整表格宽高时，会频繁触发 mouseenter 和 mouseleave\n    // 所以调整期间不更新 isHoverTable\n    if (this.isResizingTable) return;\n\n    this.setState({\n      isHoverTable: true,\n    });\n  };\n\n  handleMouseLeaveTable = () => {\n    if (this.isResizingTable) return;\n\n    this.setState({\n      isHoverTable: false,\n    });\n  };\n\n  setWholeTableHoverSelection = () => {\n    const cols = this.props.node.data?.colsWidth?.length;\n    const rows = this.props.node?.nodes.length;\n    if (!cols || !rows) {\n      this.handleSetHoverSelection(null);\n      return;\n    }\n    this.handleSetHoverSelection({\n      key: this.props.node.key,\n      endColIndex: cols - 1,\n      endRowIndex: rows - 1,\n      startColIndex: 0,\n      startRowIndex: 0,\n    });\n  };\n\n  removeWholeTableHoverSelection = () => {\n    this.handleSetHoverSelection(null);\n  };\n\n\n  handleMouseEnterCornerToolbar = () => {\n    this.setWholeTableHoverSelection();\n    this.setState({\n      isHoverCornerToolbar: true,\n    });\n  };\n\n  handleMouseLeaveCornerToolbar = () => {\n    this.removeWholeTableHoverSelection();\n    this.setState({\n      isHoverCornerToolbar: false,\n    });\n  };\n\n  render() {\n    const {\n      controller,\n      node,\n      children,\n      locale,\n      scale = 1,\n      zoomContainer,\n      scrollableContainer,\n      tableConfig = {},\n      draggableConfig,\n      visible,\n    } = this.props;\n\n    const {\n      hideDeleteButton = false,\n      hideWidthFitButton = false,\n      enableAutofitWidth,\n      enableHeader,\n      setTableHeaderStyle,\n    } = tableConfig;\n\n    const {\n      shouldShowTableLeftShadow,\n      shouldShowTableRightShadow,\n      isSelectionHighlight,\n      hoverSelection,\n      isHoverCornerToolbar,\n    } = this.state;\n\n    const leftOffset = Math.floor(this.getTableLeftMaxBorder(node) / 2);\n\n    const isSelected = this.isSelected();\n    const isSelectWholeTable = controller.query('isSelectWholeTable', {\n      node,\n    });\n\n    const isHideDeleteButton = typeof hideDeleteButton === 'function'\n      ? hideDeleteButton() : hideDeleteButton;\n\n    const style: React.CSSProperties = {};\n\n    if (visible === false) {\n      style.display = 'none';\n    }\n\n    return (\n      <Wrapper\n        ref={this.wrapperRef}\n        onClick={() => {\n          // onClick 多覆盖了悬浮工具栏onMouseDown被拦截的情况\n          lastActiveTableKey = node.key;\n        }}\n        onMouseDown={this.handleMouseDown}\n        onMouseEnter={this.handleMouseEnterTable}\n        onMouseLeave={this.handleMouseLeaveTable}\n        style={style}\n        data-type=\"table\"\n      >\n        <TableIsSelectedContext.Provider value={isSelected}>\n          <TableScrollContainer\n            className=\"real-table-wrapper\"\n            table={node}\n            controller={controller}\n            ref={this.realTableWrapperRef}\n            onMouseEnter={this.handleMouseEnter}\n            onMouseMove={this.handleMouseMove}\n            onScroll={this.handleTableScroll}\n            disableHorizontalScrollbar={tableConfig?.disableHorizontalScrollbar}\n            // note: 解决左border因滚动表格overflow auto被遮挡的问题\n            style={{\n              marginLeft: -leftOffset,\n              paddingLeft: leftOffset,\n              // 设置 paddingTop、marginTop 保证列工具栏「点」不会被 overflow hidden\n              paddingTop: REALTABLE_PADDING.top / scale,\n              marginTop: -REALTABLE_PADDING.top / scale,\n              paddingBottom: REALTABLE_PADDING.bottom, // 由于选中后表格边框有1px边距，因此不加bottom会产生滚动条\n            }}\n          >\n            <TableColToolbar\n              locale={locale}\n              controller={controller}\n              table={node}\n              tableRef={this.tableRef}\n              positionedAncestorRef={this.realTableWrapperRef}\n              scrollContainer={this.realTableWrapperRef}\n              colIndicatorRef={this.colIndicatorRef}\n              isTableSelected={isSelected}\n              onContextMenu={this.handleTableToolbarContextMenu}\n              onSelect={this.handleSelectCol}\n              onColResize={this.handleColResize}\n              onGetAllColsNodes={this.getAllColsNodes}\n              zoomContainer={zoomContainer}\n              getLastActiveTableKey={getLastActiveTableKey}\n              scale={scale}\n              setIsHighlightSelection={this.handleSetIsHighlightSelection}\n              hoverSelection={hoverSelection}\n              setHoverSelection={this.handleSetHoverSelection}\n              isHideDeleteButton={isHideDeleteButton}\n              isHoverCornerToolbar={isHoverCornerToolbar}\n            />\n            <TableWithSelection\n              ref={this.tableRef}\n              node={node}\n              controller={controller}\n              left={-leftOffset}\n              scale={scale}\n              tableSelection={this.getTableSelection()}\n              getTableSelection={this.getTableSelection}\n              hoverSelection={hoverSelection}\n              isSelectionHighlight={isSelectionHighlight}\n            >{children()}\n            </TableWithSelection>\n          </TableScrollContainer>\n          <TableResizeController\n            visible={isSelected}\n            onMouseDown={this.handleTableResizeStart}\n            ref={{\n              // @ts-ignore\n              tableResizeControllerRef: this.tableResizeControllerRef,\n              tableResizeControlLinesRef: this.tableResizeControlLinesRef,\n            }}\n          />\n          <ColResizer\n            ref={this.colResizerRef}\n          />\n          <RowResizer\n            ref={this.rowResizerRef}\n            style={{ left: isSelected ? -TOOLBAR_ITEM_SIZE / scale! : 0 }}\n          />\n          <ColIndicator\n            ref={this.colIndicatorRef}\n            isTableSelected={isSelected}\n            data-testid=\"table-col-indicator\"\n            scale={scale}\n          />\n          <RowIndicator\n            ref={this.rowIndicatorRef}\n            isTableSelected={isSelected}\n            data-testid=\"table-row-indicator\"\n          />\n          <TableLeftSideShadow\n            ref={this.tableLeftShadowRef}\n            scale={scale}\n            style={{\n              display: shouldShowTableLeftShadow ? 'block' : 'none',\n            }}\n          />\n          <TableRightSideShadow\n            ref={this.tableRightShadowRef}\n            scale={scale}\n            style={{\n              display: shouldShowTableRightShadow ? 'block' : 'none',\n            }}\n          />\n          <TableRowToolbar\n            locale={locale}\n            isSelected={isSelected}\n            controller={controller}\n            table={node}\n            tableRef={this.tableRef}\n            offsetParentRef={this.wrapperRef}\n            realTableWrapperRef={this.realTableWrapperRef}\n            rowIndicatorRef={this.rowIndicatorRef}\n            isSelectWholeTable={isSelectWholeTable}\n            onContextMenu={this.handleTableToolbarContextMenu}\n            onSelect={this.handleSelectRow}\n            onRowResize={this.handleRowResize}\n            zoomContainer={zoomContainer}\n            getLastActiveTableKey={getLastActiveTableKey}\n            scale={scale}\n            setIsHighlightSelection={this.handleSetIsHighlightSelection}\n            setHoverSelection={this.handleSetHoverSelection}\n            hoverSelection={hoverSelection}\n            scrollableContainer={scrollableContainer}\n            isHideDeleteButton={isHideDeleteButton}\n            isHoverCornerToolbar={isHoverCornerToolbar}\n          />\n          {this.isShowCornerToolbar() && (\n            <TableCornerToolbar\n              locale={locale}\n              visible={this.isSelected() || this.state.isHoverTable}\n              controller={controller}\n              realTableWrapperRef={this.realTableWrapperRef}\n              table={node}\n              isSelectWholeTable={!!isSelectWholeTable}\n              onSelect={this.handleSelectCorner}\n              onMouseEnter={this.handleMouseEnterCornerToolbar}\n              onMouseLeave={this.handleMouseLeaveCornerToolbar}\n              onToolbarEvent={this.handleMenuEvent}\n              zoomContainer={zoomContainer}\n              getLastActiveTableKey={getLastActiveTableKey}\n              scale={scale!}\n              setIsHighlightSelection={this.handleSetIsHighlightSelection}\n              hideWidthFitButton={hideWidthFitButton}\n              draggableConfig={draggableConfig}\n              enableAutofitWidth={enableAutofitWidth}\n              enableHeader={enableHeader}\n              setTableHeaderStyle={setTableHeaderStyle}\n            />\n          )}\n          <CornerButton\n            scale={scale!}\n            isSelected={isSelected}\n            onClick={this.handleSelectCorner}\n            active={isSelectWholeTable || isHoverCornerToolbar}\n            onMouseEnter={this.handleMouseEnterCornerToolbar}\n            onMouseLeave={this.handleMouseLeaveCornerToolbar}\n            hoverSelection={!!hoverSelection}\n          />\n        </TableIsSelectedContext.Provider>\n      </Wrapper>\n    );\n  }\n}\n\nconst Container: React.FC<Omit<TableProps, 'colsWidth' | 'scale' | 'zoomContainer'>> = (props) => {\n  const scrollableContainer = useScrollableContainer();\n  const zoomContainer = useZoomContainer() || window.document.body;\n  const scale = useZoom();\n  const { controller, node, visible } = props;\n\n  const [pendingSelectedWhole, setPendingSelectedWhole] = React.useState<boolean>(false);\n\n  // 当仓颉pendingEnable开启的时候通过监听selectionData$的变化来实时确定是否需要更新table\n  // 避免等待500ms的防抖延时后再更新\n  // pendingEnable为false的情况下，useSelectionStatus注册的回调函数不会执行，因为此时渲染更新是实时的\n  const [realSelected, setRealSelected] = React.useState<boolean>(false);\n  const [, forceUpdate] = React.useReducer((c) => !c, false);\n\n  React.useEffect(() => {\n    const newTable = controller.value.document.getNode(node.key) as MoTable;\n    if (!newTable) return;\n    setRealSelected(getTableIsSelected(newTable, controller));\n  }, [node, controller.value.selection, controller]);\n\n  const shouldUpdateTable = React.useCallback(({ isPendingSelected, isSelectWholeTable }) => {\n    setRealSelected(isPendingSelected);\n    setPendingSelectedWhole(isSelectWholeTable);\n    if (controller.hasHots()) {\n      forceUpdate();\n    }\n  }, [controller, node]);\n\n  useSelectionStatus(controller, node, shouldUpdateTable, []);\n\n  React.useEffect(() => {\n    controller.run('onAction', adjustColsWidth(node));\n  });\n\n  const memoProps = React.useMemo(() => {\n    return { ...props, isSelected: realSelected, isSelectWholeTable: pendingSelectedWhole };\n  }, [props, realSelected, pendingSelectedWhole]);\n\n  return (\n    <ContextContainer isSelected={realSelected}>\n      <PixelColsWidthContext.Consumer>\n        {([pixelColsWidth]) => (<Table\n          {...memoProps}\n          scrollableContainer={scrollableContainer}\n          zoomContainer={zoomContainer}\n          scale={scale || 1}\n          colsWidth={pixelColsWidth}\n          visible={visible}\n        />)}\n      </PixelColsWidthContext.Consumer>\n    </ContextContainer>\n  );\n};\n\nexport default (props: Omit<TableProps, 'colsWidth' | 'scale' | 'zoomContainer'>) => {\n  const { controller, node, tableConfig = {} } = props;\n  const { enableHeaderSticky } = tableConfig;\n\n  return (\n    <TableContextContainer\n      controller={controller}\n      table={node}\n      enableHeaderSticky={enableHeaderSticky}\n    >\n      <Container {...props} />\n    </TableContextContainer>\n  );\n};\n"],"file":"table.js"}