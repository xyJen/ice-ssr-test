{"version":3,"sources":["../../../src/components/tableRow.tsx"],"names":["BORDER_BOTTOM_WIDTH","STICKY_MARGIN_LEFT","TR","styled","tr","DEFAULT_BORDER_COLOR","STICKY_TOOLBAR_INDEX_MAP","stickyRow","TableRow","attributes","node","children","controller","parent","readOnly","rowDOMRef","React","useRef","height","data","h","MIN_ROW_HEIGHT","scrollContainer","top","setTop","useState","forceUpdate","useReducer","c","renderHeightRef","prevRelativeLeftRef","clientHeight","setClientHeight","isTableSelected","zoom","colsWidth","scrollContainerWidth","tableScrollLeft","isRowSticky","setIsSticky","forceUpdateTableSelection","updateRowClientHeight","scrollRect","setScrollableContainerRect","tableScrollContainer","shouldSticky","useMemo","HTMLElement","isSticky","topOffset","STICKY_ROW_TOP_HEIGHT","useEffect","shouldObserve","updateRowRenderHeight","useCallback","rect","stickyHeight","actualHeight","current","key","prevZoomRef","getBoundingClientRect","setTablePaddingTop","paddingTop","tableDOM","parentElement","style","useLayoutEffect","rowPosition","position","toolbarSpace","TOOLBAR_ITEM_SIZE","gridTemplateColumns","nodes","forEach","n","i","colSpan","hidden","push","colWidth","slice","reduce","acc","w","minHeight","display","gridAutoFlow","map","join","width","overflowX","left","Number","isFinite","scrollLeft","updateIsSticky","tableScrollRect","containerRect","tableRect","rowRect","scrollHeight","bottom","topSpace","relativeLeft","r","handleScroll","addEventListener","window","removeEventListener","stickyContext","noop"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport styled from 'styled-components';\nimport { noop, throttle } from 'lodash-es';\nimport { Block, RenderNodeProps, useZoom, useScrollableContainer } from '@ali/4ever-cangjie';\nimport Table from '../mo/models';\nimport MoTableRow from '../mo/models/tableRow';\nimport {\n  DEFAULT_BORDER_COLOR,\n  MIN_ROW_HEIGHT,\n  STICKY_ROW_TOP_HEIGHT,\n  STICKY_TOOLBAR_INDEX_MAP,\n  TOOLBAR_ITEM_SIZE,\n} from '../utils/constants';\nimport {\n  usePixelColsWidth,\n  useTableScrollContainerWidth,\n  useTableScrollContainerScrollLeft,\n  useScrollableContainerRect,\n  RowIsStickyContext,\n  useUpdateTableSelectionContext,\n  useTableIsSelected,\n  useRowIsSticky,\n  useRowsClientHeight,\n  useTableScrollContainer,\n} from '../utils/hooks';\nimport useResizeObserver from '../utils/utils/useResizeObserver';\nimport shouldRowSticky from '../utils/utils/shouldRowSticky';\n\nconst BORDER_BOTTOM_WIDTH = 1;\nconst STICKY_MARGIN_LEFT = -1;\n\nconst TR = styled.tr`\n  &[data-sticky=\"true\"] {\n    border-bottom: ${BORDER_BOTTOM_WIDTH}px solid ${DEFAULT_BORDER_COLOR};\n    margin-left: ${STICKY_MARGIN_LEFT}px;\n    z-index: ${STICKY_TOOLBAR_INDEX_MAP.stickyRow}; // 高于 selection\n    background: white;\n    box-shadow: rgb(17 31 44 / 10%) 0px 6px 4px -4px;\n    overscroll-behavior-x: none;\n\n    td {\n      border-width: 1px 0 0 1px;\n      margin-right: -1px;\n\n      &:last-of-type {\n        border-right: 1px solid ${DEFAULT_BORDER_COLOR};\n      }\n    }\n  }\n`;\n\nexport type TableRowProps = RenderNodeProps<Block>;\n\nconst TableRow: React.FC<TableRowProps> = ({\n  attributes,\n  node,\n  children,\n  controller,\n  parent,\n}) => {\n  const { readOnly } = controller;\n  const rowDOMRef = React.useRef<HTMLTableRowElement | null>(null);\n  const height = (node.data.h as number) || MIN_ROW_HEIGHT;\n  const scrollContainer = useScrollableContainer();\n  const [top, setTop] = React.useState(0);\n  const [, forceUpdate] = React.useReducer((c) => c + 1, 0);\n  const renderHeightRef = React.useRef(0);\n  const prevRelativeLeftRef = React.useRef(0);\n  const [clientHeight, setClientHeight] = React.useState(0);\n\n  const isTableSelected = useTableIsSelected();\n  const zoom = useZoom();\n  const [colsWidth] = usePixelColsWidth() || [];\n  const scrollContainerWidth = useTableScrollContainerWidth();\n  const tableScrollLeft = useTableScrollContainerScrollLeft();\n  const [isRowSticky, setIsSticky] = useRowIsSticky();\n  const [, forceUpdateTableSelection] = useUpdateTableSelectionContext();\n  const [, updateRowClientHeight] = useRowsClientHeight();\n  const [\n    scrollRect,\n    setScrollableContainerRect,\n  ] = useScrollableContainerRect();\n  const tableScrollContainer = useTableScrollContainer();\n\n  const shouldSticky = React.useMemo(() => {\n    return shouldRowSticky(node as MoTableRow, parent as Table)\n      && (scrollContainer instanceof HTMLElement);\n  }, [node, scrollContainer, parent]);\n\n  const isSticky = shouldSticky && isRowSticky;\n\n  const topOffset = isTableSelected ? STICKY_ROW_TOP_HEIGHT : 0;\n\n  React.useEffect(() => {\n    setTop(scrollRect.top + topOffset);\n  }, [scrollRect.top, topOffset]);\n\n  const shouldObserve = !readOnly || shouldSticky;\n  const updateRowRenderHeight = React.useCallback((rect: DOMRect) => {\n    // table display: none 时高度为 0\n    if (rect.height === 0) return;\n\n    const stickyHeight = rect.height - BORDER_BOTTOM_WIDTH;\n    const actualHeight = isSticky ? stickyHeight : rect.height;\n    if (renderHeightRef.current !== actualHeight) {\n      renderHeightRef.current = actualHeight;\n      updateRowClientHeight(node.key, actualHeight);\n      setClientHeight(actualHeight);\n    }\n  }, [node, updateRowClientHeight, isSticky]);\n  useResizeObserver(shouldObserve ? rowDOMRef.current : null, updateRowRenderHeight);\n\n  const prevZoomRef = React.useRef(zoom);\n  // 触发缩放 resizeObserver 无法监听到变化\n  React.useEffect(() => {\n    if (!rowDOMRef.current || prevZoomRef.current === zoom) return;\n\n    prevZoomRef.current = zoom;\n    const rect = rowDOMRef.current.getBoundingClientRect();\n    updateRowRenderHeight(rect);\n  }, [zoom, updateRowRenderHeight]);\n\n  const setTablePaddingTop = React.useCallback((paddingTop: string) => {\n    const tableDOM = rowDOMRef.current?.parentElement?.parentElement;\n    if (!tableDOM?.parentElement) return;\n\n    // NOTE: 不能设置 marginTop，会导致文档意外滚动\n    tableDOM.parentElement.style.paddingTop = paddingTop;\n  }, []);\n\n  // 组件销毁重置状态\n  React.useEffect(() => {\n    return () => {\n      updateRowClientHeight(node.key, null);\n      setIsSticky(false);\n      setTablePaddingTop('0px');\n    };\n  }, []);\n\n  React.useLayoutEffect(() => {\n    if (!rowDOMRef.current || !shouldSticky) return;\n\n    // IMPORTANT: 需要同时对首行设置 fixed 和对 table 父节点设置 paddingTop\n    // 通过 DOM 操作来保障同时生效，避免文档跳动\n    const rowPosition = isSticky ? 'fixed' : '';\n    rowDOMRef.current.style.position = rowPosition;\n\n    const toolbarSpace = readOnly ? 0 : TOOLBAR_ITEM_SIZE;\n    const paddingTop = isSticky ? `${clientHeight + toolbarSpace}px` : '0px';\n    setTablePaddingTop(paddingTop);\n  }, [isSticky, clientHeight, setTablePaddingTop, shouldSticky, readOnly]);\n\n  const style: React.CSSProperties = React.useMemo(() => {\n    if (!isSticky) {\n      return {\n        height,\n      };\n    }\n\n    const gridTemplateColumns: number[] = [];\n    (node as MoTableRow).nodes.forEach((n, i) => {\n      const { colSpan = 1, hidden } = n.data || {};\n      if (hidden) return;\n\n      if (colSpan === 1) {\n        gridTemplateColumns.push(colsWidth[i]);\n      } else {\n        const colWidth = colsWidth\n          .slice(i, i + colSpan)\n          .reduce((acc, w) => acc + w, 0);\n        gridTemplateColumns.push(colWidth);\n      }\n    });\n\n    return {\n      minHeight: height,\n      top,\n      // 通过 grid 模拟 table 布局\n      display: 'grid',\n      gridAutoFlow: 'column',\n      gridTemplateColumns: gridTemplateColumns.map((c) => `${c}px`).join(' '),\n      width: scrollContainerWidth,\n      overflowX: 'hidden',\n      left:\n        Number.isFinite(scrollRect.left)\n          ? scrollRect.left! - STICKY_MARGIN_LEFT\n          : 'unset',\n    };\n  }, [\n    colsWidth,\n    height,\n    isSticky,\n    node,\n    scrollContainerWidth,\n    top,\n    scrollRect.left,\n  ]);\n\n  React.useLayoutEffect(() => {\n    if (isSticky && rowDOMRef.current) {\n      rowDOMRef.current.scrollLeft = tableScrollLeft;\n    }\n  }, [tableScrollLeft, isSticky]);\n\n  React.useLayoutEffect(() => {\n    forceUpdateTableSelection();\n  }, [isSticky, forceUpdateTableSelection]);\n\n  const updateIsSticky = React.useCallback(() => {\n    const tableDOM = rowDOMRef.current?.parentElement?.parentElement;\n    if (!tableDOM || !tableScrollContainer) return;\n\n    const tableScrollRect = tableScrollContainer.getBoundingClientRect();\n    const containerRect = (scrollContainer as HTMLElement).getBoundingClientRect();\n    const tableRect = tableDOM.getBoundingClientRect();\n    // height 为 0 说明是 display none 状态\n    if (!rowDOMRef.current || tableRect.height === 0) {\n      setIsSticky(false);\n      return;\n    }\n\n    const rowRect = rowDOMRef.current.getBoundingClientRect();\n    const { height: scrollHeight } = (scrollContainer as HTMLElement).getBoundingClientRect();\n\n    if (\n      isSticky === false\n      && (\n        rowRect.height > tableRect.height / 2\n        || rowRect.height > scrollHeight / 3\n      )\n    ) {\n      return;\n    }\n\n    if (tableRect.bottom < containerRect.top + rowRect.height + topOffset) {\n      setIsSticky(false);\n      return;\n    }\n\n    const topSpace = isSticky ? rowRect.height : 0;\n    if (tableRect.top - topSpace - topOffset > containerRect.top) {\n      setIsSticky(false);\n      return;\n    }\n\n    const relativeLeft = tableScrollRect.left - rowRect.left;\n    if (\n      prevRelativeLeftRef.current !== relativeLeft\n    ) {\n      prevRelativeLeftRef.current = relativeLeft;\n      setScrollableContainerRect((r) => ({\n        ...r,\n        left: tableScrollRect.left,\n      }));\n    }\n\n    setIsSticky(true);\n    forceUpdateTableSelection();\n  }, [forceUpdateTableSelection, isSticky, scrollContainer, setIsSticky, topOffset, tableScrollLeft, tableScrollContainer]);\n\n  React.useEffect(() => {\n    if (!shouldSticky) return () => {};\n\n    // NOTE: 不要设置 delay，可能会导致异常\n    const handleScroll = throttle(() => {\n      updateIsSticky();\n    });\n\n    scrollContainer!.addEventListener('scroll', handleScroll);\n    window.addEventListener('resize', handleScroll);\n\n    return () => {\n      scrollContainer!.removeEventListener('scroll', handleScroll);\n      window.removeEventListener('resize', handleScroll);\n    };\n  }, [updateIsSticky, scrollContainer, shouldSticky]);\n\n  const stickyContext: [boolean, Function] = React.useMemo(() => {\n    return [shouldSticky && isSticky, noop];\n  }, [shouldSticky, isSticky]);\n\n  return (\n    <TR\n      {...attributes}\n      ref={(n) => {\n        if (n) {\n          if (!rowDOMRef.current) forceUpdate();\n          rowDOMRef.current = n;\n        }\n      }}\n      style={style}\n      data-sticky={isSticky}\n    >\n      <RowIsStickyContext.Provider value={stickyContext}>\n        {children()}\n      </RowIsStickyContext.Provider>\n    </TR>\n  );\n};\n\nexport default TableRow;\n"],"file":"tableRow.js"}