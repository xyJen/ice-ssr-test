import { Commands, Queries } from '@ali/4ever-cangjie';
import isSelectionInTableCell from "../utils/isSelectionInTableCell";
import getPositionOfCell from "../utils/getPositionOfCell";
import { isTableCell } from "../types";
import Table from "../../mo/models";
import TableCell from "../../mo/models/tableCell";
import { moveToStartOfCell, moveToStartOfPreviousSibling } from "../utils/selectionCommands";
import getNextNonHiddenCell from "../utils/getNextVisibleCell";
import setSelectionByTable from "../../utils/utils/setSelectionByTable";
export default function onArrowUp(event, controller, next) {
  var value = controller.value;
  var selection = value.selection,
      document = value.document,
      startBlock = value.startBlock;
  var tableSelection = controller.query('tableSelection');

  if (tableSelection) {
    event.preventDefault();
    var table = document.getNode(tableSelection.key);

    if (!table) {
      return;
    }

    if (controller.query('isSelectWholeTable', {
      node: table
    })) {
      return moveToStartOfPreviousSibling(controller, table);
    }

    var startColIndex = tableSelection.startColIndex,
        startRowIndex = tableSelection.startRowIndex;
    return moveToStartOfCell(controller, table, startRowIndex - 1, startColIndex);
  }

  if (!isSelectionInTableCell(value)) return next();
  var cell = document.getClosest(startBlock == null ? void 0 : startBlock.key, isTableCell);

  if (!cell) {
    return next();
  }

  var focusTable = document.getClosest(cell.key, Table.isTable);
  var position = getPositionOfCell(cell.key, focusTable);

  if (position.rowIndex === 0) {
    return next();
  }

  var newSelection = controller.query(Queries.getUpsideRange);

  if (!newSelection) {
    return next();
  }

  var anchor = newSelection.anchor;
  var newFocusCell = document.getClosest(anchor.key, TableCell.isTableCell); // 向下移动后，仍是同一个 cell 则不处理

  if ((newFocusCell == null ? void 0 : newFocusCell.key) === cell.key) {
    return next();
  }

  var nextCell = getNextNonHiddenCell(document, cell, 'up');

  if (!nextCell) {
    return next();
  }

  event.preventDefault();
  var s = selection.moveToEndOfNode(nextCell, controller);
  return controller.command(Commands.select, setSelectionByTable(s, false));
}
//# sourceMappingURL=onArrowUp.js.map