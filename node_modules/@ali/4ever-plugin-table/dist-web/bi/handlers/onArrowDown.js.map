{"version":3,"sources":["../../../../src/bi/handlers/onArrowDown.ts"],"names":["Commands","Queries","Table","TableCell","isSelectionInTableCell","getPositionOfCell","isTableCell","moveToStartOfCell","moveToStartOfNextSibling","getNextNonHiddenCell","setSelectionByTable","onArrowDown","event","controller","next","value","document","selection","startBlock","tableSelection","query","preventDefault","table","getNode","key","node","startColIndex","endRowIndex","cell","getClosest","focusTable","isTable","position","rowIndex","nodes","length","newSelection","getDownsideRange","anchor","newFocusCell","nextCell","s","moveToStartOfNode","command","select"],"mappings":"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","sourcesContent":["import {\n  Controller,\n  Commands,\n  Queries,\n} from '@ali/4ever-cangjie';\nimport Table from '../../mo/models';\nimport TableCell from '../../mo/models/tableCell';\nimport isSelectionInTableCell from '../utils/isSelectionInTableCell';\nimport getPositionOfCell from '../utils/getPositionOfCell';\nimport { isTableCell } from '../types';\nimport {\n  moveToStartOfCell,\n  moveToStartOfNextSibling,\n} from '../utils/selectionCommands';\nimport getNextNonHiddenCell from '../utils/getNextVisibleCell';\nimport setSelectionByTable from '../../utils/utils/setSelectionByTable';\n\nexport default function onArrowDown(event, controller: Controller, next) {\n  const { value } = controller;\n  const { document, selection, startBlock } = value;\n\n  const tableSelection = controller.query('tableSelection');\n  if (tableSelection) {\n    event.preventDefault();\n    const table = document.getNode(tableSelection.key) as Table | null;\n    if (!table) {\n      return;\n    }\n    if (controller.query('isSelectWholeTable', { node: table })) {\n      return moveToStartOfNextSibling(controller, table);\n    }\n    const { startColIndex, endRowIndex } = tableSelection;\n    return moveToStartOfCell(controller, table, endRowIndex + 1, startColIndex);\n  }\n\n  if (!isSelectionInTableCell(value)) {\n    return next();\n  }\n\n  const cell = document.getClosest(startBlock!.key, isTableCell) as TableCell;\n  if (!cell) {\n    return next();\n  }\n  const focusTable = document.getClosest(cell.key, Table.isTable) as Table;\n  const position = getPositionOfCell(cell.key, focusTable)!;\n  if (position.rowIndex === focusTable.nodes.length - 1) {\n    return next();\n  }\n\n  const newSelection = controller.query(Queries.getDownsideRange);\n  if (!newSelection) {\n    return next();\n  }\n  const { anchor } = newSelection;\n  const newFocusCell = document.getClosest(anchor.key, TableCell.isTableCell);\n  // 向下移动后，仍是同一个 cell 则不处理\n  if (newFocusCell?.key === cell.key) {\n    return next();\n  }\n\n  const nextCell = getNextNonHiddenCell(document, cell, 'down');\n  if (!nextCell) {\n    return next();\n  }\n\n  event.preventDefault();\n  const s = selection.moveToStartOfNode(nextCell, controller);\n  return controller.command(Commands.select, setSelectionByTable(s, false));\n}\n"],"file":"onArrowDown.js"}