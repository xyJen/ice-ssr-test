{"version":3,"sources":["../../../../src/bi/handlers/onDelete.ts"],"names":["Commands","EdgePoint","Queries","isEmptyParagraph","TableCell","emptyTableSelection","deleteTable","selectWholeTable","isKeyHotkey","isBackspaceHotKey","isDeleteHotKey","onDelete","event","controller","next","value","selection","document","startBlock","endBlock","tableSelection","query","preventDefault","table","getNode","key","isSelectWholeTable","node","run","edgeSelection","data","edge","isExpanded","startCell","getClosest","isTableCell","isDeleteKey","isBackspaceKey","anchor","isElement","nodes","length","parent","getParent","insertPoint","create","BEFORE","command","insertEmptyBlock","removeNodeByKey","endCell","block","getClosestBlock","isCollapsed","moveToStartOfNextBlock","backwardPoint","pointAtDistance","getStart","backwardCell","n","forwardPoint","getEnd","forwardCell","nextBlock","getNextSibling","type","isAtEndOfNode"],"mappings":"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","sourcesContent":["import { Block, Commands, Controller, EdgePoint, Queries } from '@ali/4ever-cangjie';\nimport { isEmptyParagraph } from '@ali/4ever-utils';\nimport Table from '../../mo/models';\nimport TableCell from '../../mo/models/tableCell';\nimport emptyTableSelection from '../commands/emptyTableSelection';\nimport deleteTable from '../commands/deleteTable';\nimport selectWholeTable from '../commands/selectWholeTable';\nimport { isKeyHotkey } from 'is-hotkey';\n\nconst isBackspaceHotKey = isKeyHotkey('backspace');\nconst isDeleteHotKey = isKeyHotkey('delete');\n\nexport default function onDelete(event, controller: Controller, next) {\n  const { value } = controller;\n  const { selection, document, startBlock, endBlock } = value;\n\n  const tableSelection = controller.query('tableSelection');\n  if (tableSelection) {\n    event.preventDefault();\n    const table = document.getNode(tableSelection.key) as Table;\n\n    if (table) {\n      const isSelectWholeTable = controller.query('isSelectWholeTable', {\n        node: table,\n      });\n      if (isSelectWholeTable) {\n        // @ts-ignore\n        return controller.run('onAction', deleteTable(controller, table));\n      }\n      // 删除选区内容而非其他东西\n      return emptyTableSelection(controller, table);\n    }\n    return controller;\n  }\n\n  const edgeSelection = value.data.edgeSelection;\n  if (edgeSelection) {\n    const table = document.getNode(edgeSelection.key);\n    if (edgeSelection.edge === 'before' && isDeleteHotKey(event)) {\n      // @ts-ignore\n      return controller.run('onAction', selectWholeTable(controller, table));\n    } else if (edgeSelection.edge === 'after' && isBackspaceHotKey(event)) {\n      // @ts-ignore\n      return controller.run('onAction', selectWholeTable(controller, table));\n    }\n    return controller;\n  }\n\n  if (!selection || selection.isExpanded) return next();\n\n  const startCell = startBlock ?\n    document.getClosest(startBlock.key, TableCell.isTableCell) as TableCell :\n    null;\n  const isDeleteKey = isDeleteHotKey(event);\n  const isBackspaceKey = isBackspaceHotKey(event);\n  const { anchor } = selection;\n\n  // 删除时，如果单元格内只有一个 void 元素，进行特殊处理\n  if (\n    startCell?.isElement() &&\n    startCell.nodes.length === 1\n  ) {\n    const parent = document.getParent(anchor.key);\n    if (parent === startCell.nodes[0] && controller.query('isVoid', parent)) {\n      const insertPoint = EdgePoint.create({\n        key: parent.key,\n        edge: EdgePoint.BEFORE,\n      });\n      return controller\n        .command(Commands.insertEmptyBlock, insertPoint)\n        .command(Commands.removeNodeByKey, parent.key);\n    }\n  }\n\n  const endCell = endBlock ?\n    document.getClosest(endBlock.key, TableCell.isTableCell) as TableCell :\n    null;\n\n  // 左移试探，发现移到其他单元格，则会删出问题，阻止\n  if (startCell && isBackspaceKey) {\n    const block = document.getClosestBlock(anchor.key);\n    if (\n      selection.isCollapsed &&\n      startCell.nodes.length !== 1 &&\n      startCell.nodes[0] === block &&\n      isEmptyParagraph(block)\n    ) {\n      return controller\n        .command(Commands.removeNodeByKey, block.key)\n        .command(Commands.moveToStartOfNextBlock);\n    }\n    const backwardPoint = controller.query(\n      Queries.pointAtDistance,\n      selection.getStart(document),\n      -1,\n    );\n    const backwardCell = backwardPoint?.key &&\n      document.getClosest(backwardPoint.key, n => n.key === startCell.key);\n\n    if (!backwardCell) {\n      event.preventDefault();\n      return controller;\n    }\n  }\n\n  if (endCell && isDeleteKey) {\n    const block = document.getClosestBlock(anchor.key);\n    if (\n      selection.isCollapsed &&\n      endCell.nodes.length !== 1 &&\n      endCell.nodes[0] === block &&\n      isEmptyParagraph(block)\n    ) {\n      return controller\n        .command(Commands.removeNodeByKey, block.key)\n        .command(Commands.moveToStartOfNextBlock);\n    }\n    const forwardPoint = controller.query(\n      Queries.pointAtDistance,\n      selection.getEnd(document),\n      1,\n    );\n    const forwardCell = forwardPoint?.key &&\n      document.getClosest(forwardPoint.key, n => n.key === endCell.key);\n\n    if (!forwardCell) {\n      event.preventDefault();\n      return controller;\n    }\n  }\n\n  const nextBlock = document.getNextSibling(endBlock?.key!) as Block;\n  if (\n    nextBlock\n    && nextBlock.type === 'table'\n    && selection.getEnd(document).isAtEndOfNode(endBlock!)\n    && isDeleteHotKey(event)\n  ) {\n    event.preventDefault();\n\n    // @ts-ignore\n    return controller.run('onAction', selectWholeTable(controller, nextBlock));\n  }\n\n  return next();\n}\n"],"file":"onDelete.js"}