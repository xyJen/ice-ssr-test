{"version":3,"sources":["../../../../src/bi/handlers/onCangjieInput.ts"],"names":["Commands","isTableCell","isSelectionAcrossTable","getRealNodeInTable","setSelectionByTable","onCangjieInput","event","controller","next","value","selection","document","tableSelection","query","table","getNode","key","startRowIndex","startColIndex","cell","s","moveToRangeOfNode","command","select","moveToFocus","start","getStart","startCell","getClosest","detail","type","isCollapsed","nodes","length","onlyBlock","onlyChildOfOnlyBlock","text"],"mappings":"AAAA,SAAqBA,QAArB,QAAqC,oBAArC;AAGA,SAASC,WAAT;AACA,OAAOC,sBAAP;AACA,SAASC,kBAAT;AACA,OAAOC,mBAAP;AAEA,eAAe,SAASC,cAAT,CAAwBC,KAAxB,EAA4CC,UAA5C,EAAoEC,IAApE,EAA0E;AAAA,MAC/EC,KAD+E,GACrEF,UADqE,CAC/EE,KAD+E;AAAA,MAE/EC,SAF+E,GAEvDD,KAFuD,CAE/EC,SAF+E;AAAA,MAEpEC,QAFoE,GAEvDF,KAFuD,CAEpEE,QAFoE;AAGvF,MAAMC,cAAc,GAAGL,UAAU,CAACM,KAAX,CAAiB,gBAAjB,CAAvB;;AACA,MAAID,cAAJ,EAAoB;AAClB,QAAME,KAAK,GAAGH,QAAQ,CAACI,OAAT,CAAiBH,cAAc,CAACI,GAAhC,CAAd;;AACA,QAAI,CAACF,KAAL,EAAY;AACV,aAAON,IAAI,EAAX;AACD;;AAJiB,QAKVS,aALU,GAKuBL,cALvB,CAKVK,aALU;AAAA,QAKKC,aALL,GAKuBN,cALvB,CAKKM,aALL;AAMlB,QAAMC,IAAI,GAAGhB,kBAAkB,CAACW,KAAD,EAAQG,aAAR,EAAuBC,aAAvB,CAA/B;AACA,QAAME,CAAC,GAAGV,SAAS,CAACW,iBAAV,CAA4BF,IAA5B,EAAmCZ,UAAnC,CAAV;AACAA,IAAAA,UAAU,CAACe,OAAX,CAAmBtB,QAAQ,CAACuB,MAA5B,EAAoCnB,mBAAmB,CAACgB,CAAD,EAAI,KAAJ,CAAvD;AACA,WAAOZ,IAAI,EAAX;AACD;;AACD,MAAIN,sBAAsB,CAACO,KAAD,CAA1B,EAAmC;AACjC,QAAMW,EAAC,GAAGV,SAAS,CAACc,WAAV,EAAV;;AACAjB,IAAAA,UAAU,CAACe,OAAX,CAAmBtB,QAAQ,CAACuB,MAA5B,EAAoCnB,mBAAmB,CAACgB,EAAD,EAAI,KAAJ,CAAvD;AACA,WAAOZ,IAAI,EAAX;AACD;;AACD,MAAMiB,KAAK,GAAGf,SAAS,CAACgB,QAAV,CAAmBf,QAAnB,CAAd;AACA,MAAMgB,SAAS,GAAGhB,QAAQ,CAACiB,UAAT,CAAoBH,KAAK,CAACT,GAA1B,EAA+Bf,WAA/B,CAAlB;;AACA,MACEK,KAAK,CAACuB,MAAN,CAAaC,IAAb,KAAsB,uBAAtB,IACApB,SAAS,CAACqB,WADV,IAEAJ,SAFA,IAGAA,SAAS,CAACK,KAAV,CAAgBC,MAAhB,KAA2B,CAJ7B,EAKE;AAAA;;AACA,QAAMC,SAAS,GAAGP,SAAS,CAACK,KAAV,CAAgB,CAAhB,CAAlB,CADA,CAEA;;AACA,QAAI,CAAAE,SAAS,QAAT,gCAAAA,SAAS,CAAEF,KAAX,sCAAkBC,MAAlB,MAA6B,CAAjC,EAAoC;AAClC,aAAOzB,IAAI,EAAX;AACD;;AACD,QAAM2B,oBAAoB,GAAGD,SAAS,CAACF,KAAV,CAAgB,CAAhB,CAA7B;;AACA,QAAIG,oBAAoB,CAACC,IAArB,KAA8B,EAAlC,EAAsC;AACpC,aAAO7B,UAAP;AACD;AACF;;AACD,SAAOC,IAAI,EAAX;AACD","sourcesContent":["import { Controller, Commands } from '@ali/4ever-cangjie';\nimport Table from '../../mo/models';\nimport TableCell from '../../mo/models/tableCell';\nimport { isTableCell } from '../types';\nimport isSelectionAcrossTable from '../utils/isSelectionAcrossTable';\nimport { getRealNodeInTable } from '../utils';\nimport setSelectionByTable from '../../utils/utils/setSelectionByTable';\n\nexport default function onCangjieInput(event: CustomEvent, controller: Controller, next) {\n  const { value } = controller;\n  const { selection, document } = value;\n  const tableSelection = controller.query('tableSelection');\n  if (tableSelection) {\n    const table = document.getNode(tableSelection.key) as Table;\n    if (!table) {\n      return next();\n    }\n    const { startRowIndex, startColIndex } = tableSelection;\n    const cell = getRealNodeInTable(table, startRowIndex, startColIndex);\n    const s = selection.moveToRangeOfNode(cell!, controller);\n    controller.command(Commands.select, setSelectionByTable(s, false));\n    return next();\n  }\n  if (isSelectionAcrossTable(value)) {\n    const s = selection.moveToFocus();\n    controller.command(Commands.select, setSelectionByTable(s, false));\n    return next();\n  }\n  const start = selection.getStart(document);\n  const startCell = document.getClosest(start.key, isTableCell) as TableCell;\n  if (\n    event.detail.type === 'deleteContentBackward' &&\n    selection.isCollapsed &&\n    startCell &&\n    startCell.nodes.length === 1\n  ) {\n    const onlyBlock = startCell.nodes[0];\n    // 非法表格（从 word 导入）中，cell 子节点可能是 text\n    if (onlyBlock?.nodes?.length !== 1) {\n      return next();\n    }\n    const onlyChildOfOnlyBlock = onlyBlock.nodes[0];\n    if (onlyChildOfOnlyBlock.text === '') {\n      return controller;\n    }\n  }\n  return next();\n}\n"],"file":"onCangjieInput.js"}