import equal from 'fast-deep-equal';
import { Commands } from '@ali/4ever-cangjie';
import Table from "../../mo/models";
import { isEmptyParagraph } from '@ali/4ever-utils';
import isSelectionInTableCell from "../utils/isSelectionInTableCell";
import isSelectWholeTable from "../queries/isSelectWholeTable";
import { isTableCell } from "../types";
import tableSelection from "../queries/tableSelection";
import { selectTable } from "../actions";

function isEmptyCell(cell) {
  return cell.nodes.length === 1 && isEmptyParagraph(cell.nodes[0]);
}

function isSelectWholeCell(controller, cell) {
  var _controller$value = controller.value,
      selection = _controller$value.selection,
      document = _controller$value.document;

  if (selection.isCollapsed && !isEmptyCell(cell)) {
    return false;
  }

  var cellSelection = selection.moveToRangeOfNode(cell, controller);
  return equal(cellSelection.sort(document), selection.sort(document));
}

export default function onSelectAll(controller, next, event) {
  var tbSelection = controller.query(tableSelection); // 选中表格时，cmd + a 选择整个文档

  if (tbSelection) {
    var table = controller.value.document.getNode(tbSelection.key);

    if (controller.query(isSelectWholeTable, {
      node: table
    })) {
      controller.command(Commands.moveToRangeOfDocument);
      return controller;
    }
  }

  var value = controller.value;
  if (!isSelectionInTableCell(value)) return next();
  var document = value.document,
      startBlock = value.startBlock;

  if (!startBlock) {
    return next();
  }

  var cell = document.getClosest(startBlock.key, isTableCell);

  if (!cell) {
    return next();
  }

  event == null ? void 0 : event.preventDefault(); // 选中单元格时，cmd + a 选择整个表格

  if (isSelectWholeCell(controller, cell)) {
    var _table = document.getClosest(cell.key, Table.isTable);

    if (_table) {
      return controller.run('onAction', selectTable(_table));
    }
  }

  return controller.command(Commands.moveToRangeOfNode, cell);
}
//# sourceMappingURL=onSelectAll.js.map