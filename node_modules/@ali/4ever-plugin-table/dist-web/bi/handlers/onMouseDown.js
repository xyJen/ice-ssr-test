import { Path } from '@ali/4ever-cangjie';
import TableCell from "../../mo/models/tableCell"; // 问题描述：
// 1. 存在表格选区时
// 2. 如果鼠标右键点击位置不在 selection.anchor、selection.focus 之间
//    但是点击在 anchor 或 focus 所在的单元格时
// 3. Cangjie 会 focus 在点击位置，导致表格选区消失
// 解法：
// 拦截 Cangjie onMouseDown 默认事件

export default function onKeyDown(event, controller, next) {
  if (event.button !== 2) {
    return next();
  }

  var _controller$value = controller.value,
      document = _controller$value.document,
      selection = _controller$value.selection;

  if (selection.isCollapsed) {
    return next();
  }

  var target = event.target;
  var td = target == null ? void 0 : target.closest('td');

  if (!td) {
    return next();
  }

  var cellKey = td.getAttribute('data-cangjie-key');

  if (!cellKey) {
    return next();
  }

  var targetCell = document.getNode(cellKey);

  var _selection$sort = selection.sort(document),
      start = _selection$sort.start,
      end = _selection$sort.end;

  var startCell = document.getClosest(start.key, TableCell.isTableCell);
  var endCell = document.getClosest(end.key, TableCell.isTableCell);

  if (!targetCell || !startCell || !endCell) {
    return next();
  }

  var targetCellPath = document.getPath(targetCell.key);
  var startCellPath = document.getPath(startCell.key);
  var endCellPath = document.getPath(endCell.key);

  if (Path.compare(targetCellPath, startCellPath) >= 0 && Path.compare(targetCellPath, endCellPath) <= 0) {
    event.preventDefault();
    return;
  }

  return next();
}
//# sourceMappingURL=onMouseDown.js.map