{"version":3,"sources":["../../../../src/bi/handlers/onEnter.ts"],"names":["Commands","biActions","basicActions","createTableData","createTable","createEmptyParagraph","moveToStartOfCell","setTableRowHeader","markdownRegExp","onEnter","event","controller","next","config","value","selection","endBlock","enableAutofitWidth","enableHeader","setTableHeaderStyle","disableDefaultAutofitWidth","isCollapsed","focus","isTextPoint","nodes","length","isAtEndOfNode","matches","text","match","query","preventDefault","defaultAutofit","defaultHeader","splited","split","firstLineTexts","slice","map","str","trim","tableData","colSize","table","rowSize","data","hasFirstRowText","firstRow","index","merge","finalTable","command","removeTextByKey","key","run","createInsertBlockWithoutExtraBlankAction","node"],"mappings":"AAAA,SAASA,QAAT,QAA2D,oBAA3D;AACA,SAASC,SAAS,IAAIC,YAAtB,QAA0C,yBAA1C;AACA,OAAOC,eAAP;AACA,OAAOC,WAAP;AACA,OAAOC,oBAAP;AACA,SAASC,iBAAT;AACA,SAASC,iBAAT;AAGA,IAAMC,cAAc,GAAG,mBAAvB;AAEA,eAAe,SAASC,OAAT,CAAiBC,KAAjB,EAAwBC,UAAxB,EAAgDC,IAAhD,EAAsDC,MAAtD,EAA2E;AAAA,MAChFC,KADgF,GACtEH,UADsE,CAChFG,KADgF;AAAA,MAEhFC,SAFgF,GAExDD,KAFwD,CAEhFC,SAFgF;AAAA,MAErEC,QAFqE,GAExDF,KAFwD,CAErEE,QAFqE;AAAA,MAItFC,kBAJsF,GAQpFJ,MARoF,CAItFI,kBAJsF;AAAA,MAKtFC,YALsF,GAQpFL,MARoF,CAKtFK,YALsF;AAAA,MAMtFC,mBANsF,GAQpFN,MARoF,CAMtFM,mBANsF;AAAA,MAOtFC,0BAPsF,GAQpFP,MARoF,CAOtFO,0BAPsF;;AAUxF,MACEL,SAAS,CAACM,WAAV,IACGN,SAAS,CAACO,KAAV,CAAgBC,WAAhB,EADH,IAEG,CAAAP,QAAQ,QAAR,YAAAA,QAAQ,CAAEQ,KAAV,CAAgBC,MAAhB,MAA2B,CAF9B,IAGGV,SAAS,CAACO,KAAV,CAAgBI,aAAhB,CAA8BV,QAA9B,CAJL,EAKE;AACA,QAAMW,OAAO,GAAGX,QAAQ,CAACY,IAAT,CAAcC,KAAd,CAAoBrB,cAApB,CAAhB;;AACA,QAAImB,OAAO,IAAIhB,UAAU,CAACmB,KAAX,CAAiB,gBAAjB,CAAf,EAAmD;AACjDpB,MAAAA,KAAK,CAACqB,cAAN;AACA,UAAMC,cAAc,GAAG,CAAAf,kBAAkB,QAAlB,YAAAA,kBAAkB,OAAQ,EAACG,0BAAD,YAACA,0BAA0B,EAA3B,CAAjD;AACA,UAAMa,aAAa,GAAGf,YAAH,oBAAGA,YAAY,EAAlC;AACA,UAAMgB,OAAO,GAAGP,OAAO,CAAC,CAAD,CAAP,CAAWQ,KAAX,CAAiB,GAAjB,CAAhB;AACA,UAAMC,cAAc,GAAGF,OAAO,CAACG,KAAR,CAAc,CAAd,EAAiBH,OAAO,CAACT,MAAR,GAAiB,CAAlC,EAAqCa,GAArC,CAAyC,UAACC,GAAD;AAAA,eAASA,GAAG,CAACC,IAAJ,EAAT;AAAA,OAAzC,CAAvB;AACA,UAAMC,SAAS,GAAGtC,eAAe,CAACQ,UAAD,EAAa;AAAE+B,QAAAA,OAAO,EAAEN,cAAc,CAACX,MAA1B;AAAkCO,QAAAA,cAAc,EAAdA;AAAlC,OAAb,CAAjC;AACA,UAAMW,KAAK,GAAGvC,WAAW,CAAC;AACxBwC,QAAAA,OAAO,EAAE,CADe;AAExBF,QAAAA,OAAO,EAAEN,cAAc,CAACX,MAFA;AAGxBoB,QAAAA,IAAI,EAAEJ;AAHkB,OAAD,CAAzB;AAMA,UAAIK,eAAe,GAAG,KAAtB;AACA,UAAMC,QAAQ,GAAGJ,KAAK,CAACnB,KAAN,CAAY,CAAZ,CAAjB;AACA,UAAMA,KAAK,GAAGY,cAAc,CAACE,GAAf,CAAmB,UAACV,IAAD,EAAOoB,KAAP,EAAiB;AAChD,YAAIpB,IAAJ,EAAU;AACRkB,UAAAA,eAAe,GAAG,IAAlB;AACA,iBAAOC,QAAQ,CAACvB,KAAT,CAAewB,KAAf,EAAsBC,KAAtB,CAA4B;AACjCzB,YAAAA,KAAK,EAAE,CAACnB,oBAAoB,CAACuB,IAAD,CAArB;AAD0B,WAA5B,CAAP;AAGD;;AACD,eAAOmB,QAAQ,CAACvB,KAAT,CAAewB,KAAf,CAAP;AACD,OARa,CAAd;AASA,UAAME,UAAU,GAAGP,KAAK,CAACM,KAAN,CAAY;AAC7BzB,QAAAA,KAAK,EAAE,CAACuB,QAAQ,CAACE,KAAT,CAAe;AAAEzB,UAAAA,KAAK,EAALA;AAAF,SAAf,CAAD,EAA4BmB,KAAK,CAACnB,KAAN,CAAY,CAAZ,CAA5B;AADsB,OAAZ,CAAnB;;AAKA,UAAIS,aAAJ,EAAmB;AACjB;AACAd,QAAAA,mBAAmB,QAAnB,YAAAA,mBAAmB;AACpB,OAhCgD,CAkCjD;;;AACAR,MAAAA,UAAU,CACPwC,OADH,CACWnD,QAAQ,CAACoD,eADpB,EACqCrC,SAAS,CAACO,KAAV,CAAgB+B,GADrD,EAC0D,CAD1D,EAC6DrC,QAAQ,CAACY,IADtE,EAEG0B,GAFH,CAEO,UAFP,EAEmBpD,YAAY,CAACqD,wCAAb,CAAsD;AAAEC,QAAAA,IAAI,EAAEN;AAAR,OAAtD,CAFnB,EAnCiD,CAuCjD;;AACA5C,MAAAA,iBAAiB,CAACK,UAAD,EAAauC,UAAb,EAAyBJ,eAAe,GAAG,CAAH,GAAO,CAA/C,EAAkD,CAAlD,CAAjB;;AAEA,UAAIb,aAAJ,EAAmB;AACjBtB,QAAAA,UAAU,CAAC2C,GAAX,CAAe,UAAf,EAA2B/C,iBAAiB,CAAC2C,UAAD,CAA5C;AACD;;AACD,aAAOvC,UAAP;AACD;AACF;;AAED,SAAOC,IAAI,EAAX;AACD","sourcesContent":["import { Commands, Controller, Selection, TextPoint } from '@ali/4ever-cangjie';\nimport { biActions as basicActions } from '@ali/4ever-plugin-basic';\nimport createTableData from '../utils/createTableData';\nimport createTable from '../utils/createTable';\nimport createEmptyParagraph from '../utils/createEmptyParagraph';\nimport { moveToStartOfCell } from '../utils/selectionCommands';\nimport { setTableRowHeader } from '../actions';\nimport type { TableConfig } from '../types';\n\nconst markdownRegExp = /^\\|([^|]+\\|){2,}$/;\n\nexport default function onEnter(event, controller: Controller, next, config: TableConfig) {\n  const { value } = controller;\n  const { selection, endBlock } = value;\n  const {\n    enableAutofitWidth,\n    enableHeader,\n    setTableHeaderStyle,\n    disableDefaultAutofitWidth,\n  } = config;\n\n  if (\n    selection.isCollapsed\n    && selection.focus.isTextPoint()\n    && endBlock?.nodes.length === 1\n    && selection.focus.isAtEndOfNode(endBlock)\n  ) {\n    const matches = endBlock.text.match(markdownRegExp);\n    if (matches && controller.query('canInsertTable')) {\n      event.preventDefault();\n      const defaultAutofit = enableAutofitWidth?.() && !disableDefaultAutofitWidth?.();\n      const defaultHeader = enableHeader?.();\n      const splited = matches[0].split('|');\n      const firstLineTexts = splited.slice(1, splited.length - 1).map((str) => str.trim());\n      const tableData = createTableData(controller, { colSize: firstLineTexts.length, defaultAutofit });\n      const table = createTable({\n        rowSize: 2,\n        colSize: firstLineTexts.length,\n        data: tableData,\n      });\n\n      let hasFirstRowText = false;\n      const firstRow = table.nodes[0];\n      const nodes = firstLineTexts.map((text, index) => {\n        if (text) {\n          hasFirstRowText = true;\n          return firstRow.nodes[index].merge({\n            nodes: [createEmptyParagraph(text)]\n          });\n        }\n        return firstRow.nodes[index];\n      });\n      const finalTable = table.merge({\n        nodes: [firstRow.merge({ nodes }), table.nodes[1]]\n      });\n\n\n      if (defaultHeader) {\n        // NOTE: 需要先执行 setTableHeaderStyle\n        setTableHeaderStyle?.();\n      }\n\n      // 删除 md 文本并插入表格\n      controller\n        .command(Commands.removeTextByKey, selection.focus.key, 0, endBlock.text)\n        .run('onAction', basicActions.createInsertBlockWithoutExtraBlankAction({ node: finalTable }));\n\n      // 首行没有文字时，插入后 focus 在第二行，否则就 focus 在第一行\n      moveToStartOfCell(controller, finalTable, hasFirstRowText ? 1 : 0, 0);\n\n      if (defaultHeader) {\n        controller.run('onAction', setTableRowHeader(finalTable));\n      }\n      return controller;\n    }\n  }\n\n  return next();\n}\n"],"file":"onEnter.js"}