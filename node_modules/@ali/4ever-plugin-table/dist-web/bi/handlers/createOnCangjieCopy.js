import { constants, transferUtils, Commands } from '@ali/4ever-cangjie';
import Table from "../../mo/models";
import generateClipTableFromTableSelection from "../utils/generateClipTableFromTableSelection";
import transformTablesToCompatibleLegacy from "../../utils/utils/transformTablesToCompatibleLegacy";
import setSelectionByTable from "../../utils/utils/setSelectionByTable";
import { isSingleTableCell } from '@ali/4ever-utils';
import { normalizeClipboardTable } from "../../utils/utils/normalizeClipboardTable";
var MIME_TYPES = constants.MIME_TYPES;
export default function createOnCangjieCopy(isMobile) {
  if (isMobile === void 0) {
    isMobile = false;
  }

  return function onCangjieCopy(event, controller, next) {
    if (!event.clipboardData) {
      return next();
    }

    var _controller$value = controller.value,
        document = _controller$value.document,
        selection = _controller$value.selection;
    var tableSelection = controller.query('tableSelection');
    var encodedFragment = event.clipboardData.getData(MIME_TYPES.FRAGMENT);
    var fragment = transferUtils.decodeFragment(encodedFragment);

    if (!tableSelection) {
      if (fragment && isSingleTableCell(fragment)) {
        return next(event.setClipboardData(event.clipboardData.setData(MIME_TYPES.FRAGMENT, transferUtils.encodeFragment(normalizeClipboardTable(fragment)))));
      }
    } else {
      var tablePath = document.assertPath(tableSelection.key);
      var table = document.assertNodeByPath(tablePath);

      if (Table.isTable(table)) {
        fragment = generateClipTableFromTableSelection(table, tableSelection);
      }
    }

    if (isMobile) {
      var noTableSelection = setSelectionByTable(selection, false);
      controller.command(Commands.select, noTableSelection);
    }

    if (fragment) {
      var _transformTablesToCom = transformTablesToCompatibleLegacy(document, fragment, isMobile),
          shouldTransfrom = _transformTablesToCom.shouldTransfrom,
          newFragment = _transformTablesToCom.fragment;

      if (shouldTransfrom || tableSelection) {
        return next(event.setClipboardData(event.clipboardData.setData(MIME_TYPES.FRAGMENT, transferUtils.encodeFragment(newFragment))));
      }
    }

    return next();
  };
}
//# sourceMappingURL=createOnCangjieCopy.js.map