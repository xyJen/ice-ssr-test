{"version":3,"sources":["../../../../src/bi/handlers/onArrowUp.ts"],"names":["Commands","Queries","isSelectionInTableCell","getPositionOfCell","isTableCell","Table","TableCell","moveToStartOfCell","moveToStartOfPreviousSibling","getNextNonHiddenCell","setSelectionByTable","onArrowUp","event","controller","next","value","selection","document","startBlock","tableSelection","query","preventDefault","table","getNode","key","node","startColIndex","startRowIndex","cell","getClosest","focusTable","isTable","position","rowIndex","newSelection","getUpsideRange","anchor","newFocusCell","nextCell","s","moveToEndOfNode","command","select"],"mappings":"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","sourcesContent":["import { Commands, Controller, Queries } from '@ali/4ever-cangjie';\nimport isSelectionInTableCell from '../utils/isSelectionInTableCell';\nimport getPositionOfCell from '../utils/getPositionOfCell';\nimport { isTableCell } from '../types';\nimport Table from '../../mo/models';\nimport TableCell from '../../mo/models/tableCell';\nimport {\n  moveToStartOfCell,\n  moveToStartOfPreviousSibling,\n} from '../utils/selectionCommands';\nimport getNextNonHiddenCell from '../utils/getNextVisibleCell';\nimport setSelectionByTable from '../../utils/utils/setSelectionByTable';\n\nexport default function onArrowUp(event, controller: Controller, next) {\n  const { value } = controller;\n  const { selection, document, startBlock } = value;\n  const tableSelection = controller.query('tableSelection');\n  if (tableSelection) {\n    event.preventDefault();\n    const table = document.getNode(tableSelection.key) as Table | null;\n    if (!table) {\n      return;\n    }\n    if (controller.query('isSelectWholeTable', { node: table })) {\n      return moveToStartOfPreviousSibling(controller, table);\n    }\n    const { startColIndex, startRowIndex } = tableSelection;\n    return moveToStartOfCell(controller, table, startRowIndex - 1, startColIndex);\n  }\n\n  if (!isSelectionInTableCell(value)) return next();\n\n  const cell = document.getClosest(startBlock?.key!, isTableCell) as TableCell;\n  if (!cell) {\n    return next();\n  }\n  const focusTable = document.getClosest(cell.key, Table.isTable) as Table;\n  const position = getPositionOfCell(cell.key, focusTable)!;\n  if (position.rowIndex === 0) {\n    return next();\n  }\n\n  const newSelection = controller.query(Queries.getUpsideRange);\n  if (!newSelection) {\n    return next();\n  }\n  const { anchor } = newSelection;\n  const newFocusCell = document.getClosest(anchor.key, TableCell.isTableCell);\n  // 向下移动后，仍是同一个 cell 则不处理\n  if (newFocusCell?.key === cell.key) {\n    return next();\n  }\n\n  const nextCell = getNextNonHiddenCell(document, cell, 'up');\n  if (!nextCell) {\n    return next();\n  }\n\n  event.preventDefault();\n  const s = selection.moveToEndOfNode(nextCell, controller);\n  return controller.command(Commands.select, setSelectionByTable(s, false));\n}\n"],"file":"onArrowUp.js"}