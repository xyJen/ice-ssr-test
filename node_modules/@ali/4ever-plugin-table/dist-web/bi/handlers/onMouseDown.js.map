{"version":3,"sources":["../../../../src/bi/handlers/onMouseDown.ts"],"names":["Path","TableCell","onKeyDown","event","controller","next","button","value","document","selection","isCollapsed","target","td","closest","cellKey","getAttribute","targetCell","getNode","sort","start","end","startCell","getClosest","key","isTableCell","endCell","targetCellPath","getPath","startCellPath","endCellPath","compare","preventDefault"],"mappings":"AAAA,SAAqBA,IAArB,QAAiC,oBAAjC;AACA,OAAOC,SAAP,kC,CAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,eAAe,SAASC,SAAT,CACbC,KADa,EAEbC,UAFa,EAGbC,IAHa,EAIb;AACA,MAAIF,KAAK,CAACG,MAAN,KAAiB,CAArB,EAAwB;AACtB,WAAOD,IAAI,EAAX;AACD;;AAHD,0BAIgCD,UAAU,CAACG,KAJ3C;AAAA,MAIQC,QAJR,qBAIQA,QAJR;AAAA,MAIkBC,SAJlB,qBAIkBA,SAJlB;;AAKA,MAAIA,SAAS,CAACC,WAAd,EAA2B;AACzB,WAAOL,IAAI,EAAX;AACD;;AAPD,MAQQM,MARR,GAQmBR,KARnB,CAQQQ,MARR;AASA,MAAMC,EAAE,GAAID,MAAJ,oBAAIA,MAAD,CAAyBE,OAAzB,CAAiC,IAAjC,CAAX;;AACA,MAAI,CAACD,EAAL,EAAS;AACP,WAAOP,IAAI,EAAX;AACD;;AACD,MAAMS,OAAO,GAAGF,EAAE,CAACG,YAAH,CAAgB,kBAAhB,CAAhB;;AACA,MAAI,CAACD,OAAL,EAAc;AACZ,WAAOT,IAAI,EAAX;AACD;;AACD,MAAMW,UAAU,GAAGR,QAAQ,CAACS,OAAT,CAAiBH,OAAjB,CAAnB;;AAjBA,wBAmBuBL,SAAS,CAACS,IAAV,CAAeV,QAAf,CAnBvB;AAAA,MAmBQW,KAnBR,mBAmBQA,KAnBR;AAAA,MAmBeC,GAnBf,mBAmBeA,GAnBf;;AAoBA,MAAMC,SAAS,GAAGb,QAAQ,CAACc,UAAT,CAAoBH,KAAK,CAACI,GAA1B,EAA+BtB,SAAS,CAACuB,WAAzC,CAAlB;AACA,MAAMC,OAAO,GAAGjB,QAAQ,CAACc,UAAT,CAAoBF,GAAG,CAACG,GAAxB,EAA6BtB,SAAS,CAACuB,WAAvC,CAAhB;;AAEA,MAAI,CAACR,UAAD,IAAe,CAACK,SAAhB,IAA6B,CAACI,OAAlC,EAA2C;AACzC,WAAOpB,IAAI,EAAX;AACD;;AAED,MAAMqB,cAAc,GAAGlB,QAAQ,CAACmB,OAAT,CAAiBX,UAAU,CAACO,GAA5B,CAAvB;AACA,MAAMK,aAAa,GAAGpB,QAAQ,CAACmB,OAAT,CAAiBN,SAAS,CAACE,GAA3B,CAAtB;AACA,MAAMM,WAAW,GAAGrB,QAAQ,CAACmB,OAAT,CAAiBF,OAAO,CAACF,GAAzB,CAApB;;AACA,MACEvB,IAAI,CAAC8B,OAAL,CAAaJ,cAAb,EAA6BE,aAA7B,KAAgD,CAAhD,IACA5B,IAAI,CAAC8B,OAAL,CAAaJ,cAAb,EAA6BG,WAA7B,KAA8C,CAFhD,EAGE;AACA1B,IAAAA,KAAK,CAAC4B,cAAN;AACA;AACD;;AAED,SAAO1B,IAAI,EAAX;AACD","sourcesContent":["import { Controller, Path } from '@ali/4ever-cangjie';\nimport TableCell from '../../mo/models/tableCell';\n\n// 问题描述：\n// 1. 存在表格选区时\n// 2. 如果鼠标右键点击位置不在 selection.anchor、selection.focus 之间\n//    但是点击在 anchor 或 focus 所在的单元格时\n// 3. Cangjie 会\b focus 在点击位置，导致表格选区消失\n// 解法：\n// 拦截 Cangjie onMouseDown 默认事件\nexport default function onKeyDown(\n  event: React.MouseEvent,\n  controller: Controller,\n  next,\n) {\n  if (event.button !== 2) {\n    return next();\n  }\n  const { document, selection } = controller.value;\n  if (selection.isCollapsed) {\n    return next();\n  }\n  const { target } = event;\n  const td = (target as HTMLElement)?.closest('td');\n  if (!td) {\n    return next();\n  }\n  const cellKey = td.getAttribute('data-cangjie-key');\n  if (!cellKey) {\n    return next();\n  }\n  const targetCell = document.getNode(cellKey);\n\n  const { start, end } = selection.sort(document);\n  const startCell = document.getClosest(start.key, TableCell.isTableCell);\n  const endCell = document.getClosest(end.key, TableCell.isTableCell);\n\n  if (!targetCell || !startCell || !endCell) {\n    return next();\n  }\n\n  const targetCellPath = document.getPath(targetCell.key)!;\n  const startCellPath = document.getPath(startCell.key)!;\n  const endCellPath = document.getPath(endCell.key)!;\n  if (\n    Path.compare(targetCellPath, startCellPath)! >= 0 &&\n    Path.compare(targetCellPath, endCellPath)! <= 0\n  ) {\n    event.preventDefault();\n    return;\n  }\n\n  return next();\n}\n"],"file":"onMouseDown.js"}