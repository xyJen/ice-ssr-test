{"version":3,"sources":["../../../../src/bi/commands/setTableBorder.ts"],"names":["Commands","isEqualWithDefault","getMirrorCellOfSameBorder","generateBorderInfo","tableSelection","table","result","leftOutline","rightOutline","topOutline","bottomOutline","leftInline","rightInline","topInline","bottomInline","startRowIndex","endRowIndex","startColIndex","endColIndex","rowIndex","row","nodes","colIndex","cell","data","hidden","colSpan","rowSpan","push","key","mirrorObj","left","right","top","bottom","defaultBdr","setBorderData","controller","options","orientation","isIncluded","val","sz","color","oldBdr","bdr","newBdr","command","setNodeByKey","setTableBorder","selection","borderSetType","borderInfo","filterObj","none","all","outer","inner","horizon","vertical","Object","keys","forEach","type","keysByType","matched","match","inlineOrOutline","toLowerCase","mirrorOrientation","isOutlineIncluded","includes","isInlineIncluded","tableCell","value","document","getNode","updatedTable","mirrorCell"],"mappings":";AAAA,SAA4BA,QAA5B,QAA0D,oBAA1D;AAEA,SAASC,kBAAT,QAAmC,kBAAnC;AAEA,OAAOC,yBAAP;;AAEA,SAASC,kBAAT,CAA4BC,cAA5B,EAA6DC,KAA7D,EAA2E;AACzE,MAAMC,MAAgC,GAAG;AACvCC,IAAAA,WAAW,EAAE,EAD0B;AAEvCC,IAAAA,YAAY,EAAE,EAFyB;AAGvCC,IAAAA,UAAU,EAAE,EAH2B;AAIvCC,IAAAA,aAAa,EAAE,EAJwB;AAKvCC,IAAAA,UAAU,EAAE,EAL2B;AAMvCC,IAAAA,WAAW,EAAE,EAN0B;AAOvCC,IAAAA,SAAS,EAAE,EAP4B;AAQvCC,IAAAA,YAAY,EAAE;AARyB,GAAzC;AADyE,MAWjEC,aAXiE,GAWNX,cAXM,CAWjEW,aAXiE;AAAA,MAWlDC,WAXkD,GAWNZ,cAXM,CAWlDY,WAXkD;AAAA,MAWrCC,aAXqC,GAWNb,cAXM,CAWrCa,aAXqC;AAAA,MAWtBC,WAXsB,GAWNd,cAXM,CAWtBc,WAXsB;;AAYzE,OAAK,IAAIC,QAAQ,GAAGJ,aAApB,EAAmCI,QAAQ,IAAIH,WAA/C,EAA4DG,QAAQ,IAAI,CAAxE,EAA2E;AACzE,QAAMC,GAAG,GAAGf,KAAK,CAACgB,KAAN,CAAYF,QAAZ,CAAZ;AACA,QAAI,CAACC,GAAL,EAAU,SAF+D,CAErD;;AAEpB,SAAK,IAAIE,QAAQ,GAAGL,aAApB,EAAmCK,QAAQ,IAAIJ,WAA/C,EAA4DI,QAAQ,IAAI,CAAxE,EAA2E;AACzE,UAAMC,IAAI,GAAGH,GAAG,CAACC,KAAJ,CAAUC,QAAV,CAAb;AACA,UAAI,CAACC,IAAL,EAAW,SAF8D,CAEpD;;AACrB,UAAIA,IAAI,CAACC,IAAL,CAAUC,MAAd,EAAsB;AAEtB,UAAMC,OAAO,GAAGH,IAAI,CAACC,IAAL,CAAUE,OAAV,IAAqB,CAArC;AACA,UAAMC,OAAO,GAAGJ,IAAI,CAACC,IAAL,CAAUG,OAAV,IAAqB,CAArC;;AAEA,UAAIL,QAAQ,KAAKL,aAAjB,EAAgC;AAC9BX,QAAAA,MAAM,CAACC,WAAP,CAAmBqB,IAAnB,CAAwBL,IAAI,CAACM,GAA7B;AACD,OAFD,MAEO;AACLvB,QAAAA,MAAM,CAACK,UAAP,CAAkBiB,IAAlB,CAAuBL,IAAI,CAACM,GAA5B;AACD;;AACD,UAAIP,QAAQ,GAAGI,OAAX,KAAuBR,WAAW,GAAG,CAAzC,EAA4C;AAC1CZ,QAAAA,MAAM,CAACE,YAAP,CAAoBoB,IAApB,CAAyBL,IAAI,CAACM,GAA9B;AACD,OAFD,MAEO;AACLvB,QAAAA,MAAM,CAACM,WAAP,CAAmBgB,IAAnB,CAAwBL,IAAI,CAACM,GAA7B;AACD;;AACD,UAAIV,QAAQ,KAAKJ,aAAjB,EAAgC;AAC9BT,QAAAA,MAAM,CAACG,UAAP,CAAkBmB,IAAlB,CAAuBL,IAAI,CAACM,GAA5B;AACD,OAFD,MAEO;AACLvB,QAAAA,MAAM,CAACO,SAAP,CAAiBe,IAAjB,CAAsBL,IAAI,CAACM,GAA3B;AACD;;AACD,UAAIV,QAAQ,GAAGQ,OAAX,KAAuBX,WAAW,GAAG,CAAzC,EAA4C;AAC1CV,QAAAA,MAAM,CAACI,aAAP,CAAqBkB,IAArB,CAA0BL,IAAI,CAACM,GAA/B;AACD,OAFD,MAEO;AACLvB,QAAAA,MAAM,CAACQ,YAAP,CAAoBc,IAApB,CAAyBL,IAAI,CAACM,GAA9B;AACD;AACF;AACF;;AACD,SAAOvB,MAAP;AACD;;AAED,IAAMwB,SAAS,GAAG;AAChBC,EAAAA,IAAI,EAAE,OADU;AAEhBC,EAAAA,KAAK,EAAE,MAFS;AAGhBC,EAAAA,GAAG,EAAE,QAHW;AAIhBC,EAAAA,MAAM,EAAE;AAJQ,CAAlB;AAOA,IAAMC,UAAU,GAAG;AACjBJ,EAAAA,IAAI,EAAE,IADW;AAEjBC,EAAAA,KAAK,EAAE,IAFU;AAGjBC,EAAAA,GAAG,EAAE,IAHY;AAIjBC,EAAAA,MAAM,EAAE;AAJS,CAAnB;;AAcA,SAASE,aAAT,CAAuBC,UAAvB,EAA+Cd,IAA/C,EAA4DM,GAA5D,EAAyES,OAAzE,EAAuG;AAAA;;AAAA,MAC7FC,WAD6F,GACjDD,OADiD,CAC7FC,WAD6F;AAAA,MAChFC,UADgF,GACjDF,OADiD,CAChFE,UADgF;AAAA,MACpEC,GADoE,GACjDH,OADiD,CACpEG,GADoE;AAAA,MAC/DC,EAD+D,GACjDJ,OADiD,CAC/DI,EAD+D;AAAA,MAC3DC,KAD2D,GACjDL,OADiD,CAC3DK,KAD2D;AAErG,MAAMC,MAAM,GAAGrB,IAAI,CAACC,IAAL,CAAUqB,GAAV,IAAiB,EAAhC;;AACA,MAAMC,MAAM,gBACPF,MADO,6BAETL,WAFS,IAEKC,UAAU,GAAG;AAAEG,IAAAA,KAAK,EAALA,KAAF;AAASD,IAAAA,EAAE,EAAFA,EAAT;AAAaD,IAAAA,GAAG,EAAHA;AAAb,GAAH,GAAwB,IAFvC,aAAZ;;AAIA,MAAI,CAACxC,kBAAkB,CAAC2C,MAAD,EAASE,MAAT,EAAiBX,UAAjB,CAAvB,EAAqD;AACnDE,IAAAA,UAAU,CAACU,OAAX,CAAmB/C,QAAQ,CAACgD,YAA5B,EAA0CzB,IAAI,CAACM,GAA/C,EAAoD;AAClDL,MAAAA,IAAI,eACCD,IAAI,CAACC,IADN;AAEFqB,QAAAA,GAAG,EAAEC;AAFH;AAD8C,KAApD;AAMD;AACF;;AAED,eAAe,SAASG,cAAT,CAAwBZ,UAAxB,EAAgDhC,KAAhD,EAA8D6C,SAA9D,EAA0FC,aAA1F,EAAyGR,KAAzG,EAAgHD,EAAhH,EAAoHD,GAApH,EAAyH;AACtI,MAAI,CAACS,SAAL,EAAgB;AACd,WAAOb,UAAP;AACD;;AAED,MAAMe,UAAU,GAAGjD,kBAAkB,CAAC+C,SAAD,EAAY7C,KAAZ,CAArC,CALsI,CAOtI;;AACA,MAAMgD,SAAS,GAAG;AAChBC,IAAAA,IAAI,EAAE,EADU;AAEhBC,IAAAA,GAAG,EAAE,CAAC,aAAD,EAAgB,cAAhB,EAAgC,YAAhC,EAA8C,eAA9C,EAA+D,YAA/D,EAA6E,aAA7E,EAA4F,WAA5F,EAAyG,cAAzG,CAFW;AAGhBC,IAAAA,KAAK,EAAE,CAAC,aAAD,EAAgB,cAAhB,EAAgC,YAAhC,EAA8C,eAA9C,CAHS;AAIhBC,IAAAA,KAAK,EAAE,CAAC,YAAD,EAAe,aAAf,EAA8B,WAA9B,EAA2C,cAA3C,CAJS;AAKhB1B,IAAAA,IAAI,EAAE,CAAC,aAAD,CALU;AAMhBE,IAAAA,GAAG,EAAE,CAAC,YAAD,CANW;AAOhBD,IAAAA,KAAK,EAAE,CAAC,cAAD,CAPS;AAQhBE,IAAAA,MAAM,EAAE,CAAC,eAAD,CARQ;AAShBwB,IAAAA,OAAO,EAAE,CAAC,WAAD,EAAc,cAAd,CATO;AAUhBC,IAAAA,QAAQ,EAAE,CAAC,YAAD,EAAe,aAAf;AAVM,GAAlB;AAYAC,EAAAA,MAAM,CAACC,IAAP,CAAYT,UAAZ,EAAwBU,OAAxB,CAAgC,UAACC,IAAD,EAAU;AACxC,QAAMC,UAAU,GAAGZ,UAAU,CAACW,IAAD,CAA7B;AACA,QAAME,OAAO,GAAGF,IAAI,CAACG,KAAL,CAAW,iBAAX,CAAhB;;AACA,QAAI,CAACD,OAAL,EAAc;AACZ;AACD;;AACD,QAAM1B,WAAW,GAAG0B,OAAO,CAAC,CAAD,CAA3B;AACA,QAAME,eAAe,GAAGF,OAAO,CAAC,CAAD,CAAP,CAAWG,WAAX,EAAxB;AACA,QAAMC,iBAAiB,GAAGvC,SAAS,CAACS,WAAD,CAAnC;AAEA,QAAM+B,iBAAiB,GAAGH,eAAe,KAAK,SAApB,IAAiCd,SAAS,CAACF,aAAD,CAAT,CAAyBoB,QAAzB,CAAqChC,WAArC,aAA3D;AACA,QAAMiC,gBAAgB,GAAGL,eAAe,KAAK,QAApB,IAAgCd,SAAS,CAACF,aAAD,CAAT,CAAyBoB,QAAzB,CAAqChC,WAArC,YAAzD;AACA,QAAMC,UAAU,GAAG8B,iBAAiB,IAAIE,gBAAxC;AACAR,IAAAA,UAAU,CAACF,OAAX,CAAmB,UAACjC,GAAD,EAAS;AAC1B,UAAM4C,SAAS,GAAGpC,UAAU,CAACqC,KAAX,CAAiBC,QAAjB,CAA0BC,OAA1B,CAAkC/C,GAAlC,CAAlB;AACA,UAAMgD,YAAY,GAAGxC,UAAU,CAACqC,KAAX,CAAiBC,QAAjB,CAA0BC,OAA1B,CAAkCvE,KAAK,CAACwB,GAAxC,CAArB,CAF0B,CAG1B;;AACA,UAAIW,UAAU,IAAIW,aAAa,KAAK,MAApC,EAA4C;AAC1Cf,QAAAA,aAAa,CAACC,UAAD,EAAaoC,SAAb,EAAwB5C,GAAxB,EAA6B;AAAEc,UAAAA,KAAK,EAALA,KAAF;AAASD,UAAAA,EAAE,EAAFA,EAAT;AAAaD,UAAAA,GAAG,EAAHA,GAAb;AAAkBF,UAAAA,WAAW,EAAXA,WAAlB;AAA+BC,UAAAA,UAAU,EAAVA;AAA/B,SAA7B,CAAb;AACD;;AAED,UAAI,CAAC8B,iBAAiB,IAAInB,aAAa,KAAK,MAAxC,KAAmDgB,eAAe,KAAK,SAA3E,EAAsF;AACpF,YAAMW,UAAU,GAAG5E,yBAAyB,CAACuE,SAAD,EAAYlC,WAAZ,EAAyBsC,YAAzB,CAA5C;;AACA,YAAIC,UAAJ,EAAgB;AACd1C,UAAAA,aAAa,CACXC,UADW,EAEXyC,UAFW,EAGXA,UAAU,CAACjD,GAHA,EAIX;AAAEc,YAAAA,KAAK,EAALA,KAAF;AAASD,YAAAA,EAAE,EAAFA,EAAT;AAAaD,YAAAA,GAAG,EAAHA,GAAb;AAAkBF,YAAAA,WAAW,EAAE8B,iBAA/B;AAAkD7B,YAAAA,UAAU,EAAE8B;AAA9D,WAJW,CAAb;AAMD;AACF;AACF,KAnBD;AAoBD,GAjCD;AAmCA,SAAOjC,UAAP;AACD","sourcesContent":["import { Controller, Block, Commands, MoInterfaces } from '@ali/4ever-cangjie';\nimport Table from '../../mo/models';\nimport { isEqualWithDefault } from '@ali/4ever-utils';\nimport { ITableSelection } from '../types';\nimport getMirrorCellOfSameBorder from '../utils/getMirrorCellOfSameBorder';\n\nfunction generateBorderInfo(tableSelection: ITableSelection, table: Table) {\n  const result: Record<string, string[]> = {\n    leftOutline: [],\n    rightOutline: [],\n    topOutline: [],\n    bottomOutline: [],\n    leftInline: [],\n    rightInline: [],\n    topInline: [],\n    bottomInline: [],\n  };\n  const { startRowIndex, endRowIndex, startColIndex, endColIndex } = tableSelection;\n  for (let rowIndex = startRowIndex; rowIndex <= endRowIndex; rowIndex += 1) {\n    const row = table.nodes[rowIndex];\n    if (!row) continue; // eslint-disable-line no-continue\n\n    for (let colIndex = startColIndex; colIndex <= endColIndex; colIndex += 1) {\n      const cell = row.nodes[colIndex];\n      if (!cell) continue; // eslint-disable-line no-continue\n      if (cell.data.hidden) continue;\n\n      const colSpan = cell.data.colSpan || 1;\n      const rowSpan = cell.data.rowSpan || 1;\n\n      if (colIndex === startColIndex) {\n        result.leftOutline.push(cell.key);\n      } else {\n        result.leftInline.push(cell.key);\n      }\n      if (colIndex + colSpan === endColIndex + 1) {\n        result.rightOutline.push(cell.key);\n      } else {\n        result.rightInline.push(cell.key);\n      }\n      if (rowIndex === startRowIndex) {\n        result.topOutline.push(cell.key);\n      } else {\n        result.topInline.push(cell.key);\n      }\n      if (rowIndex + rowSpan === endRowIndex + 1) {\n        result.bottomOutline.push(cell.key);\n      } else {\n        result.bottomInline.push(cell.key);\n      }\n    }\n  }\n  return result;\n}\n\nconst mirrorObj = {\n  left: 'right',\n  right: 'left',\n  top: 'bottom',\n  bottom: 'top',\n};\n\nconst defaultBdr = {\n  left: null,\n  right: null,\n  top: null,\n  bottom: null,\n};\n\ntype Border = MoInterfaces.Border.Border;\ntype BorderProperties = MoInterfaces.Border.BorderProperties;\ninterface SetBorderDataOption extends Pick<BorderProperties, 'val' | 'sz' | 'color'> {\n  isIncluded: boolean;\n  orientation: keyof Border;\n}\n\nfunction setBorderData(controller: Controller, cell: Block, key: string, options: SetBorderDataOption) {\n  const { orientation, isIncluded, val, sz, color } = options;\n  const oldBdr = cell.data.bdr || {};\n  const newBdr = {\n    ...oldBdr,\n    [orientation]: isIncluded ? { color, sz, val } : null,\n  };\n  if (!isEqualWithDefault(oldBdr, newBdr, defaultBdr)) {\n    controller.command(Commands.setNodeByKey, cell.key, {\n      data: {\n        ...cell.data,\n        bdr: newBdr,\n      },\n    });\n  }\n}\n\nexport default function setTableBorder(controller: Controller, table: Table, selection: ITableSelection, borderSetType, color, sz, val) {\n  if (!selection) {\n    return controller;\n  }\n\n  const borderInfo = generateBorderInfo(selection, table);\n\n  // all, outline, inside, left, top, right, bottom, innerHorizontal, innerVertical,\n  const filterObj = {\n    none: [],\n    all: ['leftOutline', 'rightOutline', 'topOutline', 'bottomOutline', 'leftInline', 'rightInline', 'topInline', 'bottomInline'],\n    outer: ['leftOutline', 'rightOutline', 'topOutline', 'bottomOutline'],\n    inner: ['leftInline', 'rightInline', 'topInline', 'bottomInline'],\n    left: ['leftOutline'],\n    top: ['topOutline'],\n    right: ['rightOutline'],\n    bottom: ['bottomOutline'],\n    horizon: ['topInline', 'bottomInline'],\n    vertical: ['leftInline', 'rightInline'],\n  };\n  Object.keys(borderInfo).forEach((type) => {\n    const keysByType = borderInfo[type];\n    const matched = type.match(/(\\w+)([A-Z]\\w+)/);\n    if (!matched) {\n      return;\n    }\n    const orientation = matched[1] as keyof Border;\n    const inlineOrOutline = matched[2].toLowerCase();\n    const mirrorOrientation = mirrorObj[orientation] as keyof Border;\n\n    const isOutlineIncluded = inlineOrOutline === 'outline' && filterObj[borderSetType].includes(`${orientation}Outline`);\n    const isInlineIncluded = inlineOrOutline === 'inline' && filterObj[borderSetType].includes(`${orientation}Inline`);\n    const isIncluded = isOutlineIncluded || isInlineIncluded;\n    keysByType.forEach((key) => {\n      const tableCell = controller.value.document.getNode(key) as Block;\n      const updatedTable = controller.value.document.getNode(table.key) as Block;\n      // none比较特殊，是清空效果，其他的都是叠加效果\n      if (isIncluded || borderSetType === 'none') {\n        setBorderData(controller, tableCell, key, { color, sz, val, orientation, isIncluded });\n      }\n\n      if ((isOutlineIncluded || borderSetType === 'none') && inlineOrOutline === 'outline') {\n        const mirrorCell = getMirrorCellOfSameBorder(tableCell, orientation, updatedTable);\n        if (mirrorCell) {\n          setBorderData(\n            controller,\n            mirrorCell,\n            mirrorCell.key,\n            { color, sz, val, orientation: mirrorOrientation, isIncluded: isOutlineIncluded },\n          );\n        }\n      }\n    });\n  });\n\n  return controller;\n}\n"],"file":"setTableBorder.js"}