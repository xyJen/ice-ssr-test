{"version":3,"sources":["../../../../src/bi/queries/tableSelection.ts"],"names":["Table","TableCell","adjustSelection","getPositionOfCell","isTableFromSameOrigin","TABLE_SELECTION_CACHE","WeakMap","setCache","key","value","set","tableSelection","controller","has","get","document","selection","anchor","focus","data","isByTable","anchorCell","getClosest","isTableCell","anchorTable","isTable","focusCell","focusTable","node","tableKey","startPosition","endPosition","minRowIndex","Math","min","rowIndex","maxRowIndex","max","minColIndex","colIndex","maxColIndex","result","startRowIndex","endRowIndex","startColIndex","endColIndex","tbSelection"],"mappings":"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","sourcesContent":["import { Controller, Value } from '@ali/4ever-cangjie';\nimport Table from '../../mo/models';\nimport TableCell from '../../mo/models/tableCell';\nimport { ITableSelection } from '../types';\nimport { adjustSelection, getPositionOfCell } from '../utils';\nimport isTableFromSameOrigin from './isTableFromSameOrigin';\n\ntype TABLE_SELECTION_TYPE = ITableSelection | null;\n\nconst TABLE_SELECTION_CACHE = new WeakMap<Value, TABLE_SELECTION_TYPE>();\n\nfunction setCache(key: Value, value: TABLE_SELECTION_TYPE) {\n  TABLE_SELECTION_CACHE.set(key, value);\n}\n\nexport default function tableSelection(controller: Controller) {\n  const { value } = controller;\n  if (TABLE_SELECTION_CACHE.has(value)) {\n    return TABLE_SELECTION_CACHE.get(value);\n  }\n\n  const { document, selection } = value;\n  const { anchor, focus, data } = selection;\n  const { isByTable } = data;\n  const anchorCell = document.getClosest(anchor.key, TableCell.isTableCell);\n  if (!anchorCell) {\n    setCache(value, null);\n    return null;\n  }\n  const anchorTable = document.getClosest(\n    anchorCell.key,\n    Table.isTable,\n  )! as Table;\n\n  const focusCell = document.getClosest(focus.key, TableCell.isTableCell);\n  if (\n    !focusCell ||\n    (\n      !isByTable &&\n      anchorCell.key === focusCell.key\n    )\n  ) {\n    setCache(value, null);\n    return null;\n  }\n  const focusTable = document.getClosest(\n    focusCell.key,\n    Table.isTable,\n  )! as Table;\n  // 处理从嵌套表格拖动到外层表格的情况\n  if (!isTableFromSameOrigin(\n    controller,\n    {\n      node: anchorTable,\n      tableKey: focusTable.key,\n    },\n  )) {\n    setCache(value, null);\n    return null;\n  }\n  const startPosition = getPositionOfCell(anchorCell.key, anchorTable)!;\n  const endPosition = getPositionOfCell(focusCell.key, anchorTable)!;\n  if (!startPosition || !endPosition) {\n    return null;\n  }\n  const minRowIndex = Math.min(startPosition.rowIndex, endPosition.rowIndex);\n  const maxRowIndex = Math.max(startPosition.rowIndex, endPosition.rowIndex);\n  const minColIndex = Math.min(startPosition.colIndex, endPosition.colIndex);\n  const maxColIndex = Math.max(startPosition.colIndex, endPosition.colIndex);\n  const result = {\n    startRowIndex: minRowIndex,\n    endRowIndex: maxRowIndex,\n    startColIndex: minColIndex,\n    endColIndex: maxColIndex,\n    key: anchorTable.key,\n  };\n\n  const tbSelection = isByTable !== true ? adjustSelection(focusTable, result) : result;\n\n  TABLE_SELECTION_CACHE.set(value, tbSelection);\n\n  return tbSelection;\n}\n"],"file":"tableSelection.js"}