{"version":3,"sources":["../../../../src/bi/utils/calcTableSelectionPos.ts"],"names":["domUtils","Table","TableRow","getBoundingRelativeRect","calcTableSelectionPos","params","tblSelection","table","colsWidthParams","colsWidth","tableNode","scale","absPostion","undefined","startRowIndex","startColIndex","endRowIndex","endColIndex","startRow","nodes","endRow","isTableRow","dataColsWidth","data","Array","isArray","isAutofitWidth","tableWidth","getBoundingClientRect","width","totalColsWidth","reduce","acc","w","map","left","slice","c","right","Math","max","firstRow","startCell","endCell","relativeParent","parentElement","firstRowDOM","querySelector","key","startRowNode","endRowNode","startCellRect","endCellRect","firstCellRect","top","bottom","height","topDelta","isSticky","lastRow","length","lastRowDOM","findDOMNodeSafely","tableBottom","lastRowBottom","relativeBottom","isSelectWholeCol","isSelectFirstRow","heightDelta","parentRect"],"mappings":"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","sourcesContent":["import { domUtils } from '@ali/4ever-cangjie';\nimport Table from '../../mo/models';\nimport TableRow from '../../mo/models/tableRow';\nimport { getBoundingRelativeRect } from '@ali/4ever-utils';\nimport { ITableSelection } from '../types';\n\ninterface CalcTableSelectionPosParams {\n  tblSelection: ITableSelection;\n  table: Table;\n  colsWidth?: Table['data']['colsWidth'];\n  tableNode: HTMLTableElement | null;\n  scale?: number;\n  absPostion?: boolean;\n}\n\n// TODO: memorize\n// 提取计算表格选区的方法，供极简工具栏使用\nconst calcTableSelectionPos = (params: CalcTableSelectionPosParams) => {\n  const {\n    tblSelection,\n    table,\n    colsWidth: colsWidthParams,\n    tableNode,\n    scale = 1,\n    absPostion,\n  } = params;\n  if (\n    !tblSelection ||\n    !tableNode\n  ) {\n    return undefined;\n  }\n  const {\n    startRowIndex, startColIndex, endRowIndex, endColIndex,\n  } = tblSelection;\n\n  const startRow = table.nodes[startRowIndex];\n  const endRow = table.nodes[endRowIndex];\n  if (!TableRow.isTableRow(startRow) || !TableRow.isTableRow(endRow)) {\n    return undefined;\n  }\n\n  let colsWidth = colsWidthParams;\n  if (!colsWidth) {\n    const dataColsWidth = table.data.colsWidth;\n    if (!Array.isArray(dataColsWidth)) return undefined;\n\n    colsWidth = dataColsWidth;\n    if (Table.isAutofitWidth(table)) {\n      const tableWidth = tableNode.getBoundingClientRect().width;\n      const totalColsWidth = dataColsWidth.reduce((acc, w) => (acc + w));\n      colsWidth = dataColsWidth.map(w => (w / totalColsWidth * tableWidth / scale));\n    }\n  }\n\n  let left = colsWidth\n    .slice(0, startColIndex)\n    .reduce((acc, c) => (acc + c), 0);\n  const right = colsWidth\n    .slice(0, endColIndex + 1)\n    .reduce((acc, c) => (acc + c), 0);\n  const width = Math.max(0, (right - left));\n\n  const firstRow = table.nodes[0];\n\n  const startCell = startRow.nodes[startColIndex];\n  const endCell = endRow.nodes[endColIndex];\n  if (!startCell || !endCell) {\n    return undefined;\n  }\n\n  const relativeParent = tableNode.parentElement;\n\n  if (!relativeParent) return undefined;\n\n  const firstRowDOM: HTMLDivElement | null = relativeParent.querySelector(`[data-cangjie-key=\"${firstRow.key}\"]`);\n  const startRowNode: HTMLDivElement | null = relativeParent.querySelector(`[data-cangjie-key=\"${startRow.key}\"]`);\n  const endRowNode: HTMLDivElement | null = relativeParent.querySelector(`[data-cangjie-key=\"${endRow.key}\"]`);\n\n  if (!startRowNode || !endRowNode || !firstRowDOM) {\n    return undefined;\n  }\n\n  const startCellRect = getBoundingRelativeRect(startRowNode, relativeParent);\n  const endCellRect = getBoundingRelativeRect(endRowNode, relativeParent);\n  const firstCellRect = getBoundingRelativeRect(firstRowDOM, relativeParent);\n  let { top } = startCellRect;\n  const bottom = Math.max(startCellRect.bottom, endCellRect.bottom);\n  const height = (bottom - top) / scale;\n  let topDelta = 0;\n  let isSticky = false;\n  // 纠正 top 值（在高版本 chrome 中可能会有 0.5px 的偏移，在此消除偏移）\n  if (firstCellRect.top !== 0) {\n    // 若首行单元格的相对表格的 top 比较大，说明首行处于 sticky 状态\n    isSticky = firstCellRect.top > 1 || firstCellRect.top < -1;\n    if (!isSticky) {\n      topDelta = firstCellRect.top;\n    } else if (startRowIndex !== 0) {\n      const lastRow = table.nodes[table.nodes.length - 1];\n      const lastRowDOM = domUtils.findDOMNodeSafely(lastRow.key, relativeParent);\n      if (lastRowDOM) {\n        const tableBottom = relativeParent.getBoundingClientRect().bottom;\n        const lastRowBottom = lastRowDOM.getBoundingClientRect().bottom;\n        const relativeBottom = tableBottom - lastRowBottom;\n        if (relativeBottom < 1 && relativeBottom > -1) {\n          topDelta = relativeBottom;\n        }\n      }\n    }\n  }\n  const isSelectWholeCol = startRowIndex === 0 && endRowIndex === table.nodes.length - 1;\n  const isSelectFirstRow = startRowIndex === 0 && endRowIndex === 0;\n  // sticky 状态下选中整列时，高度不要 +1，否则会出现纵向滚动条\n  const heightDelta = isSticky && (isSelectWholeCol || isSelectFirstRow) ? 0 : 1;\n\n  top = (top - topDelta) / scale;\n  // 计算绝对位置（默认计算相对 table 位置）\n  if (absPostion) {\n    const parentRect = relativeParent.getBoundingClientRect();\n    top += parentRect.top / scale;\n    left += parentRect.left / scale;\n  }\n  return ({\n    top,\n    left,\n    width: width + 1,\n    height: height + heightDelta,\n  });\n};\n\nexport default calcTableSelectionPos;\n"],"file":"calcTableSelectionPos.js"}