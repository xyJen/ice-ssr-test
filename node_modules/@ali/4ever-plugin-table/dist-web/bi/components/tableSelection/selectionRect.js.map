{"version":3,"sources":["../../../../../src/bi/components/tableSelection/selectionRect.tsx"],"names":["React","styled","fastdom","THEME","calcTableSelectionPos","constants","STICKY_TOOLBAR_INDEX_MAP","TableSelectionRect","div","blue3","blue0","SelectionRect","props","tableSelection","table","tableRef","scale","colsWidth","style","propsStyle","testid","forceUpdate","useState","setStyle","prevDisplayRef","useRef","measureTaskRef","draw","useCallback","tblSelection","current","clear","measure","display","pos","tableNode","useLayoutEffect","zIndex","useMemo","startRowIndex","selection","stickyRow"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport styled from 'styled-components';\nimport fastdom from 'fastdom';\nimport Table from '../../../mo/models';\nimport { ITableSelection } from '../../types';\nimport { THEME } from '../../constants';\nimport calcTableSelectionPos from '../../utils/calcTableSelectionPos';\nimport constants from '../../../utils/constants';\n\nconst { STICKY_TOOLBAR_INDEX_MAP } = constants;\n\nconst TableSelectionRect = styled.div`\n  position: absolute;\n  z-index: 100;\n  pointer-events: none;\n  outline-offset: -2px;\n  box-sizing: border-box;\n  border: 1px solid ${THEME.blue3};\n  background-color: ${THEME.blue0};\n`;\n\ninterface Props {\n  tableSelection?: ITableSelection | null;\n  table: Table;\n  tableRef: React.RefObject<HTMLTableElement>;\n  scale: number;\n  colsWidth: Table['data']['colsWidth'];\n  style?: React.CSSProperties;\n  testid?: string;\n  forceUpdate?: number;\n}\n\nconst SelectionRect = (props: Props) => {\n  const {\n    tableSelection,\n    table,\n    tableRef,\n    scale,\n    colsWidth,\n    style: propsStyle = {},\n    testid = '',\n    forceUpdate,\n  } = props;\n\n  const [style, setStyle] = React.useState<React.CSSProperties>({});\n  const prevDisplayRef = React.useRef<'none' | 'block'>();\n  const measureTaskRef = React.useRef<() => void>();\n\n  const draw = React.useCallback((tblSelection) => {\n    measureTaskRef.current && fastdom.clear(measureTaskRef.current);\n    measureTaskRef.current = fastdom.measure(() => {\n      if (!tblSelection) {\n        if (prevDisplayRef.current !== 'none') {\n          setStyle({\n            display: 'none',\n          });\n        }\n        return;\n      }\n\n      const pos = calcTableSelectionPos({\n        tblSelection,\n        table,\n        tableNode: tableRef.current,\n        scale,\n        colsWidth,\n      });\n      if (pos) {\n        setStyle({\n          ...pos,\n          display: 'block',\n        });\n      } else {\n        setStyle({\n          display: 'none',\n        })\n      }\n    });\n    return () => {\n      measureTaskRef.current && fastdom.clear(measureTaskRef.current);\n    };\n  }, [table, scale, tableRef, colsWidth]);\n\n  React.useLayoutEffect(() => {\n    draw(tableSelection);\n  }, [draw, tableSelection, forceUpdate]);\n\n  const zIndex = React.useMemo(() => {\n    if (tableSelection && tableSelection.startRowIndex !== 0) {\n      // selection 不包含首行时，selection zIndex 要低于首行\n      // 保证首行吸顶时，滚动文档，选区不遮挡首行\n      return STICKY_TOOLBAR_INDEX_MAP.selection;\n    }\n\n    return STICKY_TOOLBAR_INDEX_MAP.stickyRow + 1;\n  }, [tableSelection]);\n\n  return (\n    <TableSelectionRect\n      data-testid={testid}\n      style={{\n        ...propsStyle,\n        ...style,\n        zIndex,\n      }}\n    />\n  );\n};\n\nexport default SelectionRect;\n"],"file":"selectionRect.js"}