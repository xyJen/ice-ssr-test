{"version":3,"sources":["../../../../../src/bi/components/rowToolbar/index.tsx"],"names":["React","useEffect","useLayoutEffect","equal","ReactDOM","styled","throttle","fastdom","logger","Table","domUtils","useHotsAtTheStartOfNextFrame","getBoundingRelativeRect","getRelativeMouseEvent","HOVER_SHOW_INSERT_DELTA","DISTANCE_BETWEEN_INSERT_BUTTON_AND_TOOLBAR","DRAG_TRIGGER_TIME","DISTANCE_BETWEEN_DELETE_BUTTON_AND_TOOLBAR","RowResizer","logNPEInfo","getAllRowsDomRect","clickTableToolbar","deleteTableRows","insertTableRow","moveTableRows","InlineToolbarInsertButton","InlineToolbarDeleteButton","InsertButtonIndicator","INDICATOR_WRAPPER_WIDTH","DragElement","RowToolbarItem","scrollVerticalContainer","createToolbarWithTableSeletion","getDataTableSelectionByTable","getSelectedRowRangeFromTableSelection","hasIntersectionObserver","constants","hooks","usePixelColsWidth","useRowsClientHeight","useRowIsSticky","useScrollableContainerRect","REALTABLE_PADDING","TOOLBAR_ITEM_SIZE","MIN_ROW_HEIGHT","STICKY_ROW_TOP_HEIGHT","STICKY_TOOLBAR_INDEX_MAP","RowToolbarWrapper","div","visible","props","scale","rowToolbar","p","top","RowInlineToolbar","isShow","RowToolbarResizer","TableRowToolbar","table","isSelected","controller","zoomContainer","tableRef","offsetParentRef","realTableWrapperRef","rowIndicatorRef","selection","hoverSelection","scrollableContainer","onContextMenu","onSelect","onRowResize","setIsHighlightSelection","setHoverSelection","getLastActiveTableKey","locale","isHideDeleteButton","isHoverCornerToolbar","colsWidth","isRowHeader","isSticky","scrollRect","rowsClientHeight","rowsHeight","useMemo","nodes","map","row","key","useState","contextMenuVisible","setContextMenuVisible","positionOfInsertButton","setInsetBtnPos","isHoverDelete","setIsHoverDelete","hoverToolbarItemIndex","setHoverToolbarItemIndex","isDragging","setIsDragging","draggingRowHeight","setDraggingRowHeight","deleteButtonRef","useRef","rowToolbarRef","insertButtonRef","draggingRowResizer","startPositionTop","startClientY","originBodyCursor","rowResizerRef","deleteButtonTop","rowsRect","isResizingRowFlag","dragElementRef","dataInsertIndex","startSelectIndex","selectedIndexRange","intersectionObRef","observerTargets","isInitObserver","initObserver","useCallback","current","IntersectionObserver","changes","change","intersectionRatio","target","style","visibility","threshold","document","querySelectorAll","forEach","observe","detachObserver","unobserve","disconnect","getRowIndexByClientY","clientY","index","query","node","calcRowsHeight","startIndex","endIndex","end","undefined","slice","reduce","totalHeight","h","updateInsertButtonStyle","insertButtonNode","bottom","menuRect","right","insertButtonTop","height","position","transform","left","rowHeight","Number","isFinite","Math","round","Object","entries","k","v","updateIndicatorStyle","targetRow","min","length","rowDOM","findDOMNode","tableDOM","trueTableDOM","rowRect","tableRect","trueTableRect","width","relativeTop","e","info","type","JSON","stringify","getDataSelectedIndexRange","tableSelection","getSelectedIndexRange","getSortedSelectedRange","r","range","start","max","updateToolbarStyle","updateDeleteButtonStyle","display","thisNode","targetStartNode","children","startRowIndex","targetEndNode","endRowIndex","message","menuNode","targetStartRect","targetEndRect","mid","handlePreventDefault","event","preventDefault","stopPropagation","showIndicatorVisible","isVisible","opacity","handleMouseMove","clientX","getBoundingClientRect","toolbarRect","setPositionOfInsertButton","leading","i","handleMouseOverRowToolbarItem","isToolbarItem","getAttribute","parseInt","isNaN","tableCols","data","startColIndex","endColIndex","handleMouseOutRowToolbarItem","hideContextMenu","removeEventListener","selectRows","shouldHideContextMenu","shouldEnableEndDrag","insertIndex","rowsLength","maxColIndex","aboveRowSelection","handleMultiSelectRow","buttons","removeMultiSelectListener","endSelectedIndex","transition","moveRowToIndex","originIndexRange","targetIndex","run","updateDragElementPosition","x","y","calcInsertIndexByRowsRects","rects","rowsRects","updateDraggingStyle","relativeEvent","relativeX","relativeY","sortedRange","dataRowNodes","shouldDragEnd","dataInsertIndexTemp","handleDragging","handleDragEnd","handleDragStart","addEventListener","removeDragEventListener","addMultiSelectListener","enableDragIcon","tbs","Boolean","handleSelectRow","sortRange","shiftKey","timer","isRightClick","clearTimer","clearTimeout","removeCancelDragEventListener","window","setTimeout","handleRowResizing","rowToolbarItem","parentElement","rowToolbarItemRect","validClientY","delta","colResizer","handleRowResizeEnd","resizingRowIndex","resizingRowKey","backgroundColor","body","cursor","rowResizer","handleRowResizeStart","resizerRect","setProperty","realTableWrapperRect","tableWidth","deleteRow","insertRow","highlightSelection","cancelHighlightSelection","handleMouseOver","targetDom","srcElement","isInsideRowToolbar","contains","setCanInsertBtnShow","toolbarTop","findIndex","canInsertBtnShow","handleMouseOut","handleMouseEnterIndicator","handleContextMenu","renderRowToolbarItems","rowsCount","isSelectWholeTable","indexRange","deleteRange","selectRanges","push","activeRange","getInsertButtonIndicator","isFirst","indicatorStyle","isShowButton","isShowDelete","preTableRef","measure","colsWidthRef","scaleRef","onHotsNextFrame","hots","some","hot","hasNode","sum","isShowInsertButton","isRowInlineToolbarShow","paddingTop","createPortal"],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/no-shadow */\n/* eslint-disable max-lines */\n/* eslint-disable react/no-find-dom-node */\nimport React, { useEffect, useLayoutEffect } from 'react';\nimport equal from 'fast-deep-equal';\nimport * as ReactDOM from 'react-dom';\nimport styled from 'styled-components';\nimport { throttle } from 'lodash-es';\nimport fastdom from 'fastdom';\nimport logger from '@ali/4ever-logger';\nimport Table from '../../../mo/models';\nimport TableRow from '../../../mo/models/tableRow';\nimport { domUtils, Hot, useHotsAtTheStartOfNextFrame } from '@ali/4ever-cangjie';\nimport {\n  getBoundingRelativeRect,\n  getRelativeMouseEvent,\n} from '@ali/4ever-utils';\nimport {\n  HOVER_SHOW_INSERT_DELTA,\n  DISTANCE_BETWEEN_INSERT_BUTTON_AND_TOOLBAR,\n  DRAG_TRIGGER_TIME,\n  DISTANCE_BETWEEN_DELETE_BUTTON_AND_TOOLBAR,\n} from '../../constants';\nimport { RowResizer } from '../styled';\nimport { logNPEInfo } from '../../utils/logger';\nimport { ISelectedIndexRange, ITableSelection } from '../../types';\nimport getAllRowsDomRect from '../../queries/getAllRowsDomRect';\nimport {\n  clickTableToolbar,\n  deleteTableRows,\n  insertTableRow,\n  moveTableRows,\n} from '../../actions';\nimport InlineToolbarInsertButton from '../inlineToolbarButtons/inlineToolbarInsertButton';\nimport InlineToolbarDeleteButton from '../inlineToolbarButtons/inlineToolbarDeleteButton';\nimport InsertButtonIndicator, {\n  INDICATOR_WRAPPER_WIDTH,\n} from '../inlineToolbarButtons/insertButtonIndicator';\nimport DragElement from './dragElement';\nimport RowToolbarItem from './rowToolbarItem';\nimport { scrollVerticalContainer } from '../../utils/scrollContainer';\nimport createToolbarWithTableSeletion from '../createToolbarWithTableSelection';\nimport type { TableRowToolbarProps } from '../createToolbarWithTableSelection';\nimport getDataTableSelectionByTable from '../../utils/getDataTableSelectionByTable';\nimport { getSelectedRowRangeFromTableSelection } from '../../utils/getSelectedRangeFromTableSelection';\nimport hasIntersectionObserver from '../../utils/hasIntersectionObserver';\nimport constants from '../../../utils/constants';\nimport * as hooks from '../../../utils/hooks';\n\nconst {\n  usePixelColsWidth,\n  useRowsClientHeight,\n  useRowIsSticky,\n  useScrollableContainerRect,\n} = hooks;\n\nconst {\n  REALTABLE_PADDING,\n  TOOLBAR_ITEM_SIZE,\n  MIN_ROW_HEIGHT,\n  STICKY_ROW_TOP_HEIGHT,\n  STICKY_TOOLBAR_INDEX_MAP,\n} = constants;\n\ninterface IScaleProps {\n  scale: number;\n  visible?: boolean;\n}\n\nconst RowToolbarWrapper = styled.div<IScaleProps>`\n  display: ${({ visible }) => (visible ? 'block' : 'none')};\n  position: absolute;\n  left: ${(props) => -(TOOLBAR_ITEM_SIZE + HOVER_SHOW_INSERT_DELTA) / props.scale}px;\n  box-sizing: border-box;\n  width: ${(props) => (TOOLBAR_ITEM_SIZE + 1 + HOVER_SHOW_INSERT_DELTA) / props.scale}px;\n  padding-left: ${(props) => HOVER_SHOW_INSERT_DELTA / props.scale}px;\n  z-index: ${STICKY_TOOLBAR_INDEX_MAP.rowToolbar};\n  top: ${(p) => (REALTABLE_PADDING.top + TOOLBAR_ITEM_SIZE) / p.scale}px;\n`;\n\nconst RowInlineToolbar = styled.div<{ isShow: boolean }>`\n  position: absolute;\n  z-index: 100;\n  opacity: ${(p) => (p.isShow ? 1 : 0)};\n  transition: opacity ease-in 0.25s;\n  pointer-events: ${(p) => (p.isShow ? 'auto' : 'none')};\n`;\n\nconst RowToolbarResizer = styled.div<IScaleProps>`\n  position: absolute;\n  bottom: -4px;\n  right: -1px;\n  height: 7px;\n  width: ${(props) => ((TOOLBAR_ITEM_SIZE + 1) / props.scale)}px;\n  background-color: transparent;\n  z-index: 1;\n  cursor: row-resize;\n\n  &:hover {\n    background-color: #3296FA;\n  }\n`;\n\nconst TableRowToolbar = (props: TableRowToolbarProps) => {\n  const {\n    table,\n    isSelected,\n    controller,\n    zoomContainer,\n    scale,\n    tableRef,\n    offsetParentRef,\n    realTableWrapperRef,\n    rowIndicatorRef,\n    selection,\n    hoverSelection,\n    scrollableContainer,\n    onContextMenu,\n    onSelect,\n    onRowResize,\n    setIsHighlightSelection,\n    setHoverSelection,\n    getLastActiveTableKey,\n    locale,\n    isHideDeleteButton,\n    isHoverCornerToolbar,\n  } = props;\n\n  const [colsWidth] = usePixelColsWidth();\n  const isRowHeader = Table.isRowHeader(table);\n  const [isSticky] = useRowIsSticky();\n  const [scrollRect] = useScrollableContainerRect();\n  const [rowsClientHeight] = useRowsClientHeight();\n\n  const rowsHeight = React.useMemo(() => {\n    return table.nodes.map((row) => (rowsClientHeight[row.key] || 0));\n  }, [rowsClientHeight, table.nodes]);\n\n  const [contextMenuVisible, setContextMenuVisible] = React.useState<boolean>(false);\n\n  const [positionOfInsertButton, setInsetBtnPos] = React.useState<number>(-1);\n\n  const [isHoverDelete, setIsHoverDelete] = React.useState<boolean>(false);\n\n  const [hoverToolbarItemIndex, setHoverToolbarItemIndex] = React.useState<number>(-1);\n\n  const [isDragging, setIsDragging] = React.useState<boolean>(false);\n\n  const [draggingRowHeight, setDraggingRowHeight] = React.useState<number>(0);\n\n  const deleteButtonRef = React.useRef<HTMLDivElement>(null);\n\n  const rowToolbarRef = React.useRef<HTMLDivElement>(null);\n\n  const insertButtonRef = React.useRef<HTMLDivElement>(null);\n\n  const draggingRowResizer = React.useRef<HTMLDivElement | null>(null);\n\n  const startPositionTop = React.useRef<number | null>(null);\n\n  const startClientY = React.useRef<number | null>(null);\n\n  const originBodyCursor = React.useRef<string>('');\n\n  const rowResizerRef = React.useRef<HTMLDivElement>(null);\n\n  const deleteButtonTop = React.useRef<number>(-1);\n\n  // 当前 viewTable 下的所有行的 DOMRect\n  // \b\b不是 dataTable\n  const rowsRect = React.useRef<DOMRect[]>([]);\n\n  const isResizingRowFlag = React.useRef<boolean>(false);\n\n  const dragElementRef = React.useRef<HTMLDivElement>(null);\n\n  const dataInsertIndex = React.useRef<number>(-1);\n\n  const startSelectIndex = React.useRef<number>(-1);\n\n  const selectedIndexRange = React.useRef<ISelectedIndexRange | null>(null);\n\n\n  const intersectionObRef = React.useRef<IntersectionObserver | null>(null);\n\n  const observerTargets = React.useRef<any>(null);\n\n  const isInitObserver = React.useRef<boolean>(false); // intersectionOb是否已经监听，避免多次重复监听\n\n  const initObserver = React.useCallback(() => {\n    intersectionObRef.current = new IntersectionObserver((changes) => {\n      for (const change of changes) {\n        if (change.intersectionRatio <= 0) {\n          (change.target as HTMLDivElement).style.visibility = 'hidden';\n        } else {\n          (change.target as HTMLDivElement).style.visibility = 'inherit';\n        }\n      }\n    }, {\n      threshold: [0, 1],\n    });\n    observerTargets.current = document.querySelectorAll('[data-ob=\"true\"]');\n    observerTargets.current.forEach((target) => {\n      intersectionObRef.current!.observe(target);\n    });\n  }, []);\n\n  const detachObserver = React.useCallback(() => {\n    if (observerTargets.current && intersectionObRef.current) {\n      observerTargets.current.forEach((target) => {\n        intersectionObRef.current!.unobserve(target);\n      });\n      intersectionObRef.current!.disconnect();\n    }\n  }, []);\n\n\n  useEffect(() => {\n    if (hasIntersectionObserver && isSelected && !isInitObserver.current) {\n      // 监听后标记为true，避免重复执行\n      isInitObserver.current = true;\n      initObserver();\n    }\n  }, [initObserver, isSelected]);\n\n  const getRowIndexByClientY = React.useCallback((clientY: number) => {\n    const index = controller.query('getRowIndexByClientY', { node: table, clientY });\n    return index === null ? -1 : index;\n  }, [controller, table]);\n\n  const calcRowsHeight = React.useCallback((startIndex: number, endIndex?: number) => {\n    const end = endIndex === undefined ? endIndex : endIndex + 1;\n    return rowsHeight\n      .slice(startIndex, end)\n      .reduce((totalHeight, h) => {\n        return totalHeight + h;\n      }, 0);\n  }, [rowsHeight]);\n\n  const updateInsertButtonStyle = React.useCallback(() => {\n    if (\n      positionOfInsertButton === -1 ||\n      !insertButtonRef.current ||\n      !selection\n    ) {\n      return;\n    }\n\n    const insertButtonNode = insertButtonRef.current;\n    const bottom = calcRowsHeight(positionOfInsertButton);\n    const menuRect = getBoundingRelativeRect(insertButtonNode, zoomContainer);\n\n    const right =\n      DISTANCE_BETWEEN_INSERT_BUTTON_AND_TOOLBAR + TOOLBAR_ITEM_SIZE;\n    const insertButtonTop = (bottom - menuRect.height / 2) / scale;\n\n    const style = {\n      position: 'absolute',\n      right: 'unset',\n      top: 'unset',\n      transform: 'unset',\n      bottom: 'unset',\n      left: 'unset',\n    };\n\n    if (\n      isSticky &&\n      (positionOfInsertButton === 0 || positionOfInsertButton === 1)\n    ) {\n      style.position = 'fixed';\n      style.right = 'unset';\n\n      const top =\n        scrollRect.top + STICKY_ROW_TOP_HEIGHT - menuRect.height / 2;\n      const rowHeight = positionOfInsertButton === 0 ? 0 : rowsHeight[0];\n      style.top = `${top + rowHeight}px`;\n      if (Number.isFinite(scrollRect.left)) {\n        style.left = `${scrollRect.left}px`;\n      }\n      style.transform = 'translateX(calc(-100% - 2px))';\n    } else {\n      style.bottom = `${Math.round(insertButtonTop)}px`;\n      style.right = `${Math.round(right / scale)}px`;\n    }\n\n    Object.entries(style).forEach(([k, v]) => {\n      insertButtonNode.style[k] = v;\n    });\n  }, [\n    positionOfInsertButton,\n    selection,\n    calcRowsHeight,\n    zoomContainer,\n    scale,\n    isSticky,\n    scrollRect,\n    rowsHeight,\n  ]);\n\n  const updateIndicatorStyle = React.useCallback(() => {\n    if (\n      !selection ||\n      !rowIndicatorRef.current ||\n      positionOfInsertButton === -1\n    ) {\n      return;\n    }\n    try {\n      const targetRow =\n        table.nodes[Math.min(positionOfInsertButton, table.nodes.length - 1)];\n      // Fix to https://work.aone.alibaba-inc.com/issue/38856463. targetRow会存在拿不到的情况，未能复现早值班问题，暂时不好定位具体原因\n      // 先做兜底处理,可能跟协同场景下的一些特殊操作有关?\n      if (!targetRow?.key) {\n        return;\n      }\n      const rowDOM = domUtils.findDOMNode(targetRow.key)!;\n      const tableDOM = domUtils.findDOMNode(table.key)!;\n      const trueTableDOM = tableRef.current!;\n      const rowRect = getBoundingRelativeRect(rowDOM, offsetParentRef.current);\n      const tableRect = getBoundingRelativeRect(tableDOM, zoomContainer);\n      const trueTableRect = getBoundingRelativeRect(\n        trueTableDOM,\n        zoomContainer,\n      );\n      const width =\n        Math.min(tableRect.width, trueTableRect.width) + TOOLBAR_ITEM_SIZE;\n      rowIndicatorRef.current.style.width = `${Math.round(width / scale)}px`;\n      rowIndicatorRef.current.style.transform = `translateX(${\n        -TOOLBAR_ITEM_SIZE / scale\n      }px)`;\n\n      let relativeTop = rowRect.top;\n      if (positionOfInsertButton === table.nodes.length) {\n        relativeTop = rowRect.bottom;\n      }\n      if (\n        isSticky &&\n        (positionOfInsertButton === 0 || positionOfInsertButton === 1)\n      ) {\n        const top = scrollRect.top + STICKY_ROW_TOP_HEIGHT;\n        const rowHeight = positionOfInsertButton === 0 ? 0 : rowsHeight[0];\n        rowIndicatorRef.current.style.top = `${top + rowHeight}px`;\n        rowIndicatorRef.current.style.position = 'fixed';\n      } else {\n        rowIndicatorRef.current.style.top = `${Math.round(\n          relativeTop / scale,\n        )}px`;\n        rowIndicatorRef.current.style.position = 'absolute';\n      }\n    } catch (e) {\n      logger.info({\n        type: 'updateIndicatorStyle',\n        info: JSON.stringify(e),\n      });\n    }\n  }, [\n    selection,\n    rowIndicatorRef,\n    positionOfInsertButton,\n    table.nodes,\n    table.key,\n    tableRef,\n    offsetParentRef,\n    zoomContainer,\n    scale,\n    isSticky,\n    scrollRect.top,\n    rowsHeight,\n  ]);\n\n  const getDataSelectedIndexRange = React.useCallback(() => {\n    const tableSelection = getDataTableSelectionByTable(controller, table);\n    return getSelectedRowRangeFromTableSelection({\n      controller,\n      table,\n      tableSelection,\n    });\n  }, [controller, table]);\n\n  const getSelectedIndexRange = React.useCallback(() => {\n    const tableSelection = getDataTableSelectionByTable(controller, table);\n    return getSelectedRowRangeFromTableSelection({\n      controller,\n      table,\n      tableSelection,\n    });\n  }, [controller, table]);\n\n  const getSortedSelectedRange = React.useCallback((r?: ISelectedIndexRange | null) => {\n    const range = r || getSelectedIndexRange();\n    if (!range) {\n      return null;\n    }\n    const { start, end } = range;\n    const min = Math.min(start, end);\n    const max = Math.max(start, end);\n    return {\n      min,\n      max,\n    };\n  }, [getSelectedIndexRange]);\n\n  const updateToolbarStyle = React.useCallback(() => {\n    updateInsertButtonStyle();\n    updateIndicatorStyle();\n  }, [updateInsertButtonStyle, updateIndicatorStyle]);\n\n  const updateDeleteButtonStyle = React.useCallback(() => {\n    if (!deleteButtonRef.current || !selection) {\n      return;\n    }\n    deleteButtonRef.current.style.display = 'block';\n\n    const thisNode = ReactDOM.findDOMNode(rowToolbarRef.current) as HTMLElement;\n    const targetStartNode = thisNode.children[selection.startRowIndex]?.children[0] as HTMLElement;\n    const targetEndNode = thisNode.children[selection.endRowIndex]?.children[0] as HTMLElement;\n    // TODO: targetEndNode/targetStartNode 为空根因待排查\n    // 添加日志定位\n    if (!targetEndNode || !targetStartNode) {\n      logNPEInfo(\n        table,\n        {\n          selection,\n          message: `${targetEndNode ? 'targetStartNode' : 'targetEndNode'} is undefined \\n`,\n        },\n      );\n      return;\n    }\n\n    const menuNode = ReactDOM.findDOMNode(deleteButtonRef.current) as HTMLElement;\n    const targetStartRect = getBoundingRelativeRect(targetStartNode, zoomContainer);\n    const targetEndRect = getBoundingRelativeRect(targetEndNode, zoomContainer);\n    const menuRect = getBoundingRelativeRect(menuNode, zoomContainer);\n    const mid = (targetEndRect.bottom - targetStartRect.top) / 2;\n    const relativeTop = targetStartRect.top + mid - menuRect.height / 2;\n    const left = targetStartRect.left - menuRect.width - DISTANCE_BETWEEN_DELETE_BUTTON_AND_TOOLBAR;\n    deleteButtonTop.current = relativeTop / scale;\n    menuNode.style.top = `${deleteButtonTop.current}px`;\n    menuNode.style.left = `${left / scale}px`;\n  }, [selection, zoomContainer, table, scale]);\n\n  const handlePreventDefault = React.useCallback((event) => {\n    event.preventDefault();\n    event.stopPropagation();\n  }, []);\n\n  const showIndicatorVisible = React.useCallback((isVisible: boolean) => {\n    if (!rowIndicatorRef.current) {\n      return;\n    }\n    const opacity = isVisible ? '1' : '0';\n    rowIndicatorRef.current.style.opacity = opacity;\n  }, [rowIndicatorRef]);\n\n\n  // 根据鼠标位置判断是否出现插入按钮\n  const handleMouseMove = React.useCallback(throttle((event) => {\n    // event 应该是非空的，但是有监控有报错显示为空\n    // https://aone.alibaba-inc.com/v2/project/995011/bug/43391898\n    if (\n      !rowToolbarRef.current ||\n      isResizingRowFlag.current ||\n      isDragging ||\n      !event\n    ) {\n      return;\n    }\n    const { clientX, clientY } = event;\n    // 鼠标位置在插入按钮区域时，不隐藏插入按钮\n    if (positionOfInsertButton !== -1 && insertButtonRef.current) {\n      const insertButtonNode = ReactDOM.findDOMNode(\n        insertButtonRef.current,\n      ) as HTMLDivElement;\n      const { left, top, right, bottom } = insertButtonNode.getBoundingClientRect();\n      if (clientX >= left && clientX <= right && clientY >= top && clientY <= bottom) {\n        return;\n      }\n    }\n    const toolbarRect = rowToolbarRef.current.getBoundingClientRect();\n    const { left, top, right, bottom } = toolbarRect;\n    // 鼠标位置不在 toolbar 区域内时，不显示插入按钮\n    if (\n      clientX < left ||\n      clientX > right ||\n      clientY < (top - INDICATOR_WRAPPER_WIDTH / 2) ||\n      clientY > (bottom + INDICATOR_WRAPPER_WIDTH / 2)\n    ) {\n      showIndicatorVisible(false);\n      setPositionOfInsertButton(-1);\n    }\n  }, 200, { leading: true }),\n  [isDragging, positionOfInsertButton, showIndicatorVisible, getDataSelectedIndexRange]);\n\n  const setPositionOfInsertButton = React.useCallback((index: number) => {\n    let i = index;\n    if (isRowHeader && i === 0) {\n      i = -1;\n    }\n    setInsetBtnPos(i);\n    dataInsertIndex.current = i;\n  }, [isRowHeader]);\n\n  const handleMouseOverRowToolbarItem = React.useCallback(\n    (event) => {\n      if (isResizingRowFlag.current) return;\n      // 如果不是ToolbarItem触发的则不处理\n      const isToolbarItem = event.target.getAttribute('data-ob');\n      if (!isToolbarItem) return;\n      const index = parseInt(event.target.getAttribute('data-index'), 10);\n      if (isNaN(index)) return;\n      const tableCols = table.data?.colsWidth?.length;\n      if (tableCols) {\n        // 构造hover选区\n        const hoverSelection = {\n          key: table.key,\n          startColIndex: 0,\n          endColIndex: tableCols - 1,\n          startRowIndex: index,\n          endRowIndex: index,\n        };\n        setHoverSelection(hoverSelection);\n        // hover的时候不显示插入按钮\n        showIndicatorVisible(false);\n        setPositionOfInsertButton(-1);\n      }\n    },\n    [\n      setHoverSelection,\n      setPositionOfInsertButton,\n      showIndicatorVisible,\n      table.data?.colsWidth?.length,\n      table.key,\n    ],\n  );\n\n  const handleMouseOutRowToolbarItem = React.useCallback((e) => {\n    // 如果不是ToolbarItem触发的则不处理\n    const isToolbarItem = e.target.getAttribute('data-ob');\n    if (!isToolbarItem) return;\n    setHoverSelection(null);\n  }, [setHoverSelection]);\n\n  const hideContextMenu = React.useCallback(() => {\n    setContextMenuVisible(false);\n    document.removeEventListener('mousedown', hideContextMenu);\n  }, []);\n\n  const selectRows = React.useCallback((\n    start: number,\n    end: number,\n    shouldHideContextMenu = true,\n  ) => {\n    if (start === end) {\n      startSelectIndex.current = start;\n    }\n    selectedIndexRange.current = {\n      start,\n      end,\n    };\n    onSelect(\n      {\n        start,\n        end,\n      },\n      shouldHideContextMenu,\n    );\n  }, [onSelect]);\n\n  const shouldEnableEndDrag = React.useCallback((insertIndex: number, rowsLength: number) => {\n    if (insertIndex === 0 && isRowHeader) return false;\n\n    if (insertIndex > 0 && insertIndex < rowsLength) {\n      const maxColIndex = table.data.colsWidth!.length - 1;\n      const aboveRowSelection: ITableSelection = {\n        startRowIndex: 0,\n        endRowIndex: insertIndex - 1,\n        startColIndex: 0,\n        endColIndex: maxColIndex,\n        key: table.key,\n      };\n      return controller.query(\n        'isAllSelectedCellsComplete',\n        { node: table, tableSelection: aboveRowSelection },\n      );\n    }\n    return true;\n  }, [table, controller, isRowHeader]);\n\n  const handleMultiSelectRow = React.useCallback(throttle((event: MouseEvent) => {\n    if (isDragging) {\n      return;\n    }\n    const selectedIndexRange = getDataSelectedIndexRange();\n    const { buttons } = event;\n    // 协同下，rowToolbar 可能不存在\n    if (buttons !== 1 || !rowToolbarRef.current || !selectedIndexRange) {\n      removeMultiSelectListener();\n      return;\n    }\n\n    const endSelectedIndex = getRowIndexByClientY(event.clientY);\n    if (deleteButtonRef.current) {\n      deleteButtonRef.current.style.transition = 'top ease-out 0.1s';\n    }\n    scrollVerticalContainer(event.clientY, scrollableContainer);\n    selectRows(startSelectIndex.current, endSelectedIndex!);\n  }, 100)\n  , [isDragging, getDataSelectedIndexRange, getRowIndexByClientY, selectRows]);\n\n  const moveRowToIndex = React.useCallback((\n    originIndexRange: ISelectedIndexRange,\n    targetIndex: number,\n  ) => {\n    const { min, max } = getSortedSelectedRange(originIndexRange)!;\n    controller.run(\n      'onAction',\n      moveTableRows(\n        table,\n        {\n          start: min,\n          end: max,\n        },\n        targetIndex,\n      ),\n    );\n    const startIndex = min < targetIndex ?\n      targetIndex - (max - min + 1) :\n      targetIndex;\n    selectRows(startIndex, startIndex + max - min);\n  }, [controller, table, getSortedSelectedRange, selectRows]);\n\n  const updateDragElementPosition = React.useCallback((x: number, y: number) => {\n    if (!dragElementRef.current) {\n      return;\n    }\n    dragElementRef.current.style.left = `${x / scale}px`;\n    dragElementRef.current.style.top = `${y / scale}px`;\n  }, [scale]);\n\n  const calcInsertIndexByRowsRects = React.useCallback((clientY: number, rects?: DOMRect[]) => {\n    let rowsRects = rects;\n    if (!rowsRects) {\n      rowsRects = controller.query(\n        'getAllRowsDomRect',\n        { node: table },\n      ) as DOMRect[];\n    }\n    let insertIndex = -1;\n    for (let i = 0; i < rowsRects.length; i++) {\n      const rowRect = rowsRects[i];\n      if (!rowRect) {\n        continue;\n      }\n      if (\n        clientY >= rowRect.top &&\n        clientY <= rowRect.top + rowRect.height / 2\n      ) {\n        insertIndex = i;\n        break;\n      }\n      if (\n        clientY > rowRect.top + rowRect.height / 2 &&\n        clientY < rowRect.bottom\n      ) {\n        insertIndex = i + 1;\n        break;\n      }\n    }\n    return insertIndex;\n  }, [controller, table]);\n\n  const updateDraggingStyle = React.useCallback(\n    (relativeEvent) => {\n      const { clientX, clientY, relativeX, relativeY } = relativeEvent;\n      const tableDOM = domUtils.findDOMNode(table.key) as HTMLElement;\n      if (!tableDOM) {\n        return;\n      }\n      updateDragElementPosition(relativeX, relativeY);\n      const tableRect = tableDOM.getBoundingClientRect();\n      if (\n        clientX < tableRect.left - TOOLBAR_ITEM_SIZE ||\n        clientX > tableRect.right ||\n        clientY < tableRect.top - TOOLBAR_ITEM_SIZE ||\n        clientY > tableRect.bottom\n      ) {\n        showIndicatorVisible(false);\n        setPositionOfInsertButton(-1);\n        return;\n      }\n      scrollVerticalContainer(clientY, scrollableContainer);\n\n      // 先根据 dataModel 计算应该插入行的 index 判断是否可以插入\n      // 再根据 viewModel 计算行插入指示器渲染的位置\n      let insertIndex = calcInsertIndexByRowsRects(clientY);\n      const sortedRange = getSortedSelectedRange();\n      if (!sortedRange) {\n        return;\n      }\n      const { min, max } = sortedRange;\n      if (insertIndex >= min && insertIndex <= max + 1) {\n        insertIndex = -1;\n      }\n      const dataRowNodes = controller.query('getAllRowsNodes', { node: table });\n      if (!dataRowNodes) return;\n\n      const shouldDragEnd = shouldEnableEndDrag(insertIndex, dataRowNodes.length);\n      if (!shouldDragEnd) {\n        insertIndex = -1;\n      }\n      const dataInsertIndexTemp = insertIndex;\n      if (insertIndex !== -1) {\n        insertIndex = calcInsertIndexByRowsRects(clientY, rowsRect.current);\n      }\n      showIndicatorVisible(insertIndex !== -1);\n      setPositionOfInsertButton(insertIndex);\n      dataInsertIndex.current = dataInsertIndexTemp;\n    },\n    [\n      table,\n      controller,\n      scrollableContainer,\n      updateDragElementPosition,\n      showIndicatorVisible,\n      shouldEnableEndDrag,\n      calcInsertIndexByRowsRects,\n      getSortedSelectedRange,\n      setPositionOfInsertButton,\n    ],\n  );\n\n  const handleDragging = React.useCallback((event: React.MouseEvent | MouseEvent) => {\n    const tableDOM = domUtils.findDOMNode(table.key) as HTMLElement;\n    if (!tableDOM || event.buttons !== 1) {\n      handleDragEnd();\n      return;\n    }\n    event.stopPropagation();\n    const relativeEvent = getRelativeMouseEvent(event, zoomContainer);\n    updateDraggingStyle(relativeEvent);\n  }, [table, zoomContainer, updateDraggingStyle]);\n\n  const handleDragEnd = React.useCallback(() => {\n    setIsDragging(false);\n    showIndicatorVisible(false);\n    // Tip: 为避免循环依赖问题，所以这里没有调用removeDragEventListener函数\n    document.removeEventListener('mousemove', handleDragging);\n    document.removeEventListener('mouseup', handleDragEnd);\n    if (dataInsertIndex.current === -1) {\n      return;\n    }\n    const selectedIndexRange = getDataSelectedIndexRange();\n    moveRowToIndex(selectedIndexRange!, dataInsertIndex.current);\n    setPositionOfInsertButton(-1);\n  }, [showIndicatorVisible, handleDragging, getDataSelectedIndexRange, moveRowToIndex, setPositionOfInsertButton]);\n\n  const handleDragStart = React.useCallback((relativeEvent, rowHeight) => {\n    setIsDragging(true);\n    setDraggingRowHeight(rowHeight);\n    updateDraggingStyle(relativeEvent);\n    document.addEventListener('mousemove', handleDragging);\n    document.addEventListener('mouseup', handleDragEnd);\n  }, [updateDraggingStyle, handleDragging, handleDragEnd]);\n\n  const removeDragEventListener = React.useCallback(() => {\n    document.removeEventListener('mousemove', handleDragging);\n    document.removeEventListener('mouseup', handleDragEnd);\n  }, [handleDragging, handleDragEnd]);\n\n  const removeMultiSelectListener = React.useCallback(() => {\n    if (deleteButtonRef.current) {\n      deleteButtonRef.current.style.transition = 'none';\n    }\n    document.removeEventListener('mousemove', handleMultiSelectRow);\n    document.removeEventListener('mouseup', removeMultiSelectListener);\n  }, [handleMultiSelectRow]);\n\n  const addMultiSelectListener = React.useCallback(() => {\n    document.addEventListener('mousemove', handleMultiSelectRow);\n    document.addEventListener('mouseup', removeMultiSelectListener);\n  }, [handleMultiSelectRow, removeMultiSelectListener]);\n\n  const enableDragIcon = React.useCallback(() => {\n    const tbs = getSelectedRowRangeFromTableSelection({\n      controller,\n      table,\n      tableSelection: selection,\n    });\n    const range = getSortedSelectedRange(tbs);\n    // 禁止拖拽表头行\n    if (isRowHeader && range?.min === 0) return false;\n\n    return Boolean(\n      range &&\n        hoverToolbarItemIndex >= range.min &&\n        hoverToolbarItemIndex <= range.max,\n    );\n  }, [\n    controller,\n    table,\n    selection,\n    getSortedSelectedRange,\n    isRowHeader,\n    hoverToolbarItemIndex,\n  ]);\n\n  const handleSelectRow = React.useCallback(\n    (event) => {\n      handlePreventDefault(event);\n      const index = getRowIndexByClientY(event.clientY);\n      const sortRange = getDataSelectedIndexRange();\n      controller.run('onAction', clickTableToolbar(table, 'row', event.target));\n      // shift 键多选行\n      const selectedIndexRange = getDataSelectedIndexRange();\n      if (\n        event.shiftKey &&\n        selectedIndexRange &&\n        startSelectIndex.current !== index\n      ) {\n        let start = startSelectIndex.current;\n        // 这里为单测兼容 startSelectIndex.current 为 -1 的情况\n        // 正常用户操作不会有此类问题\n        if (start === -1) {\n          start = selectedIndexRange.start;\n        }\n        selectRows(start, index);\n        return;\n      }\n      // 直接选中行\n      if (!sortRange || index > sortRange.end || index < sortRange.start) {\n        selectRows(index, index);\n        addMultiSelectListener();\n        return;\n      }\n\n\n      const relativeEvent = getRelativeMouseEvent(event, zoomContainer);\n\n      let timer: number;\n      const isRightClick = event.buttons === 2;\n      const clearTimer = () => {\n        clearTimeout(timer);\n        selectRows(index, index, !isRightClick);\n        removeCancelDragEventListener();\n      };\n      const removeCancelDragEventListener = () => {\n        document.removeEventListener('mousemove', clearTimer);\n        document.removeEventListener('mouseup', clearTimer);\n      };\n      const rowHeight = event.target.getBoundingClientRect().height;\n      timer = window.setTimeout(() => {\n        removeMultiSelectListener();\n        handleDragStart(relativeEvent, rowHeight);\n        removeCancelDragEventListener();\n      }, DRAG_TRIGGER_TIME);\n      if (!enableDragIcon()) {\n        clearTimer();\n      }\n      addMultiSelectListener();\n      document.addEventListener('mousemove', clearTimer);\n      document.addEventListener('mouseup', clearTimer);\n    },\n    [\n      controller,\n      table,\n      zoomContainer,\n      handlePreventDefault,\n      getRowIndexByClientY,\n      getDataSelectedIndexRange,\n      selectRows,\n      addMultiSelectListener,\n      handleDragStart,\n      removeMultiSelectListener,\n      enableDragIcon,\n    ],\n  );\n\n  const handleRowResizing = React.useCallback((event) => {\n    if (!draggingRowResizer.current || !zoomContainer) {\n      return;\n    }\n    event.preventDefault();\n    const relativeEvent = getRelativeMouseEvent(event, zoomContainer);\n\n    const rowToolbarItem = draggingRowResizer.current.parentElement as HTMLElement;\n    if (!rowToolbarItem) {\n      return;\n    }\n    const rowToolbarItemRect = getBoundingRelativeRect(rowToolbarItem, zoomContainer);\n    const validClientY = Math.max(rowToolbarItemRect.top + MIN_ROW_HEIGHT * scale, relativeEvent.relativeY);\n\n    const delta = validClientY - startClientY.current!;\n    const top = `${Math.round(startPositionTop.current! + delta / scale)}px`;\n\n    const colResizer = ReactDOM.findDOMNode(rowResizerRef.current) as HTMLElement;\n    if (!colResizer) {\n      return;\n    }\n    colResizer.style.top = top;\n    draggingRowResizer.current.style.top = top;\n  }, [zoomContainer, scale]);\n\n  // @ts-ignore\n  const handleRowResizeEnd = React.useCallback(() => {\n    isResizingRowFlag.current = false;\n    if (!draggingRowResizer.current || !startPositionTop.current) {\n      return;\n    }\n\n    const delta = parseInt(draggingRowResizer.current.style.top, 10) - Math.round(startPositionTop.current);\n    const resizingRowIndex = parseInt(draggingRowResizer.current.getAttribute('data-index')!, 10);\n    const resizingRowKey = table.nodes[resizingRowIndex].key;\n\n    // @ts-ignore\n    onRowResize(resizingRowKey, delta);\n\n    draggingRowResizer.current.style.backgroundColor = '';\n    draggingRowResizer.current.style.top = '';\n    draggingRowResizer.current = null;\n    startPositionTop.current = null;\n    startClientY.current = null;\n\n    document.body.style.cursor = originBodyCursor.current;\n    originBodyCursor.current = '';\n\n    const rowResizer = ReactDOM.findDOMNode(rowResizerRef.current) as HTMLElement;\n    if (!rowResizer) {\n      return null;\n    }\n    rowResizer.style.display = 'none';\n\n    document.removeEventListener('mousemove', handleRowResizing);\n    document.removeEventListener('mouseup', handleRowResizeEnd);\n  }, [onRowResize, table, handleRowResizing]);\n\n  const handleRowResizeStart = React.useCallback((event: React.MouseEvent<HTMLDivElement, MouseEvent>) => {\n    if (!rowToolbarRef.current) return;\n\n    isResizingRowFlag.current = true;\n    event.preventDefault();\n    event.stopPropagation();\n\n    const relativeEvent = getRelativeMouseEvent(event, zoomContainer);\n\n    startClientY.current = relativeEvent.relativeY;\n    draggingRowResizer.current = event.target as HTMLDivElement;\n    const resizerRect = getBoundingRelativeRect(\n      draggingRowResizer.current,\n      rowToolbarRef.current,\n    );\n    startPositionTop.current = (resizerRect.top + resizerRect.height / 2) / scale;\n    draggingRowResizer.current.style.backgroundColor = 'transparent';\n\n    originBodyCursor.current = document.body.style.cursor;\n    document.body.style.setProperty('cursor', 'row-resize', 'important');\n\n    const table = ReactDOM.findDOMNode(tableRef.current) as HTMLElement;\n    const tableRect = getBoundingRelativeRect(table, zoomContainer);\n    if (!realTableWrapperRef.current) {\n      return;\n    }\n    const realTableWrapperRect = realTableWrapperRef.current.getBoundingClientRect();\n    // eslint-disable-next-line react/no-find-dom-node\n    const rowResizer = ReactDOM.findDOMNode(rowResizerRef.current) as HTMLElement;\n    rowResizer.style.display = 'block';\n    rowResizer.style.top = `${startPositionTop.current}px`;\n    const tableWidth = Math.min(tableRect.width, realTableWrapperRect.width);\n    rowResizer.style.width = `${Math.round(tableWidth / scale)}px`;\n    rowResizer.style.left = `${(TOOLBAR_ITEM_SIZE + HOVER_SHOW_INSERT_DELTA) / scale}px`;\n\n    document.addEventListener('mousemove', handleRowResizing);\n    document.addEventListener('mouseup', handleRowResizeEnd);\n  }, [zoomContainer, scale, realTableWrapperRef, tableRef, handleRowResizing, handleRowResizeEnd]);\n\n  const deleteRow = React.useCallback(() => {\n    controller.run('onAction', deleteTableRows(table));\n  }, [table, controller]);\n\n  const insertRow = React.useCallback(() => {\n    const rowsLength = table.nodes.length;\n    const targetRow = table.nodes[Math.min(positionOfInsertButton, rowsLength - 1)];\n    const type = positionOfInsertButton === rowsLength ?\n      'insert-row-below' :\n      'insert-row-above';\n    // 理论上 targetRow 一定存在，添加 log 定位问题\n    if (!targetRow) {\n      logNPEInfo(table, {\n        type: `insertRow targetRow is undefined ${targetRow}`,\n        positionOfInsertButton,\n        rowsLength,\n      });\n      return;\n    }\n    controller.run('onAction', insertTableRow(targetRow, type));\n  }, [positionOfInsertButton, controller, table]);\n\n  const highlightSelection = React.useCallback(() => {\n    setIsHighlightSelection(true);\n    setIsHoverDelete(true);\n  }, [setIsHighlightSelection]);\n\n  const cancelHighlightSelection = React.useCallback(() => {\n    setIsHighlightSelection(false);\n    setIsHoverDelete(false);\n  }, [setIsHighlightSelection]);\n\n  const handleMouseOver = React.useCallback((e: MouseEvent) => {\n    const targetDom = e.target || e.srcElement;\n    const isInsideRowToolbar = targetDom ? rowToolbarRef.current?.contains(targetDom as Node) || false : false;\n    setCanInsertBtnShow(isInsideRowToolbar);\n    // 通过mouseMove去模拟mouseOver，通过判断e.targte是否为目标dom的子元素或者自身即可\n    if (\n      isResizingRowFlag.current ||\n      isDragging ||\n      !rowToolbarRef.current ||\n      !isInsideRowToolbar\n    ) {\n      return;\n    }\n    const { clientY } = e;\n    const toolbarTop = rowToolbarRef.current.getBoundingClientRect().top;\n    const relativeY = clientY - toolbarTop;\n    let totalHeight = 0;\n    const index = rowsHeight.findIndex((height) => {\n      if (relativeY >= totalHeight && relativeY <= totalHeight + height) {\n        return true;\n      }\n      totalHeight += height;\n      return false;\n    });\n    if (index === 0 && isRowHeader) {\n      setHoverToolbarItemIndex(-1);\n    } else {\n      setHoverToolbarItemIndex(index);\n    }\n  }, [isDragging, rowsHeight, isRowHeader]);\n\n  const [canInsertBtnShow, setCanInsertBtnShow] = React.useState<boolean>(true);\n\n  // 这里通过mouseMove去动态感知全选按钮是否hover到，以此来确定是否需要展示插入行按钮\n  React.useEffect(() => {\n    if (isSelected) {\n      document.addEventListener('mousemove', handleMouseOver, true);\n      return () => {\n        document.removeEventListener('mousemove', handleMouseOver, true);\n      };\n    }\n    return undefined;\n  }, [handleMouseOver, isSelected]);\n\n  const handleMouseOut = React.useCallback(() => {\n    if (isResizingRowFlag.current || isDragging) {\n      return;\n    }\n    setHoverToolbarItemIndex(-1);\n  }, [isDragging]);\n\n  const handleMouseEnterIndicator = React.useCallback((insertIndex: number) => {\n    setPositionOfInsertButton(insertIndex);\n    showIndicatorVisible(insertIndex !== -1);\n  }, [setPositionOfInsertButton, showIndicatorVisible]);\n\n  const handleContextMenu = React.useCallback((event) => {\n    handlePreventDefault(event);\n\n    onContextMenu(event);\n\n    setContextMenuVisible(true);\n  }, [handlePreventDefault, onContextMenu, setContextMenuVisible]);\n\n  const renderRowToolbarItems = React.useMemo(() => {\n    const rowsCount = table.nodes.length;\n    const children: React.ReactNode[] = [];\n    const isSelectWholeTable = controller.query('isSelectWholeTable', {\n      node: table,\n    });\n    const indexRange = getSelectedIndexRange();\n    const deleteRange = isHoverDelete ? indexRange! : null;\n    const selectRanges = indexRange ? [indexRange] : [];\n    if (isHoverCornerToolbar || isSelectWholeTable) {\n      selectRanges.push({ start: 0, end: rowsCount - 1 });\n    } else if (\n      hoverSelection &&\n      hoverSelection.startRowIndex === hoverSelection.endRowIndex\n    ) {\n      selectRanges.push({\n        start: hoverSelection.startRowIndex,\n        end: hoverSelection.endRowIndex,\n      });\n    }\n    const activeRange = selection\n      ? {\n        start: selection.startRowIndex,\n        end: selection.endRowIndex,\n      }\n      : null;\n    const getInsertButtonIndicator = (i: number, isFirst?: boolean) => {\n      const indicatorStyle: React.CSSProperties = {\n        position: 'absolute',\n        right: 8 / scale,\n      };\n      if (isFirst) {\n        indicatorStyle.top = 0;\n        indicatorStyle.transform = 'translateY(-50%)';\n      } else {\n        indicatorStyle.bottom = 0;\n        indicatorStyle.transform = 'translateY(50%)';\n      }\n      return (\n        <InsertButtonIndicator\n          key={i}\n          data-index={i}\n          scale={scale}\n          onClick={insertRow}\n          onMouseEnter={handleMouseEnterIndicator}\n          style={indicatorStyle}\n        />\n      );\n    };\n    for (let i = 0; i < rowsCount; i += 1) {\n      children.push(\n        <RowToolbarItem\n          key={table.nodes[i].key}\n          index={i}\n          width={TOOLBAR_ITEM_SIZE}\n          table={table}\n          deleteRange={deleteRange}\n          selectRanges={selectRanges}\n          activeRange={activeRange}\n          isSticky={isSticky}\n          scale={scale}\n          rowHeight={rowsHeight[i]}\n          onMouseOut={handleMouseOutRowToolbarItem}\n          onMouseOver={handleMouseOverRowToolbarItem}\n          onMouseDown={handleSelectRow}\n          onContextMenu={handleContextMenu}\n          onClick={handlePreventDefault}\n        >\n          {i === 0 && !isRowHeader ? getInsertButtonIndicator(i, true) : null}\n          {getInsertButtonIndicator(i + 1)}\n          <RowToolbarResizer\n            data-index={i}\n            onMouseDown={handleRowResizeStart}\n            scale={scale}\n            data-testid=\"table-row-toolbar-resizer\"\n          />\n        </RowToolbarItem>,\n      );\n    }\n    return children;\n  }, [\n    table,\n    controller,\n    getSelectedIndexRange,\n    isHoverDelete,\n    isHoverCornerToolbar,\n    hoverSelection,\n    selection,\n    scale,\n    insertRow,\n    handleMouseEnterIndicator,\n    isSticky,\n    rowsHeight,\n    handleMouseOutRowToolbarItem,\n    handleMouseOverRowToolbarItem,\n    handleSelectRow,\n    handleContextMenu,\n    handlePreventDefault,\n    isRowHeader,\n    handleRowResizeStart,\n  ]);\n\n  const isShowButton = React.useCallback(() => {\n    return !contextMenuVisible &&\n      zoomContainer &&\n      getLastActiveTableKey() === table.key &&\n      selection;\n  }, [contextMenuVisible, zoomContainer, getLastActiveTableKey, table.key, selection]);\n\n  // 展示插入按钮时隐藏删除按钮\n  const isShowDelete = React.useCallback(() => {\n    const selectedIndexRange = getSelectedIndexRange();\n    return Boolean(isShowButton() &&\n      selectedIndexRange &&\n      positionOfInsertButton === -1 &&\n      !isDragging &&\n      !isHideDeleteButton);\n  }, [getSelectedIndexRange, isShowButton, positionOfInsertButton, isDragging, isHideDeleteButton]);\n\n  const preTableRef = React.useRef<TableRow[]>();\n\n  // 缓存行高变化，由于表格的行高是基于table和controller进行计算，因此只需要在table和controller更新时判断是否需要更新缓存即可\n  // 由于行高信息取决于table-row节点的data属性和table-cell节点的data属性，因此只需要判断当前table.nodes跟上次的table.nodes是否相同即可\n  React.useLayoutEffect(() => {\n    if (!isSelected && !isHoverCornerToolbar) return;\n    fastdom.measure(() => {\n      if (!equal(preTableRef.current, table.nodes)) {\n        preTableRef.current = table.nodes;\n        rowsRect.current = getAllRowsDomRect(controller, { node: table });\n      }\n    });\n  }, [controller, table, table.nodes, isSelected, isHoverCornerToolbar]);\n\n  const colsWidthRef = React.useRef<number[] | undefined>(table.data.colsWidth);\n  const scaleRef = React.useRef<number>(scale);\n  // scale 变化的时候也需要重新计算行高信息\n  React.useLayoutEffect(() => {\n    if (!isSelected) return;\n\n    fastdom.measure(() => {\n      if (\n        scaleRef.current !== scale\n        || (!equal(colsWidth, colsWidthRef.current))\n      ) {\n        rowsRect.current = getAllRowsDomRect(controller, { node: table });\n        scaleRef.current = scale;\n        colsWidthRef.current = colsWidth;\n      }\n    });\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [scale, colsWidth, isSelected]);\n\n  useLayoutEffect(() => {\n    if (!isSelected) return;\n\n    fastdom.measure(() => {\n      updateToolbarStyle();\n      updateDeleteButtonStyle();\n    });\n  }, [updateDeleteButtonStyle, updateToolbarStyle, isSelected]);\n\n  useEffect(() => {\n    document.addEventListener('mousemove', handleMouseMove);\n\n    return () => {\n      document.removeEventListener('mousemove', handleMouseMove);\n    };\n  }, [handleMouseMove]);\n\n  // componentWillUnmount\n  useEffect(() => {\n    return () => {\n      document.removeEventListener('mousemove', handleRowResizing);\n      document.removeEventListener('mouseup', handleRowResizeEnd);\n      removeMultiSelectListener();\n      removeDragEventListener();\n      detachObserver(); // 移除监听\n    };\n  }, []);\n\n  useEffect(() => {\n    if (contextMenuVisible) {\n      document.addEventListener('mousedown', hideContextMenu);\n      return () => {\n        document.removeEventListener('mousedown', hideContextMenu);\n      };\n    }\n    return undefined;\n  }, [contextMenuVisible, hideContextMenu]);\n\n  const onHotsNextFrame = React.useCallback(\n    (hots: Hot[]) => {\n      // PERF: 非当前表格热区不处理\n      if (\n        hots.some(\n          (hot) => table.key === hot.node.key || table.hasNode(hot.node.key),\n        )\n      ) {\n        rowsRect.current = getAllRowsDomRect(controller, { node: table });\n      }\n    },\n    [controller, table],\n  );\n\n  useHotsAtTheStartOfNextFrame(controller, onHotsNextFrame);\n\n  const tableWidth = colsWidth.reduce((sum, width) => sum + width, 0);\n  // 表格全选按钮和insertBtn不能并存\n  const isShowInsertButton = !isDragging && positionOfInsertButton !== -1 && canInsertBtnShow;\n  const isRowInlineToolbarShow = Boolean(isShowButton() && isShowInsertButton);\n  if (!isRowInlineToolbarShow) {\n    showIndicatorVisible(false);\n  }\n\n  const style = {\n    display: isSelected ? 'block' : 'none',\n    paddingTop: isSticky ? rowsHeight[0] + 1 : 0,\n  };\n\n  return (\n    <RowToolbarWrapper\n      style={style}\n      role=\"toolbar\"\n      data-testid=\"table-row-toolbar\"\n      scale={scale}\n      ref={rowToolbarRef}\n      onMouseOut={handleMouseOut}\n    >\n      {renderRowToolbarItems}\n      <RowResizer ref={rowResizerRef} />\n      {ReactDOM.createPortal(\n        <RowInlineToolbar\n          isShow={isShowDelete()}\n          ref={deleteButtonRef}\n          data-testid=\"table-row-inline-toolbar\"\n        >\n          <InlineToolbarDeleteButton\n            scale={scale}\n            mode=\"row\"\n            locale={locale}\n            onDelete={deleteRow}\n            onHighlightSelection={highlightSelection}\n            onCancelHighlightSelection={cancelHighlightSelection}\n          />\n        </RowInlineToolbar>,\n        zoomContainer,\n      )}\n      <RowInlineToolbar\n        ref={insertButtonRef}\n        data-testid=\"table-row-inline-toolbar-insert\"\n        isShow={isRowInlineToolbarShow}\n        onMouseMove={handlePreventDefault}\n      >\n        <InlineToolbarInsertButton\n          locale={locale}\n          table={table}\n          rowIndicatorRef={rowIndicatorRef}\n          selection={selection}\n          mode=\"row\"\n          tableRef={tableRef}\n          scale={scale}\n          onInsert={insertRow}\n          zoomContainer={zoomContainer}\n          insertIndex={positionOfInsertButton}\n          onShowIndicatorVisible={showIndicatorVisible}\n        />\n      </RowInlineToolbar>\n      {zoomContainer && ReactDOM.createPortal(\n        <DragElement\n          ref={dragElementRef}\n          visible={isDragging}\n          height={draggingRowHeight}\n          width={tableWidth + TOOLBAR_ITEM_SIZE}\n        />,\n        zoomContainer,\n      )}\n    </RowToolbarWrapper>\n  );\n};\n\nexport default createToolbarWithTableSeletion(TableRowToolbar);\n"],"file":"index.js"}