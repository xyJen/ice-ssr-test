{"version":3,"sources":["../../../src/bi/createContextMenu.ts"],"names":["isTable","isTableCell","mergeTableCells","splitTableCell","insertTableRowBySelections","insertTableCol","deleteTableCols","deleteTableRows","deleteTable","createTableSelectionForFocusedCell","isKeyInCell","getDataTableSelectionByTable","Table","isCutAllowed","controller","value","document","selection","isExpanded","anchor","focus","hasTableSelection","query","isAnchorInCell","key","isFocusInCell","anchorCell","getClosest","focusCell","isCopyAllowed","createContextMenu","contextMenuPlugin","pluginConfig","locale","contextMenu","next","menus","focusBlock","table","type","data","sr","queryTbSelection","isSelectionSupportMerge","visible","node","isSelectionSupportSplit","colsWidth","endColIndex","nodes","length","targetColIndex","rightColWidth","leftColWidth","startColIndex","disableInsertRowAbove","startRowIndex","isRowHeader","disableInsertColLeft","isColumnHeader","push","name","contextMenuMerge","action","options","disable","group","mobile","contextMenuSplit","contextMenuInsertAbove","contextMenuInsertBelow","contextMenuInsertLeft","contextMenuInsertRight","contextMenuDeleteRow","contextMenuDeleteCol","contextMenuDeleteTable","others","map","contextMenuItem","concat"],"mappings":"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","sourcesContent":["import {\n  Controller,\n  ContextMenuItem,\n} from '@ali/4ever-cangjie';\n\nimport { isTable, isTableCell } from './types';\nimport {\n  mergeTableCells,\n  splitTableCell,\n  insertTableRowBySelections,\n  insertTableCol,\n  deleteTableCols,\n  deleteTableRows,\n  deleteTable,\n} from './actions';\nimport createTableSelectionForFocusedCell from './utils/createTableSelectionForFocusedCell';\nimport { isKeyInCell } from './queries/canInsertTable';\nimport getDataTableSelectionByTable from './utils/getDataTableSelectionByTable';\nimport Table from '../mo/models';\n\nfunction isCutAllowed(controller: Controller) {\n  const { document, selection } = controller.value;\n  const { isExpanded, anchor, focus } = selection;\n  // 选区中全部是单元格, 允许剪切\n  const hasTableSelection = controller.query('hasTableSelection');\n  if (hasTableSelection) return true;\n  const isAnchorInCell = isKeyInCell(document, anchor.key);\n  const isFocusInCell = isKeyInCell(document, focus.key);\n  if (isAnchorInCell || isFocusInCell) {\n    const anchorCell = document.getClosest(anchor.key, isTableCell);\n    const focusCell = document.getClosest(focus.key, isTableCell);\n    // 选中同一个单元格内的内容时， 允许剪切\n    return isExpanded && anchorCell?.key === focusCell?.key;\n  }\n  return true;\n}\n\nfunction isCopyAllowed(controller: Controller) {\n  return controller.query('hasTableSelection');\n}\n\nexport default function createContextMenu() {\n  return function contextMenuPlugin(pluginConfig) {\n    const { locale = {} } = pluginConfig;\n    return function contextMenu(\n      controller: Controller,\n      next: () => ContextMenuItem[] | null,\n    ) {\n      const menus: ContextMenuItem[] = [];\n      const { value } = controller;\n      const { document, focusBlock } = value;\n      const table = focusBlock?.key && (focusBlock?.type === 'table' ? focusBlock : document.getClosest(focusBlock.key, isTable)) as Table;\n      if (table && !table.data.sr) {\n        const queryTbSelection = getDataTableSelectionByTable(controller, table);\n        const isSelectionSupportMerge = controller.query('isSelectionSupportMerge', { visible: true, node: table });\n        const isSelectionSupportSplit = controller.query('isSelectionSupportSplit', { visible: true, node: table });\n\n        const selection = queryTbSelection || createTableSelectionForFocusedCell(value, table);\n        if (selection && table.data?.colsWidth) {\n          const endColIndex: number = selection\n            ? selection.endColIndex\n            : table!.nodes[0].nodes.length - 1;\n          const targetColIndex = endColIndex + 1;\n          const rightColWidth = table.data.colsWidth[endColIndex];\n          const leftColWidth = table.data.colsWidth[selection.startColIndex];\n\n          const disableInsertRowAbove = selection.startRowIndex === 0 && Table.isRowHeader(table);\n          const disableInsertColLeft = selection.startColIndex === 0 && Table.isColumnHeader(table);\n\n          menus.push({\n            name: locale.contextMenuMerge,\n            action: mergeTableCells(table),\n            key: 'merge-cells',\n            options: {\n              disable: !isSelectionSupportMerge,\n              group: 3,\n              mobile: false,\n            },\n          }, {\n            name: locale.contextMenuSplit,\n            action: splitTableCell(table),\n            key: 'split-cell',\n            options: {\n              disable: !isSelectionSupportSplit,\n              group: 3,\n              mobile: false,\n            },\n          }, {\n            name: locale.contextMenuInsertAbove,\n            action: insertTableRowBySelections(table, 'insert-row-above'),\n            key: 'insert-row-above',\n            options: {\n              disable: disableInsertRowAbove,\n              group: 4,\n              mobile: false,\n            },\n          }, {\n            name: locale.contextMenuInsertBelow,\n            action: insertTableRowBySelections(table, 'insert-row-below'),\n            key: 'insert-row-below',\n            options: {\n              group: 4,\n              mobile: false,\n            },\n          }, {\n            name: locale.contextMenuInsertLeft,\n            action: insertTableCol(\n              table,\n              selection.startColIndex,\n              selection.startColIndex,\n              leftColWidth,\n            ),\n            key: 'insert-col-left',\n            options: {\n              disable: disableInsertColLeft,\n              group: 4,\n              mobile: false,\n            },\n          }, {\n            name: locale.contextMenuInsertRight,\n            action: insertTableCol(table, targetColIndex, endColIndex, rightColWidth),\n            key: 'insert-col-right',\n            options: {\n              group: 4,\n              mobile: false,\n            },\n          }, {\n            name: locale.contextMenuDeleteRow,\n            action: deleteTableRows(table),\n            key: 'delete-rows',\n            options: {\n              group: 5,\n              mobile: false,\n            },\n          }, {\n            name: locale.contextMenuDeleteCol,\n            action: deleteTableCols(table),\n            key: 'delete-cols',\n            options: {\n              group: 5,\n              mobile: false,\n            },\n          }, {\n            name: locale.contextMenuDeleteTable,\n            action: deleteTable(table),\n            key: 'delete-table',\n            options: {\n              group: 5,\n              mobile: false,\n            },\n          });\n        }\n      }\n      let others = next() || [];\n      others = others.map((contextMenuItem) => {\n        // 选区中包含表格的部分单元格时, 不允许剪切\n        if (contextMenuItem.key === 'cut' && !isCutAllowed(controller) && contextMenuItem.options) {\n          contextMenuItem.options.disable = true;\n        }\n        // 有表格选区时允许复制\n        if (contextMenuItem.key === 'copy' && isCopyAllowed(controller) && contextMenuItem.options) {\n          contextMenuItem.options.disable = false;\n        }\n        return contextMenuItem;\n      });\n      return menus.concat(others);\n    };\n  };\n}\n"],"file":"createContextMenu.js"}