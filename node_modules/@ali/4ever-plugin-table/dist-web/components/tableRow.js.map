{"version":3,"sources":["../../../src/components/tableRow.tsx"],"names":["React","styled","noop","throttle","useZoom","useScrollableContainer","DEFAULT_BORDER_COLOR","MIN_ROW_HEIGHT","STICKY_ROW_TOP_HEIGHT","STICKY_TOOLBAR_INDEX_MAP","TOOLBAR_ITEM_SIZE","usePixelColsWidth","useTableScrollContainerWidth","useTableScrollContainerScrollLeft","useScrollableContainerRect","RowIsStickyContext","useUpdateTableSelectionContext","useTableIsSelected","useRowIsSticky","useRowsClientHeight","useTableScrollContainer","useResizeObserver","shouldRowSticky","BORDER_BOTTOM_WIDTH","STICKY_MARGIN_LEFT","TR","tr","stickyRow","TableRow","attributes","node","children","controller","parent","readOnly","rowDOMRef","useRef","height","data","h","scrollContainer","useState","top","setTop","useReducer","c","forceUpdate","renderHeightRef","prevRelativeLeftRef","clientHeight","setClientHeight","isTableSelected","zoom","colsWidth","scrollContainerWidth","tableScrollLeft","isRowSticky","setIsSticky","forceUpdateTableSelection","updateRowClientHeight","scrollRect","setScrollableContainerRect","tableScrollContainer","shouldSticky","useMemo","HTMLElement","isSticky","topOffset","useEffect","shouldObserve","updateRowRenderHeight","useCallback","rect","stickyHeight","actualHeight","current","key","prevZoomRef","getBoundingClientRect","setTablePaddingTop","paddingTop","tableDOM","parentElement","style","useLayoutEffect","rowPosition","position","toolbarSpace","gridTemplateColumns","nodes","forEach","n","i","colSpan","hidden","push","colWidth","slice","reduce","acc","w","minHeight","display","gridAutoFlow","map","join","width","overflowX","left","Number","isFinite","scrollLeft","updateIsSticky","tableScrollRect","containerRect","tableRect","rowRect","scrollHeight","bottom","topSpace","relativeLeft","r","handleScroll","addEventListener","window","removeEventListener","stickyContext"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport styled from 'styled-components';\nimport { noop, throttle } from 'lodash-es';\nimport { Block, RenderNodeProps, useZoom, useScrollableContainer } from '@ali/4ever-cangjie';\nimport Table from '../mo/models';\nimport MoTableRow from '../mo/models/tableRow';\nimport {\n  DEFAULT_BORDER_COLOR,\n  MIN_ROW_HEIGHT,\n  STICKY_ROW_TOP_HEIGHT,\n  STICKY_TOOLBAR_INDEX_MAP,\n  TOOLBAR_ITEM_SIZE,\n} from '../utils/constants';\nimport {\n  usePixelColsWidth,\n  useTableScrollContainerWidth,\n  useTableScrollContainerScrollLeft,\n  useScrollableContainerRect,\n  RowIsStickyContext,\n  useUpdateTableSelectionContext,\n  useTableIsSelected,\n  useRowIsSticky,\n  useRowsClientHeight,\n  useTableScrollContainer,\n} from '../utils/hooks';\nimport useResizeObserver from '../utils/utils/useResizeObserver';\nimport shouldRowSticky from '../utils/utils/shouldRowSticky';\n\nconst BORDER_BOTTOM_WIDTH = 1;\nconst STICKY_MARGIN_LEFT = -1;\n\nconst TR = styled.tr`\n  &[data-sticky=\"true\"] {\n    border-bottom: ${BORDER_BOTTOM_WIDTH}px solid ${DEFAULT_BORDER_COLOR};\n    margin-left: ${STICKY_MARGIN_LEFT}px;\n    z-index: ${STICKY_TOOLBAR_INDEX_MAP.stickyRow}; // 高于 selection\n    background: white;\n    box-shadow: rgb(17 31 44 / 10%) 0px 6px 4px -4px;\n    overscroll-behavior-x: none;\n\n    td {\n      border-width: 1px 0 0 1px;\n      margin-right: -1px;\n\n      &:last-of-type {\n        border-right: 1px solid ${DEFAULT_BORDER_COLOR};\n      }\n    }\n  }\n`;\n\nexport type TableRowProps = RenderNodeProps<Block>;\n\nconst TableRow: React.FC<TableRowProps> = ({\n  attributes,\n  node,\n  children,\n  controller,\n  parent,\n}) => {\n  const { readOnly } = controller;\n  const rowDOMRef = React.useRef<HTMLTableRowElement | null>(null);\n  const height = (node.data.h as number) || MIN_ROW_HEIGHT;\n  const scrollContainer = useScrollableContainer();\n  const [top, setTop] = React.useState(0);\n  const [, forceUpdate] = React.useReducer((c) => c + 1, 0);\n  const renderHeightRef = React.useRef(0);\n  const prevRelativeLeftRef = React.useRef(0);\n  const [clientHeight, setClientHeight] = React.useState(0);\n\n  const isTableSelected = useTableIsSelected();\n  const zoom = useZoom();\n  const [colsWidth] = usePixelColsWidth() || [];\n  const scrollContainerWidth = useTableScrollContainerWidth();\n  const tableScrollLeft = useTableScrollContainerScrollLeft();\n  const [isRowSticky, setIsSticky] = useRowIsSticky();\n  const [, forceUpdateTableSelection] = useUpdateTableSelectionContext();\n  const [, updateRowClientHeight] = useRowsClientHeight();\n  const [\n    scrollRect,\n    setScrollableContainerRect,\n  ] = useScrollableContainerRect();\n  const tableScrollContainer = useTableScrollContainer();\n\n  const shouldSticky = React.useMemo(() => {\n    return shouldRowSticky(node as MoTableRow, parent as Table)\n      && (scrollContainer instanceof HTMLElement);\n  }, [node, scrollContainer, parent]);\n\n  const isSticky = shouldSticky && isRowSticky;\n\n  const topOffset = isTableSelected ? STICKY_ROW_TOP_HEIGHT : 0;\n\n  React.useEffect(() => {\n    setTop(scrollRect.top + topOffset);\n  }, [scrollRect.top, topOffset]);\n\n  const shouldObserve = !readOnly || shouldSticky;\n  const updateRowRenderHeight = React.useCallback((rect: DOMRect) => {\n    // table display: none 时高度为 0\n    if (rect.height === 0) return;\n\n    const stickyHeight = rect.height - BORDER_BOTTOM_WIDTH;\n    const actualHeight = isSticky ? stickyHeight : rect.height;\n    if (renderHeightRef.current !== actualHeight) {\n      renderHeightRef.current = actualHeight;\n      updateRowClientHeight(node.key, actualHeight);\n      setClientHeight(actualHeight);\n    }\n  }, [node, updateRowClientHeight, isSticky]);\n  useResizeObserver(shouldObserve ? rowDOMRef.current : null, updateRowRenderHeight);\n\n  const prevZoomRef = React.useRef(zoom);\n  // 触发缩放 resizeObserver 无法监听到变化\n  React.useEffect(() => {\n    if (!rowDOMRef.current || prevZoomRef.current === zoom) return;\n\n    prevZoomRef.current = zoom;\n    const rect = rowDOMRef.current.getBoundingClientRect();\n    updateRowRenderHeight(rect);\n  }, [zoom, updateRowRenderHeight]);\n\n  const setTablePaddingTop = React.useCallback((paddingTop: string) => {\n    const tableDOM = rowDOMRef.current?.parentElement?.parentElement;\n    if (!tableDOM?.parentElement) return;\n\n    // NOTE: 不能设置 marginTop，会导致文档意外滚动\n    tableDOM.parentElement.style.paddingTop = paddingTop;\n  }, []);\n\n  // 组件销毁重置状态\n  React.useEffect(() => {\n    return () => {\n      updateRowClientHeight(node.key, null);\n      setIsSticky(false);\n      setTablePaddingTop('0px');\n    };\n  }, []);\n\n  React.useLayoutEffect(() => {\n    if (!rowDOMRef.current || !shouldSticky) return;\n\n    // IMPORTANT: 需要同时对首行设置 fixed 和对 table 父节点设置 paddingTop\n    // 通过 DOM 操作来保障同时生效，避免文档跳动\n    const rowPosition = isSticky ? 'fixed' : '';\n    rowDOMRef.current.style.position = rowPosition;\n\n    const toolbarSpace = readOnly ? 0 : TOOLBAR_ITEM_SIZE;\n    const paddingTop = isSticky ? `${clientHeight + toolbarSpace}px` : '0px';\n    setTablePaddingTop(paddingTop);\n  }, [isSticky, clientHeight, setTablePaddingTop, shouldSticky, readOnly]);\n\n  const style: React.CSSProperties = React.useMemo(() => {\n    if (!isSticky) {\n      return {\n        height,\n      };\n    }\n\n    const gridTemplateColumns: number[] = [];\n    (node as MoTableRow).nodes.forEach((n, i) => {\n      const { colSpan = 1, hidden } = n.data || {};\n      if (hidden) return;\n\n      if (colSpan === 1) {\n        gridTemplateColumns.push(colsWidth[i]);\n      } else {\n        const colWidth = colsWidth\n          .slice(i, i + colSpan)\n          .reduce((acc, w) => acc + w, 0);\n        gridTemplateColumns.push(colWidth);\n      }\n    });\n\n    return {\n      minHeight: height,\n      top,\n      // 通过 grid 模拟 table 布局\n      display: 'grid',\n      gridAutoFlow: 'column',\n      gridTemplateColumns: gridTemplateColumns.map((c) => `${c}px`).join(' '),\n      width: scrollContainerWidth,\n      overflowX: 'hidden',\n      left:\n        Number.isFinite(scrollRect.left)\n          ? scrollRect.left! - STICKY_MARGIN_LEFT\n          : 'unset',\n    };\n  }, [\n    colsWidth,\n    height,\n    isSticky,\n    node,\n    scrollContainerWidth,\n    top,\n    scrollRect.left,\n  ]);\n\n  React.useLayoutEffect(() => {\n    if (isSticky && rowDOMRef.current) {\n      rowDOMRef.current.scrollLeft = tableScrollLeft;\n    }\n  }, [tableScrollLeft, isSticky]);\n\n  React.useLayoutEffect(() => {\n    forceUpdateTableSelection();\n  }, [isSticky, forceUpdateTableSelection]);\n\n  const updateIsSticky = React.useCallback(() => {\n    const tableDOM = rowDOMRef.current?.parentElement?.parentElement;\n    if (!tableDOM || !tableScrollContainer) return;\n\n    const tableScrollRect = tableScrollContainer.getBoundingClientRect();\n    const containerRect = (scrollContainer as HTMLElement).getBoundingClientRect();\n    const tableRect = tableDOM.getBoundingClientRect();\n    // height 为 0 说明是 display none 状态\n    if (!rowDOMRef.current || tableRect.height === 0) {\n      setIsSticky(false);\n      return;\n    }\n\n    const rowRect = rowDOMRef.current.getBoundingClientRect();\n    const { height: scrollHeight } = (scrollContainer as HTMLElement).getBoundingClientRect();\n\n    if (\n      isSticky === false\n      && (\n        rowRect.height > tableRect.height / 2\n        || rowRect.height > scrollHeight / 3\n      )\n    ) {\n      return;\n    }\n\n    if (tableRect.bottom < containerRect.top + rowRect.height + topOffset) {\n      setIsSticky(false);\n      return;\n    }\n\n    const topSpace = isSticky ? rowRect.height : 0;\n    if (tableRect.top - topSpace - topOffset > containerRect.top) {\n      setIsSticky(false);\n      return;\n    }\n\n    const relativeLeft = tableScrollRect.left - rowRect.left;\n    if (\n      prevRelativeLeftRef.current !== relativeLeft\n    ) {\n      prevRelativeLeftRef.current = relativeLeft;\n      setScrollableContainerRect((r) => ({\n        ...r,\n        left: tableScrollRect.left,\n      }));\n    }\n\n    setIsSticky(true);\n    forceUpdateTableSelection();\n  }, [forceUpdateTableSelection, isSticky, scrollContainer, setIsSticky, topOffset, tableScrollLeft, tableScrollContainer]);\n\n  React.useEffect(() => {\n    if (!shouldSticky) return () => {};\n\n    // NOTE: 不要设置 delay，可能会导致异常\n    const handleScroll = throttle(() => {\n      updateIsSticky();\n    });\n\n    scrollContainer!.addEventListener('scroll', handleScroll);\n    window.addEventListener('resize', handleScroll);\n\n    return () => {\n      scrollContainer!.removeEventListener('scroll', handleScroll);\n      window.removeEventListener('resize', handleScroll);\n    };\n  }, [updateIsSticky, scrollContainer, shouldSticky]);\n\n  const stickyContext: [boolean, Function] = React.useMemo(() => {\n    return [shouldSticky && isSticky, noop];\n  }, [shouldSticky, isSticky]);\n\n  return (\n    <TR\n      {...attributes}\n      ref={(n) => {\n        if (n) {\n          if (!rowDOMRef.current) forceUpdate();\n          rowDOMRef.current = n;\n        }\n      }}\n      style={style}\n      data-sticky={isSticky}\n    >\n      <RowIsStickyContext.Provider value={stickyContext}>\n        {children()}\n      </RowIsStickyContext.Provider>\n    </TR>\n  );\n};\n\nexport default TableRow;\n"],"file":"tableRow.js"}