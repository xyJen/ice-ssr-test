{"version":3,"sources":["../../../../src/zhi/components/table.tsx"],"names":["React","ResizeObserver","MoTable","constants","PixelColsWidthContext","adjustColsWidth","TableContextContainer","TableScrollContainer","PureTable","DEFAULT_TOTAL_WIDTH_FOR_AUTOFIT","CommonTable","forwardRef","props","node","children","attributes","config","controller","isMobile","rest","wrapperRef","useRef","ref","wrapperWidthRef","observerRef","useState","pixelColsWidth","setPixelColsWidth","pixelColsWidthValue","useMemo","useEffect","current","containerWidth","undefined","run","isAutofit","isAutofitWidth","list","contentRect","width","wrapperNode","observe","unobserve","disconnect","scrollContainerRef","configOnScroll","onScroll","useCallback","data","percentOfScrollLeft","frameId","window","requestAnimationFrame","scrollContainer","offsetWidth","tableWidth","totalScroll","scrollTo","left","behavior","cancelAnimationFrame","forceRenderPercentColWidthForAutoFit","PCTable","enableHeaderSticky","Table"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport ResizeObserver from 'resize-observer-polyfill';\nimport { Controller, RenderNodeProps } from '@ali/4ever-cangjie';\nimport MoTable from '../../mo/models';\nimport { TableConfig } from '../types';\nimport constants from '../../utils/constants';\nimport { PixelColsWidthContext } from '../../utils/hooks';\nimport { adjustColsWidth } from '../../utils/actions';\nimport TableContextContainer from '../../components/tableContextContainer';\nimport TableScrollContainer from '../../components/tableScrollContainer';\nimport PureTable from '../../components/pureTable';\n\nconst { DEFAULT_TOTAL_WIDTH_FOR_AUTOFIT } = constants;\n\ntype TableProps = Omit<RenderNodeProps<MoTable>, 'attributes'> & {\n  controller: Controller;\n  attributes?: { [key: string]: string };\n  isMobile?: boolean;\n  config?: TableConfig;\n  ref?: React.RefObject<HTMLTableElement>;\n};\n\nconst CommonTable = React.forwardRef<HTMLTableElement, TableProps>(\n  (props, forwardRef) => {\n    const { node, children, attributes = {}, config = {}, controller, isMobile, ...rest } = props;\n    const wrapperRef = React.useRef<HTMLDivElement>(null);\n    const ref = React.useRef<HTMLTableElement>(null);\n    const wrapperWidthRef = React.useRef(0);\n    const observerRef = React.useRef<ResizeObserver>();\n\n    const [pixelColsWidth, setPixelColsWidth] = React.useState<number[]>([]);\n\n    const pixelColsWidthValue: [number[], Function] = React.useMemo(() => {\n      return [pixelColsWidth, setPixelColsWidth];\n    }, [pixelColsWidth]);\n\n    React.useEffect(() => {\n      if (typeof forwardRef === 'function') {\n        forwardRef(ref.current);\n      } else if (forwardRef) {\n        forwardRef.current = ref.current;\n      }\n    }, [ref, forwardRef]);\n\n    React.useEffect(() => {\n      const containerWidth = isMobile ? DEFAULT_TOTAL_WIDTH_FOR_AUTOFIT : undefined;\n      controller.run('onAction', adjustColsWidth(node, containerWidth));\n    });\n\n    const isAutofit = MoTable.isAutofitWidth(node);\n\n    React.useEffect(() => {\n      if (\n        isMobile\n        || !isAutofit\n        || !wrapperRef.current\n      ) return () => {};\n\n      observerRef.current = new ResizeObserver((list: ResizeObserverEntry[]) => {\n        const { contentRect } = list[0];\n        // table 开启 prune display: none 时，宽度是 0\n        if (\n          contentRect.width === 0\n          || contentRect.width === wrapperWidthRef.current\n        ) return;\n\n        wrapperWidthRef.current = contentRect.width;\n        controller.run('onAction', adjustColsWidth(node));\n      });\n\n      const wrapperNode = wrapperRef.current;\n      observerRef.current.observe(wrapperNode);\n\n      return () => {\n        if (wrapperNode) {\n          observerRef.current?.unobserve(wrapperNode);\n        }\n      };\n    }, [node, isMobile, controller, isAutofit]);\n\n    React.useEffect(() => {\n      return () => {\n        if (observerRef.current) {\n          observerRef.current.disconnect();\n        }\n      };\n    }, []);\n\n    const scrollContainerRef = React.useRef<HTMLDivElement>(null);\n    const { onScroll: configOnScroll } = config;\n\n    const onScroll = React.useCallback(() => {\n      if (configOnScroll && scrollContainerRef.current) {\n        configOnScroll(scrollContainerRef.current, node);\n      }\n    }, [node, configOnScroll]);\n\n    const { percentOfScrollLeft } = node.data || {};\n    React.useEffect(() => {\n      const frameId = window.requestAnimationFrame(() => {\n        const scrollContainer = scrollContainerRef.current;\n        if (!scrollContainer || !ref.current) {\n          return;\n        }\n        if (typeof percentOfScrollLeft === 'number') {\n          const containerWidth = scrollContainer.offsetWidth;\n          const tableWidth = ref.current.offsetWidth;\n          const totalScroll = tableWidth - containerWidth;\n          scrollContainer.scrollTo({\n            left: percentOfScrollLeft * totalScroll,\n            behavior: 'smooth',\n          });\n        }\n      });\n      return () => {\n        window.cancelAnimationFrame(frameId);\n      };\n    }, [percentOfScrollLeft]);\n\n    return (\n      <PixelColsWidthContext.Provider value={pixelColsWidthValue}>\n        <TableScrollContainer\n          {...rest}\n          controller={controller}\n          onScroll={onScroll}\n          table={node}\n          ref={scrollContainerRef}\n          isMobile={isMobile}\n        >\n          <div {...attributes} ref={wrapperRef}>\n            <PureTable\n              ref={forwardRef}\n              node={node}\n              controller={controller}\n              isMobile={isMobile}\n              readonly\n              forceRenderPercentColWidthForAutoFit={config.forceRenderPercentColWidthForAutoFit?.()}\n            >\n              {children()}\n            </PureTable>\n          </div>\n        </TableScrollContainer>\n      </PixelColsWidthContext.Provider>\n    );\n  },\n);\n\nconst PCTable = (props: TableProps) => {\n  const { controller, node, config = {} } = props;\n  const { enableHeaderSticky } = config;\n\n  return (\n    <TableContextContainer\n      controller={controller}\n      table={node}\n      enableHeaderSticky={enableHeaderSticky}\n    >\n      <CommonTable {...props} />\n    </TableContextContainer>\n  );\n};\n\nconst Table = (props: TableProps) => {\n  const { isMobile } = props;\n  if (isMobile) {\n    return <CommonTable {...props} />;\n  }\n\n  return <PCTable {...props} />;\n};\n\nexport default Table;\n"],"file":"table.js"}