{"version":3,"file":"index.js","sources":["../../src/constant.ts","../../src/createHiddenTextarea.ts","../../src/select.ts","../../src/utils/writeFileToClipboard.ts","../../src/manager.ts"],"sourcesContent":["export const IS_IOS = typeof navigator !== 'undefined'\n  && typeof window !== 'undefined'\n  && /iPad|iPhone|iPod/.test(navigator.userAgent)\n  // eslint-disable-next-line @typescript-eslint/ban-ts-ignore\n  // @ts-ignore\n  && !window.MSStream;\n\nexport const IS_BROWSER = typeof window !== 'undefined'\n  && typeof window.document !== 'undefined'\n  && typeof window.document.createElement !== 'undefined';\n\nexport const IS_SAFARI = typeof navigator !== 'undefined'\n  && navigator.vendor === 'Apple Computer, Inc.';\n\nexport const MIME_TYPES = {\n  HTML: 'text/html',\n  TEXT: 'text/plain',\n};\n\n// match \\s string.\nexport const NONEMPTY_REG = /^\\s+$/;\n","import { IS_IOS } from './constant';\nimport { HiddenTextarea } from './types';\n\nexport default function createHiddenTextarea(): HiddenTextarea {\n  const isRTL = document.documentElement.getAttribute('dir') === 'rtl';\n  const fakeElem = document.createElement(IS_IOS ? 'div' : 'textarea');\n  if (IS_IOS) {\n    fakeElem.setAttribute('style', '-webkit-user-select: text !important');\n  }\n  // Prevent zooming on iOS\n  fakeElem.style.fontSize = '12pt';\n  // Reset box model\n  fakeElem.style.border = '0';\n  fakeElem.style.padding = '0';\n  fakeElem.style.margin = '0';\n  // Move element out of screen horizontally\n  fakeElem.style.position = 'absolute';\n  fakeElem.style[isRTL ? 'right' : 'left'] = '-9999px';\n  // Move element to the same position vertically\n  const yPosition = window.pageYOffset || document.documentElement.scrollTop;\n  fakeElem.style.top = `${yPosition}px`;\n  return fakeElem;\n}\n","import { IS_IOS } from './constant';\n\ntype SelectElement = HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement | HTMLDivElement;\n\nexport default function select(element: SelectElement): string {\n  let selectedText;\n\n  if (IS_IOS || element instanceof HTMLDivElement) {\n    /**\n     *  兼容至 ios 10 以上\n     *  https://stackoverflow.com/questions/34045777/copy-to-clipboard-using-javascript-in-ios\n     * */\n    const selection = window.getSelection();\n    const range = document.createRange();\n\n    // There must be html content to trigger copy event.\n    if (!element.innerHTML) {\n      element.innerHTML = '<div>123</div>';\n    }\n\n    range.selectNodeContents(element);\n\n    // eslint-disable-next-line no-unused-expressions\n    selection?.removeAllRanges();\n    // eslint-disable-next-line no-unused-expressions\n    selection?.addRange(range);\n    return '';\n  }\n\n  if (element.nodeName === 'SELECT') {\n    element.focus();\n\n    selectedText = element.value;\n  } else if (element.nodeName === 'INPUT' || element.nodeName === 'TEXTAREA') {\n    const isReadOnly = element.hasAttribute('readonly');\n\n    if (!isReadOnly) {\n      element.setAttribute('readonly', '');\n    }\n\n    if ('select' in element) {\n      element.select();\n    }\n\n    if ('setSelectionRange' in element) {\n      // eslint-disable-next-line no-unused-expressions\n      element?.setSelectionRange(0, element.value.length);\n    }\n\n    if (!isReadOnly) {\n      element.removeAttribute('readonly');\n    }\n\n    selectedText = element.value;\n  } else {\n    if (element.hasAttribute('contenteditable')) {\n      element.focus();\n    }\n\n    const selection = window.getSelection();\n    const range = document.createRange();\n\n    range.selectNodeContents(element);\n    // eslint-disable-next-line no-unused-expressions\n    selection?.removeAllRanges();\n    // eslint-disable-next-line no-unused-expressions\n    selection?.addRange(range);\n\n    selectedText = selection?.toString();\n  }\n\n  return selectedText || '';\n}\n","import { WriteData } from '../types';\nimport { MIME_TYPES, IS_SAFARI, NONEMPTY_REG } from '../constant';\n\nlet canvas: HTMLCanvasElement;\nlet ctx: CanvasRenderingContext2D | null;\n\n/**\n * @description Clear canvas memory.\n */\nfunction clearCanvas(): void {\n  if (canvas) {\n    canvas.width = 0;\n    canvas.height = 0;\n  }\n}\n\n/**\n * @description Only support image type.\n */\nexport function isFileMimeType(mimeType: string): boolean {\n  return /^(image)\\//.test(mimeType);\n}\n\n/**\n * @description Transform media url to blob\n */\nexport function urlToBlob(url: string): Promise<Blob> {\n  return new Promise<Blob>((resolve, reject) => {\n    const img = new Image();\n    img.setAttribute('crossOrigin', 'anonymous');\n    img.onload = () => {\n      if (!canvas || !ctx) {\n        canvas = document.createElement('canvas');\n        ctx = canvas.getContext('2d');\n      }\n      canvas.width = img.naturalWidth;\n      canvas.height = img.naturalHeight;\n      if (ctx) {\n        ctx.drawImage(img, 0, 0);\n        canvas.toBlob((blob) => {\n          if (blob) {\n            resolve(blob);\n          }\n          clearCanvas();\n        }, 'image/png');\n      } else {\n        reject(new Error(\"canvas.getContext('2d') return null\"));\n        clearCanvas();\n      }\n    };\n    img.onerror = (e) => {\n      reject(e);\n      clearCanvas();\n    };\n    img.src = url;\n  });\n}\n\nasync function fileDataToBlob(fileData: string | Blob): Promise<Blob> {\n  if (fileData instanceof Blob) {\n    return Promise.resolve(fileData);\n  }\n  const blob = await urlToBlob(fileData);\n  return blob;\n}\n\n/**\n * @description Support for multiple ClipboardItems is not implemented.\n * @see https://source.chromium.org/chromium/chromium/src/+/master:ui/base/clipboard/scoped_clipboard_writer.cc;l=22?q=~ScopedClipboardWriter\n */\nasync function asyncClipboardDataToBlob(writeData: WriteData): Promise<Record<string, Blob>> {\n  const result: Record<string, Blob> = {};\n  for await (const key of Object.keys(writeData)) {\n    if (isFileMimeType(key)) {\n      // DOMException: Type image/jpeg not supported on write.\n      result['image/png'] = await fileDataToBlob(writeData[key]);\n    } else if ([MIME_TYPES.HTML, MIME_TYPES.TEXT].includes(key)) {\n      result[key] = new Blob([writeData[key]], { type: key });\n    } else {\n      console.warn('Support for multiple ClipboardItems is not implemented.(details: https://source.chromium.org/chromium/chromium/src/+/master:ui/base/clipboard/scoped_clipboard_writer.cc;l=22?q=~ScopedClipboardWriter)');\n    }\n  }\n  return result;\n}\n\n/**\n * @description Compatible with safari.\n * @see https://stackoverflow.com/questions/66312944/javascript-clipboard-api-write-does-not-work-in-safari\n */\nfunction syncClipboardDataToBlob(writeData: WriteData): Record<string, Blob | Promise<Blob>> {\n  const result: Record<string, Blob | Promise<Blob>> = {};\n  for (const key of Object.keys(writeData)) {\n    if (isFileMimeType(key)) {\n      // DOMException: Type image/jpeg not supported on write.\n      result['image/png'] = fileDataToBlob(writeData[key]);\n    } else if ([MIME_TYPES.HTML, MIME_TYPES.TEXT].includes(key)) {\n      result[key] = new Blob([writeData[key]], { type: key });\n    } else {\n      console.warn('Support for multiple ClipboardItems is not implemented.(details: https://source.chromium.org/chromium/chromium/src/+/master:ui/base/clipboard/scoped_clipboard_writer.cc;l=22?q=~ScopedClipboardWriter)');\n    }\n  }\n  return result;\n}\n\nexport const isInValidData = (data: string) => !data || NONEMPTY_REG.test(data);\n\nexport function isSupportWriteFile() {\n  const nav = window.navigator as any;\n  // eslint-disable-next-line no-param-reassign\n  const ClipboardItem = window?.ClipboardItem as any;\n  return nav?.clipboard?.write && !ClipboardItem;\n}\n\n/**\n * @param {WriteData} writeData\n * @return {*}  {Promise<any>}\n * @description Write file data(allow blob or url) to clipboard.\n */\nexport async function writeFileToClipboard(writeData: WriteData): Promise<any> {\n  try {\n    const nav = window.navigator as any;\n    // eslint-disable-next-line no-param-reassign\n    const ClipboardItem = window?.ClipboardItem as any;\n    if (!nav?.clipboard?.write || !ClipboardItem) {\n      return Promise.reject(\n        new Error('Your browser does not support navigator.clipboard.write method.'),\n      );\n    }\n    if (IS_SAFARI) {\n      const result = await nav.clipboard.write([\n        new ClipboardItem(syncClipboardDataToBlob(writeData)),\n      ]);\n      return Promise.resolve(result);\n    }\n    const blobData = await asyncClipboardDataToBlob(writeData);\n    const result = await nav.clipboard.write([\n      new ClipboardItem(blobData),\n    ]);\n    return Promise.resolve(result);\n  } catch (err) {\n    return Promise.reject(err);\n  }\n}\n","import { ClipboardEvent } from 'react';\nimport createHiddenTextarea from './createHiddenTextarea';\nimport select from './select';\nimport {\n  ClipboardActionType,\n  IClipboardOptions,\n  ICopyTextResult,\n  WriteData,\n  HiddenTextarea,\n} from './types';\nimport { MIME_TYPES, IS_IOS, IS_BROWSER } from './constant';\nimport {\n  isFileMimeType,\n  isSupportWriteFile,\n  writeFileToClipboard,\n  isInValidData,\n} from './utils/writeFileToClipboard';\n\n/**\n * Cannot run on the server.\n */\nlet _commonManager: ClipboardManager | null = null;\n\n/**\n * Inner class which performs selection from either `text` or `target`\n * properties and then executes copy or cut operations.\n */\nexport default class ClipboardManager {\n  private readonly action: ClipboardActionType = 'copy';\n\n  private fakeElem: HiddenTextarea = createHiddenTextarea();\n\n  private readonly container: HTMLElement = document.body;\n\n  private text = ' ';\n\n  /**\n   * Create a common manager, write data to clipboard directly without new object.\n   */\n  static create = (): ClipboardManager | null => {\n    if (!IS_BROWSER) {\n      return null;\n    }\n    if (!_commonManager) {\n      _commonManager = new ClipboardManager();\n    }\n    return _commonManager;\n  };\n\n  /**\n   * @param {Object} options\n   */\n  constructor(options: IClipboardOptions = {}) {\n    if (options.action) {\n      this.action = options.action;\n    }\n    if (options.container instanceof HTMLElement) {\n      this.container = options.container;\n    }\n    if (options.target) {\n      this.fakeElem = options.target;\n    }\n  }\n\n  /**\n   * Executes the copy operation based on the current selection.\n   */\n  private copyText = (): ICopyTextResult => {\n    let succeeded;\n\n    try {\n      succeeded = window.document.execCommand(this.action);\n    } catch (err) {\n      succeeded = false;\n    }\n\n    const cbResult = {\n      succeeded,\n      action: this.action,\n      text: this.text,\n    };\n    return cbResult;\n  };\n\n  /**\n   * Create action function.\n   */\n  private createOnAction = (data: WriteData): ((e: ClipboardEvent) => void) => {\n    const { action } = this;\n    const onAction = (e: ClipboardEvent): void => {\n      e.preventDefault();\n      const dataEntries = Object.entries(data);\n      dataEntries.forEach((item) => {\n        const [mimeType, content] = item;\n        if (!isFileMimeType(mimeType) && typeof content === 'string') {\n          const text = (\n            isInValidData(content as string) ? ' ' : content\n          ) as string;\n          if (mimeType === MIME_TYPES.TEXT) {\n            this.text = text;\n          }\n          e.clipboardData.setData(mimeType, text);\n        }\n      });\n      // @ts-ignore\n      this.fakeElem.removeEventListener(action, onAction);\n      this.destroy();\n    };\n    return onAction;\n  };\n\n  /**\n   * Creates a fake textarea element, sets its value from `text` property,\n   * and makes a selection on it.\n   */\n  public selectFake = (data: WriteData): void => {\n    if (!(this.fakeElem instanceof HTMLDivElement)) {\n      this.fakeElem.value = (data[MIME_TYPES.TEXT] || '') as string;\n    } else {\n      this.fakeElem.innerHTML = (data[MIME_TYPES.HTML] || '') as string;\n    }\n    this.container.appendChild(this.fakeElem);\n    this.fakeElem.focus();\n    select(this.fakeElem);\n  };\n\n  /**\n   * Async set file data of clipboard.\n   */\n  public writeFile = (\n    data: WriteData,\n    result: ICopyTextResult,\n  ): Promise<ICopyTextResult> => {\n    const { activeElement } = window.document;\n    return new Promise((resolve, reject) => {\n      if (!isSupportWriteFile()) {\n        this.writeDataWithoutFile(data);\n      }\n      const selection = window.getSelection();\n      const range = document.createRange();\n      this.selectFake(data);\n      writeFileToClipboard(data)\n        .then(resolve, (error) => {\n          console.warn(error);\n          return result.succeeded ? resolve(result) : reject(result);\n        })\n        .finally(() => {\n          if (selection) {\n            selection.addRange(range);\n          }\n          this.destroy();\n          if (\n            activeElement instanceof HTMLTextAreaElement\n            || activeElement instanceof HTMLInputElement\n          ) {\n            activeElement.blur();\n            activeElement.focus();\n          }\n        });\n    });\n  };\n\n  /**\n   * Set clipboard data without file.\n   */\n  private writeDataWithoutFile = (data: WriteData): ICopyTextResult => {\n    const onCopy = this.createOnAction(data);\n    if (!IS_IOS) {\n      // TODO copy failed in ios version lower than 13 if prevent default event.\n      // @ts-ignore\n      this.fakeElem.addEventListener(this.action, onCopy);\n    }\n\n    const copyDataByExecCommand = (): ICopyTextResult => {\n      this.selectFake(data);\n      const copyResult = this.copyText();\n      this.destroy();\n      return copyResult;\n    };\n\n    return copyDataByExecCommand();\n  }\n\n  /**\n   * Set clipboard data by mine type.\n   * Support async and sync syntactic sugars.\n   */\n  public write = (\n    data: WriteData,\n    async = true,\n  ): Promise<ICopyTextResult> | ICopyTextResult => {\n    const result = this.writeDataWithoutFile(data);\n    // set media data\n    if (Object.keys(data).some(isFileMimeType)) {\n      return this.writeFile(data, result);\n    }\n\n    if (async) {\n      return new Promise((resolve, reject) => {\n        if (result.succeeded) {\n          return resolve(result);\n        }\n        return reject(result);\n      });\n    }\n    return result;\n  };\n\n  /**\n   * Only set plain text of clipboard.\n   * Support async and sync syntactic sugars.\n   */\n  public writeText = (\n    clipText: string,\n    async = true,\n  ): Promise<ICopyTextResult> | ICopyTextResult => {\n    this.text = clipText;\n    this.selectFake({ [MIME_TYPES.TEXT]: clipText });\n    const result = this.copyText();\n    this.destroy();\n    if (async) {\n      return new Promise((resolve, reject) => {\n        if (result.succeeded) {\n          return resolve(result);\n        }\n        return reject(result);\n      });\n    }\n    return result;\n  };\n\n  /**\n   * Remove fake textarea element.\n   */\n  public destroy = (): void => {\n    this.fakeElem.remove();\n  };\n}\n"],"names":["IS_IOS","navigator","window","test","userAgent","MSStream","IS_BROWSER","document","createElement","IS_SAFARI","vendor","MIME_TYPES","HTML","TEXT","NONEMPTY_REG","createHiddenTextarea","isRTL","documentElement","getAttribute","fakeElem","setAttribute","style","fontSize","border","padding","margin","position","yPosition","pageYOffset","scrollTop","top","select","element","selectedText","HTMLDivElement","selection","getSelection","range","createRange","innerHTML","selectNodeContents","removeAllRanges","addRange","nodeName","focus","value","isReadOnly","hasAttribute","setSelectionRange","length","removeAttribute","toString","canvas","ctx","clearCanvas","width","height","isFileMimeType","mimeType","urlToBlob","url","Promise","resolve","reject","img","Image","onload","getContext","naturalWidth","naturalHeight","drawImage","toBlob","blob","Error","onerror","e","src","fileDataToBlob","fileData","Blob","asyncClipboardDataToBlob","writeData","result","key","Object","keys","includes","type","console","warn","syncClipboardDataToBlob","isInValidData","data","isSupportWriteFile","nav","ClipboardItem","clipboard","write","writeFileToClipboard","blobData","err","_commonManager","ClipboardManager","constructor","options","body","succeeded","execCommand","action","cbResult","text","onAction","preventDefault","dataEntries","entries","forEach","item","content","clipboardData","setData","removeEventListener","destroy","container","appendChild","activeElement","writeDataWithoutFile","selectFake","then","error","finally","HTMLTextAreaElement","HTMLInputElement","blur","onCopy","createOnAction","addEventListener","copyDataByExecCommand","copyResult","copyText","async","some","writeFile","clipText","remove","HTMLElement","target"],"mappings":"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"}