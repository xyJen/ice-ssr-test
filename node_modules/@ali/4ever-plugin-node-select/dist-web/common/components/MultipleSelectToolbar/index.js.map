{"version":3,"sources":["../../../../../src/common/components/MultipleSelectToolbar/index.tsx"],"names":["React","styled","isEqual","DrawerMobile","Commands","MobileIconBack","isSequent","sortNodeKeys","ToolbarItem","NODE_SELECT_CLICKABLE_BOX_CLASS_NAME","NODE_SELECTING_ATTRIBUTE","ToolbarWrapper","div","ToolbarBtnsWrapper","ToolbarDropDownIconWrapper","Drawer","MultipleSelectToolbar","props","controller","manager","toolbarItemsPriority","useState","isVisible","setVisible","layout","setLayout","handleClose","useCallback","selectedNodeKeys","getSelectedNodeKeys","selectedNodes","map","key","value","document","getNode","filter","node","dispatch","type","reason","closeSelect","useEffect","handleHide","timer","handleShow","isExpanded","selection","command","moveToFocus","setTimeout","run","on","off","clearTimeout","handleSelectedNodeChange","sequent","toolbarItems","selectedNodeTypes","sortedLayout","item","priority","sort","item1","item2","item1Priority","item2Priority","oldLayout","handleClick","btn","find","action","keys","sortedNodeKeys","sortedNodes","nodeKey","handleClickOutside","e","target","closest","body","addEventListener","removeEventListener","window","setAttribute","removeAttribute","title","icon","disabled"],"mappings":"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","sourcesContent":["import React from 'react';\n// import ReactDOM from 'react-dom';\nimport styled from 'styled-components';\nimport { isEqual } from 'lodash-es';\nimport { DrawerMobile } from '@ali/we-design-next';\nimport { Commands, Controller, NodeSelectToolbarItem } from '@ali/4ever-cangjie';\nimport { MobileIconBack } from '@ali/4ever-component';\nimport type { SelectManager } from '../../utils/SelectManager';\nimport { isSequent } from '../../utils/isSequent';\nimport { sortNodeKeys } from '../../utils/sortNodeKeys';\nimport { ToolbarItem } from './ToolbarItem';\nimport { NODE_SELECT_CLICKABLE_BOX_CLASS_NAME } from '../constants';\nimport { INodeSelectPluginConfigs } from '../../types';\n\nconst NODE_SELECTING_ATTRIBUTE = 'data-node-selecting';\nexport interface IMultipleSelectToolbarProps {\n  controller: Controller;\n  manager: SelectManager;\n  toolbarItemsPriority?: INodeSelectPluginConfigs['toolbarItemsPriority'];\n}\n\nconst ToolbarWrapper = styled.div`\n  position: relative;\n  margin: 0 auto;\n  width: min-content;\n  background: #ffffff;\n  box-shadow: 0px 0px 1px rgba(126,134,142,0.18), 0px 12px 32px 0px rgba(53, 64, 90, 0.18);\n  border-radius: 8px;\n  padding: 34px 6px 6px 6px;\n  display: flex;\n  flex-direction: row;\n`;\n\nconst ToolbarBtnsWrapper = styled.div`\n  display: flex;\n  flex-direction: row;\n`;\n\nconst ToolbarDropDownIconWrapper = styled.div`\n  position: absolute;\n  left: 50%;\n  transform: translateX(-50%) rotate(-90deg);\n  top: 0px;\n  font-size: 0;\n  padding: 4px;\n`;\n\nconst Drawer = styled(DrawerMobile)`\n  & > div {\n    pointer-events: none;\n  }\n  & .wdn-drawer-mobile-drawer-box {\n    background: transparent;\n    height: auto;\n    box-shadow: unset;\n    border-radius: 0;\n    padding: 0;\n    padding-bottom: 40px;\n  }\n  & .wdn-drawer-mobile-drawer-box > .node-select-clickable-box {\n    pointer-events: auto;\n  }\n`;\n\nexport const MultipleSelectToolbar: React.FC<IMultipleSelectToolbarProps> = (props) => {\n  const { controller, manager, toolbarItemsPriority } = props;\n  const [isVisible, setVisible] = React.useState(false);\n  const [layout, setLayout] = React.useState<NodeSelectToolbarItem[]>([]);\n\n  const handleClose = React.useCallback(() => {\n    const selectedNodeKeys = manager.getSelectedNodeKeys();\n    const selectedNodes = selectedNodeKeys\n      .map((key) => controller.value.document.getNode(key))\n      .filter((node) => !!node);\n    // 清除掉高亮效果\n    controller.dispatch('removeHighlight', {\n      node: selectedNodes,\n      type: 'hover',\n      reason: 'blockSelect',\n    });\n    manager.closeSelect();\n  }, [manager, controller]);\n\n  React.useEffect(() => {\n    const handleHide = () => {\n      setVisible(false);\n    };\n    let timer: any = null;\n    const handleShow = () => {\n      setVisible(true);\n      const { isExpanded } = controller.value.selection;\n      if (isExpanded) {\n        controller.command(Commands.moveToFocus);\n      }\n      timer = setTimeout(() => {\n        controller.run('onCangjieBlur');\n      });\n    };\n\n    manager.on('showSelect', handleShow);\n    manager.on('hideSelect', handleHide);\n    return () => {\n      manager.off('showSelect', handleShow);\n      manager.off('hideSelect', handleHide);\n      timer && clearTimeout(timer);\n      timer = null;\n    };\n  }, [manager, controller]);\n\n  React.useEffect(() => {\n    const handleSelectedNodeChange = (selectedNodeKeys: string[]) => {\n      const sequent = isSequent(selectedNodeKeys, controller);\n      const toolbarItems = controller.run('getNodeSelectToolbarItems', {\n        isSequent: sequent,\n        // TODO\n        selectedNodeTypes: [],\n      }) || [];\n      const sortedLayout = toolbarItems\n        .filter((item) => {\n          return !!item &&\n            (typeof toolbarItemsPriority?.[item.key] === 'number' ? toolbarItemsPriority?.[item.key] > 0 : item.priority > 0);\n        }).sort((item1, item2) => {\n          const item1Priority = typeof toolbarItemsPriority?.[item1.key] === 'number'\n            ? toolbarItemsPriority?.[item1.key]\n            : (item1.priority || 0);\n          const item2Priority = typeof toolbarItemsPriority?.[item2.key] === 'number'\n            ? toolbarItemsPriority?.[item2.key]\n            : (item2.priority || 0);\n          return item1Priority - item2Priority;\n        });\n      setLayout((oldLayout) => {\n        if (!isEqual(oldLayout, sortedLayout)) {\n          return sortedLayout;\n        }\n        return oldLayout;\n      });\n    };\n    manager.on('selectedNodeChange', handleSelectedNodeChange);\n    return () => {\n      manager.off('selectedNodeChange', handleSelectedNodeChange);\n    };\n  }, [controller, manager, toolbarItemsPriority]);\n\n  const handleClick = React.useCallback((key: string) => {\n    const btn = layout.find((item) => item.key === key);\n    if (btn && btn.action) {\n      const keys = manager.getSelectedNodeKeys();\n      // @ts-ignore\n      const sortedNodeKeys = sortNodeKeys(keys, controller.value.document);\n      const sortedNodes = sortedNodeKeys.map((nodeKey) => {\n        return controller.value.document.getNode(nodeKey);\n      }).filter((node) => !!node);\n      controller.dispatch(btn.action, { selectedNodes: sortedNodes });\n    }\n  }, [layout, controller, manager]);\n\n  React.useEffect(() => {\n    const handleClickOutside = (e: MouseEvent) => {\n      const { target } = e;\n      if (!(target as HTMLElement).closest(`.${NODE_SELECT_CLICKABLE_BOX_CLASS_NAME}`)) {\n        handleClose();\n      }\n    };\n    if (isVisible) {\n      document.body.addEventListener('click', handleClickOutside);\n    }\n    return () => {\n      if (isVisible) {\n        document.body.removeEventListener('click', handleClickOutside);\n      }\n    };\n  }, [handleClose, isVisible]);\n\n  React.useEffect(() => {\n    if (isVisible) {\n      window.document.body.setAttribute(NODE_SELECTING_ATTRIBUTE, '');\n    } else {\n      window.document.body.removeAttribute(NODE_SELECTING_ATTRIBUTE);\n    }\n    return () => {\n      window.document.body.removeAttribute(NODE_SELECTING_ATTRIBUTE);\n    };\n  }, [isVisible]);\n\n  return (\n    <Drawer\n      content={\n        <ToolbarWrapper className={NODE_SELECT_CLICKABLE_BOX_CLASS_NAME}>\n          <ToolbarDropDownIconWrapper onClick={handleClose}>\n            <MobileIconBack color=\"rgba(53, 64, 90, 0.48)\" />\n          </ToolbarDropDownIconWrapper>\n          <ToolbarBtnsWrapper>\n            {\n              layout.map((item) => (\n                <ToolbarItem\n                  onClick={() => handleClick(item.key)}\n                  title={item.title}\n                  key={item.key}\n                  icon={item.icon}\n                  disabled={item.disabled}\n                />\n              ))\n            }\n          </ToolbarBtnsWrapper>\n        </ToolbarWrapper>\n      }\n      height={'auto'}\n      visible={isVisible}\n      onClose={handleClose}\n      getContainer={() => document.body}\n    />\n  );\n};\n"],"file":"index.js"}