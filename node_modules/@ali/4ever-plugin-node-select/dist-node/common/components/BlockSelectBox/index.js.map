{"version":3,"sources":["../../../../../src/common/components/BlockSelectBox/index.tsx"],"names":["Box","styled","div","CHECKBOX_SIZE","CHECKBOX_HOT_SIZE","InnerCheckbox","p","isSelected","Checkbox","blockEvent","e","stopPropagation","preventDefault","BlockSelectBox","props","children","node","manager","controller","style","className","key","ref","React","useRef","setSelected","useState","isNodeSelected","selectBox","setSelectBox","isSelecting","swiper","Swiper","current","onPress","v","isExpanded","value","selection","dispatch","type","reason","setNodeSelected","onSwipeEnd","onClick","useEffect","handleShowSelect","on","off","setEnableClick","handleHideSelect","handleClickCheckBox","onRef","useCallback","elem","addEventListener","onTouchStart","handleTouchBox","NODE_SELECT_CLICKABLE_BOX_CLASS_NAME"],"mappings":"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","sourcesContent":["import React from 'react';\nimport styled from 'styled-components';\nimport { Block, Controller } from '@ali/4ever-cangjie';\nimport { MobileIconCheck } from '@ali/4ever-component';\nimport type { SelectManager } from '../../utils/SelectManager';\nimport { Swiper } from './Swiper';\nimport { NODE_SELECT_CLICKABLE_BOX_CLASS_NAME } from '../constants';\n\nconst Box = styled.div`\n  position: relative;\n`;\n\nconst CHECKBOX_SIZE = 20;\nconst CHECKBOX_HOT_SIZE = 4;\n\nconst InnerCheckbox = styled.div<{ isSelected: boolean }>`\n  width: ${CHECKBOX_SIZE}px;\n  height: ${CHECKBOX_SIZE}px;\n  box-sizing: border-box;\n  border-radius: 50%;\n  background: ${(p) => (p.isSelected ? '#0089FF' : '#FFFFFF')};\n  border: ${(p) => (p.isSelected ? '1.5px solid #0089FF' : '1.5px solid rgba(126, 134, 142, 0.24)')};\n  transition: 0.2s background, 0.2s border;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n`;\n\nconst Checkbox = styled.div`\n  position: absolute;\n  right: 0;\n  top: 50%;\n  transform: translate3d(50%, -50%, 0);\n  width: ${CHECKBOX_SIZE + CHECKBOX_HOT_SIZE * 2}px;\n  height: ${CHECKBOX_SIZE + CHECKBOX_HOT_SIZE * 2}px;\n  box-sizing: border-box;\n  border-radius: 50%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 1;\n  .icon, ${InnerCheckbox} {\n    pointer-events: none;\n  }\n`;\n\nfunction blockEvent(e: React.TouchEvent) {\n  e.stopPropagation();\n  e.preventDefault();\n}\n\nexport interface IBlockSelectBoxProps {\n  node: Block;\n  manager: SelectManager;\n  controller: Controller;\n  style?: React.CSSProperties;\n  className?: string;\n}\n\nexport const BlockSelectBox: React.FC<IBlockSelectBoxProps> = (props) => {\n  const { children, node, manager, controller, style, className } = props;\n  const { key } = node;\n  const ref = React.useRef<HTMLDivElement>(null);\n  const [isSelected, setSelected] = React.useState(manager.isNodeSelected(key));\n  const [selectBox, setSelectBox] = React.useState(manager.isSelecting);\n\n  const swiper = React.useRef(new Swiper(() => ref.current, {\n    onPress: () => {\n      setSelected((v) => {\n        const { isExpanded } = controller.value.selection;\n        // 若不在多选状态，长按后选区为 isExpanded 状态，表示触发了右键菜单，状态保持不变\n        if (!manager.isSelecting && isExpanded) {\n          return v;\n        }\n        // 已经在多选状态，长按一定会切换节点的选择状态\n        controller.dispatch(!v ? 'updateHighlight' : 'removeHighlight', {\n          node,\n          type: 'hover',\n          reason: 'blockSelect',\n        });\n        manager.setNodeSelected(node.key, !v);\n        return !v;\n      });\n    },\n    onSwipeEnd: () => {\n      setSelected((v) => {\n        controller.dispatch(!v ? 'updateHighlight' : 'removeHighlight', {\n          node,\n          type: 'hover',\n          reason: 'blockSelect',\n        });\n        manager.setNodeSelected(node.key, !v);\n        return !v;\n      });\n    },\n    onClick: () => {\n      setSelected((v) => {\n        controller.dispatch(!v ? 'updateHighlight' : 'removeHighlight', {\n          node,\n          type: 'hover',\n          reason: 'blockSelect',\n        });\n        manager.setNodeSelected(node.key, !v);\n        return !v;\n      });\n    },\n  }));\n\n  React.useEffect(() => {\n    // 处理渲染多选 checkbox\n    const handleShowSelect = () => {\n      setSelectBox(true);\n    };\n    manager.on('showSelect', handleShowSelect);\n    return () => {\n      manager.off('showSelect', handleShowSelect);\n    };\n  }, [manager]);\n\n  React.useEffect(() => {\n    swiper.current.setEnableClick(selectBox);\n  }, [selectBox]);\n\n  React.useEffect(() => {\n    const handleHideSelect = () => {\n      setSelectBox(false);\n      setSelected(false);\n    };\n    manager.on('hideSelect', handleHideSelect);\n    return () => {\n      manager.off('hideSelect', handleHideSelect);\n    };\n  }, [manager]);\n\n  const handleClickCheckBox = (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setSelected((v) => {\n      controller.dispatch(!v ? 'updateHighlight' : 'removeHighlight', {\n        node,\n        type: 'hover',\n        reason: 'blockSelect',\n      });\n      manager.setNodeSelected(node.key, !v);\n      return !v;\n    });\n  };\n\n  const onRef = React.useCallback((elem: HTMLDivElement) => {\n    // @ts-ignore\n    ref.current = elem;\n    if (elem) {\n      elem.addEventListener('touchstart', swiper.current.onTouchStart);\n    }\n  }, []);\n\n  const handleTouchBox = React.useCallback((e: React.TouchEvent) => {\n    if (selectBox) {\n      e.preventDefault();\n    }\n  }, [selectBox]);\n\n  React.useEffect(() => {\n    return () => {\n      if (manager.isNodeSelected(key)) {\n        manager.setNodeSelected(key, false);\n      }\n    };\n  }, [key, manager]);\n\n  return (\n    <Box\n      ref={onRef}\n      className={`${NODE_SELECT_CLICKABLE_BOX_CLASS_NAME} ${className ?? ''}`}\n      onTouchStart={handleTouchBox}\n      onTouchEnd={handleTouchBox}\n      style={style}\n    >\n      {children}\n      { selectBox && (\n        <Checkbox\n          onClick={handleClickCheckBox}\n          onTouchEnd={blockEvent}\n          className=\"node-select-checkbox\"\n        >\n          <InnerCheckbox className=\"node-select-visible-checkbox\" isSelected={isSelected}>\n            {\n              isSelected && <MobileIconCheck color=\"#ffffff\" />\n            }\n          </InnerCheckbox>\n        </Checkbox>\n      )}\n    </Box>\n  );\n};\n"],"file":"index.js"}