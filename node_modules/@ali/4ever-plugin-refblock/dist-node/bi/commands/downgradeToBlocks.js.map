{"version":3,"sources":["../../../../src/bi/commands/downgradeToBlocks.ts"],"names":["downgradeToBlocks","controller","node","document","value","path","assertPath","key","parentPath","Path","parent","refblockIndex","length","withoutNormalizing","nodes","forEach","child","index","command","Commands","insertNodeByPath","removeNodeByKey","downgradeToBlocksByDocKey","docKey","forEachDescendant","RefBlock","isRefBlock","data","downgradeToBlocksByKey","assertNode"],"mappings":";;;;;;;;;;AAAA;;AACA;;AAEA,SAASA,iBAAT,CAA2BC,UAA3B,EAAmDC,IAAnD,EAAmE;AACjE,QAAM;AAAEC,IAAAA;AAAF,MAAeF,UAAU,CAACG,KAAhC;AACA,QAAMC,IAAI,GAAGF,QAAQ,CAACG,UAAT,CAAoBJ,IAAI,CAACK,GAAzB,CAAb;;AACA,QAAMC,UAAU,GAAGC,kBAAKC,MAAL,CAAYL,IAAZ,CAAnB;;AACA,QAAMM,aAAa,GAAGN,IAAI,CAACA,IAAI,CAACO,MAAL,GAAc,CAAf,CAA1B;AACAX,EAAAA,UAAU,CAACY,kBAAX,CAA8B,MAAM;AAClC;AACAX,IAAAA,IAAI,CAACY,KAAL,CAAWC,OAAX,CAAmB,CAACC,KAAD,EAAQC,KAAR,KAAkB;AACnChB,MAAAA,UAAU,CAACiB,OAAX,CACEC,sBAASC,gBADX,EAEEZ,UAFF,EAGEG,aAAa,GAAGM,KAHlB,EAIED,KAJF;AAMD,KAPD,EAFkC,CAUlC;;AACAf,IAAAA,UAAU,CAACiB,OAAX,CAAmBC,sBAASE,eAA5B,EAA6CnB,IAAI,CAACK,GAAlD;AACD,GAZD;AAaA,SAAON,UAAP;AACD;AAED;AACA;AACA;AACA;AACA;;;AACO,SAASqB,yBAAT,CACLrB,UADK,EAELsB,MAFK,EAGL;AACA,QAAM;AAAEpB,IAAAA;AAAF,MAAeF,UAAU,CAACG,KAAhC;AACAD,EAAAA,QAAQ,CAACqB,iBAAT,CAA4BtB,IAAD,IAAU;AACnC,QAAIuB,gBAASC,UAAT,CAAoBxB,IAApB,KAA6BA,IAAI,CAACyB,IAAL,CAAUJ,MAAV,KAAqBA,MAAtD,EAA8D;AAC5DtB,MAAAA,UAAU,CAACiB,OAAX,CAAmBlB,iBAAnB,EAAsCE,IAAtC;AACD;AACF,GAJD;AAKA,SAAOD,UAAP;AACD;AAED;AACA;AACA;AACA;AACA;;;AACO,SAAS2B,sBAAT,CAAgC3B,UAAhC,EAAwDM,GAAxD,EAAqE;AAC1E,QAAM;AAAEJ,IAAAA;AAAF,MAAeF,UAAU,CAACG,KAAhC;AACA,QAAMF,IAAI,GAAGC,QAAQ,CAAC0B,UAAT,CAAoBtB,GAApB,CAAb;;AACA,MAAIkB,gBAASC,UAAT,CAAoBxB,IAApB,CAAJ,EAA+B;AAC7B,WAAOD,UAAU,CAACiB,OAAX,CAAmBlB,iBAAnB,EAAsCE,IAAtC,CAAP;AACD;;AACD,SAAOD,UAAP;AACD","sourcesContent":["import { Controller, Commands, Path } from '@ali/4ever-cangjie';\nimport RefBlock from '../../mo/models';\n\nfunction downgradeToBlocks(controller: Controller, node: RefBlock) {\n  const { document } = controller.value;\n  const path = document.assertPath(node.key);\n  const parentPath = Path.parent(path);\n  const refblockIndex = path[path.length - 1];\n  controller.withoutNormalizing(() => {\n    // 插入引用块内容\n    node.nodes.forEach((child, index) => {\n      controller.command(\n        Commands.insertNodeByPath,\n        parentPath,\n        refblockIndex + index,\n        child,\n      );\n    });\n    // 删除引用块\n    controller.command(Commands.removeNodeByKey, node.key);\n  });\n  return controller;\n}\n\n/**\n * 降级为普通块\n * @param controller\n * @param docKey\n */\nexport function downgradeToBlocksByDocKey(\n  controller: Controller,\n  docKey: string,\n) {\n  const { document } = controller.value;\n  document.forEachDescendant((node) => {\n    if (RefBlock.isRefBlock(node) && node.data.docKey === docKey) {\n      controller.command(downgradeToBlocks, node);\n    }\n  });\n  return controller;\n}\n\n/**\n * 降级对应节点 key 的块为普通块\n * @param controller\n * @param key\n */\nexport function downgradeToBlocksByKey(controller: Controller, key: string) {\n  const { document } = controller.value;\n  const node = document.assertNode(key);\n  if (RefBlock.isRefBlock(node)) {\n    return controller.command(downgradeToBlocks, node);\n  }\n  return controller;\n}\n"],"file":"downgradeToBlocks.js"}