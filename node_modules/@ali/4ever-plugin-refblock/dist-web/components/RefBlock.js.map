{"version":3,"sources":["../../../src/components/RefBlock.tsx"],"names":["React","stubFalse","debounce","noop","RefBlockStatus","RefBlockWrapper","Forbidden","Deleted","Invalid","Loading","RefBlockToolbar","REFBLOCK_MAX_HEIGHT","defaultGetUrl","url","RefBlock","props","children","readOnly","locale","renderProps","toolbarAnimationDuration","enableToolbar","detach","getReferenceList","getDocKey","renderRefBlockInOtherStates","onRefBlockMounted","copyRefBlock","renderLoading","getURL","attributes","ref","node","controller","value","selection","isBlurred","isCollapsed","isFocused","useState","toolbarVisible","setToolbarVisible","top","left","toolbarAnchor","setToolbarAnchor","wrapperRef","useRef","current","data","status","loading","isPageMode","docKey","uuid","refblockUUID","isHost","useLayoutEffect","useEffect","key","handleToolbarHide","useMemo","handleToolbarShow","useCallback","cancel","rect","getBoundingClientRect","right","handleCopy","handleMouseEnterToContent","event","preventDefault","stopPropagation","loadingJSX","forbidden","deleted","invalid","normal","read","wrapperStyle","maxHeight","overflow"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { stubFalse, debounce, noop } from 'lodash-es';\nimport { RenderNodeProps, Controller } from '@ali/4ever-cangjie';\nimport RefBlockNode, { RefBlockStatus } from '../mo/models';\nimport { RefBlockWrapper } from './styled';\nimport Forbidden from './Forbidden';\nimport Deleted from './Deleted';\nimport Invalid from './Invalid';\nimport Loading from './Loading';\nimport type { ReferenceItem, RefBlockLocale } from '../utils/types';\nimport RefBlockToolbar from './RefBlockToolbar';\nimport { REFBLOCK_MAX_HEIGHT } from '../utils/styles';\n\ninterface RefBlockProps {\n  /** 是否 focus 在引用块 */\n  isFocused: boolean;\n  /** 编辑器节点渲染 props */\n  renderProps: RenderNodeProps;\n  /** 只读模式 */\n  readOnly: boolean;\n  /** 国际化文案 */\n  locale: RefBlockLocale;\n  /** 工具栏动画持续时间 */\n  toolbarAnimationDuration?: number;\n  /** 是否开启工具栏 */\n  enableToolbar?: () => boolean;\n  /** 获得引用列表 */\n  getReferenceList: (id: string) => Promise<ReferenceItem[]>;\n  /** 点击取消引用 */\n  detach: (docKey: string, uuid: string) => Promise<void>;\n  /** 获得当前文档 key */\n  getDocKey: () => string;\n  /** 渲染其他状态的引用块 */\n  renderRefBlockInOtherStates: (\n    props: RenderNodeProps,\n    status: RefBlockStatus,\n  ) => React.ReactNode;\n  /** 挂载引用块时的操作 */\n  onRefBlockMounted?: (\n    controller: Controller,\n    nodeKey: string,\n    uuid: string,\n  ) => void;\n  /** 拷贝引用块 */\n  copyRefBlock: () => void;\n  /* 自定义 loading 组件样式 */\n  renderLoading?: (props: RenderNodeProps) => JSX.Element | null;\n  /** 获得文档链接 */\n  getURL?: (url: string, id: string) => string;\n}\n\nconst defaultGetUrl = (url: string) => url;\n\nconst RefBlock: React.FC<RefBlockProps> = (props) => {\n  const {\n    children,\n    readOnly,\n    locale,\n    renderProps,\n    toolbarAnimationDuration = 150,\n    enableToolbar = stubFalse,\n    detach,\n    getReferenceList,\n    getDocKey,\n    renderRefBlockInOtherStates,\n    onRefBlockMounted,\n    copyRefBlock,\n    renderLoading,\n    getURL = defaultGetUrl,\n  } = props;\n  const { attributes } = renderProps;\n  const { ref } = attributes;\n  const node = renderProps.node as RefBlockNode;\n  const { controller } = renderProps;\n  const { selection, isBlurred } = controller.value;\n  const { isCollapsed } = selection;\n  const isFocused = props.isFocused && !isBlurred;\n\n  const [toolbarVisible, setToolbarVisible] = React.useState(false);\n  /**********************************\\\n  *                                  *\n  *                      |           *\n  *                    left          *\n  *                      |           *\n  *                      v           *\n  * +--------------------+  <--top-- *\n  * |      RefBlock      |           *\n  * +--------------------+           *\n  *                                  *\n  \\**********************************/\n  const [toolbarAnchor, setToolbarAnchor] = React.useState<{\n    top: number;\n    left: number;\n  }>({ top: -100, left: -100 });\n  const wrapperRef = React.useRef<HTMLDivElement>(ref && ref.current);\n\n  const { status = RefBlockStatus.loading, isPageMode } = node.data;\n  const docKey = node.data.docKey!;\n  const uuid = node.data.refblockUUID!;\n  const isHost = uuid === docKey;\n\n  React.useLayoutEffect(() => {\n    if (ref) {\n      wrapperRef.current = ref.current;\n    }\n  }, [ref]);\n\n  React.useEffect(() => {\n    onRefBlockMounted && onRefBlockMounted(controller, node.key, uuid);\n  }, [onRefBlockMounted, controller, node.key, uuid]);\n\n  const handleToolbarHide = React.useMemo(\n    () =>\n      debounce(() => {\n        setToolbarVisible(false);\n      }, toolbarAnimationDuration),\n    [toolbarAnimationDuration],\n  );\n\n  const handleToolbarShow = React.useCallback(() => {\n    handleToolbarHide.cancel();\n    // 计算工具栏定位锚点\n    const rect = wrapperRef.current!.getBoundingClientRect();\n    const left = rect.right;\n    const top = rect.top - 42;\n    setToolbarAnchor({\n      top,\n      left,\n    });\n    setToolbarVisible(true);\n  }, [handleToolbarHide]);\n\n  React.useEffect(() => {\n    return () => {\n      handleToolbarHide.cancel();\n    };\n  }, [handleToolbarHide]);\n\n  const handleCopy = React.useCallback(() => {\n    copyRefBlock();\n    setToolbarVisible(false);\n  }, [copyRefBlock]);\n\n  const handleMouseEnterToContent = React.useCallback(\n    (event: React.MouseEvent) => {\n      // focus 时，鼠标进入到 content，隐藏工具栏\n      event.preventDefault();\n      event.stopPropagation();\n      setToolbarVisible(false);\n    },\n    [],\n  );\n\n  React.useEffect(() => {\n    // focus 时，隐藏工具栏\n    if (isFocused) {\n      setToolbarVisible(false);\n    }\n  }, [isFocused]);\n\n  if (status === RefBlockStatus.loading) {\n    const loadingJSX = renderLoading?.(renderProps);\n    return (\n      <RefBlockWrapper\n        data-dockey={docKey}\n        data-cangjie-not-editable\n        isHost={isHost}\n        $loading={true}\n        {...attributes}\n      >\n        {loadingJSX || <Loading>{children}</Loading>}\n      </RefBlockWrapper>\n    );\n  } else if (status === RefBlockStatus.forbidden) {\n    return <Forbidden attributes={attributes}>{locale.forbidden}</Forbidden>;\n  } else if (status === RefBlockStatus.deleted) {\n    return <Deleted attributes={attributes}>{locale.deleted}</Deleted>;\n  } else if (status === RefBlockStatus.invalid) {\n    return <Invalid attributes={attributes}>{locale.deleted}</Invalid>;\n  } else if (\n    status === RefBlockStatus.normal ||\n    status === RefBlockStatus.readOnly\n  ) {\n    const read = status === RefBlockStatus.readOnly || readOnly;\n    /* istanbul ignore next */\n    const wrapperStyle: React.CSSProperties =\n      isPageMode && status === RefBlockStatus.readOnly\n        ? {\n            maxHeight: REFBLOCK_MAX_HEIGHT,\n            overflow: 'scroll',\n          }\n        : {};\n\n    return (\n      <RefBlockWrapper\n        data-testid=\"refblock-container\"\n        data-container-block\n        data-focused={isFocused}\n        ref={wrapperRef}\n        isFocused={isFocused}\n        isHost={isHost}\n        style={wrapperStyle}\n        onMouseLeave={handleToolbarHide}\n        onMouseEnter={isFocused ? noop : handleToolbarShow}\n        onMouseMove={isFocused ? handleToolbarShow : noop}\n        {...attributes}\n      >\n        {enableToolbar() && (\n          <RefBlockToolbar\n            locale={locale}\n            readOnly={read}\n            canCopy={status === RefBlockStatus.normal}\n            visible={toolbarVisible && isCollapsed}\n            node={node}\n            isHost={isHost}\n            status={status}\n            duration={toolbarAnimationDuration}\n            anchor={toolbarAnchor}\n            detach={detach}\n            getReferenceList={getReferenceList}\n            getDocKey={getDocKey}\n            getURL={getURL}\n            copy={handleCopy}\n            onToolbarShow={handleToolbarShow}\n            onToolbarHide={handleToolbarHide}\n          />\n        )}\n        <div\n          className=\"refblock-content\"\n          data-refblock-uuid={uuid}\n          onMouseEnter={isFocused ? handleMouseEnterToContent : noop}\n        >\n          {children}\n        </div>\n      </RefBlockWrapper>\n    );\n  } else {\n    return (\n      <div {...attributes} data-testid={`refblock-other-states-${status}`}>\n        {renderRefBlockInOtherStates(renderProps, status)}\n      </div>\n    );\n  }\n};\n\nexport default RefBlock;\n"],"file":"RefBlock.js"}