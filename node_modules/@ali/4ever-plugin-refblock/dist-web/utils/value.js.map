{"version":3,"sources":["../../../src/utils/value.ts"],"names":["OperationType","RefBlock","getRefBlockMap","document","refblocks","filterDescendants","node","isRefBlock","reduce","map","refblock","key","data","docKey","push","nodeKey","uuid","refblockUUID","refreshRefBlockByKey","value","refblockDocument","uuidKey","path","assertPath","assertNodeByPath","Error","type","newValue","nodes","forEach","child","childPath","removeNodeOp","RemoveNode","applyOperation","regenerateChildrenUUID","index","insertNodeOp","InsertNode","refreshRefBlockByDocKey","forEachDescendant"],"mappings":"AAAA,SAGEA,aAHF,QAMO,oBANP;AAOA,OAAOC,QAAP;AAEqF;;AAErF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,SAASC,cAAT,CAAwBC,QAAxB,EAAyD;AAC9D,MAAMC,SAAS,GAAGD,QAAQ,CAACE,iBAAT,CAA2B,UAACC,IAAD;AAAA,WAC3CL,QAAQ,CAACM,UAAT,CAAoBD,IAApB,CAD2C;AAAA,GAA3B,CAAlB;AAEA,SAAOF,SAAS,CAACI,MAAV,CAA8B,UAACC,GAAD,EAAMC,QAAN,EAAmB;AACtD,QAAMC,GAAG,GAAGD,QAAQ,CAACE,IAAT,CAAcC,MAA1B;;AACA,QAAI,CAACJ,GAAG,CAACE,GAAD,CAAR,EAAe;AACbF,MAAAA,GAAG,CAACE,GAAD,CAAH,GAAW,EAAX;AACD;;AACDF,IAAAA,GAAG,CAACE,GAAD,CAAH,CAASG,IAAT,CAAc;AACZC,MAAAA,OAAO,EAAEL,QAAQ,CAACC,GADN;AAEZK,MAAAA,IAAI,EAAEN,QAAQ,CAACE,IAAT,CAAcK;AAFR,KAAd;AAIA,WAAOR,GAAP;AACD,GAVM,EAUJ,EAVI,CAAP;AAWD;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,OAAO,SAASS,oBAAT,CACLC,KADK,EAELJ,OAFK,EAGLK,gBAHK,EAILC,OAJK,EAKE;AAAA,MADPA,OACO;AADPA,IAAAA,OACO,GADG,MACH;AAAA;;AAAA,MACClB,QADD,GACcgB,KADd,CACChB,QADD;AAEP,MAAMmB,IAAI,GAAGnB,QAAQ,CAACoB,UAAT,CAAoBR,OAApB,CAAb;AACA,MAAMT,IAAI,GAAGH,QAAQ,CAACqB,gBAAT,CAA0BF,IAA1B,CAAb;;AACA,MAAI,CAACrB,QAAQ,CAACM,UAAT,CAAoBD,IAApB,CAAL,EAAgC;AAC9B,UAAM,IAAImB,KAAJ,EACJ;AADI,cAEInB,IAAI,CAACK,GAFT,qCAE4CL,IAAI,CAACoB,IAFjD,CAAN;AAID;;AACD,MAAIC,QAAQ,GAAGR,KAAf,CAVO,CAWP;;AACAb,EAAAA,IAAI,CAACsB,KAAL,CAAWC,OAAX,CAAmB,UAACC,KAAD,EAAW;AAC5B,QAAMC,SAAS,aAAOT,IAAP,GAAa,CAAb,EAAf;AACA,QAAMU,YAAiC,GAAG;AACxCN,MAAAA,IAAI,EAAE1B,aAAa,CAACiC,UADoB;AAExCX,MAAAA,IAAI,EAAES,SAFkC;AAGxCzB,MAAAA,IAAI,EAAEwB;AAHkC,KAA1C;AAKAH,IAAAA,QAAQ,GAAGA,QAAQ,CAACO,cAAT,CAAwBF,YAAxB,CAAX;AACD,GARD,EAZO,CAqBP;;AACA/B,EAAAA,QAAQ,CAACkC,sBAAT,CACEf,gBADF,EAEEd,IAAI,CAACM,IAAL,CAAUK,YAFZ,EAGEI,OAHF,EAIEO,KAJF,CAIQC,OAJR,CAIgB,UAACC,KAAD,EAAQM,KAAR,EAAkB;AAChC,QAAML,SAAS,aAAOT,IAAP,GAAac,KAAb,EAAf;AACA,QAAMC,YAAiC,GAAG;AACxCX,MAAAA,IAAI,EAAE1B,aAAa,CAACsC,UADoB;AAExChB,MAAAA,IAAI,EAAES,SAFkC;AAGxCzB,MAAAA,IAAI,EAAEwB;AAHkC,KAA1C;AAKAH,IAAAA,QAAQ,GAAGA,QAAQ,CAACO,cAAT,CAAwBG,YAAxB,CAAX;AACD,GAZD;AAcA,SAAOV,QAAP;AACD;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,OAAO,SAASY,uBAAT,CACLpB,KADK,EAELN,MAFK,EAGLO,gBAHK,EAIE;AACP,MAAIO,QAAQ,GAAGR,KAAf;AACAA,EAAAA,KAAK,CAAChB,QAAN,CAAeqC,iBAAf,CAAiC,UAAClC,IAAD,EAAU;AACzC,QAAIL,QAAQ,CAACM,UAAT,CAAoBD,IAApB,KAA6BA,IAAI,CAACM,IAAL,CAAUC,MAAV,KAAqBA,MAAtD,EAA8D;AAC5Dc,MAAAA,QAAQ,GAAGT,oBAAoB,CAACS,QAAD,EAAWrB,IAAI,CAACK,GAAhB,EAAqBS,gBAArB,CAA/B;AACD;AACF,GAJD;AAKA,SAAOO,QAAP;AACD","sourcesContent":["import {\n  Document,\n  InsertNodeOperation,\n  OperationType,\n  RemoveNodeOperation,\n  Value,\n} from '@ali/4ever-cangjie';\nimport RefBlock from '../mo/models';\n\nexport type RefBlockMap = Record<string, Array<{ nodeKey: string; uuid?: string }>>; // docKey: [{ nodeKey, uuid }]\n\n/**\n * 获得引用块的 key 映射表 { docKey: [{ nodeKey, uuid }] }\n *\n * ## Example\n *\n * ```tsx\n * const document = (\n *   <document>\n *     <paragraph key=\"0\">Introduction</paragraph>\n *     <refblock docKey=\"doc-a\" uuid=\"a-0\" key=\"1\">\n *       <paragraph>Cangjie Editor</paragraph>\n *     </refblock>\n *     <refblock docKey=\"doc-a\" uuid=\"a-1\" key=\"2\">\n *       <paragraph>Cangjie Editor</paragraph>\n *     </refblock>\n *     <refblock docKey=\"doc-b\" uuid=\"b-0\" key=\"3\">\n *       <paragraph>Commands</paragraph>\n *     </refblock>\n *   </document>\n * );\n *\n * const refblockMap = getRefBlockMap(document);\n *\n * // refblock map is:\n * // {\n * //   'doc-a': [{nodeKey: '1', uuid: 'a-0'}, {nodeKey: '2', uuid: 'a-1'}],\n * //   'doc-b': [{nodeKey: '3', uuid: 'b-0'}]\n * // }\n * ```\n * @param document\n * @returns\n */\nexport function getRefBlockMap(document: Document): RefBlockMap {\n  const refblocks = document.filterDescendants((node) =>\n    RefBlock.isRefBlock(node)) as RefBlock[];\n  return refblocks.reduce<RefBlockMap>((map, refblock) => {\n    const key = refblock.data.docKey!;\n    if (!map[key]) {\n      map[key] = [];\n    }\n    map[key].push({\n      nodeKey: refblock.key,\n      uuid: refblock.data.refblockUUID,\n    });\n    return map;\n  }, {});\n}\n\n/**\n * 根据 node key 刷新引用块\n *\n * ## Example\n *\n * ```tsx\n * const value = (\n *   <value>\n *     <document>\n *       <paragraph key=\"0\">Introduction</paragraph>\n *       <refblock docKey=\"doc-a\" key=\"1\"/>\n *     </document>\n *   </value>\n * );\n *\n * const docA = (\n *   <document>\n *     <paragraph>JavaScript</paragraph>\n *     <code lang=\"javascript\">const a = 1;</code>\n *   </document>\n * );\n *\n * const newValue = refreshRefBlockByKey(document, '1', docA);\n * // newValue is:\n * // (\n * //   <value>\n * //     <document>\n * //       <paragraph key=\"0\">Introduction</paragraph>\n * //       <refblock docKey=\"doc-a\" key=\"1\">\n * //         <paragraph>JavaScript</paragraph>\n * //         <code lang=\"javascript\">const a = 1;</code>\n * //       </refblock>\n * //     </document>\n * //   </value>\n * // )\n * ```\n * @param document\n * @param nodeKey\n * @param refblockDocument\n */\nexport function refreshRefBlockByKey(\n  value: Value,\n  nodeKey: string,\n  refblockDocument: Document,\n  uuidKey = 'uuid',\n): Value {\n  const { document } = value;\n  const path = document.assertPath(nodeKey);\n  const node = document.assertNodeByPath(path);\n  if (!RefBlock.isRefBlock(node)) {\n    throw new Error(\n      // @ts-ignore\n      `node ${node.key} is not a refblock, type is: ${node.type}`,\n    );\n  }\n  let newValue = value;\n  // 清空原 refblock children\n  node.nodes.forEach((child) => {\n    const childPath = [...path, 0];\n    const removeNodeOp: RemoveNodeOperation = {\n      type: OperationType.RemoveNode,\n      path: childPath,\n      node: child,\n    };\n    newValue = newValue.applyOperation(removeNodeOp);\n  });\n  // 注入 refblock document，并替换其中的 uuid，防止多个相同引用块中，出现重复的 uuid\n  RefBlock.regenerateChildrenUUID(\n    refblockDocument,\n    node.data.refblockUUID!,\n    uuidKey,\n  ).nodes.forEach((child, index) => {\n    const childPath = [...path, index];\n    const insertNodeOp: InsertNodeOperation = {\n      type: OperationType.InsertNode,\n      path: childPath,\n      node: child,\n    };\n    newValue = newValue.applyOperation(insertNodeOp);\n  });\n\n  return newValue;\n}\n\n/**\n * 根据 doc key 刷新引用块\n *\n * ## Example\n *\n * ```tsx\n * const value = (\n *   <value>\n *     <document>\n *       <paragraph key=\"0\">Introduction</paragraph>\n *       <refblock docKey=\"doc-a\"/>\n *       <refblock docKey=\"doc-a\"/>\n *     </document>\n *   </value>\n * );\n *\n * const docA = (\n *   <document>\n *     <paragraph>JavaScript</paragraph>\n *     <code lang=\"javascript\">const a = 1;</code>\n *   </document>\n * );\n *\n * const newValue = refreshRefBlockByDocKey(document, 'doc-a', docA);\n * // newValue is:\n * // (\n * //   <value>\n * //     <document>\n * //       <paragraph key=\"0\">Introduction</paragraph>\n * //       <refblock docKey=\"doc-a\">\n * //         <paragraph>JavaScript</paragraph>\n * //         <code lang=\"javascript\">const a = 1;</code>\n * //       </refblock>\n * //       <refblock docKey=\"doc-a\">\n * //         <paragraph>JavaScript</paragraph>\n * //         <code lang=\"javascript\">const a = 1;</code>\n * //       </refblock>\n * //     </document>\n * //   </value>\n * // )\n * ```\n * @param document\n * @param nodeKey\n * @param refblockDocument\n */\nexport function refreshRefBlockByDocKey(\n  value: Value,\n  docKey: string,\n  refblockDocument: Document,\n): Value {\n  let newValue = value;\n  value.document.forEachDescendant((node) => {\n    if (RefBlock.isRefBlock(node) && node.data.docKey === docKey) {\n      newValue = refreshRefBlockByKey(newValue, node.key, refblockDocument);\n    }\n  });\n  return newValue;\n}\n"],"file":"value.js"}