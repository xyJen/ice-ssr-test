{"version":3,"sources":["../../../../src/bi/commands/downgradeToBlocks.ts"],"names":["Commands","Path","RefBlock","downgradeToBlocks","controller","node","document","value","path","assertPath","key","parentPath","parent","refblockIndex","length","withoutNormalizing","nodes","forEach","child","index","command","insertNodeByPath","removeNodeByKey","downgradeToBlocksByDocKey","docKey","forEachDescendant","isRefBlock","data","downgradeToBlocksByKey","assertNode"],"mappings":"AAAA,SAAqBA,QAArB,EAA+BC,IAA/B,QAA2C,oBAA3C;AACA,OAAOC,QAAP;;AAEA,SAASC,iBAAT,CAA2BC,UAA3B,EAAmDC,IAAnD,EAAmE;AAAA,MACzDC,QADyD,GAC5CF,UAAU,CAACG,KADiC,CACzDD,QADyD;AAEjE,MAAME,IAAI,GAAGF,QAAQ,CAACG,UAAT,CAAoBJ,IAAI,CAACK,GAAzB,CAAb;AACA,MAAMC,UAAU,GAAGV,IAAI,CAACW,MAAL,CAAYJ,IAAZ,CAAnB;AACA,MAAMK,aAAa,GAAGL,IAAI,CAACA,IAAI,CAACM,MAAL,GAAc,CAAf,CAA1B;AACAV,EAAAA,UAAU,CAACW,kBAAX,CAA8B,YAAM;AAClC;AACAV,IAAAA,IAAI,CAACW,KAAL,CAAWC,OAAX,CAAmB,UAACC,KAAD,EAAQC,KAAR,EAAkB;AACnCf,MAAAA,UAAU,CAACgB,OAAX,CACEpB,QAAQ,CAACqB,gBADX,EAEEV,UAFF,EAGEE,aAAa,GAAGM,KAHlB,EAIED,KAJF;AAMD,KAPD,EAFkC,CAUlC;;AACAd,IAAAA,UAAU,CAACgB,OAAX,CAAmBpB,QAAQ,CAACsB,eAA5B,EAA6CjB,IAAI,CAACK,GAAlD;AACD,GAZD;AAaA,SAAON,UAAP;AACD;AAED;AACA;AACA;AACA;AACA;;;AACA,OAAO,SAASmB,yBAAT,CACLnB,UADK,EAELoB,MAFK,EAGL;AAAA,MACQlB,QADR,GACqBF,UAAU,CAACG,KADhC,CACQD,QADR;AAEAA,EAAAA,QAAQ,CAACmB,iBAAT,CAA2B,UAACpB,IAAD,EAAU;AACnC,QAAIH,QAAQ,CAACwB,UAAT,CAAoBrB,IAApB,KAA6BA,IAAI,CAACsB,IAAL,CAAUH,MAAV,KAAqBA,MAAtD,EAA8D;AAC5DpB,MAAAA,UAAU,CAACgB,OAAX,CAAmBjB,iBAAnB,EAAsCE,IAAtC;AACD;AACF,GAJD;AAKA,SAAOD,UAAP;AACD;AAED;AACA;AACA;AACA;AACA;;AACA,OAAO,SAASwB,sBAAT,CAAgCxB,UAAhC,EAAwDM,GAAxD,EAAqE;AAAA,MAClEJ,QADkE,GACrDF,UAAU,CAACG,KAD0C,CAClED,QADkE;AAE1E,MAAMD,IAAI,GAAGC,QAAQ,CAACuB,UAAT,CAAoBnB,GAApB,CAAb;;AACA,MAAIR,QAAQ,CAACwB,UAAT,CAAoBrB,IAApB,CAAJ,EAA+B;AAC7B,WAAOD,UAAU,CAACgB,OAAX,CAAmBjB,iBAAnB,EAAsCE,IAAtC,CAAP;AACD;;AACD,SAAOD,UAAP;AACD","sourcesContent":["import { Controller, Commands, Path } from '@ali/4ever-cangjie';\nimport RefBlock from '../../mo/models';\n\nfunction downgradeToBlocks(controller: Controller, node: RefBlock) {\n  const { document } = controller.value;\n  const path = document.assertPath(node.key);\n  const parentPath = Path.parent(path);\n  const refblockIndex = path[path.length - 1];\n  controller.withoutNormalizing(() => {\n    // 插入引用块内容\n    node.nodes.forEach((child, index) => {\n      controller.command(\n        Commands.insertNodeByPath,\n        parentPath,\n        refblockIndex + index,\n        child,\n      );\n    });\n    // 删除引用块\n    controller.command(Commands.removeNodeByKey, node.key);\n  });\n  return controller;\n}\n\n/**\n * 降级为普通块\n * @param controller\n * @param docKey\n */\nexport function downgradeToBlocksByDocKey(\n  controller: Controller,\n  docKey: string,\n) {\n  const { document } = controller.value;\n  document.forEachDescendant((node) => {\n    if (RefBlock.isRefBlock(node) && node.data.docKey === docKey) {\n      controller.command(downgradeToBlocks, node);\n    }\n  });\n  return controller;\n}\n\n/**\n * 降级对应节点 key 的块为普通块\n * @param controller\n * @param key\n */\nexport function downgradeToBlocksByKey(controller: Controller, key: string) {\n  const { document } = controller.value;\n  const node = document.assertNode(key);\n  if (RefBlock.isRefBlock(node)) {\n    return controller.command(downgradeToBlocks, node);\n  }\n  return controller;\n}\n"],"file":"downgradeToBlocks.js"}