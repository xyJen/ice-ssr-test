{"version":3,"sources":["../../../src/cardFactory/createRenderNode.tsx"],"names":["React","logger","ErrorBoundary","Card","CardContainer","removeCard","isOwnerAndFirstCreated","setOwnerAndFirstCreated","ChildrenComponent","childProps","controller","plugin","config","restrictSize","locale","renderNode","isMobile","cardStyle","disableSelected","node","key","isOwner","useEffect","PHolder","cardTypeConfig","cardType","TYPE","props","next","data","errorTitle","fallback","renderText","run","error"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport logger from '@ali/4ever-logger';\nimport { RenderNodeProps, Controller, Element, Block } from '@ali/4ever-cangjie';\nimport { ErrorBoundary } from '@ali/4ever-component';\nimport { Card } from '@ali/4ever-plugin-card';\nimport { CustomizedBiCardPluginType, CardPluginType } from './type';\nimport CardContainer from './components/cardContainer';\nimport type { BiPluginConfig } from '@ali/4ever-cangjie';\nimport { removeCard } from './actions';\nimport { isOwnerAndFirstCreated, setOwnerAndFirstCreated } from './utils/cardStore';\n\ninterface IChildrenProps {\n  childProps: RenderNodeProps<Block>;\n  controller: Controller;\n  plugin: CustomizedBiCardPluginType;\n  config: BiPluginConfig;\n  restrictSize?: boolean;\n  cardStyle?: React.CSSProperties;\n}\n\nconst ChildrenComponent: React.FC<IChildrenProps> = ({\n  childProps,\n  controller,\n  plugin,\n  config,\n  restrictSize,\n}): JSX.Element => {\n  const { locale, renderNode, isMobile, cardStyle } = plugin;\n\n  const disableSelected = typeof plugin.disableSelected === 'function' ?\n    plugin.disableSelected(childProps.node) :\n    plugin.disableSelected;\n  const { key } = childProps.node;\n  const isOwner = isOwnerAndFirstCreated(key);\n\n  React.useEffect(() => {\n    if (isOwner) setOwnerAndFirstCreated(key, false);\n  }, [key, isOwner]);\n\n  return (\n    <CardContainer\n      {...childProps}\n      config={config}\n      isMobile={isMobile}\n      disableSelected={disableSelected}\n      locale={locale}\n      cardStyle={cardStyle}\n      restrictSize={restrictSize}\n    >\n      {renderNode({ ...childProps, isOwnerAndFirstCreated: isOwner }, controller)}\n    </CardContainer>\n  );\n};\n\nexport default (plugin: CustomizedBiCardPluginType, config: BiPluginConfig, PHolder: React.ComponentType<any>): CardPluginType['renderNode'] => {\n  const { cardType: cardTypeConfig } = plugin;\n  return {\n    [Card.TYPE]: (props, controller, next) => {\n      const { restrictSize } = props;\n      const node = props.node as Block;\n\n      const { cardType } = node.data;\n      if (cardTypeConfig !== cardType) {\n        return next();\n      }\n\n      const errorTitle = `BI:CARD:${cardType}`;\n      const fallback = (\n        <PHolder\n          {...props}\n          renderText={plugin.renderText}\n          editor={controller}\n          handleRemoveNode={() => controller.run('onAction', removeCard(node as Element))}\n        />\n      );\n      try {\n        return (\n          <ErrorBoundary\n            errorTitle={errorTitle}\n            fallback={fallback}\n          >\n            <ChildrenComponent\n              restrictSize={restrictSize}\n              childProps={props}\n              controller={controller}\n              plugin={plugin}\n              config={config}\n            />\n          </ErrorBoundary>\n        );\n      } catch (error: any) {\n        // ErrorBoundary 只能捕获子组件错误，这里对组件本身加一层兜底处理\n        logger.error(errorTitle, error);\n        return fallback;\n      }\n    },\n  };\n};\n"],"file":"createRenderNode.js"}