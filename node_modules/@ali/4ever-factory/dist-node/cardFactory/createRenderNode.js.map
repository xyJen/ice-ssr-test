{"version":3,"sources":["../../../src/cardFactory/createRenderNode.tsx"],"names":["ChildrenComponent","childProps","controller","plugin","config","restrictSize","locale","renderNode","isMobile","cardStyle","disableSelected","node","key","isOwner","React","useEffect","isOwnerAndFirstCreated","PHolder","cardType","cardTypeConfig","Card","TYPE","props","next","data","errorTitle","fallback","renderText","run","error","logger"],"mappings":";;;;;;;;;;;;;AAAA;;AACA;;AAEA;;AACA;;AAEA;;AAEA;;AACA;;uBAR4B,a;;AAmB5B,MAAMA,iBAA2C,GAAG,CAAC;AACnDC,EAAAA,UADmD;AAEnDC,EAAAA,UAFmD;AAGnDC,EAAAA,MAHmD;AAInDC,EAAAA,MAJmD;AAKnDC,EAAAA;AALmD,CAAD,KAMjC;AACjB,QAAM;AAAEC,IAAAA,MAAF;AAAUC,IAAAA,UAAV;AAAsBC,IAAAA,QAAtB;AAAgCC,IAAAA;AAAhC,MAA8CN,MAApD;AAEA,QAAMO,eAAe,GAAG,OAAOP,MAAM,CAACO,eAAd,KAAkC,UAAlC,GACtBP,MAAM,CAACO,eAAP,CAAuBT,UAAU,CAACU,IAAlC,CADsB,GAEtBR,MAAM,CAACO,eAFT;AAGA,QAAM;AAAEE,IAAAA;AAAF,MAAUX,UAAU,CAACU,IAA3B;AACA,QAAME,OAAO,GAAG,uCAAuBD,GAAvB,CAAhB;AAEAE,EAAAA,KAAK,CAACC,SAAN,CAAgB,MAAM;AACpB,QAAIF,OAAJ,EAAa,wCAAwBD,GAAxB,EAA6B,KAA7B;AACd,GAFD,EAEG,CAACA,GAAD,EAAMC,OAAN,CAFH;AAIA,sBACE,eAAC,sBAAD,6BACMZ,UADN;AAEE,IAAA,MAAM,EAAEG,MAFV;AAGE,IAAA,QAAQ,EAAEI,QAHZ;AAIE,IAAA,eAAe,EAAEE,eAJnB;AAKE,IAAA,MAAM,EAAEJ,MALV;AAME,IAAA,SAAS,EAAEG,SANb;AAOE,IAAA,YAAY,EAAEJ;AAPhB,MASGE,UAAU,CAAC,EAAE,GAAGN,UAAL;AAAiBe,IAAAA,sBAAsB,EAAEH;AAAzC,GAAD,EAAqDX,UAArD,CATb,CADF;AAaD,CAhCD;;eAkCe,CAACC,MAAD,EAAqCC,MAArC,EAA6Da,OAA7D,KAAiI;AAC9I,QAAM;AAAEC,IAAAA,QAAQ,EAAEC;AAAZ,MAA+BhB,MAArC;AACA,SAAO;AACL,KAACiB,qBAAKC,IAAN,GAAa,CAACC,KAAD,EAAQpB,UAAR,EAAoBqB,IAApB,KAA6B;AACxC,YAAM;AAAElB,QAAAA;AAAF,UAAmBiB,KAAzB;AACA,YAAMX,IAAI,GAAGW,KAAK,CAACX,IAAnB;AAEA,YAAM;AAAEO,QAAAA;AAAF,UAAeP,IAAI,CAACa,IAA1B;;AACA,UAAIL,cAAc,KAAKD,QAAvB,EAAiC;AAC/B,eAAOK,IAAI,EAAX;AACD;;AAED,YAAME,UAAU,GAAI,WAAUP,QAAS,EAAvC;;AACA,YAAMQ,QAAQ,gBACZ,eAAC,OAAD,6BACMJ,KADN;AAEE,QAAA,UAAU,EAAEnB,MAAM,CAACwB,UAFrB;AAGE,QAAA,MAAM,EAAEzB,UAHV;AAIE,QAAA,gBAAgB,EAAE,MAAMA,UAAU,CAAC0B,GAAX,CAAe,UAAf,EAA2B,yBAAWjB,IAAX,CAA3B;AAJ1B,SADF;;AAQA,UAAI;AACF,4BACE,eAAC,4BAAD;AACE,UAAA,UAAU,EAAEc,UADd;AAEE,UAAA,QAAQ,EAAEC;AAFZ,wBAIE,eAAC,iBAAD;AACE,UAAA,YAAY,EAAErB,YADhB;AAEE,UAAA,UAAU,EAAEiB,KAFd;AAGE,UAAA,UAAU,EAAEpB,UAHd;AAIE,UAAA,MAAM,EAAEC,MAJV;AAKE,UAAA,MAAM,EAAEC;AALV,UAJF,CADF;AAcD,OAfD,CAeE,OAAOyB,KAAP,EAAmB;AACnB;AACAC,4BAAOD,KAAP,CAAaJ,UAAb,EAAyBI,KAAzB;;AACA,eAAOH,QAAP;AACD;AACF;AAvCI,GAAP;AAyCD,C","sourcesContent":["import * as React from 'react';\nimport logger from '@ali/4ever-logger';\nimport { RenderNodeProps, Controller, Element, Block } from '@ali/4ever-cangjie';\nimport { ErrorBoundary } from '@ali/4ever-component';\nimport { Card } from '@ali/4ever-plugin-card';\nimport { CustomizedBiCardPluginType, CardPluginType } from './type';\nimport CardContainer from './components/cardContainer';\nimport type { BiPluginConfig } from '@ali/4ever-cangjie';\nimport { removeCard } from './actions';\nimport { isOwnerAndFirstCreated, setOwnerAndFirstCreated } from './utils/cardStore';\n\ninterface IChildrenProps {\n  childProps: RenderNodeProps<Block>;\n  controller: Controller;\n  plugin: CustomizedBiCardPluginType;\n  config: BiPluginConfig;\n  restrictSize?: boolean;\n  cardStyle?: React.CSSProperties;\n}\n\nconst ChildrenComponent: React.FC<IChildrenProps> = ({\n  childProps,\n  controller,\n  plugin,\n  config,\n  restrictSize,\n}): JSX.Element => {\n  const { locale, renderNode, isMobile, cardStyle } = plugin;\n\n  const disableSelected = typeof plugin.disableSelected === 'function' ?\n    plugin.disableSelected(childProps.node) :\n    plugin.disableSelected;\n  const { key } = childProps.node;\n  const isOwner = isOwnerAndFirstCreated(key);\n\n  React.useEffect(() => {\n    if (isOwner) setOwnerAndFirstCreated(key, false);\n  }, [key, isOwner]);\n\n  return (\n    <CardContainer\n      {...childProps}\n      config={config}\n      isMobile={isMobile}\n      disableSelected={disableSelected}\n      locale={locale}\n      cardStyle={cardStyle}\n      restrictSize={restrictSize}\n    >\n      {renderNode({ ...childProps, isOwnerAndFirstCreated: isOwner }, controller)}\n    </CardContainer>\n  );\n};\n\nexport default (plugin: CustomizedBiCardPluginType, config: BiPluginConfig, PHolder: React.ComponentType<any>): CardPluginType['renderNode'] => {\n  const { cardType: cardTypeConfig } = plugin;\n  return {\n    [Card.TYPE]: (props, controller, next) => {\n      const { restrictSize } = props;\n      const node = props.node as Block;\n\n      const { cardType } = node.data;\n      if (cardTypeConfig !== cardType) {\n        return next();\n      }\n\n      const errorTitle = `BI:CARD:${cardType}`;\n      const fallback = (\n        <PHolder\n          {...props}\n          renderText={plugin.renderText}\n          editor={controller}\n          handleRemoveNode={() => controller.run('onAction', removeCard(node as Element))}\n        />\n      );\n      try {\n        return (\n          <ErrorBoundary\n            errorTitle={errorTitle}\n            fallback={fallback}\n          >\n            <ChildrenComponent\n              restrictSize={restrictSize}\n              childProps={props}\n              controller={controller}\n              plugin={plugin}\n              config={config}\n            />\n          </ErrorBoundary>\n        );\n      } catch (error: any) {\n        // ErrorBoundary 只能捕获子组件错误，这里对组件本身加一层兜底处理\n        logger.error(errorTitle, error);\n        return fallback;\n      }\n    },\n  };\n};\n"],"file":"createRenderNode.js"}