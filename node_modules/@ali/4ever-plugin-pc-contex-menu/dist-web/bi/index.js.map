{"version":3,"sources":["../../../src/bi/index.tsx"],"names":["React","Selection","Queries","CangjieSelectEvent","LEGAL_EVENT","dispatchCustomEvent","ACTION_CLOSE","openContextMenu","ContextMenu","key","handleAction","action","controller","next","type","handleCloseContextMenu","data","value","contextData","contextMenuVisible","visible","enableHots","isPendingEnable","setTimeout","setData","biFactory","configs","pcContextMenu","handleContextMenu","event","preventDefault","x","clientX","y","clientY","selection","document","isCollapsed","point","anchor","voidParent","getClosestVoid","query","pointAtDistance","focus","newSelection","create","run","handleMouseDown","renderEditable","_","onAction","onContextMenu","onMouseDown","models"],"mappings":";AAAA,OAAOA,KAAP,MAAkB,OAAlB;qBAC4B,a;AAA5B,SAEEC,SAFF,EAGEC,OAHF,EAIEC,kBAJF,QAMO,oBANP;AAOA,SAASC,WAAT,EAAsBC,mBAAtB,QAAiD,kBAAjD;AACA,SAASC,YAAT,EAAuBC,eAAvB;AACA,OAAOC,WAAP;AACA,SAASC,GAAT;;AAEA,SAASC,YAAT,CAAsBC,MAAtB,EAA8BC,UAA9B,EAAsDC,IAAtD,EAA4D;AAAA,MAClDC,IADkD,GACzCH,MADyC,CAClDG,IADkD;;AAE1D,MAAIA,IAAI,KAAKR,YAAb,EAA2B;AACzBS,IAAAA,sBAAsB,CAACH,UAAD,CAAtB;AACD;;AACD,SAAOC,IAAI,EAAX;AACD;;AAED,SAASE,sBAAT,CAAgCH,UAAhC,EAAwD;AAAA,MAC9CI,IAD8C,GACrCJ,UAAU,CAACK,KAD0B,CAC9CD,IAD8C;;AAEtD,MAAIA,IAAI,CAACE,WAAT,EAAsB;AACpBb,IAAAA,mBAAmB,CAACD,WAAW,CAACe,kBAAb,EAAiC;AAAEC,MAAAA,OAAO,EAAE;AAAX,KAAjC,CAAnB;;AACA,QAAIR,UAAU,CAACS,UAAX,IAAyBT,UAAU,CAACU,eAAxC,EAAyD;AACvD;AACA;AACA;AACA;AACAC,MAAAA,UAAU,CAAC,YAAM;AACfX,QAAAA,UAAU,CAACY,OAAX,cACKR,IADL;AAEEE,UAAAA,WAAW,EAAE;AAFf;AAID,OALS,EAKP,CALO,CAAV;AAMD,KAXD,MAWO;AACLN,MAAAA,UAAU,CAACY,OAAX,cACKR,IADL;AAEEE,QAAAA,WAAW,EAAE;AAFf;AAID;AACF;AACF;;AAED,OAAO,IAAMO,SAAoB,GAAG,SAAvBA,SAAuB,CAACC,OAAD,EAAa;AAC/C,MAAMC,aAAa,GAAG,CAAAD,OAAO,QAAP,YAAAA,OAAO,CAAEC,aAAT,KAA0B,EAAhD;;AACA,WAASC,iBAAT,CACEC,KADF,EAEEjB,UAFF,EAGEC,IAHF,EAIE;AACAgB,IAAAA,KAAK,CAACC,cAAN;AACA,QAAMZ,WAAW,GAAG;AAClBa,MAAAA,CAAC,EAAEF,KAAK,CAACG,OADS;AAElBC,MAAAA,CAAC,EAAEJ,KAAK,CAACK;AAFS,KAApB,CAFA,CAMA;;AANA,4BAOgCtB,UAAU,CAACK,KAP3C;AAAA,QAOQkB,SAPR,qBAOQA,SAPR;AAAA,QAOmBC,QAPnB,qBAOmBA,QAPnB;;AAQA,QAAID,SAAS,CAACE,WAAd,EAA2B;AAAA,UACTC,KADS,GACCH,SADD,CACjBI,MADiB;AAEzB,UAAMC,UAAU,GAAGJ,QAAQ,CAACK,cAAT,CAAwBH,KAAK,CAAC7B,GAA9B,EAAmCG,UAAnC,CAAnB;;AACA,UAAI4B,UAAJ,EAAgB;AACd,YAAMD,MAAM,GAAG3B,UAAU,CAAC8B,KAAX,CAAiBxC,OAAO,CAACyC,eAAzB,EAA0CL,KAA1C,EAAiD,CAAC,CAAlD,CAAf;AACA,YAAMM,KAAK,GAAGhC,UAAU,CAAC8B,KAAX,CAAiBxC,OAAO,CAACyC,eAAzB,EAA0CL,KAA1C,EAAiD,CAAjD,CAAd;AACA,YAAMO,YAAY,GAAG5C,SAAS,CAAC6C,MAAV,CAAiB;AAAEP,UAAAA,MAAM,EAANA,MAAF;AAAUK,UAAAA,KAAK,EAALA;AAAV,SAAjB,CAArB;AACAhC,QAAAA,UAAU,CAACmC,GAAX,CACE,iBADF,EAEE5C,kBAAkB,CAAC;AACjBgC,UAAAA,SAAS,EAAEU;AADM,SAAD,CAFpB;AAMD;AACF;;AAtBD,QAuBQ7B,IAvBR,GAuBiBJ,UAAU,CAACK,KAvB5B,CAuBQD,IAvBR;AAwBAX,IAAAA,mBAAmB,CAACD,WAAW,CAACe,kBAAb,EAAiC;AAAEC,MAAAA,OAAO,EAAE;AAAX,KAAjC,CAAnB;AACAR,IAAAA,UAAU,CAACY,OAAX,cACKR,IADL;AAEEE,MAAAA,WAAW,EAAXA;AAFF;AAIAN,IAAAA,UAAU,CAACmC,GAAX,CAAe,UAAf,EAA2BxC,eAAe,EAA1C;AACA,WAAOM,IAAI,EAAX;AACD;;AACD,WAASmC,eAAT,CACEnB,KADF,EAEEjB,UAFF,EAGEC,IAHF,EAIE;AACAE,IAAAA,sBAAsB,CAACH,UAAD,CAAtB;AACA,WAAOC,IAAI,EAAX;AACD;;AAED,WAASoC,cAAT,CAAwBC,CAAxB,EAA2BtC,UAA3B,EAAuCC,IAAvC,EAA6C;AAC3C,wBACE,eAAC,KAAD,CAAO,QAAP,QACGA,IAAI,EADP,eAEE,eAAC,WAAD,EAAiBc,aAAjB,CAFF,CADF;AAMD;;AACD,SAAO;AACLlB,IAAAA,GAAG,EAAHA,GADK;AAEL0C,IAAAA,QAAQ,EAAEzC,YAFL;AAGL0C,IAAAA,aAAa,EAAExB,iBAHV;AAILyB,IAAAA,WAAW,EAAEL,eAJR;AAKLC,IAAAA,cAAc,EAAdA,cALK;AAMLK,IAAAA,MAAM,EAAE;AANH,GAAP;AAQD,CA/DM","sourcesContent":["import React from 'react';\nimport {\n  Controller,\n  Selection,\n  Queries,\n  CangjieSelectEvent,\n  BiFactory,\n} from '@ali/4ever-cangjie';\nimport { LEGAL_EVENT, dispatchCustomEvent } from '@ali/4ever-utils';\nimport { ACTION_CLOSE, openContextMenu } from '../utils/actions';\nimport ContextMenu from '../utils/PCContextMenu';\nimport { key } from '../utils/meta';\n\nfunction handleAction(action, controller: Controller, next) {\n  const { type } = action;\n  if (type === ACTION_CLOSE) {\n    handleCloseContextMenu(controller);\n  }\n  return next();\n}\n\nfunction handleCloseContextMenu(controller: Controller) {\n  const { data } = controller.value;\n  if (data.contextData) {\n    dispatchCustomEvent(LEGAL_EVENT.contextMenuVisible, { visible: false });\n    if (controller.enableHots || controller.isPendingEnable) {\n      // BACKGROUND: 右键菜单全选时，形成的 op 序列是：\n      // -- set_selection -- set_data --\n      // 导致无法匹配选区 pending 的模式，因此将隐藏菜单的变更滞后\n      // -- set_selection -- pending -- set_data -- ...\n      setTimeout(() => {\n        controller.setData({\n          ...data,\n          contextData: null,\n        });\n      }, 0);\n    } else {\n      controller.setData({\n        ...data,\n        contextData: null,\n      });\n    }\n  }\n}\n\nexport const biFactory: BiFactory = (configs) => {\n  const pcContextMenu = configs?.pcContextMenu || {};\n  function handleContextMenu(\n    event: React.MouseEvent,\n    controller: Controller,\n    next,\n  ) {\n    event.preventDefault();\n    const contextData = {\n      x: event.clientX,\n      y: event.clientY,\n    };\n    // 如果右键的时候，当前选区选中了一个 void，则选中这个 void 元素\n    const { selection, document } = controller.value;\n    if (selection.isCollapsed) {\n      const { anchor: point } = selection;\n      const voidParent = document.getClosestVoid(point.key, controller);\n      if (voidParent) {\n        const anchor = controller.query(Queries.pointAtDistance, point, -1);\n        const focus = controller.query(Queries.pointAtDistance, point, 1);\n        const newSelection = Selection.create({ anchor, focus });\n        controller.run(\n          'onCangjieSelect',\n          CangjieSelectEvent({\n            selection: newSelection,\n          }),\n        );\n      }\n    }\n    const { data } = controller.value;\n    dispatchCustomEvent(LEGAL_EVENT.contextMenuVisible, { visible: true });\n    controller.setData({\n      ...data,\n      contextData,\n    });\n    controller.run('onAction', openContextMenu());\n    return next();\n  }\n  function handleMouseDown(\n    event: React.MouseEvent,\n    controller: Controller,\n    next,\n  ) {\n    handleCloseContextMenu(controller);\n    return next();\n  }\n\n  function renderEditable(_, controller, next) {\n    return (\n      <React.Fragment>\n        {next()}\n        <ContextMenu {...pcContextMenu} />\n      </React.Fragment>\n    );\n  }\n  return {\n    key,\n    onAction: handleAction,\n    onContextMenu: handleContextMenu,\n    onMouseDown: handleMouseDown,\n    renderEditable,\n    models: [],\n  };\n}\n"],"file":"index.js"}