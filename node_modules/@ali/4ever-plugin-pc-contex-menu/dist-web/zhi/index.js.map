{"version":3,"sources":["../../../src/zhi/index.tsx"],"names":["React","Commands","Selection","Queries","CangjieSelectEvent","key","ContextMenu","ACTION_CLOSE","openContextMenu","handleAction","action","controller","next","type","handleCloseContextMenu","data","value","contextData","setData","zhiFactory","configs","pcContextMenu","handleContextMenu","event","preventDefault","x","clientX","y","clientY","selection","document","command","focus","isCollapsed","point","anchor","voidParent","getClosestVoid","query","pointAtDistance","newSelection","create","run","handleMouseDown","renderEditable","_","onAction","onContextMenu","onMouseDown"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { Controller, Commands, Selection, Queries, CangjieSelectEvent, ZhiFactory } from '@ali/4ever-cangjie';\nimport { key } from '../utils/meta';\nimport ContextMenu from '../utils/PCContextMenu';\nimport { ACTION_CLOSE, openContextMenu } from '../utils/actions';\n\nfunction handleAction(action, controller: Controller, next) {\n  const { type } = action;\n  if (type === ACTION_CLOSE) {\n    handleCloseContextMenu(controller);\n  }\n  return next();\n}\n\nfunction handleCloseContextMenu(controller: Controller) {\n  const { data } = controller.value;\n  if (data.contextData) {\n    controller.setData({\n      ...data,\n      contextData: null,\n    });\n  }\n}\n\nexport const zhiFactory: ZhiFactory = (configs) => {\n  const pcContextMenu = configs?.pcContextMenu || {};\n  function handleContextMenu(\n    event: React.MouseEvent,\n    controller: Controller,\n    next,\n  ) {\n    event.preventDefault();\n    const contextData = {\n      x: event.clientX,\n      y: event.clientY,\n    };\n    const { data, selection, document } = controller.value;\n    controller.command(Commands.focus);\n    if (selection.isCollapsed) {\n      const { anchor: point } = selection;\n      const voidParent = document.getClosestVoid(point.key, controller);\n      if (voidParent) {\n        const anchor = controller.query(Queries.pointAtDistance, point, -1);\n        const focus = controller.query(Queries.pointAtDistance, point, 1);\n        const newSelection = Selection.create({ anchor, focus });\n        controller.run(\n          'onCangjieSelect',\n          CangjieSelectEvent({\n            selection: newSelection,\n          }),\n        );\n      }\n    }\n    controller.setData({\n      ...data,\n      contextData,\n    });\n    controller.run('onAction', openContextMenu());\n    return next();\n  }\n  function handleMouseDown(\n    event: React.MouseEvent,\n    controller: Controller,\n    next,\n  ) {\n    handleCloseContextMenu(controller);\n    return next();\n  }\n\n  function renderEditable(_, controller, next) {\n    return (\n      <React.Fragment>\n        {next()}\n        <ContextMenu {...pcContextMenu} />\n      </React.Fragment>\n    );\n  }\n  return {\n    key,\n    onAction: handleAction,\n    onContextMenu: handleContextMenu,\n    onMouseDown: handleMouseDown,\n    renderEditable,\n  };\n}\n"],"file":"index.js"}