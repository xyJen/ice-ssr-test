{"version":3,"sources":["../../../src/bi/index.tsx"],"names":["handleAction","action","controller","next","type","ACTION_CLOSE","handleCloseContextMenu","data","value","contextData","LEGAL_EVENT","contextMenuVisible","visible","enableHots","isPendingEnable","setTimeout","setData","biFactory","configs","pcContextMenu","handleContextMenu","event","preventDefault","x","clientX","y","clientY","selection","document","isCollapsed","anchor","point","voidParent","getClosestVoid","key","query","Queries","pointAtDistance","focus","newSelection","Selection","create","run","handleMouseDown","renderEditable","_","onAction","onContextMenu","onMouseDown","models"],"mappings":"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","sourcesContent":["import React from 'react';\nimport {\n  Controller,\n  Selection,\n  Queries,\n  CangjieSelectEvent,\n  BiFactory,\n} from '@ali/4ever-cangjie';\nimport { LEGAL_EVENT, dispatchCustomEvent } from '@ali/4ever-utils';\nimport { ACTION_CLOSE, openContextMenu } from '../utils/actions';\nimport ContextMenu from '../utils/PCContextMenu';\nimport { key } from '../utils/meta';\n\nfunction handleAction(action, controller: Controller, next) {\n  const { type } = action;\n  if (type === ACTION_CLOSE) {\n    handleCloseContextMenu(controller);\n  }\n  return next();\n}\n\nfunction handleCloseContextMenu(controller: Controller) {\n  const { data } = controller.value;\n  if (data.contextData) {\n    dispatchCustomEvent(LEGAL_EVENT.contextMenuVisible, { visible: false });\n    if (controller.enableHots || controller.isPendingEnable) {\n      // BACKGROUND: 右键菜单全选时，形成的 op 序列是：\n      // -- set_selection -- set_data --\n      // 导致无法匹配选区 pending 的模式，因此将隐藏菜单的变更滞后\n      // -- set_selection -- pending -- set_data -- ...\n      setTimeout(() => {\n        controller.setData({\n          ...data,\n          contextData: null,\n        });\n      }, 0);\n    } else {\n      controller.setData({\n        ...data,\n        contextData: null,\n      });\n    }\n  }\n}\n\nexport const biFactory: BiFactory = (configs) => {\n  const pcContextMenu = configs?.pcContextMenu || {};\n  function handleContextMenu(\n    event: React.MouseEvent,\n    controller: Controller,\n    next,\n  ) {\n    event.preventDefault();\n    const contextData = {\n      x: event.clientX,\n      y: event.clientY,\n    };\n    // 如果右键的时候，当前选区选中了一个 void，则选中这个 void 元素\n    const { selection, document } = controller.value;\n    if (selection.isCollapsed) {\n      const { anchor: point } = selection;\n      const voidParent = document.getClosestVoid(point.key, controller);\n      if (voidParent) {\n        const anchor = controller.query(Queries.pointAtDistance, point, -1);\n        const focus = controller.query(Queries.pointAtDistance, point, 1);\n        const newSelection = Selection.create({ anchor, focus });\n        controller.run(\n          'onCangjieSelect',\n          CangjieSelectEvent({\n            selection: newSelection,\n          }),\n        );\n      }\n    }\n    const { data } = controller.value;\n    dispatchCustomEvent(LEGAL_EVENT.contextMenuVisible, { visible: true });\n    controller.setData({\n      ...data,\n      contextData,\n    });\n    controller.run('onAction', openContextMenu());\n    return next();\n  }\n  function handleMouseDown(\n    event: React.MouseEvent,\n    controller: Controller,\n    next,\n  ) {\n    handleCloseContextMenu(controller);\n    return next();\n  }\n\n  function renderEditable(_, controller, next) {\n    return (\n      <React.Fragment>\n        {next()}\n        <ContextMenu {...pcContextMenu} />\n      </React.Fragment>\n    );\n  }\n  return {\n    key,\n    onAction: handleAction,\n    onContextMenu: handleContextMenu,\n    onMouseDown: handleMouseDown,\n    renderEditable,\n    models: [],\n  };\n}\n"],"file":"index.js"}