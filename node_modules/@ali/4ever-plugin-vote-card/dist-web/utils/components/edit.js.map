{"version":3,"sources":["../../../../src/utils/components/edit.tsx"],"names":["React","useCallback","useMemo","useEffect","useState","useRef","environment","classnames","orderBy","produce","dayjs","ToolbarAddNormal","SelectArrowDownNormalNormal","DragallNormal","ToolbarDeleteNormal","Select","DatePicker","Button","EnumVoteType","EnumModifyType","cancelEditing","voteSave","ContainerWrapper","ContainerEditWrapper","DatePickerWrapper","InputTitleWrapper","InputContentWrapper","InputPrefixWrapper","Separator","InputSuffixWrapper","Option","MAX_OPTIONS_LENGTH","Edit","memo","props","controller","node","locale","isSelected","data","setData","titleRef","optionRef","modifyData","voteId","optionInfoList","modifyList","optionHeightRef","draggingObj","form","setForm","state","draft","options","handleCancel","run","collectModifyData","realData","current","forEach","item","addOptions","filter","optionId","content","map","operationType","ADD","handleBlurContent","index","e","persist","target","collectModifyKey","MODIFY","value","handleContentChange","key","id","type","DELETE","push","MOVE","pos","includes","handleTitleChange","title","handleAdd","length","userOptionTicket","optionTicket","handleRemove","_","i","handleSave","handleDragStart","dragging","rect","getBoundingClientRect","offset","optionsRect","height","handleDragOver","targetRect","top","handleClickShowTicket","showTicketBeforeVoting","handleChangeEndTime","endTime","valueOf","handleVoteTypeChange","voteType","Number","handleDragEnd","finallyIndex","Math","floor","targetIndex","max","min","temp","saveDisable","currentDate","disabledDate","date","add","totalVoteCount","width","String","RADIO","radio","CHECKBOX","checkbox","titlePlaceholder","stopPropagation","preventDefault","IS_SAFARI","optionPlaceholder","disabled","v","deadline","format","noDeadline","resultShow","afterVote","always","checked","Boolean","cancel","save"],"mappings":"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","sourcesContent":["import React, { useCallback, useMemo, useEffect, useState, useRef } from 'react';\nimport { environment } from '@ali/4ever-cangjie';\nimport { Block, Controller } from '@ali/4ever-cangjie';\nimport classnames from 'classnames';\nimport { orderBy } from 'lodash-es';\nimport produce from 'immer';\nimport dayjs from 'dayjs';\nimport { ToolbarAddNormal, SelectArrowDownNormalNormal, DragallNormal, ToolbarDeleteNormal } from '@ali/we-icon';\nimport { Select, DatePicker } from '@ali/we-design';\nimport { Button } from '@ali/we-design-next';\nimport type { VotePluginConfig, IVoteData, IModifyOptionInfo } from '../types';\nimport { EnumVoteType, EnumModifyType } from '../types';\nimport { cancelEditing, voteSave } from '../actions';\nimport {\n  ContainerWrapper, ContainerEditWrapper,\n  DatePickerWrapper, InputTitleWrapper, InputContentWrapper,\n  InputPrefixWrapper, Separator, InputSuffixWrapper,\n} from './styled';\n\nconst { Option } = Select;\n\nconst MAX_OPTIONS_LENGTH = 50;\n\ntype DraggingProps = {\n  index: number;\n  offset: number;\n  rect: {\n    [x: string]: number;\n  };\n};\n\ninterface IModifyData {\n  voteId?: string;\n  optionInfoList: IModifyOptionInfo[];\n}\n\ninterface IProps {\n  node: Block;\n  locale: VotePluginConfig['locale'];\n  controller: Controller;\n  isSelected?: boolean;\n  data: IVoteData;\n  setData: React.Dispatch<React.SetStateAction<IVoteData>>;\n}\n\nconst Edit: React.FC<IProps> = React.memo((props: IProps) => {\n  const { controller, node, locale, isSelected, data, setData } = props;\n  const titleRef = useRef<HTMLInputElement>(null);\n  const optionRef = useRef<HTMLDivElement>(null);\n  const modifyData = useRef<IModifyData>({\n    voteId: data.voteId,\n    optionInfoList: [],\n  });\n  const modifyList = useRef<string[]>([]);\n  const optionHeightRef = useRef<number>(0);\n  const draggingObj = useRef<DraggingProps>();\n  // @ts-ignore\n  const [form, setForm] = useState<IVoteData>(data as IVoteData);\n\n  useEffect(() => {\n    // isSelected && titleRef.current?.focus();\n  }, [isSelected]);\n\n  useEffect(() => {\n    setForm((state) => {\n      return produce(state, (draft) => {\n        // eslint-disable-next-line @typescript-eslint/no-unused-vars\n        draft = data;\n      });\n    });\n  }, [data]);\n\n  const options = useMemo(() => {\n    return orderBy(form.optionInfoList, 'pos');\n  }, [form]);\n\n  const handleCancel = useCallback(() => {\n    controller.run('onAction', cancelEditing(node, data));\n  }, []);\n\n  const collectModifyData = useCallback((realData) => {\n    if (!realData.voteId) return;\n    // title, voteType, endTime, showTicketBeforeVoting 变化\n    modifyList.current.forEach(item => {\n      if (realData[item] !== form[item]) {\n        modifyData.current[item] = form[item];\n      }\n    });\n\n    const addOptions = form.optionInfoList.filter(item => !item.optionId && item.content);\n    modifyData.current.optionInfoList = [...(modifyData.current.optionInfoList ?? []),\n      ...addOptions.map((item) => ({ ...item, operationType: EnumModifyType.ADD }))];\n  }, [form]);\n\n  // 内容修改结束\n  const handleBlurContent = useCallback((index, e: React.ChangeEvent<HTMLInputElement>) => {\n    e.persist();\n    const target = options[index];\n    collectModifyKey('optionInfo', target.optionId, EnumModifyType.MODIFY, e.target.value);\n  }, [options]);\n\n  // 内容修改\n  const handleContentChange = useCallback((index, e: React.ChangeEvent<HTMLInputElement>) => {\n    e.persist();\n    setForm((state) => {\n      return produce(state, (draft) => {\n        draft.optionInfoList[index].content = e.target?.value;\n      });\n    });\n  }, [options]);\n\n  // 收集修改内容的 key\n  const collectModifyKey = useCallback((key: string, id?: number, type?: EnumModifyType, content?: string | number) => {\n    // 如果是新增投票，不用收集差异数据\n    if (!data.voteId) return;\n    if (key === 'optionInfo') {\n      if (!id) return;\n      if (type === EnumModifyType.DELETE) {\n        modifyData.current.optionInfoList?.push({ optionId: id, operationType: EnumModifyType.DELETE });\n      } else if (type === EnumModifyType.MODIFY) {\n        content ?\n          modifyData.current.optionInfoList?.push({ optionId: id, operationType: EnumModifyType.MODIFY, content: content! as string })\n          : modifyData.current.optionInfoList?.push({ optionId: id, operationType: EnumModifyType.DELETE });\n      } else if (type === EnumModifyType.MOVE) {\n        modifyData.current.optionInfoList?.push({ optionId: id, operationType: EnumModifyType.MOVE, pos: content! as number });\n      }\n\n      return;\n    }\n\n    if (!modifyList.current.includes(key)) {\n      modifyList.current.push(key);\n    }\n  }, [data]);\n\n  // 标题修改\n  const handleTitleChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {\n    e.persist();\n    collectModifyKey('title');\n    setForm((state) => {\n      return produce(state, (draft) => {\n        draft.title = e.target?.value;\n      });\n    });\n  }, []);\n\n  // 添加\n  const handleAdd = useCallback(() => {\n    if (form.optionInfoList.length >= MAX_OPTIONS_LENGTH) {\n      return;\n    }\n    setForm((state) => {\n      return produce(state, (draft) => {\n        draft.optionInfoList =\n          [...state.optionInfoList,\n            {\n              content: '',\n              pos: state.optionInfoList[state.optionInfoList.length - 1].pos + 1,\n              userOptionTicket: 0,\n              optionTicket: 0,\n            },\n          ];\n      });\n    });\n  }, [form]);\n\n  // 删除\n  const handleRemove = useCallback((index: number) => {\n    const target = options[index];\n    collectModifyKey('optionInfo', target.optionId, EnumModifyType.DELETE);\n    setForm((state) => {\n      return produce(state, (draft) => {\n        draft.optionInfoList = state.optionInfoList.filter((_, i) => index !== i);\n      });\n    });\n  }, [form]);\n\n  const handleSave = useCallback(async () => {\n    collectModifyData(data);\n\n    controller.run('onAction', voteSave({\n      node,\n      data: data.voteId ? modifyData.current as IVoteData : {\n        ...form,\n        optionInfoList: form.optionInfoList.filter(({ content }) => content),\n      },\n      setData,\n    }));\n  }, [node, form, data.voteId]);\n\n  const handleDragStart = useCallback((e, index: number) => {\n    const dragging = e.target;\n    draggingObj.current = {\n      index,\n      rect: dragging.getBoundingClientRect(),\n      offset: 0,\n    };\n  }, []);\n\n  /** 计算 options 的单位高度 */\n  useEffect(() => {\n    if (!optionRef.current) return;\n    const optionsRect = optionRef.current.getBoundingClientRect();\n    optionHeightRef.current = optionsRect.height / form.optionInfoList.length;\n  }, [form.optionInfoList]);\n\n  const handleDragOver = useCallback((e) => {\n    if (!draggingObj.current) return;\n    const target = e.target;\n    const targetRect = target.getBoundingClientRect();\n    draggingObj.current.offset = targetRect.top - draggingObj.current.rect.top;\n  }, []);\n\n  const handleClickShowTicket = useCallback(() => {\n    collectModifyKey('showTicketBeforeVoting');\n    setForm((state) => {\n      return produce(state, draft => {\n        draft.showTicketBeforeVoting = !state.showTicketBeforeVoting;\n      });\n    });\n  }, []);\n\n  const handleChangeEndTime = useCallback((e) => {\n    collectModifyKey('endTime');\n    setForm((state) => {\n      return produce(state, draft => {\n        draft.endTime = dayjs(e).valueOf();\n      });\n    });\n  }, []);\n\n  const handleVoteTypeChange = useCallback((e) => {\n    collectModifyKey('voteType');\n    setForm((state) => {\n      return produce(state, draft => {\n        draft.voteType = Number(e);\n      });\n    });\n  }, []);\n\n  // 拖拽后排序\n  const handleDragEnd = useCallback(() => {\n    if (!draggingObj.current) return;\n\n    const { index, offset } = draggingObj.current;\n\n    const finallyIndex = index + Math.floor(offset / optionHeightRef.current);\n    const targetIndex = Math.max(0, Math.min(finallyIndex, options.length - 1));\n\n    // 位置未发生变化\n    if (targetIndex === index) return;\n\n    setForm((state) => {\n      return produce(state, draft => {\n        const temp = orderBy(state.optionInfoList, 'pos').map((item, i) => {\n          if (i !== index) return item;\n\n          let pos = item.pos;\n          if (targetIndex === 0) {\n            // 拖拽到第一位\n            pos = state.optionInfoList[0].pos / 2;\n          } else if (targetIndex === state.optionInfoList.length - 1) {\n            // 拖拽到最后\n            pos = state.optionInfoList[state.optionInfoList.length - 1].pos + 1;\n          } else {\n            // 拖拽到中间位置\n            pos = (state.optionInfoList[targetIndex].pos + state.optionInfoList[targetIndex - 1].pos) / 2;\n          }\n\n          collectModifyKey('optionInfo', item.optionId, EnumModifyType.MOVE, pos);\n\n          return {\n            ...item,\n            pos,\n          };\n        });\n\n        draft.optionInfoList = [...orderBy(temp, 'pos')];\n      });\n    });\n  }, [options]);\n\n  const saveDisable = useMemo(() => {\n    // title 不能为空\n    if (!form.title) return true;\n    if (form.optionInfoList.filter(item => item.content).length < 2) return true;\n    return false;\n  }, [form]);\n\n  const currentDate = dayjs();\n  const disabledDate = useCallback((date) => {\n    if (!date) {\n      return false;\n    }\n    return date.valueOf() <= currentDate.add(-1, 'day').valueOf();\n  }, []);\n  return (\n    <ContainerWrapper\n      isSelected={isSelected}\n      data-cangjie-not-editable\n      data-role=\"vote\"\n      data-testid=\"card-vote-container-edit\"\n    >\n      <ContainerEditWrapper>\n        <div className=\"editing-header\">\n          <InputPrefixWrapper>\n            <Select\n              disabled={data.totalVoteCount > 0}\n              style={{ width: '60px' }}\n              value={String(form.voteType)}\n              onChange={handleVoteTypeChange}\n              testid=\"test\"\n              styleType=\"toolbar\"\n            >\n              <Option key=\"radio\" value={String(EnumVoteType.RADIO)} >{locale?.radio}</Option>\n              <Option key=\"checkbox\" value={String(EnumVoteType.CHECKBOX)} >{locale?.checkbox}</Option>\n            </Select>\n            <Separator />\n          </InputPrefixWrapper>\n          <InputTitleWrapper\n            data-testid=\"card-vote-edit-title\"\n            ref={titleRef}\n            type=\"text\"\n            onChange={handleTitleChange}\n            value={form.title}\n            maxLength={100}\n            placeholder={locale?.titlePlaceholder}\n          />\n        </div>\n        <div className=\"editing-options\" data-testid=\"card-vote-edit-options\" ref={optionRef}>\n          {\n            options.map((item, index) =>\n              (\n                <div\n                  key={item.optionId || index}\n                  draggable={form.optionInfoList.length > 1}\n                  onDragEnd={handleDragEnd}\n                  onDragOver={handleDragOver}\n                  onDragStart={(e) => handleDragStart(e, index)}\n                >\n                  <span\n                    className={\n                      classnames({\n                        'drag-icon': form.optionInfoList.length > 1,\n                      })\n                    }\n                  >\n                    <DragallNormal />\n                  </span>\n                  <InputContentWrapper\n                    onDragStart={e => { e.stopPropagation(); e.preventDefault(); }}\n                    draggable={!environment.IS_SAFARI}\n                    type=\"text\"\n                    value={item.content}\n                    maxLength={100}\n                    onChange={(e) => handleContentChange(index, e)}\n                    onBlur={(e) => handleBlurContent(index, e)}\n                    placeholder={`${locale?.optionPlaceholder} ${index + 1}`}\n                  />\n                  <InputSuffixWrapper>\n                    {\n                      options.length > 2 &&\n                      <ToolbarDeleteNormal onClick={() => handleRemove(index)} />\n                    }\n                  </InputSuffixWrapper>\n                </div>\n              ))\n          }\n        </div>\n        <div\n          className={classnames({\n            'editing-add': true,\n            disabled: options.length >= MAX_OPTIONS_LENGTH,\n          })}\n          onClick={handleAdd}\n        >\n          <ToolbarAddNormal />\n          {locale?.add}\n        </div>\n        <div className=\"editing-datepicker\">\n          <DatePicker\n            showTime\n            disabledDate={disabledDate}\n            renderTrigger={(v) => {\n              return (\n                <DatePickerWrapper>\n                  {locale?.deadline}\n                  <span>\n                    {v ? v.format('YYYY-MM-DD HH:mm:ss') : locale?.noDeadline}\n                  </span>\n                  <SelectArrowDownNormalNormal />\n                </DatePickerWrapper>\n              );\n            }}\n            defaultValue={dayjs(form.endTime)}\n            onChange={handleChangeEndTime}\n            style={{ width: 280 }}\n            testid=\"DatePicker\"\n            locale=\"ja\"\n            allowClear\n          />\n        </div>\n        <div className=\"editing-footer\">\n          <span>{locale?.resultShow}</span>\n          {[locale?.afterVote, locale?.always].map(((item, index) => (\n            <div onClick={handleClickShowTicket}>\n              <span className={classnames({\n                checked: form.showTicketBeforeVoting === Boolean(index),\n              })}\n              />\n              {item}\n            </div>\n          )))}\n          <div>\n            <Button onClick={handleCancel}>{locale?.cancel}</Button>\n            <Button data-role=\"create\" disabled={saveDisable} type=\"primary\" onClick={handleSave}>{locale?.save}</Button>\n          </div>\n        </div>\n      </ContainerEditWrapper>\n    </ContainerWrapper>\n  );\n});\n\nexport default Edit;\n"],"file":"edit.js"}