{"version":3,"sources":["../../../../src/utils/components/container.tsx"],"names":["React","useMemo","useState","useEffect","useCallback","SpinErrorCard","SpinCard","produce","VoteNormal","Voting","Result","Edit","voteSaveCP","styleCard","padding","minHeight","Container","props","locale","controller","node","isSelected","getVote","onSocketMsg","isPublish","readOnly","data","metadata","setData","isEditStatus","query","isNewVote","voteId","isUserUnTicketed","optionInfoList","filter","userOptionTicket","length","updateVoteData","payload","console","warn","isServiceError","run","key","state","draft","loading","err","remove","submit","serviceErrorMsg","isVotingStatus","hasEnded","totalVoteCount","showTicketBeforeVoting"],"mappings":"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","sourcesContent":["import React, { useMemo, useState, useEffect, useCallback } from 'react';\nimport { Block, Controller } from '@ali/4ever-cangjie';\nimport { SpinErrorCard, SpinCard } from '@ali/we-design';\nimport produce from 'immer';\nimport { VoteNormal } from '@ali/we-icon';\nimport Voting from './voting';\nimport Result from './result';\nimport Edit from './edit';\nimport { voteSaveCP } from '../actions';\nimport type { VotePluginConfig, IVoteData } from '../types';\n\nconst styleCard: React.CSSProperties = {\n  padding: '20px',\n  minHeight: '140px',\n};\ninterface IProps {\n  locale: VotePluginConfig['locale'];\n  node: Block;\n  controller: Controller;\n  isSelected?: boolean;\n  getVote?: (id: number, callback: React.Dispatch<React.SetStateAction<IVoteData>>) => void;\n  onSocketMsg: (updateFunc: () => void) => Function;\n  isPublish?: boolean;\n  readOnly?: boolean;\n}\n\nconst Container: React.FC<IProps> = (props: IProps) => {\n  const { locale, controller, node, isSelected, getVote, onSocketMsg, isPublish, readOnly } = props;\n  const [data, setData] = useState<IVoteData>(node.data.metadata as IVoteData);\n  const isEditStatus = controller.query('isVoteCardEditingStatus', { node });\n\n  const isNewVote = useMemo(() => !node.data.metadata.voteId, [node]);\n\n  const isUserUnTicketed = useMemo(() => data.optionInfoList?.filter(({ userOptionTicket }) => userOptionTicket !== 0).length !== 0, [data]);\n\n  const updateVoteData = useCallback((payload?) => {\n    if (!getVote) {\n      console.warn('Missing `getVote`');\n      return;\n    }\n\n    const voteId = node.data.metadata.voteId;\n    if (!data.isServiceError) {\n      controller.run('onAction', voteSaveCP(node.key, data));\n    }\n    if (!payload) {\n      setData((state) => {\n        return produce(state, draft => {\n          draft.loading = true;\n        });\n      });\n      getVote(voteId, setData);\n      return;\n    }\n\n    if (isEditStatus || isNewVote) return;\n    if (payload.payload.voteId !== voteId) return;\n    // 协同时，直接更新数据，不需要 loading，避免闪动\n    // setData((state) => {\n    //   return produce(state, draft => {\n    //     draft.loading = true;\n    //   });\n    // });\n    getVote(voteId, setData);\n  }, [node, isEditStatus, isNewVote]);\n\n  useEffect(() => {\n    // 如果是新创建的投票，返回默认数据\n    if (isNewVote) {\n      setData(node.data.metadata);\n      return;\n    }\n\n    if (getVote) {\n      try {\n        updateVoteData();\n      } catch (err) {\n        // 如果数据请求失败，取 cp 中的数据，在公开发布场景下适用\n        setData(node.data.metadata);\n      }\n    }\n  }, [isNewVote, controller]);\n\n  useEffect(() => {\n    const remove = onSocketMsg && onSocketMsg(updateVoteData)();\n    return () => {\n      remove && remove();\n    };\n  }, [onSocketMsg]);\n\n  if (data.loading) {\n    return (\n      <SpinCard style={styleCard} size=\"medium\" />\n    );\n  }\n\n\n  if (data.isServiceError) {\n    return (\n      <SpinErrorCard\n        style={styleCard}\n        icon={<VoteNormal />}\n        title={locale?.submit}\n        highlightIcon\n        tip={data.serviceErrorMsg}\n        role=\"spin-card\"\n        onRefresh={() => {\n          updateVoteData();\n        }}\n      />\n    );\n  }\n\n  // 公开发布等只读场景\n  if (isPublish) {\n    // 投票结果页\n    return (\n      <Result\n        data={data}\n        node={node}\n        locale={locale}\n        controller={controller}\n        isSelected={isSelected}\n        readOnly={readOnly}\n      />\n    );\n  }\n\n  // 编辑状态\n  if (isEditStatus || isNewVote) {\n    return (\n      <Edit\n        data={data}\n        node={node}\n        controller={controller}\n        locale={locale}\n        setData={setData}\n        isSelected={isSelected}\n      />\n    );\n  }\n\n  // 点击重新发起投票，此时是一个内存态\n  const isVotingStatus = controller.query('isVoteCardVotingStatus', { node });\n\n  if (isVotingStatus ||\n    (!data.hasEnded &&\n    // 始终可见，无人投\n    (\n      (data.totalVoteCount === 0 && data.showTicketBeforeVoting) ||\n      // 投票后可见，我未投\n    (!data.showTicketBeforeVoting && !isUserUnTicketed)\n    ))) {\n    // 投票状态\n    return (\n      <Voting\n        data={data}\n        node={node}\n        locale={locale}\n        controller={controller}\n        isSelected={isSelected}\n        setData={setData}\n        readOnly={readOnly}\n      />\n    );\n  }\n\n  // 投票结果页\n  return (\n    <Result\n      data={data}\n      node={node}\n      locale={locale}\n      controller={controller}\n      isSelected={isSelected}\n      readOnly={readOnly}\n    />\n  );\n};\n\nexport default Container;\n"],"file":"container.js"}