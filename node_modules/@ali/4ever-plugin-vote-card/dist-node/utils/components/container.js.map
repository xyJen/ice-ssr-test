{"version":3,"sources":["../../../../src/utils/components/container.tsx"],"names":["styleCard","padding","minHeight","Container","props","locale","controller","node","isSelected","getVote","onSocketMsg","isPublish","readOnly","data","setData","metadata","isEditStatus","query","isNewVote","voteId","isUserUnTicketed","optionInfoList","filter","userOptionTicket","length","updateVoteData","payload","console","warn","isServiceError","run","key","state","draft","loading","err","remove","submit","serviceErrorMsg","isVotingStatus","hasEnded","totalVoteCount","showTicketBeforeVoting"],"mappings":"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","sourcesContent":["import React, { useMemo, useState, useEffect, useCallback } from 'react';\nimport { Block, Controller } from '@ali/4ever-cangjie';\nimport { SpinErrorCard, SpinCard } from '@ali/we-design';\nimport produce from 'immer';\nimport { VoteNormal } from '@ali/we-icon';\nimport Voting from './voting';\nimport Result from './result';\nimport Edit from './edit';\nimport { voteSaveCP } from '../actions';\nimport type { VotePluginConfig, IVoteData } from '../types';\n\nconst styleCard: React.CSSProperties = {\n  padding: '20px',\n  minHeight: '140px',\n};\ninterface IProps {\n  locale: VotePluginConfig['locale'];\n  node: Block;\n  controller: Controller;\n  isSelected?: boolean;\n  getVote?: (id: number, callback: React.Dispatch<React.SetStateAction<IVoteData>>) => void;\n  onSocketMsg: (updateFunc: () => void) => Function;\n  isPublish?: boolean;\n  readOnly?: boolean;\n}\n\nconst Container: React.FC<IProps> = (props: IProps) => {\n  const { locale, controller, node, isSelected, getVote, onSocketMsg, isPublish, readOnly } = props;\n  const [data, setData] = useState<IVoteData>(node.data.metadata as IVoteData);\n  const isEditStatus = controller.query('isVoteCardEditingStatus', { node });\n\n  const isNewVote = useMemo(() => !node.data.metadata.voteId, [node]);\n\n  const isUserUnTicketed = useMemo(() => data.optionInfoList?.filter(({ userOptionTicket }) => userOptionTicket !== 0).length !== 0, [data]);\n\n  const updateVoteData = useCallback((payload?) => {\n    if (!getVote) {\n      console.warn('Missing `getVote`');\n      return;\n    }\n\n    const voteId = node.data.metadata.voteId;\n    if (!data.isServiceError) {\n      controller.run('onAction', voteSaveCP(node.key, data));\n    }\n    if (!payload) {\n      setData((state) => {\n        return produce(state, draft => {\n          draft.loading = true;\n        });\n      });\n      getVote(voteId, setData);\n      return;\n    }\n\n    if (isEditStatus || isNewVote) return;\n    if (payload.payload.voteId !== voteId) return;\n    // 协同时，直接更新数据，不需要 loading，避免闪动\n    // setData((state) => {\n    //   return produce(state, draft => {\n    //     draft.loading = true;\n    //   });\n    // });\n    getVote(voteId, setData);\n  }, [node, isEditStatus, isNewVote]);\n\n  useEffect(() => {\n    // 如果是新创建的投票，返回默认数据\n    if (isNewVote) {\n      setData(node.data.metadata);\n      return;\n    }\n\n    if (getVote) {\n      try {\n        updateVoteData();\n      } catch (err) {\n        // 如果数据请求失败，取 cp 中的数据，在公开发布场景下适用\n        setData(node.data.metadata);\n      }\n    }\n  }, [isNewVote, controller]);\n\n  useEffect(() => {\n    const remove = onSocketMsg && onSocketMsg(updateVoteData)();\n    return () => {\n      remove && remove();\n    };\n  }, [onSocketMsg]);\n\n  if (data.loading) {\n    return (\n      <SpinCard style={styleCard} size=\"medium\" />\n    );\n  }\n\n\n  if (data.isServiceError) {\n    return (\n      <SpinErrorCard\n        style={styleCard}\n        icon={<VoteNormal />}\n        title={locale?.submit}\n        highlightIcon\n        tip={data.serviceErrorMsg}\n        role=\"spin-card\"\n        onRefresh={() => {\n          updateVoteData();\n        }}\n      />\n    );\n  }\n\n  // 公开发布等只读场景\n  if (isPublish) {\n    // 投票结果页\n    return (\n      <Result\n        data={data}\n        node={node}\n        locale={locale}\n        controller={controller}\n        isSelected={isSelected}\n        readOnly={readOnly}\n      />\n    );\n  }\n\n  // 编辑状态\n  if (isEditStatus || isNewVote) {\n    return (\n      <Edit\n        data={data}\n        node={node}\n        controller={controller}\n        locale={locale}\n        setData={setData}\n        isSelected={isSelected}\n      />\n    );\n  }\n\n  // 点击重新发起投票，此时是一个内存态\n  const isVotingStatus = controller.query('isVoteCardVotingStatus', { node });\n\n  if (isVotingStatus ||\n    (!data.hasEnded &&\n    // 始终可见，无人投\n    (\n      (data.totalVoteCount === 0 && data.showTicketBeforeVoting) ||\n      // 投票后可见，我未投\n    (!data.showTicketBeforeVoting && !isUserUnTicketed)\n    ))) {\n    // 投票状态\n    return (\n      <Voting\n        data={data}\n        node={node}\n        locale={locale}\n        controller={controller}\n        isSelected={isSelected}\n        setData={setData}\n        readOnly={readOnly}\n      />\n    );\n  }\n\n  // 投票结果页\n  return (\n    <Result\n      data={data}\n      node={node}\n      locale={locale}\n      controller={controller}\n      isSelected={isSelected}\n      readOnly={readOnly}\n    />\n  );\n};\n\nexport default Container;\n"],"file":"container.js"}