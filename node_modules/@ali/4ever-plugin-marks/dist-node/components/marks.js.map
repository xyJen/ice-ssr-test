{"version":3,"sources":["../../../src/components/marks.tsx"],"names":["inlineCodeTheme_BGCOLOR","inlineCodeTheme","fillStyle","options","style","mark","disableHighlight","type","data","value","fontWeight","color","fontFamily","fontRenderFallback","getFontFallback","backgroundColor","ShdUtil","transformShd","fontStyle","UnderlineUtil","setTextDecotation","fontSize","SzUtil","fromMark","FONTSIZE_BIGGER","vertAlign","verticalAlign","padding","margin","border","borderRadius","wordBreak","isComma","WebkitTextEmphasisStyle","WebkitTextEmphasisPosition","textTransform","fontVariantCaps","letterSpacing","marksToStyle","marks","ops","reduce","kernMark","find","m","hasInlineCode","some","sz","parseFloat","DEFAULT","fontKerning","Object","keys","GRADIENT_COLOR_STYLE","forEach","gradientStyle","GRADIENT_STYLE_FLAG","paddingRight","marginRight","setStyleWithMark","MarksOptionContext","React","createContext","MarksComponent","props","marksOption","useContext","children","useMemo","onlyChild","Children","only","cloneElement"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { Mark } from '@ali/4ever-cangjie';\nimport { inlineCodeTheme } from '@ali/4ever-utils';\nimport { fontSize } from '@ali/4ever-utils';\nimport {\n  SzUtil,\n  ShdUtil,\n  UnderlineUtil,\n  fontRenderFallback,\n  GRADIENT_COLOR_STYLE,\n  GRADIENT_STYLE_FLAG,\n  isGradientColor,\n  setGradientStyle,\n  shouldDegradeGradient,\n} from '@ali/4ever-utils';\n\n\nconst inlineCodeTheme_BGCOLOR = inlineCodeTheme['background-color'];\ninterface FillStyleOptions {\n  disableHighlight?: boolean;\n}\n\nconst fillStyle = (options?: FillStyleOptions) => (style: React.CSSProperties, mark: Mark) => {\n  const disableHighlight = options?.disableHighlight;\n  if (mark.type === 'bold') {\n    if (mark.data.value === false) {\n      style.fontWeight = 'normal';\n    } else {\n      style.fontWeight = 'bold';\n    }\n  } else if (mark.type === 'color') {\n    const { value } = mark.data;\n    if (isGradientColor(value)) {\n      setGradientStyle(value, style);\n    } else {\n      style.color = value;\n    }\n  } else if (mark.type === 'fonts') {\n    style.fontFamily = fontRenderFallback.getFontFallback(mark);\n  } else if (mark.type === 'highlight') {\n    if (!disableHighlight && mark.data.value !== 'transparent') {\n      style.backgroundColor = mark.data.value;\n    }\n  } else if (mark.type === 'shd') {\n    if (!disableHighlight) {\n      // shd 优先级更低（highlight 直接覆盖）\n      style.backgroundColor = style.backgroundColor || ShdUtil.transformShd(mark.data);\n    }\n  } else if (mark.type === 'italic') {\n    style.fontStyle = 'italic';\n  } else if (\n    mark.type === 'underline' ||\n    mark.type === 'strike' ||\n    mark.type === 'dstrike'\n  ) {\n    UnderlineUtil.setTextDecotation(style, mark.type, mark);\n  } else if (mark.type === 'sz') {\n    // 最终呈现需要在移动端考虑放大sz\n    style.fontSize = `${SzUtil.fromMark(mark) * SzUtil.FONTSIZE_BIGGER}pt`;\n  } else if (mark.type === 'vertAlign') {\n    const vertAlign = mark.data.value;\n    // TODO: 字号较大时与 word 存在较大差异\n    if (vertAlign === 'superscript') {\n      style.verticalAlign = 'super';\n    } else if (vertAlign === 'subscript') {\n      style.verticalAlign = 'sub';\n    }\n  } else if (mark.type === 'inlineCode') {\n    style.padding = inlineCodeTheme.padding;\n    style.margin = inlineCodeTheme.margin;\n    style.border = inlineCodeTheme.border;\n    style.borderRadius = inlineCodeTheme['border-radius'];\n    style.fontFamily = inlineCodeTheme['font-family'];\n    style.wordBreak = inlineCodeTheme['word-break'] as any;\n  } else if (mark.type === 'em' && mark.data.value) {\n    const isComma = mark.data.value === 'comma';\n    style.WebkitTextEmphasisStyle = isComma ? 'sesame' : mark.data.value;\n    style.WebkitTextEmphasisPosition = isComma ? 'over' : 'under';\n  } else if (mark.type === 'caps') {\n    if (mark.data.value) {\n      style.textTransform = 'uppercase';\n    }\n  } else if (mark.type === 'smallCaps') {\n    style.fontVariantCaps = 'small-caps';\n  }\n  if (mark.type === 'spacing' && mark.data.value) {\n    style.letterSpacing = `${mark.data.value * 2}pt`;\n  }\n  return style;\n};\n\nexport function marksToStyle(marks: Mark[], ops?: FillStyleOptions) {\n  const style = marks.reduce(fillStyle(ops), {});\n\n  const kernMark = marks.find((m) => m.type === 'kern');\n  const hasInlineCode = marks.some((m) => m.type === 'inlineCode');\n\n  if (hasInlineCode) {\n    // 背景色以 行内代码 为准\n    style.backgroundColor = inlineCodeTheme_BGCOLOR;\n  }\n\n  if (style.verticalAlign || kernMark) {\n    const sz = parseFloat(`${style.fontSize}`) || fontSize.DEFAULT;\n    if (style.verticalAlign) {\n      // 上下标字号减半\n      style.fontSize = `${sz / 2 }pt`;\n    }\n    if (kernMark && (kernMark.data.value === 0 || sz < kernMark.data.value)) {\n      // 禁止 kerning\n      style.fontKerning = 'none';\n    }\n  }\n\n  if (shouldDegradeGradient(style)) {\n    // 渐变色和删除线有冲突，设置删除线时渐变色退化为第一个颜色\n    Object.keys(GRADIENT_COLOR_STYLE)\n      .forEach((gradientStyle) => delete style[gradientStyle]);\n  }\n\n  // 斜体渐变色右边缘可能被截断, 当斜体和渐变色同时存在时设置右边距\n  if (style.fontStyle === 'italic' && GRADIENT_STYLE_FLAG in style) {\n    if (!style.paddingRight && !style.marginRight) {\n      style.paddingRight = '0.2em';\n      style.marginRight = '-0.2em';\n    }\n  }\n\n  return style;\n}\n\nexport const setStyleWithMark = fillStyle();\n\nexport const MarksOptionContext = React.createContext({ disableHighlight: false });\n\nexport function MarksComponent(props) {\n  const marksOption = React.useContext(MarksOptionContext);\n  const { marks, children } = props;\n  // memo style (marks not always change, eg: selection change)\n  const style = React.useMemo(() => {\n    return marksToStyle(marks, marksOption);\n  }, [marks, marksOption]);\n\n  const hasInlineCode = React.useMemo(() => marks.some((mark) => mark.type === 'inlineCode'), [marks]);\n  if (hasInlineCode) {\n    return <code data-cangjie-mark style={style}>{children()}</code>;\n  }\n  const onlyChild = React.Children.only(children());\n\n  return React.cloneElement(onlyChild, { 'data-cangjie-mark': true, style });\n}\n"],"file":"marks.js"}