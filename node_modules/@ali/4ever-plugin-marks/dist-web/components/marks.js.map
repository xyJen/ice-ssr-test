{"version":3,"sources":["../../../src/components/marks.tsx"],"names":["React","inlineCodeTheme","fontSize","SzUtil","ShdUtil","UnderlineUtil","fontRenderFallback","GRADIENT_COLOR_STYLE","GRADIENT_STYLE_FLAG","isGradientColor","setGradientStyle","shouldDegradeGradient","inlineCodeTheme_BGCOLOR","fillStyle","options","style","mark","disableHighlight","type","data","value","fontWeight","color","fontFamily","getFontFallback","backgroundColor","transformShd","fontStyle","setTextDecotation","fromMark","FONTSIZE_BIGGER","vertAlign","verticalAlign","padding","margin","border","borderRadius","wordBreak","isComma","WebkitTextEmphasisStyle","WebkitTextEmphasisPosition","textTransform","fontVariantCaps","letterSpacing","marksToStyle","marks","ops","reduce","kernMark","find","m","hasInlineCode","some","sz","parseFloat","DEFAULT","fontKerning","Object","keys","forEach","gradientStyle","paddingRight","marginRight","setStyleWithMark","MarksOptionContext","createContext","MarksComponent","props","marksOption","useContext","children","useMemo","onlyChild","Children","only","cloneElement"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { Mark } from '@ali/4ever-cangjie';\nimport { inlineCodeTheme } from '@ali/4ever-utils';\nimport { fontSize } from '@ali/4ever-utils';\nimport {\n  SzUtil,\n  ShdUtil,\n  UnderlineUtil,\n  fontRenderFallback,\n  GRADIENT_COLOR_STYLE,\n  GRADIENT_STYLE_FLAG,\n  isGradientColor,\n  setGradientStyle,\n  shouldDegradeGradient,\n} from '@ali/4ever-utils';\n\n\nconst inlineCodeTheme_BGCOLOR = inlineCodeTheme['background-color'];\ninterface FillStyleOptions {\n  disableHighlight?: boolean;\n}\n\nconst fillStyle = (options?: FillStyleOptions) => (style: React.CSSProperties, mark: Mark) => {\n  const disableHighlight = options?.disableHighlight;\n  if (mark.type === 'bold') {\n    if (mark.data.value === false) {\n      style.fontWeight = 'normal';\n    } else {\n      style.fontWeight = 'bold';\n    }\n  } else if (mark.type === 'color') {\n    const { value } = mark.data;\n    if (isGradientColor(value)) {\n      setGradientStyle(value, style);\n    } else {\n      style.color = value;\n    }\n  } else if (mark.type === 'fonts') {\n    style.fontFamily = fontRenderFallback.getFontFallback(mark);\n  } else if (mark.type === 'highlight') {\n    if (!disableHighlight && mark.data.value !== 'transparent') {\n      style.backgroundColor = mark.data.value;\n    }\n  } else if (mark.type === 'shd') {\n    if (!disableHighlight) {\n      // shd 优先级更低（highlight 直接覆盖）\n      style.backgroundColor = style.backgroundColor || ShdUtil.transformShd(mark.data);\n    }\n  } else if (mark.type === 'italic') {\n    style.fontStyle = 'italic';\n  } else if (\n    mark.type === 'underline' ||\n    mark.type === 'strike' ||\n    mark.type === 'dstrike'\n  ) {\n    UnderlineUtil.setTextDecotation(style, mark.type, mark);\n  } else if (mark.type === 'sz') {\n    // 最终呈现需要在移动端考虑放大sz\n    style.fontSize = `${SzUtil.fromMark(mark) * SzUtil.FONTSIZE_BIGGER}pt`;\n  } else if (mark.type === 'vertAlign') {\n    const vertAlign = mark.data.value;\n    // TODO: 字号较大时与 word 存在较大差异\n    if (vertAlign === 'superscript') {\n      style.verticalAlign = 'super';\n    } else if (vertAlign === 'subscript') {\n      style.verticalAlign = 'sub';\n    }\n  } else if (mark.type === 'inlineCode') {\n    style.padding = inlineCodeTheme.padding;\n    style.margin = inlineCodeTheme.margin;\n    style.border = inlineCodeTheme.border;\n    style.borderRadius = inlineCodeTheme['border-radius'];\n    style.fontFamily = inlineCodeTheme['font-family'];\n    style.wordBreak = inlineCodeTheme['word-break'] as any;\n  } else if (mark.type === 'em' && mark.data.value) {\n    const isComma = mark.data.value === 'comma';\n    style.WebkitTextEmphasisStyle = isComma ? 'sesame' : mark.data.value;\n    style.WebkitTextEmphasisPosition = isComma ? 'over' : 'under';\n  } else if (mark.type === 'caps') {\n    if (mark.data.value) {\n      style.textTransform = 'uppercase';\n    }\n  } else if (mark.type === 'smallCaps') {\n    style.fontVariantCaps = 'small-caps';\n  }\n  if (mark.type === 'spacing' && mark.data.value) {\n    style.letterSpacing = `${mark.data.value * 2}pt`;\n  }\n  return style;\n};\n\nexport function marksToStyle(marks: Mark[], ops?: FillStyleOptions) {\n  const style = marks.reduce(fillStyle(ops), {});\n\n  const kernMark = marks.find((m) => m.type === 'kern');\n  const hasInlineCode = marks.some((m) => m.type === 'inlineCode');\n\n  if (hasInlineCode) {\n    // 背景色以 行内代码 为准\n    style.backgroundColor = inlineCodeTheme_BGCOLOR;\n  }\n\n  if (style.verticalAlign || kernMark) {\n    const sz = parseFloat(`${style.fontSize}`) || fontSize.DEFAULT;\n    if (style.verticalAlign) {\n      // 上下标字号减半\n      style.fontSize = `${sz / 2 }pt`;\n    }\n    if (kernMark && (kernMark.data.value === 0 || sz < kernMark.data.value)) {\n      // 禁止 kerning\n      style.fontKerning = 'none';\n    }\n  }\n\n  if (shouldDegradeGradient(style)) {\n    // 渐变色和删除线有冲突，设置删除线时渐变色退化为第一个颜色\n    Object.keys(GRADIENT_COLOR_STYLE)\n      .forEach((gradientStyle) => delete style[gradientStyle]);\n  }\n\n  // 斜体渐变色右边缘可能被截断, 当斜体和渐变色同时存在时设置右边距\n  if (style.fontStyle === 'italic' && GRADIENT_STYLE_FLAG in style) {\n    if (!style.paddingRight && !style.marginRight) {\n      style.paddingRight = '0.2em';\n      style.marginRight = '-0.2em';\n    }\n  }\n\n  return style;\n}\n\nexport const setStyleWithMark = fillStyle();\n\nexport const MarksOptionContext = React.createContext({ disableHighlight: false });\n\nexport function MarksComponent(props) {\n  const marksOption = React.useContext(MarksOptionContext);\n  const { marks, children } = props;\n  // memo style (marks not always change, eg: selection change)\n  const style = React.useMemo(() => {\n    return marksToStyle(marks, marksOption);\n  }, [marks, marksOption]);\n\n  const hasInlineCode = React.useMemo(() => marks.some((mark) => mark.type === 'inlineCode'), [marks]);\n  if (hasInlineCode) {\n    return <code data-cangjie-mark style={style}>{children()}</code>;\n  }\n  const onlyChild = React.Children.only(children());\n\n  return React.cloneElement(onlyChild, { 'data-cangjie-mark': true, style });\n}\n"],"file":"marks.js"}