{"version":3,"sources":["../../../../src/utils/components/Table.tsx"],"names":["IS_MOBILE","IS_IPAD","environment","IS_PC_OR_IPAD","Wrapper","styled","div","writeToData","items","controller","document","value","table","getClosest","key","Table","isTable","command","Commands","setNodeByKey","data","colsWidth","map","i","width","isFocused","selection","focusKey","focus","hasNode","TableView","TopBar","configs","onDragChange","children","attributes","ref","React","useRef","parentRect","isDragging","forceRender","useReducer","s","alignKey","setAlignKey","useState","activeIndex","setActiveIndex","stateCellsRef","refWidth","propsCells","useMemo","row","nodes","TableRow","isTableRow","reduce","ws","cell","index","push","isHover","setIsHover","hasFocus","handleDraggingChange","useCallback","dragging","current","getBoundingClientRect","moveToFocus","blur","useEffect","length","run","totalWidth","COLUMN_SPACE","handleDragging","cellKey","clientX","offsetX","Math","round","left","CURSOR_SIZE","newItems","isAligned","rectWidth","cells","providerConfigs","renderTopBar","Boolean","readOnly","handleMouseEnter","handleMousseLeave"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport styled from 'styled-components';\nimport { Controller, Commands, environment } from '@ali/4ever-cangjie';\nimport { Table, TableRow } from '@ali/4ever-plugin-table';\nimport {\n  correctWidths,\n  moveWidths,\n  CellItem,\n  ColumnsProvider,\n} from '../utils/ColumnsProvider';\nimport useWidth from '../utils/useWidth';\nimport { COLUMN_SPACE, CURSOR_SIZE } from '../constants';\nimport { cleanUpColumns } from '../actions';\nimport { OnDragChange, ColumnsConfigs } from '../types';\nimport { IpadActiveBarProvider } from '../utils/useIpadActiveIndex';\n\nconst { IS_MOBILE, IS_IPAD } = environment;\nconst IS_PC_OR_IPAD = !IS_MOBILE || IS_IPAD;\n\nconst Wrapper = styled.div`\n  display: flex;\n  align-items: stretch;\n  flex-direction: row;\n  position: relative;\n  touch-action: pan-y pinch-zoom;\n  ${IS_MOBILE && !IS_IPAD &&\n    `\n      @media (max-width: 500px) {\n        flex-direction: column;\n      }\n    `}\n`;\n\ninterface IProps {\n  table: Table;\n  onDragChange?: OnDragChange;\n  controller: Controller;\n  configs?: ColumnsConfigs;\n  TopBar?: React.ComponentType<any>;\n  attributes?: Record<string, any>;\n}\n\nfunction writeToData(items: CellItem[], controller: Controller) {\n  const { document } = controller.value;\n  const table = document.getClosest(\n    items[0].key,\n    Table.isTable,\n  ) as Table | null;\n  if (!table) {\n    return;\n  }\n  controller.command(Commands.setNodeByKey, table.key, {\n    data: {\n      ...table.data,\n      colsWidth: items.map((i) => i.width),\n    },\n  });\n}\n\nconst isFocused = (controller: Controller, table: Table) => {\n  const { selection } = controller.value;\n  const { key: focusKey } = selection.focus;\n  return focusKey === table.key || table.hasNode(focusKey);\n};\n\nexport default function TableView({\n  table,\n  controller,\n  TopBar,\n  configs,\n  onDragChange,\n  children,\n  attributes,\n}: React.PropsWithChildren<IProps>) {\n  const ref = React.useRef<HTMLDivElement>(null);\n  const parentRect = React.useRef<DOMRect | undefined>();\n  const isDragging = React.useRef<boolean | undefined>();\n  const [, forceRender] = React.useReducer((s: number) => s + 1, 0);\n  const [alignKey, setAlignKey] = React.useState('');\n  /**\n   * iPad 交互\n   * 1. 分栏中间的点 常显\n   * 2. 分栏中间的插入按钮和拖拽杆，点击后一起显示\n   */\n  const [activeIndex, setActiveIndex] = React.useState(-1);\n  const stateCellsRef = React.useRef<CellItem[] | undefined>();\n  const refWidth = useWidth(ref);\n  const propsCells = React.useMemo(() => {\n    const colsWidth = table.data.colsWidth || [];\n    const row = table.nodes[0];\n    if (!TableRow.isTableRow(row)) {\n      return [];\n    }\n    return row.nodes.reduce<CellItem[]>((ws, cell, index) => {\n      const width = colsWidth[index] || 100;\n      ws.push({ key: cell.key, width });\n      return ws;\n    }, []);\n  }, [table, refWidth]);\n  const [isHover, setIsHover] = React.useState(false);\n\n  const hasFocus = isFocused(controller, table);\n\n  const handleDraggingChange = React.useCallback(\n    (dragging: boolean) => {\n      isDragging.current = dragging;\n      onDragChange && onDragChange(dragging, controller);\n      if (dragging) {\n        parentRect.current = ref.current?.getBoundingClientRect();\n        controller.command(Commands.moveToFocus).command(Commands.blur);\n      } else if (stateCellsRef.current) {\n        writeToData(stateCellsRef.current, controller);\n        controller.command(Commands.focus);\n      }\n      setAlignKey('');\n      forceRender();\n    },\n    [controller, onDragChange],\n  );\n\n  React.useEffect(() => {\n    const row = table.nodes[0];\n    if (!TableRow.isTableRow(row)) {\n      return;\n    }\n    if (row && row.nodes.length <= 0) {\n      controller.run('onAction', cleanUpColumns());\n    }\n  }, [controller, table]);\n\n  React.useEffect(() => {\n    if (!ref.current) {\n      return;\n    }\n    parentRect.current = ref.current?.getBoundingClientRect();\n    const totalWidth =\n      parentRect.current.width - (propsCells.length - 1) * COLUMN_SPACE;\n    stateCellsRef.current = correctWidths(propsCells, totalWidth);\n    forceRender();\n  }, [propsCells]);\n\n  const handleDragging = React.useCallback(\n    (cellKey: string, clientX: number) => {\n      if (!parentRect.current || !stateCellsRef.current) {\n        return;\n      }\n      const offsetX = Math.round(\n        clientX - parentRect.current.left - CURSOR_SIZE,\n      );\n      const items = stateCellsRef.current;\n      const totalWidth =\n        parentRect.current.width - (items.length - 1) * COLUMN_SPACE;\n      const { items: newItems, isAligned } = moveWidths({\n        offsetX,\n        key: cellKey,\n        items,\n        totalWidth,\n        rectWidth: parentRect.current.width,\n      });\n      stateCellsRef.current = newItems;\n      setAlignKey(isAligned ? cellKey : '');\n      forceRender();\n    },\n    [],\n  );\n  const dragging = isDragging.current || false;\n  const cells = dragging ? stateCellsRef.current : propsCells;\n\n  const providerConfigs = React.useMemo(() => {\n    return {\n      cells: cells!,\n      alignKey,\n      isDragging: dragging,\n      handleDragging,\n      handleDraggingChange,\n    };\n  }, [cells, handleDragging, handleDraggingChange, dragging, alignKey]);\n\n  const renderTopBar = Boolean(\n    (isHover || hasFocus || IS_IPAD) && !controller.readOnly && IS_PC_OR_IPAD && !dragging,\n  );\n\n  const handleMouseEnter = React.useCallback(() => {\n    setIsHover(true);\n  }, [setIsHover]);\n\n  const handleMousseLeave = React.useCallback(() => {\n    setIsHover(false);\n  }, [setIsHover]);\n\n  if (!cells?.length) {\n    return null;\n  }\n\n  return (\n    <Wrapper\n      {...attributes}\n      data-columns\n      data-columns-key={table.key}\n      data-cangjie-key={table.key}\n      ref={ref}\n      onMouseEnter={handleMouseEnter}\n      onMouseLeave={handleMousseLeave}\n    >\n      <IpadActiveBarProvider value={[activeIndex, setActiveIndex]}>\n        {renderTopBar && !!TopBar && <TopBar items={cells} configs={configs} />}\n        <ColumnsProvider value={providerConfigs}>{children}</ColumnsProvider>\n      </IpadActiveBarProvider>\n    </Wrapper>\n  );\n}\n"],"file":"Table.js"}