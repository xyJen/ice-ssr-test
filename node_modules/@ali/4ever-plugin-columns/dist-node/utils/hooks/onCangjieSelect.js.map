{"version":3,"sources":["../../../../src/utils/hooks/onCangjieSelect.ts"],"names":["moveToInside","controller","anchor","offset","edge","EdgePoint","BEFORE","point","query","Queries","pointAtDistance","newSelection","RangeSelection","create","focus","command","Commands","select","moveFocusInsideColumn","selection","targetNode","document","value","isForward","pointAtEndOfNode","pointAtStartOfNode","createOnCangjieSelect","configs","event","next","isDisabled","trigger","detail","isCollapsed","isEdgePoint","block","getNode","key","Table","isTable","data","sr","docStart","docEnd","theOtherSide","environment","IS_MOBILE","maybeCell","getClosest","n","TableCell","isTableCell","isExpanded","maybeRow","getParent","maybeTable","focusCell"],"mappings":"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","sourcesContent":["import equal from 'fast-deep-equal';\nimport {\n  Controller,\n  Queries,\n  Selection,\n  CangjieSelectEvent,\n  EdgePoint,\n  Commands,\n  RangeSelection,\n} from '@ali/4ever-cangjie';\nimport { Table, TableCell } from '@ali/4ever-plugin-table';\nimport { ColumnsConfigs } from '../types';\nimport { environment } from '@ali/4ever-cangjie';\n\nfunction moveToInside(controller: Controller, anchor: EdgePoint) {\n  const offset = anchor.edge === EdgePoint.BEFORE ? 1 : -1;\n  const point = controller.query(Queries.pointAtDistance, anchor, offset);\n  const newSelection = RangeSelection.create({\n    anchor: point,\n    focus: point,\n  });\n  return controller.command(Commands.select, newSelection);\n}\n\nfunction moveFocusInsideColumn(\n  controller: Controller,\n  selection: Selection,\n  targetNode: TableCell,\n) {\n  const { document } = controller.value;\n  const isForward = selection.isForward(document);\n  const focus = isForward\n    ? controller.query(Queries.pointAtEndOfNode, targetNode)\n    : controller.query(Queries.pointAtStartOfNode, targetNode);\n  const newSelection = RangeSelection.create({\n    anchor: selection.anchor,\n    focus,\n  });\n  return controller.command(Commands.select, newSelection);\n}\n\nexport default function createOnCangjieSelect(configs?: ColumnsConfigs) {\n  return (\n    event: CangjieSelectEvent,\n    controller: Controller,\n    next: Function,\n  ) => {\n    if (configs?.isDisabled && configs.isDisabled()) {\n      return next();\n    }\n    const { document } = controller.value;\n    const { selection, trigger } = event.detail;\n    const { anchor, focus } = selection;\n    // 处理一：用户点击的时候，把 edge 光标挪到分栏内部\n    if (\n      trigger === 'selectStart' &&\n      selection.isCollapsed &&\n      anchor.isEdgePoint()\n    ) {\n      const block = document.getNode(anchor.key);\n      if (Table.isTable(block) && block.data.sr) {\n        const docStart = controller.query(Queries.pointAtStartOfNode, document);\n        const docEnd = controller.query(Queries.pointAtEndOfNode, document);\n        if (\n          !equal(docStart, anchor) &&\n          !equal(docEnd, anchor) &&\n          // 页面试图下，docStart 返回 column 内部的 point\n          !block.getNode(docStart.key) &&\n          !block.getNode(docEnd.key)\n        ) {\n          return moveToInside(controller, anchor);\n        }\n      }\n    }\n    // 处理二：用户跨栏选中内容，就自动纠正掉（禁止跨栏选中，因为操作不支持）\n    // 移动端拖选时，会将拖动的点置为 anchor，所以需要额外判断下\n    const theOtherSide = event.detail.trigger === 'dragging' && environment.IS_MOBILE ? focus : anchor;\n    const maybeCell = document.getClosest(theOtherSide.key, (n) => {\n      return TableCell.isTableCell(n);\n    });\n    if (selection.isExpanded && TableCell.isTableCell(maybeCell)) {\n      const maybeRow = document.getParent(maybeCell.key);\n      const maybeTable = maybeRow && document.getParent(maybeRow.key);\n      if (Table.isTable(maybeTable) && maybeTable.data.sr) {\n        const focusCell = document.getClosest(\n          focus.key,\n          (n) => n.key === maybeCell.key,\n        );\n        if (!focusCell) {\n          return moveFocusInsideColumn(controller, selection, maybeCell);\n        }\n      }\n    }\n    return next();\n  };\n}\n"],"file":"onCangjieSelect.js"}