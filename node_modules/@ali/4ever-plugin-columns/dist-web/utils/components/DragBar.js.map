{"version":3,"sources":["../../../../src/utils/components/DragBar.tsx"],"names":["React","styled","environment","useIpadActiveBarIndex","useOnClickOutside","COLUMN_SPACE","IS_IPAD","Line","div","visible","Wrapper","props","readOnly","isEnabled","CURSOR_SIZE","SplitLine","cellKey","isAligned","onDragging","onDraggingChange","index","isDragging","useRef","ref","activeIndex","setActiveIndex","handleMouseMove","useCallback","event","stopPropagation","stopImmediatePropagation","preventDefault","current","clientX","handleMouseUp","currentTarget","releasePointerCapture","pointerId","removeEventListener","handleMouseDown","pointerType","setPointerCapture","addEventListener","handleMouseEnter","handleMouseLeave","useEffect","node","undefined","handleClick","ele","closest"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport styled from 'styled-components';\nimport { environment } from '@ali/4ever-cangjie';\nimport { useIpadActiveBarIndex } from '../utils/useIpadActiveIndex';\nimport { useOnClickOutside } from '@ali/4ever-component';\n\nimport { COLUMN_SPACE } from '../constants';\n\nconst { IS_IPAD } = environment;\n\nconst Line = styled.div<{ isAligned: boolean; visible: boolean }>`\n  width: 4px;\n  height: 100%;\n  transition: background-color 250ms;\n  background-color: rgba(0, 137, 255, 0.48);\n  border-radius: 2px;\n\n  opacity: ${({ visible }) => (visible ? 1 : 0)};\n  .draggable-hander & {\n    opacity: 0 !important;\n    pointer-events: none;\n  }\n`;\n\nconst Wrapper = styled.div<{ isEnabled: boolean; readOnly: boolean }>`\n  cursor: ${(props) => (props.readOnly ? 'inherit' : 'col-resize')};\n  margin: 0;\n  padding: 0 ${(COLUMN_SPACE - 4) / 2}px;\n\n  &:hover ${Line} {\n    opacity: ${(props) => (props.isEnabled ? '1' : '0')};\n  }\n  [data-node-selecting] &[data-column-dragkey]{\n    pointer-events: none;\n  }\n`;\n\nconst CURSOR_SIZE = 5;\n\ninterface HoverAreaProps {\n  cellKey: string;\n  isEnabled: boolean;\n  readOnly: boolean;\n  isAligned: boolean;\n  onDraggingChange: (isDragging: boolean) => void;\n  onDragging: (cellKey: string, clientX: number) => void;\n  index: number;\n}\n\nexport default function SplitLine(props: HoverAreaProps) {\n  const {\n    cellKey,\n    isAligned,\n    isEnabled,\n    onDragging,\n    onDraggingChange,\n    readOnly,\n    index,\n  } = props;\n  const isDragging = React.useRef(false);\n  const ref = React.useRef<HTMLDivElement>(null);\n  const [activeIndex, setActiveIndex] = useIpadActiveBarIndex();\n\n  const handleMouseMove = React.useCallback(\n    (event: PointerEvent) => {\n      event.stopPropagation();\n      event.stopImmediatePropagation();\n      event.preventDefault();\n      if (isDragging.current) {\n        onDraggingChange(true);\n        onDragging(cellKey, event.clientX + CURSOR_SIZE);\n      }\n    },\n    [cellKey, onDragging, onDraggingChange],\n  );\n  const handleMouseUp = React.useCallback(\n    (event: PointerEvent) => {\n      event.stopPropagation();\n      event.stopImmediatePropagation();\n      event.preventDefault();\n      (event.currentTarget as HTMLElement).releasePointerCapture(\n        event.pointerId,\n      );\n      isDragging.current = false;\n      onDraggingChange(false);\n      if (!ref.current) {\n        return;\n      }\n      ref.current.removeEventListener('pointerup', handleMouseUp);\n      ref.current.removeEventListener('pointermove', handleMouseMove);\n    },\n    [handleMouseMove, onDraggingChange],\n  );\n  const handleMouseDown = React.useCallback(\n    (event: PointerEvent) => {\n      event.stopPropagation();\n      event.stopImmediatePropagation();\n      event.preventDefault();\n      if (!ref.current) {\n        return;\n      }\n\n      isDragging.current = true;\n\n      if (event.pointerType === 'mouse') {\n        (event.currentTarget as HTMLElement).setPointerCapture(event.pointerId);\n      }\n\n      ref.current.addEventListener('pointerup', handleMouseUp);\n      ref.current.addEventListener('pointermove', handleMouseMove);\n    },\n    [handleMouseMove, handleMouseUp],\n  );\n\n  const handleMouseEnter = React.useCallback(() => {\n    // ipad hover 时，期望 topBar 和 dragBar 同时显示\n    if (IS_IPAD) {\n      setActiveIndex(index);\n    }\n  }, [index, setActiveIndex]);\n\n  const handleMouseLeave = React.useCallback(() => {\n    if (IS_IPAD && activeIndex !== -1) {\n      setActiveIndex(-1);\n    }\n  }, [activeIndex, setActiveIndex]);\n\n  React.useEffect(() => {\n    const node = ref.current;\n    if (!node || !isEnabled) {\n      return undefined;\n    }\n    node.addEventListener('pointerdown', handleMouseDown);\n    return () => {\n      node.removeEventListener('pointerdown', handleMouseDown);\n    };\n  }, [handleMouseDown, handleMouseMove, handleMouseUp, isEnabled, activeIndex]);\n\n  const handleClick = () => {\n    if (IS_IPAD && activeIndex !== index) {\n      setActiveIndex(index);\n    }\n  };\n\n  useOnClickOutside(\n    ref,\n    () => {\n      if (IS_IPAD && activeIndex !== -1) {\n        setActiveIndex(-1);\n      }\n    },\n    false,\n    (ele) => {\n      // 忽略 topbar\n      return !!ele.closest('div[data-column-topbar]');\n    },\n  );\n\n  return (\n    <Wrapper\n      readOnly={readOnly}\n      isEnabled={isEnabled}\n      data-column-dragkey={cellKey}\n      ref={ref}\n      onClick={handleClick}\n      onMouseEnter={handleMouseEnter}\n      onMouseLeave={handleMouseLeave}\n    >\n      <Line\n        isAligned={isAligned}\n        data-column-dragkey={cellKey}\n        visible={activeIndex === index}\n      />\n    </Wrapper>\n  );\n}\n"],"file":"DragBar.js"}