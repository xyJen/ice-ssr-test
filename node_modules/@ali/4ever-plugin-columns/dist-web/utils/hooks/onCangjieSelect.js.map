{"version":3,"sources":["../../../../src/utils/hooks/onCangjieSelect.ts"],"names":["equal","Queries","EdgePoint","Commands","RangeSelection","Table","TableCell","environment","moveToInside","controller","anchor","offset","edge","BEFORE","point","query","pointAtDistance","newSelection","create","focus","command","select","moveFocusInsideColumn","selection","targetNode","document","value","isForward","pointAtEndOfNode","pointAtStartOfNode","createOnCangjieSelect","configs","event","next","isDisabled","detail","trigger","isCollapsed","isEdgePoint","block","getNode","key","isTable","data","sr","docStart","docEnd","theOtherSide","IS_MOBILE","maybeCell","getClosest","n","isTableCell","isExpanded","maybeRow","getParent","maybeTable","focusCell"],"mappings":"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","sourcesContent":["import equal from 'fast-deep-equal';\nimport {\n  Controller,\n  Queries,\n  Selection,\n  CangjieSelectEvent,\n  EdgePoint,\n  Commands,\n  RangeSelection,\n} from '@ali/4ever-cangjie';\nimport { Table, TableCell } from '@ali/4ever-plugin-table';\nimport { ColumnsConfigs } from '../types';\nimport { environment } from '@ali/4ever-cangjie';\n\nfunction moveToInside(controller: Controller, anchor: EdgePoint) {\n  const offset = anchor.edge === EdgePoint.BEFORE ? 1 : -1;\n  const point = controller.query(Queries.pointAtDistance, anchor, offset);\n  const newSelection = RangeSelection.create({\n    anchor: point,\n    focus: point,\n  });\n  return controller.command(Commands.select, newSelection);\n}\n\nfunction moveFocusInsideColumn(\n  controller: Controller,\n  selection: Selection,\n  targetNode: TableCell,\n) {\n  const { document } = controller.value;\n  const isForward = selection.isForward(document);\n  const focus = isForward\n    ? controller.query(Queries.pointAtEndOfNode, targetNode)\n    : controller.query(Queries.pointAtStartOfNode, targetNode);\n  const newSelection = RangeSelection.create({\n    anchor: selection.anchor,\n    focus,\n  });\n  return controller.command(Commands.select, newSelection);\n}\n\nexport default function createOnCangjieSelect(configs?: ColumnsConfigs) {\n  return (\n    event: CangjieSelectEvent,\n    controller: Controller,\n    next: Function,\n  ) => {\n    if (configs?.isDisabled && configs.isDisabled()) {\n      return next();\n    }\n    const { document } = controller.value;\n    const { selection, trigger } = event.detail;\n    const { anchor, focus } = selection;\n    // 处理一：用户点击的时候，把 edge 光标挪到分栏内部\n    if (\n      trigger === 'selectStart' &&\n      selection.isCollapsed &&\n      anchor.isEdgePoint()\n    ) {\n      const block = document.getNode(anchor.key);\n      if (Table.isTable(block) && block.data.sr) {\n        const docStart = controller.query(Queries.pointAtStartOfNode, document);\n        const docEnd = controller.query(Queries.pointAtEndOfNode, document);\n        if (\n          !equal(docStart, anchor) &&\n          !equal(docEnd, anchor) &&\n          // 页面试图下，docStart 返回 column 内部的 point\n          !block.getNode(docStart.key) &&\n          !block.getNode(docEnd.key)\n        ) {\n          return moveToInside(controller, anchor);\n        }\n      }\n    }\n    // 处理二：用户跨栏选中内容，就自动纠正掉（禁止跨栏选中，因为操作不支持）\n    // 移动端拖选时，会将拖动的点置为 anchor，所以需要额外判断下\n    const theOtherSide = event.detail.trigger === 'dragging' && environment.IS_MOBILE ? focus : anchor;\n    const maybeCell = document.getClosest(theOtherSide.key, (n) => {\n      return TableCell.isTableCell(n);\n    });\n    if (selection.isExpanded && TableCell.isTableCell(maybeCell)) {\n      const maybeRow = document.getParent(maybeCell.key);\n      const maybeTable = maybeRow && document.getParent(maybeRow.key);\n      if (Table.isTable(maybeTable) && maybeTable.data.sr) {\n        const focusCell = document.getClosest(\n          focus.key,\n          (n) => n.key === maybeCell.key,\n        );\n        if (!focusCell) {\n          return moveFocusInsideColumn(controller, selection, maybeCell);\n        }\n      }\n    }\n    return next();\n  };\n}\n"],"file":"onCangjieSelect.js"}