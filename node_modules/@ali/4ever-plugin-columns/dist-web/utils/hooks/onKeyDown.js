import { hotkeys } from '@ali/4ever-cangjie';
import { Table, TableCell } from '@ali/4ever-plugin-table';
import { Heading } from '@ali/4ever-plugin-heading';
import { deleteColumn } from "../actions";
import { isEmptyParagraph } from '@ali/4ever-utils';

function tryRemoveColumn(controller, closestBlock) {
  var _controller$value = controller.value,
      selection = _controller$value.selection,
      document = _controller$value.document;
  var key = selection.focus.key;
  var maybeTableCell = document.getParent(closestBlock.key);
  var table = document.getClosest(key, Table.isTable);

  if ( // inside a column
  table && table.data.sr && // only block
  TableCell.isTableCell(maybeTableCell) && maybeTableCell.nodes.length === 1) {
    controller.run('onAction', deleteColumn({
      key: maybeTableCell.key
    }));
    return true;
  }

  return false;
}

export default function createOnKeyDown() {
  return function onKeyDown(event, controller, next) {
    var _controller$value2 = controller.value,
        selection = _controller$value2.selection,
        document = _controller$value2.document;

    if (selection.isExpanded || !hotkeys.isDeleteBackward(event)) {
      return next();
    }

    var focusKey = selection.focus.key;
    var closestBlock = document.getClosestBlock(focusKey);

    if (!closestBlock) {
      return next();
    }

    var procceed = false; // 如果在分栏里没有内容，再按下了删除：就删除掉整个分栏

    if (isEmptyParagraph(closestBlock)) {
      procceed = tryRemoveColumn(controller, closestBlock);
    } else if (Heading.isHeading(closestBlock) && !closestBlock.text) {
      procceed = tryRemoveColumn(controller, closestBlock);
    }

    if (procceed) {
      return controller;
    }

    return next();
  };
}
//# sourceMappingURL=onKeyDown.js.map