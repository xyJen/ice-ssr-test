import equal from 'fast-deep-equal';
import { Queries, EdgePoint, Commands, RangeSelection } from '@ali/4ever-cangjie';
import { Table, TableCell } from '@ali/4ever-plugin-table';
import { environment } from '@ali/4ever-cangjie';

function moveToInside(controller, anchor) {
  var offset = anchor.edge === EdgePoint.BEFORE ? 1 : -1;
  var point = controller.query(Queries.pointAtDistance, anchor, offset);
  var newSelection = RangeSelection.create({
    anchor: point,
    focus: point
  });
  return controller.command(Commands.select, newSelection);
}

function moveFocusInsideColumn(controller, selection, targetNode) {
  var document = controller.value.document;
  var isForward = selection.isForward(document);
  var focus = isForward ? controller.query(Queries.pointAtEndOfNode, targetNode) : controller.query(Queries.pointAtStartOfNode, targetNode);
  var newSelection = RangeSelection.create({
    anchor: selection.anchor,
    focus: focus
  });
  return controller.command(Commands.select, newSelection);
}

export default function createOnCangjieSelect(configs) {
  return function (event, controller, next) {
    if (configs != null && configs.isDisabled && configs.isDisabled()) {
      return next();
    }

    var document = controller.value.document;
    var _event$detail = event.detail,
        selection = _event$detail.selection,
        trigger = _event$detail.trigger;
    var anchor = selection.anchor,
        focus = selection.focus; // 处理一：用户点击的时候，把 edge 光标挪到分栏内部

    if (trigger === 'selectStart' && selection.isCollapsed && anchor.isEdgePoint()) {
      var block = document.getNode(anchor.key);

      if (Table.isTable(block) && block.data.sr) {
        var docStart = controller.query(Queries.pointAtStartOfNode, document);
        var docEnd = controller.query(Queries.pointAtEndOfNode, document);

        if (!equal(docStart, anchor) && !equal(docEnd, anchor) && // 页面试图下，docStart 返回 column 内部的 point
        !block.getNode(docStart.key) && !block.getNode(docEnd.key)) {
          return moveToInside(controller, anchor);
        }
      }
    } // 处理二：用户跨栏选中内容，就自动纠正掉（禁止跨栏选中，因为操作不支持）
    // 移动端拖选时，会将拖动的点置为 anchor，所以需要额外判断下


    var theOtherSide = event.detail.trigger === 'dragging' && environment.IS_MOBILE ? focus : anchor;
    var maybeCell = document.getClosest(theOtherSide.key, function (n) {
      return TableCell.isTableCell(n);
    });

    if (selection.isExpanded && TableCell.isTableCell(maybeCell)) {
      var maybeRow = document.getParent(maybeCell.key);
      var maybeTable = maybeRow && document.getParent(maybeRow.key);

      if (Table.isTable(maybeTable) && maybeTable.data.sr) {
        var focusCell = document.getClosest(focus.key, function (n) {
          return n.key === maybeCell.key;
        });

        if (!focusCell) {
          return moveFocusInsideColumn(controller, selection, maybeCell);
        }
      }
    }

    return next();
  };
}
//# sourceMappingURL=onCangjieSelect.js.map