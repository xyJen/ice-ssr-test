{"version":3,"sources":["../../../../src/utils/commands/clearAloneTables.ts"],"names":["Commands","Table","TableRow","TableCell","safeFindFirstCell","table","nodes","undefined","row","isTableRow","cell","isTableCell","safeFindFirstRow","isBadTable","firstRow","firstCell","length","clearAloneTables","controller","document","value","aloneTableIndex","findIndex","n","isTable","data","sr","withoutNormalizing","tablePath","getPath","key","command","removeNodeByPath"],"mappings":"AAAA,SAASA,QAAT,QAAqC,oBAArC;AACA,SAASC,KAAT,EAAgBC,QAAhB,EAA0BC,SAA1B,QAA2C,yBAA3C,C,CAEA;AACA;;AACA,IAAMC,iBAAiB,GAAG,SAApBA,iBAAoB,CAACC,KAAD,EAAkB;AAC1C,MAAI,CAACA,KAAK,CAACC,KAAX,EAAkB;AAChB,WAAOC,SAAP;AACD;;AACD,MAAMC,GAAG,GAAGH,KAAK,CAACC,KAAN,CAAY,CAAZ,CAAZ;;AACA,MAAI,CAACJ,QAAQ,CAACO,UAAT,CAAoBD,GAApB,CAAD,IAA6B,CAACA,GAAG,CAACF,KAAtC,EAA6C;AAC3C,WAAOC,SAAP;AACD;;AACD,MAAMG,IAAI,GAAGF,GAAG,CAACF,KAAJ,CAAU,CAAV,CAAb;;AACA,MAAI,CAACH,SAAS,CAACQ,WAAV,CAAsBD,IAAtB,CAAD,IAAgC,CAACA,IAAI,CAACJ,KAA1C,EAAiD;AAC/C,WAAOC,SAAP;AACD;;AACD,SAAOG,IAAP;AACD,CAbD;;AAeA,IAAME,gBAAgB,GAAG,SAAnBA,gBAAmB,CAACP,KAAD,EAAkB;AACzC,MAAI,CAACA,KAAK,CAACC,KAAX,EAAkB;AAChB,WAAOC,SAAP;AACD;;AACD,MAAMC,GAAG,GAAGH,KAAK,CAACC,KAAN,CAAY,CAAZ,CAAZ;;AACA,MAAI,CAACJ,QAAQ,CAACO,UAAT,CAAoBD,GAApB,CAAD,IAA6B,CAACA,GAAG,CAACF,KAAtC,EAA6C;AAC3C,WAAOC,SAAP;AACD;;AACD,SAAOC,GAAP;AACD,CATD;;AAWA,OAAO,IAAMK,UAAU,GAAG,SAAbA,UAAa,CAACR,KAAD,EAAkB;AAC1C,MAAMS,QAAQ,GAAGF,gBAAgB,CAACP,KAAD,CAAjC;AACA,MAAMU,SAAS,GAAGX,iBAAiB,CAACC,KAAD,CAAnC;;AAEA,MAAI,CAACS,QAAD,IAAa,CAACC,SAAlB,EAA6B;AAC3B,WAAO,IAAP;AACD,GANyC,CAQ1C;;;AACA,MAAI,CAACA,SAAS,CAACT,KAAf,EAAsB;AACpB,WAAO,IAAP;AACD,GAXyC,CAa1C;;;AACA,MAAIS,SAAS,CAACT,KAAV,CAAgBU,MAAhB,KAA2B,CAA/B,EAAkC;AAChC,WAAO,IAAP;AACD;;AAED,SAAO,KAAP;AACD,CAnBM;AAqBP,eAAe,SAASC,gBAAT,CAA0BC,UAA1B,EAA8D;AAAA,MACnEC,QADmE,GACtDD,UAAU,CAACE,KAD2C,CACnED,QADmE;AAE3E,MAAME,eAAe,GAAGF,QAAQ,CAACb,KAAT,CAAegB,SAAf,CACtB,UAACC,CAAD;AAAA,WACEtB,KAAK,CAACuB,OAAN,CAAcD,CAAd,KACAA,CAAC,CAACE,IAAF,CAAOC,EADP,IAEAb,UAAU,CAACU,CAAD,CAHZ;AAAA,GADsB,CAAxB;;AAMA,MAAIF,eAAe,GAAG,CAAtB,EAAyB;AACvB,WAAOH,UAAP;AACD;;AACD,MAAMb,KAAK,GAAGc,QAAQ,CAACb,KAAT,CAAee,eAAf,CAAd;AACAH,EAAAA,UAAU,CAACS,kBAAX,CAA8B,YAAM;AAClC,QAAMC,SAAS,GAAGT,QAAQ,CAACU,OAAT,CAAiBxB,KAAK,CAACyB,GAAvB,CAAlB,CADkC,CAGlC;;AACAZ,IAAAA,UAAU,CAACa,OAAX,CAAmB/B,QAAQ,CAACgC,gBAA5B,EAA8CJ,SAA9C;AACD,GALD;AAOA,SAAOX,gBAAgB,CAACC,UAAD,CAAvB;AACD","sourcesContent":["import { Commands, Controller } from '@ali/4ever-cangjie';\nimport { Table, TableRow, TableCell } from '@ali/4ever-plugin-table';\n\n// 在拖拽、normalize 等一些极限场景，table 结构被破坏\n// 这里会进行二次校验，如果 table 下的数据不合法，就拉出来删除掉\nconst safeFindFirstCell = (table: Table) => {\n  if (!table.nodes) {\n    return undefined;\n  }\n  const row = table.nodes[0];\n  if (!TableRow.isTableRow(row) || !row.nodes) {\n    return undefined;\n  }\n  const cell = row.nodes[0];\n  if (!TableCell.isTableCell(cell) || !cell.nodes) {\n    return undefined;\n  }\n  return cell;\n};\n\nconst safeFindFirstRow = (table: Table) => {\n  if (!table.nodes) {\n    return undefined;\n  }\n  const row = table.nodes[0];\n  if (!TableRow.isTableRow(row) || !row.nodes) {\n    return undefined;\n  }\n  return row;\n};\n\nexport const isBadTable = (table: Table) => {\n  const firstRow = safeFindFirstRow(table);\n  const firstCell = safeFindFirstCell(table);\n\n  if (!firstRow || !firstCell) {\n    return true;\n  }\n\n  // badCellNodesUndefined\n  if (!firstCell.nodes) {\n    return true;\n  }\n\n  // badCellNodesEmpty\n  if (firstCell.nodes.length === 0) {\n    return true;\n  }\n\n  return false;\n};\n\nexport default function clearAloneTables(controller: Controller): Controller {\n  const { document } = controller.value;\n  const aloneTableIndex = document.nodes.findIndex(\n    (n) =>\n      Table.isTable(n) &&\n      n.data.sr &&\n      isBadTable(n),\n  );\n  if (aloneTableIndex < 0) {\n    return controller;\n  }\n  const table = document.nodes[aloneTableIndex] as Table;\n  controller.withoutNormalizing(() => {\n    const tablePath = document.getPath(table.key)!;\n\n    // delete the table\n    controller.command(Commands.removeNodeByPath, tablePath);\n  });\n\n  return clearAloneTables(controller);\n}\n"],"file":"clearAloneTables.js"}