{"version":3,"sources":["../../../../src/bi/utils/getRangeFromDragEvent.ts"],"names":["domUtils","Block","COLUMN_BAR_KEY","HORIZ_ADJUST_OFFSET","shouldTraverseBlock","node","isBlock","test","type","getBlockFromDragEvent","controller","event","zoom","onlyEdge","clientX","clientY","target","getBoundingClientRect","left","right","adjustedX","document","value","isOutsideContent","element","dragKey","getAttribute","block","getNode","isElement","nodes","querySelector","window","getComputedStyle","paddingLeft","paddingRight","l","parseInt","r","hitedTarget","elementFromPoint","closest","hasAttribute","pivotY","firstElementChild","bottom","childTarget","lastElementChild","split","key","getParent","getRangeFromDragEvent","caretRangeFromTargetAndCoord"],"mappings":"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","sourcesContent":["import { Controller, domUtils, Block, Node } from '@ali/4ever-cangjie';\n\nconst COLUMN_BAR_KEY = 'data-column-dragkey';\nconst HORIZ_ADJUST_OFFSET = 10;\n\nfunction shouldTraverseBlock(node: Node | null) {\n  if (!node) return false;\n\n  if (!Block.isBlock(node)) return true;\n  if (/line/.test(node.type)) return true;\n\n  return false;\n}\n\n/**\n   * 从 drag 事件中计算命中的块级元素\n   * 水平位置矫正策略（I 表示 drag 事件的位置）：\n   * |   [---I---  ]   |\n   * |   [------ I ]   |\n   * | I [-------  ]   |\n   * |   [-------  ] I |\n   * 当事件命中 content 的 padding 区域时，如果取原始的水平位置拿不到 block\n   * 因此矫正为 dragEvent.target 的中点\n   */\nexport function getBlockFromDragEvent(controller: Controller, event: DragEvent, zoom?: number, onlyEdge = false) {\n  const { clientX, clientY } = event;\n  const { left, right } = (event.target as HTMLElement)?.getBoundingClientRect() || {};\n  let adjustedX = (left + right) / 2 || clientX;\n  const { document } = controller.value;\n  let isOutsideContent = false;\n\n  if (event.target) {\n    const element = event.target as HTMLElement;\n    const dragKey = element.getAttribute(COLUMN_BAR_KEY);\n    // 如果刚好到分隔栏上，就直接返回分隔栏的 key\n    if (dragKey) {\n      const block = document.getNode(dragKey);\n      if (block?.isElement()) {\n        return block.nodes[0];\n      }\n    }\n    // 如果在编辑器区域外部，需要加一下 padding，重新获取一下。\n    if (element.querySelector('[data-cangjie-editable]')) {\n      isOutsideContent = true;\n      if (typeof zoom !== 'number') return null;\n      const { paddingLeft, paddingRight } = window.getComputedStyle(event.target as HTMLElement);\n      const l = left + parseInt(paddingLeft, 10) * zoom;\n      const r = right - parseInt(paddingRight, 10) * zoom;\n      if (clientX < l) {\n        adjustedX = l + HORIZ_ADJUST_OFFSET * zoom;\n      } else if (clientX > r) {\n        adjustedX = r - HORIZ_ADJUST_OFFSET * zoom;\n      }\n    }\n  }\n  // 图片仅在拖拽到分隔栏和编辑器区域外部时返回 block\n  if (onlyEdge && !isOutsideContent) {\n    return null;\n  }\n  let hitedTarget = window.document.elementFromPoint(adjustedX, clientY);\n  if (!hitedTarget) return null;\n\n  // 兼容列表悬空区域探测\n  if (hitedTarget.closest('[data-listid]')) {\n    hitedTarget = hitedTarget.querySelector('[data-cangjie-key]') || hitedTarget;\n  }\n  // 兼容分栏悬空区域探测\n  if (hitedTarget.hasAttribute('data-column')) {\n    const pivotY = hitedTarget.firstElementChild?.getBoundingClientRect().bottom || 0;\n    const childTarget = clientY >= pivotY ? hitedTarget.lastElementChild : hitedTarget.firstElementChild;\n    hitedTarget = childTarget?.querySelector('[data-cangjie-key]') || hitedTarget;\n  }\n  const node = hitedTarget.closest('[data-cangjie-key]');\n  let block: Node | null = null;\n  if (node) {\n    const [key] = node.getAttribute('data-cangjie-key')?.split(':') || [];\n    block = document.getNode(key);\n    while (shouldTraverseBlock(block)) {\n      block = document.getParent(block?.key || '');\n    }\n  }\n  if (block?.key === document.key) {\n    return null;\n  }\n  return block;\n}\n\n\nexport default function getRangeFromDragEvent(controller: Controller, event: DragEvent) {\n  getBlockFromDragEvent(controller, event);\n  const { clientX, clientY } = event;\n  let hitedTarget = window.document.elementFromPoint(clientX, clientY);\n  if (!hitedTarget) return null;\n  hitedTarget = hitedTarget.closest('[data-listid]') || hitedTarget;\n  return domUtils.caretRangeFromTargetAndCoord(hitedTarget, clientX, clientY, controller);\n}\n"],"file":"getRangeFromDragEvent.js"}