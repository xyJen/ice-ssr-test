{"version":3,"sources":["../../../../src/bi/utils/getDragThumbnails.ts"],"names":["environment","Heading","Paragraph","getClosestDom","DRAG_HIGHLIGHT_CLASSNAME","DRAG_HIGHLIGHT_TABLE_CLASSNAME","DRAG_THUMBNAIL_ID","getElementType","MAX_FIT_HEIGHT","MAX_ALLOW_ELEMENTS","createFakeThumbnail","element","fakeElement","window","document","createElement","style","cssText","clientWidth","clientHeight","isComplexElement","controller","viewNode","closest","viewKey","getAttribute","block","value","getNode","isParagraph","isHeading","cloneElement","isComplex","cloneNode","getDragThumbnails","keys","draggableConfig","inlineKey","highlightElements","inlineDom","querySelectorAll","length","elements","Array","from","isSimple","complexElements","realType","codeScrollNode","querySelector","scrollTop","inline","type","imageNode","thumbnail","inner","maxLen","Math","min","i","clonedNode","appendChild","max","scale","IS_SAFARI","id","body"],"mappings":"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","sourcesContent":["import {\n  Controller,\n  Inline,\n  Block,\n  environment,\n} from '@ali/4ever-cangjie';\nimport { Heading } from '@ali/4ever-plugin-heading';\nimport { Paragraph } from '@ali/4ever-plugin-paragraph';\nimport getClosestDom from './getClosestDom';\nimport { DRAG_HIGHLIGHT_CLASSNAME, DRAG_HIGHLIGHT_TABLE_CLASSNAME, DRAG_THUMBNAIL_ID } from './domUtils';\nimport getElementType from './getElementType';\nimport { DraggablePluginConfig } from '../types';\n\nconst MAX_FIT_HEIGHT = 200;\nconst MAX_ALLOW_ELEMENTS = 15;\n\nfunction createFakeThumbnail(element: Element) {\n  const fakeElement = window.document.createElement('div');\n  fakeElement.style.cssText = `width:${element.clientWidth}px;height:${element.clientHeight}px;background-color:rgba(17,31,44,0.08);`;\n  return fakeElement;\n}\n\nfunction isComplexElement(controller: Controller, element: Element) {\n  const viewNode = element.closest('[data-cangjie-leaf-block]') || element;\n  if (!viewNode) return true;\n\n  const viewKey = viewNode.getAttribute('data-cangjie-key');\n  if (!viewKey) return true;\n\n  const block = controller.value.document.getNode(viewKey);\n  return !(Paragraph.isParagraph(block) || Heading.isHeading(block));\n}\n\nfunction cloneElement(controller: Controller, element: Element) {\n  const isComplex = isComplexElement(controller, element);\n  if (!isComplex) return element.cloneNode(true);\n\n  return createFakeThumbnail(element);\n}\n\n/**\n * 获取拖拽的缩略图\n * 策略：最多允许 15 个元素生成缩略图，如果元素高度大于 300 将做缩放\n * 1. 行内元素直接返回元素 dom 节点\n * 2. 块级元素\n *  2.1 单个\n *    2.1.1 不是拖拽配置声明的复杂元素类型：返回元素 dom 节点\n *    2.1.2 是拖拽配置声明的复杂元素类型：返回 fake 占位 dom\n *  2.2 多个\n *    2.2.1 是 paragraph 或 heading：深度克隆元素\n *    2.2.2 不是：生成 fake 占位 dom\n * @param controller\n * @param keys\n * @param draggableConfig\n */\nexport default function getDragThumbnails(\n  controller: Controller,\n  keys: {\n    inlineKey?: string;\n    viewKey?: string;\n  },\n  draggableConfig?: DraggablePluginConfig,\n) {\n  const {\n    inlineKey,\n    viewKey,\n  } = keys;\n\n  let highlightElements: Element[] = [];\n  // 1 处理行内元素\n  if (inlineKey) {\n    const inlineDom = getClosestDom(controller.value.document.getNode(inlineKey) as Inline);\n    highlightElements = inlineDom ? [inlineDom] : [];\n  } else {\n    // 根据当前高亮的元素查询\n    highlightElements = window.document.querySelectorAll(`.${DRAG_HIGHLIGHT_CLASSNAME}`) as unknown as Element[];\n    // 由于表格走的不是通用的拖拽高亮逻辑，因此这里需要处理一下拖拽表格的情况\n    if (!highlightElements.length) {\n      highlightElements = window.document.querySelectorAll(`.${DRAG_HIGHLIGHT_TABLE_CLASSNAME}`) as unknown as Element[];\n    }\n  }\n\n  if (!highlightElements || !highlightElements.length) {\n    return null;\n  }\n\n  const elements = Array.from(highlightElements);\n  if (elements.length === 1) {\n    const block = (viewKey ? controller.value.document.getNode(viewKey) : null) as Block | null;\n    let isSimple = true;\n    if (block && draggableConfig?.complexElements) {\n      const realType = getElementType(block);\n      isSimple = !draggableConfig.complexElements[realType];\n    }\n    // 单个元素也限制高度\n    if (isSimple && elements[0].clientHeight < MAX_FIT_HEIGHT) {\n      // 2.1.2\n      const codeScrollNode = elements[0].querySelector('.CodeMirror-scroll');\n      if (codeScrollNode && codeScrollNode.scrollTop) {\n        // HACK: 这里针对代码块做特别的处理：重置滚动防止偏差\n        codeScrollNode.scrollTop = 0;\n      }\n\n      const inline = (inlineKey ? controller.value.document.getNode(inlineKey) : null) as Inline | null;\n\n      // 对图片做特别处理：取图片包含高亮边框的那一层，防止边框显示不全\n      if (inline?.type === 'image') {\n        const imageNode = elements[0].closest('.image-data-wrapper') || elements[0];\n        return imageNode;\n      }\n      return elements[0];\n    }\n  }\n\n  // 2.1.1 or 2.2\n  let clientHeight = 0;\n  let clientWidth = 0;\n  const thumbnail = window.document.createElement('div');\n  const inner = window.document.createElement('div');\n\n  const maxLen = Math.min(MAX_ALLOW_ELEMENTS, elements.length);\n  for (let i = 0; i < maxLen; i++) {\n    const clonedNode = cloneElement(controller, elements[i]);\n    inner.appendChild(clonedNode);\n    clientHeight += (elements[i].clientHeight || 0);\n    clientWidth = Math.max(clientWidth, elements[i].clientWidth);\n  }\n\n  const scale = 1 / Math.max(1, clientHeight / MAX_FIT_HEIGHT);\n  inner.style.cssText = `background-color:#fff;transform-origin:0 0;transform:scale(${scale});width:${clientWidth}px;`;\n  thumbnail.appendChild(inner);\n\n  if (environment.IS_SAFARI) {\n    // Safari need thumbnail in viewport\n    thumbnail.style.cssText = 'position:fixed;top:99.9vh;left:99.9vh;';\n  } else {\n    thumbnail.style.cssText = 'position:fixed;top:9999px;left:9999px;';\n  }\n  thumbnail.id = DRAG_THUMBNAIL_ID;\n  window.document.body.appendChild(thumbnail);\n  return thumbnail;\n}\n"],"file":"getDragThumbnails.js"}