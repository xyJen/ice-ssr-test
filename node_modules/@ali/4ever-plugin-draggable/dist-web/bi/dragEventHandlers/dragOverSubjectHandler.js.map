{"version":3,"sources":["../../../../src/bi/dragEventHandlers/dragOverSubjectHandler.ts"],"names":["domUtils","Heading","DROP_POSITION","getBlockFromDragEvent","dragOverBlockHandler","SUBJECT_MARGIN","dropToSubject","event","controller","subject","data","subjectPr","subjectDOM","document","getElementById","id","findDOMNode","key","clientRect","getBoundingClientRect","rect","top","left","width","height","dropPosition","clientY","before","after","dropBlock","query","type","dropToCallout","block","calloutStartBlock","calloutDOM","value","prevBlock","getPreviousBlock","calloutEndBlock","nextBlock","getNextBlock","dragOverSubjectHandler","zoom","subjectStartBlock","isCallout"],"mappings":"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","sourcesContent":["/* eslint-disable react/no-find-dom-node */\nimport { Block, Controller, domUtils } from '@ali/4ever-cangjie';\nimport { ParagraphData } from '@ali/4ever-plugin-paragraph';\nimport { Heading, Heading1Data } from '@ali/4ever-plugin-heading';\nimport { DropHolderProps, DROP_POSITION, RECT } from '../types';\nimport { getBlockFromDragEvent } from '../utils/getRangeFromDragEvent';\nimport dragOverBlockHandler from './dragOverBlockHandler';\n\ntype Subject = Block<Heading1Data>;\n\ntype Callout = Block<ParagraphData>;\n\n/**\n * 议题边距 40px\n */\nconst SUBJECT_MARGIN = 40;\n\n/**\n * 议题拖拽至议题区域内\n * @param event\n * @param controller\n * @param subject\n * @returns\n */\nfunction dropToSubject(event: DragEvent, controller: Controller, subject: Subject): DropHolderProps | null {\n  const { subjectPr = {} } = subject.data;\n  // 先通过 id 找，找不到再通过 key 找\n  const subjectDOM = document.getElementById(subjectPr.id || '') || domUtils.findDOMNode(`${subject.key}-group`);\n\n  if (subjectDOM) {\n    // 议题的 Rect 取整个区块的大小再加上边距距离\n    const clientRect = subjectDOM.getBoundingClientRect();\n    const rect = {\n      top: clientRect.top - (SUBJECT_MARGIN / 2),\n      left: clientRect.left,\n      width: clientRect.width,\n      height: clientRect.height + SUBJECT_MARGIN,\n    };\n\n    const dropPosition = event.clientY < rect.top + (rect.height / 2) ? DROP_POSITION.before : DROP_POSITION.after;\n    const dropBlock = dropPosition === DROP_POSITION.before\n      ? subject\n      : controller.query('getSubjectEndBlock', subject) as Block;\n\n    // dropBlock 不存在\n    if (!dropBlock) {\n      return null;\n    }\n\n    return {\n      type: dropBlock.type,\n      key: dropBlock.key,\n      dropPosition,\n      rect,\n    };\n  }\n\n  return null;\n}\n\n/**\n * 议题拖拽至高亮块区域内\n * @param event\n * @param controller\n * @param block\n * @returns\n */\nfunction dropToCallout(event: DragEvent, controller: Controller, block: Callout): DropHolderProps | null {\n  const calloutStartBlock = controller.query('getCalloutStartBlock', block) as Callout;\n\n  if (!calloutStartBlock) {\n    return null;\n  }\n\n  const calloutDOM = domUtils.findDOMNode(`${calloutStartBlock.key}-group`);\n\n  if (calloutDOM) {\n    const clientRect = calloutDOM.getBoundingClientRect();\n    const { document } = controller.value;\n\n    let dropPosition: DROP_POSITION;\n    let dropBlock: Block;\n    let rect: RECT | undefined;\n\n    // drop 落在高亮块上方\n    if (event.clientY < clientRect.top + (clientRect.height / 2)) {\n      const prevBlock = document.getPreviousBlock(calloutStartBlock.key);\n      if (prevBlock) {\n        dropPosition = DROP_POSITION.after;\n        dropBlock = prevBlock;\n        rect = domUtils.findDOMNode(prevBlock.key).getBoundingClientRect();\n      } else {\n        dropPosition = DROP_POSITION.before;\n        dropBlock = calloutStartBlock;\n        rect = calloutDOM.getBoundingClientRect();\n      }\n    } else {\n      // drop 落在高亮块下方\n      const calloutEndBlock = controller.query('getCalloutEndBlock', block) as Callout;\n      const nextBlock = calloutEndBlock && document.getNextBlock(calloutEndBlock.key);\n\n      if (nextBlock) {\n        dropPosition = DROP_POSITION.before;\n        dropBlock = nextBlock;\n        rect = domUtils.findDOMNode(nextBlock.key).getBoundingClientRect();\n      } else if (calloutEndBlock) {\n        dropPosition = DROP_POSITION.after;\n        dropBlock = calloutEndBlock;\n        rect = calloutDOM.getBoundingClientRect();\n      } else {\n        return null;\n      }\n    }\n\n    return {\n      type: dropBlock.type,\n      key: dropBlock.key,\n      dropPosition,\n      rect,\n    };\n  }\n\n  return null;\n}\n\nfunction dragOverSubjectHandler(event: DragEvent, controller: Controller, zoom: number): DropHolderProps | null {\n  const block = getBlockFromDragEvent(controller, event, zoom);\n\n  // block 为找到则不处理\n  if (!block) {\n    return null;\n  }\n\n  // 若 block 在议题区块内，则只能落在议题前后\n  const subjectStartBlock = controller.query('getSubjectStartBlock', block) as Subject;\n  if (subjectStartBlock) {\n    return dropToSubject(event, controller, subjectStartBlock);\n  }\n\n  // 若 block 是高亮块，则只能落在区块前后\n  if (Heading.isCallout(block)) {\n    return dropToCallout(event, controller, block as Block);\n  }\n\n  // 若不在区块内，则直接返回 block 的 drop 点\n  return dragOverBlockHandler(event, controller);\n}\n\nexport default dragOverSubjectHandler;\n"],"file":"dragOverSubjectHandler.js"}