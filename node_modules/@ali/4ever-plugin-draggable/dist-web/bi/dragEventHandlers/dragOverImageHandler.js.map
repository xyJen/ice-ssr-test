{"version":3,"sources":["../../../../src/bi/dragEventHandlers/dragOverImageHandler.ts"],"names":["getDropPosFromBlock","getBlockFromDragEvent","getDropHolderDataFromViewKeys","getDraggableData","dragOverInlineHandler","updateImageDropHolder","updateBlockDropHolder","controller","dropBlock","event","test","key","undefined","dropKey","query","viewKeys","clientX","clientY","nextDropHolderData","length","dragOverImageHandler","dispatch","zoom","draggableData","dragFragment","fragment","type","block","run","dropHolder"],"mappings":";AACA,OAAOA,mBAAP;AACA,SAASC,qBAAT;AACA,OAAOC,6BAAP;AACA,SAASC,gBAAT;AACA,OAAOC,qBAAP;AAEA,SAASC,qBAAT;;AAEA,SAASC,qBAAT,CACEC,UADF,EAEEC,SAFF,EAGEC,KAHF,EAIE;AACA;AACA,MAAI,iBAAiBC,IAAjB,CAAsBF,SAAS,CAACG,GAAhC,CAAJ,EAA0C,OAAOC,SAAP;AAC1C,MAAMC,OAAO,GAAGN,UAAU,CAACO,KAAX,CAAiB,YAAjB,EAA+BN,SAAS,CAACG,GAAzC,KAAiDH,SAAS,CAACG,GAA3E;AACA,MAAMI,QAAQ,GAAGR,UAAU,CAACO,KAAX,CAAiB,aAAjB,EAAgCD,OAAhC,CAAjB;AAJA,MAKQG,OALR,GAK6BP,KAL7B,CAKQO,OALR;AAAA,MAKiBC,OALjB,GAK6BR,KAL7B,CAKiBQ,OALjB;AAMA,MAAIC,kBAAkB,GAAGlB,mBAAmB,CAACO,UAAD,EAAaC,SAAb,EAAwBQ,OAAxB,EAAiCC,OAAjC,EAA0C,IAA1C,CAA5C;;AACA,MAAIC,kBAAkB,IAAI,CAAAH,QAAQ,QAAR,YAAAA,QAAQ,CAAEI,MAAV,IAAmB,CAA7C,EAAgD;AAC9C;AACAD,IAAAA,kBAAkB,gBACbA,kBADa,EAEbhB,6BAA6B,CAACK,UAAD,EAAaE,KAAb,EAAoBM,QAApB,CAFhB,CAAlB;AAID;;AACD,SAAOG,kBAAP;AACD;;AAED,SAASE,oBAAT,CAA8BX,KAA9B,EAAgDF,UAAhD,EAAwEc,QAAxE,EAAuGC,IAAvG,EAA2H;AACzH,MAAMC,aAAa,GAAGpB,gBAAgB,CAACI,UAAD,CAAtC;AACA,MAAI,CAACgB,aAAL,EAAoB;AAFqG,MAIjHC,YAJiH,GAIhGD,aAJgG,CAIjHC,YAJiH,EAKzH;;AACA,MAAI,CAACA,YAAD,IAAkBA,YAAY,CAACC,QAAd,CAA2CC,IAA3C,KAAoD,OAAzE,EAAkF;AAElF,MAAMC,KAAK,GAAG1B,qBAAqB,CAACM,UAAD,EAAaE,KAAb,EAAoBa,IAApB,EAA0B,IAA1B,CAAnC;;AACA,MAAI,CAACK,KAAL,EAAY;AACV;AACApB,IAAAA,UAAU,CAACqB,GAAX,CAAe,UAAf,EAA2BvB,qBAAqB,CAAC;AAC/CgB,MAAAA,QAAQ,EAARA,QAD+C;AAE/CZ,MAAAA,KAAK,EAALA,KAF+C;AAG/CoB,MAAAA,UAAU,EAAE;AAHmC,KAAD,CAAhD;AAKAzB,IAAAA,qBAAqB,CAACK,KAAD,EAAQF,UAAR,CAArB;AACA;AACD;;AACD,MAAMW,kBAAkB,GAAGZ,qBAAqB,CAACC,UAAD,EAAaoB,KAAb,EAA6BlB,KAA7B,CAAhD;AACAF,EAAAA,UAAU,CAACqB,GAAX,CAAe,UAAf,EAA2BvB,qBAAqB,CAAC;AAC/CgB,IAAAA,QAAQ,EAARA,QAD+C;AAE/CZ,IAAAA,KAAK,EAALA,KAF+C;AAG/CoB,IAAAA,UAAU,EAAEX;AAHmC,GAAD,CAAhD;AAKD;;AAED,eAAeE,oBAAf","sourcesContent":["import { Controller, Block } from '@ali/4ever-cangjie';\nimport getDropPosFromBlock from '../utils/getDropPosFromBlock';\nimport { getBlockFromDragEvent } from '../utils/getRangeFromDragEvent';\nimport getDropHolderDataFromViewKeys from '../utils/getDropHolderDataFromViewKeys';\nimport { getDraggableData } from '../model/draggableData';\nimport dragOverInlineHandler from './dragOverInlineHandler';\nimport { DragInlineProps } from '../types';\nimport { updateImageDropHolder } from '../actions';\n\nfunction updateBlockDropHolder(\n  controller: Controller,\n  dropBlock: Block,\n  event: DragEvent,\n) {\n  // 不允许落到排版相关位置\n  if (/^page|^section/.test(dropBlock.key)) return undefined;\n  const dropKey = controller.query('getDataKey', dropBlock.key) || dropBlock.key;\n  const viewKeys = controller.query('getViewKeys', dropKey);\n  const { clientX, clientY } = event;\n  let nextDropHolderData = getDropPosFromBlock(controller, dropBlock, clientX, clientY, true);\n  if (nextDropHolderData && viewKeys?.length > 1) {\n    // 兼容分页下段落跨页情形\n    nextDropHolderData = {\n      ...nextDropHolderData,\n      ...getDropHolderDataFromViewKeys(controller, event, viewKeys),\n    };\n  }\n  return nextDropHolderData;\n}\n\nfunction dragOverImageHandler(event: DragEvent, controller: Controller, dispatch: React.Dispatch<any>, zoom: number): void {\n  const draggableData = getDraggableData(controller);\n  if (!draggableData) return;\n\n  const { dragFragment } = draggableData;\n  // 仅处理图片\n  if (!dragFragment || (dragFragment.fragment as DragInlineProps).type !== 'image') return;\n\n  const block = getBlockFromDragEvent(controller, event, zoom, true);\n  if (!block) {\n    // 段中拖拽\n    controller.run('onAction', updateImageDropHolder({\n      dispatch,\n      event,\n      dropHolder: null,\n    }));\n    dragOverInlineHandler(event, controller);\n    return;\n  }\n  const nextDropHolderData = updateBlockDropHolder(controller, block as Block, event);\n  controller.run('onAction', updateImageDropHolder({\n    dispatch,\n    event,\n    dropHolder: nextDropHolderData,\n  }));\n}\n\nexport default dragOverImageHandler;\n"],"file":"dragOverImageHandler.js"}