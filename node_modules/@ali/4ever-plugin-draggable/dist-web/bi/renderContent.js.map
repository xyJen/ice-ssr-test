{"version":3,"sources":["../../../src/bi/renderContent.tsx"],"names":["React","useMemo","useCallback","useZoomContainer","useZoom","DropHolder","DragHighlightStyle","DraggableContext","useValue","updateDragHander","clearDropHolder","dragOverHandler","checkAndUpdatePosition","dropHandler","dragEndHandler","removeDragHightlight","updateDraggableData","DraggableProvider","props","draggableData","dispatch","zoom","controller","draggableConfig","handleDragChange","value","onKeyDown","dragHander","viewKey","onDragOver","event","pageX","pageY","onDrop","cancel","dropHolder","onDragEnd","zoomContainer","useEffect","undefined","addEventListener","document","removeEventListener","children","config","next","draggable","enabled"],"mappings":"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","sourcesContent":["/* eslint-disable react-hooks/exhaustive-deps */\nimport React, { useMemo, useCallback } from 'react';\nimport { Controller, RenderContentProps, useZoomContainer, useZoom, BiPluginConfig } from '@ali/4ever-cangjie';\nimport DropHolder from './components/dropHolder';\nimport { DragHighlightStyle } from './components/styled';\nimport { DraggableContext, useValue } from './draggableContext';\nimport { updateDragHander, clearDropHolder, deleteDragFragment } from './actions';\nimport { DraggablePluginConfig } from './types';\nimport dragOverHandler, { checkAndUpdatePosition } from './dragEventHandlers/dragOverHandler';\nimport dropHandler from './dragEventHandlers/dropHandler';\nimport dragEndHandler from './dragEventHandlers/dragEndHandler';\nimport mouseMoveHandler from './dragEventHandlers/mouseMoveHandler';\nimport { removeDragHightlight, removeDragHolderWrapper } from './utils/domUtils';\nimport { updateDraggableData } from './model/draggableData';\n\ninterface DraggableProviderProps extends Pick<RenderContentProps, 'zoom' | 'children'> {\n  controller: Controller;\n  draggableConfig?: DraggablePluginConfig;\n  handleDragChange: (\n    action: 'clear' | 'disable' | 'enable',\n    controller: Controller,\n  ) => {};\n}\n\nconst DraggableProvider = (props: DraggableProviderProps) => {\n  const [draggableData, dispatch] = useValue();\n  const zoom = useZoom();\n  const { controller, draggableConfig, handleDragChange } = props;\n  const value = useMemo(() => {\n    /**\n     * PERF\n     * never get the data from context when it change constantly or a lot of components useContext\n     * it will cause DISASTER\n     */\n    return {\n      dispatch,\n    };\n  }, [dispatch]);\n\n  const onKeyDown = useCallback(() => {\n    if (draggableData.dragHander?.viewKey) {\n      dispatch(updateDragHander());\n      removeDragHightlight();\n    }\n  }, [dispatch, draggableData]);\n\n  const onDragOver = useCallback((event: DragEvent) => {\n    if (checkAndUpdatePosition(event.pageX, event.pageY)) {\n      dragOverHandler(event, controller, dispatch, zoom, draggableConfig);\n    }\n  }, [controller, dispatch, zoom, draggableConfig]);\n\n  const onDrop = useCallback((event: DragEvent) => {\n    // 取消，避免延迟触发\n    dragOverHandler.cancel();\n    // 清除 UI 拖拽数据\n    dispatch(clearDropHolder());\n    // onDrop triggered means onDragEnd not trigger\n    dropHandler(event, controller, draggableData.dropHolder);\n    dragEndHandler(controller);\n    checkAndUpdatePosition();\n    handleDragChange('clear', controller);\n  }, [dispatch, controller, draggableData]);\n\n  const onDragEnd = useCallback(() => {\n    // 取消拖拽\n    updateDraggableData(controller);\n    dragEndHandler(controller);\n    dispatch(clearDropHolder());\n    checkAndUpdatePosition();\n    handleDragChange('clear', controller);\n  }, [controller, dispatch]);\n\n  const zoomContainer = useZoomContainer();\n\n  React.useEffect(() => {\n    if (!zoomContainer) {\n      return undefined;\n    }\n    zoomContainer.addEventListener('dragover', onDragOver);\n    document.addEventListener('keydown', onKeyDown);\n    zoomContainer.addEventListener('drop', onDrop);\n    document.addEventListener('dragend', onDragEnd);\n    return () => {\n      zoomContainer.removeEventListener('dragover', onDragOver);\n      document.removeEventListener('keydown', onKeyDown);\n      zoomContainer.removeEventListener('drop', onDrop);\n      document.removeEventListener('dragend', onDragEnd);\n    };\n  }, [zoomContainer, onDragOver, onKeyDown, onDrop, onDragEnd]);\n\n  return (\n    <DraggableContext.Provider value={value}>\n      {/* PERF: 使用 props.children 避免 next 在 hook 变更时 rerender */}\n      {props.children}\n      <DragHighlightStyle/>\n      <DropHolder {...draggableData} controller={controller} />\n    </DraggableContext.Provider>\n  );\n};\n\nexport default (config: BiPluginConfig, handleDragChange: (action: 'clear' | 'disable' | 'enable', controller: Controller) => {}) => {\n  return (props: RenderContentProps, controller: Controller, next) => {\n    if (config.draggable?.enabled) {\n      return (\n        <DraggableProvider draggableConfig={config.draggable} controller={controller} zoom={props.zoom} handleDragChange={handleDragChange}>\n          {next()}\n        </DraggableProvider>\n      );\n    }\n    return next();\n  };\n};\n"],"file":"renderContent.js"}