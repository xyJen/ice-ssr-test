{"version":3,"sources":["../../../../src/bi/utils/getDropPosFromBlock.ts"],"names":["COLUMN_ITEM","COLUMNS_TABLE","getDropPosFromBlock","controller","block","x","y","onlyHorizon","dropHolder","dropDomNode","document","value","dropPosition","rect","getBoundingClientRect","tableNode","closest","tableRect","left","DROP_POSITION","right","table","getClosest","key","n","query","type","top","width","height","isHorizon","before","after","parentColumn","columnsRect","newRect","draggableData","pagePosition","undefined","isInTable","preDropNode","getPreviousSibling","preDropDomNode","Heading","isCallout","preDomRect","bottom"],"mappings":"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","sourcesContent":["import { Controller, Block } from '@ali/4ever-cangjie';\nimport {\n  DropHolderProps,\n  DROP_POSITION,\n} from '../types';\nimport getClosestDom from './getClosestDom';\nimport { getDraggableData } from '../model/draggableData';\nimport { Heading } from '@ali/4ever-plugin-heading';\n\nconst COLUMN_ITEM = 'data-column';\nconst COLUMNS_TABLE = 'data-columns';\n\nexport default function getDropPosFromBlock(controller: Controller, block: Block, x: number, y: number, onlyHorizon?: boolean) {\n  let dropHolder: DropHolderProps | null = null;\n  const dropDomNode = getClosestDom(block);\n  if (!dropDomNode) return dropHolder;\n  const { document } = controller.value;\n\n  let dropPosition: DROP_POSITION | undefined;\n  const rect = dropDomNode.getBoundingClientRect();\n\n  // <table> 包含了滚动，这里需要取 <table> 的上一层\n  const tableNode = dropDomNode.closest('table')?.closest('[data-cangjie-key]');\n  const tableRect = tableNode?.getBoundingClientRect();\n\n  // 判断是否是左右方向。\n  // case 1，普通元素的拖拽\n  if (!tableRect) {\n    if (x <= rect.left) {\n      dropPosition = DROP_POSITION.left;\n    }\n    if (x >= rect.right) {\n      dropPosition = DROP_POSITION.right;\n    }\n  // case 2，表格需要单独处理\n  } else if (x < tableRect.left || x > tableRect.right) {\n    // 此时一定是左右拖拽了。\n    dropPosition = x < tableRect.left ? DROP_POSITION.left : DROP_POSITION.right;\n    // 这里取父元素，作为 target node\n    const table = document.getClosest(block.key, n => {\n      return !!controller.query('isTable', n);\n    }) as Block;\n    dropHolder = {\n      type: table.type,\n      rect: {\n        top: tableRect.top,\n        left: tableRect.left,\n        width: tableRect.width,\n        height: tableRect.height,\n      },\n      key: table.key,\n      dropPosition,\n    };\n  }\n\n  const isHorizon = dropPosition === DROP_POSITION.left || dropPosition === DROP_POSITION.right;\n  // 仅左右分栏时，若不满足拖拽到段左、段右，直接返回\n  if (onlyHorizon && !isHorizon) return dropHolder;\n  if (!dropPosition) {\n    dropPosition = y < rect.top + rect.height / 2 ? DROP_POSITION.before : DROP_POSITION.after;\n  }\n\n  // 如果之前没有定义的话，现在可以使用 block 赋值\n  if (!dropHolder) {\n    dropHolder = {\n      type: block.type,\n      rect: {\n        top: rect.top,\n        left: rect.left,\n        width: rect.width,\n        height: rect.height,\n      },\n      key: block.key,\n      dropPosition,\n    };\n  }\n\n  // 如果存在分栏拖拽，单独处理一下 rect。（target node 不需要处理）\n  const parentColumn = dropDomNode.closest(`[${COLUMN_ITEM}]`);\n  if (parentColumn && isHorizon) {\n    const columnsRect = parentColumn.closest(`[${COLUMNS_TABLE}]`)?.getBoundingClientRect();\n    if (!columnsRect) {\n      return dropHolder;\n    }\n    const newRect = parentColumn.getBoundingClientRect();\n    const { left, width } = newRect;\n    const { top, height } = columnsRect;\n    dropHolder.rect = { top, left, width, height };\n  }\n\n  // 处理跨页的情况：pagePosition（由分页模式下的 renderController 计算）\n  // 如果有跨页则覆盖 dropPosition 和 rect\n  const draggableData = getDraggableData(controller);\n  const pagePosition = draggableData?.dropHolder?.pagePosition;\n  if (draggableData && pagePosition !== undefined) {\n    dropHolder.dropPosition = pagePosition;\n    dropHolder.rect = draggableData.dropHolder?.rect;\n  }\n\n  const isInTable = controller.query('isNodeInTable', block);\n  if (\n    pagePosition === undefined &&\n    dropPosition === DROP_POSITION.before &&\n    !isInTable\n  ) {\n    const preDropNode = document.getPreviousSibling(block.key) as Block | null;\n\n    // 高亮块下的元素则不修正\n    const preDropDomNode = preDropNode && !Heading.isCallout(preDropNode) ? getClosestDom(preDropNode) : null;\n    if (preDropDomNode && dropHolder.rect) {\n      // 修正：drop 位置处于元素上方时，取前一个元素的 bottom，确保两个元素之间只有一根线\n      const preDomRect = preDropDomNode.getBoundingClientRect();\n      dropHolder.rect = {\n        top: preDomRect.bottom,\n        left: preDomRect.left,\n        height: preDomRect.height,\n        width: preDomRect.width,\n      };\n    }\n  }\n  return dropHolder;\n}\n"],"file":"getDropPosFromBlock.js"}