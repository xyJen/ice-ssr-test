"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = getDragThumbnails;

var _everCangjie = require("@ali/4ever-cangjie");

var _everPluginHeading = require("@ali/4ever-plugin-heading");

var _everPluginParagraph = require("@ali/4ever-plugin-paragraph");

var _getClosestDom = _interopRequireDefault(require("./getClosestDom"));

var _domUtils = require("./domUtils");

var _getElementType = _interopRequireDefault(require("./getElementType"));

const MAX_FIT_HEIGHT = 200;
const MAX_ALLOW_ELEMENTS = 15;

function createFakeThumbnail(element) {
  const fakeElement = window.document.createElement('div');
  fakeElement.style.cssText = `width:${element.clientWidth}px;height:${element.clientHeight}px;background-color:rgba(17,31,44,0.08);`;
  return fakeElement;
}

function isComplexElement(controller, element) {
  const viewNode = element.closest('[data-cangjie-leaf-block]') || element;
  if (!viewNode) return true;
  const viewKey = viewNode.getAttribute('data-cangjie-key');
  if (!viewKey) return true;
  const block = controller.value.document.getNode(viewKey);
  return !(_everPluginParagraph.Paragraph.isParagraph(block) || _everPluginHeading.Heading.isHeading(block));
}

function cloneElement(controller, element) {
  const isComplex = isComplexElement(controller, element);
  if (!isComplex) return element.cloneNode(true);
  return createFakeThumbnail(element);
}
/**
 * 获取拖拽的缩略图
 * 策略：最多允许 15 个元素生成缩略图，如果元素高度大于 300 将做缩放
 * 1. 行内元素直接返回元素 dom 节点
 * 2. 块级元素
 *  2.1 单个
 *    2.1.1 不是拖拽配置声明的复杂元素类型：返回元素 dom 节点
 *    2.1.2 是拖拽配置声明的复杂元素类型：返回 fake 占位 dom
 *  2.2 多个
 *    2.2.1 是 paragraph 或 heading：深度克隆元素
 *    2.2.2 不是：生成 fake 占位 dom
 * @param controller
 * @param keys
 * @param draggableConfig
 */


function getDragThumbnails(controller, keys, draggableConfig) {
  const {
    inlineKey,
    viewKey
  } = keys;
  let highlightElements = []; // 1 处理行内元素

  if (inlineKey) {
    const inlineDom = (0, _getClosestDom.default)(controller.value.document.getNode(inlineKey));
    highlightElements = inlineDom ? [inlineDom] : [];
  } else {
    // 根据当前高亮的元素查询
    highlightElements = window.document.querySelectorAll(`.${_domUtils.DRAG_HIGHLIGHT_CLASSNAME}`); // 由于表格走的不是通用的拖拽高亮逻辑，因此这里需要处理一下拖拽表格的情况

    if (!highlightElements.length) {
      highlightElements = window.document.querySelectorAll(`.${_domUtils.DRAG_HIGHLIGHT_TABLE_CLASSNAME}`);
    }
  }

  if (!highlightElements || !highlightElements.length) {
    return null;
  }

  const elements = Array.from(highlightElements);

  if (elements.length === 1) {
    const block = viewKey ? controller.value.document.getNode(viewKey) : null;
    let isSimple = true;

    if (block && draggableConfig?.complexElements) {
      const realType = (0, _getElementType.default)(block);
      isSimple = !draggableConfig.complexElements[realType];
    } // 单个元素也限制高度


    if (isSimple && elements[0].clientHeight < MAX_FIT_HEIGHT) {
      // 2.1.2
      const codeScrollNode = elements[0].querySelector('.CodeMirror-scroll');

      if (codeScrollNode && codeScrollNode.scrollTop) {
        // HACK: 这里针对代码块做特别的处理：重置滚动防止偏差
        codeScrollNode.scrollTop = 0;
      }

      const inline = inlineKey ? controller.value.document.getNode(inlineKey) : null; // 对图片做特别处理：取图片包含高亮边框的那一层，防止边框显示不全

      if (inline?.type === 'image') {
        const imageNode = elements[0].closest('.image-data-wrapper') || elements[0];
        return imageNode;
      }

      return elements[0];
    }
  } // 2.1.1 or 2.2


  let clientHeight = 0;
  let clientWidth = 0;
  const thumbnail = window.document.createElement('div');
  const inner = window.document.createElement('div');
  const maxLen = Math.min(MAX_ALLOW_ELEMENTS, elements.length);

  for (let i = 0; i < maxLen; i++) {
    const clonedNode = cloneElement(controller, elements[i]);
    inner.appendChild(clonedNode);
    clientHeight += elements[i].clientHeight || 0;
    clientWidth = Math.max(clientWidth, elements[i].clientWidth);
  }

  const scale = 1 / Math.max(1, clientHeight / MAX_FIT_HEIGHT);
  inner.style.cssText = `background-color:#fff;transform-origin:0 0;transform:scale(${scale});width:${clientWidth}px;`;
  thumbnail.appendChild(inner);

  if (_everCangjie.environment.IS_SAFARI) {
    // Safari need thumbnail in viewport
    thumbnail.style.cssText = 'position:fixed;top:99.9vh;left:99.9vh;';
  } else {
    thumbnail.style.cssText = 'position:fixed;top:9999px;left:9999px;';
  }

  thumbnail.id = _domUtils.DRAG_THUMBNAIL_ID;
  window.document.body.appendChild(thumbnail);
  return thumbnail;
}
//# sourceMappingURL=getDragThumbnails.js.map