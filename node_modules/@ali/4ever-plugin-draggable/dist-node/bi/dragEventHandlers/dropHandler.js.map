{"version":3,"sources":["../../../../src/bi/dragEventHandlers/dropHandler.ts"],"names":["dropHandler","event","controller","dropHolder","preventDefault","draggableData","dragFragment","fragmentData","isCopy","dataTransfer","effectAllowed","key","query","run","getData","APPLICATION_CANGJIE_DRAG_FRAGMENT","dragFragmentData","JSON","parse","e","html","TEXT_HTML","TEXT_PLAIN"],"mappings":";;;;;;;;;AAEA;;AACA;;AACA;;AACA;;AAEA,MAAMA,WAAW,GAAG,CAClBC,KADkB,EAElBC,UAFkB,EAGlBC,UAHkB,KAIf;AACH;AACA,MAAI,4BAAcF,KAAd,CAAJ,EAA0B;AAE1BA,EAAAA,KAAK,CAACG,cAAN;AACA,QAAMC,aAAa,GAAG,qCAAiBH,UAAjB,CAAtB;;AACA,MAAIG,aAAa,EAAEC,YAAnB,EAAiC;AAC/B,UAAMC,YAAY,GAAG,EACnB,GAAGF,aADgB;AAEnBG,MAAAA,MAAM,EAAEP,KAAK,CAACQ,YAAN,EAAoBC,aAApB,KAAsC;AAF3B,KAArB;;AAIA,QAAIP,UAAU,EAAEQ,GAAhB,EAAqB;AACnB;AACAJ,MAAAA,YAAY,CAACJ,UAAb,GAA0B,EACxB,GAAGA,UADqB;AAExBQ,QAAAA,GAAG,EAAET,UAAU,CAACU,KAAX,CAAiB,YAAjB,EAA+BT,UAAU,CAACQ,GAA1C,KAAkDR,UAAU,CAACQ;AAF1C,OAA1B;AAID;;AACD,WAAOT,UAAU,CAACW,GAAX,CAAe,UAAf,EAA2B,2BAAaN,YAAb,CAA3B,CAAP;AACD;;AAED,QAAMD,YAAY,GAAGL,KAAK,CAACQ,YAAN,EAAoBK,OAApB,CAA4BC,4CAA5B,CAArB;;AACA,MAAIT,YAAJ,EAAkB;AAChB,QAAIU,gBAA0C,GAAG,IAAjD;;AACA,QAAI;AACFA,MAAAA,gBAAgB,GAAGC,IAAI,CAACC,KAAL,CAAWZ,YAAX,CAAnB;AACD,KAFD,CAEE,OAAOa,CAAP,EAAU,CACV;AACD;;AACD,QAAIH,gBAAJ,EAAsB;AACpB,aAAOd,UAAU,CAACW,GAAX,CAAe,UAAf,EAA2B,gCAAkB;AAClDP,QAAAA,YAAY,EAAE,EAAE,GAAGU;AAAL;AADoC,OAAlB,CAA3B,CAAP;AAGD;AACF;;AAED,QAAMI,IAAI,GAAGnB,KAAK,CAACQ,YAAN,EAAoBK,OAApB,CAA4BO,oBAA5B,KAA0CpB,KAAK,CAACQ,YAAN,EAAoBK,OAApB,CAA4BQ,qBAA5B,CAAvD;;AAEA,MAAIF,IAAJ,EAAU;AACR,WAAOlB,UAAU,CAACW,GAAX,CAAe,UAAf,EAA2B,uBAASO,IAAT,CAA3B,CAAP;AACD;AACF,CA7CD;;eA+CepB,W","sourcesContent":["import { Controller } from '@ali/4ever-cangjie';\nimport { DragFragmentProps, DropHolderProps } from '../types';\nimport { APPLICATION_CANGJIE_DRAG_FRAGMENT, TEXT_HTML, TEXT_PLAIN } from '@ali/4ever-utils';\nimport { dropFragment, dropEventFragment, dropHtml } from '../actions';\nimport { getDraggableData } from '../model/draggableData';\nimport isNotEditable from '../utils/isNotEditable';\n\nconst dropHandler = (\n  event: DragEvent,\n  controller: Controller,\n  dropHolder?: DropHolderProps,\n) => {\n  // 不响应链路上含有 data-cangjie-not-editable 的 drop 事件\n  if (isNotEditable(event)) return;\n\n  event.preventDefault();\n  const draggableData = getDraggableData(controller);\n  if (draggableData?.dragFragment) {\n    const fragmentData = {\n      ...draggableData,\n      isCopy: event.dataTransfer?.effectAllowed === 'copy',\n    };\n    if (dropHolder?.key) {\n      // 兼容排版\n      fragmentData.dropHolder = {\n        ...dropHolder,\n        key: controller.query('getDataKey', dropHolder.key) || dropHolder.key,\n      };\n    }\n    return controller.run('onAction', dropFragment(fragmentData));\n  }\n\n  const dragFragment = event.dataTransfer?.getData(APPLICATION_CANGJIE_DRAG_FRAGMENT);\n  if (dragFragment) {\n    let dragFragmentData: DragFragmentProps | null = null;\n    try {\n      dragFragmentData = JSON.parse(dragFragment) as DragFragmentProps;\n    } catch (e) {\n      // do nothing\n    }\n    if (dragFragmentData) {\n      return controller.run('onAction', dropEventFragment({\n        dragFragment: { ...dragFragmentData },\n      }));\n    }\n  }\n\n  const html = event.dataTransfer?.getData(TEXT_HTML) || event.dataTransfer?.getData(TEXT_PLAIN);\n\n  if (html) {\n    return controller.run('onAction', dropHtml(html));\n  }\n};\n\nexport default dropHandler;\n"],"file":"dropHandler.js"}