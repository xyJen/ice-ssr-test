{"version":3,"file":"getVisibleRectForElement.js","names":["getVisibleRectForElement","element","alwaysByViewport","visibleRect","left","right","Infinity","top","bottom","el","getOffsetParent","doc","utils","getDocument","win","defaultView","parentWindow","body","documentElement","navigator","userAgent","indexOf","clientWidth","css","pos","offset","clientLeft","clientTop","Math","max","min","clientHeight","originalPosition","isWindow","isDocument","style","position","scrollX","getWindowScrollLeft","scrollY","getWindowScrollTop","viewportWidth","domUtils","viewportHeight","documentWidth","scrollWidth","documentHeight","scrollHeight","bodyStyle","window","getComputedStyle","overflowX","innerWidth","overflowY","innerHeight","isAncestorFixed","maxVisibleWidth","maxVisibleHeight"],"sources":["../../../../../src/common/domAlign/calc/getVisibleRectForElement.tsx"],"sourcesContent":["import { utils } from '../utils/utils';\nimport { domUtils } from '../utils/dom-utils';\nimport getOffsetParent from './getOffsetParent';\nimport isAncestorFixed from './isAncestorFixed';\nimport type { IRegion, IVisibleRect } from '../interface';\n\n/**\n * 获得元素的显示部分的区域，其实是获取会影响该元素显示区域的祖先元素内容区域的交集\n * http://yiminghe.iteye.com/blog/1124720\n */\nfunction getVisibleRectForElement(element: HTMLElement, alwaysByViewport?: boolean): IVisibleRect | null {\n  // 首先可视区域为整个文档\n  const visibleRect = {\n    left: 0,\n    right: Infinity,\n    top: 0,\n    bottom: Infinity,\n  };\n  let el = getOffsetParent(element);\n  const doc = utils.getDocument(element);\n  const win = (doc.defaultView || doc.parentWindow) as Window;\n  const body = doc.body;\n  const documentElement = doc.documentElement;\n\n  // Determine the size of the visible rect by climbing the dom accounting for\n  // all scrollable containers.\n  // 即通过依次向 目标元素 的祖先元素递归,查找到会影响该元素显示的祖先元素\n  // 得到 目标元素 的相对文档的 { left,right,top,bottom }\n  // 简单理解为祖先中每一层父级都会对可视区域进行削减\n  // 因此所有`影响显示区域`的祖先元素的区域的交集即为最终的结果\n  while (el) {\n    // clientWidth is zero for inline block elements in ie.\n    if (\n      (navigator.userAgent.indexOf('MSIE') === -1 || el.clientWidth !== 0) &&\n      // body may have overflow set on it, yet we still get the entire\n      // viewport. In some browsers, el.offsetParent may be\n      // document.documentElement, so check for that too.\n      (el !== body &&\n        el !== documentElement &&\n        utils.css(el, 'overflow') !== 'visible')\n    ) {\n      const pos = utils.offset(el) as IRegion;\n      // add border\n      pos.left += el.clientLeft;\n      pos.top += el.clientTop;\n  \n      // 以下代码即为 做区域的交集,不断的缩小区域, 不考虑滚动条\n      visibleRect.top = Math.max(visibleRect.top, pos.top);\n      visibleRect.right = Math.min(\n        visibleRect.right,\n        // consider area without scrollBar\n        pos.left + el.clientWidth,\n      );\n      visibleRect.bottom = Math.min(\n        visibleRect.bottom,\n        pos.top + el.clientHeight,\n      );\n      visibleRect.left = Math.max(visibleRect.left, pos.left);\n    } else if (el === body || el === documentElement) {\n      break;\n    }\n    el = getOffsetParent(el);\n  }\n\n  // 根据 document，和window 元素对区域进行剪裁\n  // ele.style.position 只能返回行内样式 position 中的值，不能返回 css 样式表中的值\n  // window.getComputedStyle(ele).position 会返回元素最终的 position 值，不管是style中还是css中的\n  // Set element position to fixed\n  // make sure absolute element itself don't affect it's visible area\n  // https://github.com/ant-design/ant-design/issues/7601\n  let originalPosition: string | null = null;\n  if (!utils.isWindow(element) && !utils.isDocument(element)) {\n    originalPosition = element.style.position;\n    const position = utils.css(element, 'position');\n    if (position === 'absolute') {\n      element.style.position = 'fixed';\n    }\n  }\n\n  const scrollX = utils.getWindowScrollLeft(win);\n  const scrollY = utils.getWindowScrollTop(win);\n  const viewportWidth = domUtils.viewportWidth(win);\n  const viewportHeight = domUtils.viewportHeight(win);\n  let documentWidth = documentElement.scrollWidth;\n  let documentHeight = documentElement.scrollHeight;\n\n  // scrollXXX on html is sync with body which means overflow: hidden on body gets wrong scrollXXX.\n  // We should cut this ourself.\n  const bodyStyle = window.getComputedStyle(body);\n  if (bodyStyle.overflowX === 'hidden') {\n    documentWidth = win.innerWidth;\n  }\n  if (bodyStyle.overflowY === 'hidden') {\n    documentHeight = win.innerHeight;\n  }\n\n  // Reset element position after calculate the visible area\n  if (element.style && originalPosition) {\n    element.style.position = originalPosition;\n  }\n\n  // document can be larger than the viewport\n  if (alwaysByViewport || isAncestorFixed(element)) {\n    // Clip by viewport's size.\n    visibleRect.left = Math.max(visibleRect.left, scrollX);\n    visibleRect.top = Math.max(visibleRect.top, scrollY);\n    visibleRect.right = Math.min(visibleRect.right, scrollX + viewportWidth);\n    visibleRect.bottom = Math.min(visibleRect.bottom, scrollY + viewportHeight);\n  } else {\n    // Clip by document's size.\n    const maxVisibleWidth = Math.max(documentWidth, scrollX + viewportWidth);\n    visibleRect.right = Math.min(visibleRect.right, maxVisibleWidth);\n\n    const maxVisibleHeight = Math.max(documentHeight, scrollY + viewportHeight);\n    visibleRect.bottom = Math.min(visibleRect.bottom, maxVisibleHeight);\n  }\n\n  // 最后确保该可视区域是 `正常的` 因为 top 小于 0 是不现实的。内容不可能在文档之外\n  return visibleRect.top >= 0 &&\n    visibleRect.left >= 0 &&\n    visibleRect.bottom > visibleRect.top &&\n    visibleRect.right > visibleRect.left\n    ? visibleRect\n    : null;\n}\n\nexport default getVisibleRectForElement;\n"],"mappings":"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"}