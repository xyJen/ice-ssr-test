{"version":3,"file":"size-utils.js","names":["BOX_MODELS","CONTENT_INDEX","MARGIN_INDEX","BORDER_INDEX","PADDING_INDEX","isBorderBoxFn","elem","getComputedStyleX","swap","options","callback","old","style","Object","keys","forEach","key","call","getPBMWidth","props","which","value","prop","j","i","length","cssProp","parseFloat","getWH","name","ex","extra","utils","isWindow","domUtils","viewportWidth","viewportHeight","isDocument","docWidth","docHeight","borderBoxValue","Math","floor","getBoundingClientRect","width","height","isBorderBox","cssBoxValue","undefined","Number","String","borderBoxValueOrIsBorderBox","val","slice","cssShow","position","visibility","display","getWHIgnoreDisplay","args","offsetWidth","apply"],"sources":["../../../../../src/common/domAlign/utils/size-utils.tsx"],"sourcesContent":["import type { ICssPropertyName } from '../interface';\nimport { utils } from './utils';\nimport { domUtils } from './dom-utils';\nimport { getComputedStyleX } from './getComputedStyle';\nimport React from 'react';\n\nconst BOX_MODELS: ICssPropertyName[] = ['margin', 'border', 'padding'];\n\nexport const CONTENT_INDEX = -1;\nexport const MARGIN_INDEX = 0;\nexport const BORDER_INDEX = 1;\nconst PADDING_INDEX = 2;\n\nfunction isBorderBoxFn(elem: HTMLElement): boolean {\n  return getComputedStyleX(elem, 'boxSizing') === 'border-box';\n}\n\nfunction swap(elem: HTMLElement, options: React.CSSProperties, callback: Function) {\n  const old: React.CSSProperties = {};\n  const style = elem.style;\n\n  // Remember the old values, and insert the new ones\n  // 老的写法\n  // for (const name in options) {\n  //   if (options.hasOwnProperty(name)) {\n  //     old[name] = style[name];\n  //     style[name] = options[name];\n  //   }\n  // }\n  Object.keys(options).forEach((key) => {\n    (old as any)[key] = (style as any)[key];\n    (style as any)[key] = (options as any)[key];\n  });\n\n  callback.call(elem);\n\n  // Revert the old values\n  // 老的写法\n  // for (const name in options) {\n  //   if (options.hasOwnProperty(name)) {\n  //     style[name] = old[name];\n  //   }\n  // }\n  Object.keys(options).forEach((key) => {\n    (style as any)[key] = (old as any)[key];\n  });\n}\n\nfunction getPBMWidth(elem: HTMLElement, props: ICssPropertyName[], which: ['Left', 'Right'] | ['Top', 'Bottom']) {\n  let value = 0;\n  let prop;\n  let j;\n  let i;\n  for (j = 0; j < props.length; j++) {\n    prop = props[j];\n    if (prop) {\n      for (i = 0; i < which.length; i++) {\n        let cssProp;\n        if (prop === 'border') {\n          cssProp = `${prop}${which[i]}Width`;\n        } else {\n          cssProp = prop + which[i];\n        }\n        value += parseFloat(getComputedStyleX(elem, cssProp)) || 0;\n      }\n    }\n  }\n  return value;\n}\n\n/*\n 得到元素的大小信息\n @param elem\n @param name: width / height\n @param {String} [extra]  'padding' : (css width) + padding\n 'border' : (css width) + padding + border\n 'margin' : (css width) + padding + border + margin\n */\n function getWH(elem: HTMLElement, name: string, ex?: number): number {\n  let extra = ex;\n\n  if (utils.isWindow(elem)) {\n    return name === 'width' ? domUtils.viewportWidth(elem) : domUtils.viewportHeight(elem);\n  } else if (utils.isDocument(elem)) {\n    return name === 'width' ? domUtils.docWidth(elem) : domUtils.docHeight(elem);\n  }\n\n  const which: ['Left', 'Right'] | ['Top', 'Bottom'] = name === 'width' ? ['Left', 'Right'] : ['Top', 'Bottom'];\n  // 这里使用clientXX而不是getBoundingClientRect是因为拿到的宽高不准确，比实际小\n  let borderBoxValue: number | null | undefined = name === 'width' ? Math.floor(elem.getBoundingClientRect().width) : Math.floor(elem.getBoundingClientRect().height);\n  const isBorderBox = isBorderBoxFn(elem);\n  let cssBoxValue: string | number | null | undefined = 0;\n\n  if (borderBoxValue === null || borderBoxValue === undefined || borderBoxValue <= 0) {\n    borderBoxValue = undefined;\n    // Fall back to computed then un computed css if necessary\n    cssBoxValue = getComputedStyleX(elem, name);\n    if (cssBoxValue === null || cssBoxValue === undefined || Number(cssBoxValue) < 0) {\n      cssBoxValue = (elem.style[name as keyof CSSStyleDeclaration] as number) || 0;\n    }\n    // Normalize '', auto, and prepare for extra\n    cssBoxValue = parseFloat(String(cssBoxValue)) || 0;\n  }\n\n  if (extra === undefined) {\n    extra = isBorderBox ? BORDER_INDEX : CONTENT_INDEX;\n  }\n\n  const borderBoxValueOrIsBorderBox = borderBoxValue !== undefined || isBorderBox;\n  const val = borderBoxValue || cssBoxValue;\n\n  if (extra === CONTENT_INDEX) {\n    if (borderBoxValueOrIsBorderBox) {\n      return val - getPBMWidth(elem, ['border', 'padding'], which);\n    }\n    return cssBoxValue;\n  } else if (borderBoxValueOrIsBorderBox) {\n    if (extra === BORDER_INDEX) {\n      return val;\n    }\n    return (val + (extra === PADDING_INDEX ? -getPBMWidth(elem, ['border'], which): getPBMWidth(elem, ['margin'], which)));\n  }\n  return cssBoxValue + getPBMWidth(elem, BOX_MODELS.slice(extra), which);\n}\n\nconst cssShow: React.CSSProperties = {\n  position: 'absolute',\n  visibility: 'hidden',\n  display: 'block',\n};\n\n// fix #119 : https://github.com/kissyteam/kissy/issues/119\nfunction getWHIgnoreDisplay(...args: [HTMLElement, ICssPropertyName, number]): number {\n  let val;\n  const elem = args[0];\n  // in case elem is window\n  // elem.offsetWidth === undefined\n  if (elem.offsetWidth !== 0) {\n    val = getWH.apply(undefined, args);\n  } else {\n    // 元素设置display：none的时候offsetWidth是0\n    // 当display: none时，先让元素display: block, 通过visibility在页面上不可见\n    // 但是可以取到该元素的样式信息，之后再还原成display：none\n    swap(elem, cssShow, () => {\n      val = getWH.apply(undefined, args);\n    });\n  }\n  return val as number;\n}\n\nexport { isBorderBoxFn, getPBMWidth, getWHIgnoreDisplay };"],"mappings":"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"}