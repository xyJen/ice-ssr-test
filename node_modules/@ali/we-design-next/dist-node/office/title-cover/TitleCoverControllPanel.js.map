{"version":3,"file":"TitleCoverControllPanel.js","names":["TitleCoverControllPanel","React","memo","forwardRef","props","ref","imagePicker","getImagePickerContainer","onChange","onPickImageStart","onPickImageEnd","rest","position","setPosition","useState","DEFAULT_POSITION","isReposition","setIsReposition","wrapperRef","useRef","startYRef","isMovePosition","originPositionRef","titleCoverRef","positionRef","dragStartPositionRef","useImperativeHandle","attach","titleCover","current","isRep","p","useEffect","savePosition","cover","getCover","transform","offsetY","endReposition","turnOnReposition","startReposition","handleMouseDownImg","e","handleDragging","imgRef","getImageRef","preventDefault","stopPropagation","screenY","offsetPercent","offsetHeight","setRenderPosition","Math","max","min","handleMouseUp","getSafePosition","document","removeEventListener","addEventListener","imgeRef","handleCancel","handleClick","top","bottom","left","right","getBoundingClientRect","clientX","clientY","handleClickPickImageButton","t","useTranslate","handleOnVisibleChange","v","getContainer","body","mergeRestProps","borderRadius","borderRight"],"sources":["../../../../src/office/title-cover/TitleCoverControllPanel.tsx"],"sourcesContent":["import React, {\n  DOMAttributes,\n  useEffect,\n  useImperativeHandle,\n  useRef,\n  useState,\n} from \"react\";\nimport { TitleCover, Cover as CoverType } from \"./TitleCover\";\nimport { Popover } from \"../../display/popover\";\nimport { useTranslate } from \"../../locale\";\nimport { ButtonsWrapper, SettingButton } from \"./style\";\nimport { getSafePosition } from \"./utils\";\nimport { DEFAULT_POSITION } from \"./constants\";\nimport { IRestProps, mergeRestProps } from \"../../common/react/mergeRestProps\";\n\ntype TitleCoverControllPanelProps = {\n  /**\n   * 更换封面图片选择器\n   * 返回值会被设为 Popover 的 content\n   */\n  imagePicker: React.ReactNode;\n  /**\n   * 作为 imagePicker Popover 的 getContainer\n   */\n  getImagePickerContainer?: () => HTMLElement;\n  /**\n   * 封面数据变化 callback\n   */\n  onChange?: (cover: CoverType) => void;\n  /**\n   * 开始选择图片\n   */\n  onPickImageStart?: () => void;\n  /**\n   * 结束选择图片\n   */\n  onPickImageEnd?: () => void;\n} & IRestProps & Omit<DOMAttributes<HTMLDivElement>, 'onChange'>;\n\ntype TitleCoverControllPanelRef = {\n  attach: (titleCover: React.ComponentRef<typeof TitleCover>) => () => void;\n};\n\nexport const TitleCoverControllPanel = React.memo(\n  React.forwardRef<TitleCoverControllPanelRef, TitleCoverControllPanelProps>(\n    (props, ref) => {\n      const {\n        imagePicker,\n        getImagePickerContainer,\n        onChange,\n        onPickImageStart,\n        onPickImageEnd,\n        ...rest\n      } = props;\n      const [position, setPosition] = useState(DEFAULT_POSITION);\n      const [isReposition, setIsReposition] = useState(false);\n      const wrapperRef = useRef<HTMLDivElement>(null);\n      const startYRef = useRef(0);\n      const isMovePosition = useRef(false);\n      const originPositionRef = useRef(0);\n      const titleCoverRef = useRef<React.ComponentRef<\n        typeof TitleCover\n      > | null>(null);\n      const positionRef = useRef(position);\n      const dragStartPositionRef = useRef(position);\n\n      useImperativeHandle(ref, () => ({\n        attach: (titleCover) => {\n          titleCoverRef.current = titleCover;\n          return titleCover.onChange(({ isReposition: isRep, position: p }) => {\n            setIsReposition(isRep);\n            setPosition(p);\n          });\n        },\n      }));\n\n      useEffect(() => {\n        positionRef.current = position;\n      }, [position]);\n\n      const savePosition = () => {\n        const cover = titleCoverRef.current?.getCover();\n        if (cover) {\n          onChange?.({\n            ...cover,\n            transform: { offsetY: position },\n          });\n        }\n        titleCoverRef.current?.endReposition();\n      };\n\n      const turnOnReposition = () => {\n        originPositionRef.current = position;\n        titleCoverRef.current?.startReposition();\n      };\n\n      React.useEffect(() => {\n        if (isReposition) {\n          const handleMouseDownImg = (e: MouseEvent) => {\n            isMovePosition.current = false;\n            dragStartPositionRef.current = positionRef.current;\n\n            const handleDragging = (e: MouseEvent) => {\n              const imgRef = titleCoverRef.current?.getImageRef();\n              if (!imgRef?.current) {\n                return;\n              }\n              e.preventDefault();\n              e.stopPropagation();\n              isMovePosition.current = true;\n              const offsetY = e.screenY - startYRef.current;\n              // x0.5 避免拖动过快（参考 notion）\n              const offsetPercent = (offsetY / imgRef.current.offsetHeight) * 0.5;\n              // position 取值范围 [0, 1]\n              titleCoverRef.current?.setRenderPosition(\n                Math.max(0, Math.min(1, dragStartPositionRef.current - offsetPercent))\n              );\n            };\n\n            const handleMouseUp = () => {\n              if (!isMovePosition.current) {\n                titleCoverRef.current?.setRenderPosition(\n                  getSafePosition(originPositionRef.current)\n                );\n                titleCoverRef.current?.endReposition();\n              }\n              document.removeEventListener(\"mousemove\", handleDragging);\n              document.removeEventListener(\"mouseup\", handleMouseUp);\n            };\n\n            if (isReposition) {\n              startYRef.current = e.screenY;\n              document.addEventListener(\"mousemove\", handleDragging);\n              document.addEventListener(\"mouseup\", handleMouseUp);\n\n              return () => {\n                document.removeEventListener(\"mousemove\", handleDragging);\n                document.removeEventListener(\"mouseup\", handleMouseUp);\n              };\n            }\n          };\n\n          const imgeRef = titleCoverRef.current?.getImageRef();\n          if (imgeRef?.current) {\n            imgeRef.current.addEventListener(\"mousedown\", handleMouseDownImg);\n            return () => {\n              imgeRef.current?.removeEventListener(\n                \"mousedown\",\n                handleMouseDownImg\n              );\n            };\n          }\n        }\n      }, [isReposition]);\n\n      const handleCancel = () => {\n        titleCoverRef.current?.setRenderPosition(\n          getSafePosition(originPositionRef.current)\n        );\n        titleCoverRef.current?.endReposition();\n      };\n\n      const preventDefault = (e: React.MouseEvent) => {\n        e.stopPropagation();\n      };\n\n      useEffect(() => {\n        const handleClick = (e: MouseEvent) => {\n          const imgRef = titleCoverRef.current?.getImageRef();\n          if (!imgRef?.current || isMovePosition.current) {\n            isMovePosition.current = false;\n            return;\n          }\n          const { top, bottom, left, right } =\n            imgRef.current.getBoundingClientRect();\n          const { clientX, clientY } = e;\n          if (\n            clientX < left ||\n            clientX > right ||\n            clientY < top ||\n            clientY > bottom\n          ) {\n            const cover = titleCoverRef.current?.getCover();\n            if (cover) {\n              onChange?.({\n                ...cover,\n                transform: { offsetY: positionRef.current },\n              });\n            }\n            titleCoverRef.current?.endReposition();\n          }\n        };\n\n        if (isReposition) {\n          document.addEventListener(\"click\", handleClick);\n        } else {\n          document.removeEventListener(\"click\", handleClick);\n        }\n        return () => {\n          if (isReposition) {\n            document.removeEventListener(\"click\", handleClick);\n          }\n        };\n      }, [isReposition]);\n\n      const handleClickPickImageButton = () => {\n        onPickImageStart?.();\n      };\n\n      const t = useTranslate();\n\n      const handleOnVisibleChange = (v: boolean) => {\n        if (!v) {\n          onPickImageEnd?.();\n        }\n      };\n\n      const getContainer = () => {\n        return getImagePickerContainer?.() || wrapperRef.current || document.body;\n      };\n\n      return (\n        <ButtonsWrapper ref={wrapperRef} {...mergeRestProps(rest, 'wdn-title-cover-controll-panel')}>\n          {!isReposition ? (\n            <>\n              <Popover\n                placement=\"bottomLeft\"\n                trigger=\"click\"\n                content={imagePicker}\n                onVisibleChange={handleOnVisibleChange}\n                getContainer={getContainer}\n                style={{ borderRadius: 8 }}\n              >\n                <SettingButton onClick={handleClickPickImageButton} style={{\n                  borderRight: '1px solid rgba(55, 53, 47, 0.09)',\n                }}>\n                  {t(\"wdn_title_cover_update_image\")}\n                </SettingButton>\n              </Popover>\n              <SettingButton onClick={turnOnReposition}>\n                {t(\"wdn_title_cover_reposition\")}\n              </SettingButton>\n            </>\n          ) : (\n            <>\n              <SettingButton\n                style={{\n                  borderRight: '1px solid rgba(55, 53, 47, 0.09)',\n                }}\n                onClick={savePosition}\n                onMouseDown={preventDefault}\n              >\n                {t(\"wdn_title_cover_save_position\")}\n              </SettingButton>\n              <SettingButton\n                onClick={handleCancel}\n                onMouseDown={preventDefault}\n              >\n                {t(\"wdn_cancel\")}\n              </SettingButton>\n            </>\n          )}\n        </ButtonsWrapper>\n      );\n    }\n  )\n);\n"],"mappings":"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"}