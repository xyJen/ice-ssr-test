{"version":3,"file":"rename.js","names":["mirrorOffsetWidth","inputOffsetHeight","inputOffsetWidth","minWidth","maxLength","isSafari","window","navigator","userAgent","includes","Filename","memo","props","filename","fileName","renameAble","onRename","maxWidth","rest","inputRef","useRef","readerRef","mirrorRef","newFileName","setFileName","useState","isFocused","setFocus","isComposing","setIsComposing","illeaguePost","setIlleaguePost","resizeNameInput","useCallback","current","width","height","getBoundingClientRect","mirrorWidth","Math","ceil","inputWidth","style","max","min","useEffect","handleMouseLeave","HTMLInputElement","scrollLeft","onChangeName","e","value","target","handleBlur","trimFileName","trim","substring","length","alertNameLength","handleFocus","handleEnterKey","input","key","blur","handleTextAreaComposition","type","mirrorText","useMemo","replace"],"sources":["../../../../src/office/rename/rename.tsx"],"sourcesContent":["import React, { memo, useRef, useEffect, useCallback, useState, useMemo } from 'react';\nimport { Tooltip } from '../../display/tooltip';\nimport { TitleInput, TitleMirror, TitleBar, TitleName } from './styled';\nimport type { IRestProps } from '../../common';\n\nconst mirrorOffsetWidth = 6;\nconst inputOffsetHeight = 6;\nconst inputOffsetWidth = 10;\n\nexport interface IRenameProps extends IRestProps {\n  filename?: string;\n  renameAble: boolean;\n  onRename: (newName: string) => void;\n  maxWidth?: number;\n}\n\nconst minWidth = 2;\nconst maxLength = 32;\n\nconst isSafari = window.navigator.userAgent.includes('Safari') && !window.navigator.userAgent.includes('Chrome');\n\nexport const Filename = memo<IRenameProps>((props) => {\n  const {\n    filename: fileName,\n    renameAble,\n    onRename,\n    maxWidth = -1,\n    ...rest\n  } = props;\n  const inputRef = useRef<HTMLInputElement | null>(null);\n  const readerRef = useRef<HTMLInputElement | null>(null);\n  const mirrorRef = useRef<HTMLDivElement | null>(null);\n\n  const [newFileName, setFileName] = useState<string | undefined>('');\n  const [isFocused, setFocus] = useState(false);\n  const [isComposing, setIsComposing] = useState(false);\n  const [illeaguePost, setIlleaguePost] = useState(false);\n\n\n\n  const resizeNameInput = useCallback(\n    () => {\n      if (!mirrorRef.current) {\n        return;\n      }\n      const { width = 0, height } = mirrorRef.current!.getBoundingClientRect();\n      const mirrorWidth: number = Math.ceil(width);\n      if (renameAble) {\n        if (inputRef.current) {\n          let inputWidth = mirrorWidth + inputOffsetWidth - mirrorOffsetWidth;\n          if (isSafari) {\n            inputWidth = mirrorWidth + inputOffsetWidth;\n            inputRef.current.style.height = `${height + inputOffsetHeight}px`;\n          }\n\n          \n          inputRef.current.style.width = `${maxWidth === -1 ? Math.max(inputWidth, minWidth): Math.min(Math.max(inputWidth, minWidth), maxWidth - inputOffsetWidth)}px`;\n\n          if(readerRef.current){\n            readerRef.current.style.width = `${maxWidth === -1 ? Math.max(inputWidth, minWidth): Math.min(Math.max(inputWidth, minWidth), maxWidth - mirrorOffsetWidth)}px`;\n          }\n          \n        }\n      } else if (readerRef.current) {\n        readerRef.current.style.width = `${maxWidth === -1 ? Math.max(mirrorWidth, minWidth): Math.min(Math.max(mirrorWidth, minWidth), maxWidth - mirrorOffsetWidth)}px`;\n      }\n    },\n    [renameAble, isSafari, minWidth, maxWidth],\n  );\n\n  useEffect(\n    () => {\n      setFileName(fileName);\n      resizeNameInput();\n    },\n    [fileName, resizeNameInput],\n  );\n\n  useEffect(\n    () => {\n      resizeNameInput();\n    },\n    [resizeNameInput, newFileName],\n  );\n\n  const handleMouseLeave = useCallback(\n    () => {\n      if (!isFocused && inputRef?.current instanceof HTMLInputElement) {\n        const { width } = inputRef.current.getBoundingClientRect();\n        inputRef.current.style.width = `${width}px`;\n        inputRef.current.scrollLeft = 0;\n        resizeNameInput();\n      }\n    },\n    [isFocused, resizeNameInput],\n  );\n\n  const onChangeName = useCallback(\n    (e: React.ChangeEvent<HTMLInputElement>) => {\n      const { value } = e.target;\n      setFileName(value);\n    },\n    [],\n  );\n  /* 响应编辑输入框失焦 */\n  const handleBlur = useCallback(\n    () => {\n      setIlleaguePost(false);\n      const trimFileName = inputRef?.current?.value?.trim().substring(0, maxLength);\n      if (trimFileName && trimFileName?.length > 0) {\n        setFileName(trimFileName);\n        setFocus(false);\n        onRename(trimFileName);\n      } else {\n        setFileName(fileName);\n        setFocus(false);\n      }\n    },\n    [fileName, maxLength, onRename],\n  );\n\n  // 文件名超限时给出警告\n  const alertNameLength = useCallback(\n    () => {\n      if (!illeaguePost && newFileName && newFileName.length > maxLength) {\n        setIlleaguePost(true);\n      }\n    },\n    [illeaguePost, maxLength, newFileName],\n  );\n\n  // 聚焦时，选中文本\n  const handleFocus = useCallback(\n    () => {\n      setFocus(true);\n    },\n    [],\n  );\n\n  const handleEnterKey = useCallback(\n    (e: React.KeyboardEvent<HTMLInputElement>) => {\n      const input = inputRef.current;\n      switch (e.key) {\n        case 'Escape':\n          if (input) {\n            input.value = fileName || '';\n          }\n          !isComposing && input?.blur();\n          break;\n        case 'Enter':\n          setIlleaguePost(false);\n          !isComposing && input?.blur();\n          break;\n        default:\n          break;\n      }\n    },\n    [isComposing, fileName],\n  );\n\n  const handleTextAreaComposition = useCallback(\n    (e: React.CompositionEvent<HTMLTextAreaElement>) => {\n      if (e.type === 'compositionstart') {\n        setIsComposing(true);\n      }\n      if (e.type === 'compositionend') {\n        setIsComposing(false);\n        setIlleaguePost(false);\n      }\n    },\n    [],\n  );\n\n  const mirrorText = useMemo(\n    () => (newFileName || '').replace(/\\s/g, '\\u00A0'),\n    [newFileName],\n  );\n\n  return (\n    <TitleBar {...rest}>\n      {renameAble\n        ? (\n          <Tooltip title={'重命名'}>\n            <TitleInput\n              ref={inputRef}\n              value={newFileName}\n              title={newFileName}\n              onChange={onChangeName}\n              onBlur={handleBlur}\n              onFocus={handleFocus}\n              onKeyDown={handleEnterKey}\n              onKeyUp={alertNameLength}\n              maxLength={maxLength}\n              isFocused={isFocused}\n              onMouseLeave={handleMouseLeave}\n              onCompositionStart={handleTextAreaComposition}\n              onCompositionEnd={handleTextAreaComposition}\n            />\n          </Tooltip>\n        )\n        : (\n          <TitleName ref={readerRef} title={fileName}>\n            {fileName}\n          </TitleName>\n        )\n      }\n      <TitleMirror ref={mirrorRef}>\n        {mirrorText}\n      </TitleMirror>\n    </TitleBar>\n  );\n});\n"],"mappings":"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"}