{"version":3,"file":"Mention.js","names":["Mention","React","memo","forwardRef","props","ref","placeholder","onRequest","Promise","r","onSelect","items","setItems","useState","requestState","setRequestState","inputValue","setInputValue","invoke","request","useMemo","LastPromiseResolver","handleRequest","useEventCallback","searchText","page","origin","members","cloned","splice","error","useEffect","undefined","e","target","value","i","count","constructor","fn","current","_args","_resolve","resolve","args","isResolving","trigger","then"],"sources":["../../../../src/collaboration/mention/Mention.tsx"],"sourcesContent":["import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { useEventCallback } from '../../common/react';\nimport { Input } from '../../form/input';\nimport { IconLoading, IconSearch } from '../../basic/icon';\nimport { IMember } from './items/MemberItem';\nimport { MentionList } from './MentionList';\nimport { MentionWrapper } from './styled';\n\ntype IMentionProps = {\n  /**\n   * placeholder\n   */\n  placeholder?: string;\n  /**\n   * 选择的回调\n   */\n  onSelect?: (item: IMember) => void;\n  /**\n   * 数据请求\n   */\n  onRequest?: (\n    searchText: string,\n    page: [number, number],\n  ) => Promise<IMember[]>;\n}\n\nexport const Mention = React.memo(\n\n  React.forwardRef<HTMLDivElement, IMentionProps>(\n    (props, ref) => {\n\n      const {\n        placeholder,\n        onRequest = () => new Promise(r => r([])),\n        onSelect,\n      } = props;\n\n      const [items, setItems] = useState<IMember[]>([]);\n\n      const [requestState, setRequestState] = useState<'complete' | 'requesting' | 'error'>('complete');\n\n      const [inputValue, setInputValue] = useState<string>('');\n\n      const { invoke: request } = useMemo(() => new LastPromiseResolver(onRequest), [onRequest]);\n\n      const handleRequest = useEventCallback(\n        async (searchText: string, page: [number, number], origin: IMember[]) => {\n\n          setRequestState('requesting');\n\n          try {\n            const members = await request(searchText, page);\n            if (members) {\n              const cloned = [...origin];\n              cloned.splice(page[0], page[1], ...members);\n              setItems(cloned);\n              setRequestState('complete');\n            }\n          } catch (error) {\n            setRequestState('error');\n          }\n        }\n      );\n\n      useEffect(() => {\n        handleRequest(inputValue, [0, 10], []);\n      }, []);\n\n      return (\n        <MentionWrapper ref={ref}>\n          <Input\n            value={inputValue}\n            prefix={<IconSearch />}\n            suffix={requestState === 'requesting' ? <IconLoading /> : undefined}\n            onChange={(e) => {\n              setItems([]);\n              setInputValue(e.target.value);\n              handleRequest(e.target.value, [0, 10], []);\n            }}\n            placeholder={placeholder}\n            bordered={false}\n          />\n          <MentionList\n            items={items}\n            onMention={() => 1}\n            onLoadMore={(i, count) => { return handleRequest(inputValue, [i, count], items); }}\n          />\n        </MentionWrapper>\n      );\n    }\n  )\n)\n\n\n\nclass LastPromiseResolver<T extends any[], R> {\n\n  protected readonly fn: (...args: T) => Promise<R>;\n\n  constructor(fn: (...args: T) => Promise<R>) {\n    this.fn = fn;\n  }\n\n  protected current: [(r: R | null) => void, T, boolean] | null = null;\n\n  // only the last invoke will resolve with R\n  invoke = async (..._args: T): Promise<R | null> => {\n\n    return new Promise<R | null>(_resolve => {\n      if (this.current) {\n        const [resolve, args, isResolving] = this.current;\n        resolve(null);\n        this.current = [_resolve, _args, false];\n        // do not trigger\n      } else {\n        this.current = [_resolve, _args, false];\n        this.trigger();\n      }\n    })\n  }\n\n  protected trigger = (): void => {\n    if (this.current) {\n      const [resolve, args, isResolving] = this.current;\n      if (isResolving === false) {\n        this.current[2] = true;\n        this.fn(...args).then(e => {\n          if (this.current && this.current[0] === resolve) {\n            this.current = null;\n            resolve(e);\n          } else if (this.current) {\n            this.trigger();\n          }\n        });\n      }\n    }\n  }\n}"],"mappings":"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"}