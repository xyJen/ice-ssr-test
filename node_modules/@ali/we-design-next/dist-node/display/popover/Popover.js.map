{"version":3,"file":"Popover.js","names":["DEFAULT_PROPS","placement","placementOffset","getContainer","document","body","contains","container","target","ele","parentElement","Popover","React","memo","props","visible","_visible","trigger","content","children","onVisibleChange","animation","keepAlign","keepMounted","resize","rest","isValidElement","_setVisible","useDefaultProp","setVisible","useEventCallback","e","visibleController","useMemo","timeoutId","open","cancel","close","setTimeout","isHoveringContent","current","clearTimeout","closeImmediately","useRef","triggerEvents","onMouseEnter","onMouseLeave","onClick","useEffect","hide","contentRef","triggerRef","timerId","requestAnimationFrame","addEventListener","window","cancelAnimationFrame","removeEventListener","align","flag","reAlign","regRes","className","match","replace","resizeObserver","ResizeObserver","observe","setFlagTimeoutId","disconnect","ref","mergeRef","cloneReactNode","ReactDOM","createPortal","undefined","mergeRestProps","mergeClassName"],"sources":["../../../../src/display/popover/Popover.tsx"],"sourcesContent":["import React, { ReactNode, useEffect, useMemo, useRef, isValidElement } from 'react';\nimport ReactDOM from 'react-dom';\nimport { useDefaultProp, mergeRef, cloneReactNode, mergeRestProps, useEventCallback, mergeClassName, MergePropsType } from '../../common';\nimport { align } from './align';\nimport { ContentWrap } from './styled';\nimport ResizeObserver from 'resize-observer-polyfill';\n\nexport type IPlacement =\n  | 'topLeft'\n  | 'top'\n  | 'topRight'\n  | 'leftTop'\n  | 'rightTop'\n  | 'left'\n  | 'right'\n  | 'leftBottom'\n  | 'rightBottom'\n  | 'bottom'\n  | 'bottomLeft'\n  | 'bottomRight';\n\nexport type IPopoverProps = MergePropsType<{\n  /**\n   * 弹层内容\n   */\n  content?: ReactNode;\n  /**\n   * 弹层相对触发元素的对齐方向\n   */\n  placement?: IPlacement;\n  /**\n   * 对齐方向上的位移（主轴和副轴，取决于对齐方向）\n   */\n  placementOffset?: [number, number];\n  /**\n   * 弹层是否打开\n   */\n  visible?: boolean;\n  /**\n   * 弹层打开状态变化\n   */\n  onVisibleChange?: (visible: boolean) => void;\n  /**\n   * 触发弹层打开的方式\n   */\n  trigger?: 'hover' | 'click' | 'mouse-enter';\n  /**\n   * 启用动画\n   */\n  animation?: boolean;\n  /**\n   * 保持弹层内容和触发元素对齐（窗口尺寸发生变化时）\n   */\n  keepAlign?: boolean;\n  /**\n   * 弹层关闭时，保持其中的内容不被从 DOM 上卸载\n   */\n  keepMounted?: boolean;\n  /**\n   * 挂载容器元素\n   */\n  getContainer?: () => HTMLElement | undefined;\n  /**\n   * 当屏幕可视区域放不下内容时是否自动调整内容的宽高\n   */\n   resize?: boolean;\n}, React.HTMLAttributes<HTMLDivElement>>;\n\nconst DEFAULT_PROPS:\n  Required<Pick<IPopoverProps, 'placement' | 'placementOffset' | 'getContainer'>> =\n{\n  placement: 'bottom',\n  placementOffset: [0, 0],\n  getContainer: () => document.body\n};\n\nconst contains = (container: HTMLElement, target: HTMLElement): boolean => {\n  let ele: HTMLElement | null = target;\n  while (ele !== null) {\n    if (ele === container) {\n      return true;\n    }\n    ele = ele.parentElement;\n  }\n  return false;\n};\n\nexport const Popover = React.memo((props: IPopoverProps) => {\n\n  const {\n    visible: _visible,\n    trigger,\n    content = <div></div>,\n    children,\n    getContainer = DEFAULT_PROPS.getContainer,\n    onVisibleChange,\n    placement = DEFAULT_PROPS.placement,\n    placementOffset = DEFAULT_PROPS.placementOffset,\n    animation,\n    keepAlign,\n    keepMounted,\n    resize,\n    ...rest\n  } = props;\n\n  if (!isValidElement(children)) {\n    return null;\n  }\n\n  const [visible, _setVisible] = useDefaultProp(false, _visible, onVisibleChange);\n  const setVisible = useEventCallback((e: boolean) => _setVisible(e));\n\n  const visibleController = useMemo(() => {\n\n    let timeoutId: ReturnType<typeof setTimeout> | null = null;\n\n    const open = () => {\n      cancel();\n      setVisible(true);\n    };\n\n    const close = () => {\n      if (timeoutId === null) {\n        timeoutId = setTimeout(() => {\n          timeoutId = null;\n          (isHoveringContent.current === false) && setVisible(false);\n        }, 150);\n      }\n    };\n\n    const cancel = () => {\n      if (timeoutId !== null) {\n        clearTimeout(timeoutId);\n        timeoutId = null;\n      }\n    };\n\n    const closeImmediately = () => {\n      cancel();\n      setVisible(false);\n    };\n\n    return { open, close, closeImmediately };\n  }, []);\n\n  const isHoveringContent = useRef<boolean>(false);\n\n  const triggerEvents = useMemo(\n    () => {\n\n      if (trigger === 'hover') {\n\n        return {\n          onMouseEnter: visibleController.open,\n          onMouseLeave: visibleController.closeImmediately\n        };\n      } else if (trigger === 'mouse-enter') {\n\n        return {\n          onMouseEnter: visibleController.open,\n          onMouseLeave: visibleController.close,\n        };\n      } else if (trigger === 'click') {\n\n        return {\n          onClick: visibleController.open,\n        };\n      } else {\n        return {};\n      }\n    },\n    [trigger, visibleController]\n  );\n\n  // 监听 document mousedown 事件，触发时关闭 Popover（除非事件在 content 或 trigger 内部触发）\n  useEffect(() => {\n    if (visible) {\n      const hide = (e: MouseEvent) => {\n        if (\n          contentRef.current &&\n          triggerRef.current &&\n          e.target &&\n          !contains(contentRef.current, e.target as HTMLElement) &&\n          !contains(triggerRef.current, e.target as HTMLElement)\n        ) {\n          visibleController.closeImmediately();\n        }\n      }\n      // 为什么要 raf 后再监听：因为当前也许正处在一次 click 事件中\n      const timerId = requestAnimationFrame(() => {\n        document.addEventListener('mousedown', hide);\n      });\n      return () => {\n        window.cancelAnimationFrame(timerId);\n        document.removeEventListener('mousedown', hide);\n      }\n    }\n  }, [visibleController, visible]);\n\n  // 打开 Popover 后，立刻对齐 content 和 trigger\n  useEffect(() => {\n    if (visible === true && contentRef.current && triggerRef.current) {\n      align(contentRef.current, triggerRef.current, placement, placementOffset);\n    }\n  }, [visible]);\n\n  // 如果开启了 keepAlign：打开 Popover 后，监听窗口 resize 事件，触发时重新对齐 content 和 trigger\n  // 注意：如果开启了 animation，首次重新对齐时需要移除 content 上的动画相关 classname\n  useEffect(() => {\n\n    if (visible && keepAlign && contentRef.current && triggerRef.current) {\n\n      // ResizeObserver.observe 会直接触发一次 callback，此时不需要 reAlign\n      let flag = false;\n\n      const reAlign = () => {\n        if (flag && contentRef.current && triggerRef.current) {\n          if (animation) {\n            const regRes = contentRef.current.className.match(/wds-popover-animation-[\\w-]+/);\n            if (regRes && regRes[0]) {\n              contentRef.current.className = contentRef.current.className.replace(regRes[0], '');\n            }\n          }\n          align(contentRef.current, triggerRef.current, placement, placementOffset);\n        }\n      };\n\n      const resizeObserver = new ResizeObserver(reAlign);\n      resizeObserver.observe(document.body);\n      const setFlagTimeoutId = setTimeout(() => flag = true, 100);\n      return () => {\n        resizeObserver.disconnect();\n        clearTimeout(setFlagTimeoutId);\n      }\n    }\n  }, [visible, keepAlign, animation]);\n\n  const triggerRef = useRef<HTMLElement>(null);\n  const contentRef = useRef<HTMLDivElement>(null);\n\n  const ref = mergeRef((children as any).ref, triggerRef);\n\n  return <>\n    {\n      cloneReactNode(\n        children,\n        {\n          ref,\n          ...triggerEvents\n        }\n      )\n    }\n    {\n      (visible || keepMounted) ?\n        ReactDOM.createPortal(\n          <ContentWrap\n            hidden={!keepMounted ? false : !visible}\n            onMouseEnter={\n              trigger === 'mouse-enter' ?\n                () => {\n                  isHoveringContent.current = true;\n                } :\n                undefined\n            }\n            onMouseLeave={\n              trigger === 'mouse-enter' ?\n                () => {\n                  isHoveringContent.current = false;\n                  visibleController.close();\n                } :\n                undefined\n            }\n            ref={contentRef}\n            {...mergeRestProps(rest, mergeClassName('wdn-popover', animation ? `wds-popover-animation-${placement}` : ''))}\n          >\n            {content}\n          </ContentWrap>,\n          getContainer() || document.body\n        )\n        :\n        null\n    }\n  </>;\n});"],"mappings":"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"}