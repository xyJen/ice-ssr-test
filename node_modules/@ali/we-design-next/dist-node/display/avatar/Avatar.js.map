{"version":3,"file":"Avatar.js","names":["AvatarText","styled","span","SMALL_SIZE","COLORS","WHITE","AvatarImage","img","getRealSize","size","LARGE_SIZE","NORMAL_SIZE","getAvatarStyle","shape","fontSize","Math","ceil","borderRadius","LARGE_BORDER_RADIUS","SMALL_BORDER_RADIUS","width","height","lineHeight","isCdnImgSrc","src","test","getThumbnail","host","search","split","url","URL","oldValue","searchParams","get","newValue","startsWith","slice","set","toString","getLastNickName","nick","num","broken","Array","from","length","join","Avatar","props","name","style","styleProp","rest","imgRef","React","useRef","failed","setFailed","useState","nickName","realSize","thumbnailUrl","handleError","useCallback","current"],"sources":["../../../../src/display/avatar/Avatar.tsx"],"sourcesContent":["import React from 'react';\nimport { IRestProps, COLORS } from '../../common';\nimport { LARGE_SIZE, NORMAL_SIZE, SMALL_SIZE, LARGE_BORDER_RADIUS, SMALL_BORDER_RADIUS } from './constants';\n\ntype IShape = 'rect' | 'circle';\ntype ISize = 'small' | 'normal' | 'large' | number;\n\nexport type IAvatarProps = {\n  src?: string;\n  /**\n   * 头像的形状, 默认为 rect\n   */\n   shape?: IShape;\n  /**\n    * 用户名字\n    */\n   name?: string;\n   /**\n    * 头像的大小, 其中 small：24px, normal: 32px, large: 64px\n    */\n   size?: ISize;\n} & IRestProps & React.DOMAttributes<HTMLImageElement>;\n\nimport styled from 'styled-components';\n\nconst AvatarText = styled.span`\n  display: inline-block;\n  width: ${SMALL_SIZE}px;\n  height: ${SMALL_SIZE}px;\n  line-height: ${SMALL_SIZE}px;\n  text-align: center;\n  font-size: ${SMALL_SIZE / 2}px;\n  cursor: default;\n  color: ${COLORS.WHITE};\n  background-color: rgb(0, 137, 255);\n  user-select: none;\n`;\n\nconst AvatarImage = styled.img`\n  display: inline-block;\n  width: ${SMALL_SIZE}px;\n  height: ${SMALL_SIZE}px;\n  cursor: default;\n`;\n\nfunction getRealSize(size: ISize) {\n  if (typeof size === 'number') {\n    return size;\n  }\n  switch(size) {\n    case 'large': return LARGE_SIZE;\n    case 'normal': return NORMAL_SIZE;\n    default: return SMALL_SIZE;\n  }\n}\n\nfunction getAvatarStyle(size: number, shape: IShape): React.CSSProperties {\n  const fontSize = Math.ceil(size / 2);\n  let borderRadius: React.CSSProperties['borderRadius'] = size >= LARGE_SIZE ? LARGE_BORDER_RADIUS : SMALL_BORDER_RADIUS;\n  if (shape === 'circle') {\n    borderRadius = '50%';\n  }\n  return {\n    borderRadius,\n    fontSize,\n    width: size,\n    height: size,\n    lineHeight: `${size}px`,\n  };\n}\n\nfunction isCdnImgSrc(src: string) {\n  return /^https?:\\/\\/img.alicdn.com/.test(src);\n}\n\nfunction getThumbnail(src: string = '') {\n  if (!src) return '';\n  const size = 100;\n  if (isCdnImgSrc(src)) {\n    const [host, search = ''] = src.split('?', 2);\n    // 参考文档 https://open.dingtalk.com/document/orgapp-client/image-scaling\n    return `${host}_${size}x${size}${search ? '?' + search : ''}`;\n  }\n  const url = new URL(src);\n  const oldValue = url.searchParams.get('x-oss-process');\n  let newValue = `image/resize,m_fill,h_${size},w_${size}`;\n  if (oldValue && oldValue.startsWith('image/')) {\n    // 第一个resize 配置才会生效\n    newValue = 'image/' + `resize,m_fill,h_${size},w_${size}` + oldValue.slice(5);\n  }\n  // 参考文档 https://help.aliyun.com/document_detail/44688.html\n  url.searchParams.set('x-oss-process', newValue);\n  return url.toString();\n}\n\nfunction getLastNickName(nick?: string, num = 2) {\n  if (!nick) return '';\n  const broken = Array.from(nick);\n  return broken.slice(broken.length - num).join('');\n}\n\nexport const Avatar: React.FC<IAvatarProps> = (props) => {\n  const {\n    src,\n    name,\n    shape = 'rect',\n    size = 'small',\n    style: styleProp,\n    ...rest\n  } = props;\n  const imgRef = React.useRef<HTMLImageElement | null>(null);\n  const [failed, setFailed] = React.useState(false);\n  const nickName = getLastNickName(name, 1);\n  const realSize = getRealSize(size);\n  const thumbnailUrl = getThumbnail(src);\n  const style = getAvatarStyle(realSize, shape);\n\n  const handleError = React.useCallback(\n    () => {\n      if (src && imgRef.current && imgRef.current.src !== src) {\n        // 1. fallback to fallback src\n        imgRef.current.src = src;\n      } else {\n        // 2. fallback to TextAvatar\n        setFailed(true);\n      }\n    },\n    [src],\n  );\n\n  if (!src || failed) {\n    return (\n      <AvatarText {...rest} style={{ ...style, ...styleProp }}>\n        {nickName}\n      </AvatarText>\n    );\n  }\n\n  return (\n    <AvatarImage ref={imgRef} src={thumbnailUrl} onError={handleError} style={{ ...style, ...styleProp }} {...rest} />\n  );\n}\n"],"mappings":"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"}