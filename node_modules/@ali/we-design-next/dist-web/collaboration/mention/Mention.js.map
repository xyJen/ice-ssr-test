{"version":3,"file":"Mention.js","names":["React","useEffect","useMemo","useState","useEventCallback","Input","IconLoading","IconSearch","MentionList","MentionWrapper","Mention","memo","forwardRef","props","ref","placeholder","onRequest","Promise","r","onSelect","items","setItems","requestState","setRequestState","inputValue","setInputValue","LastPromiseResolver","request","invoke","handleRequest","searchText","page","origin","members","cloned","splice","undefined","e","target","value","i","count","fn","current","_args","_resolve","resolve","args","isResolving","trigger","then"],"sources":["../../../../src/collaboration/mention/Mention.tsx"],"sourcesContent":["import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { useEventCallback } from '../../common/react';\nimport { Input } from '../../form/input';\nimport { IconLoading, IconSearch } from '../../basic/icon';\nimport { IMember } from './items/MemberItem';\nimport { MentionList } from './MentionList';\nimport { MentionWrapper } from './styled';\n\ntype IMentionProps = {\n  /**\n   * placeholder\n   */\n  placeholder?: string;\n  /**\n   * 选择的回调\n   */\n  onSelect?: (item: IMember) => void;\n  /**\n   * 数据请求\n   */\n  onRequest?: (\n    searchText: string,\n    page: [number, number],\n  ) => Promise<IMember[]>;\n}\n\nexport const Mention = React.memo(\n\n  React.forwardRef<HTMLDivElement, IMentionProps>(\n    (props, ref) => {\n\n      const {\n        placeholder,\n        onRequest = () => new Promise(r => r([])),\n        onSelect,\n      } = props;\n\n      const [items, setItems] = useState<IMember[]>([]);\n\n      const [requestState, setRequestState] = useState<'complete' | 'requesting' | 'error'>('complete');\n\n      const [inputValue, setInputValue] = useState<string>('');\n\n      const { invoke: request } = useMemo(() => new LastPromiseResolver(onRequest), [onRequest]);\n\n      const handleRequest = useEventCallback(\n        async (searchText: string, page: [number, number], origin: IMember[]) => {\n\n          setRequestState('requesting');\n\n          try {\n            const members = await request(searchText, page);\n            if (members) {\n              const cloned = [...origin];\n              cloned.splice(page[0], page[1], ...members);\n              setItems(cloned);\n              setRequestState('complete');\n            }\n          } catch (error) {\n            setRequestState('error');\n          }\n        }\n      );\n\n      useEffect(() => {\n        handleRequest(inputValue, [0, 10], []);\n      }, []);\n\n      return (\n        <MentionWrapper ref={ref}>\n          <Input\n            value={inputValue}\n            prefix={<IconSearch />}\n            suffix={requestState === 'requesting' ? <IconLoading /> : undefined}\n            onChange={(e) => {\n              setItems([]);\n              setInputValue(e.target.value);\n              handleRequest(e.target.value, [0, 10], []);\n            }}\n            placeholder={placeholder}\n            bordered={false}\n          />\n          <MentionList\n            items={items}\n            onMention={() => 1}\n            onLoadMore={(i, count) => { return handleRequest(inputValue, [i, count], items); }}\n          />\n        </MentionWrapper>\n      );\n    }\n  )\n)\n\n\n\nclass LastPromiseResolver<T extends any[], R> {\n\n  protected readonly fn: (...args: T) => Promise<R>;\n\n  constructor(fn: (...args: T) => Promise<R>) {\n    this.fn = fn;\n  }\n\n  protected current: [(r: R | null) => void, T, boolean] | null = null;\n\n  // only the last invoke will resolve with R\n  invoke = async (..._args: T): Promise<R | null> => {\n\n    return new Promise<R | null>(_resolve => {\n      if (this.current) {\n        const [resolve, args, isResolving] = this.current;\n        resolve(null);\n        this.current = [_resolve, _args, false];\n        // do not trigger\n      } else {\n        this.current = [_resolve, _args, false];\n        this.trigger();\n      }\n    })\n  }\n\n  protected trigger = (): void => {\n    if (this.current) {\n      const [resolve, args, isResolving] = this.current;\n      if (isResolving === false) {\n        this.current[2] = true;\n        this.fn(...args).then(e => {\n          if (this.current && this.current[0] === resolve) {\n            this.current = null;\n            resolve(e);\n          } else if (this.current) {\n            this.trigger();\n          }\n        });\n      }\n    }\n  }\n}"],"mappings":"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"}