{"version":3,"file":"getVisibleRectForElement.js","names":["utils","domUtils","getOffsetParent","isAncestorFixed","getVisibleRectForElement","element","alwaysByViewport","visibleRect","left","right","Infinity","top","bottom","el","doc","getDocument","win","defaultView","parentWindow","body","documentElement","navigator","userAgent","indexOf","clientWidth","css","pos","offset","clientLeft","clientTop","Math","max","min","clientHeight","originalPosition","isWindow","isDocument","style","position","scrollX","getWindowScrollLeft","scrollY","getWindowScrollTop","viewportWidth","viewportHeight","documentWidth","scrollWidth","documentHeight","scrollHeight","bodyStyle","window","getComputedStyle","overflowX","innerWidth","overflowY","innerHeight","maxVisibleWidth","maxVisibleHeight"],"sources":["../../../../../src/common/domAlign/calc/getVisibleRectForElement.tsx"],"sourcesContent":["import { utils } from '../utils/utils';\nimport { domUtils } from '../utils/dom-utils';\nimport getOffsetParent from './getOffsetParent';\nimport isAncestorFixed from './isAncestorFixed';\nimport type { IRegion, IVisibleRect } from '../interface';\n\n/**\n * 获得元素的显示部分的区域，其实是获取会影响该元素显示区域的祖先元素内容区域的交集\n * http://yiminghe.iteye.com/blog/1124720\n */\nfunction getVisibleRectForElement(element: HTMLElement, alwaysByViewport?: boolean): IVisibleRect | null {\n  // 首先可视区域为整个文档\n  const visibleRect = {\n    left: 0,\n    right: Infinity,\n    top: 0,\n    bottom: Infinity,\n  };\n  let el = getOffsetParent(element);\n  const doc = utils.getDocument(element);\n  const win = (doc.defaultView || doc.parentWindow) as Window;\n  const body = doc.body;\n  const documentElement = doc.documentElement;\n\n  // Determine the size of the visible rect by climbing the dom accounting for\n  // all scrollable containers.\n  // 即通过依次向 目标元素 的祖先元素递归,查找到会影响该元素显示的祖先元素\n  // 得到 目标元素 的相对文档的 { left,right,top,bottom }\n  // 简单理解为祖先中每一层父级都会对可视区域进行削减\n  // 因此所有`影响显示区域`的祖先元素的区域的交集即为最终的结果\n  while (el) {\n    // clientWidth is zero for inline block elements in ie.\n    if (\n      (navigator.userAgent.indexOf('MSIE') === -1 || el.clientWidth !== 0) &&\n      // body may have overflow set on it, yet we still get the entire\n      // viewport. In some browsers, el.offsetParent may be\n      // document.documentElement, so check for that too.\n      (el !== body &&\n        el !== documentElement &&\n        utils.css(el, 'overflow') !== 'visible')\n    ) {\n      const pos = utils.offset(el) as IRegion;\n      // add border\n      pos.left += el.clientLeft;\n      pos.top += el.clientTop;\n  \n      // 以下代码即为 做区域的交集,不断的缩小区域, 不考虑滚动条\n      visibleRect.top = Math.max(visibleRect.top, pos.top);\n      visibleRect.right = Math.min(\n        visibleRect.right,\n        // consider area without scrollBar\n        pos.left + el.clientWidth,\n      );\n      visibleRect.bottom = Math.min(\n        visibleRect.bottom,\n        pos.top + el.clientHeight,\n      );\n      visibleRect.left = Math.max(visibleRect.left, pos.left);\n    } else if (el === body || el === documentElement) {\n      break;\n    }\n    el = getOffsetParent(el);\n  }\n\n  // 根据 document，和window 元素对区域进行剪裁\n  // ele.style.position 只能返回行内样式 position 中的值，不能返回 css 样式表中的值\n  // window.getComputedStyle(ele).position 会返回元素最终的 position 值，不管是style中还是css中的\n  // Set element position to fixed\n  // make sure absolute element itself don't affect it's visible area\n  // https://github.com/ant-design/ant-design/issues/7601\n  let originalPosition: string | null = null;\n  if (!utils.isWindow(element) && !utils.isDocument(element)) {\n    originalPosition = element.style.position;\n    const position = utils.css(element, 'position');\n    if (position === 'absolute') {\n      element.style.position = 'fixed';\n    }\n  }\n\n  const scrollX = utils.getWindowScrollLeft(win);\n  const scrollY = utils.getWindowScrollTop(win);\n  const viewportWidth = domUtils.viewportWidth(win);\n  const viewportHeight = domUtils.viewportHeight(win);\n  let documentWidth = documentElement.scrollWidth;\n  let documentHeight = documentElement.scrollHeight;\n\n  // scrollXXX on html is sync with body which means overflow: hidden on body gets wrong scrollXXX.\n  // We should cut this ourself.\n  const bodyStyle = window.getComputedStyle(body);\n  if (bodyStyle.overflowX === 'hidden') {\n    documentWidth = win.innerWidth;\n  }\n  if (bodyStyle.overflowY === 'hidden') {\n    documentHeight = win.innerHeight;\n  }\n\n  // Reset element position after calculate the visible area\n  if (element.style && originalPosition) {\n    element.style.position = originalPosition;\n  }\n\n  // document can be larger than the viewport\n  if (alwaysByViewport || isAncestorFixed(element)) {\n    // Clip by viewport's size.\n    visibleRect.left = Math.max(visibleRect.left, scrollX);\n    visibleRect.top = Math.max(visibleRect.top, scrollY);\n    visibleRect.right = Math.min(visibleRect.right, scrollX + viewportWidth);\n    visibleRect.bottom = Math.min(visibleRect.bottom, scrollY + viewportHeight);\n  } else {\n    // Clip by document's size.\n    const maxVisibleWidth = Math.max(documentWidth, scrollX + viewportWidth);\n    visibleRect.right = Math.min(visibleRect.right, maxVisibleWidth);\n\n    const maxVisibleHeight = Math.max(documentHeight, scrollY + viewportHeight);\n    visibleRect.bottom = Math.min(visibleRect.bottom, maxVisibleHeight);\n  }\n\n  // 最后确保该可视区域是 `正常的` 因为 top 小于 0 是不现实的。内容不可能在文档之外\n  return visibleRect.top >= 0 &&\n    visibleRect.left >= 0 &&\n    visibleRect.bottom > visibleRect.top &&\n    visibleRect.right > visibleRect.left\n    ? visibleRect\n    : null;\n}\n\nexport default getVisibleRectForElement;\n"],"mappings":"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"}