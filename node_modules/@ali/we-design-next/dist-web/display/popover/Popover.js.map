{"version":3,"file":"Popover.js","names":["React","useEffect","useMemo","useRef","isValidElement","ReactDOM","useDefaultProp","mergeRef","cloneReactNode","mergeRestProps","useEventCallback","mergeClassName","align","ContentWrap","ResizeObserver","DEFAULT_PROPS","placement","placementOffset","getContainer","document","body","contains","container","target","ele","parentElement","Popover","memo","props","_visible","visible","trigger","content","children","onVisibleChange","animation","keepAlign","keepMounted","resize","rest","_setVisible","setVisible","e","visibleController","timeoutId","open","cancel","close","setTimeout","isHoveringContent","current","clearTimeout","closeImmediately","triggerEvents","onMouseEnter","onMouseLeave","onClick","hide","contentRef","triggerRef","timerId","requestAnimationFrame","addEventListener","window","cancelAnimationFrame","removeEventListener","flag","reAlign","regRes","className","match","replace","resizeObserver","observe","setFlagTimeoutId","disconnect","ref","createPortal","undefined"],"sources":["../../../../src/display/popover/Popover.tsx"],"sourcesContent":["import React, { ReactNode, useEffect, useMemo, useRef, isValidElement } from 'react';\nimport ReactDOM from 'react-dom';\nimport { useDefaultProp, mergeRef, cloneReactNode, mergeRestProps, useEventCallback, mergeClassName, MergePropsType } from '../../common';\nimport { align } from './align';\nimport { ContentWrap } from './styled';\nimport ResizeObserver from 'resize-observer-polyfill';\n\nexport type IPlacement =\n  | 'topLeft'\n  | 'top'\n  | 'topRight'\n  | 'leftTop'\n  | 'rightTop'\n  | 'left'\n  | 'right'\n  | 'leftBottom'\n  | 'rightBottom'\n  | 'bottom'\n  | 'bottomLeft'\n  | 'bottomRight';\n\nexport type IPopoverProps = MergePropsType<{\n  /**\n   * 弹层内容\n   */\n  content?: ReactNode;\n  /**\n   * 弹层相对触发元素的对齐方向\n   */\n  placement?: IPlacement;\n  /**\n   * 对齐方向上的位移（主轴和副轴，取决于对齐方向）\n   */\n  placementOffset?: [number, number];\n  /**\n   * 弹层是否打开\n   */\n  visible?: boolean;\n  /**\n   * 弹层打开状态变化\n   */\n  onVisibleChange?: (visible: boolean) => void;\n  /**\n   * 触发弹层打开的方式\n   */\n  trigger?: 'hover' | 'click' | 'mouse-enter';\n  /**\n   * 启用动画\n   */\n  animation?: boolean;\n  /**\n   * 保持弹层内容和触发元素对齐（窗口尺寸发生变化时）\n   */\n  keepAlign?: boolean;\n  /**\n   * 弹层关闭时，保持其中的内容不被从 DOM 上卸载\n   */\n  keepMounted?: boolean;\n  /**\n   * 挂载容器元素\n   */\n  getContainer?: () => HTMLElement | undefined;\n  /**\n   * 当屏幕可视区域放不下内容时是否自动调整内容的宽高\n   */\n   resize?: boolean;\n}, React.HTMLAttributes<HTMLDivElement>>;\n\nconst DEFAULT_PROPS:\n  Required<Pick<IPopoverProps, 'placement' | 'placementOffset' | 'getContainer'>> =\n{\n  placement: 'bottom',\n  placementOffset: [0, 0],\n  getContainer: () => document.body\n};\n\nconst contains = (container: HTMLElement, target: HTMLElement): boolean => {\n  let ele: HTMLElement | null = target;\n  while (ele !== null) {\n    if (ele === container) {\n      return true;\n    }\n    ele = ele.parentElement;\n  }\n  return false;\n};\n\nexport const Popover = React.memo((props: IPopoverProps) => {\n\n  const {\n    visible: _visible,\n    trigger,\n    content = <div></div>,\n    children,\n    getContainer = DEFAULT_PROPS.getContainer,\n    onVisibleChange,\n    placement = DEFAULT_PROPS.placement,\n    placementOffset = DEFAULT_PROPS.placementOffset,\n    animation,\n    keepAlign,\n    keepMounted,\n    resize,\n    ...rest\n  } = props;\n\n  if (!isValidElement(children)) {\n    return null;\n  }\n\n  const [visible, _setVisible] = useDefaultProp(false, _visible, onVisibleChange);\n  const setVisible = useEventCallback((e: boolean) => _setVisible(e));\n\n  const visibleController = useMemo(() => {\n\n    let timeoutId: ReturnType<typeof setTimeout> | null = null;\n\n    const open = () => {\n      cancel();\n      setVisible(true);\n    };\n\n    const close = () => {\n      if (timeoutId === null) {\n        timeoutId = setTimeout(() => {\n          timeoutId = null;\n          (isHoveringContent.current === false) && setVisible(false);\n        }, 150);\n      }\n    };\n\n    const cancel = () => {\n      if (timeoutId !== null) {\n        clearTimeout(timeoutId);\n        timeoutId = null;\n      }\n    };\n\n    const closeImmediately = () => {\n      cancel();\n      setVisible(false);\n    };\n\n    return { open, close, closeImmediately };\n  }, []);\n\n  const isHoveringContent = useRef<boolean>(false);\n\n  const triggerEvents = useMemo(\n    () => {\n\n      if (trigger === 'hover') {\n\n        return {\n          onMouseEnter: visibleController.open,\n          onMouseLeave: visibleController.closeImmediately\n        };\n      } else if (trigger === 'mouse-enter') {\n\n        return {\n          onMouseEnter: visibleController.open,\n          onMouseLeave: visibleController.close,\n        };\n      } else if (trigger === 'click') {\n\n        return {\n          onClick: visibleController.open,\n        };\n      } else {\n        return {};\n      }\n    },\n    [trigger, visibleController]\n  );\n\n  // 监听 document mousedown 事件，触发时关闭 Popover（除非事件在 content 或 trigger 内部触发）\n  useEffect(() => {\n    if (visible) {\n      const hide = (e: MouseEvent) => {\n        if (\n          contentRef.current &&\n          triggerRef.current &&\n          e.target &&\n          !contains(contentRef.current, e.target as HTMLElement) &&\n          !contains(triggerRef.current, e.target as HTMLElement)\n        ) {\n          visibleController.closeImmediately();\n        }\n      }\n      // 为什么要 raf 后再监听：因为当前也许正处在一次 click 事件中\n      const timerId = requestAnimationFrame(() => {\n        document.addEventListener('mousedown', hide);\n      });\n      return () => {\n        window.cancelAnimationFrame(timerId);\n        document.removeEventListener('mousedown', hide);\n      }\n    }\n  }, [visibleController, visible]);\n\n  // 打开 Popover 后，立刻对齐 content 和 trigger\n  useEffect(() => {\n    if (visible === true && contentRef.current && triggerRef.current) {\n      align(contentRef.current, triggerRef.current, placement, placementOffset);\n    }\n  }, [visible]);\n\n  // 如果开启了 keepAlign：打开 Popover 后，监听窗口 resize 事件，触发时重新对齐 content 和 trigger\n  // 注意：如果开启了 animation，首次重新对齐时需要移除 content 上的动画相关 classname\n  useEffect(() => {\n\n    if (visible && keepAlign && contentRef.current && triggerRef.current) {\n\n      // ResizeObserver.observe 会直接触发一次 callback，此时不需要 reAlign\n      let flag = false;\n\n      const reAlign = () => {\n        if (flag && contentRef.current && triggerRef.current) {\n          if (animation) {\n            const regRes = contentRef.current.className.match(/wds-popover-animation-[\\w-]+/);\n            if (regRes && regRes[0]) {\n              contentRef.current.className = contentRef.current.className.replace(regRes[0], '');\n            }\n          }\n          align(contentRef.current, triggerRef.current, placement, placementOffset);\n        }\n      };\n\n      const resizeObserver = new ResizeObserver(reAlign);\n      resizeObserver.observe(document.body);\n      const setFlagTimeoutId = setTimeout(() => flag = true, 100);\n      return () => {\n        resizeObserver.disconnect();\n        clearTimeout(setFlagTimeoutId);\n      }\n    }\n  }, [visible, keepAlign, animation]);\n\n  const triggerRef = useRef<HTMLElement>(null);\n  const contentRef = useRef<HTMLDivElement>(null);\n\n  const ref = mergeRef((children as any).ref, triggerRef);\n\n  return <>\n    {\n      cloneReactNode(\n        children,\n        {\n          ref,\n          ...triggerEvents\n        }\n      )\n    }\n    {\n      (visible || keepMounted) ?\n        ReactDOM.createPortal(\n          <ContentWrap\n            hidden={!keepMounted ? false : !visible}\n            onMouseEnter={\n              trigger === 'mouse-enter' ?\n                () => {\n                  isHoveringContent.current = true;\n                } :\n                undefined\n            }\n            onMouseLeave={\n              trigger === 'mouse-enter' ?\n                () => {\n                  isHoveringContent.current = false;\n                  visibleController.close();\n                } :\n                undefined\n            }\n            ref={contentRef}\n            {...mergeRestProps(rest, mergeClassName('wdn-popover', animation ? `wds-popover-animation-${placement}` : ''))}\n          >\n            {content}\n          </ContentWrap>,\n          getContainer() || document.body\n        )\n        :\n        null\n    }\n  </>;\n});"],"mappings":"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"}