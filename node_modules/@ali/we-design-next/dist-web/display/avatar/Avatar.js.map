{"version":3,"file":"Avatar.js","names":["React","COLORS","LARGE_SIZE","NORMAL_SIZE","SMALL_SIZE","LARGE_BORDER_RADIUS","SMALL_BORDER_RADIUS","styled","AvatarText","span","WHITE","AvatarImage","img","getRealSize","size","getAvatarStyle","shape","fontSize","Math","ceil","borderRadius","width","height","lineHeight","isCdnImgSrc","src","test","getThumbnail","split","host","search","url","URL","oldValue","searchParams","get","newValue","startsWith","slice","set","toString","getLastNickName","nick","num","broken","Array","from","length","join","Avatar","props","name","styleProp","style","rest","imgRef","useRef","useState","failed","setFailed","nickName","realSize","thumbnailUrl","handleError","useCallback","current"],"sources":["../../../../src/display/avatar/Avatar.tsx"],"sourcesContent":["import React from 'react';\nimport { IRestProps, COLORS } from '../../common';\nimport { LARGE_SIZE, NORMAL_SIZE, SMALL_SIZE, LARGE_BORDER_RADIUS, SMALL_BORDER_RADIUS } from './constants';\n\ntype IShape = 'rect' | 'circle';\ntype ISize = 'small' | 'normal' | 'large' | number;\n\nexport type IAvatarProps = {\n  src?: string;\n  /**\n   * 头像的形状, 默认为 rect\n   */\n   shape?: IShape;\n  /**\n    * 用户名字\n    */\n   name?: string;\n   /**\n    * 头像的大小, 其中 small：24px, normal: 32px, large: 64px\n    */\n   size?: ISize;\n} & IRestProps & React.DOMAttributes<HTMLImageElement>;\n\nimport styled from 'styled-components';\n\nconst AvatarText = styled.span`\n  display: inline-block;\n  width: ${SMALL_SIZE}px;\n  height: ${SMALL_SIZE}px;\n  line-height: ${SMALL_SIZE}px;\n  text-align: center;\n  font-size: ${SMALL_SIZE / 2}px;\n  cursor: default;\n  color: ${COLORS.WHITE};\n  background-color: rgb(0, 137, 255);\n  user-select: none;\n`;\n\nconst AvatarImage = styled.img`\n  display: inline-block;\n  width: ${SMALL_SIZE}px;\n  height: ${SMALL_SIZE}px;\n  cursor: default;\n`;\n\nfunction getRealSize(size: ISize) {\n  if (typeof size === 'number') {\n    return size;\n  }\n  switch(size) {\n    case 'large': return LARGE_SIZE;\n    case 'normal': return NORMAL_SIZE;\n    default: return SMALL_SIZE;\n  }\n}\n\nfunction getAvatarStyle(size: number, shape: IShape): React.CSSProperties {\n  const fontSize = Math.ceil(size / 2);\n  let borderRadius: React.CSSProperties['borderRadius'] = size >= LARGE_SIZE ? LARGE_BORDER_RADIUS : SMALL_BORDER_RADIUS;\n  if (shape === 'circle') {\n    borderRadius = '50%';\n  }\n  return {\n    borderRadius,\n    fontSize,\n    width: size,\n    height: size,\n    lineHeight: `${size}px`,\n  };\n}\n\nfunction isCdnImgSrc(src: string) {\n  return /^https?:\\/\\/img.alicdn.com/.test(src);\n}\n\nfunction getThumbnail(src: string = '') {\n  if (!src) return '';\n  const size = 100;\n  if (isCdnImgSrc(src)) {\n    const [host, search = ''] = src.split('?', 2);\n    // 参考文档 https://open.dingtalk.com/document/orgapp-client/image-scaling\n    return `${host}_${size}x${size}${search ? '?' + search : ''}`;\n  }\n  const url = new URL(src);\n  const oldValue = url.searchParams.get('x-oss-process');\n  let newValue = `image/resize,m_fill,h_${size},w_${size}`;\n  if (oldValue && oldValue.startsWith('image/')) {\n    // 第一个resize 配置才会生效\n    newValue = 'image/' + `resize,m_fill,h_${size},w_${size}` + oldValue.slice(5);\n  }\n  // 参考文档 https://help.aliyun.com/document_detail/44688.html\n  url.searchParams.set('x-oss-process', newValue);\n  return url.toString();\n}\n\nfunction getLastNickName(nick?: string, num = 2) {\n  if (!nick) return '';\n  const broken = Array.from(nick);\n  return broken.slice(broken.length - num).join('');\n}\n\nexport const Avatar: React.FC<IAvatarProps> = (props) => {\n  const {\n    src,\n    name,\n    shape = 'rect',\n    size = 'small',\n    style: styleProp,\n    ...rest\n  } = props;\n  const imgRef = React.useRef<HTMLImageElement | null>(null);\n  const [failed, setFailed] = React.useState(false);\n  const nickName = getLastNickName(name, 1);\n  const realSize = getRealSize(size);\n  const thumbnailUrl = getThumbnail(src);\n  const style = getAvatarStyle(realSize, shape);\n\n  const handleError = React.useCallback(\n    () => {\n      if (src && imgRef.current && imgRef.current.src !== src) {\n        // 1. fallback to fallback src\n        imgRef.current.src = src;\n      } else {\n        // 2. fallback to TextAvatar\n        setFailed(true);\n      }\n    },\n    [src],\n  );\n\n  if (!src || failed) {\n    return (\n      <AvatarText {...rest} style={{ ...style, ...styleProp }}>\n        {nickName}\n      </AvatarText>\n    );\n  }\n\n  return (\n    <AvatarImage ref={imgRef} src={thumbnailUrl} onError={handleError} style={{ ...style, ...styleProp }} {...rest} />\n  );\n}\n"],"mappings":"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"}