{"version":3,"file":"rename.js","names":["React","memo","useRef","useEffect","useCallback","useState","useMemo","Tooltip","TitleInput","TitleMirror","TitleBar","TitleName","mirrorOffsetWidth","inputOffsetHeight","inputOffsetWidth","minWidth","maxLength","isSafari","window","navigator","userAgent","includes","Filename","props","fileName","filename","renameAble","onRename","maxWidth","rest","inputRef","readerRef","mirrorRef","newFileName","setFileName","isFocused","setFocus","isComposing","setIsComposing","illeaguePost","setIlleaguePost","resizeNameInput","current","getBoundingClientRect","width","height","mirrorWidth","Math","ceil","inputWidth","style","max","min","handleMouseLeave","HTMLInputElement","scrollLeft","onChangeName","e","value","target","handleBlur","trimFileName","trim","substring","length","alertNameLength","handleFocus","handleEnterKey","input","key","blur","handleTextAreaComposition","type","mirrorText","replace"],"sources":["../../../../src/office/rename/rename.tsx"],"sourcesContent":["import React, { memo, useRef, useEffect, useCallback, useState, useMemo } from 'react';\nimport { Tooltip } from '../../display/tooltip';\nimport { TitleInput, TitleMirror, TitleBar, TitleName } from './styled';\nimport type { IRestProps } from '../../common';\n\nconst mirrorOffsetWidth = 6;\nconst inputOffsetHeight = 6;\nconst inputOffsetWidth = 10;\n\nexport interface IRenameProps extends IRestProps {\n  filename?: string;\n  renameAble: boolean;\n  onRename: (newName: string) => void;\n  maxWidth?: number;\n}\n\nconst minWidth = 2;\nconst maxLength = 32;\n\nconst isSafari = window.navigator.userAgent.includes('Safari') && !window.navigator.userAgent.includes('Chrome');\n\nexport const Filename = memo<IRenameProps>((props) => {\n  const {\n    filename: fileName,\n    renameAble,\n    onRename,\n    maxWidth = -1,\n    ...rest\n  } = props;\n  const inputRef = useRef<HTMLInputElement | null>(null);\n  const readerRef = useRef<HTMLInputElement | null>(null);\n  const mirrorRef = useRef<HTMLDivElement | null>(null);\n\n  const [newFileName, setFileName] = useState<string | undefined>('');\n  const [isFocused, setFocus] = useState(false);\n  const [isComposing, setIsComposing] = useState(false);\n  const [illeaguePost, setIlleaguePost] = useState(false);\n\n\n\n  const resizeNameInput = useCallback(\n    () => {\n      if (!mirrorRef.current) {\n        return;\n      }\n      const { width = 0, height } = mirrorRef.current!.getBoundingClientRect();\n      const mirrorWidth: number = Math.ceil(width);\n      if (renameAble) {\n        if (inputRef.current) {\n          let inputWidth = mirrorWidth + inputOffsetWidth - mirrorOffsetWidth;\n          if (isSafari) {\n            inputWidth = mirrorWidth + inputOffsetWidth;\n            inputRef.current.style.height = `${height + inputOffsetHeight}px`;\n          }\n\n          \n          inputRef.current.style.width = `${maxWidth === -1 ? Math.max(inputWidth, minWidth): Math.min(Math.max(inputWidth, minWidth), maxWidth - inputOffsetWidth)}px`;\n\n          if(readerRef.current){\n            readerRef.current.style.width = `${maxWidth === -1 ? Math.max(inputWidth, minWidth): Math.min(Math.max(inputWidth, minWidth), maxWidth - mirrorOffsetWidth)}px`;\n          }\n          \n        }\n      } else if (readerRef.current) {\n        readerRef.current.style.width = `${maxWidth === -1 ? Math.max(mirrorWidth, minWidth): Math.min(Math.max(mirrorWidth, minWidth), maxWidth - mirrorOffsetWidth)}px`;\n      }\n    },\n    [renameAble, isSafari, minWidth, maxWidth],\n  );\n\n  useEffect(\n    () => {\n      setFileName(fileName);\n      resizeNameInput();\n    },\n    [fileName, resizeNameInput],\n  );\n\n  useEffect(\n    () => {\n      resizeNameInput();\n    },\n    [resizeNameInput, newFileName],\n  );\n\n  const handleMouseLeave = useCallback(\n    () => {\n      if (!isFocused && inputRef?.current instanceof HTMLInputElement) {\n        const { width } = inputRef.current.getBoundingClientRect();\n        inputRef.current.style.width = `${width}px`;\n        inputRef.current.scrollLeft = 0;\n        resizeNameInput();\n      }\n    },\n    [isFocused, resizeNameInput],\n  );\n\n  const onChangeName = useCallback(\n    (e: React.ChangeEvent<HTMLInputElement>) => {\n      const { value } = e.target;\n      setFileName(value);\n    },\n    [],\n  );\n  /* 响应编辑输入框失焦 */\n  const handleBlur = useCallback(\n    () => {\n      setIlleaguePost(false);\n      const trimFileName = inputRef?.current?.value?.trim().substring(0, maxLength);\n      if (trimFileName && trimFileName?.length > 0) {\n        setFileName(trimFileName);\n        setFocus(false);\n        onRename(trimFileName);\n      } else {\n        setFileName(fileName);\n        setFocus(false);\n      }\n    },\n    [fileName, maxLength, onRename],\n  );\n\n  // 文件名超限时给出警告\n  const alertNameLength = useCallback(\n    () => {\n      if (!illeaguePost && newFileName && newFileName.length > maxLength) {\n        setIlleaguePost(true);\n      }\n    },\n    [illeaguePost, maxLength, newFileName],\n  );\n\n  // 聚焦时，选中文本\n  const handleFocus = useCallback(\n    () => {\n      setFocus(true);\n    },\n    [],\n  );\n\n  const handleEnterKey = useCallback(\n    (e: React.KeyboardEvent<HTMLInputElement>) => {\n      const input = inputRef.current;\n      switch (e.key) {\n        case 'Escape':\n          if (input) {\n            input.value = fileName || '';\n          }\n          !isComposing && input?.blur();\n          break;\n        case 'Enter':\n          setIlleaguePost(false);\n          !isComposing && input?.blur();\n          break;\n        default:\n          break;\n      }\n    },\n    [isComposing, fileName],\n  );\n\n  const handleTextAreaComposition = useCallback(\n    (e: React.CompositionEvent<HTMLTextAreaElement>) => {\n      if (e.type === 'compositionstart') {\n        setIsComposing(true);\n      }\n      if (e.type === 'compositionend') {\n        setIsComposing(false);\n        setIlleaguePost(false);\n      }\n    },\n    [],\n  );\n\n  const mirrorText = useMemo(\n    () => (newFileName || '').replace(/\\s/g, '\\u00A0'),\n    [newFileName],\n  );\n\n  return (\n    <TitleBar {...rest}>\n      {renameAble\n        ? (\n          <Tooltip title={'重命名'}>\n            <TitleInput\n              ref={inputRef}\n              value={newFileName}\n              title={newFileName}\n              onChange={onChangeName}\n              onBlur={handleBlur}\n              onFocus={handleFocus}\n              onKeyDown={handleEnterKey}\n              onKeyUp={alertNameLength}\n              maxLength={maxLength}\n              isFocused={isFocused}\n              onMouseLeave={handleMouseLeave}\n              onCompositionStart={handleTextAreaComposition}\n              onCompositionEnd={handleTextAreaComposition}\n            />\n          </Tooltip>\n        )\n        : (\n          <TitleName ref={readerRef} title={fileName}>\n            {fileName}\n          </TitleName>\n        )\n      }\n      <TitleMirror ref={mirrorRef}>\n        {mirrorText}\n      </TitleMirror>\n    </TitleBar>\n  );\n});\n"],"mappings":"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"}