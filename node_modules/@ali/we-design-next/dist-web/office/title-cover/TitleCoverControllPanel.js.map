{"version":3,"file":"TitleCoverControllPanel.js","names":["React","useEffect","useImperativeHandle","useRef","useState","Popover","useTranslate","ButtonsWrapper","SettingButton","getSafePosition","DEFAULT_POSITION","mergeRestProps","TitleCoverControllPanel","memo","forwardRef","props","ref","imagePicker","getImagePickerContainer","onChange","onPickImageStart","onPickImageEnd","rest","position","setPosition","isReposition","setIsReposition","wrapperRef","startYRef","isMovePosition","originPositionRef","titleCoverRef","positionRef","dragStartPositionRef","attach","titleCover","current","isRep","p","savePosition","cover","getCover","transform","offsetY","endReposition","turnOnReposition","startReposition","handleMouseDownImg","e","handleDragging","imgRef","getImageRef","preventDefault","stopPropagation","screenY","offsetPercent","offsetHeight","setRenderPosition","Math","max","min","handleMouseUp","document","removeEventListener","addEventListener","imgeRef","handleCancel","handleClick","getBoundingClientRect","top","bottom","left","right","clientX","clientY","handleClickPickImageButton","t","handleOnVisibleChange","v","getContainer","body","borderRadius","borderRight"],"sources":["../../../../src/office/title-cover/TitleCoverControllPanel.tsx"],"sourcesContent":["import React, {\n  DOMAttributes,\n  useEffect,\n  useImperativeHandle,\n  useRef,\n  useState,\n} from \"react\";\nimport { TitleCover, Cover as CoverType } from \"./TitleCover\";\nimport { Popover } from \"../../display/popover\";\nimport { useTranslate } from \"../../locale\";\nimport { ButtonsWrapper, SettingButton } from \"./style\";\nimport { getSafePosition } from \"./utils\";\nimport { DEFAULT_POSITION } from \"./constants\";\nimport { IRestProps, mergeRestProps } from \"../../common/react/mergeRestProps\";\n\ntype TitleCoverControllPanelProps = {\n  /**\n   * 更换封面图片选择器\n   * 返回值会被设为 Popover 的 content\n   */\n  imagePicker: React.ReactNode;\n  /**\n   * 作为 imagePicker Popover 的 getContainer\n   */\n  getImagePickerContainer?: () => HTMLElement;\n  /**\n   * 封面数据变化 callback\n   */\n  onChange?: (cover: CoverType) => void;\n  /**\n   * 开始选择图片\n   */\n  onPickImageStart?: () => void;\n  /**\n   * 结束选择图片\n   */\n  onPickImageEnd?: () => void;\n} & IRestProps & Omit<DOMAttributes<HTMLDivElement>, 'onChange'>;\n\ntype TitleCoverControllPanelRef = {\n  attach: (titleCover: React.ComponentRef<typeof TitleCover>) => () => void;\n};\n\nexport const TitleCoverControllPanel = React.memo(\n  React.forwardRef<TitleCoverControllPanelRef, TitleCoverControllPanelProps>(\n    (props, ref) => {\n      const {\n        imagePicker,\n        getImagePickerContainer,\n        onChange,\n        onPickImageStart,\n        onPickImageEnd,\n        ...rest\n      } = props;\n      const [position, setPosition] = useState(DEFAULT_POSITION);\n      const [isReposition, setIsReposition] = useState(false);\n      const wrapperRef = useRef<HTMLDivElement>(null);\n      const startYRef = useRef(0);\n      const isMovePosition = useRef(false);\n      const originPositionRef = useRef(0);\n      const titleCoverRef = useRef<React.ComponentRef<\n        typeof TitleCover\n      > | null>(null);\n      const positionRef = useRef(position);\n      const dragStartPositionRef = useRef(position);\n\n      useImperativeHandle(ref, () => ({\n        attach: (titleCover) => {\n          titleCoverRef.current = titleCover;\n          return titleCover.onChange(({ isReposition: isRep, position: p }) => {\n            setIsReposition(isRep);\n            setPosition(p);\n          });\n        },\n      }));\n\n      useEffect(() => {\n        positionRef.current = position;\n      }, [position]);\n\n      const savePosition = () => {\n        const cover = titleCoverRef.current?.getCover();\n        if (cover) {\n          onChange?.({\n            ...cover,\n            transform: { offsetY: position },\n          });\n        }\n        titleCoverRef.current?.endReposition();\n      };\n\n      const turnOnReposition = () => {\n        originPositionRef.current = position;\n        titleCoverRef.current?.startReposition();\n      };\n\n      React.useEffect(() => {\n        if (isReposition) {\n          const handleMouseDownImg = (e: MouseEvent) => {\n            isMovePosition.current = false;\n            dragStartPositionRef.current = positionRef.current;\n\n            const handleDragging = (e: MouseEvent) => {\n              const imgRef = titleCoverRef.current?.getImageRef();\n              if (!imgRef?.current) {\n                return;\n              }\n              e.preventDefault();\n              e.stopPropagation();\n              isMovePosition.current = true;\n              const offsetY = e.screenY - startYRef.current;\n              // x0.5 避免拖动过快（参考 notion）\n              const offsetPercent = (offsetY / imgRef.current.offsetHeight) * 0.5;\n              // position 取值范围 [0, 1]\n              titleCoverRef.current?.setRenderPosition(\n                Math.max(0, Math.min(1, dragStartPositionRef.current - offsetPercent))\n              );\n            };\n\n            const handleMouseUp = () => {\n              if (!isMovePosition.current) {\n                titleCoverRef.current?.setRenderPosition(\n                  getSafePosition(originPositionRef.current)\n                );\n                titleCoverRef.current?.endReposition();\n              }\n              document.removeEventListener(\"mousemove\", handleDragging);\n              document.removeEventListener(\"mouseup\", handleMouseUp);\n            };\n\n            if (isReposition) {\n              startYRef.current = e.screenY;\n              document.addEventListener(\"mousemove\", handleDragging);\n              document.addEventListener(\"mouseup\", handleMouseUp);\n\n              return () => {\n                document.removeEventListener(\"mousemove\", handleDragging);\n                document.removeEventListener(\"mouseup\", handleMouseUp);\n              };\n            }\n          };\n\n          const imgeRef = titleCoverRef.current?.getImageRef();\n          if (imgeRef?.current) {\n            imgeRef.current.addEventListener(\"mousedown\", handleMouseDownImg);\n            return () => {\n              imgeRef.current?.removeEventListener(\n                \"mousedown\",\n                handleMouseDownImg\n              );\n            };\n          }\n        }\n      }, [isReposition]);\n\n      const handleCancel = () => {\n        titleCoverRef.current?.setRenderPosition(\n          getSafePosition(originPositionRef.current)\n        );\n        titleCoverRef.current?.endReposition();\n      };\n\n      const preventDefault = (e: React.MouseEvent) => {\n        e.stopPropagation();\n      };\n\n      useEffect(() => {\n        const handleClick = (e: MouseEvent) => {\n          const imgRef = titleCoverRef.current?.getImageRef();\n          if (!imgRef?.current || isMovePosition.current) {\n            isMovePosition.current = false;\n            return;\n          }\n          const { top, bottom, left, right } =\n            imgRef.current.getBoundingClientRect();\n          const { clientX, clientY } = e;\n          if (\n            clientX < left ||\n            clientX > right ||\n            clientY < top ||\n            clientY > bottom\n          ) {\n            const cover = titleCoverRef.current?.getCover();\n            if (cover) {\n              onChange?.({\n                ...cover,\n                transform: { offsetY: positionRef.current },\n              });\n            }\n            titleCoverRef.current?.endReposition();\n          }\n        };\n\n        if (isReposition) {\n          document.addEventListener(\"click\", handleClick);\n        } else {\n          document.removeEventListener(\"click\", handleClick);\n        }\n        return () => {\n          if (isReposition) {\n            document.removeEventListener(\"click\", handleClick);\n          }\n        };\n      }, [isReposition]);\n\n      const handleClickPickImageButton = () => {\n        onPickImageStart?.();\n      };\n\n      const t = useTranslate();\n\n      const handleOnVisibleChange = (v: boolean) => {\n        if (!v) {\n          onPickImageEnd?.();\n        }\n      };\n\n      const getContainer = () => {\n        return getImagePickerContainer?.() || wrapperRef.current || document.body;\n      };\n\n      return (\n        <ButtonsWrapper ref={wrapperRef} {...mergeRestProps(rest, 'wdn-title-cover-controll-panel')}>\n          {!isReposition ? (\n            <>\n              <Popover\n                placement=\"bottomLeft\"\n                trigger=\"click\"\n                content={imagePicker}\n                onVisibleChange={handleOnVisibleChange}\n                getContainer={getContainer}\n                style={{ borderRadius: 8 }}\n              >\n                <SettingButton onClick={handleClickPickImageButton} style={{\n                  borderRight: '1px solid rgba(55, 53, 47, 0.09)',\n                }}>\n                  {t(\"wdn_title_cover_update_image\")}\n                </SettingButton>\n              </Popover>\n              <SettingButton onClick={turnOnReposition}>\n                {t(\"wdn_title_cover_reposition\")}\n              </SettingButton>\n            </>\n          ) : (\n            <>\n              <SettingButton\n                style={{\n                  borderRight: '1px solid rgba(55, 53, 47, 0.09)',\n                }}\n                onClick={savePosition}\n                onMouseDown={preventDefault}\n              >\n                {t(\"wdn_title_cover_save_position\")}\n              </SettingButton>\n              <SettingButton\n                onClick={handleCancel}\n                onMouseDown={preventDefault}\n              >\n                {t(\"wdn_cancel\")}\n              </SettingButton>\n            </>\n          )}\n        </ButtonsWrapper>\n      );\n    }\n  )\n);\n"],"mappings":"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"}