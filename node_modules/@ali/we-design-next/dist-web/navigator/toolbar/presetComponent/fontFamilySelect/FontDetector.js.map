{"version":3,"file":"FontDetector.js","names":["v4","uuid","fastdom","woff","FontDetector","fonts","css","timer","styleUuid","iframeUuid","detection","ready","callback","window","setTimeout","iframe","document","getElementById","inject","style","clientWidth","detect","Promise","relove","getResult","res","uid","createElement","id","cssText","body","appendChild","iframeDoc","contentDocument","sheet","setAttribute","innerHTML","head","getElementsByTagName","elem","remove","destroy","clearTimeout","fragment","createDocumentFragment","font","el","className","fontFamily","measure","results","Array","from","children","map"],"sources":["../../../../../../src/navigator/toolbar/presetComponent/fontFamilySelect/FontDetector.ts"],"sourcesContent":["/* eslint-disable consistent-return */\n/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { v4 as uuid } from 'uuid';\nimport fastdom from 'fastdom';\n\nconst woff =\n  'data:font/woff;charset=utf-8;base64,d09GRk9UVE8AAAQYAAoAAAAABlwAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABDRkYgAAAA9AAAAMQAAADSEQga8UZGVE0AAAG4AAAAGwAAABxqQJGNT1MvMgAAAdQAAABDAAAAYFYPXfBjbWFwAAACGAAAADcAAAFCAA0D1mhlYWQAAAJQAAAAKQAAADb9ITBXaGhlYQAAAnwAAAAZAAAAJAN7/ztobXR4AAACmAAAAAgAAAAIAfQAAG1heHAAAAKgAAAABgAAAAYAAlAAbmFtZQAAAqgAAAFZAAACjkaWZeZwb3N0AAAEBAAAABMAAAAg/4YAMnicY2RgYWFgZGTkCs0rySzJSU0xZGBkYmBk0PjBz/BDmvGHDNMPWeYf4izdQMAqw7CIX4aBQUCGYamgDAO7DMNpIQZmkGoXBl+GMOei1MSS1BSFpEqFqtS8fCBO19HRUSjPLMlQcMvPK3HLL0pPVTDSM1DQyCgpKbDS108DiqaBRPWK0/TyUks04Y5AuAYIBBmYGBkVFLv3/nDdy7h37++Yvcx7xdR/rHzPtvdPuegP198xf1zZ+fi6RbpFu3m4ANybP/V4nGNgYGBkAIIztovOg+jzjOV2ULoeAEMOBccAeJxjYGH8wviFgZWBgamLaQ8DA0MPhGZ8wGDIyAQUZWBjZoABRgYkEJDmmsJwgMGAwYBZ4b8FQxSGGgUgZAQAfmQKqgB4nGNgYGBmgGAZBkYGELAB8hjBfBYGBSDNAoQgvsH//xDy/0WoSgZGNgYYk2hAqvrBDgBrAQbjAHicY2BkYGAA4pys3ox4fpuvDNzML4AiDOcZy3ci01DAwcAEogAU4ghtAAAAeJxjYGRgYFb4b8EQxQADjAyogAkAMlIBuQAAAAH0AAAAAAAAAABQAAACAAB4nIWQzUoDMRSFT+wPFESkT5CNUGEmzZRuOluhC8Wl3bdMph2omTpNKe1eceebCL6Ca9euXfsE7vTMNBREsBOS+92TMzc3AXCCZwjsvgs8ehZo4cPzEZr48lzDmbjyXEdL3Htu4FS8eG5Sf6dT1FvMHqq/ShZo483zEY7x6bmGS3x7rqMt7jw3IMWT5yb1V/ZXwGAMxzWBxAQbrltmFrmPUwTVkFgjo3NGGnLXkstY0GGo9aCgGTt0OI4FYnQ5Uu9N916FJTNF1VA/5zMVZuxMIicbuTU255wGQSDXmZvJYW7dMC+mRvaUlp2Zc4u4202ppqWqlqmyxrHITXVK2eG8uk1EybrMzU1CvK60DCvcMjFJtmL87xox59+SOz3CACHXkG7N2GepX23Gcn80ORqEUdjTUf9QkyNqBR8nq/qSrF1WV1Use8LIFMsst1LrSGmt5YGCP/yzcc0AAAB4nGNgZgCD/80MRgxYAAAoRAG4AA==';\n\n/**\n * 20200126 引入 uuid，保证多实例 hook，避免多个hook同时对dom操作造成的判断失效\n * 保证每次调用能拿到同一个值\n */\nexport class FontDetector {\n\n  private css: string;\n\n  private timer: number;\n\n  private readonly uuid: string;\n\n  private readonly styleUuid: string;\n\n  private readonly iframeUuid: string;\n\n  private detection: boolean[] | undefined;\n\n  fonts: string[];\n\n  constructor(fonts: string[]) {\n    this.fonts = fonts;\n    this.detection;\n    const uid = uuid();\n    this.uuid = `font-${uid}`;\n    this.styleUuid = `style-${uid}`;\n    this.iframeUuid = `iframe-${uid}`;\n    this.css = `\n    @font-face {\n      font-family: font-detect-0-woff;\n      src: url(${woff}) format('woff');\n    }\n    #${this.uuid} {\n      display: inline-block;\n      position: fixed;\n      left: -1000px;\n      top: -1000px;\n      font-family: font-detect-0-woff;\n    }\n    #${this.uuid} .fontspan {\n      display: inline-block;\n      position: fixed;\n      left: -1000px;\n      top: -1000px;\n    }\n    `;\n    this.inject();\n    this.timer = 0;\n  }\n\n   private inject() {\n    let iframe = document.getElementById(this.iframeUuid);\n    if (!iframe) {\n      iframe = document.createElement('iframe');\n      iframe.id = this.iframeUuid;\n      iframe.style.cssText = `\n        position: fixed;\n        left: -1000px;\n        top: -1000px;\n        width: 0;\n        height: 0;\n        border: none;\n        margin: 0;\n        padding: 0;\n        overflow: hidden;\n        z-index: -1;\n      `;\n      document.body.appendChild(iframe);\n\n      const iframeDoc = (iframe as HTMLIFrameElement).contentDocument!;\n\n      const sheet = iframeDoc.createElement('style');\n      sheet.setAttribute('type', 'text/css');\n      sheet.id = this.styleUuid;\n      sheet.innerHTML = this.css;\n      const head = iframeDoc.getElementsByTagName('head')[0];\n      head.appendChild(sheet);\n\n      const elem = iframeDoc.createElement('div');\n      elem.id = this.uuid;\n      elem.innerHTML = '0';\n      iframeDoc.body.appendChild(elem);\n    }\n  };\n\n  private remove() {\n    const elem = document.getElementById(this.iframeUuid);\n    if (elem != null) {\n      elem.remove();\n    }\n  };\n\n  /**\n   * 增加500ms的delay避免hooks快速触发导致的回掉失效\n   * @param callback\n   */\n   private ready = (callback: any): any => {\n    this.timer = window.setTimeout(() => {\n      let iframe = document.getElementById(this.iframeUuid);\n      if (!iframe) {\n        this.inject();\n        iframe = document.getElementById(this.iframeUuid);\n      }\n      // warning: 这里的判断逻辑过于 hack，无法找到ref来自哪里\n      if (iframe?.style && iframe.clientWidth === 0) {\n        return callback();\n      }\n    }, 0);\n  };\n\n  destroy() {\n    if (this.timer) {\n      window.clearTimeout(this.timer);\n      this.remove();\n    }\n  }\n\n  private getResult(callback: (res: boolean[]) => void) {\n    const iframe = document.getElementById(this.iframeUuid);\n    const iframeDoc = (iframe as HTMLIFrameElement).contentDocument!;\n    const elem = iframeDoc.getElementById(this.uuid) as HTMLElement;\n    const fragment = iframeDoc.createDocumentFragment();\n    // eslint-disable-next-line no-restricted-syntax\n    for (const font of this.fonts) {\n      const el = iframeDoc.createElement('span');\n      el.className = 'fontspan';\n      el.innerHTML = '0';\n      el.style.fontFamily = `'${font}', font-detect-0-woff`;\n      fragment.appendChild(el);\n    }\n    elem.appendChild(fragment);\n    // read dom on next cycle\n    fastdom.measure(() => {\n      const results = Array.from(elem.children).map(\n        (el) => el.clientWidth > 0,\n      );\n      this.detection = results;\n      callback(results);\n      this.remove();\n    });\n  };\n\n  detect = () => {\n    return new Promise<boolean[]>((relove) => {\n      if (this.detection) { relove(this.detection); return; } \n      const detection: boolean[] = [];\n      this.ready(() => this.getResult((res) => {\n        this.detection = res;\n        relove(this.detection);\n        return;\n      }))\n    })\n  }\n}\n\n\n"],"mappings":"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"}