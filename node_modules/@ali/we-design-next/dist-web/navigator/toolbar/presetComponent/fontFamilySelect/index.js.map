{"version":3,"file":"index.js","names":["React","useMemo","useState","useCallback","useLayoutEffect","useRef","useEffect","TBTextSelect","Select","Tooltip","getFontFamily","fontFamilies","useTranslate","useDefaultProp","FontDetector","DownloadButton","fontSet","Set","getFontDetector","fontDetectorMap","Map","fonts","fontDetector","get","useFontFamily","t","options","s","temp","TBFontFamilySelect","memo","props","value_","value","onChange_","onChange","overlayVisible_","overlayVisible","onVisibleChange_","onVisibleChange","downloadFontInfos","handleDownload","enableUnSupportFont","restProps","setValue","installedRecord","setInstalledRecord","fontDetectedRef","fontDetected","current","fontFamiliesInfo","res","forEach","installable","push","key","title","disabled","status","extendOptions","some","opt","detectFont","font","detect","then","hasFont","newInstalledRecord","results","result","index","renderOption","find","o","family","display","justifyContent","titleNode","undefined","fontFamily","fontValue","has","displayName"],"sources":["../../../../../../src/navigator/toolbar/presetComponent/fontFamilySelect/index.tsx"],"sourcesContent":["import React, { useMemo, useState, useCallback, useLayoutEffect, useRef, useEffect } from 'react';\nimport { TBTextSelect } from '../../baseItem/textSelect';\nimport { ISelectProps, Select } from '../../../../form/select';\nimport type { ITBTextSelectProps } from '../../baseItem/textSelect';\nimport { Tooltip } from '../../../../display/tooltip/Tooltip';\nimport { getFontFamily, fontFamilies } from './getFontFamily';\nimport { useTranslate } from '../../../../locale';\nimport { useDefaultProp } from '../../../../common';\nimport { FontDetector } from './FontDetector';\nimport { DownloadButton } from './DownloadButton';\n\nconst fontSet = new Set(fontFamilies);\n\nconst getFontDetector = (() => {\n  let fontDetectorMap = new Map<string[] | string, FontDetector>();\n  return function (fonts: (string[] | string) = fontFamilies) {\n    let fontDetector = fontDetectorMap.get(fonts);\n    if (fontDetector) { return fontDetector; }\n    if (typeof fonts === 'string') { }\n    fontDetector = new FontDetector(\n      (typeof fonts === 'string') ? [fonts] : fonts,\n    );\n    return fontDetector;\n  }\n})();\n\nconst useFontFamily = (t: (v: string) => string) => {\n\n  // 字体列表选项\n  const options = useMemo(() => {\n    const fontFamilies = getFontFamily((s) => t(s));\n    return fontFamilies;\n  }, [t]);\n\n  return options;\n};\n\nexport interface DownloadFontInfo {\n  status: 'unDownload' | 'downloading' | 'downloaded';\n}\n\nexport interface ITBFontFamilySelectProps extends Omit<ITBTextSelectProps, 'renderOption'> {\n  downloadFontInfos?: Record<string, DownloadFontInfo>;\n  handleDownload?: (font: string) => void;\n  // 可否接受传入不支持的字体\n  enableUnSupportFont?: boolean;\n}\n\nconst temp: Record<string, DownloadFontInfo> = {};\n\nexport const TBFontFamilySelect = React.memo<ITBFontFamilySelectProps>((props) => {\n  const {\n    value: value_,\n    onChange: onChange_,\n    overlayVisible: overlayVisible_,\n    onVisibleChange: onVisibleChange_,\n    downloadFontInfos = temp,\n    handleDownload,\n    enableUnSupportFont = true,\n    ...restProps\n  } = props;\n  const t = useTranslate();\n  const [value, setValue] = useDefaultProp('default', value_, onChange_);\n  const [overlayVisible, onVisibleChange] = useDefaultProp(false, overlayVisible_, onVisibleChange_);\n\n  const [installedRecord, setInstalledRecord] = useState<\n    Record<string, boolean>\n  >({ default: true });\n  // font detected\n  const fontDetectedRef = useRef({ fontDetected: false, installedRecord });\n  fontDetectedRef.current.installedRecord = installedRecord;\n\n  // @ts-ignore\n  const fontFamiliesInfo = useFontFamily(t);\n\n  const options = useMemo(() => {\n    const res: Array<{ key: string, title: string, disabled: boolean }> = [];\n    fontFamiliesInfo.forEach((t) => {\n      if (installedRecord[t.value] || t.installable) {\n        res.push({\n          key: t.value,\n          title: t.title,\n          disabled: !installedRecord[t.value] && downloadFontInfos[t.value]?.status !== 'downloaded',\n        });\n      }\n    });\n    return res;\n  }, [fontFamilies, installedRecord, downloadFontInfos]);\n\n  // 单测环境下这里需要依赖浏览器 API 获取已安装字体然后显示，所以只有那些可安装的字体会显示。\n  // 这里即使字体不可安装，也应该显示出来，作为列表一项\n  const extendOptions = (!enableUnSupportFont || options.some((opt) => opt.key === value)) ? options : [\n    ...options,\n    {\n      key: value,\n      title: value,\n      disabled: true,\n    }\n  ]\n\n\n  const detectFont = useCallback((font?: string) => {\n    if (fontDetectedRef.current.fontDetected) {\n      return;\n    }\n    if (font && !fontDetectedRef.current.installedRecord[font]) {\n      getFontDetector(font).detect().then(([hasFont]) => {\n        const newInstalledRecord = fontDetectedRef.current.installedRecord;\n        setInstalledRecord({ ...newInstalledRecord, [font]: hasFont });\n      });\n      return;\n    }\n    getFontDetector().detect().then((results) => {\n\n      const newInstalledRecord: Record<string, boolean> = {};\n      results.forEach((result: boolean, index: number) => {\n        if (index !== 0) {\n          newInstalledRecord[fontFamilies[index]] = result;\n        }\n      });\n      newInstalledRecord.default = true;\n      setInstalledRecord(newInstalledRecord);\n      fontDetectedRef.current.fontDetected = true;\n    });\n  }, []);\n\n  useEffect(() => {\n    if (fontDetectedRef.current.fontDetected) {\n      return;\n    }\n    if (value !== 'default') {\n      detectFont(value);\n    }\n  }, [value]);\n\n  useLayoutEffect(() => {\n    if (overlayVisible) {\n      detectFont();\n    }\n  }, [overlayVisible]);\n\n  const renderOption: ISelectProps['renderOption'] = useCallback(({ key }: { key: string }) => {\n\n    const { title, disabled, key: family } = extendOptions.find(o => o.key === key) || { title: '' };\n\n    if (handleDownload && disabled && downloadFontInfos[key]) {\n      return (\n        <Select.Option\n          key={key}\n          children={\n            <div style={{ display: 'flex', justifyContent: 'space-between' }}>\n              <Tooltip title={t('wdn_font_UninstallFonts')} placement=\"top\" ><div>{title}</div></Tooltip>\n              <DownloadButton handleDownload={handleDownload} status={downloadFontInfos[key].status} fontFamily={key} />\n            </div>\n          }\n        />\n      );\n    }\n    const titleNode = <div style={disabled ? undefined : { fontFamily: family }}>{title}</div>;\n\n    return (\n      <Select.Option\n        key={key}\n        children={disabled ? <Tooltip title={t('wdn_font_UninstallFonts')} placement=\"top\" >{titleNode}</Tooltip> : titleNode}\n      />\n    );\n  }, [installedRecord, handleDownload, downloadFontInfos]);\n\n  let fontValue = value;\n  if (!enableUnSupportFont) {\n    fontValue = fontSet.has(value) ? value : 'default';\n  }\n\n  return (\n    <TBTextSelect\n      {...restProps}\n      value={fontValue}\n      overlayVisible={overlayVisible}\n      onVisibleChange={onVisibleChange}\n      onChange={setValue}\n      options={extendOptions}\n      renderOption={renderOption}\n    />\n  );\n});\nTBFontFamilySelect.displayName = 'textSelect'\n"],"mappings":"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"}