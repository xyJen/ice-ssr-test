{"version":3,"sources":["../../../../src/bi/components/placeholder.tsx"],"names":["React","useState","useCallback","useEffect","environment","useZoom","useZoomContainer","Portal","MentionSuggestion","useOnClickOutside","exitPlaceholder","cancelPlaceholder","activePlaceholder","PlaceholderInputWrapper","InputSpanWrapper","InputWrapper","InsertWrapper","PlaceholderTextWrapper","PlaceholderIcon","InlinePlaceholder","PlaceholderComponent","Status","PRE_FIX","Placeholder","memo","props","placeholderRef","useRef","node","controller","data","active","normal","status","setStatus","handleClick","query","PlaceholderPortal","inputRef","portalRef","scrollableContent","document","body","zoom","onStatusChange","mentionConfig","value","setValue","current","focus","moveAnchorEnd","close","e","contains","target","run","key","trim","parentRef","overlay","slice","handleChange","innerHtml","innerText","range","window","getSelection","anchorNode","childNodes","selectAllChildren","collapseToEnd","locale","mentionPlaceholder","PlaceholderBtn","isSelected","onClick","stopPropagation","IS_MOBILE"],"mappings":"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","sourcesContent":["import React, { useState, useCallback, useEffect } from 'react';\nimport { Controller, Injection, Inline, environment, useZoom, useZoomContainer } from '@ali/4ever-cangjie';\nimport { Portal } from '@ali/4ever-component';\nimport MentionSuggestion from '../components/suggestionForQuickInsert';\nimport { useOnClickOutside } from '@ali/4ever-component';\nimport { MentionPluginConfig } from '../types';\nimport { exitPlaceholder, cancelPlaceholder, activePlaceholder } from '../actions';\nimport { PlaceholderInputWrapper, InputSpanWrapper, InputWrapper, InsertWrapper, PlaceholderTextWrapper, PlaceholderIcon } from './styled';\nimport { InlinePlaceholder } from '@ali/we-toolbar';\nimport PlaceholderComponent from '../../components/placeholder';\n\nexport enum Status {\n  normal,\n  active,\n}\ninterface IProps {\n  controller: Controller;\n  injections: Injection[];\n  node: Inline;\n  mentionConfig: MentionPluginConfig;\n  isSelected: boolean;\n}\n\ninterface IPortalProps extends Omit<IProps, 'injections'> {\n  onStatusChange: (status: Status) => void;\n  parentRef: React.RefObject<HTMLDivElement>;\n}\n\ninterface IBtnProps extends Omit<IProps, 'injections'> {\n  onClick: () => void;\n}\n\nconst PRE_FIX = '@';\n\nconst Placeholder: React.FC<IProps> = React.memo((props: IProps) => {\n  const placeholderRef = React.useRef<HTMLDivElement>(null);\n\n  const { node, controller } = props;\n  const [status, setStatus] = useState(node.data.active ? Status.active : Status.normal);\n\n  const handleClick = useCallback(() => {\n    setStatus(Status.active);\n  }, []);\n\n  return (\n    <PlaceholderComponent\n      ref={placeholderRef}\n    >\n      {\n        status === Status.active && !controller.query('isDisableMentionPanel') ?\n          <PlaceholderPortal\n            {...props}\n            parentRef={placeholderRef}\n            onStatusChange={setStatus}\n          />\n          :\n          <PlaceholderBtn {...props} onClick={handleClick} />\n      }\n    </PlaceholderComponent>);\n});\n\nconst PlaceholderPortal: React.FC<IPortalProps> = React.memo((props: IPortalProps) => {\n  const inputRef = React.useRef<HTMLDivElement>(null);\n  const portalRef = React.useRef<HTMLDivElement>(null);\n  const scrollableContent = useZoomContainer() || document.body;\n  const zoom = useZoom();\n\n  const { controller, onStatusChange, mentionConfig, node } = props;\n  const [value, setValue] = useState(PRE_FIX);\n\n  useEffect(() => {\n    inputRef.current?.focus();\n    moveAnchorEnd();\n  }, [inputRef.current]);\n\n  const close = useCallback((e) => {\n    // 如点击了 portal 区域 不触发关闭\n    if (portalRef.current?.contains(e.target)) {\n      return;\n    }\n\n    // 清除掉 injection\n    controller.run('onAction', cancelPlaceholder(node.key));\n\n    // 如未输入内容，变成占位符状态\n    // 如输入部分内容，变成文本\n    if (value.trim() === PRE_FIX) {\n      onStatusChange(Status.normal);\n      return;\n    }\n\n    return controller.run('onAction', exitPlaceholder(value.trim(), node));\n  }, [controller, onStatusChange, node, value]);\n\n  useOnClickOutside(props.parentRef, close);\n\n  const overlay = (\n    <InsertWrapper>\n      <MentionSuggestion\n        {...mentionConfig}\n        controller={controller}\n        at={node.key}\n        text={value!.slice(1).trim()}\n      />\n    </InsertWrapper>\n  );\n\n  const handleChange = () => {\n    const innerHtml = inputRef.current?.innerText as string;\n    if (innerHtml === '') {\n      onStatusChange(Status.normal);\n      return controller.run('onAction', exitPlaceholder('', node));\n    }\n    setValue(inputRef.current?.innerText as string);\n  };\n\n  const moveAnchorEnd = () => {\n    const range = window.getSelection();\n    if (range?.anchorNode !== inputRef.current?.childNodes[0]) {\n      return;\n    }\n    range?.selectAllChildren && (range?.selectAllChildren(inputRef.current as HTMLDivElement));\n    range?.collapseToEnd && (range?.collapseToEnd());\n  };\n\n  return (\n    <PlaceholderInputWrapper>\n      <Portal\n        className=\"menu-insert-mention-portal\"\n        data-testid=\"menu-insert-mention-portal\"\n        visible\n        container={scrollableContent}\n        overlay={overlay}\n        portalRef={portalRef}\n        maxWidth={420}\n        zoom={zoom}\n      >\n        <InputWrapper>\n          <InlinePlaceholder\n            icon={(\n              <InputSpanWrapper\n                data-testid=\"menu-insert-mention-input\"\n                contentEditable\n                data-cangjie-not-editable\n                ref={inputRef}\n                onInput={handleChange}\n              >\n                {PRE_FIX}\n              </InputSpanWrapper>\n            )}\n            type=\"normal\"\n            className=\"inline-placeholder\"\n          >\n            {\n              value === PRE_FIX &&\n              <PlaceholderTextWrapper>{mentionConfig.locale?.mentionPlaceholder}</PlaceholderTextWrapper>\n            }\n          </InlinePlaceholder>\n        </InputWrapper>\n      </Portal>\n    </PlaceholderInputWrapper>);\n});\n\nconst PlaceholderBtn: React.FC<IBtnProps> = React.memo((props: IBtnProps) => {\n  const { mentionConfig, controller, isSelected, node, onClick } = props;\n\n  const handleClick = useCallback((e: React.MouseEvent) => {\n    e.stopPropagation();\n\n    // 移动端不触发默认逻辑，只传递 action\n    // TODO 移动端 mention 占位符功能\n    if (!environment.IS_MOBILE) {\n      onClick();\n    }\n\n    return controller.run('onAction', activePlaceholder(node));\n  }, [controller, node, onClick]);\n\n  return (\n    <InlinePlaceholder\n      icon={<PlaceholderIcon>{PRE_FIX}</PlaceholderIcon>}\n      type=\"normal\"\n      isSelected={isSelected}\n      onClick={handleClick}\n      testid=\"mention-placeholder-normal\"\n    >\n      {mentionConfig.locale?.mentionPlaceholder}\n    </InlinePlaceholder>\n  )\n});\n\nexport default Placeholder;\n"],"file":"placeholder.js"}