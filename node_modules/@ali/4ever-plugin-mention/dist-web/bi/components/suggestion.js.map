{"version":3,"sources":["../../../../src/bi/components/suggestion.tsx"],"names":["React","FixedSizeList","List","AutoSizer","isNil","LoadingBetaNormal","isKeyHotkey","deactiveMention","insertMention","MentionSuggestionItem","LoadingWrapper","isUpHotKey","isDownHotKey","isLeftHotKey","isRightHotKey","isEnterHotKey","MentionSuggestion","props","controller","text","renderItem","renderHeader","searching","renderFooter","renderLoading","renderEmpty","offsetBottom","loadMoreSuggestions","suggestions","setSuggestions","delayedSearching","itemHeight","useState","selectedIndex","setSelectedIndex","listRef","useRef","lastItem","editorRef","isEmptyText","trim","length","isEmptySuggestions","handleSelect","useCallback","index","suggestion","current","run","handleScroll","scrollOffset","startOffset","height","itemData","useMemo","onSelect","onSelectedIndexChange","useEffect","handleMove","event","isComposing","preventDefault","stopPropagation","document","addEventListener","removeEventListener","handleKeyDown","key","toLowerCase","keyCode","scrollToItem","flex","width","memo"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { Controller } from '@ali/4ever-cangjie';\nimport { FixedSizeList as List, ListOnScrollProps } from 'react-window';\nimport AutoSizer from 'react-virtualized-auto-sizer';\nimport { isNil } from 'lodash-es';\nimport { LoadingBetaNormal } from '@ali/we-design';\nimport isKeyHotkey from 'is-hotkey';\nimport { deactiveMention, insertMention } from '../actions';\nimport MentionSuggestionItem, {\n  MentionSuggestionItemProps,\n} from './suggestionItem';\nimport { Suggestion, MentionPluginConfig } from '../types';\nimport { LoadingWrapper } from './styled';\n\n\nexport interface MentionSuggestionProps\n  extends Pick<MentionSuggestionItemProps['data'], 'renderItem'>,\n  // @ts-ignore\n  Omit<MentionPluginConfig<Suggestion>, 'locale' | 'getCurrentUser'> {\n  controller: Controller;\n  /** 当前的搜索字串 */\n  text: string;\n}\n\nconst isUpHotKey = isKeyHotkey('up');\nconst isDownHotKey = isKeyHotkey('down');\nconst isLeftHotKey = isKeyHotkey('left');\nconst isRightHotKey = isKeyHotkey('right');\nconst isEnterHotKey = isKeyHotkey('enter');\n\nconst MentionSuggestion: React.FC<MentionSuggestionProps> = (props) => {\n  const {\n    controller,\n    text,\n    renderItem,\n    renderHeader,\n    searching,\n    renderFooter,\n    renderLoading,\n    renderEmpty,\n    offsetBottom = 0,\n    loadMoreSuggestions,\n    suggestions,\n    setSuggestions,\n    delayedSearching,\n    itemHeight = 50,\n  } = props;\n\n\n  const [selectedIndex, setSelectedIndex] = React.useState<number>(0);\n\n\n  const listRef = React.useRef<List>(null);\n  const lastItem = React.useRef<number | null>(null);\n  const editorRef = React.useRef<Controller>(controller);\n\n  const isEmptyText = text.trim().length === 0;\n  const isEmptySuggestions = suggestions.length === 0;\n\n  const handleSelect = React.useCallback(\n    (index?: number) => {\n      const suggestion = suggestions[isNil(index) ? selectedIndex : index];\n      editorRef.current.run('onAction', insertMention(suggestion));\n    },\n    [suggestions, selectedIndex],\n  );\n\n  const handleScroll = React.useCallback(\n    ({ scrollOffset }: ListOnScrollProps) => {\n      if (!loadMoreSuggestions || !listRef.current) {\n        return;\n      }\n      /* 当倒数第 offsetBottom + 1 个元素进入可视区域时触发 loadMoreSuggestions */\n      const startOffset =\n        (suggestions.length - offsetBottom - 2) * itemHeight -\n        (listRef.current.props.height as number);\n\n      if (\n        startOffset > 0 &&\n        startOffset <= scrollOffset &&\n        lastItem.current !== suggestions.length\n      ) {\n        lastItem.current = suggestions.length;\n\n        loadMoreSuggestions(text, suggestions.length, setSuggestions);\n      }\n    },\n    [loadMoreSuggestions, suggestions.length, offsetBottom, itemHeight, text, setSuggestions],\n  );\n\n  const itemData = React.useMemo(\n    () => ({\n      suggestions,\n      onSelect: handleSelect,\n      renderItem,\n      selectedIndex,\n      onSelectedIndexChange: setSelectedIndex,\n    }),\n    [suggestions, renderItem, selectedIndex, handleSelect],\n  );\n\n  React.useEffect(() => {\n    editorRef.current = controller;\n  }, [controller]);\n\n  // listen up & down\n  React.useEffect(() => {\n    const handleMove = (event: KeyboardEvent) => {\n      if (event.isComposing || searching.current) {\n        return;\n      }\n      if (isRightHotKey(event) || isDownHotKey(event)) {\n        event.preventDefault();\n        setSelectedIndex((index) => (index + 1) % suggestions.length);\n      }\n      if (isLeftHotKey(event) || isUpHotKey(event)) {\n        event.preventDefault();\n        setSelectedIndex((index) => (index === 0 ? suggestions.length - 1 : index - 1));\n      }\n\n      if (isEnterHotKey(event)) {\n        event.preventDefault();\n        event.stopPropagation();\n        handleSelect();\n        editorRef.current.run('onAction', deactiveMention());\n      }\n    };\n\n    document.addEventListener('keyup', handleMove);\n\n    return () => {\n      document.removeEventListener('keyup', handleMove);\n    };\n  }, [searching, suggestions, selectedIndex]);\n\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (!event.key) {\n        return;\n      }\n      const key = event.key.toLowerCase();\n      if (event.isComposing || searching.current) {\n        return;\n      }\n      if (key === ' ' && event.keyCode === 32) {\n        if (!isEmptyText && !isEmptySuggestions) {\n          event.preventDefault();\n          event.stopPropagation();\n          handleSelect(0);\n        } else {\n          editorRef.current.run('onAction', deactiveMention());\n        }\n      }\n    };\n    document.addEventListener('keydown', handleKeyDown);\n    return () => {\n      document.removeEventListener('keydown', handleKeyDown);\n    };\n  }, [handleSelect, isEmptySuggestions, isEmptyText, searching]);\n\n\n  // scroll to selected index\n  React.useEffect(() => {\n    if (listRef.current) {\n      listRef.current!.scrollToItem(selectedIndex);\n    }\n  }, [selectedIndex]);\n\n  if (!delayedSearching && suggestions.length === 0 && renderEmpty) {\n    return renderEmpty();\n  }\n\n  return (\n    <>\n      {renderHeader && renderHeader()}\n      <div style={{ flex: 1 }}>\n        <AutoSizer>\n          {({ height, width }) => (delayedSearching ? (\n            <LoadingWrapper\n              data-testid=\"mention-suggestion-loading\"\n              height={height}\n              width={width}\n            >\n              {renderLoading ? renderLoading() : <LoadingBetaNormal />}\n            </LoadingWrapper>\n          ) : (\n            <>\n              <List\n                className=\"mention-suggestion-list\"\n                ref={listRef}\n                height={height}\n                itemCount={suggestions.length}\n                itemSize={itemHeight}\n                itemData={itemData}\n                width={width}\n                onScroll={handleScroll}\n              >\n                {MentionSuggestionItem}\n              </List>\n            </>\n          ))\n          }\n        </AutoSizer>\n      </div>\n      {renderFooter && renderFooter()}\n    </>\n  );\n};\n\nexport default React.memo(MentionSuggestion);\n"],"file":"suggestion.js"}