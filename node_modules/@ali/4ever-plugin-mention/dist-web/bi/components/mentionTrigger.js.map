{"version":3,"sources":["../../../../src/bi/components/mentionTrigger.tsx"],"names":["React","useState","useRef","useEffect","useCallback","styled","throttle","useScrollableContainer","ReactDOM","Toolbar","SuggestionsWrapper","MentionSuggestion","useDelayedState","deactiveMention","PanelBox","div","MentionSuggestionPortal","props","controller","searchSuggestions","loadMoreSuggestions","renderItem","renderHeader","renderFooter","renderLoading","renderEmpty","renderPanel","isComposing","text","popupOptions","theme","offsetBottom","itemHeight","alignment","offsets","suggestionOffset","scrollableContainer","panelVisible","setPanelVisible","suggestions","setSuggestions","searching","delayedSearching","setDelayedSearching","top","left","position","setPosition","portalRef","topOffset","leftOffset","current","console","warn","slice","updatePosition","flag","pos","query","portalDom","children","align","p","value","callback","event","target","HTMLElement","closest","run","window","document","addEventListener","removeEventListener","close","length","overlay","zIndex","createPortal","body"],"mappings":"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","sourcesContent":["import React, { useState, useRef, useEffect, useCallback } from 'react';\nimport styled from 'styled-components';\nimport { throttle } from 'lodash-es';\nimport { useScrollableContainer } from '@ali/4ever-cangjie';\nimport * as ReactDOM from 'react-dom';\nimport { Toolbar, SuggestionsWrapper } from './styled';\nimport MentionSuggestion, { MentionSuggestionProps } from './suggestion';\nimport { Suggestion } from '../types';\nimport { useDelayedState } from '@ali/4ever-component';\nimport { deactiveMention } from '../actions';\n\nconst PanelBox = styled.div``;\n\nconst MentionSuggestionPortal:\nReact.FunctionComponent<MentionSuggestionProps> = (\n  props,\n) => {\n  const {\n    controller,\n    searchSuggestions,\n    loadMoreSuggestions,\n    renderItem,\n    renderHeader,\n    renderFooter,\n    renderLoading,\n    renderEmpty,\n    renderPanel,\n    isComposing,\n    text,\n    popupOptions = {},\n    theme,\n  } = props;\n  const {\n    offsetBottom,\n    itemHeight,\n    alignment = 'follow',\n    offsets = [0, 0],\n  } = popupOptions;\n  const suggestionOffset = offsets;\n  const scrollableContainer = useScrollableContainer();\n  const [panelVisible, setPanelVisible] = useState(!isComposing);\n  const [suggestions, setSuggestions] = useState<Suggestion[]>([]);\n  const searching = useRef(false);\n  const [delayedSearching, setDelayedSearching] = useDelayedState(false);\n  const [position, setPosition] = useState<{\n    top: number;\n    left: number;\n  }\n  >({ top: 9999, left: 9999 });\n  const portalRef = React.useRef<HTMLDivElement>(null);\n  const left = useRef<number>(0);\n  const [topOffset, leftOffset] = suggestionOffset;\n\n  // reset loading when search done\n  useEffect(() => {\n    setDelayedSearching(false);\n    searching.current = false;\n  }, [setDelayedSearching, suggestions]);\n\n  // do search when text changed\n  useEffect(() => {\n    if (isComposing) {\n      return;\n    }\n    if (!searchSuggestions) {\n      // eslint-disable-next-line no-console\n      console.warn('Missing `searchSuggestions`');\n      return;\n    }\n    setDelayedSearching(true, 200);\n    searching.current = true;\n    searchSuggestions(text.slice(1), setSuggestions);\n  }, [isComposing, text, searchSuggestions, setDelayedSearching, setSuggestions]);\n\n  useEffect(() => {\n    if (suggestions || delayedSearching) {\n      setPanelVisible(true);\n    } else {\n      setPanelVisible(false);\n    }\n  }, [delayedSearching, setPanelVisible, suggestions]);\n\n  const updatePosition = useCallback(\n    throttle((flag?: Boolean | Event) => {\n      if (isComposing) {\n        return;\n      }\n\n      const pos = controller.query('getMentionPanelPosition', {\n        controller, scrollableContainer: scrollableContainer as HTMLElement, portalDom: portalRef.current!.children[0] as HTMLElement, align: alignment,\n      })!;\n      const p = {\n        left: typeof flag === 'boolean' ? pos.left : left.current,\n        top: pos.top,\n      };\n      setPosition(p);\n      left.current = p.left;\n    }), [controller.value, scrollableContainer],\n  );\n\n  useEffect(() => {\n    const callback = (event: MouseEvent) => {\n      if (\n        event.target instanceof HTMLElement &&\n        event.target.closest('.mention-suggestion-portal')\n      ) {\n        // click inside\n        return;\n      }\n      controller.run('onAction', deactiveMention());\n    };\n    window.document.addEventListener('mousedown', callback);\n    return () => {\n      window.document.removeEventListener('mousedown', callback);\n    };\n  }, [controller]);\n\n  const close = useCallback(() => {\n    return controller.run('onAction', deactiveMention());\n  }, [controller]);\n\n  useEffect(() => {\n    updatePosition(true);\n    scrollableContainer?.addEventListener('scroll', updatePosition);\n\n    return () => {\n      scrollableContainer?.removeEventListener('scroll', updatePosition);\n    };\n  }, [scrollableContainer]);\n\n  useEffect(() => {\n    if (text.length === 1) {\n      updatePosition(true);\n    }\n  }, [text, controller.value]);\n\n  const overlay = (\n    <Toolbar\n      active\n      style={{\n        left: position.left + leftOffset,\n        top: position.top + topOffset,\n        zIndex: 999,\n      }}\n    >\n      <SuggestionsWrapper theme={theme} className=\"mention-suggestion\" data-testid=\"mention-suggestion\">\n        {renderPanel ? renderPanel() : (\n          <MentionSuggestion\n            offsetBottom={offsetBottom}\n            loadMoreSuggestions={loadMoreSuggestions}\n            renderItem={renderItem}\n            renderHeader={renderHeader}\n            renderFooter={renderFooter}\n            delayedSearching={delayedSearching}\n            renderLoading={renderLoading}\n            renderEmpty={renderEmpty}\n            controller={controller}\n            suggestions={suggestions}\n            setSuggestions={setSuggestions}\n            searching={searching}\n            text={text.slice(1)}\n            theme={theme}\n            itemHeight={itemHeight}\n          />\n        )}\n      </SuggestionsWrapper>\n    </Toolbar>\n  );\n\n  return panelVisible ? ReactDOM.createPortal(\n    <PanelBox\n      className=\"mention-suggestion-portal\"\n      data-testid=\"mention-suggestion-portal\"\n      ref={portalRef}\n    >\n      {overlay}\n    </PanelBox>,\n    document.body,\n  ): null;\n};\n\nexport default MentionSuggestionPortal;\n"],"file":"mentionTrigger.js"}