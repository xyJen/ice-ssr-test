{"version":3,"sources":["../../../../src/bi/components/suggestionPortal.tsx"],"names":["React","useZoom","useZoomContainer","Portal","MentionAt","Toolbar","SuggestionsWrapper","MentionSuggestion","useDelayedState","removeMention","MentionSuggestionPortal","props","controller","children","attributes","searchSuggestions","loadMoreSuggestions","renderItem","renderHeader","renderFooter","renderLoading","renderEmpty","isComposing","text","popupOptions","theme","getSuggestionTarget","offsetBottom","itemHeight","alignment","mountOnBody","offsets","suggestionPosition","suggestionOffset","zoomContainer","document","body","scrollableContent","zoom","useState","panelVisible","setPanelVisible","suggestions","setSuggestions","searching","useRef","delayedSearching","setDelayedSearching","undefined","position","setPosition","portalRef","topOffset","leftOffset","useEffect","current","console","warn","slice","callback","event","target","HTMLElement","closest","command","window","addEventListener","removeEventListener","useLayoutEffect","cangjieRect","getBoundingClientRect","portalRect","pos","top","height","left","bottom","overlay"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { Mark, RenderMarkProps, useZoom, useZoomContainer } from '@ali/4ever-cangjie';\nimport { Portal } from '@ali/4ever-component';\nimport { MentionAt, Toolbar, SuggestionsWrapper } from './styled';\nimport MentionSuggestion, { MentionSuggestionProps } from './suggestion';\nimport { Suggestion } from '../types';\nimport { useDelayedState } from '@ali/4ever-component';\nimport removeMention from '../commands/removeMention';\n\ninterface MentionSuggestionPortalProps extends MentionSuggestionProps {\n  mark: Mark;\n  attributes: React.Attributes;\n  children: RenderMarkProps['children'];\n}\n\nconst MentionSuggestionPortal:\nReact.FunctionComponent<MentionSuggestionPortalProps> = (\n  props,\n) => {\n  const {\n    controller,\n    children,\n    attributes,\n    searchSuggestions,\n    loadMoreSuggestions,\n    renderItem,\n    renderHeader,\n    renderFooter,\n    renderLoading,\n    renderEmpty,\n    isComposing,\n    text,\n    popupOptions = {},\n    theme,\n    getSuggestionTarget,\n  } = props;\n  const {\n    offsetBottom,\n    itemHeight,\n    alignment = 'follow',\n    mountOnBody = false,\n    offsets = [0, 0],\n  } = popupOptions;\n  const suggestionPosition = alignment;\n  const suggestionOffset = offsets;\n  const zoomContainer = useZoomContainer() || document.body;\n  const scrollableContent = mountOnBody ? document.body : zoomContainer;\n  const zoom = useZoom();\n  const [panelVisible, setPanelVisible] = React.useState(!isComposing);\n  const [suggestions, setSuggestions] = React.useState<Suggestion[]>([]);\n  const searching = React.useRef(false);\n  const [delayedSearching, setDelayedSearching] = useDelayedState(false);\n  const [position, setPosition] = React.useState<\n  | {\n    top: number;\n    left: number;\n  }\n  | undefined\n  >(undefined);\n  const portalRef = React.useRef<HTMLDivElement>(null);\n  const [topOffset, leftOffset] = suggestionOffset;\n\n  // reset loading when search done\n  React.useEffect(() => {\n    setDelayedSearching(false);\n    searching.current = false;\n  }, [setDelayedSearching, suggestions]);\n\n  // do search when text changed\n  React.useEffect(() => {\n    if (isComposing) {\n      return;\n    }\n    if (!searchSuggestions) {\n      // eslint-disable-next-line no-console\n      console.warn('Missing `searchSuggestions`');\n      return;\n    }\n    setDelayedSearching(true);\n    searching.current = true;\n    searchSuggestions(text.slice(1), setSuggestions);\n  }, [isComposing, text, searchSuggestions, setDelayedSearching, setSuggestions]);\n\n  React.useEffect(() => {\n    if (suggestions || delayedSearching) {\n      setPanelVisible(true);\n    } else {\n      setPanelVisible(false);\n    }\n  }, [delayedSearching, setPanelVisible, suggestions]);\n\n  React.useEffect(() => {\n    const callback = (event: MouseEvent) => {\n      if (\n        event.target instanceof HTMLElement &&\n        event.target.closest('.mention-suggestion-list')\n      ) {\n        // click inside\n        return;\n      }\n      controller.command(removeMention);\n    };\n    window.document.addEventListener('mousedown', callback);\n    return () => {\n      window.document.removeEventListener('mousedown', callback);\n    };\n  }, [controller]);\n\n  React.useLayoutEffect(() => {\n    if (isComposing) {\n      return;\n    }\n\n    if (suggestionPosition !== 'follow') {\n      const target = getSuggestionTarget && getSuggestionTarget();\n      if (!target) {\n        return;\n      }\n      const { current } = portalRef;\n      if (!('getBoundingClientRect' in target) || !(current && 'getBoundingClientRect' in current)) {\n        return;\n      }\n\n      const cangjieRect = target.getBoundingClientRect();\n      const portalRect = current.getBoundingClientRect();\n\n      let pos: { top: number; left: number } | null = null;\n\n      if (suggestionPosition === 'top') {\n        pos = {\n          top: cangjieRect.top - portalRect.height,\n          left: cangjieRect.left,\n        };\n      } else if (suggestionPosition === 'bottom') {\n        pos = {\n          top: cangjieRect.bottom,\n          left: cangjieRect.left,\n        };\n      }\n\n      if (!pos) {\n        return;\n      }\n\n      setPosition({\n        top: pos.top + portalRect.height + topOffset,\n        left: pos.left + leftOffset,\n      });\n    }\n  }, [suggestionPosition, leftOffset, topOffset, isComposing, getSuggestionTarget]);\n\n  const overlay = (\n    <Toolbar active>\n      <SuggestionsWrapper data-testid=\"mention-suggestion\" theme={theme}>\n        <MentionSuggestion\n          offsetBottom={offsetBottom}\n          loadMoreSuggestions={loadMoreSuggestions}\n          renderItem={renderItem}\n          renderHeader={renderHeader}\n          renderFooter={renderFooter}\n          delayedSearching={delayedSearching}\n          renderLoading={renderLoading}\n          renderEmpty={renderEmpty}\n          controller={controller}\n          suggestions={suggestions}\n          setSuggestions={setSuggestions}\n          searching={searching}\n          text={text.slice(1)}\n          theme={theme}\n          itemHeight={itemHeight}\n        />\n      </SuggestionsWrapper>\n    </Toolbar>\n  );\n\n  return (\n    <Portal\n      portalRef={portalRef}\n      overlay={overlay}\n      visible={panelVisible}\n      container={scrollableContent}\n      position={position}\n      className=\"metion-suggestion-portal\"\n      zoom={zoom}\n    >\n      <MentionAt {...attributes} data-type=\"mention-at\" active>\n        {children()}\n      </MentionAt>\n    </Portal>\n  );\n};\n\nexport default MentionSuggestionPortal;\n"],"file":"suggestionPortal.js"}