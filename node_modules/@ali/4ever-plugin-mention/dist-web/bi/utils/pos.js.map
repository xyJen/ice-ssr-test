{"version":3,"sources":["../../../../src/bi/utils/pos.ts"],"names":["Point","domUtils","constants","getPos","controller","scrollableContainer","portalDom","align","value","selection","document","point","create","key","focus","offset","contentDOM","findDOMNodeSafely","closest","Selector","content","pos","findCaretPosition","window","containerRect","body","getBoundingClientRect","clientLeft","clientTop","height","clientHeight","clientWidth","isBottomLittleSpace","isLeftLittleSpace","width","left","scrollX","top","scrollY"],"mappings":"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","sourcesContent":["import { Point, Controller, domUtils, constants } from '@ali/4ever-cangjie';\n\nexport default function getPos(controller: Controller, scrollableContainer: HTMLElement, portalDom: HTMLElement, align: string = 'follow') {\n\n  const { selection, document } = controller.value;\n\n  const point = Point.create({\n    key: selection.focus.key,\n    // @ts-ignore\n    offset: selection.focus.offset - 1,\n  });\n\n  const contentDOM = domUtils.findDOMNodeSafely(document.key)?.closest(`[${constants.Selector.content}]`);\n\n  const pos = domUtils.findCaretPosition(point, 'start', contentDOM || window);\n  if (pos && scrollableContainer && portalDom) {\n    // @ts-ignore\n    const containerRect = (scrollableContainer.window === scrollableContainer ? window.document.body : scrollableContainer).getBoundingClientRect();\n    const { clientLeft, clientTop, height } = pos;\n    const { clientHeight, clientWidth } = portalDom;\n\n    const isBottomLittleSpace =\n      clientTop > clientHeight\n      && containerRect.height - (clientTop + height) < clientHeight;\n    const isLeftLittleSpace =\n      clientLeft > clientWidth\n      && containerRect.width - clientLeft < clientWidth;\n\n    const left = isLeftLittleSpace ? clientLeft + window.scrollX - clientWidth : clientLeft + window.scrollX;\n    const top = isBottomLittleSpace ? clientTop + window.scrollY - clientHeight - 2 : pos.clientTop + height + 2 + window.scrollY;\n\n    if (align === 'bottom') {\n      return { left, top: pos.clientTop + height + 2 + window.scrollY };\n    }\n    if (align === 'top') {\n      return { left, top: clientTop + window.scrollY - clientHeight };\n    }\n    return ({ left, top });\n  }\n\n  return { left: 9999, top: 9999 };\n}\n"],"file":"pos.js"}