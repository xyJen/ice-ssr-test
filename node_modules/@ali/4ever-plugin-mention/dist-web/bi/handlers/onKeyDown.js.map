{"version":3,"sources":["../../../../src/bi/handlers/onKeyDown.ts"],"names":["hotkeys","Commands","isKeyHotkey","isSelectionInMentionSuggestion","removeMention","getMentionAtFocusEdge","isEnterHotkey","isBackspaceHotkey","isEscHotkey","isArrowRightHotKey","isArrowLeftHotKey","isMoveHotKey","event","map","key","some","isEvent","isSelectKeyDown","onKeyDown","controller","next","value","selection","document","anchor","anchorText","getNode","anchorOffset","offset","prevText","text","charAt","isCollapsed","tagElement","isDeleteBackward","isDeleteForward","preventDefault","command","moveAnchorToStartOfNode","moveFocusToEndOfNode","stopPropagation"],"mappings":"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","sourcesContent":["import { Controller, hotkeys, Commands, TextPoint } from '@ali/4ever-cangjie';\nimport { isKeyHotkey } from 'is-hotkey';\nimport { isSelectionInMentionSuggestion } from '../utils';\nimport removeMention from '../commands/removeMention';\nimport getMentionAtFocusEdge from '../queries/getMentionAtFocusEdge';\n\nconst isEnterHotkey = isKeyHotkey('enter');\nconst isBackspaceHotkey = isKeyHotkey('backspace');\nconst isEscHotkey = isKeyHotkey('esc');\nconst isArrowRightHotKey = isKeyHotkey('right');\nconst isArrowLeftHotKey = isKeyHotkey('left');\n\n\nconst isMoveHotKey = (event: React.KeyboardEvent) => ['up', 'down', 'left', 'right']\n  .map((key) => isKeyHotkey(key))\n  .some((isEvent) => isEvent(event));\n\nconst isSelectKeyDown = (event: React.KeyboardEvent) => ['del', 'backspace', 'left', 'right']\n  .map((key) => isKeyHotkey(key))\n  .some((isEvent) => isEvent(event));\n\nexport default function onKeyDown(\n  event: React.KeyboardEvent,\n  controller: Controller,\n  next: () => void,\n) {\n  const { value } = controller;\n  const { selection, document } = value;\n  if (!selection) {\n    return next();\n  }\n  const { anchor } = selection;\n  const anchorText = document.getNode(anchor.key);\n  const anchorOffset = (selection.anchor as TextPoint).offset;\n  const prevText =\n    anchorText && anchorText.text\n      ? anchorText.text.charAt(anchorOffset - 1)\n      : '';\n\n  if (selection && selection.isCollapsed && isSelectKeyDown(event)) {\n    let tagElement;\n    if (hotkeys.isDeleteBackward(event) || hotkeys.isDeleteForward(event)) {\n      tagElement = getMentionAtFocusEdge(controller, hotkeys.isDeleteBackward(event) ? 'backward' : 'forward');\n    } else if (isArrowLeftHotKey(event)) {\n      tagElement = getMentionAtFocusEdge(controller, 'backward');\n    } else if (isArrowRightHotKey(event)) {\n      tagElement = getMentionAtFocusEdge(controller, 'forward');\n    }\n    if (tagElement) {\n      event.preventDefault();\n      return controller.command(Commands.moveAnchorToStartOfNode, tagElement).command(Commands.moveFocusToEndOfNode, tagElement);\n    }\n  }\n\n  if (isSelectionInMentionSuggestion(value) && isEscHotkey(event)) {\n    return controller.command(removeMention);\n  }\n\n  if (\n    isSelectionInMentionSuggestion(value) &&\n    (isEnterHotkey(event) || isMoveHotKey(event))\n  ) {\n    event.preventDefault();\n    event.stopPropagation();\n    return controller;\n  }\n\n  if (\n    isSelectionInMentionSuggestion(value) &&\n    isBackspaceHotkey(event) &&\n    prevText === '@'\n  ) {\n    controller.command(removeMention);\n  }\n  return next();\n}\n"],"file":"onKeyDown.js"}