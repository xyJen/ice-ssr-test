{"version":3,"sources":["../../../../src/bi/handlers/onKeyDown.ts"],"names":["isEnterHotkey","isBackspaceHotkey","isEscHotkey","isArrowRightHotKey","isArrowLeftHotKey","isMoveHotKey","event","map","key","some","isEvent","isSelectKeyDown","onKeyDown","controller","next","value","selection","document","anchor","anchorText","getNode","anchorOffset","offset","prevText","text","charAt","isCollapsed","tagElement","hotkeys","isDeleteBackward","isDeleteForward","preventDefault","command","Commands","moveAnchorToStartOfNode","moveFocusToEndOfNode","removeMention","stopPropagation"],"mappings":"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","sourcesContent":["import { Controller, hotkeys, Commands, TextPoint } from '@ali/4ever-cangjie';\nimport { isKeyHotkey } from 'is-hotkey';\nimport { isSelectionInMentionSuggestion } from '../utils';\nimport removeMention from '../commands/removeMention';\nimport getMentionAtFocusEdge from '../queries/getMentionAtFocusEdge';\n\nconst isEnterHotkey = isKeyHotkey('enter');\nconst isBackspaceHotkey = isKeyHotkey('backspace');\nconst isEscHotkey = isKeyHotkey('esc');\nconst isArrowRightHotKey = isKeyHotkey('right');\nconst isArrowLeftHotKey = isKeyHotkey('left');\n\n\nconst isMoveHotKey = (event: React.KeyboardEvent) => ['up', 'down', 'left', 'right']\n  .map((key) => isKeyHotkey(key))\n  .some((isEvent) => isEvent(event));\n\nconst isSelectKeyDown = (event: React.KeyboardEvent) => ['del', 'backspace', 'left', 'right']\n  .map((key) => isKeyHotkey(key))\n  .some((isEvent) => isEvent(event));\n\nexport default function onKeyDown(\n  event: React.KeyboardEvent,\n  controller: Controller,\n  next: () => void,\n) {\n  const { value } = controller;\n  const { selection, document } = value;\n  if (!selection) {\n    return next();\n  }\n  const { anchor } = selection;\n  const anchorText = document.getNode(anchor.key);\n  const anchorOffset = (selection.anchor as TextPoint).offset;\n  const prevText =\n    anchorText && anchorText.text\n      ? anchorText.text.charAt(anchorOffset - 1)\n      : '';\n\n  if (selection && selection.isCollapsed && isSelectKeyDown(event)) {\n    let tagElement;\n    if (hotkeys.isDeleteBackward(event) || hotkeys.isDeleteForward(event)) {\n      tagElement = getMentionAtFocusEdge(controller, hotkeys.isDeleteBackward(event) ? 'backward' : 'forward');\n    } else if (isArrowLeftHotKey(event)) {\n      tagElement = getMentionAtFocusEdge(controller, 'backward');\n    } else if (isArrowRightHotKey(event)) {\n      tagElement = getMentionAtFocusEdge(controller, 'forward');\n    }\n    if (tagElement) {\n      event.preventDefault();\n      return controller.command(Commands.moveAnchorToStartOfNode, tagElement).command(Commands.moveFocusToEndOfNode, tagElement);\n    }\n  }\n\n  if (isSelectionInMentionSuggestion(value) && isEscHotkey(event)) {\n    return controller.command(removeMention);\n  }\n\n  if (\n    isSelectionInMentionSuggestion(value) &&\n    (isEnterHotkey(event) || isMoveHotKey(event))\n  ) {\n    event.preventDefault();\n    event.stopPropagation();\n    return controller;\n  }\n\n  if (\n    isSelectionInMentionSuggestion(value) &&\n    isBackspaceHotkey(event) &&\n    prevText === '@'\n  ) {\n    controller.command(removeMention);\n  }\n  return next();\n}\n"],"file":"onKeyDown.js"}