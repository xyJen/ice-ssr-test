{"version":3,"sources":["../../../../src/bi/components/suggestionForQuickInsert.tsx"],"names":["isUpHotKey","isDownHotKey","isLeftHotKey","isRightHotKey","MentionSuggestion","props","controller","text","searchSuggestions","renderItem","renderHeader","renderFooter","renderLoading","renderEmpty","offsetBottom","loadMoreSuggestions","itemHeight","at","suggestions","setSuggestions","React","useState","errData","setErrData","selectedIndex","setSelectedIndex","searching","useRef","delayedSearching","setDelayedSearching","listRef","lastItem","editorRef","isEmptyText","trim","length","isEmptySuggestions","handleSelect","useCallback","index","suggestion","current","run","handleScroll","scrollOffset","startOffset","height","itemData","useMemo","onSelect","onSelectedIndexChange","useEffect","handleMove","event","isComposing","preventDefault","document","addEventListener","removeEventListener","handleKeyDown","key","toLowerCase","stopPropagation","keyCode","value","console","warn","scrollToItem","flex","width","isServiceError","border","serviceErrorMsg","MentionSuggestionItem","memo"],"mappings":"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","sourcesContent":["import React, { useMemo } from 'react';\nimport { Controller } from '@ali/4ever-cangjie';\nimport { FixedSizeList as List, ListOnScrollProps } from 'react-window';\nimport AutoSizer from 'react-virtualized-auto-sizer';\nimport { isNil } from 'lodash-es';\nimport { LoadingBetaNormal, SpinErrorCard } from '@ali/we-design';\nimport isKeyHotkey from 'is-hotkey';\nimport { deactiveMention, insertMention } from '../actions';\nimport MentionSuggestionItem, {\n  MentionSuggestionItemProps,\n} from './suggestionItem';\nimport type { Suggestion, MentionPluginConfig, ISearchSuggestionErrData } from '../types';\nimport { SuggestionsWrapper, LoadingWrapper } from './styled';\nimport { useDelayedState } from '@ali/4ever-component';\n\nexport interface MentionSuggestionProps\n  extends Pick<MentionSuggestionItemProps['data'], 'renderItem'>,\n  // @ts-ignore\n  Omit<MentionPluginConfig<Suggestion>, 'locale' | 'getCurrentUser'> {\n  controller: Controller;\n  /** 当前的搜索字串 */\n  text: string;\n}\n\nconst isUpHotKey = isKeyHotkey('up');\nconst isDownHotKey = isKeyHotkey('down');\nconst isLeftHotKey = isKeyHotkey('left');\nconst isRightHotKey = isKeyHotkey('right');\n\nconst MentionSuggestion: React.FC<MentionSuggestionProps> = (props) => {\n  const {\n    controller,\n    text,\n    searchSuggestions,\n    renderItem,\n    renderHeader,\n    renderFooter,\n    renderLoading,\n    renderEmpty,\n    offsetBottom = 0,\n    loadMoreSuggestions,\n    itemHeight = 50,\n    at,\n  } = props;\n\n  const [suggestions, setSuggestions] = React.useState<Suggestion[]>([]);\n  const [errData, setErrData] = React.useState<ISearchSuggestionErrData>({});\n  const [selectedIndex, setSelectedIndex] = React.useState<number>(0);\n  const searching = React.useRef(false);\n  const [delayedSearching, setDelayedSearching] = useDelayedState(false);\n\n  const listRef = React.useRef<List>(null);\n  const lastItem = React.useRef<number | null>(null);\n  const editorRef = React.useRef<Controller>(controller);\n\n  const isEmptyText = text.trim().length === 0;\n  const isEmptySuggestions = suggestions.length === 0;\n\n  const handleSelect = React.useCallback(\n    (index?: number) => {\n      const suggestion = suggestions[isNil(index) ? selectedIndex : index];\n      editorRef.current.run('onAction', insertMention(suggestion, at));\n    },\n    [suggestions, selectedIndex],\n  );\n\n  const handleScroll = React.useCallback(\n    ({ scrollOffset }: ListOnScrollProps) => {\n      if (!loadMoreSuggestions || !listRef.current) {\n        return;\n      }\n      /* 当倒数第 offsetBottom + 1 个元素进入可视区域时触发 loadMoreSuggestions */\n      const startOffset =\n        (suggestions.length - offsetBottom - 2) * itemHeight -\n        (listRef.current.props.height as number);\n\n      if (\n        startOffset > 0 &&\n        startOffset <= scrollOffset &&\n        lastItem.current !== suggestions.length\n      ) {\n        lastItem.current = suggestions.length;\n\n        loadMoreSuggestions(text, suggestions.length, setSuggestions, setErrData);\n      }\n    },\n    [loadMoreSuggestions, suggestions.length, offsetBottom, itemHeight, text],\n  );\n\n  const itemData = React.useMemo(\n    () => ({\n      suggestions,\n      onSelect: handleSelect,\n      renderItem,\n      selectedIndex,\n      onSelectedIndexChange: setSelectedIndex,\n    }),\n    [suggestions, renderItem, selectedIndex, handleSelect],\n  );\n\n  React.useEffect(() => {\n    editorRef.current = controller;\n  }, [controller]);\n\n  // listen up & down\n  React.useEffect(() => {\n    const handleMove = (event: KeyboardEvent) => {\n      if (event.isComposing || searching.current) {\n        return;\n      }\n      if (isRightHotKey(event) || isDownHotKey(event)) {\n        event.preventDefault();\n        setSelectedIndex((index) => (index + 1) % suggestions.length);\n      }\n      if (isLeftHotKey(event) || isUpHotKey(event)) {\n        event.preventDefault();\n        setSelectedIndex((index) => (index === 0 ? suggestions.length - 1 : index - 1));\n      }\n    };\n\n    document.addEventListener('keydown', handleMove);\n\n    return () => {\n      document.removeEventListener('keydown', handleMove);\n    };\n  }, [suggestions]);\n\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (!event.key) {\n        return;\n      }\n      const key = event.key.toLowerCase();\n      if (event.isComposing || searching.current) {\n        return;\n      }\n      if (key === 'enter') {\n        event.preventDefault();\n        event.stopPropagation();\n        if (delayedSearching) {\n          return;\n        }\n        handleSelect();\n        return editorRef.current.run('onAction', deactiveMention());\n      }\n      if (key === ' ' && event.keyCode === 32) {\n        if (!isEmptyText && !isEmptySuggestions) {\n          event.preventDefault();\n          event.stopPropagation();\n          handleSelect(0);\n        } else {\n          return editorRef.current.run('onAction', deactiveMention());\n        }\n      }\n    };\n    document.addEventListener('keydown', handleKeyDown);\n    return () => {\n      document.removeEventListener('keydown', handleKeyDown);\n    };\n  }, [handleSelect, isEmptySuggestions, isEmptyText, delayedSearching]);\n\n  // reset loading when search done\n  React.useEffect(() => {\n    setDelayedSearching(false);\n    searching.current = false;\n  }, [setDelayedSearching, suggestions]);\n\n  // do search when text changed\n  React.useEffect(() => {\n    // @ts-ignore value 没有 isComposing 属性\n    if (editorRef.current.value.isComposing) {\n      return;\n    }\n    if (!searchSuggestions) {\n      // eslint-disable-next-line no-console\n      console.warn('Missing `searchSuggestions`');\n      return;\n    }\n    setDelayedSearching(true, 200);\n    searching.current = true;\n    searchSuggestions(text, setSuggestions, setErrData);\n  }, [text, searchSuggestions, setDelayedSearching]);\n\n  // scroll to selected index\n  React.useEffect(() => {\n    if (listRef.current) {\n      listRef.current!.scrollToItem(selectedIndex);\n    }\n  }, [selectedIndex]);\n\n  return (\n    <SuggestionsWrapper>\n      {renderHeader && renderHeader()}\n      <div style={{ flex: 1 }}>\n        <AutoSizer>\n          {({ height, width }) => (delayedSearching ? (\n            <LoadingWrapper\n              data-testid=\"mention-suggestion-loading\"\n              height={height}\n              width={width}\n            >\n              {renderLoading ? renderLoading() : <LoadingBetaNormal />}\n            </LoadingWrapper>\n          ) : (\n            <>\n              {\n                errData.isServiceError ?\n                  <SpinErrorCard\n                    style={{ width: `${width}px`, height: `${height}px`, border: 'none', }}\n                    tip={errData.serviceErrorMsg}\n                  />\n                  : suggestions.length === 0 && renderEmpty && renderEmpty()\n              }\n              {\n                suggestions.length > 0 &&\n                (\n                  <List\n                    className=\"mention-suggestion-list\"\n                    ref={listRef}\n                    height={height}\n                    itemCount={suggestions.length}\n                    itemSize={itemHeight}\n                    itemData={itemData}\n                    width={width}\n                    onScroll={handleScroll}\n                  >\n                    {MentionSuggestionItem}\n                  </List>\n                )\n              }\n            </>\n          ))\n          }\n        </AutoSizer>\n      </div>\n      {renderFooter && renderFooter()}\n    </SuggestionsWrapper>\n  );\n};\n\nexport default React.memo(MentionSuggestion);\n"],"file":"suggestionForQuickInsert.js"}