{"version":3,"sources":["../../../../src/bi/components/suggestionPortal.tsx"],"names":["MentionSuggestionPortal","props","controller","children","attributes","searchSuggestions","loadMoreSuggestions","renderItem","renderHeader","renderFooter","renderLoading","renderEmpty","isComposing","text","popupOptions","theme","getSuggestionTarget","offsetBottom","itemHeight","alignment","mountOnBody","offsets","suggestionPosition","suggestionOffset","zoomContainer","document","body","scrollableContent","zoom","panelVisible","setPanelVisible","React","useState","suggestions","setSuggestions","searching","useRef","delayedSearching","setDelayedSearching","position","setPosition","undefined","portalRef","topOffset","leftOffset","useEffect","current","console","warn","slice","callback","event","target","HTMLElement","closest","command","removeMention","window","addEventListener","removeEventListener","useLayoutEffect","cangjieRect","getBoundingClientRect","portalRect","pos","top","height","left","bottom","overlay"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { Mark, RenderMarkProps, useZoom, useZoomContainer } from '@ali/4ever-cangjie';\nimport { Portal } from '@ali/4ever-component';\nimport { MentionAt, Toolbar, SuggestionsWrapper } from './styled';\nimport MentionSuggestion, { MentionSuggestionProps } from './suggestion';\nimport { Suggestion } from '../types';\nimport { useDelayedState } from '@ali/4ever-component';\nimport removeMention from '../commands/removeMention';\n\ninterface MentionSuggestionPortalProps extends MentionSuggestionProps {\n  mark: Mark;\n  attributes: React.Attributes;\n  children: RenderMarkProps['children'];\n}\n\nconst MentionSuggestionPortal:\nReact.FunctionComponent<MentionSuggestionPortalProps> = (\n  props,\n) => {\n  const {\n    controller,\n    children,\n    attributes,\n    searchSuggestions,\n    loadMoreSuggestions,\n    renderItem,\n    renderHeader,\n    renderFooter,\n    renderLoading,\n    renderEmpty,\n    isComposing,\n    text,\n    popupOptions = {},\n    theme,\n    getSuggestionTarget,\n  } = props;\n  const {\n    offsetBottom,\n    itemHeight,\n    alignment = 'follow',\n    mountOnBody = false,\n    offsets = [0, 0],\n  } = popupOptions;\n  const suggestionPosition = alignment;\n  const suggestionOffset = offsets;\n  const zoomContainer = useZoomContainer() || document.body;\n  const scrollableContent = mountOnBody ? document.body : zoomContainer;\n  const zoom = useZoom();\n  const [panelVisible, setPanelVisible] = React.useState(!isComposing);\n  const [suggestions, setSuggestions] = React.useState<Suggestion[]>([]);\n  const searching = React.useRef(false);\n  const [delayedSearching, setDelayedSearching] = useDelayedState(false);\n  const [position, setPosition] = React.useState<\n  | {\n    top: number;\n    left: number;\n  }\n  | undefined\n  >(undefined);\n  const portalRef = React.useRef<HTMLDivElement>(null);\n  const [topOffset, leftOffset] = suggestionOffset;\n\n  // reset loading when search done\n  React.useEffect(() => {\n    setDelayedSearching(false);\n    searching.current = false;\n  }, [setDelayedSearching, suggestions]);\n\n  // do search when text changed\n  React.useEffect(() => {\n    if (isComposing) {\n      return;\n    }\n    if (!searchSuggestions) {\n      // eslint-disable-next-line no-console\n      console.warn('Missing `searchSuggestions`');\n      return;\n    }\n    setDelayedSearching(true);\n    searching.current = true;\n    searchSuggestions(text.slice(1), setSuggestions);\n  }, [isComposing, text, searchSuggestions, setDelayedSearching, setSuggestions]);\n\n  React.useEffect(() => {\n    if (suggestions || delayedSearching) {\n      setPanelVisible(true);\n    } else {\n      setPanelVisible(false);\n    }\n  }, [delayedSearching, setPanelVisible, suggestions]);\n\n  React.useEffect(() => {\n    const callback = (event: MouseEvent) => {\n      if (\n        event.target instanceof HTMLElement &&\n        event.target.closest('.mention-suggestion-list')\n      ) {\n        // click inside\n        return;\n      }\n      controller.command(removeMention);\n    };\n    window.document.addEventListener('mousedown', callback);\n    return () => {\n      window.document.removeEventListener('mousedown', callback);\n    };\n  }, [controller]);\n\n  React.useLayoutEffect(() => {\n    if (isComposing) {\n      return;\n    }\n\n    if (suggestionPosition !== 'follow') {\n      const target = getSuggestionTarget && getSuggestionTarget();\n      if (!target) {\n        return;\n      }\n      const { current } = portalRef;\n      if (!('getBoundingClientRect' in target) || !(current && 'getBoundingClientRect' in current)) {\n        return;\n      }\n\n      const cangjieRect = target.getBoundingClientRect();\n      const portalRect = current.getBoundingClientRect();\n\n      let pos: { top: number; left: number } | null = null;\n\n      if (suggestionPosition === 'top') {\n        pos = {\n          top: cangjieRect.top - portalRect.height,\n          left: cangjieRect.left,\n        };\n      } else if (suggestionPosition === 'bottom') {\n        pos = {\n          top: cangjieRect.bottom,\n          left: cangjieRect.left,\n        };\n      }\n\n      if (!pos) {\n        return;\n      }\n\n      setPosition({\n        top: pos.top + portalRect.height + topOffset,\n        left: pos.left + leftOffset,\n      });\n    }\n  }, [suggestionPosition, leftOffset, topOffset, isComposing, getSuggestionTarget]);\n\n  const overlay = (\n    <Toolbar active>\n      <SuggestionsWrapper data-testid=\"mention-suggestion\" theme={theme}>\n        <MentionSuggestion\n          offsetBottom={offsetBottom}\n          loadMoreSuggestions={loadMoreSuggestions}\n          renderItem={renderItem}\n          renderHeader={renderHeader}\n          renderFooter={renderFooter}\n          delayedSearching={delayedSearching}\n          renderLoading={renderLoading}\n          renderEmpty={renderEmpty}\n          controller={controller}\n          suggestions={suggestions}\n          setSuggestions={setSuggestions}\n          searching={searching}\n          text={text.slice(1)}\n          theme={theme}\n          itemHeight={itemHeight}\n        />\n      </SuggestionsWrapper>\n    </Toolbar>\n  );\n\n  return (\n    <Portal\n      portalRef={portalRef}\n      overlay={overlay}\n      visible={panelVisible}\n      container={scrollableContent}\n      position={position}\n      className=\"metion-suggestion-portal\"\n      zoom={zoom}\n    >\n      <MentionAt {...attributes} data-type=\"mention-at\" active>\n        {children()}\n      </MentionAt>\n    </Portal>\n  );\n};\n\nexport default MentionSuggestionPortal;\n"],"file":"suggestionPortal.js"}