{"version":3,"sources":["../../../../src/bi/components/suggestion.tsx"],"names":["isUpHotKey","isDownHotKey","isLeftHotKey","isRightHotKey","isEnterHotKey","MentionSuggestion","props","controller","text","renderItem","renderHeader","searching","renderFooter","renderLoading","renderEmpty","offsetBottom","loadMoreSuggestions","suggestions","setSuggestions","delayedSearching","itemHeight","selectedIndex","setSelectedIndex","React","useState","listRef","useRef","lastItem","editorRef","isEmptyText","trim","length","isEmptySuggestions","handleSelect","useCallback","index","suggestion","current","run","handleScroll","scrollOffset","startOffset","height","itemData","useMemo","onSelect","onSelectedIndexChange","useEffect","handleMove","event","isComposing","preventDefault","stopPropagation","document","addEventListener","removeEventListener","handleKeyDown","key","toLowerCase","keyCode","scrollToItem","flex","width","MentionSuggestionItem","memo"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { Controller } from '@ali/4ever-cangjie';\nimport { FixedSizeList as List, ListOnScrollProps } from 'react-window';\nimport AutoSizer from 'react-virtualized-auto-sizer';\nimport { isNil } from 'lodash-es';\nimport { LoadingBetaNormal } from '@ali/we-design';\nimport isKeyHotkey from 'is-hotkey';\nimport { deactiveMention, insertMention } from '../actions';\nimport MentionSuggestionItem, {\n  MentionSuggestionItemProps,\n} from './suggestionItem';\nimport { Suggestion, MentionPluginConfig } from '../types';\nimport { LoadingWrapper } from './styled';\n\n\nexport interface MentionSuggestionProps\n  extends Pick<MentionSuggestionItemProps['data'], 'renderItem'>,\n  // @ts-ignore\n  Omit<MentionPluginConfig<Suggestion>, 'locale' | 'getCurrentUser'> {\n  controller: Controller;\n  /** 当前的搜索字串 */\n  text: string;\n}\n\nconst isUpHotKey = isKeyHotkey('up');\nconst isDownHotKey = isKeyHotkey('down');\nconst isLeftHotKey = isKeyHotkey('left');\nconst isRightHotKey = isKeyHotkey('right');\nconst isEnterHotKey = isKeyHotkey('enter');\n\nconst MentionSuggestion: React.FC<MentionSuggestionProps> = (props) => {\n  const {\n    controller,\n    text,\n    renderItem,\n    renderHeader,\n    searching,\n    renderFooter,\n    renderLoading,\n    renderEmpty,\n    offsetBottom = 0,\n    loadMoreSuggestions,\n    suggestions,\n    setSuggestions,\n    delayedSearching,\n    itemHeight = 50,\n  } = props;\n\n\n  const [selectedIndex, setSelectedIndex] = React.useState<number>(0);\n\n\n  const listRef = React.useRef<List>(null);\n  const lastItem = React.useRef<number | null>(null);\n  const editorRef = React.useRef<Controller>(controller);\n\n  const isEmptyText = text.trim().length === 0;\n  const isEmptySuggestions = suggestions.length === 0;\n\n  const handleSelect = React.useCallback(\n    (index?: number) => {\n      const suggestion = suggestions[isNil(index) ? selectedIndex : index];\n      editorRef.current.run('onAction', insertMention(suggestion));\n    },\n    [suggestions, selectedIndex],\n  );\n\n  const handleScroll = React.useCallback(\n    ({ scrollOffset }: ListOnScrollProps) => {\n      if (!loadMoreSuggestions || !listRef.current) {\n        return;\n      }\n      /* 当倒数第 offsetBottom + 1 个元素进入可视区域时触发 loadMoreSuggestions */\n      const startOffset =\n        (suggestions.length - offsetBottom - 2) * itemHeight -\n        (listRef.current.props.height as number);\n\n      if (\n        startOffset > 0 &&\n        startOffset <= scrollOffset &&\n        lastItem.current !== suggestions.length\n      ) {\n        lastItem.current = suggestions.length;\n\n        loadMoreSuggestions(text, suggestions.length, setSuggestions);\n      }\n    },\n    [loadMoreSuggestions, suggestions.length, offsetBottom, itemHeight, text, setSuggestions],\n  );\n\n  const itemData = React.useMemo(\n    () => ({\n      suggestions,\n      onSelect: handleSelect,\n      renderItem,\n      selectedIndex,\n      onSelectedIndexChange: setSelectedIndex,\n    }),\n    [suggestions, renderItem, selectedIndex, handleSelect],\n  );\n\n  React.useEffect(() => {\n    editorRef.current = controller;\n  }, [controller]);\n\n  // listen up & down\n  React.useEffect(() => {\n    const handleMove = (event: KeyboardEvent) => {\n      if (event.isComposing || searching.current) {\n        return;\n      }\n      if (isRightHotKey(event) || isDownHotKey(event)) {\n        event.preventDefault();\n        setSelectedIndex((index) => (index + 1) % suggestions.length);\n      }\n      if (isLeftHotKey(event) || isUpHotKey(event)) {\n        event.preventDefault();\n        setSelectedIndex((index) => (index === 0 ? suggestions.length - 1 : index - 1));\n      }\n\n      if (isEnterHotKey(event)) {\n        event.preventDefault();\n        event.stopPropagation();\n        handleSelect();\n        editorRef.current.run('onAction', deactiveMention());\n      }\n    };\n\n    document.addEventListener('keyup', handleMove);\n\n    return () => {\n      document.removeEventListener('keyup', handleMove);\n    };\n  }, [searching, suggestions, selectedIndex]);\n\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (!event.key) {\n        return;\n      }\n      const key = event.key.toLowerCase();\n      if (event.isComposing || searching.current) {\n        return;\n      }\n      if (key === ' ' && event.keyCode === 32) {\n        if (!isEmptyText && !isEmptySuggestions) {\n          event.preventDefault();\n          event.stopPropagation();\n          handleSelect(0);\n        } else {\n          editorRef.current.run('onAction', deactiveMention());\n        }\n      }\n    };\n    document.addEventListener('keydown', handleKeyDown);\n    return () => {\n      document.removeEventListener('keydown', handleKeyDown);\n    };\n  }, [handleSelect, isEmptySuggestions, isEmptyText, searching]);\n\n\n  // scroll to selected index\n  React.useEffect(() => {\n    if (listRef.current) {\n      listRef.current!.scrollToItem(selectedIndex);\n    }\n  }, [selectedIndex]);\n\n  if (!delayedSearching && suggestions.length === 0 && renderEmpty) {\n    return renderEmpty();\n  }\n\n  return (\n    <>\n      {renderHeader && renderHeader()}\n      <div style={{ flex: 1 }}>\n        <AutoSizer>\n          {({ height, width }) => (delayedSearching ? (\n            <LoadingWrapper\n              data-testid=\"mention-suggestion-loading\"\n              height={height}\n              width={width}\n            >\n              {renderLoading ? renderLoading() : <LoadingBetaNormal />}\n            </LoadingWrapper>\n          ) : (\n            <>\n              <List\n                className=\"mention-suggestion-list\"\n                ref={listRef}\n                height={height}\n                itemCount={suggestions.length}\n                itemSize={itemHeight}\n                itemData={itemData}\n                width={width}\n                onScroll={handleScroll}\n              >\n                {MentionSuggestionItem}\n              </List>\n            </>\n          ))\n          }\n        </AutoSizer>\n      </div>\n      {renderFooter && renderFooter()}\n    </>\n  );\n};\n\nexport default React.memo(MentionSuggestion);\n"],"file":"suggestion.js"}