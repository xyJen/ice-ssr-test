{"version":3,"sources":["../../../../src/bi/components/Menu.tsx"],"names":["React","isKeyHotkey","List","styled","ListWrapper","div","isUpHotKey","isDownHotKey","isEnterHotKey","SnippetsMenu","props","items","controller","onItemSelected","onEnterDirectly","useState","selectedIndex","setSelectedIndex","listRef","useRef","itemsMap","useMemo","reduce","record","current","index","key","item","handleActiveChange","useCallback","_opt","undefined","handleSelected","handleKeyDown","event","value","composing","length","preventDefault","children","scrollIntoViewIfNeeded","useEffect","document","addEventListener","removeEventListener"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { isKeyHotkey } from 'is-hotkey';\nimport { List } from '@ali/we-design-next';\nimport { Controller, SnippetItemBase } from '@ali/4ever-cangjie';\nimport styled from 'styled-components';\n\nconst ListWrapper = styled.div`\n  max-height: 280px;\n  overflow-y: scroll;\n`;\n\ninterface SnippetsMenuProps<T extends SnippetItemBase = SnippetItemBase> {\n  items: T[];\n  controller: Controller;\n  onItemSelected: (item?: T) => void;\n  /**\n   * 未选中任何选项时按 enter 的行为\n   */\n  onEnterDirectly: (event: KeyboardEvent) => void;\n}\n\nconst isUpHotKey = isKeyHotkey('up');\nconst isDownHotKey = isKeyHotkey('down');\nconst isEnterHotKey = isKeyHotkey('enter');\n\nexport function SnippetsMenu<T extends SnippetItemBase>(props: SnippetsMenuProps<T>) {\n  const { items, controller, onItemSelected, onEnterDirectly } = props;\n  const [selectedIndex, setSelectedIndex] = React.useState<number | undefined>();\n  const listRef = React.useRef<HTMLDivElement | null>(null);\n\n  const itemsMap: Record<string, { item: T; index: number }> = React.useMemo(() => (\n    items.reduce((record, current, index) => ({\n      ...record,\n      [current.key]: { item: current, index },\n    }), {})\n  ), [items]);\n\n  const handleActiveChange = React.useCallback((key: string | null, _opt) => {\n    if (typeof key !== 'string') {\n      setSelectedIndex(undefined);\n    } else {\n      setSelectedIndex(itemsMap[key || ''].index);\n    }\n  }, [itemsMap]);\n\n  const handleSelected = React.useCallback((key: string) => {\n    onItemSelected(itemsMap[key].item)\n  }, [itemsMap]);\n\n  const handleKeyDown = React.useCallback((event: KeyboardEvent) => {\n    // composing 过程中的 keydown 不予处理\n    if (controller.value.composing.length > 0) {\n      return;\n    }\n    if (isUpHotKey(event)) {\n      event.preventDefault();\n      const index = typeof selectedIndex === 'number' && selectedIndex > 0 ? selectedIndex - 1 : items.length - 1\n      setSelectedIndex(index);\n      // @ts-ignore\n      listRef.current?.children[index].scrollIntoViewIfNeeded(false);\n    } else if (isDownHotKey(event)) {\n      event.preventDefault();\n      const index = (\n        typeof selectedIndex === 'undefined'\n          ? 0\n          : (selectedIndex < items.length - 1 ? selectedIndex + 1 : undefined)\n      );\n      setSelectedIndex(index);\n      // Ref: [兼容性](https://developer.mozilla.org/zh-CN/docs/Web/API/Element/scrollIntoViewIfNeeded#%E6%B5%8F%E8%A7%88%E5%99%A8%E6%94%AF%E6%8C%81)\n      // @ts-ignore\n      listRef.current?.children[index || 0].scrollIntoViewIfNeeded(false);\n    } else if (isEnterHotKey(event)) {\n      if (typeof selectedIndex === 'number') {\n        event.preventDefault();\n        onItemSelected(items[selectedIndex]);\n      } else {\n        // 未选中选项，按 enter 则走原本编辑器的逻辑\n        onEnterDirectly(event);\n      }\n    }\n  }, [selectedIndex, items]);\n\n  React.useEffect(() => {\n    document.addEventListener('keydown', handleKeyDown);\n    return () => {\n      document.removeEventListener('keydown', handleKeyDown);\n    };\n  }, [handleKeyDown]);\n\n  React.useEffect(() => {\n    // reset active item\n    setSelectedIndex(undefined);\n  }, [items]);\n\n  return (\n    <ListWrapper>\n      <List\n        ref={listRef}\n        items={items}\n        active={typeof selectedIndex === 'undefined' ? undefined : items[selectedIndex]?.key}\n        onActiveChange={handleActiveChange}\n        onSelect={handleSelected}\n      />\n    </ListWrapper>\n  );\n}\n"],"file":"Menu.js"}