{"version":3,"sources":["../../../../src/bi/handlers/onKeyUp.ts"],"names":["isKeyHotkey","FN_KEYS","isFnKey","isUpDownEnterHotKey","createOnKeyUp","manager","prevFocusText","onKeyUp","event","controller","next","value","focusText","selection","getSnippet","originTrigger","trigger","originText","text","isExpanded","focus","isEdgePoint","undefined","setCurrentSnippet","slice","offset","configs","triggerText","Object","keys","find","regexp","RegExp","matched","match","matchedText","triggerPrefix","triggerSuffix","prefixText","length","test","suffixText"],"mappings":"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","sourcesContent":["import { Controller, Node } from '@ali/4ever-cangjie';\nimport type SnippetManger from '../snippetManager';\nimport { isKeyHotkey } from 'is-hotkey';\n\nconst FN_KEYS = [\n  'tab',\n  'shift',\n  'control',\n  'alt',\n  'pause',\n  'capslock',\n  'escape',\n  'pageup',\n  'pagedown',\n  'end',\n  'home',\n  'arrowleft',\n  'arrowright',\n  // 'insert',\n  // 'delete',\n  'meta',\n  'numlock',\n  'scrolllock',\n]\nconst isFnKey = isKeyHotkey(FN_KEYS);\nconst isUpDownEnterHotKey = isKeyHotkey(['up', 'down', 'enter'])\n\nexport function createOnKeyUp(manager: SnippetManger) {\n  let prevFocusText: Node | undefined;\n\n  return function onKeyUp(\n    event: React.KeyboardEvent,\n    controller: Controller,\n    next: Function,\n  ) {\n    const { focusText, selection } = controller.value;\n    const { trigger: originTrigger, text: originText } = manager.getSnippet();\n    if (selection.isExpanded || selection.focus.isEdgePoint() || isFnKey(event)) {\n      if (originTrigger !== undefined || originText !== undefined) {\n        manager.setCurrentSnippet();\n      }\n      return next();\n    }\n\n    if (isUpDownEnterHotKey(event) || !focusText || focusText === prevFocusText) {\n      return next();\n    }\n\n    prevFocusText = focusText;\n    const text = focusText.text.slice(0, selection.focus.offset);\n    const configs = manager.configs;\n\n    let triggerText: string | undefined = undefined;\n    const trigger = Object.keys(configs || {}).find((trigger) => {\n      const regexp = new RegExp(trigger);\n      const matched = text.match(regexp);\n      if (matched) {\n        const [matchedText] = matched;\n        const { triggerPrefix, triggerSuffix } = configs[trigger] || {};\n        // 检查 prefix 字符串\n        const prefixText = text.slice(0, text.length - matchedText.length);\n        if (triggerPrefix && !new RegExp(triggerPrefix).test(prefixText)) {\n          return false;\n        }\n        // 检查 suffix 字符串\n        const suffixText = focusText.text.slice(text.length);\n        if (triggerSuffix && !new RegExp(triggerSuffix).test(suffixText)) {\n          return false;\n        }\n        triggerText = matchedText;\n        return true;\n      }\n      return false;\n    });\n    if (trigger !== originTrigger || triggerText !== originText) {\n      manager.setCurrentSnippet(trigger, triggerText);\n    }\n    return next();\n  }\n}"],"file":"onKeyUp.js"}