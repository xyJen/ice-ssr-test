{"version":3,"sources":["../../../../src/plugins/embed/index.tsx"],"names":["React","useEffect","sanitizeUrl","v4","uuid","get","EmbedPlugin","theme","CardIconWrapper","CardContentWrapper","ContentHeader","ContentDesc","EmbedFilePreviewWrapper","PreviewHeaderWrapper","PreviewContentWrapper","CardContentInnerWrapper","PreviewError","PreviewErrorText","PreviewErrorRetry","EnlargeIconHide","moFactory","DEFAULT_PREVIEW_HEIGHT","embed","previewHeight","getFileTypeForRead","getIcon","formatSize","FileTypeMap","EmbedDownloadButton","EmbedCard","EmbedFailedCard","createEmbedPlugin","config","onDownloadFile","props","node","data","src","name","type","size","embedConfig","downloadFile","preview","iframeId","previewErrorId","enlargeHideId","onPreview","transformDocURL","Video","Audio","then","res","previewUrl","iframe","document","getElementById","enlargeHide","style","display","Promise","resolve","reject","e","console","error","previewError","renderCard","locale","allowDownload","renderPreviewHeader","mode","width","height","download","AutoInitPreview","initPreview","renderPreview","previewSize","reTryPreview","border","background","Ppt","renderNode","_","next","viewType","errorType","attributes"],"mappings":"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","sourcesContent":["import React, { useEffect } from 'react';\nimport { sanitizeUrl } from '@ali/4ever-utils';\nimport { v4 as uuid } from 'uuid';\nimport { get } from 'lodash-es';\nimport {\n  EmbedPlugin,\n  theme,\n} from '@ali/4ever-bamboo';\nimport {\n  CardIconWrapper,\n  CardContentWrapper,\n  ContentHeader,\n  ContentDesc,\n  EmbedFilePreviewWrapper,\n  PreviewHeaderWrapper,\n  PreviewContentWrapper,\n  CardContentInnerWrapper,\n  PreviewError,\n  PreviewErrorText,\n  PreviewErrorRetry,\n  EnlargeIconHide,\n} from './styled';\nimport { moFactory } from '@ali/4ever-plugin-embed';\n\nconst { previewHeight: DEFAULT_PREVIEW_HEIGHT } = theme.embed;\n\nconst {\n  getFileTypeForRead,\n  getIcon,\n  formatSize,\n  FileTypeMap,\n  EmbedDownloadButton,\n  EmbedCard,\n  EmbedFailedCard,\n} = EmbedPlugin;\n\n// 只读下 allowDownload 附件只支持 boolean 类型\nexport default function createEmbedPlugin(config) {\n  const onDownloadFile = (props) => () => {\n    const { node } = props;\n    const { data } = node;\n    const { src, name, type, size } = data;\n    const embedConfig = config.embed || {};\n    const { downloadFile } = embedConfig;\n    if (downloadFile) {\n      downloadFile(src, {\n        name,\n        type,\n        size,\n      });\n    }\n  };\n\n  const preview = (props, iframeId, previewErrorId, enlargeHideId) => {\n    const { node } = props;\n    const { data } = node;\n    const { src, type } = data;\n    const embedConfig = config.embed || {};\n    const { transformDocURL: onPreview } = embedConfig;\n    if (!onPreview) {\n      return;\n    }\n    if (type === FileTypeMap.Video || type === FileTypeMap.Audio) {\n      return;\n    }\n    onPreview(src)\n      .then((res: {previewUrl? : string}) => {\n        const { previewUrl } = res || {};\n        if (previewUrl) {\n          const iframe = document.getElementById(iframeId) as HTMLIFrameElement;\n          if (iframe) {\n            iframe.src = sanitizeUrl(previewUrl);\n          }\n          const enlargeHide = document.getElementById(enlargeHideId);\n          if (enlargeHide) {\n            enlargeHide.style.display = 'block';\n          }\n          return Promise.resolve();\n        } else {\n          return Promise.reject('empty previewUrl')\n        }\n      })\n      .catch((e) => {\n        console.error(e);\n        const previewError = document.getElementById(previewErrorId);\n        const iframe = document.getElementById(iframeId) as HTMLIFrameElement;\n        if (previewError) {\n          previewError.style.display = 'block';\n        }\n        if (iframe) {\n          iframe.style.display = 'none';\n        }\n      });\n  };\n\n  const renderCard = (props) => {\n    const { node } = props;\n    const { locale = {}, allowDownload } = config.embed || {};\n    const { data } = node;\n    const { name, size } = data;\n\n    return (\n      <EmbedCard\n        name={name}\n        allowDownload={allowDownload}\n        isSelected={false}\n        node={node}\n        locale={locale}\n        onDownloadFile={onDownloadFile(props)}\n        size={size}\n      />\n    );\n  };\n\n  const renderPreviewHeader = (props, mode?: string) => {\n    const { locale = {}, allowDownload } = config.embed || {};\n    const { node } = props;\n    const { data } = node;\n    const { size, name } = data;\n\n    return (\n      <PreviewHeaderWrapper mode={mode}>\n        <CardIconWrapper>\n          <img\n            src={getIcon(getFileTypeForRead(name))}\n            alt=\"icon\"\n            style={{ width: 16, height: 23 }}\n          />\n        </CardIconWrapper>\n        <CardContentWrapper>\n          <CardContentInnerWrapper>\n            <ContentHeader mode={mode}>{name}</ContentHeader>\n            <ContentDesc mode={mode}>{formatSize(size)}</ContentDesc>\n          </CardContentInnerWrapper>\n        </CardContentWrapper>\n        {allowDownload &&\n          <EmbedDownloadButton\n            title={locale?.download}\n            onDownloadFile={onDownloadFile(props)}\n            allowDownload={allowDownload}\n          />}\n      </PreviewHeaderWrapper>\n    );\n  };\n\n  const AutoInitPreview = ({ initPreview }: any) => {\n    useEffect(() => {\n      if (initPreview) initPreview();\n    }, [initPreview]);\n\n    return null;\n  };\n\n  const renderPreview = (props) => {\n    const { locale = {} } = config.embed || {};\n    const { node } = props;\n    const { data } = node;\n    const { previewSize, type } = data;\n    const iframeId = uuid();\n    const previewErrorId = uuid();\n    const height = get(previewSize, 'height', DEFAULT_PREVIEW_HEIGHT);\n    const enlargeHideId = uuid();\n\n    return (\n      <EmbedFilePreviewWrapper style={{ height }}>\n        {renderPreviewHeader(props)}\n        <PreviewContentWrapper>\n          <PreviewError id={previewErrorId}>\n            <PreviewErrorText>\n              {locale.previewError}\n              <PreviewErrorRetry\n                onClick={() => preview(\n                  props,\n                  iframeId,\n                  previewErrorId,\n                  enlargeHideId,\n                )\n                }\n              >\n                {locale.reTryPreview}\n              </PreviewErrorRetry>\n            </PreviewErrorText>\n          </PreviewError>\n          <iframe\n            style={{\n              width: '100%',\n              height: '100%',\n              border: 'none',\n              background: '#EDEDED',\n            }}\n            title=\"preview\"\n            src=\"\"\n            id={iframeId}\n          />\n          {/* hack：阿里云文档预览页面会给ppt底下加个放大按钮，但在我们这里点了没反应，先隐藏 */}\n          {type === FileTypeMap.Ppt && <EnlargeIconHide id={enlargeHideId} />}\n        </PreviewContentWrapper>\n        <AutoInitPreview initPreview={() => { preview(props, iframeId, previewErrorId, enlargeHideId); }} />\n      </EmbedFilePreviewWrapper>\n    );\n  };\n\n  return {\n    ...moFactory({}),\n    renderNode(props, _, next) {\n      const { node } = props;\n      if (node.type !== 'embed' || node.data.type === FileTypeMap.Video || node.data.type === FileTypeMap.Audio) {\n        return next();\n      }\n      const { data } = node;\n      const { viewType, errorType } = data;\n\n      const { attributes } = props;\n\n      const { locale = {} } = config.embed || {};\n      if (errorType) return <EmbedFailedCard node={node} locale={locale} />;\n\n      return (\n        <div\n          {...attributes}\n        >\n          {viewType === 'preview' ? renderPreview(props) : renderCard(props)}\n        </div>\n      );\n    },\n  };\n}\n"],"file":"index.js"}