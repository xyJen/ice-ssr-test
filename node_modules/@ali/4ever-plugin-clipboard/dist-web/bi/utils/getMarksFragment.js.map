{"version":3,"sources":["../../../../src/bi/utils/getMarksFragment.ts"],"names":["Commands","Text","omit","getPointAndBlockOnSelection","getExtendBlock","EXCLUDE_STYLE","dealFirsIsList","controller","listItems","query","length","fistItem","command","setNodeByKey","key","type","data","getMarksFragment","fragment","startBlock","startPoint","extendBlock","value","document","pasteFromStart","isAtStartOfNode","isFirstParagraph","marks","newFragment","mapDescendants","child","isText","childMarks","forEach","mark","removeMark","text","addMarks","set"],"mappings":"AAAA,SAAqBA,QAArB,EAAyCC,IAAzC,QAA4D,oBAA5D;AACA,SAASC,IAAT,QAAqB,WAArB;AACA,SAASC,2BAAT,QAA4C,kBAA5C;AACA,SAASC,cAAT,6B,CAEA;;AACA,IAAMC,aAAa,GAAG,CAAC,IAAD,CAAtB,C,CAEA;;AACA,IAAMC,cAAc,GAAG,SAAjBA,cAAiB,CAACC,UAAD,EAA4B;AACjD,MAAMC,SAAS,GAAGD,UAAU,CAACE,KAAX,CAAiB,gBAAjB,CAAlB;;AACA,MAAID,SAAJ,YAAIA,SAAS,CAAEE,MAAf,EAAuB;AACrB,QAAMC,QAAQ,GAAGH,SAAS,CAAC,CAAD,CAA1B;AACAG,IAAAA,QAAQ,IAAIJ,UAAU,CAACK,OAAX,CACVZ,QAAQ,CAACa,YADC,EAEVF,QAAQ,CAACG,GAFC,EAGV;AACEC,MAAAA,IAAI,EAAE,WADR;AAEEC,MAAAA,IAAI,EAAEd,IAAI,CAACS,QAAQ,CAACK,IAAV,EAAgB,MAAhB;AAFZ,KAHU,CAAZ;AAQD;AACF,CAbD;AAeA;AACA;AACA;AACA;;;AACA,eAAe,SAASC,gBAAT,CACbV,UADa,EAEbW,QAFa,EAGH;AAAA,8BACyBf,2BAA2B,CAACI,UAAD,CADpD;AAAA,MACFY,UADE,yBACFA,UADE;AAAA,MACUC,UADV,yBACUA,UADV;;AAEV,MAAMC,WAAW,GAAGjB,cAAc,CAACG,UAAU,CAACe,KAAX,CAAiBC,QAAlB,EAA4BJ,UAA5B,CAAlC;AACA,MAAI,CAACA,UAAL,EAAiB,OAAOD,QAAP;AACjB,MAAMM,cAAc,GAAGJ,UAAU,CAACK,eAAX,CAA2BN,UAA3B,CAAvB;AACA,MAAIO,gBAAgB,GAAG,IAAvB;;AACA,MAAIF,cAAJ,EAAoB;AAClBlB,IAAAA,cAAc,CAACC,UAAD,CAAd;AACD;;AACD,MAAKY,UAAD,CAAqBQ,KAAzB,EAAgC;AAC9B;AACA,QAAMC,WAAW,GAAGV,QAAQ,CAACW,cAAT,CAAwB,UAACC,KAAD,EAAW;AACrD,UAAI7B,IAAI,CAAC8B,MAAL,CAAYD,KAAZ,CAAJ,EAAwB;AACtB,YAAME,UAAU,GAAGF,KAAK,CAACH,KAAzB;AACAK,QAAAA,UAAU,CAACC,OAAX,CAAmB,UAACC,IAAD,EAAU;AAC3BJ,UAAAA,KAAK,GAAIA,KAAD,CAAgBK,UAAhB,CAA2B,CAA3B,EAA8BL,KAAK,CAACM,IAAN,CAAW1B,MAAzC,EAAiDwB,IAAjD,CAAR;AACD,SAFD,EAFsB,CAKtB;;AACA,eAAOV,cAAc,GACjBM,KADiB,GAEjBA,KAAK,CAACO,QAAN,CAAe,CAAf,EAAkBP,KAAK,CAACM,IAAN,CAAW1B,MAA7B,EAAsCS,UAAD,CAAqBQ,KAA1D,CAFJ;AAGD,OATD,MASO,IAAIN,WAAJ,EAAiB;AAAA;;AACtB,YAAI,WAACS,KAAD,4BAAkBf,IAAlB,MAA2B,WAA3B,IAA0CW,gBAA9C,EAAgE;AAC9DA,UAAAA,gBAAgB,GAAG,KAAnB;AACA,iBAAQI,KAAD,CACJQ,GADI,CACA,MADA,EACQjB,WAAW,CAACN,IADpB,EAEJuB,GAFI,CAEA,MAFA,EAEQpC,IAAI,CAACmB,WAAW,CAACL,IAAb,EAAmBX,aAAnB,CAFZ,CAAP;AAGD;;AACD,eAAOyB,KAAP;AACD,OARM,MAQA;AACL,eAAOA,KAAP;AACD;AACF,KArBmB,CAApB;AAsBA,WAAOF,WAAP;AACD,GAzBD,MAyBO;AACL,WAAOV,QAAP;AACD;AACF","sourcesContent":["import { Controller, Commands, Document, Text, Block } from '@ali/4ever-cangjie';\nimport { omit } from 'lodash-es';\nimport { getPointAndBlockOnSelection } from '@ali/4ever-utils';\nimport { getExtendBlock } from './getMatchFragment';\n\n// 不需要继承的样式\nconst EXCLUDE_STYLE = ['jc']\n\n// 列表内容切换为纯文本时，第一项序号不会被删除, 列表转为普通段落\nconst dealFirsIsList = (controller: Controller) => {\n  const listItems = controller.query(\"getCurrentItem\");\n  if (listItems?.length) {\n    const fistItem = listItems[0];\n    fistItem && controller.command(\n      Commands.setNodeByKey,\n      fistItem.key,\n      {\n        type: 'paragraph',\n        data: omit(fistItem.data, 'list'),\n      },\n    );\n  }\n};\n\n/**\n * @description 继承粘贴时光标所在位置 startBlock的style\n * @param {Document} fragment - 粘贴要插入的内存模型对象\n * */\nexport default function getMarksFragment(\n  controller: Controller,\n  fragment: Document,\n): Document {\n  const { startBlock, startPoint } = getPointAndBlockOnSelection(controller);\n  const extendBlock = getExtendBlock(controller.value.document, startBlock as Block);\n  if (!startBlock) return fragment;\n  const pasteFromStart = startPoint.isAtStartOfNode(startBlock);\n  let isFirstParagraph = true;\n  if (pasteFromStart) {\n    dealFirsIsList(controller);\n  }\n  if ((startBlock as Text).marks) {\n    // @ts-ignore\n    const newFragment = fragment.mapDescendants((child) => {\n      if (Text.isText(child)) {\n        const childMarks = child.marks;\n        childMarks.forEach((mark) => {\n          child = (child as Text).removeMark(0, child.text.length, mark);\n        });\n        // 如果粘贴位置是在段落开始位置，没有样式继承项时，只做样式清除\n        return pasteFromStart\n          ? child\n          : child.addMarks(0, child.text.length, (startBlock as Text).marks);\n      } else if (extendBlock) {\n        if ((child as Block)?.type === 'paragraph' && isFirstParagraph) {\n          isFirstParagraph = false;\n          return (child as Block)\n            .set('type', extendBlock.type)\n            .set('data', omit(extendBlock.data, EXCLUDE_STYLE));\n        }\n        return child;\n      } else {\n        return child;\n      }\n    });\n    return newFragment;\n  } else {\n    return fragment;\n  }\n}\n"],"file":"getMarksFragment.js"}