import { insertFragment, insertMatchFragment, insertTextFragment } from "../actions";
import { PasteMode } from "../../utils/types";
import { ClipboardErrorEnum } from "../../utils/constants";
import { isDingDocs } from "../../utils/tester";
import { decorateFragment } from "../utils/decorateFragment";
export default function createOnCangjiePaste(clipboardConfig) {
  return function onCangjiePaste(event, controller, next) {
    if (!event.clipboardData) {
      return next();
    }

    var mode = clipboardConfig.mode,
        onError = clipboardConfig.onError;

    var pasteOperation = function pasteOperation() {
      // 记录光标位置到decoration
      // 读取粘贴板数据
      var clipboardData = controller.query('getClipboardData', event);

      if (!clipboardData) {
        return;
      }

      switch (mode) {
        case PasteMode.text:
          {
            var fragment = clipboardData.getTextFragment();
            return controller.run('onAction', insertTextFragment(fragment));
          }

        case PasteMode.match:
          {
            var _fragment = clipboardData.getFragment();

            return controller.run('onAction', insertMatchFragment(_fragment));
          }

        default:
          {
            var _fragment2 = clipboardData.getFragment();

            if (!event.nativeEvent && !_fragment2) {
              console.warn('Js has no clipboard read permission, you can set event clipboardData that jsapi gets.(See: https://pre-cangjie.alibaba-inc.com/document/advanced-topics/ccp#copy-and-paste-%E5%A4%8D%E5%88%B6%E7%B2%98%E8%B4%B4)');
            }

            if (!isDingDocs(clipboardData)) {
              _fragment2 = decorateFragment(controller, _fragment2);
            }

            return controller.run('onAction', insertFragment(_fragment2));
          }
      }
    };

    try {
      if (event.nativeEvent) {
        pasteOperation();
      } else {
        // 防止粘贴大量内容加载动画卡顿，等业务层ui更新后，再进行反序列化
        // 使用 requestIdleCallback， 大文档中编辑器 idle 时间较少, 粘贴会导致 pasteOperation 操作堆积
        setTimeout(function () {
          pasteOperation();
        });
      }
    } catch (error) {
      if (onError) {
        onError(ClipboardErrorEnum.PASTE_FAILED, error);
      }

      throw error;
    }
  };
}
//# sourceMappingURL=createOnCangjiePaste.js.map