{"version":3,"sources":["../../../src/utils/restructFragment.ts"],"names":["CheckStatus","klassRule","match","Mark","isMark","klass","Text","isText","Document","isDocument","Inline","isInline","Block","isBlock","getNodeKlass","node","find","rule","flattenNode","array","reduce","result","current","nodes","concat","push","parseDataType","dataType","Array","isArray","checkDataType","receiveData","expectData","Object","keys","length","success","necessaryType","filter","field","type","includes","undefined","conformNecessary","every","failed","receiveDataTypes","redundance","allowTypes","actual","hasType","some","actualIsObj","typeName","name","toLowerCase","randundance","getModelVal","modelsMap","get","join","isKnown","modelVal","Boolean","processWithNode","results","map","val","data","successResult","randundanceResult","forEach","rst","set","restructFragment","fragment","restructure","oldNode","isKnownNode","restructNodes","create","key","leaves","leaf","marks","mark","isKnownMark","newMark"],"mappings":"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","sourcesContent":["import { Block, Document, Inline, Text, Mark } from '@ali/4ever-cangjie';\nimport { flatten } from 'lodash-es';\nimport { omit } from 'lodash-es';\nimport { ModelsMap } from './types';\n\nenum CheckStatus {\n  success,\n  failed,\n  randundance,\n}\n\ntype CheckDataResult = [CheckStatus.success | CheckStatus.failed | CheckStatus.randundance, object];\n\nconst klassRule = [\n  {\n    match: Mark.isMark,\n    klass: 'mark',\n  },\n  {\n    match: Text.isText,\n    klass: 'text',\n  },\n  {\n    match: Document.isDocument,\n    klass: 'document',\n  },\n  {\n    match: Inline.isInline,\n    klass: 'inline',\n  },\n  {\n    match: Block.isBlock,\n    klass: 'block',\n  },\n];\n\nconst getNodeKlass = (node: Block | Mark): string => {\n  return klassRule.find((rule) => rule.match(node))?.klass || '';\n};\n\nexport const flattenNode = (array) => {\n  return array.reduce((result, current) => {\n    if (current.nodes) {\n      result.concat(current.nodes);\n    } else {\n      result.push(current);\n    }\n    return result;\n  }, []);\n};\n\nfunction parseDataType(dataType: string | string[]): string[] {\n  if (Array.isArray(dataType)) {\n    return dataType;\n  }\n  return [dataType];\n}\n// success -> 校验成功, failed -> 校验失败, redundance -> 校验成功，但有冗余字段\nfunction checkDataType(\n  receiveData: object,\n  expectData?: object,\n): CheckDataResult {\n  // models 中未定义 data 类型，默认为类型校验成功\n  if (!expectData || Object.keys(expectData).length === 0) {\n    return [CheckStatus.success, receiveData];\n  }\n\n  // 从 models 中找出必须有的字段（即非 undefined 类型）\n  const necessaryType = Object.keys(expectData).filter((field) => {\n    const type = expectData[field];\n    return !(Array.isArray(type) && type.includes(undefined));\n  });\n\n  // 校验 node 节点属性上是否有 models 中定义的必须有的字段\n  const conformNecessary = necessaryType.every((field) => {\n    return receiveData[field];\n  });\n\n  // node 缺少必有字段，类型校验失败\n  if (!conformNecessary) {\n    return [CheckStatus.failed, receiveData];\n  }\n\n  // 对 node 上的属性进行类型校验\n  const receiveDataTypes = Object.keys(receiveData);\n  if (receiveDataTypes.length === 0) {\n    return [CheckStatus.success, receiveData];\n  }\n  const redundance: string[] = [];\n  for (const field of receiveDataTypes) {\n    // node 中 存在 models data 中未定义的字段，类型校验失败\n    if (!expectData[field]) {\n      redundance.push(field);\n      continue;\n    }\n\n    // 解析 model.data 字段中允许的类型\n    const allowTypes = parseDataType(expectData[field]);\n\n    // 获取真实节点上对应属性的类型\n    const actual = receiveData[field];\n    const hasType = allowTypes.some((type: any) => {\n      const actualIsObj = actual instanceof Object;\n      if (!type) {\n        // 对 undefined、null 类型的 type 做校验\n        return actual === type;\n      } else if (actualIsObj) {\n        // 这里对 actual 是 Array、Object 类型作区分\n        if (Array.isArray(actual) && !type.isArray) {\n          return false;\n        }\n        return actual instanceof type;\n      };\n      // instanceof 只能通过原型链判断，例如 'abc' instanceof String, 结果是 false\n      const typeName = type.name?.toLowerCase();\n      // eslint-disable-next-line valid-typeof\n      return typeof actual === typeName;\n    });\n\n    // 类型校验\n    if (!hasType) {\n      return [CheckStatus.failed, receiveData];\n    }\n  }\n  if (redundance.length > 0) {\n    return [CheckStatus.randundance, omit(receiveData, redundance)];\n  }\n  return [CheckStatus.success, receiveData];\n}\n\nfunction getModelVal(node, modelsMap) {\n  const klass = getNodeKlass(node);\n  const keys = [klass, node.type];\n  return modelsMap.get(keys.join('_'));\n}\n\nconst isKnown = (node: Block | Mark, modelsMap): boolean => {\n  const klass = getNodeKlass(node);\n  const modelVal = getModelVal(node, modelsMap);\n  return Boolean(modelVal) || klass === 'document';\n};\n\nfunction processWithNode(node, modelsMap) {\n  const klass = getNodeKlass(node);\n  if (klass === 'document') {\n    return [true, node];\n  }\n  if (isKnown(node, modelsMap)) {\n    const modelVal = getModelVal(node, modelsMap);\n    const results = modelVal.map((val) => checkDataType(node.data, val));\n    const successResult: any[] = [];\n    const randundanceResult: any[] = [];\n    results.forEach((rst) => {\n      if (rst[0] === CheckStatus.success) {\n        successResult.push(rst);\n      } else if (rst[0] === CheckStatus.randundance) {\n        randundanceResult.push(rst);\n      }\n    });\n    if (successResult.length > 0) {\n      return [true, node];\n    }\n    if (randundanceResult.length > 0) {\n      return [true, node.set('data', randundanceResult[CheckStatus.success][1])];\n    }\n    return [false, node];\n  }\n  return [false, node];\n}\n\nexport function restructFragment(\n  fragment: Document,\n  modelsMap: ModelsMap,\n): Document {\n  const restructure = (oldNode) => {\n    const [isKnownNode, node] = processWithNode(oldNode, modelsMap);\n    if (isKnownNode) {\n      if (node.nodes) {\n        return [node.set('nodes', flatten(node.nodes.map(restructure)))];\n      }\n      return [node];\n    }\n    if (node.nodes) {\n      const klass = getNodeKlass(node);\n      if (klass === 'block') {\n        return [\n          node\n            .set('type', 'paragraph')\n            .set('nodes', restructNodes(node.nodes))\n            .set('data', {}),\n        ];\n      }\n      return flattenNode(flatten(node.nodes.map(restructure)));\n    }\n    if (Text.isText(node)) {\n      return [\n        Text.create({\n          key: node.key,\n          leaves: node.leaves.map((leaf) => {\n            const marks: Mark[] = [];\n            leaf.marks.forEach((mark) => {\n              const [isKnownMark, newMark] = processWithNode(mark, modelsMap);\n              if (isKnownMark) {\n                marks.push(newMark);\n              }\n            });\n            return leaf.set('marks', marks);\n          }),\n        }),\n      ];\n    }\n    return [node];\n  };\n  const restructNodes = (nodes) => flatten(nodes.map(restructure));\n  const [result] = restructure(fragment);\n  return result;\n}\n"],"file":"restructFragment.js"}