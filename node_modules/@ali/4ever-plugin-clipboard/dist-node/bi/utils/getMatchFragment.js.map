{"version":3,"sources":["../../../../src/bi/utils/getMatchFragment.ts"],"names":["getExtendBlock","doc","block","type","getParent","key","getMatchFragment","controller","fragment","document","value","pointAndBlock","startBlock","startPoint","extendBlock","startBlockPath","getPath","pasteFromStart","isAtStartOfNode","marks","newFragment","mapDescendants","child","Text","isText","childMarks","forEach","mark","removeMark","text","length","addMarks","set","data","undefined"],"mappings":";;;;;;;;AAAA;;AACA;;AAEO,MAAMA,cAAc,GAAG,CAACC,GAAD,EAAgBC,KAAhB,KAAsD;AAClF,MAAI,CAACA,KAAL,EAAY;AACV,WAAO,IAAP;AACD,GAFD,MAEO,IAAIA,KAAK,CAACC,IAAV,EAAgB;AACrB,WAAOD,KAAP;AACD,GAFM,MAEA;AACL,WAAOF,cAAc,CAACC,GAAD,EAAMA,GAAG,CAACG,SAAJ,CAAcF,KAAK,CAACG,GAApB,CAAN,CAArB;AACD;AACF,CARM;AAUP;AACA;AACA;AACA;;;;;AACe,SAASC,gBAAT,CACbC,UADa,EAEbC,QAFa,EAGH;AACV,QAAM;AAAEC,IAAAA;AAAF,MAAeF,UAAU,CAACG,KAAhC;AACA,QAAMC,aAAa,GAAG,4CAA4BJ,UAA5B,CAAtB;AACA,QAAM;AAAEK,IAAAA,UAAF;AAAcC,IAAAA;AAAd,MAA6BF,aAAnC;AACA,QAAMG,WAAW,GAAGd,cAAc,CAACO,UAAU,CAACG,KAAX,CAAiBD,QAAlB,EAA4BG,UAA5B,CAAlC;AACA,MAAI,CAACA,UAAL,EAAiB,OAAOJ,QAAP;AACjB,QAAMO,cAAc,GAAGN,QAAQ,CAACO,OAAT,CAAiBJ,UAAU,CAACP,GAA5B,CAAvB;AACA,QAAMY,cAAc,GAClBF,cAAc,IACdA,cAAc,CAAC,CAAD,CAAd,KAAsB,CADtB,IAEAF,UAAU,CAACK,eAAX,CAA2BN,UAA3B,CAHF;AAIA,QAAMO,KAAK,GAAIP,UAAD,EAAsBO,KAApC;;AACA,MAAIA,KAAJ,EAAW;AACT;AACA,UAAMC,WAAW,GAAGZ,QAAQ,CAACa,cAAT,CAAwBC,KAAK,IAAI;AACnD,UAAIC,kBAAKC,MAAL,CAAYF,KAAZ,CAAJ,EAAwB;AACtB,cAAMG,UAAU,GAAGH,KAAK,CAACH,KAAzB;AACAM,QAAAA,UAAU,CAACC,OAAX,CAAmBC,IAAI,IAAI;AACzBL,UAAAA,KAAK,GAAIA,KAAD,CAAgBM,UAAhB,CAA2B,CAA3B,EAA8BN,KAAK,CAACO,IAAN,CAAWC,MAAzC,EAAiDH,IAAjD,CAAR;AACD,SAFD;AAGA,eAAOV,cAAc,GACjBK,KADiB,GAEjBA,KAAK,CAACS,QAAN,CAAe,CAAf,EAAkBT,KAAK,CAACO,IAAN,CAAWC,MAA7B,EAAqCX,KAArC,CAFJ;AAGD,OARD,MAQO,IAAIL,WAAJ,EAAiB;AACtB,YAAKQ,KAAD,EAAkBnB,IAAlB,KAA2B,WAA/B,EAA4C;AAC1C,iBAAQmB,KAAD,CACJU,GADI,CACA,MADA,EACQlB,WAAW,CAACX,IADpB,EAEJ6B,GAFI,CAEA,MAFA,EAEQlB,WAAW,CAACmB,IAFpB,CAAP;AAGD;;AACD,eAAOX,KAAP;AACD;;AACD,aAAOY,SAAP;AACD,KAlBmB,CAApB;AAmBA,WAAOd,WAAP;AACD,GAtBD,MAsBO;AACL,WAAOZ,QAAP;AACD;AACF","sourcesContent":["import { Controller, Block, Document, Text } from '@ali/4ever-cangjie';\nimport { getPointAndBlockOnSelection } from '@ali/4ever-utils';\n\nexport const getExtendBlock = (doc: Document, block: Block | null): Block | null => {\n  if (!block) {\n    return null;\n  } else if (block.type) {\n    return block;\n  } else {\n    return getExtendBlock(doc, doc.getParent(block.key) as Block);\n  }\n};\n\n/**\n * @description 继承粘贴时光标所在位置 startBlock的style及type\n * @param {Document} fragment - 粘贴要插入的内存模型对象\n * */\nexport default function getMatchFragment(\n  controller: Controller,\n  fragment: Document,\n): Document {\n  const { document } = controller.value;\n  const pointAndBlock = getPointAndBlockOnSelection(controller);\n  const { startBlock, startPoint } = pointAndBlock;\n  const extendBlock = getExtendBlock(controller.value.document, startBlock as Block);\n  if (!startBlock) return fragment;\n  const startBlockPath = document.getPath(startBlock.key);\n  const pasteFromStart =\n    startBlockPath &&\n    startBlockPath[1] === 0 &&\n    startPoint.isAtStartOfNode(startBlock);\n  const marks = (startBlock as Text)?.marks;\n  if (marks) {\n    // @ts-ignore\n    const newFragment = fragment.mapDescendants(child => {\n      if (Text.isText(child)) {\n        const childMarks = child.marks;\n        childMarks.forEach(mark => {\n          child = (child as Text).removeMark(0, child.text.length, mark);\n        });\n        return pasteFromStart\n          ? child\n          : child.addMarks(0, child.text.length, marks);\n      } else if (extendBlock) {\n        if ((child as Block)?.type === 'paragraph') {\n          return (child as Block)\n            .set('type', extendBlock.type)\n            .set('data', extendBlock.data);\n        }\n        return child;\n      }\n      return undefined;\n    });\n    return newFragment;\n  } else {\n    return fragment;\n  }\n}\n"],"file":"getMatchFragment.js"}