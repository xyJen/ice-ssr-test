{"version":3,"sources":["../../../src/ToolbarNext/BasicToolbar.tsx"],"names":["React","styled","ToolbarLayout","HeaderToolbarMode","areArraysContentEqual","areArraysIntersected","convertSingleLayout","convertDoubleLayout","ToolbarWrapper","div","convertToolbarMode","mode","convertBackToolbarMode","single","disabledStyle","opacity","pointerEvents","BasicToolbar","props","controller","plugins","singleLayout","doubleLayout","disableTargets","hideTargets","customButtons","onSwitchModeClick","rest","value","selection","pluginsArray","array","useState","currentTarget","setCurrentTargets","targets","useMemo","results","i","length","plugin","getTarget","toolbar","tgt","includes","push","useEffect","singleLineToolbar","doubleLineToolbar","shouldDisable","style","handleMouseDown","useCallback","ev","activeElement","window","document","closest","target","tagName","toLocaleLowerCase","preventDefault","handleModeChange","modeType","type"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport styled from 'styled-components';\nimport { ToolbarLayout } from '@ali/we-design-next';\nimport type { IToolbarLayoutProps } from '@ali/we-design-next';\nimport { IToolBar, HeaderToolbarMode } from './interface';\nimport type { Controller, BiPlugin } from '@ali/4ever-cangjie';\nimport type { Plugins } from '../PluginsContext';\nimport { areArraysContentEqual, areArraysIntersected } from './utils';\nimport { convertSingleLayout, convertDoubleLayout } from './layoutConverter';\n\n\nconst ToolbarWrapper = styled.div`\n  position: relative;\n`;\n\n\nexport interface IBasicToolbarProps extends IToolBar {\n  plugins: Plugins | null,\n  controller: Controller,\n}\n\nfunction convertToolbarMode(mode: HeaderToolbarMode): NonNullable<IToolbarLayoutProps['mode']> {\n\n  if (mode === HeaderToolbarMode.double) {\n    return 'doubleLine';\n  }\n\n  return 'singleLine';\n}\n\nfunction convertBackToolbarMode(mode: IToolbarLayoutProps['mode']): HeaderToolbarMode {\n\n  if (mode === 'doubleLine') {\n    return HeaderToolbarMode.double;\n  }\n  return HeaderToolbarMode.single;\n}\n\nconst disabledStyle: React.CSSProperties = {\n  opacity: 0.35,\n  pointerEvents: 'none',\n};\n\n\nexport const BasicToolbar: React.FC<IBasicToolbarProps> = (props) => {\n  const {\n    controller,\n    plugins,\n    singleLayout,\n    doubleLayout,\n    mode,\n    disableTargets = [],\n    hideTargets = [],\n    customButtons = {},\n    onSwitchModeClick,\n    ...rest\n  } = props;\n  const { value } = controller;\n  const { selection } = value;\n  const pluginsArray = plugins?.array || [];\n\n  const [currentTarget, setCurrentTargets] = React.useState<string[]>([]);\n\n  /**\n   * 从插件查询哪个插件被选中（暂不支持多个插件同时识别）\n   * 通过调用插件 getTarget 实现\n   */\n  const targets = React.useMemo(() => {\n    const results: string[] = [];\n    for (let i = 0; i < pluginsArray.length; i += 1) {\n      const plugin = pluginsArray[i] as BiPlugin;\n      const getTarget = plugin.toolbar?.getTarget;\n      if (getTarget && typeof getTarget === 'function') {\n        const tgt = getTarget(controller);\n        if (tgt && !results.includes(tgt)) {\n          results.push(tgt);\n        }\n      }\n    }\n    return results;\n  }, [pluginsArray, selection]);\n\n  React.useEffect(() => {\n    if (currentTarget !== targets && !areArraysContentEqual(currentTarget, targets)) {\n      setCurrentTargets(targets);\n    }\n\n  }, [currentTarget, targets])\n\n\n  const singleLineToolbar = singleLayout && convertSingleLayout(singleLayout, { controller, plugins, targets: currentTarget, customButtons });\n\n  const doubleLineToolbar = doubleLayout && convertDoubleLayout(doubleLayout, { controller, plugins, targets: currentTarget, customButtons });\n\n\n  if (areArraysIntersected(currentTarget, hideTargets)) {\n    return null;\n  }\n\n  const shouldDisable = areArraysIntersected(currentTarget, disableTargets);\n\n  const style = React.useMemo(() => {\n    if (shouldDisable) {\n      return disabledStyle;\n    }\n\n    return {};\n  }, [shouldDisable]);\n\n  const handleMouseDown = React.useCallback((ev: React.MouseEvent) => {\n    const { activeElement } = window.document;\n\n    // 对于有自定义输入域的不可编辑对象，不阻止其失焦行为\n    if (activeElement && activeElement.closest('[data-cangjie-not-editable]')) {\n      return;\n    }\n\n    if ((ev.target as Element)?.tagName?.toLocaleLowerCase() !== 'input') {\n      // 放过input，以便输入地方可以正常输入\n      ev.preventDefault && ev.preventDefault();\n      // 允许工具栏子节点上元素点击冒泡，避免下拉菜单无法收起\n      // ev.stopPropagation && ev.stopPropagation();\n    }\n  }, []);\n\n  const handleModeChange = React.useCallback((modeType: NonNullable<IToolbarLayoutProps['mode']>) => {\n    if (onSwitchModeClick) {\n      const type = convertBackToolbarMode(modeType)\n      onSwitchModeClick(type);\n    }\n  }, [onSwitchModeClick]);\n\n\n  return (\n    <ToolbarWrapper\n      style={style}\n      onMouseDown={handleMouseDown}\n      data-role={'toolbar'}\n      className={`bi-toolbar ${mode === HeaderToolbarMode.double ? 'double' : 'single'}`}\n    >\n      <ToolbarLayout\n        mode={convertToolbarMode(mode)}\n        singleLineToolbar={singleLineToolbar}\n        doubleLineToolbar={doubleLineToolbar}\n        onModeChange={handleModeChange}\n        {...rest}\n      />\n    </ToolbarWrapper>\n  );\n\n}\n\n"],"file":"BasicToolbar.js"}