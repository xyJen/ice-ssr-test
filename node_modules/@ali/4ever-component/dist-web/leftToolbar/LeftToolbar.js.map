{"version":3,"sources":["../../../src/leftToolbar/LeftToolbar.tsx"],"names":["React","useEffect","useCallback","useMemo","ReactDOM","throttle","Controller","Block","useZoom","ScrollableContentContext","logger","usePlugins","findBlockKeyFromEvent","calcCurrentPos","LeftToolbarWrapper","useLeftToolbar","LeftToolbarProvider","LEGAL_EVENT","isKeyHotkey","isEnterHotKey","mouseMoveHandler","event","container","updateHoverBlock","controller","contains","target","blockKey","block","value","document","getNode","type","getParent","isBlock","LeftToolbar","props","config","getScrollableContent","initController","useController","plugins","window","body","isMoveDisabled","useRef","focusBlock","selection","state","actions","preventMouseMove","isPreventMouseMove","canLeftToolbarVisibleRef","zoom","current","disable","query","node","position","undefined","offsetWithFocus","error","warn","offset","fixedPosition","right","Number","x","top","y","onKeyDown","onScroll","handleMouseMove","onMouseMove","shouldDisabledLeftToolbar","handleCustomEvent","e","detail","enable","clear","addEventListener","leftToolbarEnable","removeEventListener","arrays","array","listenerArrays","reduce","arr","p","leftToolbarHandlers","push","handler","cancel","getHandler","forEach","la","splice","indexOf","renderToolBtn","map","item","btn","plugin","hash","key","leftToolbar","ToolBtn","createPortal"],"mappings":"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","sourcesContent":["import React, { useEffect, useCallback, useMemo } from 'react';\nimport ReactDOM from 'react-dom';\nimport { throttle } from 'lodash-es';\nimport { Controller, Block, useZoom, BiPlugin, ScrollableContentContext } from '@ali/4ever-cangjie';\nimport logger from '@ali/4ever-logger';\nimport { usePlugins } from '../PluginsContext';\nimport findBlockKeyFromEvent from './utils/findBlockKeyFromEvent';\nimport calcCurrentPos from './utils/calcCurrentPos';\nimport { LeftToolbarWrapper } from './styled';\nimport { useLeftToolbar, LeftToolbarProvider } from './leftToolbarContext';\nimport { LEGAL_EVENT } from '@ali/4ever-utils';\nimport { isKeyHotkey } from 'is-hotkey';\n\nconst isEnterHotKey = isKeyHotkey('enter');\n\ninterface ToolbarBtn {\n  /**\n   * 对应的 plugin key\n   */\n  key: string;\n  /**\n   * 可以支持自定义工具栏按钮\n   */\n  btn?: JSX.Element;\n  // 偏移\n  offset?: number;\n}\n\n// 需要支持配置项传入， 这样可以给后面拆出拖拽提供可能性, 还可以在配置项中控制宽高\ninterface ILeftToolbarProps {\n  config: ToolbarBtn[];\n  getScrollableContent: () => HTMLElement;\n  controller: Controller;\n}\n\nconst mouseMoveHandler = (event, container, updateHoverBlock, controller) => {\n  if (!container.contains(event.target)) {\n    updateHoverBlock();\n    return;\n  }\n  const blockKey = findBlockKeyFromEvent(event, container, controller);\n  let block = controller.value.document.getNode(blockKey);\n  // 如果leftToolbar的findBlockKeyFromEvent没有找到对应block，则再通过hoverBlock的方法进行查找\n  // TODO 两套方法各自维护一套findBlockKeyFromEvent方法，后面需要统一\n  if (block?.type === 'line') {\n    block = controller.value.document.getParent(blockKey);\n  }\n  if (Block.isBlock(block)) {\n    updateHoverBlock(block);\n  }\n};\n\nconst LeftToolbar: React.FC<ILeftToolbarProps> = (props) => {\n  const { config, getScrollableContent, controller: initController } = props;\n\n  // eslint-disable-next-line react-hooks/rules-of-hooks\n  const controller = initController || Controller.useController();\n  const plugins = usePlugins();\n  const container = getScrollableContent() || window.document.body;\n  const isMoveDisabled = React.useRef(false);\n  const { focusBlock, selection } = controller.value;\n  const [state, actions] = useLeftToolbar();\n  const { block, preventMouseMove } = state;\n  const isPreventMouseMove = React.useRef(preventMouseMove);\n  const canLeftToolbarVisibleRef = React.useRef(true);\n  const zoom = useZoom();\n  isPreventMouseMove.current = preventMouseMove;\n\n  const disable = controller.query('disableLeftToolbar', { node: block! });\n\n  const position = useMemo(() => {\n    if (!block) return undefined;\n    // 插件检测是否需要偏移\n    return calcCurrentPos(block, container)!;\n  }, [block, container, controller]);\n\n  const offsetWithFocus = useMemo(() => {\n    if (!block) return undefined;\n    // 用于表格的场景，在focus的时候也要精确位置计算\n    // query 过程中 controller 可能会变为 undefined\n    try {\n      return controller.query('getLeftToolbarOffsetWithFocus', { node: block });\n    } catch (error) {\n      logger.warn(error as Error);\n    }\n    return undefined;\n  }, [block, controller, focusBlock]);\n\n  const offset = useMemo(() => {\n    if (!block) return undefined;\n    // query 过程中 controller 可能会变为 undefined\n    try {\n      return controller.query('getLeftToolbarOffset', { node: block });\n    } catch (error) {\n      logger.warn(error as Error);\n    }\n    return undefined;\n  }, [block, controller]);\n\n  const fixedPosition = useMemo(() => {\n    const value = offsetWithFocus || offset;\n    return value ? {\n      ...position,\n      right: (Number(position?.right) - value.x || 0),\n      // @ts-ignore\n      top: position?.top + value.y || 0,\n    } : position;\n  }, [position, offset, offsetWithFocus]);\n\n  const onKeyDown = useCallback((event: KeyboardEvent) => {\n    if (isEnterHotKey(event)) {\n      actions.updateHoverBlock();\n    }\n  }, [actions]);\n\n  const onScroll = useCallback(throttle(() => {\n    if (isPreventMouseMove.current) return;\n    actions.updateHoverBlock();\n  }, 1000), [actions]);\n\n  const handleMouseMove = useCallback(throttle(mouseMoveHandler, 50), []);\n\n  // 确保依赖是稳定的，不然会频繁监听和卸载事件监听\n  const onMouseMove = useCallback((event: MouseEvent) => {\n    // 如果外部组件比如SelectionBar设置了需要禁用左侧工具栏，则需要将左侧工具栏隐藏\n    // 浮动工具栏显示到时候需要隐藏掉左侧工具栏按钮\n    const shouldDisabledLeftToolbar = !canLeftToolbarVisibleRef.current;\n    if (isPreventMouseMove.current || isMoveDisabled.current || shouldDisabledLeftToolbar) {\n      if (shouldDisabledLeftToolbar) {\n        actions.updateHoverBlock();\n      }\n      return;\n    }\n    handleMouseMove(event, container, actions.updateHoverBlock, controller);\n  }, [handleMouseMove, container, actions.updateHoverBlock, controller]);\n\n  // 提供一个对外的事件，方便操作左侧工具栏的状态，原先leftToolbarHandlers的方式过于复杂\n  const handleCustomEvent = React.useCallback((e: any) => {\n    const { enable, clear } = e.detail;\n    if (clear) {\n      actions.updateHoverBlock();\n    }\n    canLeftToolbarVisibleRef.current = enable;\n  }, [actions.updateHoverBlock]);\n\n  useEffect(() => {\n    actions.updateHoverBlock();\n  }, [zoom, actions.updateHoverBlock]);\n\n  useEffect(() => {\n    // 新的产品逻辑要求输入的时候左侧工具栏不隐藏\n    window.document.addEventListener('mousemove', onMouseMove);\n    window.document.addEventListener('keydown', onKeyDown);\n    window.document.addEventListener('scroll', onScroll, true);\n    window.document.body.addEventListener(LEGAL_EVENT.leftToolbarEnable, handleCustomEvent);\n    return () => {\n      window.document.removeEventListener('mousemove', onMouseMove);\n      window.document.removeEventListener('keydown', onKeyDown);\n      window.document.removeEventListener('scroll', onScroll, true);\n      window.document.body.removeEventListener(LEGAL_EVENT.leftToolbarEnable, handleCustomEvent);\n    };\n  }, [onMouseMove, handleCustomEvent, onKeyDown, onScroll]);\n\n  // 把拖拽的临时启动、禁用，提供给外部使用。\n  // 其他可能与拖拽冲突的插件，就可以控制拖拽杆的禁用、隐藏。\n  useEffect(() => {\n    const arrays = plugins?.array || [];\n    const listenerArrays = arrays.reduce<Function[][]>((arr, p) => {\n      // @ts-ignore\n      const array = p?.leftToolbarHandlers as Function[] | undefined;\n      if (array) {\n        arr.push(array);\n      }\n      return arr;\n    }, []);\n    const handler = {\n      disable: () => {\n        actions.updateHoverBlock();\n        handleMouseMove.cancel();\n        isMoveDisabled.current = true;\n      },\n      enable: () => {\n        isMoveDisabled.current = false;\n      },\n      clear: () => {\n        actions.updateHoverBlock();\n        isMoveDisabled.current = false;\n      },\n    };\n    const getHandler = () => {\n      return handler;\n    };\n    listenerArrays.forEach((la) => la.push(getHandler));\n    return () => {\n      listenerArrays.forEach((la) => la.splice(la.indexOf(getHandler), 1));\n    };\n  }, [actions, plugins, controller, handleMouseMove]);\n\n  const renderToolBtn = useMemo(() => {\n    if (!plugins || !block || !config) {\n      return null;\n    }\n    return config.map((item) => {\n      if (item.btn) {\n        return item.btn;\n      }\n      const plugin = plugins?.hash[item.key] as BiPlugin | undefined;\n      if (plugin && plugin.leftToolbar) {\n        const ToolBtn = plugin.leftToolbar;\n        return (\n          <ToolBtn\n            key={`${item.key}_${block.key}`}\n            controller={controller}\n            currentBlock={block}\n          />\n        );\n      }\n      return null;\n    });\n  }, [plugins, block, config, controller, selection]);\n\n  if (!renderToolBtn || disable) return null;\n\n  return (\n    <LeftToolbarWrapper style={fixedPosition}>\n      {renderToolBtn}\n    </LeftToolbarWrapper>\n  );\n};\n\nexport default (props: ILeftToolbarProps) => {\n  const { getScrollableContent } = props;\n  const container = getScrollableContent?.() || window.document.body;\n  return ReactDOM.createPortal(\n    <ScrollableContentContext.Provider value={container}>\n      <LeftToolbarProvider>\n        <LeftToolbar {...props} />\n      </LeftToolbarProvider>\n    </ScrollableContentContext.Provider>\n    , container,\n  );\n};\n"],"file":"LeftToolbar.js"}