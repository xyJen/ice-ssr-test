{"version":3,"sources":["../../../src/Portal/index.tsx"],"names":["React","ReactDOM","throttle","Portal","triggerRef","createRef","portalRef","updatePortalPosition","props","visible","container","portalMatchTrigger","getPosition","zoom","maxWidth","trigger","findDOMNode","current","portal","triggerRect","getBoundingClientRect","offset","position","offsetX","offsetY","containerRect","top","bottom","left","portalRect","height","width","Math","min","style","minWidth","computedLeft","computedTop","bottomSpace","rightSpace","triggerTop","triggerRight","right","zIndex","componentDidMount","componentDidUpdate","componentWillUnmount","cancel","render","children","overlay","className","destroyOverlayOnHide","cloneElement","ref","createPortal","Component","defaultProps"],"mappings":"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","sourcesContent":["/* eslint-disable import/no-extraneous-dependencies */\nimport * as React from 'react';\nimport * as ReactDOM from 'react-dom';\nimport { throttle } from 'lodash-es';\n\nexport type GetPosition = (containerRect: DOMRect, triggerRect: DOMRect, portalRect: DOMRect) => { top: number, left: number };\n\nexport interface PortalProps {\n  overlay: React.ReactElement;\n  visible?: boolean;\n  destroyOverlayOnHide?: boolean;\n  // portal 相对原始位置偏移量\n  offset: number[];\n  container: HTMLElement;\n  zoom: number;\n  className?: string;\n  portalMatchTrigger: boolean;\n  // portal 的元素 ref\n  portalRef?: React.RefObject<HTMLElement>;\n  // 触发 portal 的元素 ref\n  triggerRef?: React.RefObject<HTMLElement>;\n  // 获取 portal 指定位置的自定义函数\n  getPosition?: GetPosition;\n  // 指定固定的 position（优先级高于 offset 和 getPosition）\n  position?: {\n    top: number;\n    left: number;\n  };\n  /**\n   * 面板最大宽度\n   */\n  maxWidth?: number;\n}\n\nexport class Portal extends React.Component<PortalProps> {\n  private triggerRef = React.createRef<HTMLDivElement>();\n\n  private portalRef = React.createRef<HTMLDivElement>();\n\n  private updatePortalPosition = throttle(() => {\n    const { visible, container, portalMatchTrigger, portalRef, triggerRef, getPosition, zoom = 1, maxWidth } = this.props;\n    if (!visible) {\n      return;\n    }\n\n    // eslint-disable-next-line react/no-find-dom-node\n    const trigger = ReactDOM.findDOMNode(\n      triggerRef ? triggerRef.current : this.triggerRef.current,\n    ) as HTMLDivElement;\n    // eslint-disable-next-line react/no-find-dom-node\n    const portal = ReactDOM.findDOMNode(\n      portalRef ? portalRef.current : this.portalRef.current,\n    ) as HTMLDivElement;\n    if (!trigger || !portal) {\n      return;\n    }\n\n    const triggerRect = trigger.getBoundingClientRect();\n    if (!triggerRect) {\n      return;\n    }\n\n    const { offset, position } = this.props;\n    const [offsetX, offsetY] = offset;\n    const containerRect = container.getBoundingClientRect();\n    const top = triggerRect.bottom - containerRect.top;\n    const left = triggerRect.left - containerRect.left;\n    const portalRect = portal.getBoundingClientRect();\n    const { height, width } = portalRect;\n\n    if (portalMatchTrigger) {\n      const width = maxWidth ? Math.min(maxWidth, triggerRect.width) : triggerRect.width;\n      portal.style.minWidth = `${width}px`;\n    }\n\n    /**\n     * zoom 场景下，left 和 top 需要乘以 zoom\n     * ┌────────┬────────────┐                      ┌──────────────┬───────────────┐\n     * │        │            │                      │              │               │\n     * │        │ left       │        zoom          │              │               │\n     * ├────────┘            │  ────────────────►   │              │ left * zoom   │\n     * │   top               │                      │              │               │\n     * │                     │                      ├──────────────┘               │\n     * │                     │                      │  top * zoom                  │\n     * └─────────────────────┘                      │                              │\n     *                                              │                              │\n     *                                              │                              │\n     *                                              └──────────────────────────────┘\n     * 我们这边使用 getBoundingClientRect 获取的是相对 viewport 的数据\n     * 在 zoom 情况下，需要除以 zoom 获得真实的 style 设置\n     * \n     * ┌────────┬────────────┐                      ┌──────────────┬───────────────┐\n     * │        │            │                      │              │               │\n     * │        │left / zoom │          zoom        │              │               │\n     * ├────────┘            │  ◄─────────────────  │              │ left          │\n     * │ top / zoom          │                      │              │               │\n     * │                     │                      ├──────────────┘               │\n     * │                     │                      │      top                     │\n     * └─────────────────────┘                      │                              │\n     *                                              │                              │\n     *                                              │                              │\n     *                                              └──────────────────────────────┘\n     */\n    /* 当有外部传入固定position时，优先采用position */\n    if (position) {\n      // position 的绝对位置，不受 zoom 影响\n      portal.style.top = `${position.top}px`;\n      portal.style.left = `${position.left}px`;\n    } else if (getPosition && typeof getPosition === 'function') {\n      const { left: computedLeft, top: computedTop } = getPosition(containerRect, triggerRect, portalRect);\n      portal.style.top = `${computedTop / zoom}px`;\n      portal.style.left = `${computedLeft / zoom}px`;\n    } else {\n      // 计算底部剩余空间，若剩余空间能够容纳 portal，则向下展示 portal\n      // 如果下方剩余空间无法容纳 portal，还需要判断上方空间能否容纳\n      // 若上方也无法容纳(triggerTop < height)，则仍然放到下方\n      // 左右则优先放右侧\n      const bottomSpace = containerRect.height - top;\n      const rightSpace = containerRect.width - left;\n      const triggerTop = triggerRect.top - containerRect.top;\n      const triggerRight = triggerRect.right - containerRect.left;\n      portal.style.top =\n        bottomSpace < height && triggerTop > height\n          ? `${(triggerTop + offsetY - height - 4) / zoom}px` // 放到上方\n          : `${(top + offsetY) / zoom}px`;\n      portal.style.left =\n        rightSpace < width && triggerRight > width\n          ? `${(left + offsetX - width - 4) / zoom}px`\n          : `${(left + offsetX) / zoom}px`;\n    }\n    portal.style.zIndex = '999';\n  });\n\n  static defaultProps = {\n    offset: [0, 0],\n    portalMatchTrigger: true,\n    className: '',\n    visible: false,\n  };\n\n  componentDidMount() {\n    this.updatePortalPosition();\n  }\n\n  componentDidUpdate() {\n    this.updatePortalPosition();\n  }\n\n  componentWillUnmount() {\n    this.updatePortalPosition.cancel();\n  }\n\n  render() {\n    const {\n      children,\n      container,\n      overlay,\n      className,\n      visible,\n      destroyOverlayOnHide = true,\n      portalRef,\n      triggerRef,\n    } = this.props;\n    return (\n      <React.Fragment>\n        {React.cloneElement(children as React.ReactElement, {\n          ref: triggerRef || this.triggerRef,\n        })}\n        {visible || !destroyOverlayOnHide\n          ? ReactDOM.createPortal(\n            <div className={className}>\n              {React.cloneElement(overlay, { ref: portalRef || this.portalRef })}\n            </div>,\n            container,\n          )\n          : null}\n      </React.Fragment>\n    );\n  }\n}\n"],"file":"index.js"}