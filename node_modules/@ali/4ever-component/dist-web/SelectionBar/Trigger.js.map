{"version":3,"sources":["../../../src/SelectionBar/Trigger.tsx"],"names":["React","ReactDOM","throttle","isElement","ResizeObserver","Controller","domUtils","useSelectionData","useSelectingHots","LEGAL_EVENT","findDOMNodeByKey","default","SelectionBar","SELECTION_BAR_HEIGHT","useSelectionBarContext","ActiveInteractionHooks","getTable","controller","value","document","selection","getClosest","getStart","key","n","query","useActiveInteraction","BasicPortal","props","children","container","createPortal","displayName","INITIAL_STATE","visible","placement","x","y","VIEWPORT_GAP","SELECTION_BAR_GAP","isBreakLine","clientRects","length","firstRect","i","rect","top","bottom","isTargetFromTableToolbar","target","getAttribute","isSelectedTableFirstRow","tableSelection","startRowIndex","isSelectedSingleTableRow","endRowIndex","CUSTOM_PANEL_INPUT_FLAG","Trigger","content","toolbarLayout","moreToolbarLayout","customToolButtons","context","canHide","boxRef","useRef","tableRef","transformRef","isRightMouseDown","useState","state","setState","alignRef","visibleRef","current","pressRef","contextMenuVisibleRef","activeRef","activeType","setActiveType","useMemo","TOOLBAR_ITEM_SIZE","SPACING","TABLE_ROW_TOOLBAR_HEIGHT","useEffect","display","useCallback","newSelection","domRange","findDOMRange","Array","from","getClientRects","tableRect","tablePos","contentRect","getBoundingClientRect","contentContainerDistance","offsetTop","clientRect","isSelectWholeRow","table","tableDOMNode","HTMLTableElement","querySelector","node","tblSelection","tableNode","scale","pos","width","height","left","isForward","isSelectRow","shouldFixOffsetTop","scrollTop","clientHeight","handleAnimationInStart","handleMouseDown","event","targetFromTableToolbar","button","prevState","handleMouseUp","isBlurred","isByTable","data","isCollapsed","handleMouseMove","hasOtherActiveInteraction","ref","Nearesetcontainer","containerRect","right","scrollBarWidth","offsetWidth","clientWidth","handleCustomEvent","e","detail","hideSelectionBar","isFocusInCustomColorPanel","activeElement","selectionData$","window","body","addEventListener","contextMenuVisible","removeEventListener","resizeObserver","handleResize","observe","disconnect","TriggerContainer","useController","getScrollableContainer","getScrollableContent","rest"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport * as ReactDOM from 'react-dom';\nimport { throttle, isElement } from 'lodash-es';\nimport ResizeObserver from 'resize-observer-polyfill';\nimport { Controller, domUtils, useSelectionData, useSelectingHots, Block } from '@ali/4ever-cangjie';\nimport { LEGAL_EVENT, findDOMNodeByKey } from '@ali/4ever-utils';\nimport {\n  default as SelectionBar,\n  SELECTION_BAR_HEIGHT,\n} from './SelectionBar';\nimport {\n  useSelectionBarContext,\n} from './context';\nimport {\n  ActiveInteractionHooks,\n} from '../HoverBlock/ActiveInteractionContext';\nimport type {\n  Placement,\n} from './SelectionBar';\nimport type { ToolLineProps } from '../NewToolbar/interface';\n\nconst getTable = (controller: Controller): Block | null => {\n  const { document, selection } = controller.value;\n  return document.getClosest(selection.getStart(document).key, (n) => {\n    return !!controller.query('isTable', n);\n  }) as Block || null;\n};\n\nconst { useActiveInteraction } = ActiveInteractionHooks;\n\nexport interface PortalProps {\n  /**\n   * 挂载容器\n   */\n  container: Element;\n\n  key?: string;\n}\n\n/**\n * 使用 ReactDOM.createPortal 渲染节点\n * @param props\n * @returns\n */\nexport const BasicPortal: React.FC<PortalProps> = (props) => {\n  const { children, container, key } = props;\n\n  return ReactDOM.createPortal(children, container, key);\n};\n\nBasicPortal.displayName = 'Portal';\n\nexport interface TriggerProps {\n  /**\n   * 编辑器 Controller\n   */\n  controller: Controller;\n  /**\n   * 文档滚动容器\n   */\n  container: HTMLElement;\n  /**\n   * 文档正文\n   */\n  content: HTMLElement;\n  /**\n   * 外层工具栏插件配置\n   */\n  toolbarLayout: ToolLineProps[];\n  /**\n   * 更多工具栏插件配置\n   */\n  moreToolbarLayout?: ToolLineProps[];\n  /**\n   * 自定义按钮\n   */\n  customToolButtons?: Record<string, any>;\n}\n\ninterface TriggerState {\n  visible: boolean;\n  placement: Placement;\n  x: number;\n  y: number;\n}\n\ninterface Pos {\n  top: number;\n  left: number;\n  width: number;\n  height: number;\n}\n\nconst INITIAL_STATE: TriggerState = {\n  visible: false,\n  placement: 'top',\n  x: 0,\n  y: 0,\n};\n\n/**\n * 工具栏视口边距\n */\nconst VIEWPORT_GAP = 4;\n\n/**\n * SelectionBar 与文字之间的距离\n */\nconst SELECTION_BAR_GAP = 8;\n\n/**\n * 判断一组选区是否有换行\n * @param clientRects\n */\nfunction isBreakLine(clientRects: DOMRect[]): boolean {\n  // 如果只有单选区，则一定没有换行\n  if (clientRects.length <= 1) {\n    return false;\n  }\n  const firstRect = clientRects[0];\n  for (let i = 1; i < clientRects.length; i++) {\n    const rect = clientRects[i];\n    // 如果存在选区块错层，则断定存在换行\n    if (rect.top >= firstRect.bottom || rect.bottom <= firstRect.top) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * 判断选区是否由表格工具栏操作，注释见下方\n * 解决从表格工具栏点击，表格选区变化时，极简工具栏位置不变的问题\n * 之前花过一些时间尝试从表格选区数据 diff 下手\n * 但无可避免的产生了一些误伤，例如在表格选区下调整字体大小，在一些操作后会使极简工具栏抖动\n * 所以改为从 UI 判定下手\n */\nfunction isTargetFromTableToolbar(target?: HTMLElement | null) {\n  if (!target) {\n    return false;\n  }\n  return target.getAttribute('data-cangjie-col-toolbar-item') ||\n    target.getAttribute('data-cangjie-row-toolbar-item') ||\n    target.getAttribute('data-cangjie-cornel-toolbar');\n}\n\n/**\n * 由于表格边缘有行列工具栏的存在，因此为了避免toolbar遮挡住工具栏，需要将其往上抬升8个px\n * 满足以下两个条件时需要抬升\n * 1. 选中首行\n * 2. 选中一列或多列\n */\nfunction isSelectedTableFirstRow(tableSelection: any) {\n  const { startRowIndex } = tableSelection;\n  return startRowIndex === 0;\n}\n\n/**\n * 判断是否是选中表格行\n * 背景：选中行的时候工具栏位于行头右侧8px处\n * 多行的情况工具栏居于上方中部位置也是更符合用户习惯\n */\nfunction isSelectedSingleTableRow(tableSelection: any) {\n  const { startRowIndex, endRowIndex } = tableSelection;\n  return startRowIndex === endRowIndex;\n}\n\nconst CUSTOM_PANEL_INPUT_FLAG = 'custom-color-input';\n\nconst Trigger: React.FC<TriggerProps> = (props) => {\n  const {\n    controller,\n    content,\n    container,\n    toolbarLayout,\n    moreToolbarLayout,\n    customToolButtons,\n  } = props;\n\n  const [context] = useSelectionBarContext();\n  const { canHide } = context;\n  const boxRef = React.useRef<HTMLDivElement>(null);\n  const tableRef = React.useRef<HTMLDivElement | null>(null);\n  const transformRef = React.useRef<boolean>(true);\n  // 右键呼出菜单的时候需要隐藏工具栏\n  const isRightMouseDown = React.useRef<boolean>(false);\n  const { value } = controller;\n\n  const [state, setState] = React.useState<TriggerState>(INITIAL_STATE);\n  // 是否修正定位\n  const alignRef = React.useRef(false);\n  // 工具栏可见性\n  const visibleRef = React.useRef(state.visible);\n  visibleRef.current = state.visible;\n  // 当前鼠标是否按住\n  const pressRef = React.useRef(false);\n  // 当前右键菜单是否可见\n  const contextMenuVisibleRef = React.useRef(false);\n\n  const activeRef = React.useRef('');\n  const [activeType, setActiveType] = useActiveInteraction();\n  activeRef.current = activeType;\n\n  // table constants\n  const { TOOLBAR_ITEM_SIZE: TABLE_ROW_TOOLBAR_HEIGHT, SPACING } = React.useMemo(() => {\n    return controller.query('getTableConstants') || {\n      /**\n       * 表格行工具栏高度\n       * 为避免toolbar遮挡表格行工具栏，SelectionBar 选中表格首行时需要向上偏移该高度\n       */\n      TOOLBAR_ITEM_SIZE: 8,\n      SPACING: 16,\n    };\n  }, [controller]);\n\n  React.useEffect(() => {\n    // 选区工具栏可见时更新当前激活的类型\n    if (state.visible) {\n      activeRef.current !== 'selectionBar' && setActiveType('selectionBar');\n    } else if (activeRef.current === 'selectionBar') {\n      setActiveType('');\n    }\n  }, [state.visible, setActiveType]);\n\n  /**\n   * 展示选区工具栏\n   * @description 非重叠光标选区渲染工具栏，由于工具栏高度固定，所以挂载时可以订正垂直位置\n   */\n  const display = React.useCallback(() => {\n    const { selection: newSelection, document } = controller.value;\n    // 如果 Range 不存在则不处理\n    // TODO: 在 void 元素的场景下和选区的范围不之一，后续考虑使用视图上 range 的大小\n    const domRange = domUtils.findDOMRange(newSelection, controller, content);\n    // 右键菜单显示的情况下不展示工具栏\n    if (!domRange || isRightMouseDown.current || contextMenuVisibleRef.current) {\n      return;\n    }\n\n    const clientRects = Array.from(domRange.getClientRects());\n    if (clientRects.length <= 0) {\n      return;\n    }\n\n    const tableSelection = controller.query('getTableSelection');\n    let tableRect: DOMRect | null = null;\n    let tablePos: Pos | undefined | null;\n\n    const contentRect = content.getBoundingClientRect();\n    const contentContainerDistance = content.offsetTop - container.offsetTop;\n\n    // 定位方向\n    let placement: Placement;\n    // x 偏移量\n    let x: number;\n    // y 偏移量\n    let y: number;\n    // 光标落点 Range Rect (Focus Range Rect)\n    let clientRect: DOMRect;\n    let isSelectWholeRow = false;\n    /**\n     * 产品要求在表格中选中文字浮动工具栏尽量不要超出表格的左右区域\n     * 这里的解决办法是如果在表格中选中文字就把当前表格的dom对象保\n     * 存到tableRef中，在进行位置修正的时候如果tableRef不为null\n     * 则使用tableRef作为contanier进行位置修正，否则使用传入的contaner\n     * 进行位置修正\n     */\n    if (controller.query('isSelectionInTableCell') || tableSelection) {\n      const table = getTable(controller);\n      const tableDOMNode = table && findDOMNodeByKey(table.key) as HTMLDivElement;\n      if (table && tableDOMNode) {\n        tableRef.current = tableDOMNode;\n      }\n    } else {\n      // 不在表格中选区的时候需要初始化tableRef，使其在位置修正的时候使用传入的container进行修正\n      tableRef.current = null;\n    }\n\n    if (tableSelection && !controller.query('isSelectionInTableCell')) {\n      const table = getTable(controller);\n      let tableDOMNode = table && findDOMNodeByKey(table.key) as HTMLElement;\n      if (tableDOMNode && !(tableDOMNode instanceof HTMLTableElement)) {\n        tableDOMNode = tableDOMNode.querySelector('table') as HTMLTableElement;\n      }\n      if (table && tableDOMNode) {\n        isSelectWholeRow = !!controller.query('isSelectWholeRow', {\n          // @ts-ignore\n          node: table,\n        });\n        // 表格的选区计算逻辑，TODO: scale 计算\n        tablePos = controller.query('calcTableSelectionPos', {\n          tblSelection: tableSelection,\n          // @ts-ignore\n          table,\n          tableNode: tableDOMNode as HTMLTableElement,\n          scale: 1,\n        });\n        tableRect = tableDOMNode.getBoundingClientRect();\n      }\n    }\n\n    if (tableRect && tableSelection && tablePos) {\n      const pos = tablePos;\n      clientRect = {\n        ...tableRect,\n        width: tablePos.width,\n        height: tablePos.height,\n        left: tableRect.x + pos.left,\n        x: tableRect.x + pos.left,\n        top: tableRect.y + pos.top,\n        y: tableRect.y + pos.top,\n      };\n      // 第一行被选中遮挡工具栏，强制置于下方，其他情况下依据选区方向\n      if (newSelection.isForward(document)) {\n        placement = 'bottom';\n        const isSelectRow = isSelectedSingleTableRow(tableSelection) && isSelectWholeRow;\n        if (isSelectRow) {\n          // 选中行的时候浮动工具栏位置位于选中行头工具栏右侧\n          x = tableRect.x - contentRect.x;\n          transformRef.current = false;\n          tableRef.current = null;\n        } else {\n          x = tableRect.x + pos.left + pos.width / 2 - contentRect.x;\n          transformRef.current = true;\n        }\n        y = tableRect.y + pos.top + pos.height - contentRect.y;\n        y += SELECTION_BAR_GAP;\n      } else {\n        placement = 'top';\n        const shouldFixOffsetTop = isSelectedTableFirstRow(tableSelection);\n        const isSelectRow = isSelectedSingleTableRow(tableSelection) && isSelectWholeRow;\n        if (isSelectRow) {\n          // 选中行的时候浮动工具栏位置位于选中行头工具栏右侧\n          x = tableRect.x - contentRect.x;\n          transformRef.current = false;\n          tableRef.current = null;\n        } else {\n          x = tableRect.x + pos.left + pos.width / 2 - contentRect.x;\n          transformRef.current = true;\n        }\n        y = tableRect.y + pos.top - contentRect.y;\n        y -= SELECTION_BAR_GAP;\n        if (shouldFixOffsetTop) {\n          // 选中第一行时不能遮挡表格插入按钮\n          y -= TABLE_ROW_TOOLBAR_HEIGHT * 2 + SPACING;\n        }\n      }\n    } else if (newSelection.isForward(document)) {\n      clientRect = clientRects[clientRects.length - 1];\n      if (isBreakLine(clientRects)) {\n        placement = 'bottom';\n        x = clientRect.x + clientRect.width - contentRect.x;\n        y = clientRect.y + clientRect.height - contentRect.y;\n        y += SELECTION_BAR_GAP;\n      } else {\n        placement = 'top';\n        x = clientRect.x + clientRect.width - contentRect.x;\n        y = clientRect.y - contentRect.y;\n        y -= SELECTION_BAR_GAP;\n      }\n    } else {\n      clientRect = clientRects[0];\n      placement = 'top';\n      x = clientRect.x - contentRect.x;\n      y = clientRect.y - contentRect.y;\n      y -= SELECTION_BAR_GAP;\n    }\n\n    /**\n     * 若定位超出视口上方，则平移至当前 clientRect 下方\n     */\n    if (placement === 'top' && y + contentContainerDistance - SELECTION_BAR_HEIGHT - VIEWPORT_GAP < container.scrollTop) {\n      placement = 'bottom';\n      y = clientRect.y + clientRect.height - contentRect.y;\n      y += SELECTION_BAR_GAP;\n    }\n\n    /**\n     * 若定位超出视口下方，则平移至当前 clientRect 上方\n     */\n    if (placement === 'bottom' && y + contentContainerDistance + SELECTION_BAR_HEIGHT + VIEWPORT_GAP > container.scrollTop + container.clientHeight) {\n      placement = 'top';\n      y = clientRect.y - contentRect.y;\n      y -= SELECTION_BAR_GAP;\n      // table 不平移，暂时不展示\n      // if (tableSelection && tableSelection.startRowIndex === 0) {\n      //   return;\n      // }\n    }\n\n    // 开启定位偏移修正\n    alignRef.current = true;\n\n    setState({\n      visible: true,\n      placement,\n      x,\n      y,\n    });\n  }, [container, content, controller]);\n\n  // value 变化后，修正位置\n  React.useEffect(() => {\n    if (boxRef?.current) {\n      alignRef.current = true;\n      handleAnimationInStart(boxRef.current);\n    }\n  }, [value]);\n\n  const handleMouseDown = React.useCallback((event: MouseEvent) => {\n    const targetFromTableToolbar = isTargetFromTableToolbar(event.target as HTMLElement);\n    pressRef.current = true;\n    // 需要与右键菜单互斥，因此这里判断鼠标点击事件是否为右键，是的话则不显示工具栏\n    isRightMouseDown.current = event.button === 2;\n    // 在点击表格工具栏 mouseDown 时选区消失，mouseUp 时再出现\n    // 一定要完整的执行 消失 -> 出现 这个闭环，才能触发选区动画，以及位置校正逻辑\n    // 这是最简单有效的做法，其他做法容易让时序乱套，或者把代码改乱\n    if (targetFromTableToolbar || isRightMouseDown.current) {\n      setState((prevState) => ({ ...prevState, visible: false }));\n    }\n  }, []);\n\n  const handleMouseUp = React.useCallback(() => {\n    pressRef.current = false;\n    const { selection, isBlurred } = controller.value;\n    const { isByTable } = selection.data;\n    // 通过工具栏选中仅一个单元格时，selection.isCollapsed 为 true，需要额外处理\n    const isCollapsed = selection.isCollapsed && !isByTable;\n\n    // 选中列表符号，显示工具栏\n    if (controller.query('isSelectionInListSymbol')) {\n      display();\n      return;\n    }\n    // 重叠光标选区不处理\n    if (isBlurred || isCollapsed || visibleRef.current) {\n      return;\n    }\n    display();\n  }, [controller, display]);\n\n  const handleMouseMove = React.useCallback(throttle(() => {\n    if (pressRef.current) {\n      return;\n    }\n    // 有其他类型激活时，不触发选区工具栏\n    const hasOtherActiveInteraction = activeRef.current && activeRef.current !== 'selectionBar';\n    const { selection, isBlurred } = controller.value;\n    // 重叠光标选区不处理\n    if (isBlurred || selection.isCollapsed || visibleRef.current || hasOtherActiveInteraction) {\n      return;\n    }\n    display();\n  }), [controller, display]);\n\n  /**\n   * 工具栏渲染前，订正 X 偏移量\n   */\n  const handleAnimationInStart = React.useCallback((ref: HTMLElement | null) => {\n    if (!ref || !alignRef.current) {\n      return;\n    }\n    const Nearesetcontainer = tableRef.current ? tableRef.current : container;\n    const containerRect = Nearesetcontainer.getBoundingClientRect();\n    const contentRect = content.getBoundingClientRect();\n    const rect = ref.getBoundingClientRect();\n    // 超出左侧\n    if (rect.left - VIEWPORT_GAP < containerRect.left) {\n      const x = containerRect.left - contentRect.left + (rect.width / 2) + VIEWPORT_GAP;\n      setState((prevState) => ({ ...prevState, x }));\n    }\n\n    // 超出右侧\n    if (rect.right + VIEWPORT_GAP > containerRect.right) {\n      const scrollBarWidth = Nearesetcontainer.offsetWidth - Nearesetcontainer.clientWidth;\n      setState((prevState) => ({\n        ...prevState,\n        x: prevState.x - (rect.right - containerRect.right) - scrollBarWidth - VIEWPORT_GAP,\n      }));\n    }\n\n    // 禁止定位偏移修正\n    alignRef.current = false;\n  }, [container, content]);\n\n  /**\n   * 处理自定义事件（右键菜单显示隐藏）\n   */\n  const handleCustomEvent = React.useCallback((e: any) => {\n    const { visible } = e.detail;\n    contextMenuVisibleRef.current = visible;\n  }, []);\n\n  const { visible, placement, x, y } = state;\n\n  const hideSelectionBar = () => {\n    const { selection, isBlurred } = controller.value;\n    // 通过工具栏选中仅一个单元格时，selection.isCollapsed 为 true，需要额外处理\n    const isCollapsed = selection.isCollapsed && !selection.data.isByTable;\n\n    // 当 focus 到 自定义色板的输入框时, selectionBar 不隐藏\n    const isFocusInCustomColorPanel = document.activeElement?.getAttribute('data-testid') === CUSTOM_PANEL_INPUT_FLAG;\n\n    // fix: https://aone.alibaba-inc.com/v2/bug/36320509# 《选中文字点击空白处无法取消选中\n    if (\n      canHide &&\n      visible &&\n      (isCollapsed || isBlurred) &&\n      !controller.query('isSelectionInListSymbol') &&\n      !isFocusInCustomColorPanel\n    ) {\n      setState((prevState) => ({ ...prevState, visible: false }));\n    }\n  };\n\n  /**\n   * 选区折叠则隐藏工具栏\n   */\n  React.useEffect(hideSelectionBar);\n\n  // 响应 pending selection 和 普通 selection 变化实时更新\n  useSelectionData(controller.selectionData$, null, hideSelectionBar, [controller.value.selection]);\n  useSelectingHots(controller, hideSelectionBar);\n\n  React.useEffect(() => {\n    // 监听contextMenuVisible变化需要挂载body上，因为事件源无法绑定到content上\n    window.document.body.addEventListener(LEGAL_EVENT.contextMenuVisible, handleCustomEvent, true);\n    content.addEventListener('mousedown', handleMouseDown, true);\n    content.addEventListener('mouseup', handleMouseUp, true);\n    content.addEventListener('mousemove', handleMouseMove, true);\n    return () => {\n      window.document.body.removeEventListener(LEGAL_EVENT.contextMenuVisible, handleCustomEvent, true);\n      content.removeEventListener('mousedown', handleMouseDown, true);\n      content.removeEventListener('mouseup', handleMouseUp, true);\n      content.removeEventListener('mousemove', handleMouseMove, true);\n    };\n  }, [content, handleMouseDown, handleMouseMove, handleMouseUp, handleCustomEvent]);\n\n  // 容器内容高度变化后，需要重新计算工具栏的位置\n  React.useEffect(() => {\n    let resizeObserver: ResizeObserver | undefined;\n    const handleResize = throttle(() => {\n      display();\n      handleAnimationInStart(boxRef.current);\n    }, 50);\n    if (visible && content && isElement(content)) {\n      resizeObserver = new ResizeObserver(handleResize);\n      resizeObserver.observe(content);\n    }\n\n    return () => {\n      resizeObserver?.disconnect();\n    };\n  }, [visible, content, display, handleAnimationInStart]);\n\n  return (\n    <BasicPortal container={content}>\n      <SelectionBar\n        needTransform={transformRef.current}\n        ref={boxRef}\n        toolbarLayout={toolbarLayout}\n        moreToolbarLayout={moreToolbarLayout}\n        onAnimationInStart={handleAnimationInStart}\n        controller={controller}\n        content={content}\n        visible={visible}\n        placement={placement}\n        x={x}\n        y={y}\n        customToolButtons={customToolButtons}\n      />\n    </BasicPortal>\n  );\n};\n\nTrigger.displayName = 'Trigger';\n\nexport interface ContainerProps {\n  /**\n   * 获取编辑器挂载的滚动容器\n   */\n  getScrollableContainer: () => HTMLElement | null;\n  /**\n   * 获取文档正文 DOM\n   */\n  getScrollableContent: () => HTMLElement | null;\n  /**\n   * 外层工具栏插件配置\n   */\n  toolbarLayout: ToolLineProps[];\n  /**\n  * 更多工具栏插件配置\n  */\n  moreToolbarLayout?: ToolLineProps[];\n}\n\nconst TriggerContainer: React.FC<ContainerProps> = (props) => {\n  const controller = Controller.useController();\n  const {\n    getScrollableContainer,\n    getScrollableContent,\n    ...rest\n  } = props;\n\n  const container = getScrollableContainer();\n  const content = getScrollableContent();\n\n  if (!container || !content) {\n    return null;\n  }\n\n  return (\n    <Trigger\n      {...rest}\n      container={container}\n      content={content}\n      controller={controller}\n    />\n  );\n};\n\nTriggerContainer.displayName = 'TriggerContainer';\n\nexport default TriggerContainer;\n"],"file":"Trigger.js"}