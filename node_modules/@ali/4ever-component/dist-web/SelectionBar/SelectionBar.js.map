{"version":3,"sources":["../../../src/SelectionBar/SelectionBar.tsx"],"names":["React","zIndex","styled","keyframes","SimpleToolbar","InlineFloatToolbar","NewToolbarMode","ToolbarMode","noop","mountSelectionToolbar","tableRowSlideInBottom","tableRowSlideOutBottom","tableRowSlideInTop","tableRowSlideOutTop","slideInTop","slideOutTop","slideInBottom","slideOutBottom","SelectionBarBox","div","BI_FLOAT_TOOLBAR_Z_INDEX","props","top","left","height","needTransform","getAnimation","placement","visible","usePartialState","initialState","useState","state","setState","setPartialState","useCallback","nextState","prevState","INITIAL_STATE","internalVisible","animate","SELECTION_BAR_HEIGHT","SelectionBar","forwardRef","ref","toolbarLayout","moreToolbarLayout","x","y","content","onAnimationInStart","onAnimationInEnd","onAnimationOutStart","onAnimationOutEnd","controller","customToolButtons","boxRef","useRef","useEffect","current","useLayoutEffect","run","handleAnimationEnd","offsetY","className","single","displayName"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { Controller } from '@ali/4ever-cangjie';\nimport { zIndex } from '@ali/4ever-utils';\nimport styled, { keyframes } from 'styled-components';\nimport { SimpleToolbar as InlineFloatToolbar, NewToolbarMode as ToolbarMode, NewToolLineProps as ToolLineProps } from '../NewToolbar';\n\nimport { noop } from 'lodash-es';\nimport { mountSelectionToolbar } from './reducer';\n\nconst tableRowSlideInBottom = keyframes`\n  0% {\n    opacity: 0;\n    transform: translate(0%, -50%);\n  }\n  90% {\n    opacity: 1;\n    transform: translate(0%, -5%);\n  }\n  100% {\n    opacity: 1;\n    transform: translate(0%, 0%);\n  }\n`;\n\n\nconst tableRowSlideOutBottom = keyframes`\n  0% {\n    opacity: 1;\n    transform: translate(0, 0);\n  }\n  100% {\n    opacity: 0;\n    transform: translate(0, 50%);\n  }\n`;\n\nconst tableRowSlideInTop = keyframes`\n  0% {\n    opacity: 0;\n    transform: translate(0, -50%);\n  }\n  90% {\n    opacity: 1;\n    transform: translate(0, -5%);\n  }\n  100% {\n    opacity: 1;\n    transform: translate(0);\n  }\n`;\n\nconst tableRowSlideOutTop = keyframes`\n  0% {\n    opacity: 1;\n    transform: translate(0);\n  }\n  100% {\n    opacity: 0;\n    transform: translate(0, -50%);\n  }\n`;\n\nconst slideInTop = keyframes`\n  0% {\n    opacity: 0;\n    transform: translate(-50%, -50%);\n  }\n  90% {\n    opacity: 1;\n    transform: translate(-50%, -5%);\n  }\n  100% {\n    opacity: 1;\n    transform: translate(-50%);\n  }\n`;\n\nconst slideOutTop = keyframes`\n  0% {\n    opacity: 1;\n    transform: translate(-50%);\n  }\n  100% {\n    opacity: 0;\n    transform: translate(-50%, 30%);\n  }\n`;\n\nconst slideInBottom = keyframes`\n  0% {\n    opacity: 0;\n    transform: translate(-50%, -50%);\n  }\n  90% {\n    opacity: 1;\n    transform: translate(-50%, 5%);\n  }\n  100% {\n    opacity: 1;\n    transform: translate(-50%);\n  }\n`;\n\nconst slideOutBottom = keyframes`\n  0% {\n    opacity: 1;\n    transform: translate(-50%);\n  }\n  100% {\n    opacity: 0;\n    transform: translate(-50%, -30%);\n  }\n`;\n\ninterface BoxProps {\n  top: number;\n  left: number;\n  height: number;\n  needTransform: boolean;\n}\n\nconst SelectionBarBox = styled.div<BoxProps>`\n  position: absolute;\n  z-index: ${zIndex.BI_FLOAT_TOOLBAR_Z_INDEX};\n  top: ${(props) => props.top}px;\n  left: ${(props) => props.left}px;\n  height: ${(props) => props.height}px;\n  width: fit-content;\n  transform: ${(props) => (props.needTransform ? 'translate(-50%, 0)' : 'none')};\n  /* Light/fg_color */\n  background: #FFFFFF;\n  /* /Shadow_Doc_M */\n  box-shadow: 0px 0px 1px rgba(0, 0, 0, 0.24), 0px 8px 24px rgba(0, 0, 0, 0.16);\n  border-radius: 4px;\n  display: flex;\n  align-items: center;\n  padding: 0;\n\n  &.table-row-slide-in-bottom {\n    animation-duration: 0.2s;\n    animation-timing-function: ease-out;\n    animation-name: ${tableRowSlideInBottom};\n  }\n\n  &.table-row-slide-out-bottom {\n    animation-duration: 0.2s;\n    animation-timing-function: ease-out;\n    animation-name: ${tableRowSlideOutBottom};\n  }\n\n  &.table-row-slide-in-top {\n    animation-duration: 0.2s;\n    animation-timing-function: ease-out;\n    animation-name: ${tableRowSlideInTop};\n  }\n\n  &.table-row-slide-out-top {\n    animation-duration: 0.2s;\n    animation-timing-function: ease-out;\n    animation-name: ${tableRowSlideOutTop};\n  }\n\n  &.slide-in-top {\n    animation-duration: 0.2s;\n    animation-timing-function: ease-out;\n    animation-name: ${slideInTop};\n  }\n\n  &.slide-out-top {\n    animation-name: ${slideOutTop};\n    animation-duration: 0.2s;\n    animation-timing-function: ease;\n  }\n\n  &.slide-in-bottom {\n    animation-duration: 0.2s;\n    animation-timing-function: ease-out;\n    animation-name: ${slideInBottom};\n  }\n\n  &.slide-out-bottom {\n    animation-name: ${slideOutBottom};\n    animation-duration: 0.2s;\n    animation-timing-function: ease;\n  }\n`;\n\nexport type Placement = 'top' | 'bottom';\n\nexport interface SelectionBarProps {\n  /**\n   * 编辑器 Controller\n   */\n  controller: Controller;\n  /**\n   * SelectionBar 是否可见\n   */\n  visible: boolean;\n  /**\n   * 外层工具栏插件配置\n   */\n  toolbarLayout: ToolLineProps[];\n  /**\n   * 更多工具栏插件配置\n   */\n  moreToolbarLayout?: ToolLineProps[];\n  /**\n   * SelectionBar 定位方向\n   */\n  placement: Placement;\n  /**\n   * 定位容器\n   */\n  content: HTMLElement;\n  /**\n   * left 定位\n   */\n  x: number;\n  /**\n   * top 定位\n   */\n  y: number;\n  /**\n   * 组件进入开始时动画\n   */\n  onAnimationInStart?: (ref: HTMLElement| null) => void;\n  /**\n   * 组件进入结束时动画\n   */\n  onAnimationInEnd?: (ref: HTMLElement | null) => void;\n  /**\n   * 组件离开开始时动画\n   */\n  onAnimationOutStart?: (ref: HTMLElement | null) => void;\n  /**\n   * 组件离开结束时动画\n   */\n  onAnimationOutEnd?: () => void;\n  /**\n   * 选中表格行的时候需要把工具栏置于表格行工具头右侧，但是拿不到Selectionbar的宽度，无法计算确切left。必须禁用transform\n   */\n  needTransform: boolean;\n  customToolButtons?: Record<string, any>;\n}\n\nfunction getAnimation(placement: Placement, visible: boolean, needTransform: boolean) {\n  if (placement === 'top') {\n    if (visible) {\n      if (!needTransform) {\n        return 'table-row-slide-in-top';\n      }\n      return 'slide-in-top';\n    } else {\n      if (!needTransform) {\n        return 'table-row-slide-out-top';\n      }\n      return 'slide-out-top';\n    }\n  }\n\n  if (visible) {\n    if (!needTransform) {\n      return 'table-row-slide-in-bottom';\n    }\n    return 'slide-in-bottom';\n  } else {\n    if (!needTransform) {\n      return 'table-row-slide-out-bottom';\n    }\n    return 'slide-out-bottom';\n  }\n}\n\nfunction usePartialState<T extends object>(initialState: T): [T, React.Dispatch<Partial<T>>] {\n  const [state, setState] = React.useState(initialState);\n  const setPartialState = React.useCallback<React.Dispatch<Partial<T>>>((nextState) => {\n    setState((prevState) => {\n      return {\n        ...prevState,\n        ...nextState,\n      };\n    });\n  }, []);\n  return [state, setPartialState];\n}\n\ninterface SelectionBarState {\n  internalVisible: boolean;\n  animate: boolean;\n}\n\nconst INITIAL_STATE: SelectionBarState = {\n  internalVisible: false,\n  animate: false,\n};\n\n/**\n * SelectionBar 高度\n */\nexport const SELECTION_BAR_HEIGHT = 36;\n\nconst SelectionBar = React.forwardRef<HTMLDivElement, SelectionBarProps>((props, ref) => {\n  const {\n    visible,\n    placement,\n    toolbarLayout,\n    moreToolbarLayout,\n    x,\n    y,\n    content,\n    onAnimationInStart = noop,\n    onAnimationInEnd = noop,\n    onAnimationOutStart = noop,\n    onAnimationOutEnd = noop,\n    needTransform,\n    controller,\n    customToolButtons,\n  } = props;\n\n  const [state, setState] = usePartialState(INITIAL_STATE);\n  const boxRef = React.useRef<HTMLDivElement>(null);\n\n  const {\n    internalVisible,\n    animate,\n  } = state;\n\n  React.useEffect(() => {\n    if (typeof ref === 'function') {\n      ref(boxRef.current);\n    } else if (ref) {\n      ref.current = boxRef.current;\n    }\n  });\n\n  React.useEffect(() => {\n    if (visible && !internalVisible) {\n      // 激活工具栏\n      setState({\n        internalVisible: true,\n        animate: true,\n      });\n    } else if (!visible && internalVisible) {\n      // 关闭工具栏：先展示动画，再注销组件\n      setState({\n        animate: true,\n      });\n    }\n  }, [internalVisible, setState, visible]);\n\n  React.useLayoutEffect(() => {\n    if (visible && animate) {\n      // 这里不合理但目前测试是最准确的，先通过这里报，再梳理\n      controller.run('onAction', mountSelectionToolbar());\n      onAnimationInStart(boxRef.current);\n    } else if (visible && !animate) {\n      onAnimationInEnd(boxRef.current);\n    } else if (!visible && animate) {\n      onAnimationOutStart(boxRef.current);\n    } else if (!visible && !animate) {\n      onAnimationOutEnd();\n    }\n  }, [visible, animate, onAnimationInStart, onAnimationInEnd, onAnimationOutStart, onAnimationOutEnd]);\n\n  const handleAnimationEnd = React.useCallback(() => {\n    if (visible) {\n      // 可见状态下，注销动画效果\n      setState({\n        animate: false,\n      });\n    } else {\n      // 不可见状态下，销毁组件\n      setState({\n        animate: false,\n        internalVisible: false,\n      });\n    }\n  }, [setState, visible]);\n\n  const offsetY = placement === 'bottom' ? y : y - SELECTION_BAR_HEIGHT;\n\n  if (!internalVisible) {\n    return null;\n  }\n\n  const className = animate ? getAnimation(placement, visible, needTransform) : '';\n\n  return (\n    <SelectionBarBox\n      needTransform={needTransform}\n      ref={boxRef}\n      top={offsetY}\n      left={x}\n      height={SELECTION_BAR_HEIGHT}\n      className={className}\n      onAnimationEnd={handleAnimationEnd}\n      data-testid=\"selection-bar\"\n    >\n      <InlineFloatToolbar\n        container={content}\n        toolbarMode={ToolbarMode.single}\n        singleLayout={toolbarLayout}\n        moreSingleLayout={moreToolbarLayout}\n        customToolButtons={customToolButtons}\n      />\n    </SelectionBarBox>\n  );\n});\n\nSelectionBar.displayName = 'SelectionBar';\n\nexport default SelectionBar;\n"],"file":"SelectionBar.js"}