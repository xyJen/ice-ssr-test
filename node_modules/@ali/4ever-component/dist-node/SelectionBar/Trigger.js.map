{"version":3,"sources":["../../../src/SelectionBar/Trigger.tsx"],"names":["getTable","controller","document","selection","value","getClosest","getStart","key","n","query","useActiveInteraction","ActiveInteractionHooks","BasicPortal","props","children","container","ReactDOM","createPortal","displayName","INITIAL_STATE","visible","placement","x","y","VIEWPORT_GAP","SELECTION_BAR_GAP","isBreakLine","clientRects","length","firstRect","i","rect","top","bottom","isTargetFromTableToolbar","target","getAttribute","isSelectedTableFirstRow","tableSelection","startRowIndex","isSelectedSingleTableRow","endRowIndex","CUSTOM_PANEL_INPUT_FLAG","Trigger","content","toolbarLayout","moreToolbarLayout","customToolButtons","context","canHide","boxRef","React","useRef","tableRef","transformRef","isRightMouseDown","state","setState","useState","alignRef","visibleRef","current","pressRef","contextMenuVisibleRef","activeRef","activeType","setActiveType","TOOLBAR_ITEM_SIZE","TABLE_ROW_TOOLBAR_HEIGHT","SPACING","useMemo","useEffect","display","useCallback","newSelection","domRange","domUtils","findDOMRange","Array","from","getClientRects","tableRect","tablePos","contentRect","getBoundingClientRect","contentContainerDistance","offsetTop","clientRect","isSelectWholeRow","table","tableDOMNode","HTMLTableElement","querySelector","node","tblSelection","tableNode","scale","pos","width","height","left","isForward","isSelectRow","shouldFixOffsetTop","SELECTION_BAR_HEIGHT","scrollTop","clientHeight","handleAnimationInStart","handleMouseDown","event","targetFromTableToolbar","button","prevState","handleMouseUp","isBlurred","isByTable","data","isCollapsed","handleMouseMove","hasOtherActiveInteraction","ref","Nearesetcontainer","containerRect","right","scrollBarWidth","offsetWidth","clientWidth","handleCustomEvent","e","detail","hideSelectionBar","isFocusInCustomColorPanel","activeElement","selectionData$","window","body","addEventListener","LEGAL_EVENT","contextMenuVisible","removeEventListener","resizeObserver","handleResize","ResizeObserver","observe","disconnect","TriggerContainer","Controller","useController","getScrollableContainer","getScrollableContent","rest"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport * as ReactDOM from 'react-dom';\nimport { throttle, isElement } from 'lodash-es';\nimport ResizeObserver from 'resize-observer-polyfill';\nimport { Controller, domUtils, useSelectionData, useSelectingHots, Block } from '@ali/4ever-cangjie';\nimport { LEGAL_EVENT, findDOMNodeByKey } from '@ali/4ever-utils';\nimport {\n  default as SelectionBar,\n  SELECTION_BAR_HEIGHT,\n} from './SelectionBar';\nimport {\n  useSelectionBarContext,\n} from './context';\nimport {\n  ActiveInteractionHooks,\n} from '../HoverBlock/ActiveInteractionContext';\nimport type {\n  Placement,\n} from './SelectionBar';\nimport type { ToolLineProps } from '../NewToolbar/interface';\n\nconst getTable = (controller: Controller): Block | null => {\n  const { document, selection } = controller.value;\n  return document.getClosest(selection.getStart(document).key, (n) => {\n    return !!controller.query('isTable', n);\n  }) as Block || null;\n};\n\nconst { useActiveInteraction } = ActiveInteractionHooks;\n\nexport interface PortalProps {\n  /**\n   * 挂载容器\n   */\n  container: Element;\n\n  key?: string;\n}\n\n/**\n * 使用 ReactDOM.createPortal 渲染节点\n * @param props\n * @returns\n */\nexport const BasicPortal: React.FC<PortalProps> = (props) => {\n  const { children, container, key } = props;\n\n  return ReactDOM.createPortal(children, container, key);\n};\n\nBasicPortal.displayName = 'Portal';\n\nexport interface TriggerProps {\n  /**\n   * 编辑器 Controller\n   */\n  controller: Controller;\n  /**\n   * 文档滚动容器\n   */\n  container: HTMLElement;\n  /**\n   * 文档正文\n   */\n  content: HTMLElement;\n  /**\n   * 外层工具栏插件配置\n   */\n  toolbarLayout: ToolLineProps[];\n  /**\n   * 更多工具栏插件配置\n   */\n  moreToolbarLayout?: ToolLineProps[];\n  /**\n   * 自定义按钮\n   */\n  customToolButtons?: Record<string, any>;\n}\n\ninterface TriggerState {\n  visible: boolean;\n  placement: Placement;\n  x: number;\n  y: number;\n}\n\ninterface Pos {\n  top: number;\n  left: number;\n  width: number;\n  height: number;\n}\n\nconst INITIAL_STATE: TriggerState = {\n  visible: false,\n  placement: 'top',\n  x: 0,\n  y: 0,\n};\n\n/**\n * 工具栏视口边距\n */\nconst VIEWPORT_GAP = 4;\n\n/**\n * SelectionBar 与文字之间的距离\n */\nconst SELECTION_BAR_GAP = 8;\n\n/**\n * 判断一组选区是否有换行\n * @param clientRects\n */\nfunction isBreakLine(clientRects: DOMRect[]): boolean {\n  // 如果只有单选区，则一定没有换行\n  if (clientRects.length <= 1) {\n    return false;\n  }\n  const firstRect = clientRects[0];\n  for (let i = 1; i < clientRects.length; i++) {\n    const rect = clientRects[i];\n    // 如果存在选区块错层，则断定存在换行\n    if (rect.top >= firstRect.bottom || rect.bottom <= firstRect.top) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * 判断选区是否由表格工具栏操作，注释见下方\n * 解决从表格工具栏点击，表格选区变化时，极简工具栏位置不变的问题\n * 之前花过一些时间尝试从表格选区数据 diff 下手\n * 但无可避免的产生了一些误伤，例如在表格选区下调整字体大小，在一些操作后会使极简工具栏抖动\n * 所以改为从 UI 判定下手\n */\nfunction isTargetFromTableToolbar(target?: HTMLElement | null) {\n  if (!target) {\n    return false;\n  }\n  return target.getAttribute('data-cangjie-col-toolbar-item') ||\n    target.getAttribute('data-cangjie-row-toolbar-item') ||\n    target.getAttribute('data-cangjie-cornel-toolbar');\n}\n\n/**\n * 由于表格边缘有行列工具栏的存在，因此为了避免toolbar遮挡住工具栏，需要将其往上抬升8个px\n * 满足以下两个条件时需要抬升\n * 1. 选中首行\n * 2. 选中一列或多列\n */\nfunction isSelectedTableFirstRow(tableSelection: any) {\n  const { startRowIndex } = tableSelection;\n  return startRowIndex === 0;\n}\n\n/**\n * 判断是否是选中表格行\n * 背景：选中行的时候工具栏位于行头右侧8px处\n * 多行的情况工具栏居于上方中部位置也是更符合用户习惯\n */\nfunction isSelectedSingleTableRow(tableSelection: any) {\n  const { startRowIndex, endRowIndex } = tableSelection;\n  return startRowIndex === endRowIndex;\n}\n\nconst CUSTOM_PANEL_INPUT_FLAG = 'custom-color-input';\n\nconst Trigger: React.FC<TriggerProps> = (props) => {\n  const {\n    controller,\n    content,\n    container,\n    toolbarLayout,\n    moreToolbarLayout,\n    customToolButtons,\n  } = props;\n\n  const [context] = useSelectionBarContext();\n  const { canHide } = context;\n  const boxRef = React.useRef<HTMLDivElement>(null);\n  const tableRef = React.useRef<HTMLDivElement | null>(null);\n  const transformRef = React.useRef<boolean>(true);\n  // 右键呼出菜单的时候需要隐藏工具栏\n  const isRightMouseDown = React.useRef<boolean>(false);\n  const { value } = controller;\n\n  const [state, setState] = React.useState<TriggerState>(INITIAL_STATE);\n  // 是否修正定位\n  const alignRef = React.useRef(false);\n  // 工具栏可见性\n  const visibleRef = React.useRef(state.visible);\n  visibleRef.current = state.visible;\n  // 当前鼠标是否按住\n  const pressRef = React.useRef(false);\n  // 当前右键菜单是否可见\n  const contextMenuVisibleRef = React.useRef(false);\n\n  const activeRef = React.useRef('');\n  const [activeType, setActiveType] = useActiveInteraction();\n  activeRef.current = activeType;\n\n  // table constants\n  const { TOOLBAR_ITEM_SIZE: TABLE_ROW_TOOLBAR_HEIGHT, SPACING } = React.useMemo(() => {\n    return controller.query('getTableConstants') || {\n      /**\n       * 表格行工具栏高度\n       * 为避免toolbar遮挡表格行工具栏，SelectionBar 选中表格首行时需要向上偏移该高度\n       */\n      TOOLBAR_ITEM_SIZE: 8,\n      SPACING: 16,\n    };\n  }, [controller]);\n\n  React.useEffect(() => {\n    // 选区工具栏可见时更新当前激活的类型\n    if (state.visible) {\n      activeRef.current !== 'selectionBar' && setActiveType('selectionBar');\n    } else if (activeRef.current === 'selectionBar') {\n      setActiveType('');\n    }\n  }, [state.visible, setActiveType]);\n\n  /**\n   * 展示选区工具栏\n   * @description 非重叠光标选区渲染工具栏，由于工具栏高度固定，所以挂载时可以订正垂直位置\n   */\n  const display = React.useCallback(() => {\n    const { selection: newSelection, document } = controller.value;\n    // 如果 Range 不存在则不处理\n    // TODO: 在 void 元素的场景下和选区的范围不之一，后续考虑使用视图上 range 的大小\n    const domRange = domUtils.findDOMRange(newSelection, controller, content);\n    // 右键菜单显示的情况下不展示工具栏\n    if (!domRange || isRightMouseDown.current || contextMenuVisibleRef.current) {\n      return;\n    }\n\n    const clientRects = Array.from(domRange.getClientRects());\n    if (clientRects.length <= 0) {\n      return;\n    }\n\n    const tableSelection = controller.query('getTableSelection');\n    let tableRect: DOMRect | null = null;\n    let tablePos: Pos | undefined | null;\n\n    const contentRect = content.getBoundingClientRect();\n    const contentContainerDistance = content.offsetTop - container.offsetTop;\n\n    // 定位方向\n    let placement: Placement;\n    // x 偏移量\n    let x: number;\n    // y 偏移量\n    let y: number;\n    // 光标落点 Range Rect (Focus Range Rect)\n    let clientRect: DOMRect;\n    let isSelectWholeRow = false;\n    /**\n     * 产品要求在表格中选中文字浮动工具栏尽量不要超出表格的左右区域\n     * 这里的解决办法是如果在表格中选中文字就把当前表格的dom对象保\n     * 存到tableRef中，在进行位置修正的时候如果tableRef不为null\n     * 则使用tableRef作为contanier进行位置修正，否则使用传入的contaner\n     * 进行位置修正\n     */\n    if (controller.query('isSelectionInTableCell') || tableSelection) {\n      const table = getTable(controller);\n      const tableDOMNode = table && findDOMNodeByKey(table.key) as HTMLDivElement;\n      if (table && tableDOMNode) {\n        tableRef.current = tableDOMNode;\n      }\n    } else {\n      // 不在表格中选区的时候需要初始化tableRef，使其在位置修正的时候使用传入的container进行修正\n      tableRef.current = null;\n    }\n\n    if (tableSelection && !controller.query('isSelectionInTableCell')) {\n      const table = getTable(controller);\n      let tableDOMNode = table && findDOMNodeByKey(table.key) as HTMLElement;\n      if (tableDOMNode && !(tableDOMNode instanceof HTMLTableElement)) {\n        tableDOMNode = tableDOMNode.querySelector('table') as HTMLTableElement;\n      }\n      if (table && tableDOMNode) {\n        isSelectWholeRow = !!controller.query('isSelectWholeRow', {\n          // @ts-ignore\n          node: table,\n        });\n        // 表格的选区计算逻辑，TODO: scale 计算\n        tablePos = controller.query('calcTableSelectionPos', {\n          tblSelection: tableSelection,\n          // @ts-ignore\n          table,\n          tableNode: tableDOMNode as HTMLTableElement,\n          scale: 1,\n        });\n        tableRect = tableDOMNode.getBoundingClientRect();\n      }\n    }\n\n    if (tableRect && tableSelection && tablePos) {\n      const pos = tablePos;\n      clientRect = {\n        ...tableRect,\n        width: tablePos.width,\n        height: tablePos.height,\n        left: tableRect.x + pos.left,\n        x: tableRect.x + pos.left,\n        top: tableRect.y + pos.top,\n        y: tableRect.y + pos.top,\n      };\n      // 第一行被选中遮挡工具栏，强制置于下方，其他情况下依据选区方向\n      if (newSelection.isForward(document)) {\n        placement = 'bottom';\n        const isSelectRow = isSelectedSingleTableRow(tableSelection) && isSelectWholeRow;\n        if (isSelectRow) {\n          // 选中行的时候浮动工具栏位置位于选中行头工具栏右侧\n          x = tableRect.x - contentRect.x;\n          transformRef.current = false;\n          tableRef.current = null;\n        } else {\n          x = tableRect.x + pos.left + pos.width / 2 - contentRect.x;\n          transformRef.current = true;\n        }\n        y = tableRect.y + pos.top + pos.height - contentRect.y;\n        y += SELECTION_BAR_GAP;\n      } else {\n        placement = 'top';\n        const shouldFixOffsetTop = isSelectedTableFirstRow(tableSelection);\n        const isSelectRow = isSelectedSingleTableRow(tableSelection) && isSelectWholeRow;\n        if (isSelectRow) {\n          // 选中行的时候浮动工具栏位置位于选中行头工具栏右侧\n          x = tableRect.x - contentRect.x;\n          transformRef.current = false;\n          tableRef.current = null;\n        } else {\n          x = tableRect.x + pos.left + pos.width / 2 - contentRect.x;\n          transformRef.current = true;\n        }\n        y = tableRect.y + pos.top - contentRect.y;\n        y -= SELECTION_BAR_GAP;\n        if (shouldFixOffsetTop) {\n          // 选中第一行时不能遮挡表格插入按钮\n          y -= TABLE_ROW_TOOLBAR_HEIGHT * 2 + SPACING;\n        }\n      }\n    } else if (newSelection.isForward(document)) {\n      clientRect = clientRects[clientRects.length - 1];\n      if (isBreakLine(clientRects)) {\n        placement = 'bottom';\n        x = clientRect.x + clientRect.width - contentRect.x;\n        y = clientRect.y + clientRect.height - contentRect.y;\n        y += SELECTION_BAR_GAP;\n      } else {\n        placement = 'top';\n        x = clientRect.x + clientRect.width - contentRect.x;\n        y = clientRect.y - contentRect.y;\n        y -= SELECTION_BAR_GAP;\n      }\n    } else {\n      clientRect = clientRects[0];\n      placement = 'top';\n      x = clientRect.x - contentRect.x;\n      y = clientRect.y - contentRect.y;\n      y -= SELECTION_BAR_GAP;\n    }\n\n    /**\n     * 若定位超出视口上方，则平移至当前 clientRect 下方\n     */\n    if (placement === 'top' && y + contentContainerDistance - SELECTION_BAR_HEIGHT - VIEWPORT_GAP < container.scrollTop) {\n      placement = 'bottom';\n      y = clientRect.y + clientRect.height - contentRect.y;\n      y += SELECTION_BAR_GAP;\n    }\n\n    /**\n     * 若定位超出视口下方，则平移至当前 clientRect 上方\n     */\n    if (placement === 'bottom' && y + contentContainerDistance + SELECTION_BAR_HEIGHT + VIEWPORT_GAP > container.scrollTop + container.clientHeight) {\n      placement = 'top';\n      y = clientRect.y - contentRect.y;\n      y -= SELECTION_BAR_GAP;\n      // table 不平移，暂时不展示\n      // if (tableSelection && tableSelection.startRowIndex === 0) {\n      //   return;\n      // }\n    }\n\n    // 开启定位偏移修正\n    alignRef.current = true;\n\n    setState({\n      visible: true,\n      placement,\n      x,\n      y,\n    });\n  }, [container, content, controller]);\n\n  // value 变化后，修正位置\n  React.useEffect(() => {\n    if (boxRef?.current) {\n      alignRef.current = true;\n      handleAnimationInStart(boxRef.current);\n    }\n  }, [value]);\n\n  const handleMouseDown = React.useCallback((event: MouseEvent) => {\n    const targetFromTableToolbar = isTargetFromTableToolbar(event.target as HTMLElement);\n    pressRef.current = true;\n    // 需要与右键菜单互斥，因此这里判断鼠标点击事件是否为右键，是的话则不显示工具栏\n    isRightMouseDown.current = event.button === 2;\n    // 在点击表格工具栏 mouseDown 时选区消失，mouseUp 时再出现\n    // 一定要完整的执行 消失 -> 出现 这个闭环，才能触发选区动画，以及位置校正逻辑\n    // 这是最简单有效的做法，其他做法容易让时序乱套，或者把代码改乱\n    if (targetFromTableToolbar || isRightMouseDown.current) {\n      setState((prevState) => ({ ...prevState, visible: false }));\n    }\n  }, []);\n\n  const handleMouseUp = React.useCallback(() => {\n    pressRef.current = false;\n    const { selection, isBlurred } = controller.value;\n    const { isByTable } = selection.data;\n    // 通过工具栏选中仅一个单元格时，selection.isCollapsed 为 true，需要额外处理\n    const isCollapsed = selection.isCollapsed && !isByTable;\n\n    // 选中列表符号，显示工具栏\n    if (controller.query('isSelectionInListSymbol')) {\n      display();\n      return;\n    }\n    // 重叠光标选区不处理\n    if (isBlurred || isCollapsed || visibleRef.current) {\n      return;\n    }\n    display();\n  }, [controller, display]);\n\n  const handleMouseMove = React.useCallback(throttle(() => {\n    if (pressRef.current) {\n      return;\n    }\n    // 有其他类型激活时，不触发选区工具栏\n    const hasOtherActiveInteraction = activeRef.current && activeRef.current !== 'selectionBar';\n    const { selection, isBlurred } = controller.value;\n    // 重叠光标选区不处理\n    if (isBlurred || selection.isCollapsed || visibleRef.current || hasOtherActiveInteraction) {\n      return;\n    }\n    display();\n  }), [controller, display]);\n\n  /**\n   * 工具栏渲染前，订正 X 偏移量\n   */\n  const handleAnimationInStart = React.useCallback((ref: HTMLElement | null) => {\n    if (!ref || !alignRef.current) {\n      return;\n    }\n    const Nearesetcontainer = tableRef.current ? tableRef.current : container;\n    const containerRect = Nearesetcontainer.getBoundingClientRect();\n    const contentRect = content.getBoundingClientRect();\n    const rect = ref.getBoundingClientRect();\n    // 超出左侧\n    if (rect.left - VIEWPORT_GAP < containerRect.left) {\n      const x = containerRect.left - contentRect.left + (rect.width / 2) + VIEWPORT_GAP;\n      setState((prevState) => ({ ...prevState, x }));\n    }\n\n    // 超出右侧\n    if (rect.right + VIEWPORT_GAP > containerRect.right) {\n      const scrollBarWidth = Nearesetcontainer.offsetWidth - Nearesetcontainer.clientWidth;\n      setState((prevState) => ({\n        ...prevState,\n        x: prevState.x - (rect.right - containerRect.right) - scrollBarWidth - VIEWPORT_GAP,\n      }));\n    }\n\n    // 禁止定位偏移修正\n    alignRef.current = false;\n  }, [container, content]);\n\n  /**\n   * 处理自定义事件（右键菜单显示隐藏）\n   */\n  const handleCustomEvent = React.useCallback((e: any) => {\n    const { visible } = e.detail;\n    contextMenuVisibleRef.current = visible;\n  }, []);\n\n  const { visible, placement, x, y } = state;\n\n  const hideSelectionBar = () => {\n    const { selection, isBlurred } = controller.value;\n    // 通过工具栏选中仅一个单元格时，selection.isCollapsed 为 true，需要额外处理\n    const isCollapsed = selection.isCollapsed && !selection.data.isByTable;\n\n    // 当 focus 到 自定义色板的输入框时, selectionBar 不隐藏\n    const isFocusInCustomColorPanel = document.activeElement?.getAttribute('data-testid') === CUSTOM_PANEL_INPUT_FLAG;\n\n    // fix: https://aone.alibaba-inc.com/v2/bug/36320509# 《选中文字点击空白处无法取消选中\n    if (\n      canHide &&\n      visible &&\n      (isCollapsed || isBlurred) &&\n      !controller.query('isSelectionInListSymbol') &&\n      !isFocusInCustomColorPanel\n    ) {\n      setState((prevState) => ({ ...prevState, visible: false }));\n    }\n  };\n\n  /**\n   * 选区折叠则隐藏工具栏\n   */\n  React.useEffect(hideSelectionBar);\n\n  // 响应 pending selection 和 普通 selection 变化实时更新\n  useSelectionData(controller.selectionData$, null, hideSelectionBar, [controller.value.selection]);\n  useSelectingHots(controller, hideSelectionBar);\n\n  React.useEffect(() => {\n    // 监听contextMenuVisible变化需要挂载body上，因为事件源无法绑定到content上\n    window.document.body.addEventListener(LEGAL_EVENT.contextMenuVisible, handleCustomEvent, true);\n    content.addEventListener('mousedown', handleMouseDown, true);\n    content.addEventListener('mouseup', handleMouseUp, true);\n    content.addEventListener('mousemove', handleMouseMove, true);\n    return () => {\n      window.document.body.removeEventListener(LEGAL_EVENT.contextMenuVisible, handleCustomEvent, true);\n      content.removeEventListener('mousedown', handleMouseDown, true);\n      content.removeEventListener('mouseup', handleMouseUp, true);\n      content.removeEventListener('mousemove', handleMouseMove, true);\n    };\n  }, [content, handleMouseDown, handleMouseMove, handleMouseUp, handleCustomEvent]);\n\n  // 容器内容高度变化后，需要重新计算工具栏的位置\n  React.useEffect(() => {\n    let resizeObserver: ResizeObserver | undefined;\n    const handleResize = throttle(() => {\n      display();\n      handleAnimationInStart(boxRef.current);\n    }, 50);\n    if (visible && content && isElement(content)) {\n      resizeObserver = new ResizeObserver(handleResize);\n      resizeObserver.observe(content);\n    }\n\n    return () => {\n      resizeObserver?.disconnect();\n    };\n  }, [visible, content, display, handleAnimationInStart]);\n\n  return (\n    <BasicPortal container={content}>\n      <SelectionBar\n        needTransform={transformRef.current}\n        ref={boxRef}\n        toolbarLayout={toolbarLayout}\n        moreToolbarLayout={moreToolbarLayout}\n        onAnimationInStart={handleAnimationInStart}\n        controller={controller}\n        content={content}\n        visible={visible}\n        placement={placement}\n        x={x}\n        y={y}\n        customToolButtons={customToolButtons}\n      />\n    </BasicPortal>\n  );\n};\n\nTrigger.displayName = 'Trigger';\n\nexport interface ContainerProps {\n  /**\n   * 获取编辑器挂载的滚动容器\n   */\n  getScrollableContainer: () => HTMLElement | null;\n  /**\n   * 获取文档正文 DOM\n   */\n  getScrollableContent: () => HTMLElement | null;\n  /**\n   * 外层工具栏插件配置\n   */\n  toolbarLayout: ToolLineProps[];\n  /**\n  * 更多工具栏插件配置\n  */\n  moreToolbarLayout?: ToolLineProps[];\n}\n\nconst TriggerContainer: React.FC<ContainerProps> = (props) => {\n  const controller = Controller.useController();\n  const {\n    getScrollableContainer,\n    getScrollableContent,\n    ...rest\n  } = props;\n\n  const container = getScrollableContainer();\n  const content = getScrollableContent();\n\n  if (!container || !content) {\n    return null;\n  }\n\n  return (\n    <Trigger\n      {...rest}\n      container={container}\n      content={content}\n      controller={controller}\n    />\n  );\n};\n\nTriggerContainer.displayName = 'TriggerContainer';\n\nexport default TriggerContainer;\n"],"file":"Trigger.js"}