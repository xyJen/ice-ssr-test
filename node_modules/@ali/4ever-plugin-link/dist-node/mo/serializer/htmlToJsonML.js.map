{"version":3,"sources":["../../../../src/mo/serializer/htmlToJsonML.ts"],"names":["DATA_LINK_HREF_CANGJIE","isLink","name","attrs","normalizeLink","link","tagName","children","normalized","forEach","child","paragraphTags","push","removeAttribute","attr","result","Object","keys","length","dropColor","element","normalizeAttrs","map","onOpenTag","state","href","onCloseTag","pop","parent","peek","append","prevSibling","isPhantom","phantom"],"mappings":"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","sourcesContent":["import {\n  JsonML,\n  getTagName,\n  getAttributes,\n  getChildren,\n  getLastChild,\n} from '@ali/4ever-utils';\nimport { omit } from 'lodash-es';\nimport { MoState as State, MoAttributes as Attributes, createEmptyText } from '@ali/4ever-cangjie';\nimport { paragraphTags, normalizeJsonMLChildren as normalizeChildren, Phantom  } from '@ali/4ever-utils';\n\nexport const DATA_LINK_HREF_CANGJIE = 'data-link-href-cangjie';\n\nfunction isLink(name: string, attrs: Attributes): boolean {\n  return name === 'a' && ('href' in attrs || DATA_LINK_HREF_CANGJIE in attrs);\n}\n\nfunction normalizeLink(link: JsonML) {\n  const tagName = getTagName(link);\n  const attrs = getAttributes(link);\n  const children = getChildren(link);\n\n  const normalized: JsonML = attrs ? [tagName, attrs] : [tagName];\n  children.forEach((child: JsonML): void => {\n    if (paragraphTags[getTagName(child)]) {\n      normalized.push(...getChildren(child));\n    } else {\n      normalized.push(child);\n    }\n  });\n  return normalized;\n}\n\nfunction removeAttribute(attrs: Object | null, attr: string) {\n\n  const result = omit(attrs, attr);\n\n  // 如果结果已经没有其他 attribute，直接返回 null\n  if (Object.keys(result).length === 0) {\n    return null;\n  }\n\n  return result;\n}\n\nfunction dropColor(element: JsonML) {\n  if (typeof element === 'string') {\n    return element;\n  }\n  const tagName = getTagName(element);\n  const attrs = getAttributes(element);\n  const children = getChildren(element);\n\n  const normalizeAttrs = removeAttribute(attrs, 'color');\n\n  const normalized: JsonML = normalizeAttrs ? [tagName, normalizeAttrs] : [tagName];\n  // 如果当前节点是叶子节点，则子节点一定是字符串，不需要额外处理 dropcolor\n  if (attrs && attrs['data-type'] === 'leaf') {\n    normalized.push(...children);\n  } else {\n    children.forEach((child: JsonML) => {\n      if (paragraphTags[getTagName(child)]) {\n        normalized.push(...(getChildren(child).map(dropColor)));\n      } else {\n        normalized.push(dropColor(child));\n      }\n    });\n  }\n\n  return normalized;\n}\n\nexport default {\n  name: 'a',\n\n  onOpenTag(state: State, name: string, attrs: Attributes): boolean {\n    if (!isLink(name, attrs)) return false;\n\n    const link: JsonML = ['a', { href: attrs[DATA_LINK_HREF_CANGJIE] || attrs.href || '' }] as JsonML;\n    state.push(link);\n    return true;\n  },\n\n  onCloseTag(state: State, name: string, attrs: Attributes): boolean {\n    if (!isLink(name, attrs)) return false;\n\n    let link = state.pop();\n    // HACK: 通过设置 data-title，覆盖 a.innerText 的值，用于实现钉钉文档 文档引用 功能\n    if ('data-title' in attrs && attrs['data-title'].length) {\n      link = [\n        getTagName(link),\n        getAttributes(link) as object,\n        [\n          'span',\n          { 'data-type': 'text' },\n          ['span', { 'data-type': 'leaf' }, attrs['data-title']],\n        ],\n      ];\n    }\n\n    const children = getChildren(link);\n    if (children.length === 0) return true;\n\n    link = dropColor(normalizeLink(normalizeChildren(link)));\n\n    const parent = state.peek();\n    // 如果是段落行，则直接 append\n    if (paragraphTags[getTagName(parent)]) {\n      state.append(link);\n      return true;\n    }\n\n    const prevSibling = getLastChild(parent);\n    if (prevSibling && (prevSibling as Phantom).isPhantom) {\n      // 如果上一个兄弟节点是 phantom，则直接添加进去\n      // 追加一个 text 节点 normalize，否则单测跑不过\n      prevSibling.push(link, createEmptyText());\n    } else {\n      // 如果上一个兄弟节点不存在，或者不是 phantom 节点，则创建一个 phantom 节点\n      const phantom: JsonML = ['p', createEmptyText(), link, createEmptyText()];\n      (phantom as Phantom).isPhantom = true;\n      state.append(phantom);\n    }\n\n    return true;\n  },\n};\n"],"file":"htmlToJsonML.js"}