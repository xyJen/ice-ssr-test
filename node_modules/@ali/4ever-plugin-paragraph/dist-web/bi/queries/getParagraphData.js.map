{"version":3,"sources":["../../../../src/bi/queries/getParagraphData.ts"],"names":["getBlocksFromEditor","SpacingUtil","IndUtil","ShdUtil","defaultSpacing","before","after","line","defaultInd","left","right","defaultShd","val","color","fill","createGetSpacingFromBlock","defaultProperties","getSpacingFromBlock","block","mergedSpacing","spacing","fromBlock","getIndFromBlock","mergedInd","ind","getShdFromBlock","mergedShd","shd","getCommonProperties","items","processor","first","length","dirtyMap","i","nextSpacing","keys","Object","j","key","forEach","dirtyKey","undefined","getCommonSpacing","controller","blocks","getCommonInd","getCommonShd"],"mappings":"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","sourcesContent":["import { Controller, Block } from '@ali/4ever-cangjie';\nimport { getBlocksFromEditor, SpacingUtil, IndUtil, ShdUtil, SpacingProperties, IndentProperties }  from '@ali/4ever-utils';\n\nconst defaultSpacing = {\n  before: 0,\n  after: 0,\n  line: 1,\n};\n\nconst defaultInd = {\n  left: 0,\n  right: 0,\n};\n\nconst defaultShd = {\n  val: 'clear',\n  color: 'auto',\n  fill: 'auto',\n};\n\nfunction createGetSpacingFromBlock(defaultProperties?: SpacingProperties) {\n  return function getSpacingFromBlock(block: Block) {\n    let mergedSpacing: SpacingProperties = {};\n\n    // 拿到转换后的 spacing\n    const spacing = SpacingUtil.fromBlock(block);\n\n    mergedSpacing = {\n      ...defaultSpacing,\n      ...defaultProperties,\n      ...spacing,\n    };\n\n    return mergedSpacing;\n  }\n}\n\nfunction getIndFromBlock(block: Block) {\n  let mergedInd: IndentProperties = {};\n\n  // 拿到转换后的 spacing\n  const ind = IndUtil.fromBlock(block);\n\n  mergedInd = {\n    ...defaultInd,\n    ...ind,\n  };\n\n  return mergedInd;\n}\n\nexport function getShdFromBlock(block: Block) {\n  let mergedShd: any = {};\n\n  // 拿到转换后的 shd\n  const shd = ShdUtil.fromBlock(block);\n\n  mergedShd = {\n    ...defaultShd,\n    ...shd,\n  };\n\n  return mergedShd;\n}\n\n/**\n * 提取公共属性\n * 这是个 n * m 复杂度的计算\n * 3000个段落大概是 5ms\n * TODO: 或许有人有更好的解法？\n */\nfunction getCommonProperties(\n  items: Array<Record<string, any>>, \n  processor: Function, \n) {\n  let first: Record<string, any> = {};\n  if (!items.length) return first;\n\n  first = processor(items[0]);\n  if (items.length === 1) return first;\n  const dirtyMap = {};\n\n  for (let i = 1; i < items.length; i++) {\n    const nextSpacing = processor(items[i]);\n    const keys = Object.keys(nextSpacing);\n    for (let j = 0; j < keys.length; j++) {\n      const key = keys[j];\n      if (dirtyMap[key]) continue;\n\n      if (!(key in dirtyMap)) {\n        dirtyMap[key] = false;\n      }\n\n      if (!dirtyMap[key] && nextSpacing[key] !== first[key]) {\n        // 标记不一致\n        dirtyMap[key] = true;\n      }\n    }\n  }\n\n  Object.keys(dirtyMap).forEach((dirtyKey) => {\n    if (dirtyMap[dirtyKey]) {\n      // 发现了不一样的视为未发现公共属性\n      delete first[dirtyKey];\n    }\n  });\n\n  Object.keys(first).forEach((key) => {\n    if (first[key] !== undefined && !(key in dirtyMap)) {\n      // 从未发现后续 block 有此属性也视为未发现公共属性\n      delete first[key];\n    }\n  });\n\n  return first;\n}\n\nexport function getCommonSpacing(controller: Controller, defaultProperties?: SpacingProperties) {\n  const blocks = getBlocksFromEditor(controller);\n  return getCommonProperties(blocks, createGetSpacingFromBlock(defaultProperties)) as SpacingProperties;\n}\n\nexport function getCommonInd(controller: Controller) {\n  const blocks = getBlocksFromEditor(controller);\n  return getCommonProperties(blocks, getIndFromBlock) as IndentProperties;\n}\n\nexport function getCommonShd(controller: Controller) {\n  const blocks = getBlocksFromEditor(controller);\n  return getCommonProperties(blocks, getShdFromBlock) as IndentProperties;\n}\n"],"file":"getParagraphData.js"}