{"version":3,"sources":["../../../../src/bi/handlers/onKeyDown.ts"],"names":["Commands","hotkeys","Block","TemplateButton","isEmptyNode","isList","isInlineCode","isSelectionInTemplateButton","onKeyDown","event","controller","next","isDelete","isDeleteHotKey","value","document","selection","isInTemplateButton","templateButton","getClosest","focus","key","isTemplateButton","nodes","isOpen","command","replaceNodeByKey","create","moveForward","length","anchor","block","getClosestBlock","isVoid","query","preventDefault","isDeleteLineForward","isDeleteLineBackward","isDeleteForward","isDeleteBackward","isDeleteWordForward","isDeleteWordBackward"],"mappings":"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","sourcesContent":["import {\n  Controller,\n  ZhiPlugin,\n  Commands,\n  hotkeys,\n  Block,\n} from '@ali/4ever-cangjie';\nimport { TemplateButton } from '../../mo';;\nimport { isEmptyNode, isList, isInlineCode } from '../utils';\nimport isSelectionInTemplateButton from '../queries/isSelectionInTemplateButton';\n\n\nexport const onKeyDown: ZhiPlugin['onKeyDown'] = (\n  event: React.KeyboardEvent,\n  controller: Controller,\n  next,\n) => {\n  const isDelete = isDeleteHotKey(event);\n  // perf 非关注的事件，趁早返回，减少计算\n  if (!isDelete) {\n    return next();\n  }\n\n  const { value } = controller;\n  const { document, selection } = value;\n  const isInTemplateButton = isSelectionInTemplateButton(controller);\n  // 开始、结束节点均不在模板按钮内，则交由其他插件处理\n  if (!isInTemplateButton) {\n    return next();\n  }\n  // 开始、结束节点只有一个在模板按钮内，则不要有响应\n  if (isInTemplateButton !== 'all') {\n    return controller;\n  }\n\n  const templateButton = document.getClosest(\n    selection.focus.key,\n    TemplateButton.isTemplateButton,\n  ) as Block;\n\n  const { nodes } = templateButton;\n\n  // 删除 -> 必需得保留一个空段落\n  if (isDelete) {\n    const isOpen = TemplateButton.isOpen(controller, templateButton.key);\n    // 关闭状态下，删除时会先选中，再继续退格需要直接删除\n    if (!isOpen) {\n      return controller\n        .command(Commands.replaceNodeByKey, templateButton.key, Block.create('paragraph'))\n        .command(Commands.moveForward, 1);\n    }\n\n    // 只处理单个子元素即将被删除的情况\n    if (nodes.length !== 1) {\n      return next();\n    }\n\n    const { anchor } = selection;\n    const block = document.getClosestBlock(anchor.key);\n    // 异常情况兜底\n    if (!block) {\n      return controller;\n    }\n\n    const isVoid = controller.query('isVoid', block);\n    // 非空 & 非 void block，不处理\n    if (!isEmptyNode(controller, block) && !isVoid) {\n      return next();\n    }\n\n    // 空 list 与 void block 被删除时，需要插入一个空段落\n    if (isList(block) || isVoid || isInlineCode(controller)) {\n      controller\n        .command(\n          Commands.replaceNodeByKey,\n          block.key,\n          Block.create('paragraph'),\n        )\n        .command(Commands.moveForward, 2);\n      return controller;\n    }\n    event.preventDefault();\n    return controller;\n  }\n  return next();\n}\n\n/**\n * 需要拦截删除事件\n * @param event\n * @returns\n */\nconst isDeleteHotKey = (event: React.KeyboardEvent) => {\n  return (\n    hotkeys.isDeleteLineForward(event) ||\n    hotkeys.isDeleteLineBackward(event) ||\n    hotkeys.isDeleteForward(event) ||\n    hotkeys.isDeleteBackward(event) ||\n    hotkeys.isDeleteWordForward(event) ||\n    hotkeys.isDeleteWordBackward(event)\n  );\n};\n"],"file":"onKeyDown.js"}