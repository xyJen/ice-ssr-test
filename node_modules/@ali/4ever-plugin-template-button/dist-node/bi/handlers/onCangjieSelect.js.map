{"version":3,"sources":["../../../../src/bi/handlers/onCangjieSelect.ts"],"names":["onCangjieSelect","event","controller","next","detail","selection","focus","anchor","isCollapsed","value","beforeFocus","document","focusBlock","getClosestTemplateButton","key","anchorBlock","focusBlockPath","getPath","anchorBlockPath","Path","isAncestor","edge","anchorPath","focusPath","isAfter","isEdgePoint","isDescendant","newFocus","EdgePoint","create","Selection","command","Commands","select","beforeFocusBlock","preventDefault","nodes","moveAnchorToStartOfNode","moveFocusToEndOfNode","length","getClosest","TemplateButton","isTemplateButton"],"mappings":"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","sourcesContent":["import {\n  Path,\n  Commands,\n  Document,\n  EdgePoint,\n  PointEdge,\n  Selection,\n  ZhiPlugin,\n  Controller,\n  CangjieSelectEvent\n} from '@ali/4ever-cangjie';\nimport { TemplateButton } from '../../mo';;\n\n/**\n * 与模板按钮相关的选区需要处理三种情况：\n * 1. 按钮内全选，表现为：原 focus anchor 均在模板按钮内，但事件发生后，focus anchor 均不在模板按钮内，且 focus !== anchor，此时仅选择模板按钮内容\n * 2. 从内向外选，表现为：原 focus anchor 均在模板按钮内，但事件发生后，focus 不在模板按钮内，此时需要忽略该事件\n * 3. 从外向内选，表现为：原 focus anchor 均不在模板按钮内，但事件发生后，focus 在模板按钮内，此时需要扩展选区包含整个模板按钮\n */\n\nexport const onCangjieSelect: ZhiPlugin['onCangjieSelect'] = (\n  event: CangjieSelectEvent,\n  controller: Controller,\n  next,\n) => {\n  const { detail: { selection } } = event;\n  const { focus, anchor } = selection;\n  // perf: 此种情况无需关心\n  if (selection.isCollapsed) {\n    return next();\n  }\n  const { value: { selection: { focus: beforeFocus }, document } } = controller;\n\n  const focusBlock = getClosestTemplateButton(focus.key, document);\n  const anchorBlock = getClosestTemplateButton(anchor.key, document);\n\n  // 从内向外选 或 由外向内选\n  if (focusBlock !== anchorBlock) {\n    // 由内向外，限制在模板按钮内\n    if (!focusBlock) {\n      return;\n    }\n    const focusBlockPath = document.getPath(focusBlock.key);\n    const anchorBlockPath = anchorBlock && document.getPath(anchorBlock.key);\n    // 嵌套情况下的由内向外，限制在内部的模板按钮内\n    if (focusBlockPath && anchorBlockPath && Path.isAncestor(focusBlockPath, anchorBlockPath)) {\n      return;\n    }\n    // 由外向内选则选中整个模板按钮\n    let edge: PointEdge = 'before';\n    const anchorPath = document.getPath(anchor.key)!;\n    const focusPath = document.getPath(focus.key)!;\n    // 模板按钮在初始选区后面\n    if (Path.isAfter(focusPath, anchorPath)) {\n      edge = 'after';\n    } else if (anchor.isEdgePoint()) {\n      // 从边缘的 edgePoint 开始选，且与 focus 存在父子关系\n      if (Path.isDescendant(focusPath, anchorPath)) {\n        edge = anchor.edge === 'after' ? 'before' : 'after';\n      }\n    }\n    const newFocus = EdgePoint.create({ key: focusBlock.key, edge });\n    const selection = Selection.create({ focus: newFocus, anchor });\n    return controller.command(Commands.select, selection)\n  }\n\n  // beforeFocusBlock 与 beforeAnchorBlock 必然相等，这是由要处理的三个条件所约束的，所以这里只需要查询一种情况\n  const beforeFocusBlock = getClosestTemplateButton(beforeFocus.key, document);\n  // 全选\n  if (!focusBlock && !anchorBlock && beforeFocusBlock) {\n    event.preventDefault();\n    const { nodes } = beforeFocusBlock;\n    return controller\n      .command(Commands.moveAnchorToStartOfNode, nodes[0])\n      .command(Commands.moveFocusToEndOfNode, nodes[nodes.length - 1]);\n  }\n  return next();\n}\n\n\nfunction getClosestTemplateButton(key: string, document: Document) {\n  return document.getClosest(key, TemplateButton.isTemplateButton);\n}\n"],"file":"onCangjieSelect.js"}